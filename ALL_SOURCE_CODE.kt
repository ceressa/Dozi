/**
 * ============================================================================
 * DOZI - Consolidated Source Code
 * ============================================================================
 * 
 * This file contains all 122 Kotlin source files from the Dozi application.
 * Generated for documentation and review purposes.
 * 
 * Dozi is a medication reminder application for Android built with:
 * - Jetpack Compose UI framework
 * - Material 3 design system
 * - Firebase (Auth, Firestore)
 * - Room database (local storage)
 * - Hilt dependency injection
 * - MVVM architecture
 * 
 * Application package: com.bardino.dozi
 * 
 * ============================================================================
 */


// ============================================================================
// FILE: DoziApplication.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/DoziApplication.kt
// [1 of 122]
// ============================================================================

package com.bardino.dozi

import android.app.Application
import android.app.NotificationChannel
import android.app.NotificationManager
import android.graphics.Color
import android.os.Build

import androidx.compose.foundation.ExperimentalFoundationApi
import com.bardino.dozi.core.common.Constants.BUDDY_CHANNEL_ID
import com.bardino.dozi.core.common.Constants.REMINDER_CHANNEL_ID
import com.bardino.dozi.core.data.MedicineLookupRepository
import com.bardino.dozi.core.sync.SyncWorker
import com.bardino.dozi.notifications.NotificationHelper
import com.google.android.libraries.places.api.Places
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.firestore.FirebaseFirestoreSettings
import dagger.hilt.android.HiltAndroidApp

@HiltAndroidApp
class DoziApplication : Application() {

    @OptIn(ExperimentalFoundationApi::class)
    override fun onCreate() {
        super.onCreate()

        if (!Places.isInitialized()) {
            Places.initialize(this, getString(R.string.google_maps_key))
        }

        // üî• Firestore offline persistence'ƒ± aktif et
        FirebaseFirestore.getInstance().firestoreSettings = FirebaseFirestoreSettings.Builder()
            .setPersistenceEnabled(true)
            .build()
        android.util.Log.d("DoziApplication", "‚úÖ Firestore offline persistence enabled")

        // üíä Uygulama a√ßƒ±ldƒ±ƒüƒ±nda ila√ß veritabanƒ±nƒ± belleƒüe y√ºkle (ilaclar.json lookup i√ßin)
        MedicineLookupRepository.initialize(this)

        // üîî Bildirim kanallarƒ±nƒ± olu≈ütur
        createNotificationChannels()

        // üîÑ Periyodik sync worker'ƒ± ba≈ülat (offline-first support)
        SyncWorker.schedulePeriodicSync(this)
        android.util.Log.d("DoziApplication", "‚úÖ Periodic sync worker scheduled")
    }

    private fun createNotificationChannels() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            val manager = getSystemService(NotificationManager::class.java)

            // üíß Dozi Ana Kanal (Yeni - En √∂ncelikli)
            NotificationHelper.createDoziChannel(this)

            // üìÖ ƒ∞la√ß Hatƒ±rlatmalarƒ± Kanalƒ± (Eski - Geri uyumluluk i√ßin)
            val reminderChannel = NotificationChannel(
                REMINDER_CHANNEL_ID,
                "ƒ∞la√ß Hatƒ±rlatmalarƒ±",
                NotificationManager.IMPORTANCE_HIGH
            ).apply {
                description = "ƒ∞la√ß alma zamanƒ± hatƒ±rlatmalarƒ±"
                enableVibration(true)
                vibrationPattern = longArrayOf(0, 300, 150, 300)
                enableLights(true)
                lightColor = Color.parseColor("#4DD0E1")
                setShowBadge(true)
            }

            // üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Aile Bildirimleri Kanalƒ±
            val buddyChannel = NotificationChannel(
                BUDDY_CHANNEL_ID,
                "Aile Bildirimleri",
                NotificationManager.IMPORTANCE_DEFAULT
            ).apply {
                description = "Aile √ºyesi bildirimleri ve g√ºncellemeleri"
                enableVibration(true)
                setShowBadge(true)
            }

            // T√ºm kanallarƒ± olu≈ütur
            manager.createNotificationChannels(
                listOf(
                    reminderChannel,
                    buddyChannel
                )
            )
        }
    }
}

// ============================================================================
// FILE: MainActivity.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/MainActivity.kt
// [2 of 122]
// ============================================================================

package com.bardino.dozi

import android.Manifest
import android.app.AlarmManager
import android.app.AlertDialog
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Build
import android.os.Bundle
import android.provider.Settings
import android.util.Log
import android.widget.Toast
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.result.contract.ActivityResultContracts
import androidx.annotation.RequiresApi
import androidx.compose.foundation.isSystemInDarkTheme
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.runtime.DisposableEffect
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.ui.Modifier
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.getValue
import androidx.compose.runtime.setValue
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.remember
import androidx.core.content.ContextCompat
import androidx.navigation.compose.rememberNavController
import com.bardino.dozi.core.data.ThemePreferences
import com.bardino.dozi.core.data.repository.UserRepository
import com.bardino.dozi.core.data.repository.PremiumRepository
import com.bardino.dozi.navigation.NavGraph
import com.bardino.dozi.notifications.NotificationHelper
import com.bardino.dozi.core.ui.theme.DoziAppTheme
import com.bardino.dozi.navigation.Screen
import com.google.android.gms.auth.api.signin.GoogleSignIn
import com.google.android.gms.auth.api.signin.GoogleSignInOptions
import com.google.android.gms.common.api.ApiException
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.auth.GoogleAuthProvider
import com.google.firebase.messaging.FirebaseMessaging
import dagger.hilt.android.AndroidEntryPoint
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.tasks.await
import javax.inject.Inject

@AndroidEntryPoint
class MainActivity : ComponentActivity() {

    private val userRepository = UserRepository()
    private var currentIntent by mutableStateOf<Intent?>(null)
    private var navController: androidx.navigation.NavHostController? = null

    // üîπ √áoklu izin isteyici (bildirim, kamera, konum)
    private val permissionLauncher =
        registerForActivityResult(ActivityResultContracts.RequestMultiplePermissions()) { permissions ->
            handlePermissionResults(permissions)
        }

    // üîπ Overlay izni i√ßin ayrƒ± launcher
    private val overlayPermissionLauncher =
        registerForActivityResult(ActivityResultContracts.StartActivityForResult()) {
            // Sessiz kontrol
        }

    // üîπ Exact Alarm izni i√ßin launcher
    private val exactAlarmLauncher =
        registerForActivityResult(ActivityResultContracts.StartActivityForResult()) {
            // Sessiz kontrol
        }

    // üîπ Google Sign-In sonucu yakalayƒ±cƒ±
    private val googleSignInLauncher =
        registerForActivityResult(ActivityResultContracts.StartActivityForResult()) { result ->
            if (result.resultCode == RESULT_OK) {
                val task = GoogleSignIn.getSignedInAccountFromIntent(result.data)
                try {
                    val account = task.getResult(ApiException::class.java)
                    val credential = GoogleAuthProvider.getCredential(account.idToken, null)

                    FirebaseAuth.getInstance().signInWithCredential(credential)
                        .addOnSuccessListener { authResult ->
                            val user = authResult.user
                            if (user != null) {
                                Log.d("GOOGLE_AUTH", "Firebase login ba≈üarƒ±lƒ±: ${user.email}")
                                Toast.makeText(
                                    this,
                                    "Giri≈ü ba≈üarƒ±lƒ±: ${user.displayName}",
                                    Toast.LENGTH_SHORT
                                ).show()

                                // ‚úÖ UserRepository ile Firestore kullanƒ±cƒ± kaydƒ±
                                CoroutineScope(Dispatchers.IO).launch {
                                    try {
                                        // ƒ∞lk kez giri≈ü yapan kullanƒ±cƒ± mƒ± kontrol et
                                        val existingUser = userRepository.getUserData()
                                        val isFirstTimeUser = existingUser == null

                                        userRepository.createUserIfNotExists()
                                        Log.d("GOOGLE_AUTH", "Kullanƒ±cƒ± Firestore'a kaydedildi/g√ºncellendi")

                                        // üì± Device ID'yi kaydet
                                        val deviceId = Settings.Secure.getString(
                                            contentResolver,
                                            Settings.Secure.ANDROID_ID
                                        )
                                        userRepository.updateUserField("deviceId", deviceId)
                                        Log.d("GOOGLE_AUTH", "Device ID kaydedildi: $deviceId")

                                        // üéÅ ƒ∞lk kez giri≈ü yapan kullanƒ±cƒ±ya 3 g√ºnl√ºk trial ver
                                        if (isFirstTimeUser) {
                                            userRepository.activateTrialForNewUser()
                                            Log.d("PREMIUM_TRIAL", "3 g√ºnl√ºk trial aktivasyonu yapƒ±ldƒ±")
                                        }

                                        // ‚úÖ FCM token'ƒ± al ve kaydet (retry logic ile)
                                        saveFCMToken()
                                    } catch (e: Exception) {
                                        Log.e("GOOGLE_AUTH", "Firestore kaydƒ± ba≈üarƒ±sƒ±z: ${e.localizedMessage}")
                                    }
                                }
                            }
                        }
                        .addOnFailureListener { e ->
                            Log.e("GOOGLE_AUTH", "Firebase login hatasƒ±: ${e.localizedMessage}")
                            Toast.makeText(this, "Hata: ${e.localizedMessage}", Toast.LENGTH_LONG)
                                .show()
                        }

                } catch (e: Exception) {
                    Log.e("GOOGLE_AUTH", "Google oturumu alƒ±namadƒ±: ${e.message}")
                    Toast.makeText(this, "Google oturumu alƒ±namadƒ±: ${e.message}", Toast.LENGTH_LONG)
                        .show()
                }
            } else {
                Log.w("GOOGLE_AUTH", "Google Sign-In iptal edildi veya ba≈üarƒ±sƒ±z.")
            }
        }


    @RequiresApi(Build.VERSION_CODES.O)
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        currentIntent = intent

        // Ba≈ülangƒ±√ßta kullanƒ±cƒ± varsa arka plan sync
        CoroutineScope(Dispatchers.IO).launch {
            val currentUser = FirebaseAuth.getInstance().currentUser
            if (currentUser != null) {
                val deviceId = Settings.Secure.getString(
                    contentResolver,
                    Settings.Secure.ANDROID_ID
                )
                userRepository.updateUserField("deviceId", deviceId)
                saveFCMToken()
            }
        }

        setContent {

            // Tema
            val themeMode by ThemePreferences.getThemeFlow(this).collectAsState(initial = "system")
            val systemInDarkTheme = isSystemInDarkTheme()
            val isDarkTheme = when (themeMode) {
                "dark" -> true
                "light" -> false
                else -> systemInDarkTheme
            }

            DoziAppTheme(darkTheme = isDarkTheme) {

                navController = rememberNavController()

                // üî• LOGIN STATE REACTIVE HALE GETƒ∞Rƒ∞Lƒ∞YOR
                val auth = FirebaseAuth.getInstance()
                var currentUser by remember { mutableStateOf(auth.currentUser) }

                DisposableEffect(Unit) {
                    val listener = FirebaseAuth.AuthStateListener { firebaseAuth ->
                        currentUser = firebaseAuth.currentUser
                    }
                    auth.addAuthStateListener(listener)

                    onDispose { auth.removeAuthStateListener(listener) }
                }

                // üî• startDestination artƒ±k currentUser'a g√∂re hesaplanƒ±yor
                // Basitle≈ütirilmi≈ü: Login varsa Home, yoksa Login
                val startDestination = remember(currentUser) {
                    if (currentUser != null) {
                        Screen.Home.route
                    } else {
                        Screen.Login.route
                    }
                }

                // Deep link i≈üle
                LaunchedEffect(Unit) {
                    handleDeepLink(intent, navController!!)
                }

                // üî• Artƒ±k login state deƒüi≈üince NavGraph otomatik g√ºncellenir
                NavGraph(
                    navController = navController!!,
                    startDestination = startDestination,
                    onGoogleSignInClick = { signInWithGoogle() }
                )
            }
        }
    }

    @RequiresApi(Build.VERSION_CODES.O)
    override fun onNewIntent(intent: Intent) {
        super.onNewIntent(intent)
        setIntent(intent)
        Log.d("MainActivity", "onNewIntent called")

        // Bildirimden tƒ±klanƒ±nca direkt navigation yap
        navController?.let { nav ->
            handleDeepLink(intent, nav)
        } ?: Log.w("MainActivity", "NavController is null in onNewIntent")
    }

    private fun handleDeepLink(intent: Intent?, navController: androidx.navigation.NavHostController) {
        Log.d("MainActivity", "handleDeepLink called with intent: $intent")
        Log.d("MainActivity", "Intent extras: ${intent?.extras?.keySet()?.joinToString()}")

        val navigationRoute = intent?.getStringExtra("navigation_route")
        Log.d("MainActivity", "navigationRoute from intent: $navigationRoute")

        if (!navigationRoute.isNullOrEmpty()) {
            Log.d("MainActivity", "Deep link detected: $navigationRoute")
            try {
                navController.navigate(navigationRoute) {
                    // Ana sayfayƒ± stack'te tut
                    popUpTo(Screen.Home.route) {
                        saveState = true
                    }
                    launchSingleTop = true
                    restoreState = true
                }
            } catch (e: Exception) {
                Log.e("MainActivity", "Navigation failed: ${e.message}")
            }
        } else {
            Log.d("MainActivity", "No navigation_route in intent extras")
        }
    }

    // üîπ Google oturum ba≈ülatma fonksiyonu
    private fun signInWithGoogle() {
        Log.d("GOOGLE_AUTH", "Google sign-in ba≈ülatƒ±lƒ±yor (Activity i√ßinden)")
        val gso = GoogleSignInOptions.Builder(GoogleSignInOptions.DEFAULT_SIGN_IN)
            .requestIdToken(getString(R.string.default_web_client_id))
            .requestEmail()
            .build()
        val client = GoogleSignIn.getClient(this, gso)
        googleSignInLauncher.launch(client.signInIntent)
    }



    private fun checkAndRequestPermissions() {
        val permissionsToRequest = mutableListOf<String>()

        // üîî Bildirim izni (Android 13+)
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            if (ContextCompat.checkSelfPermission(
                    this,
                    Manifest.permission.POST_NOTIFICATIONS
                ) != PackageManager.PERMISSION_GRANTED
            ) {
                permissionsToRequest.add(Manifest.permission.POST_NOTIFICATIONS)
            }
        }

        // üì∑ Kamera izni
        if (ContextCompat.checkSelfPermission(
                this,
                Manifest.permission.CAMERA
            ) != PackageManager.PERMISSION_GRANTED
        ) {
            permissionsToRequest.add(Manifest.permission.CAMERA)
        }

        // üìç Konum izinleri
        val fineGranted = ContextCompat.checkSelfPermission(
            this,
            Manifest.permission.ACCESS_FINE_LOCATION
        ) == PackageManager.PERMISSION_GRANTED
        val coarseGranted = ContextCompat.checkSelfPermission(
            this,
            Manifest.permission.ACCESS_COARSE_LOCATION
        ) == PackageManager.PERMISSION_GRANTED

        if (!fineGranted && !coarseGranted) {
            permissionsToRequest.addAll(
                listOf(
                    Manifest.permission.ACCESS_FINE_LOCATION,
                    Manifest.permission.ACCESS_COARSE_LOCATION
                )
            )
        }

        // üîπ Standart izinleri iste
        if (permissionsToRequest.isNotEmpty()) {
            permissionLauncher.launch(permissionsToRequest.toTypedArray())
        } else {
            // T√ºm standart izinler verilmi≈ü, kanal olu≈ütur
            NotificationHelper.createDoziChannel(this)

            // ≈ûimdi √∂zel izinleri kontrol et
            checkSpecialPermissions()
        }
    }

    private fun handlePermissionResults(permissions: Map<String, Boolean>) {
        val notifGranted = permissions[Manifest.permission.POST_NOTIFICATIONS] ?: true
        val cameraGranted = permissions[Manifest.permission.CAMERA] ?: true
        val locationGranted = permissions[Manifest.permission.ACCESS_FINE_LOCATION] ?: true

        // üîî Bildirim izni
        if (notifGranted) {
            NotificationHelper.createDoziChannel(this)
            Toast.makeText(this, "‚úÖ Bildirim izni verildi", Toast.LENGTH_SHORT).show()

            // Standart izinler tamam, ≈üimdi √∂zel izinleri kontrol et
            checkSpecialPermissions()
        } else {
            Toast.makeText(
                this,
                "üíß Dozi: Bildirim izni olmadan seni zamanƒ±nda uyaramam.",
                Toast.LENGTH_LONG
            ).show()
        }

        // üì∑ Kamera izni
        if (!cameraGranted) {
            Toast.makeText(
                this,
                "üì∑ Kamera izni verilmedi (ƒ∞la√ß barkod okuma √ßalƒ±≈ümayacak)",
                Toast.LENGTH_SHORT
            ).show()
        }

        // üìç Konum izni
        if (!locationGranted) {
            Toast.makeText(
                this,
                "üìç Konum izni verilmedi (Eczane bulma √ßalƒ±≈ümayacak)",
                Toast.LENGTH_SHORT
            ).show()
        }
    }

    private fun checkSpecialPermissions() {
        // üéØ Overlay iznini sadece ilk sefer iste
        val prefs = getSharedPreferences("dozi_prefs", MODE_PRIVATE)
        val overlayAsked = prefs.getBoolean("overlay_asked", false)

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            if (!Settings.canDrawOverlays(this) && !overlayAsked) {
                prefs.edit().putBoolean("overlay_asked", true).apply()
                // Dialog g√∂ster, direkt isteme
                showOverlayPermissionDialog()
            }
        }

        // ‚è∞ Exact Alarm iznini sadece ilk sefer iste
        val alarmAsked = prefs.getBoolean("alarm_asked", false)

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
            val alarmManager = getSystemService(AlarmManager::class.java)
            if (!alarmManager.canScheduleExactAlarms() && !alarmAsked) {
                prefs.edit().putBoolean("alarm_asked", true).apply()
                // Dialog g√∂ster, direkt isteme
                showExactAlarmPermissionDialog()
            }
        }
    }

    private fun showOverlayPermissionDialog() {
        AlertDialog.Builder(this)
            .setTitle("üíß Dozi - Ek ƒ∞zin")
            .setMessage("ƒ∞la√ß erteleme dialog'unu g√∂sterebilmem i√ßin 'Diƒüer uygulamalarƒ±n √ºzerinde g√∂sterim' iznine ihtiyacƒ±m var.\n\nBu izin olmadan erteleme √∂zelliƒüi √ßalƒ±≈ümayacak.")
            .setPositiveButton("ƒ∞zin Ver") { _, _ ->
                requestOverlayPermission()
            }
            .setNegativeButton("≈ûimdi Deƒüil", null)
            .show()
    }

    private fun showExactAlarmPermissionDialog() {
        AlertDialog.Builder(this)
            .setTitle("üíß Dozi - Alarm ƒ∞zni")
            .setMessage("ƒ∞la√ß hatƒ±rlatmalarƒ±nƒ± tam zamanƒ±nda verebilmem i√ßin alarm izni gerekiyor.\n\nBu izin olmadan hatƒ±rlatmalar gecikebilir.")
            .setPositiveButton("ƒ∞zin Ver") { _, _ ->
                requestExactAlarmPermission()
            }
            .setNegativeButton("≈ûimdi Deƒüil", null)
            .show()
    }

    private fun requestOverlayPermission() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            val intent = Intent(
                Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
                Uri.parse("package:$packageName")
            )
            overlayPermissionLauncher.launch(intent)
        }
    }

    private fun requestExactAlarmPermission() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
            val intent = Intent(Settings.ACTION_REQUEST_SCHEDULE_EXACT_ALARM).apply {
                data = Uri.parse("package:$packageName")
            }
            exactAlarmLauncher.launch(intent)
        }
    }

    /**
     * FCM token'ƒ± al ve Firestore'a kaydet (retry logic ile)
     */
    private suspend fun saveFCMToken() {
        var retryCount = 0
        val maxRetries = 3

        while (retryCount < maxRetries) {
            try {
                Log.d("FCM_TOKEN", "FCM token alƒ±nƒ±yor... (Deneme: ${retryCount + 1})")

                val fcmToken = FirebaseMessaging.getInstance().token.await()

                if (fcmToken.isNullOrEmpty()) {
                    Log.w("FCM_TOKEN", "FCM token bo≈ü geldi, tekrar deneniyor...")
                    retryCount++
                    kotlinx.coroutines.delay(2000) // 2 saniye bekle
                    continue
                }

                // Token ba≈üarƒ±yla alƒ±ndƒ±, Firestore'a kaydet
                userRepository.updateUserField("fcmToken", fcmToken)
                Log.d("FCM_TOKEN", "‚úÖ FCM token ba≈üarƒ±yla kaydedildi: ${fcmToken.take(20)}...")
                return // Ba≈üarƒ±lƒ±, fonksiyondan √ßƒ±k

            } catch (e: Exception) {
                Log.e("FCM_TOKEN", "FCM token alma hatasƒ± (Deneme ${retryCount + 1}): ${e.message}")
                retryCount++

                if (retryCount < maxRetries) {
                    kotlinx.coroutines.delay(2000) // 2 saniye bekle ve tekrar dene
                } else {
                    Log.e("FCM_TOKEN", "‚ùå FCM token kaydƒ± ba≈üarƒ±sƒ±z (${maxRetries} deneme sonrasƒ±)")
                }
            }
        }
    }
}
// ============================================================================
// FILE: SplashActivity.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/SplashActivity.kt
// [3 of 122]
// ============================================================================

package com.bardino.dozi

import android.content.Intent
import android.media.MediaPlayer
import android.net.Uri
import android.os.Build
import android.os.Bundle
import android.view.ViewGroup
import android.widget.FrameLayout
import android.widget.VideoView
import androidx.activity.ComponentActivity
import androidx.annotation.RequiresApi
import androidx.core.view.WindowCompat
import androidx.core.view.WindowInsetsCompat
import androidx.core.view.WindowInsetsControllerCompat
import kotlin.math.max

class SplashActivity : ComponentActivity() {

    @RequiresApi(Build.VERSION_CODES.O)
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // Container
        val container = FrameLayout(this)
        container.layoutParams = ViewGroup.LayoutParams(
            ViewGroup.LayoutParams.MATCH_PARENT,
            ViewGroup.LayoutParams.MATCH_PARENT
        )

        // VideoView
        val videoView = VideoView(this)
        container.addView(videoView)
        setContentView(container)

        // Tam ekran
        WindowCompat.setDecorFitsSystemWindows(window, false)
        val controller = WindowInsetsControllerCompat(window, container)
        controller.hide(WindowInsetsCompat.Type.systemBars())
        controller.systemBarsBehavior = WindowInsetsControllerCompat.BEHAVIOR_SHOW_TRANSIENT_BARS_BY_SWIPE

        // Video hazƒ±rla
        val videoUri = Uri.parse("android.resource://$packageName/${R.raw.bardino_splash}")
        videoView.setVideoURI(videoUri)

        videoView.setOnPreparedListener { mp: MediaPlayer ->
            val videoWidth = mp.videoWidth.toFloat()
            val videoHeight = mp.videoHeight.toFloat()
            val screenWidth = resources.displayMetrics.widthPixels.toFloat()
            val screenHeight = resources.displayMetrics.heightPixels.toFloat()

            // Center crop mantƒ±ƒüƒ± - ekranƒ± tamamen kaplasƒ±n
            val scale = max(screenWidth / videoWidth, screenHeight / videoHeight)

            val scaledWidth = (videoWidth * scale).toInt()
            val scaledHeight = (videoHeight * scale).toInt()

            val params = FrameLayout.LayoutParams(scaledWidth, scaledHeight)
            params.gravity = android.view.Gravity.CENTER
            videoView.layoutParams = params

            mp.start()
        }

        videoView.setOnCompletionListener {
            startActivity(Intent(this, MainActivity::class.java))
            finish()
        }

        videoView.setOnErrorListener { _, _, _ ->
            startActivity(Intent(this, MainActivity::class.java))
            finish()
            true
        }
    }
}
// ============================================================================
// FILE: NavGraph.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/navigation/NavGraph.kt
// [4 of 122]
// ============================================================================

package com.bardino.dozi.navigation

import android.os.Build
import androidx.annotation.RequiresApi
import androidx.compose.material3.Scaffold
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.navigation.NavHostController
import androidx.navigation.NavType
import androidx.navigation.compose.NavHost
import androidx.navigation.compose.composable
import androidx.navigation.compose.currentBackStackEntryAsState
import androidx.navigation.navArgument
import com.bardino.dozi.core.ui.components.DoziBottomBar
import com.bardino.dozi.core.ui.screens.home.HomeScreen
import com.bardino.dozi.core.ui.screens.medicine.CustomMedicineAddScreen
import com.bardino.dozi.core.ui.screens.medicine.MedicineDetailScreen
import com.bardino.dozi.core.ui.screens.medicine.MedicineEditScreen
import com.bardino.dozi.core.ui.screens.medicine.MedicineListScreen
import com.bardino.dozi.core.ui.screens.medicine.MedicineLookupScreen
import com.bardino.dozi.core.ui.screens.premium.PremiumScreen
import com.bardino.dozi.core.ui.screens.premium.PremiumIntroScreen
import com.bardino.dozi.core.ui.screens.login.LoginScreen
import com.bardino.dozi.core.ui.screens.profile.LocationsScreen
import com.bardino.dozi.core.ui.screens.profile.ProfileScreen
import com.bardino.dozi.core.ui.screens.reminder.AddReminderScreen
import com.bardino.dozi.core.ui.screens.reminder.ReminderListScreen
import com.bardino.dozi.core.ui.screens.settings.AboutScreen
import com.bardino.dozi.core.ui.screens.settings.AdvancedNotificationSettingsScreen
import com.bardino.dozi.core.ui.screens.settings.NotificationSettingsScreen
import com.bardino.dozi.core.ui.screens.settings.SettingsScreen
import com.bardino.dozi.core.ui.screens.badi.BadiListScreen
import com.bardino.dozi.core.ui.screens.badi.AddBadiScreen
import com.bardino.dozi.core.ui.screens.badi.BadiPermissionsScreen
import com.bardino.dozi.core.ui.screens.badi.BadiMedicationTrackingScreen
import com.bardino.dozi.core.ui.screens.stats.StatsScreen
import com.bardino.dozi.core.ui.screens.family.FamilyManagementScreen
import com.bardino.dozi.core.ui.screens.support.SupportScreen

@RequiresApi(Build.VERSION_CODES.O)
@Composable
fun NavGraph(
    navController: NavHostController,
    onGoogleSignInClick: () -> Unit,
    startDestination: String = Screen.Home.route
) {
    // Bottom bar sadece ana ekranlarda g√∂sterilecek (onboarding ekranlarƒ±nda deƒüil)
    val bottomBarRoutes = setOf(
        Screen.Home.route,
        Screen.MedicineList.route,
        Screen.ReminderList.route,
        Screen.Stats.route,
        Screen.BadiList.route,
        Screen.Profile.route
    )

    val navBackStackEntry by navController.currentBackStackEntryAsState()
    val currentRoute = navBackStackEntry?.destination?.route

    Scaffold(
        bottomBar = {
            if (currentRoute in bottomBarRoutes) {
                DoziBottomBar(
                    currentRoute = currentRoute,
                    onNavigate = { route ->
                        if (route != currentRoute) {
                            navController.navigate(route) {
                                popUpTo(Screen.Home.route) {
                                    saveState = true // ‚úÖ State'i koru
                                }
                                launchSingleTop = true
                                restoreState = true // ‚úÖ State'i geri y√ºkle
                            }
                        }
                    },
                    onLoginRequired = {
                        // Login olmayan kullanƒ±cƒ±lar profil sayfasƒ±na y√∂nlendir (login ekranƒ±)
                        navController.navigate(Screen.Profile.route) {
                            popUpTo(Screen.Home.route) {
                                saveState = true
                            }
                            launchSingleTop = true
                            restoreState = true
                        }
                    }
                )
            }
        }
    ) { padding ->
        NavHost(
            navController = navController,
            startDestination = startDestination
        ) {

            // üè† Ana Sayfa
            composable(Screen.Home.route) {
                HomeScreen(
                    navController = navController,
                    contentPadding = padding,
                    onNavigateToMedicines = { navController.navigate(Screen.MedicineList.route) },
                    onNavigateToReminders = { navController.navigate(Screen.ReminderList.route) },
                    onNavigateToProfile = { navController.navigate(Screen.Profile.route) }
                )
            }

            // üíä ƒ∞la√ß Listesi
            composable(Screen.MedicineList.route) {
                MedicineListScreen(
                    onNavigateBack = { navController.popBackStack() },
                    onNavigateToDetail = { id ->
                        navController.navigate(Screen.MedicineDetail.createRoute(id))
                    },
                    onNavigateToAddMedicine = {
                        navController.navigate(Screen.MedicineLookup.route)
                    },
                    onNavigateToAddReminder = { medicineId ->
                        navController.navigate(Screen.EditReminder.createRoute(medicineId))
                    },
                    onNavigateToReminderDetail = { reminderId ->
                        navController.navigate(Screen.EditReminder.createRoute(reminderId))
                    }
                )
            }


            // üíä ƒ∞la√ß Detayƒ±
            composable(
                route = Screen.MedicineDetail.route,
                arguments = listOf(navArgument("medicineId") { type = NavType.StringType })
            ) { backStackEntry ->
                val id = backStackEntry.arguments?.getString("medicineId").orEmpty()
                MedicineDetailScreen(
                    medicineId = id,
                    onNavigateBack = { navController.popBackStack() },
                    onEditMedicine = { medicineId ->
                        navController.navigate(Screen.MedicineEdit.createRoute(medicineId))
                    }
                )
            }

            // üßæ ƒ∞la√ß D√ºzenleme
            composable(
                route = Screen.MedicineEdit.route,
                arguments = listOf(navArgument("id") { type = NavType.StringType })
            ) { backStackEntry ->
                val id = backStackEntry.arguments?.getString("id") ?: ""
                MedicineEditScreen(
                    medicineId = id,
                    onNavigateBack = { navController.popBackStack() },
                    onNavigateToReminder = { savedMedicineId ->
                        // ƒ∞la√ß eklendikten sonra hatƒ±rlatma ekranƒ±na git
                        navController.navigate(Screen.EditReminder.createRoute(savedMedicineId)) {
                            popUpTo(Screen.MedicineList.route)
                        }
                    },
                    savedStateHandle = navController.previousBackStackEntry?.savedStateHandle
                )
            }

            // ‚è∞ Hatƒ±rlatƒ±cƒ± Listesi
            composable(Screen.ReminderList.route) {
                ReminderListScreen(
                    onNavigateBack = { navController.popBackStack() },
                    onNavigateToAddReminder = { navController.navigate(Screen.AddReminder.route) },
                    onNavigateToEditReminder = { medicineId ->
                        navController.navigate(Screen.EditReminder.createRoute(medicineId))
                    }
                )
            }

            // ‚ûï Hatƒ±rlatƒ±cƒ± Ekle
            composable(Screen.AddReminder.route) {
                AddReminderScreen(
                    navController = navController,
                    onNavigateBack = { navController.popBackStack() }
                )
            }

            // ‚úèÔ∏è Hatƒ±rlatƒ±cƒ± D√ºzenle
            composable(
                route = Screen.EditReminder.route,
                arguments = listOf(navArgument("medicineId") { type = NavType.StringType })
            ) { backStackEntry ->
                val medicineId = backStackEntry.arguments?.getString("medicineId") ?: ""
                AddReminderScreen(
                    navController = navController,
                    onNavigateBack = { navController.popBackStack() },
                    medicineId = medicineId  // Edit mode aktif
                )
            }

            // üíä ƒ∞la√ß Aksiyonu (Bildirimden)
            composable(
                route = Screen.MedicationAction.route,
                arguments = listOf(navArgument("time") { type = NavType.StringType })
            ) { backStackEntry ->
                val time = backStackEntry.arguments?.getString("time") ?: ""
                com.bardino.dozi.core.ui.screens.medication.MedicationActionScreen(
                    time = time,
                    onNavigateBack = { navController.popBackStack() }
                )
            }

            // üë§ Profil
            composable(Screen.Profile.route) {
                ProfileScreen(
                    onNavigateToLocations = { navController.navigate(Screen.Locations.route) },
                    onNavigateToPremium = { navController.navigate(Screen.Premium.route) },
                    onNavigateToFamilyManagement = { navController.navigate(Screen.FamilyManagement.route) },
                    onNavigateToSettings = { navController.navigate(Screen.Settings.route) },
                    onNavigateToNotifications = { navController.navigate(Screen.NotificationSettings.route) },
                    onNavigateToAbout = { navController.navigate(Screen.About.route) },
                    onNavigateToSupport = { navController.navigate(Screen.Support.route) },
                    onNavigateToHome = {
                        navController.navigate(Screen.Home.route) {
                            popUpTo(Screen.Home.route) { inclusive = false }
                            launchSingleTop = true
                        }
                    },
                    onGoogleSignInClick = onGoogleSignInClick
                )
            }

            // üåü Premium Sayfasƒ±
            composable(Screen.Premium.route) {
                PremiumScreen(
                    onNavigateBack = { navController.popBackStack() },
                    onPurchase = { planType ->
                        // burada satƒ±n alma i≈ülemini veya y√∂nlendirmeyi yapabilirsin
                    }
                )
            }

            // üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Aile Y√∂netimi
            composable(Screen.FamilyManagement.route) {
                FamilyManagementScreen(
                    onNavigateBack = { navController.popBackStack() }
                )
            }

            // üîç ƒ∞la√ß Arama Ekranƒ±
            composable(Screen.MedicineLookup.route) {
                MedicineLookupScreen(
                    navController = navController,
                    onNavigateBack = { navController.popBackStack() }
                )
            }

            // ‚ú® √ñzel ƒ∞la√ß Ekleme Ekranƒ±
            composable(Screen.CustomMedicineAdd.route) {
                CustomMedicineAddScreen(
                    onNavigateBack = { navController.popBackStack() },
                    onNavigateToReminder = { savedMedicineId ->
                        navController.navigate(Screen.EditReminder.createRoute(savedMedicineId)) {
                            popUpTo(Screen.MedicineList.route)
                        }
                    }
                )
            }

            // üîê Login Ekranƒ±
            composable(Screen.Login.route) {
                LoginScreen(
                    onLoginSuccess = {
                        // ƒ∞lk kez giri≈ü yapan kullanƒ±cƒ±larƒ± PremiumIntro'ya y√∂nlendir
                        navController.navigate(Screen.PremiumIntro.route) {
                            popUpTo(Screen.Login.route) { inclusive = true }
                        }
                    },
                    onSkip = {
                        navController.navigate(Screen.Home.route) {
                            popUpTo(Screen.Login.route) { inclusive = true }
                        }
                    }
                )
            }

            // üéÅ Premium Intro Ekranƒ± (ilk kez giri≈ü yapan kullanƒ±cƒ±lar i√ßin)
            composable(Screen.PremiumIntro.route) {
                PremiumIntroScreen(
                    onContinue = {
                        navController.navigate(Screen.Home.route) {
                            popUpTo(Screen.PremiumIntro.route) { inclusive = true }
                        }
                    }
                )
            }

            composable(Screen.Locations.route) {
                LocationsScreen(onNavigateBack = { navController.popBackStack() })
            }

            // ‚öôÔ∏è Ayarlar
            composable(Screen.Settings.route) {
                SettingsScreen(
                    onNavigateBack = { navController.popBackStack() }
                )
            }

            // üîî Bildirim Ayarlarƒ±
            composable(Screen.NotificationSettings.route) {
                NotificationSettingsScreen(
                    onNavigateBack = { navController.popBackStack() },
                    onNavigateToAdvanced = { navController.navigate(Screen.AdvancedNotificationSettings.route) }
                )
            }

            // üîî Geli≈ümi≈ü Bildirim Ayarlarƒ±
            composable(Screen.AdvancedNotificationSettings.route) {
                AdvancedNotificationSettingsScreen(
                    onNavigateBack = { navController.popBackStack() }
                )
            }

            // ‚ÑπÔ∏è Hakkƒ±nda
            composable(Screen.About.route) {
                AboutScreen(
                    onNavigateBack = { navController.popBackStack() },
                    onNavigateToSupport = { navController.navigate(Screen.Support.route) }
                )
            }

            // üÜò Destek / SSS
            composable(Screen.Support.route) {
                SupportScreen(onNavigateBack = { navController.popBackStack() })
            }

            // üìä ƒ∞statistikler
            composable(Screen.Stats.route) {
                StatsScreen(
                    onNavigateBack = { navController.popBackStack() },
                    contentPadding = padding
                )
            }

            // üë• Badi Listesi
            composable(Screen.BadiList.route) {
                BadiListScreen(
                    onNavigateBack = { navController.popBackStack() },
                    onNavigateToAddBadi = { navController.navigate(Screen.AddBadi.route) },
                    onNavigateToBadiDetail = { badiId ->
                        navController.navigate(Screen.BadiMedicationTracking.createRoute(badiId))
                    },
                    onNavigateToBadiPermissions = { badiId ->
                        navController.navigate(Screen.BadiPermissions.createRoute(badiId))
                    }
                )
            }

            // ‚ûï Badi Ekle
            composable(Screen.AddBadi.route) {
                AddBadiScreen(
                    onNavigateBack = { navController.popBackStack() },
                    navController = navController
                )
            }

            // ‚öôÔ∏è Badi ƒ∞zinleri
            composable(
                route = Screen.BadiPermissions.route,
                arguments = listOf(navArgument("badiId") { type = NavType.StringType })
            ) { backStackEntry ->
                val badiId = backStackEntry.arguments?.getString("badiId") ?: ""
                BadiPermissionsScreen(
                    badiId = badiId,
                    onNavigateBack = { navController.popBackStack() }
                )
            }

            // üìä Badi ƒ∞la√ß Takibi
            composable(
                route = Screen.BadiMedicationTracking.route,
                arguments = listOf(navArgument("badiId") { type = NavType.StringType })
            ) { backStackEntry ->
                val badiId = backStackEntry.arguments?.getString("badiId") ?: ""
                BadiMedicationTrackingScreen(
                    badiId = badiId,
                    onNavigateBack = { navController.popBackStack() }
                )
            }

        }
    }
}
// ============================================================================
// FILE: Screen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/navigation/Screen.kt
// [5 of 122]
// ============================================================================

package com.bardino.dozi.navigation

sealed class Screen(val route: String) {
    // Auth
    object Login : Screen("login")
    object PremiumIntro : Screen("premium_intro")

    // Main app
    object Home : Screen("home")
    object MedicineList : Screen("medicine_list")

    object MedicineDetail : Screen("medicine_detail/{medicineId}") {
        fun createRoute(id: String) = "medicine_detail/$id"
    }

    object MedicineEdit : Screen("medicine_edit/{id}") {
        fun createRoute(id: String) = "medicine_edit/$id"
    }

    object MedicineLookup : Screen("medicine_lookup")
    object CustomMedicineAdd : Screen("custom_medicine_add")
    object ReminderList : Screen("reminder_list")
    object AddReminder : Screen("add_reminder")
    object EditReminder : Screen("edit_reminder/{medicineId}") {
        fun createRoute(medicineId: String) = "edit_reminder/$medicineId"
    }
    object Profile : Screen("profile")
    object Premium : Screen("premium")
    object Locations : Screen("locations")
    object Settings : Screen("settings")
    object NotificationSettings : Screen("notification_settings")
    object AdvancedNotificationSettings : Screen("advanced_notification_settings")
    object About : Screen("about")
    object Support : Screen("support")

    // Stats
    object Stats : Screen("stats")

    // Badi System
    object BadiList : Screen("badi_list")
    object AddBadi : Screen("add_badi")
    object BadiPermissions : Screen("badi_permissions/{badiId}") {
        fun createRoute(badiId: String) = "badi_permissions/$badiId"
    }
    object BadiMedicationTracking : Screen("badi_medication_tracking/{badiId}") {
        fun createRoute(badiId: String) = "badi_medication_tracking/$badiId"
    }

    // Medication Action (from notification)
    object MedicationAction : Screen("medication_action/{time}") {
        fun createRoute(time: String) = "medication_action/$time"
    }

    // Family Management
    object FamilyManagement : Screen("family_management")

}
// ============================================================================
// FILE: Constants.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/common/Constants.kt
// [6 of 122]
// ============================================================================

package com.bardino.dozi.core.common

object Constants {
    const val DATABASE_NAME = "dozi_database"
    const val PREFERENCES_NAME = "dozi_preferences"

    // Plan Limitleri
    const val FREE_MEDICINE_LIMIT = 1
    const val FREE_REMINDER_LIMIT = 2  // time slot bazlƒ±
    const val EKSTRA_BADI_LIMIT = 1
    const val AILE_MAX_MEMBERS = 4  // organizer dahil
    const val TRIAL_DURATION_DAYS = 3

    // Sƒ±nƒ±rsƒ±z i√ßin kullanƒ±lan deƒüer
    const val UNLIMITED = -1

    // Notification Channels
    const val REMINDER_CHANNEL_ID = "reminder_channel"
    const val BUDDY_CHANNEL_ID = "buddy_channel"
    const val CRITICAL_CHANNEL_ID = "critical_channel"

    // UI
    const val MIN_TOUCH_TARGET_DP = 48
}
// ============================================================================
// FILE: Result.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/common/Result.kt
// [7 of 122]
// ============================================================================

package com.bardino.dozi.core.common

sealed interface Result<out T> {
    data class Success<T>(val data: T) : Result<T>
    data class Error(val message: String, val cause: Throwable? = null) : Result<Nothing>
    object Loading : Result<Nothing>
}
// ============================================================================
// FILE: Achievement.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/model/Achievement.kt
// [8 of 122]
// ============================================================================

package com.bardino.dozi.core.data.model

import com.google.firebase.Timestamp
import com.google.firebase.firestore.ServerTimestamp

/**
 * üèÜ Ba≈üarƒ±/Rozet Sistemi
 */
data class Achievement(
    val id: String = "",
    val userId: String = "",
    val type: AchievementType = AchievementType.STREAK_7_DAYS,
    val isUnlocked: Boolean = false,
    @ServerTimestamp
    val unlockedAt: Timestamp? = null,
    val progress: Int = 0,              // Mevcut ilerleme
    val target: Int = 0,                // Hedef (√∂rn: 7 g√ºn, 10 ila√ß)
    @ServerTimestamp
    val createdAt: Timestamp? = null
)

/**
 * üéñÔ∏è Ba≈üarƒ± Tipleri
 */
enum class AchievementType(
    val displayName: String,
    val description: String,
    val emoji: String,
    val target: Int,
    val color: String
) {
    // üî• Streak Ba≈üarƒ±larƒ±
    STREAK_7_DAYS(
        "Ate≈üli Ba≈ülangƒ±√ß",
        "7 g√ºn √ºst √ºste ila√ß al",
        "üî•",
        7,
        "#FF5722"
    ),
    STREAK_30_DAYS(
        "Kararlƒ±",
        "30 g√ºn √ºst √ºste ila√ß al",
        "üí™",
        30,
        "#FF9800"
    ),
    STREAK_100_DAYS(
        "Efsane",
        "100 g√ºn √ºst √ºste ila√ß al",
        "üåü",
        100,
        "#FFC107"
    ),
    STREAK_365_DAYS(
        "Yƒ±lƒ±n Kralƒ±",
        "365 g√ºn √ºst √ºste ila√ß al",
        "üëë",
        365,
        "#FFD700"
    ),

    // üéØ Uyum Ba≈üarƒ±larƒ±
    PERFECT_WEEK(
        "M√ºkemmel Hafta",
        "Bir hafta boyunca %100 uyum saƒüla",
        "‚≠ê",
        7,
        "#4CAF50"
    ),
    PERFECT_MONTH(
        "M√ºkemmel Ay",
        "Bir ay boyunca %100 uyum saƒüla",
        "üèÖ",
        30,
        "#2196F3"
    ),

    // üèÖ ƒ∞lk Adƒ±mlar
    FIRST_MEDICINE(
        "ƒ∞lk Adƒ±m",
        "ƒ∞lk ilacƒ±nƒ± ekle",
        "üíä",
        1,
        "#9C27B0"
    ),
    FIRST_DOSE_TAKEN(
        "Ba≈ülangƒ±√ß",
        "ƒ∞lk dozunu al",
        "‚úÖ",
        1,
        "#00BCD4"
    ),

    // üìö Koleksiyon Ba≈üarƒ±larƒ±
    MEDICINE_COLLECTOR_5(
        "Yeni Ba≈ülayan",
        "5 farklƒ± ila√ß ekle",
        "üì¶",
        5,
        "#795548"
    ),
    MEDICINE_COLLECTOR_10(
        "Uzman",
        "10 farklƒ± ila√ß ekle",
        "üìö",
        10,
        "#607D8B"
    ),

    // üìä Toplam Doz Ba≈üarƒ±larƒ±
    TOTAL_DOSES_50(
        "Yarƒ±m Y√ºzyƒ±l",
        "Toplam 50 doz al",
        "üéØ",
        50,
        "#E91E63"
    ),
    TOTAL_DOSES_100(
        "Y√ºz√ºnc√º Doz",
        "Toplam 100 doz al",
        "üíØ",
        100,
        "#F44336"
    ),
    TOTAL_DOSES_365(
        "Yƒ±llƒ±k Ba≈üarƒ±",
        "Toplam 365 doz al",
        "üéä",
        365,
        "#9C27B0"
    ),
    TOTAL_DOSES_1000(
        "Binyƒ±l",
        "Toplam 1000 doz al",
        "üèÜ",
        1000,
        "#FFD700"
    );

    fun getProgressPercentage(current: Int): Float {
        if (target == 0) return 0f
        return (current.toFloat() / target * 100).coerceIn(0f, 100f)
    }
}

/**
 * Note: UserStats model is defined in UserStats.kt
 * Fields used for achievements:
 * - currentStreak: Int
 * - longestStreak: Int
 * - totalMedicationsTaken: Int (total doses)
 * - achievements: List<String>
 */
// ============================================================================
// FILE: Badi.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/model/Badi.kt
// [9 of 122]
// ============================================================================

package com.bardino.dozi.core.data.model

import com.google.firebase.Timestamp
import com.google.firebase.firestore.DocumentId
import com.google.firebase.firestore.ServerTimestamp

/**
 * Kullanƒ±cƒ±lar arasƒ± badi ili≈ükisini temsil eder
 */
data class Badi(
    @DocumentId
    val id: String = "",
    val userId: String = "",                    // ƒ∞steƒüi g√∂nderen/olu≈üturan kullanƒ±cƒ±
    val buddyUserId: String = "",               // Badi olan kullanƒ±cƒ±
    val status: BadiStatus = BadiStatus.ACTIVE,
    @ServerTimestamp
    val createdAt: Timestamp? = null,
    val nickname: String? = null,                // Badi i√ßin √∂zel isim
    val permissions: BadiPermissions = BadiPermissions(),
    val notificationPreferences: BadiNotificationPreferences = BadiNotificationPreferences(),
    @ServerTimestamp
    val lastInteraction: Timestamp? = null
)

/**
 * Badi rolleri
 */
enum class BadiRole {
    VIEWER,      // Sadece g√∂r√ºnt√ºleme
    HELPER,      // ƒ∞la√ß aldƒ± i≈üaretleyebilir
    CAREGIVER,   // ƒ∞la√ß ekle/d√ºzenle
    ADMIN        // T√ºm yetkiler
}

/**
 * Badi izinleri
 */
data class BadiPermissions(
    val role: BadiRole = BadiRole.VIEWER,       // Badi rol√º
    val canViewReminders: Boolean = true,         // Hatƒ±rlatmalarƒ± g√∂r√ºnt√ºleyebilir
    val canReceiveNotifications: Boolean = true,  // Bildirim alabilir
    val canMarkAsTaken: Boolean = false,          // ƒ∞la√ß aldƒ± i≈üaretleyebilir
    val canEditReminders: Boolean = false,        // Hatƒ±rlatmalarƒ± d√ºzenleyebilir
    val canAddMedicine: Boolean = false,          // Yeni ila√ß ekleyebilir
    val canDeleteMedicine: Boolean = false,       // ƒ∞la√ß silebilir
    val canViewMedicationHistory: Boolean = true, // ƒ∞la√ß ge√ßmi≈üini g√∂r√ºnt√ºleyebilir
    val canManageBadis: Boolean = false         // Diƒüer badileri y√∂netebilir
) {
    companion object {
        /**
         * Rol bazlƒ± izin seti d√∂nd√ºr
         */
        fun fromRole(role: BadiRole): BadiPermissions {
            return when (role) {
                BadiRole.VIEWER -> BadiPermissions(
                    role = role,
                    canViewReminders = true,
                    canReceiveNotifications = true,
                    canMarkAsTaken = false,
                    canEditReminders = false,
                    canAddMedicine = false,
                    canDeleteMedicine = false,
                    canViewMedicationHistory = true,
                    canManageBadis = false
                )
                BadiRole.HELPER -> BadiPermissions(
                    role = role,
                    canViewReminders = true,
                    canReceiveNotifications = true,
                    canMarkAsTaken = true,          // ‚úÖ ƒ∞la√ß aldƒ± i≈üaretleyebilir
                    canEditReminders = false,
                    canAddMedicine = false,
                    canDeleteMedicine = false,
                    canViewMedicationHistory = true,
                    canManageBadis = false
                )
                BadiRole.CAREGIVER -> BadiPermissions(
                    role = role,
                    canViewReminders = true,
                    canReceiveNotifications = true,
                    canMarkAsTaken = true,
                    canEditReminders = true,        // ‚úÖ ƒ∞la√ß d√ºzenleyebilir
                    canAddMedicine = true,          // ‚úÖ ƒ∞la√ß ekleyebilir
                    canDeleteMedicine = false,
                    canViewMedicationHistory = true,
                    canManageBadis = false
                )
                BadiRole.ADMIN -> BadiPermissions(
                    role = role,
                    canViewReminders = true,
                    canReceiveNotifications = true,
                    canMarkAsTaken = true,
                    canEditReminders = true,
                    canAddMedicine = true,
                    canDeleteMedicine = true,       // ‚úÖ ƒ∞la√ß silebilir
                    canViewMedicationHistory = true,
                    canManageBadis = true         // ‚úÖ Badileri y√∂netebilir
                )
            }
        }
    }
}

/**
 * Badi rol√º i√ßin T√ºrk√ße isimler
 */
fun BadiRole.toTurkish(): String = when (this) {
    BadiRole.VIEWER -> "ƒ∞zleyici"
    BadiRole.HELPER -> "Yardƒ±mcƒ±"
    BadiRole.CAREGIVER -> "Bakƒ±cƒ±"
    BadiRole.ADMIN -> "Y√∂netici"
}

/**
 * Badi rol√º i√ßin a√ßƒ±klama
 */
fun BadiRole.toDescription(): String = when (this) {
    BadiRole.VIEWER -> "Sadece ila√ß hatƒ±rlatmalarƒ±nƒ± ve ge√ßmi≈üi g√∂r√ºnt√ºleyebilir"
    BadiRole.HELPER -> "ƒ∞la√ß alƒ±ndƒ± olarak i≈üaretleyebilir"
    BadiRole.CAREGIVER -> "ƒ∞la√ß ekleyebilir ve d√ºzenleyebilir"
    BadiRole.ADMIN -> "T√ºm yetkiler (ila√ß ekleme, silme, badi y√∂netimi)"
}

/**
 * Badi bildirim tercihleri
 */
data class BadiNotificationPreferences(
    val onMedicationTime: Boolean = true,        // ƒ∞la√ß zamanƒ± geldiƒüinde bildir
    val onMedicationTaken: Boolean = true,       // ƒ∞la√ß alƒ±ndƒ±ƒüƒ±nda bildir
    val onMedicationSkipped: Boolean = true,     // ƒ∞la√ß atlandƒ±ƒüƒ±nda bildir
    val onMedicationMissed: Boolean = true       // ƒ∞la√ß ka√ßƒ±rƒ±ldƒ±ƒüƒ±nda bildir
)

/**
 * Badi durumu
 */
enum class BadiStatus {
    ACTIVE,      // Aktif badi ili≈ükisi
    PAUSED,      // Ge√ßici olarak duraklatƒ±lmƒ±≈ü
    REMOVED      // Kaldƒ±rƒ±lmƒ±≈ü
}

/**
 * Badi ile birlikte kullanƒ±cƒ± bilgilerini i√ßeren model
 * (UI'da g√∂stermek i√ßin)
 */
data class BadiWithUser(
    val badi: Badi,
    val user: User
)

// ============================================================================
// FILE: BadiRequest.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/model/BadiRequest.kt
// [10 of 122]
// ============================================================================

package com.bardino.dozi.core.data.model

import com.google.firebase.Timestamp
import com.google.firebase.firestore.DocumentId
import com.google.firebase.firestore.ServerTimestamp

/**
 * Badi isteƒüini temsil eder
 */
data class BadiRequest(
    @DocumentId
    val id: String = "",
    val fromUserId: String = "",              // ƒ∞steƒüi g√∂nderen
    val toUserId: String = "",                // ƒ∞steƒüi alan
    val fromUserName: String = "",            // G√∂nderenin adƒ± (bildirim i√ßin)
    val fromUserPhoto: String = "",           // G√∂nderenin fotoƒürafƒ±
    val toUserEmail: String? = null,          // Email ile g√∂nderildiyse
    val toBuddyCode: String? = null,          // Kod ile g√∂nderildiyse
    val status: BadiRequestStatus = BadiRequestStatus.PENDING,
    val message: String? = null,              // √ñzel mesaj
    @ServerTimestamp
    val createdAt: Timestamp? = null,
    val expiresAt: Timestamp? = null,         // 7 g√ºn sonra otomatik iptal
    @ServerTimestamp
    val respondedAt: Timestamp? = null
)

/**
 * Badi isteƒüi durumu
 */
enum class BadiRequestStatus {
    PENDING,    // Beklemede
    ACCEPTED,   // Kabul edildi
    REJECTED,   // Reddedildi
    EXPIRED     // S√ºresi doldu
}

/**
 * Badi isteƒüi ile birlikte kullanƒ±cƒ± bilgilerini i√ßeren model
 * (UI'da g√∂stermek i√ßin)
 */
data class BadiRequestWithUser(
    val request: BadiRequest,
    val fromUser: User
)

// ============================================================================
// FILE: DoziNotification.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/model/DoziNotification.kt
// [11 of 122]
// ============================================================================

package com.bardino.dozi.core.data.model

import com.google.firebase.Timestamp
import com.google.firebase.firestore.DocumentId
import com.google.firebase.firestore.ServerTimestamp

/**
 * Dozi uygulamasƒ± bildirimleri
 * Hem app i√ßi hem de push notification i√ßin kullanƒ±lƒ±r
 */
data class DoziNotification(
    @DocumentId
    val id: String = "",
    val userId: String = "",                    // Bildirimi alan kullanƒ±cƒ±
    val type: NotificationType = NotificationType.GENERAL,
    val title: String = "",
    val body: String = "",
    val data: Map<String, String> = emptyMap(), // Ekstra veriler
    val isRead: Boolean = false,
    val isSent: Boolean = false,                // Push notification g√∂nderildi mi?
    @ServerTimestamp
    val sentAt: Timestamp? = null,
    @ServerTimestamp
    val readAt: Timestamp? = null,
    @ServerTimestamp
    val createdAt: Timestamp? = null,
    val priority: NotificationPriority = NotificationPriority.NORMAL,
    val actionUrl: String? = null,              // Deep link
    val imageUrl: String? = null                // Bildirim g√∂rseli
)

/**
 * Bildirim t√ºr√º
 */
enum class NotificationType {
    GENERAL,                        // Genel bildirim
    BADI_REQUEST,                  // Buddy isteƒüi
    BADI_ACCEPTED,                 // Buddy isteƒüi kabul edildi
    BADI_REJECTED,                 // Buddy isteƒüi reddedildi
    MEDICATION_REMINDER,            // ƒ∞la√ß hatƒ±rlatmasƒ±
    BADI_MEDICATION_ALERT,         // Buddy ila√ß uyarƒ±sƒ±
    MEDICATION_TAKEN,               // ƒ∞la√ß alƒ±ndƒ± bildirimi
    MEDICATION_MISSED,              // ƒ∞la√ß ka√ßƒ±rƒ±ldƒ± uyarƒ±sƒ±
    CRITICAL_MEDICATION_MISSED,     // üö® Kritik ila√ß ka√ßƒ±rƒ±ldƒ± (escalation)
    STOCK_LOW,                      // Stok azaldƒ±
    STOCK_EMPTY,                    // Stok bitti
    SYSTEM                          // Sistem bildirimi
}

/**
 * Bildirim √∂nceliƒüi
 */
enum class NotificationPriority {
    LOW,
    NORMAL,
    HIGH
}

/**
 * Bildirim t√ºr√º i√ßin T√ºrk√ße isimler
 */
fun NotificationType.toTurkish(): String = when (this) {
    NotificationType.GENERAL -> "Genel"
    NotificationType.BADI_REQUEST -> "Badi ƒ∞steƒüi"
    NotificationType.BADI_ACCEPTED -> "Badi Kabul Edildi"
    NotificationType.BADI_REJECTED -> "Badi Reddedildi"
    NotificationType.MEDICATION_REMINDER -> "ƒ∞la√ß Hatƒ±rlatmasƒ±"
    NotificationType.BADI_MEDICATION_ALERT -> "Badi ƒ∞la√ß Uyarƒ±sƒ±"
    NotificationType.MEDICATION_TAKEN -> "ƒ∞la√ß Alƒ±ndƒ±"
    NotificationType.MEDICATION_MISSED -> "ƒ∞la√ß Ka√ßƒ±rƒ±ldƒ±"
    NotificationType.CRITICAL_MEDICATION_MISSED -> "Kritik ƒ∞la√ß Ka√ßƒ±rƒ±ldƒ±"
    NotificationType.STOCK_LOW -> "Stok Azaldƒ±"
    NotificationType.STOCK_EMPTY -> "Stok Bitti"
    NotificationType.SYSTEM -> "Sistem"
}

/**
 * Bildirim t√ºr√º i√ßin emoji
 */
fun NotificationType.toEmoji(): String = when (this) {
    NotificationType.GENERAL -> "üì¢"
    NotificationType.BADI_REQUEST -> "ü§ù"
    NotificationType.BADI_ACCEPTED -> "‚úÖ"
    NotificationType.BADI_REJECTED -> "‚ùå"
    NotificationType.MEDICATION_REMINDER -> "üíä"
    NotificationType.BADI_MEDICATION_ALERT -> "‚ö†Ô∏è"
    NotificationType.MEDICATION_TAKEN -> "‚úÖ"
    NotificationType.MEDICATION_MISSED -> "‚ùå"
    NotificationType.CRITICAL_MEDICATION_MISSED -> "üö®"
    NotificationType.STOCK_LOW -> "üìâ"
    NotificationType.STOCK_EMPTY -> "üö´"
    NotificationType.SYSTEM -> "‚öôÔ∏è"
}

// ============================================================================
// FILE: FAQ.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/model/FAQ.kt
// [12 of 122]
// ============================================================================

package com.bardino.dozi.core.data.model

data class FAQ(
    val id: String = "",
    val question: String = "",
    val answer: String = "",
    val category: String = "",
    val order: Int = 0,
    val isActive: Boolean = true
)

data class FAQCategory(
    val id: String = "",
    val name: String = "",
    val icon: String = "",
    val order: Int = 0
)

// ============================================================================
// FILE: FamilyPlan.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/model/FamilyPlan.kt
// [13 of 122]
// ============================================================================

package com.bardino.dozi.core.data.model

import com.google.firebase.Timestamp
import com.google.firebase.firestore.DocumentId
import com.google.firebase.firestore.ServerTimestamp

/**
 * Aile Paketi Modeli
 *
 * Ana hesap (organizer) bir aile planƒ± olu≈üturur ve en fazla 3 ki≈üiyi davet edebilir.
 * Organizer dahil toplam 4 ki≈üi premium √∂zelliklerden yararlanƒ±r.
 */
data class FamilyPlan(
    @DocumentId
    val id: String = "",

    // Organizat√∂r (Plan Sahibi) Bilgileri
    val organizerId: String = "",           // Ana hesabƒ±n userId
    val organizerEmail: String = "",
    val organizerName: String = "",

    // Plan Detaylarƒ±
    val planType: String = "FAMILY_PREMIUM", // Aile premium planƒ±
    val maxMembers: Int = 4,                 // Organizer dahil maksimum 4 ki≈üi
    val currentMembers: List<String> = emptyList(), // √úye userId'leri

    // Davet Kodu
    val invitationCode: String = "",         // 6 haneli benzersiz kod

    // Durum
    val status: FamilyPlanStatus = FamilyPlanStatus.ACTIVE,

    // Tarihler
    @ServerTimestamp
    val createdAt: Timestamp? = null,
    val expiresAt: Timestamp? = null,        // Premium biti≈ü tarihi
    val updatedAt: Timestamp? = null
) {
    /**
     * Aile planƒ±nda yer var mƒ±?
     */
    fun hasAvailableSlots(): Boolean {
        return currentMembers.size < maxMembers
    }

    fun getAvailableSlots(): Int {
        return maxMembers - currentMembers.size
    }

    /**
     * Kullanƒ±cƒ± bu aile planƒ±nƒ±n √ºyesi mi?
     */
    fun isMember(userId: String): Boolean {
        return userId == organizerId || currentMembers.contains(userId)
    }

    /**
     * Plan aktif mi?
     */
    fun isActive(): Boolean {
        return status == FamilyPlanStatus.ACTIVE &&
               (expiresAt == null || expiresAt.toDate().time > System.currentTimeMillis())
    }
}

/**
 * Aile Planƒ± Durumu
 */
enum class FamilyPlanStatus {
    ACTIVE,      // Aktif
    CANCELLED,   // ƒ∞ptal edildi
    EXPIRED      // S√ºresi doldu
}

/**
 * Kullanƒ±cƒ±nƒ±n aile planƒ±ndaki rol√º
 */
enum class FamilyRole {
    ORGANIZER,   // Plan sahibi (ana hesap)
    MEMBER       // Aile √ºyesi
}

// ============================================================================
// FILE: MedicationLog.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/model/MedicationLog.kt
// [14 of 122]
// ============================================================================

package com.bardino.dozi.core.data.model

import com.google.firebase.Timestamp
import com.google.firebase.firestore.DocumentId
import com.google.firebase.firestore.GeoPoint
import com.google.firebase.firestore.ServerTimestamp

/**
 * ƒ∞la√ß alma ge√ßmi≈üini temsil eder
 */
data class MedicationLog(
    @DocumentId
    val id: String = "",
    val userId: String = "",                    // ƒ∞la√ß alan kullanƒ±cƒ±
    val medicineId: String = "",                // ƒ∞la√ß ID
    val medicineName: String = "",
    val dosage: String = "",
    val scheduledTime: Timestamp? = null,       // Planlanmƒ±≈ü zaman
    val takenAt: Timestamp? = null,             // Ger√ßek alma zamanƒ±
    val status: MedicationStatus = MedicationStatus.PENDING,
    val notes: String? = null,
    val sideEffects: List<String> = emptyList(), // Yan etkiler
    val mood: String? = null,                   // Ruh hali
    val location: GeoPoint? = null,             // Konum
    @ServerTimestamp
    val createdAt: Timestamp? = null,
    @ServerTimestamp
    val updatedAt: Timestamp? = null
)

/**
 * ƒ∞la√ß alma durumu
 */
enum class MedicationStatus {
    PENDING,    // Beklemede (hen√ºz zaman gelmedi)
    TAKEN,      // Alƒ±ndƒ±
    SKIPPED,    // Atlandƒ± (kullanƒ±cƒ± atlayƒ± dedi)
    MISSED,     // Ka√ßƒ±rƒ±ldƒ± (zaman ge√ßti, alƒ±nmadƒ±)
    SNOOZED     // Ertelendi
}

/**
 * ƒ∞la√ß alma durumu i√ßin T√ºrk√ße isimler
 */
fun MedicationStatus.toTurkish(): String = when (this) {
    MedicationStatus.PENDING -> "Beklemede"
    MedicationStatus.TAKEN -> "Alƒ±ndƒ±"
    MedicationStatus.SKIPPED -> "Atlandƒ±"
    MedicationStatus.MISSED -> "Ka√ßƒ±rƒ±ldƒ±"
    MedicationStatus.SNOOZED -> "Ertelendi"
}

/**
 * ƒ∞la√ß alma durumu i√ßin emoji
 */
fun MedicationStatus.toEmoji(): String = when (this) {
    MedicationStatus.PENDING -> "‚è≥"
    MedicationStatus.TAKEN -> "‚úÖ"
    MedicationStatus.SKIPPED -> "‚è≠Ô∏è"
    MedicationStatus.MISSED -> "‚ùå"
    MedicationStatus.SNOOZED -> "‚è∞"
}

/**
 * ƒ∞la√ß log'u ile birlikte ila√ß bilgilerini i√ßeren model
 */
data class MedicationLogWithMedicine(
    val log: MedicationLog,
    val medicine: Medicine
)

/**
 * G√ºnl√ºk ila√ß ge√ßmi≈üi
 */
data class DailyMedicationLogs(
    val date: String,                           // "2025-11-14"
    val logs: List<MedicationLog>,
    val takenCount: Int,
    val missedCount: Int,
    val skippedCount: Int,
    val totalCount: Int
) {
    val completionRate: Float
        get() = if (totalCount > 0) takenCount.toFloat() / totalCount else 0f
}

// ============================================================================
// FILE: Medicine.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/model/Medicine.kt
// [15 of 122]
// ============================================================================

package com.bardino.dozi.core.data.model

/**
 * Firestore-compatible Medicine data model
 * Represents a medicine with its schedule and dosage information
 */
data class Medicine(
    val id: String = "",
    val userId: String = "",                    // Firebase Auth UID
    val name: String = "",
    val dosage: String = "",                    // "1", "1.5", "2" etc.
    val unit: String = "hap",                   // hap, doz, mg, ml, adet, damla, ka≈üƒ±k
    val form: String = "tablet",                // tablet, kaps√ºl, ≈üurup, damla
    val times: List<String> = emptyList(),      // ["09:00", "13:00", "21:00"]
    val days: List<String> = emptyList(),       // ["Pazartesi", "Salƒ±"] or empty for everyday
    val frequency: String = "Her g√ºn",          // "Her g√ºn", "G√ºn a≈üƒ±rƒ±", "Haftada bir", "Her X g√ºnde bir", "ƒ∞stediƒüim tarihlerde"
    val frequencyValue: Int = 1,                // X value for "Her X g√ºnde bir"
    val startDate: Long = 0L,                   // Timestamp
    val endDate: Long? = null,                  // Null = s√ºrekli kullanƒ±m

    // üì¶ Stok Takip Sistemi
    val stockCount: Int = 0,                    // Kalan ila√ß sayƒ±sƒ±
    val boxSize: Int = 0,                       // Bir kutudaki ila√ß sayƒ±sƒ±
    val stockWarningThreshold: Int = 7,         // Ka√ß g√ºnl√ºk kaldƒ±ƒüƒ±nda uyarƒ± verilsin
    val lastRestockDate: Long? = null,          // Son stok yenileme tarihi
    val autoDecrementEnabled: Boolean = true,   // Aldƒ±m dendiƒüinde otomatik azalsƒ±n mƒ±?

    val notes: String = "",
    val createdAt: Long = System.currentTimeMillis(),
    val updatedAt: Long = System.currentTimeMillis(),
    val reminderEnabled: Boolean = true,
    val reminderName: String = "",              // Hatƒ±rlatma adƒ± (√∂r: "Sabah ƒ∞lacƒ±m", "Kahvaltƒ±dan √ñnce")
    val icon: String = "üíä",                    // Emoji icon for visual display

    // ü§ù Badi sistem i√ßin yeni alanlar
    val sharedWithBadis: List<String> = emptyList(), // Payla≈üƒ±lan badi userId'leri
    val barcode: String? = null,                // Barkod/QR kod
    val imageUrl: String? = null,               // ƒ∞la√ß fotoƒürafƒ±
    val manufacturer: String? = null,           // √úretici firma
    val activeIngredient: String? = null,       // Etken madde

    // üö® Acil durum ve kritiklik ayarlarƒ±
    val criticalityLevel: MedicineCriticality = MedicineCriticality.ROUTINE,  // ƒ∞la√ß kritiklik seviyesi

    // üí° Motivasyon ve g√∂rselle≈ütirme
    val motivationReason: String = "",           // "≈ûeker hastalƒ±ƒüƒ±m i√ßin", "Saƒülƒ±klƒ± kalmak i√ßin"
    val color: MedicineColor = MedicineColor.BLUE , // ƒ∞la√ß renk kategorisi

    val selectedDays: List<String> = emptyList(),
    val selectedDates: List<String> = emptyList(),

    // üé® √ñzel ila√ß desteƒüi
    val isCustom: Boolean = false                   // Kullanƒ±cƒ± tarafƒ±ndan eklenen √∂zel ila√ß mƒ±?
)

/**
 * ƒ∞la√ß kritiklik seviyeleri
 */
enum class MedicineCriticality {
    ROUTINE,      // Normal ila√ß - DND'ye uyar
    IMPORTANT,    // √ñnemli ila√ß - DND'de sessiz bildirim
    CRITICAL      // Kritik ila√ß - DND'yi bypass eder
}

/**
 * ƒ∞la√ß renk kategorileri (g√∂rsel ayƒ±rt etme i√ßin)
 */
enum class MedicineColor(val displayName: String, val hexColor: String, val emoji: String) {
    BLUE("Mavi", "#2196F3", "üíô"),        // Genel ila√ßlar
    RED("Kƒ±rmƒ±zƒ±", "#F44336", "‚ù§Ô∏è"),      // Kalp/tansiyon
    GREEN("Ye≈üil", "#4CAF50", "üíö"),      // Vitamin/takviye
    YELLOW("Sarƒ±", "#FFEB3B", "üíõ"),      // Aƒürƒ± kesici
    PURPLE("Mor", "#9C27B0", "üíú"),       // Antibiyotik
    ORANGE("Turuncu", "#FF9800", "üß°"),   // ≈ûeker ila√ßlarƒ±
    PINK("Pembe", "#E91E63", "üíó"),       // Hormon
    BROWN("Kahverengi", "#795548", "ü§é")  // Diƒüer
}

// üì¶ Stock Management Extensions
/**
 * G√ºnl√ºk kullanƒ±m miktarƒ±nƒ± hesapla
 */
fun Medicine.dailyUsage(): Double {
    if (times.isEmpty()) return 0.0
    val dosageAmount = dosage.toDoubleOrNull() ?: 1.0
    
    return when (frequency) {
        "Her g√ºn" -> dosageAmount * times.size
        "G√ºn a≈üƒ±rƒ±" -> (dosageAmount * times.size) / 2.0
        "Haftada bir" -> (dosageAmount * times.size) / 7.0
        "Her X g√ºnde bir" -> (dosageAmount * times.size) / frequencyValue.toDouble()
        else -> dosageAmount * times.size // Default: her g√ºn
    }
}

/**
 * Stokta ka√ß g√ºn kaldƒ±ƒüƒ±nƒ± hesapla
 */
fun Medicine.daysRemainingInStock(): Int {
    if (stockCount <= 0) return 0
    val daily = dailyUsage()
    if (daily <= 0) return Int.MAX_VALUE
    
    return (stockCount / daily).toInt()
}

/**
 * Stok azaldƒ± mƒ±? (threshold'a g√∂re)
 */
fun Medicine.isStockLow(): Boolean {
    return daysRemainingInStock() <= stockWarningThreshold
}

/**
 * Stok bitmek √ºzere mi?
 */
fun Medicine.isStockCritical(): Boolean {
    return stockCount > 0 && daysRemainingInStock() <= 3
}

/**
 * Stok tamamen bitti mi?
 */
fun Medicine.isStockEmpty(): Boolean {
    return stockCount <= 0
}

/**
 * Stok uyarƒ± mesajƒ±
 */
fun Medicine.getStockWarningMessage(): String? {
    return when {
        isStockEmpty() -> "‚ö†Ô∏è $name stoƒüu bitti! Yenilemeyi unutma."
        isStockCritical() -> "üî¥ $name stoƒüu ${daysRemainingInStock()} g√ºn sonra bitecek!"
        isStockLow() -> "üü° $name stoƒüu ${daysRemainingInStock()} g√ºn sonra bitecek."
        else -> null
    }
}

/**
 * Stok seviyesi rengi
 */
fun Medicine.getStockLevelColor(): String {
    return when {
        isStockEmpty() -> "#F44336" // Red
        isStockCritical() -> "#FF5722" // Deep Orange
        isStockLow() -> "#FF9800" // Orange
        else -> "#4CAF50" // Green
    }
}

/**
 * Stoƒüu azalt ve yeni Medicine d√∂nd√ºr
 */
fun Medicine.decrementStock(amount: Double = dosage.toDoubleOrNull() ?: 1.0): Medicine {
    if (!autoDecrementEnabled || stockCount <= 0) return this
    
    val newCount = (stockCount - amount.toInt()).coerceAtLeast(0)
    return this.copy(
        stockCount = newCount,
        updatedAt = System.currentTimeMillis()
    )
}

/**
 * Stoƒüu artƒ±r (yeni kutu ekleme)
 */
fun Medicine.addStock(amount: Int): Medicine {
    return this.copy(
        stockCount = stockCount + amount,
        lastRestockDate = System.currentTimeMillis(),
        updatedAt = System.currentTimeMillis()
    )
}

// ============================================================================
// FILE: Premium.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/model/Premium.kt
// [16 of 122]
// ============================================================================

package com.bardino.dozi.core.data.model

import com.google.firebase.Timestamp
import com.google.firebase.firestore.ServerTimestamp

/**
 * üåü Dozi Ekstra (Premium) Subscription Model
 *
 * Kullanƒ±cƒ±nƒ±n premium durumunu, plan tipini ve s√ºresini y√∂netir.
 */
data class PremiumSubscription(
    val userId: String = "",
    val isActive: Boolean = false,
    val planType: PremiumPlanType = PremiumPlanType.FREE,
    val isTrial: Boolean = false,
    @ServerTimestamp
    val startDate: Timestamp? = null,
    @ServerTimestamp
    val expiryDate: Timestamp? = null,
    val autoRenew: Boolean = false,
    val purchaseToken: String? = null,
    val orderId: String? = null,
    @ServerTimestamp
    val createdAt: Timestamp? = null,
    @ServerTimestamp
    val updatedAt: Timestamp? = null
) {
    /**
     * Premium aktif mi kontrol eder
     */
    fun isCurrentlyActive(): Boolean {
        if (!isActive) return false
        val now = System.currentTimeMillis()
        val expiry = expiryDate?.toDate()?.time ?: 0
        return now < expiry
    }

    /**
     * Kalan g√ºn sayƒ±sƒ±nƒ± hesaplar
     */
    fun daysRemaining(): Int {
        if (!isCurrentlyActive()) return 0
        val now = System.currentTimeMillis()
        val expiry = expiryDate?.toDate()?.time ?: 0
        val diff = expiry - now
        return (diff / (1000 * 60 * 60 * 24)).toInt()
    }
}

/**
 * üì¶ Plan Kategorileri
 */
enum class PlanCategory {
    FREE,
    EKSTRA,
    AILE;

    fun toTurkish(): String = when (this) {
        FREE -> "√úcretsiz"
        EKSTRA -> "Dozi Ekstra"
        AILE -> "Dozi Aile"
    }
}

/**
 * üíé Premium Plan Tipleri
 *
 * Fiyatlar artƒ±k Firestore'dan √ßekilir (config/pricing)
 */
enum class PremiumPlanType(
    val id: String,
    val displayName: String,
    val category: PlanCategory,
    val productId: String
) {
    FREE("free", "√úcretsiz", PlanCategory.FREE, ""),
    TRIAL("trial", "3 G√ºn Deneme", PlanCategory.EKSTRA, ""),
    EKSTRA_MONTHLY("ekstra_monthly", "Ekstra Aylƒ±k", PlanCategory.EKSTRA, "dozi_ekstra_monthly"),
    EKSTRA_YEARLY("ekstra_yearly", "Ekstra Yƒ±llƒ±k", PlanCategory.EKSTRA, "dozi_ekstra_yearly"),
    AILE_MONTHLY("aile_monthly", "Aile Aylƒ±k", PlanCategory.AILE, "dozi_aile_monthly"),
    AILE_YEARLY("aile_yearly", "Aile Yƒ±llƒ±k", PlanCategory.AILE, "dozi_aile_yearly");

    fun isPremium(): Boolean = this != FREE

    fun isFamilyPlan(): Boolean = category == PlanCategory.AILE

    fun isEkstra(): Boolean = category == PlanCategory.EKSTRA

    fun isAile(): Boolean = category == PlanCategory.AILE

    fun toTurkish(): String = displayName

    companion object {
        fun fromId(id: String): PremiumPlanType {
            return entries.find { it.id == id } ?: FREE
        }

        fun fromProductId(productId: String): PremiumPlanType {
            return entries.find { it.productId == productId } ?: FREE
        }
    }
}

/**
 * üìä Premium Analytics Model
 *
 * Premium kullanƒ±cƒ± istatistiklerini takip eder.
 */
data class PremiumAnalytics(
    val totalUsers: Int = 0,
    val premiumUsers: Int = 0,
    val trialUsers: Int = 0,
    val ekstraMonthlyUsers: Int = 0,
    val ekstraYearlyUsers: Int = 0,
    val aileMonthlyUsers: Int = 0,
    val aileYearlyUsers: Int = 0,
    // Billing period aggregates for analytics dashboard
    val weeklyUsers: Int = 0,
    val monthlyUsers: Int = 0,
    val yearlyUsers: Int = 0,
    val lifetimeUsers: Int = 0,
    val conversionRate: Float = 0f,
    val totalRevenue: Float = 0f,
    @ServerTimestamp
    val lastUpdated: Timestamp? = null
)

/**
 * üìà Daily Analytics Snapshot
 *
 * G√ºnl√ºk kullanƒ±cƒ± aktivitesi ve retention metrikleri
 */
data class DailyAnalytics(
    val date: String = "", // "2025-11-15" formatƒ±nda
    val activeUsers: Int = 0,
    val newSignups: Int = 0,
    val premiumPurchases: Int = 0,
    val trialStarts: Int = 0,
    val trialConversions: Int = 0,
    val notificationsSent: Int = 0,
    val medicationsTaken: Int = 0,
    val retention1Day: Float = 0f,
    val retention7Day: Float = 0f,
    val retention30Day: Float = 0f,
    @ServerTimestamp
    val createdAt: Timestamp? = null
)

/**
 * üö´ Ban System Model
 *
 * Kullanƒ±cƒ± ban y√∂netimi i√ßin
 */
data class UserBan(
    val userId: String = "",
    val isBanned: Boolean = false,
    val reason: String = "",
    val bannedBy: String = "", // Admin user ID
    @ServerTimestamp
    val bannedAt: Timestamp? = null,
    @ServerTimestamp
    val expiresAt: Timestamp? = null, // null = permanent
    val isPermanent: Boolean = true
) {
    /**
     * Ban aktif mi kontrol eder
     */
    fun isCurrentlyBanned(): Boolean {
        if (!isBanned) return false
        if (isPermanent) return true

        val now = System.currentTimeMillis()
        val expiry = expiresAt?.toDate()?.time ?: Long.MAX_VALUE
        return now < expiry
    }
}

/**
 * üéµ Notification Sound Settings (Premium Feature)
 */
data class NotificationSoundSettings(
    val userId: String = "",
    val soundEnabled: Boolean = true,
    val soundUri: String? = null, // Custom sound URI (premium only)
    val soundName: String = "Varsayƒ±lan",
    val vibrationPattern: List<Long> = listOf(0, 300, 200, 300), // Pattern (premium only)
    val volume: Float = 0.8f, // 0.0 - 1.0
    @ServerTimestamp
    val updatedAt: Timestamp? = null
)

// ============================================================================
// FILE: PricingConfig.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/model/PricingConfig.kt
// [17 of 122]
// ============================================================================

package com.bardino.dozi.core.data.model

import com.google.firebase.Timestamp
import com.google.firebase.firestore.ServerTimestamp

/**
 * üí∞ Fiyatlandƒ±rma Konfig√ºrasyonu
 *
 * Firestore'dan √ßekilen dinamik fiyat bilgileri.
 * Collection: config/pricing
 */
data class PricingConfig(
    val ekstraMonthly: PlanPricing = PlanPricing(),
    val ekstraYearly: PlanPricing = PlanPricing(),
    val aileMonthly: PlanPricing = PlanPricing(),
    val aileYearly: PlanPricing = PlanPricing(),
    val trialDurationDays: Int = 3,
    @ServerTimestamp
    val lastUpdated: Timestamp? = null
)

/**
 * üìã Tek Plan Fiyat Bilgisi
 */
data class PlanPricing(
    val price: Float = 0f,
    val currency: String = "TRY",
    val durationDays: Int = 30,
    val displayName: String = "",
    val isActive: Boolean = true,
    val savingsPercent: Int = 0,  // Yƒ±llƒ±k planlarda tasarruf y√ºzdesi
    val discountPercent: Int = 0,  // Kampanya indirimi
    val campaignEndDate: Timestamp? = null
) {
    /**
     * ƒ∞ndirimli fiyatƒ± hesaplar
     */
    fun getDiscountedPrice(): Float {
        return if (discountPercent > 0) {
            price * (1 - discountPercent / 100f)
        } else {
            price
        }
    }

    /**
     * Kampanya aktif mi kontrol eder
     */
    fun isCampaignActive(): Boolean {
        if (discountPercent <= 0) return false
        val now = System.currentTimeMillis()
        val endDate = campaignEndDate?.toDate()?.time ?: return true
        return now < endDate
    }

    /**
     * G√∂r√ºnt√ºlenecek fiyat stringi
     */
    fun getDisplayPrice(): String {
        val finalPrice = if (isCampaignActive()) getDiscountedPrice() else price
        return "%.2f %s".format(finalPrice, getCurrencySymbol())
    }

    private fun getCurrencySymbol(): String = when (currency) {
        "TRY" -> "‚Ç∫"
        "USD" -> "$"
        "EUR" -> "‚Ç¨"
        else -> currency
    }
}

/**
 * üîÑ Varsayƒ±lan fiyatlar (offline fallback)
 */
object DefaultPricing {
    val config = PricingConfig(
        ekstraMonthly = PlanPricing(
            price = 149.99f,
            currency = "TRY",
            durationDays = 30,
            displayName = "Ekstra Aylƒ±k",
            isActive = true
        ),
        ekstraYearly = PlanPricing(
            price = 999.99f,
            currency = "TRY",
            durationDays = 365,
            displayName = "Ekstra Yƒ±llƒ±k",
            isActive = true,
            savingsPercent = 44
        ),
        aileMonthly = PlanPricing(
            price = 249.99f,
            currency = "TRY",
            durationDays = 30,
            displayName = "Aile Aylƒ±k",
            isActive = true
        ),
        aileYearly = PlanPricing(
            price = 1999.99f,
            currency = "TRY",
            durationDays = 365,
            displayName = "Aile Yƒ±llƒ±k",
            isActive = true,
            savingsPercent = 33
        ),
        trialDurationDays = 3
    )
}

// ============================================================================
// FILE: Reminder.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/model/Reminder.kt
// [18 of 122]
// ============================================================================

package com.bardino.dozi.core.data.model

import com.google.firebase.Timestamp
import com.google.firebase.firestore.DocumentId
import com.google.firebase.firestore.ServerTimestamp

/**
 * ƒ∞la√ß hatƒ±rlatmasƒ±nƒ± temsil eder
 */
data class Reminder(
    @DocumentId
    val id: String = "",
    val userId: String = "",                    // Hatƒ±rlatma sahibi
    val medicineId: String = "",                // ƒ∞la√ß ID (local DB'den)
    val medicineName: String = "",
    val dosage: String = "",
    val frequency: ReminderFrequency = ReminderFrequency.DAILY,
    val times: List<String> = emptyList(),      // ["08:00", "20:00"]
    val days: List<Int>? = null,                // Haftalƒ±k i√ßin: [1,2,3,4,5] (Pazartesi=1)
    val startDate: Timestamp? = null,
    val endDate: Timestamp? = null,
    val isActive: Boolean = true,
    val isMuted: Boolean = false,               // Ge√ßici olarak sessize alƒ±nmƒ±≈ü
    val reminderSound: String = "default",
    val vibrationPattern: String = "default",
    val notes: String? = null,
    @ServerTimestamp
    val createdAt: Timestamp? = null,
    @ServerTimestamp
    val updatedAt: Timestamp? = null,
    val sharedWithBadis: List<String> = emptyList() // Payla≈üƒ±lan badi userId'leri
)

/**
 * Hatƒ±rlatma sƒ±klƒ±ƒüƒ±
 */
enum class ReminderFrequency {
    DAILY,          // Her g√ºn
    WEEKLY,         // Haftanƒ±n belirli g√ºnleri
    AS_NEEDED,      // Gerektiƒüinde
    CUSTOM          // √ñzel
}

/**
 * Hatƒ±rlatma ile birlikte ila√ß bilgilerini i√ßeren model
 * (UI'da g√∂stermek i√ßin)
 */
data class ReminderWithMedicine(
    val reminder: Reminder,
    val medicine: Medicine? = null
)

/**
 * G√ºnl√ºk hatƒ±rlatma g√∂r√ºn√ºm√º
 * Belirli bir g√ºn i√ßin t√ºm hatƒ±rlatmalarƒ± gruplamak i√ßin
 */
data class DailyReminderGroup(
    val date: String,                           // "2025-11-14"
    val reminders: List<ReminderWithTime>
)

/**
 * Zaman ile hatƒ±rlatma
 */
data class ReminderWithTime(
    val reminder: Reminder,
    val time: String,                           // "08:00"
    val isPast: Boolean = false,
    val isTaken: Boolean = false
)

// ============================================================================
// FILE: User.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/model/User.kt
// [19 of 122]
// ============================================================================

package com.bardino.dozi.core.data.model

import com.google.firebase.firestore.Exclude
import com.google.firebase.firestore.PropertyName
import java.util.Locale

data class User(
    val uid: String = "",
    val name: String = "",
    val email: String = "",
    val photoUrl: String = "",
    val createdAt: Long = 0L,
    val planType: String = "free", // "free", "trial", "ekstra_monthly", "ekstra_yearly", "aile_monthly", "aile_yearly"
    val timezone: String = "Europe/Istanbul",
    val language: String = "tr",
    val vibration: Boolean = true,
    val theme: String = "light",
    val voiceGender: String = "erkek", // "erkek" (Ozan) veya "kadin" (Efsun)
    val onboardingCompleted: Boolean = false,

    // üåü Premium (Dozi Ekstra) bilgileri
    @PropertyName("isPremium")
    val isPremium: Boolean = false,              // Premium aktif mi?

    @PropertyName("isTrial")
    val isTrial: Boolean = false,                // Deneme s√ºr√ºm√º m√º?

    @get:PropertyName("premiumPlanType")
    val legacyPremiumPlanType: String? = null,   // V1/V2 plan alanƒ±

    @get:PropertyName("premium")
    val legacyPremiumFlag: Boolean = false,      // Legacy premium bayraƒüƒ±

    @get:PropertyName("currentlyPremium")
    val legacyCurrentlyPremium: Boolean = false, // Legacy aktif premium bayraƒüƒ±

    val premiumExpiryDate: Long = 0L,            // Premium biti≈ü tarihi (timestamp)
    val premiumStartDate: Long = 0L,             // Premium ba≈ülangƒ±√ß tarihi

    // üö´ Ban sistemi
    @PropertyName("isBanned")
    val isBanned: Boolean = false,               // Kullanƒ±cƒ± banlandƒ± mƒ±?

    val banReason: String? = null,               // Ban nedeni

    // ü§ù Badi sistem i√ßin
    val fcmToken: String? = null,                // Firebase Cloud Messaging token
    val buddyCode: String? = null,               // 6 haneli buddy kodu

    // üì± Device bilgileri
    val deviceId: String? = null,                // Android Device ID (telefonu tanƒ±mlamak i√ßin)

    // üîï DND (Do Not Disturb) ayarlarƒ±
    val dndEnabled: Boolean = false,             // DND aktif mi?
    val dndStartHour: Int = 22,                  // DND ba≈ülangƒ±√ß saati (0-23)
    val dndStartMinute: Int = 0,                 // DND ba≈ülangƒ±√ß dakikasƒ± (0-59)
    val dndEndHour: Int = 8,                     // DND biti≈ü saati (0-23)
    val dndEndMinute: Int = 0,                   // DND biti≈ü dakikasƒ± (0-59)

    // üîî Adaptive timing (akƒ±llƒ± zamanlama)
    val adaptiveTimingEnabled: Boolean = false,  // Adaptive timing aktif mi?
    val preferredMorningHour: Int = 8,           // Sabah tercihi (7-11)
    val preferredEveningHour: Int = 20,          // Ak≈üam tercihi (18-22)

    // üß† Smart reminder (akƒ±llƒ± hatƒ±rlatma √∂nerileri)
    val smartReminderEnabled: Boolean = false,   // Akƒ±llƒ± erteleme √∂nerileri aktif mi? (default: kapalƒ±)

    // üî¥ Important notifications (kritik hatƒ±rlatmalar - DND bypass)
    val importantNotificationsEnabled: Boolean = true,  // √ñnemli bildirimler aktif mi? (1 saat sonraki escalation)

    // üéµ Bildirim sesi √∂zelle≈ütirme (Premium √∂zellik)
    val customSoundUri: String? = null,          // √ñzel bildirim sesi URI
    val customSoundName: String = "Varsayƒ±lan",  // √ñzel ses adƒ±

    // üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Aile Paketi (Dozi Ekstra Aile)
    val familyPlanId: String? = null,            // Hangi aile planƒ±na ait (null ise yok)
    val familyRole: String? = null,              // "ORGANIZER" veya "MEMBER"

    // üìç Kayƒ±tlƒ± Konumlar (Firestore'da saklanƒ±yor)
    val locations: List<Map<String, Any>> = emptyList()  // Kayƒ±tlƒ± konumlar listesi
) {
    /**
     * Kullanƒ±cƒ±nƒ±n ≈üu anda premium olup olmadƒ±ƒüƒ±nƒ± kontrol eder
     */
    @get:Exclude
    fun isCurrentlyPremium(): Boolean {
        return premiumStatus().isActive
    }

    /**
     * Premium'un ka√ß g√ºn kaldƒ±ƒüƒ±nƒ± hesaplar
     */
    @get:Exclude
    fun premiumDaysRemaining(): Int {
        return premiumStatus().daysRemaining()
    }

    /**
     * Plan tipini PremiumPlanType enum'a √ßevirir
     */
    @get:Exclude
    fun premiumPlanType(): PremiumPlanType {
        return premiumStatus().planType
    }

    /**
     * Premium durumunu normalize eder ve tek noktadan hesaplar
     */
    @get:Exclude
    fun premiumStatus(now: Long = System.currentTimeMillis()): PremiumStatus {
        val planType = resolvePlanType()
        val expiry = premiumExpiryDate

        val hasPremiumFlag = isPremium || legacyPremiumFlag || legacyCurrentlyPremium || planType.isPremium()
        val isActive = hasPremiumFlag && expiry > now && planType != PremiumPlanType.FREE
        val isTrialActive = isTrial && isActive

        val source = when {
            isInFamilyPlan() -> PremiumSource.FAMILY
            isTrialActive -> PremiumSource.TRIAL
            isActive -> PremiumSource.INDIVIDUAL
            else -> PremiumSource.NONE
        }

        return PremiumStatus(
            planType = planType,
            isActive = isActive,
            isTrial = isTrialActive,
            premiumStartDate = premiumStartDate,
            premiumExpiryDate = expiry,
            source = source
        )
    }

    private fun resolvePlanType(): PremiumPlanType {
        val normalizedPlanId = normalizePlanId(planType)
            ?: normalizePlanId(legacyPremiumPlanType)
            ?: "free"

        return PremiumPlanType.fromId(normalizedPlanId)
    }

    private fun normalizePlanId(raw: String?): String? {
        val normalized = raw?.trim()?.lowercase(Locale.ROOT)
        if (normalized.isNullOrEmpty() || normalized == "free") return null

        return when (normalized) {
            "trial" -> PremiumPlanType.TRIAL.id
            "ekstra_monthly", "weekly", "monthly" -> PremiumPlanType.EKSTRA_MONTHLY.id
            "ekstra_yearly", "yearly", "lifetime" -> PremiumPlanType.EKSTRA_YEARLY.id
            "aile_monthly", "monthly_family" -> PremiumPlanType.AILE_MONTHLY.id
            "aile_yearly", "yearly_family", "family_premium" -> PremiumPlanType.AILE_YEARLY.id
            else -> normalized
        }
    }

    /**
     * Kullanƒ±cƒ± bir aile planƒ±nƒ±n √ºyesi mi?
     */
    fun isInFamilyPlan(): Boolean {
        return !familyPlanId.isNullOrEmpty()
    }

    /**
     * Kullanƒ±cƒ± aile planƒ±nƒ±n organizat√∂r√º m√º?
     */
    fun isFamilyOrganizer(): Boolean {
        return familyRole == "ORGANIZER"
    }

    /**
     * Kullanƒ±cƒ± aile planƒ±nƒ±n √ºyesi mi? (organizat√∂r deƒüil)
     */
    fun isFamilyMember(): Boolean {
        return familyRole == "MEMBER"
    }
}

data class PremiumStatus(
    val planType: PremiumPlanType,
    val isActive: Boolean,
    val isTrial: Boolean,
    val premiumStartDate: Long,
    val premiumExpiryDate: Long,
    val source: PremiumSource
) {
    fun daysRemaining(now: Long = System.currentTimeMillis()): Int {
        if (!isActive) return 0
        val diff = premiumExpiryDate - now
        return (diff / (1000 * 60 * 60 * 24)).toInt()
    }
}

enum class PremiumSource {
    INDIVIDUAL,
    FAMILY,
    TRIAL,
    NONE
}

// ============================================================================
// FILE: UserStats.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/model/UserStats.kt
// [20 of 122]
// ============================================================================

package com.bardino.dozi.core.data.model

import com.google.firebase.Timestamp
import com.google.firebase.firestore.DocumentId
import com.google.firebase.firestore.ServerTimestamp

/**
 * üìä Kullanƒ±cƒ± istatistikleri ve gamification verileri
 */
data class UserStats(
    @DocumentId
    val id: String = "",
    val userId: String = "",

    // üî• Streak (d√ºzenli kullanƒ±m)
    val currentStreak: Int = 0,          // ≈ûu anki ardƒ±≈üƒ±k g√ºn sayƒ±sƒ±
    val longestStreak: Int = 0,          // En uzun ardƒ±≈üƒ±k g√ºn sayƒ±sƒ±
    val lastStreakDate: Timestamp? = null, // Son streak tarihi

    // üìà Genel istatistikler
    val totalMedicationsTaken: Int = 0,   // Toplam alƒ±nan ila√ß sayƒ±sƒ±
    val totalMedicationsMissed: Int = 0,  // Toplam ka√ßƒ±rƒ±lan ila√ß sayƒ±sƒ±
    val totalMedicationsSkipped: Int = 0, // Toplam atlanan ila√ß sayƒ±sƒ±
    val complianceRate: Float = 0f,       // Uyumluluk oranƒ± (0-100)

    // üíä ƒ∞la√ß koleksiyonu
    val totalMedicines: Int = 0,          // Kullanƒ±cƒ±nƒ±n eklediƒüi toplam ila√ß sayƒ±sƒ±
    val totalDosesTaken: Int = 0,         // Toplam alƒ±nan doz sayƒ±sƒ± (totalMedicationsTaken ile aynƒ±)

    // üèÜ Achievement rozetleri
    val achievements: List<String> = emptyList(), // Kazanƒ±lan achievement ID'leri

    // ‚è∞ En iyi/en k√∂t√º saatler
    val bestComplianceHour: Int = 9,      // En iyi uyumluluk saati (0-23)
    val worstComplianceHour: Int = 21,    // En k√∂t√º uyumluluk saati (0-23)
    val hourlyCompliance: Map<String, Float> = emptyMap(), // Saatlik uyumluluk ("0"-"23" -> 0-100)

    @ServerTimestamp
    val createdAt: Timestamp? = null,
    @ServerTimestamp
    val updatedAt: Timestamp? = null
)

/**
 * Note: Achievement model is defined in Achievement.kt
 * This file only contains UserStats and ComplianceTrend models
 */

/**
 * üìä Uyumluluk trend verisi (grafikler i√ßin)
 */
data class ComplianceTrend(
    val date: String,                    // "2025-11-14"
    val complianceRate: Float,           // 0-100
    val takenCount: Int,
    val totalCount: Int,
    val missedCount: Int
)

/**
 * üìà 30 g√ºnl√ºk trend hesapla
 */
fun List<DailyMedicationLogs>.toComplianceTrend(): List<ComplianceTrend> {
    return this.map { daily ->
        ComplianceTrend(
            date = daily.date,
            complianceRate = daily.completionRate * 100,
            takenCount = daily.takenCount,
            totalCount = daily.totalCount,
            missedCount = daily.missedCount
        )
    }
}

// ============================================================================
// FILE: DoziDatabase.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/local/DoziDatabase.kt
// [21 of 122]
// ============================================================================

package com.bardino.dozi.core.data.local

import android.content.Context
import androidx.room.Database
import androidx.room.Room
import androidx.room.RoomDatabase
import com.bardino.dozi.core.data.local.dao.MedicationLogDao
import com.bardino.dozi.core.data.local.dao.SyncQueueDao
import com.bardino.dozi.core.data.local.entity.MedicationLogEntity
import com.bardino.dozi.core.data.local.entity.SyncQueueEntity

@Database(
    entities = [
        MedicationLogEntity::class,
        SyncQueueEntity::class
    ],
    version = 1,
    exportSchema = false
)
abstract class DoziDatabase : RoomDatabase() {

    abstract fun medicationLogDao(): MedicationLogDao
    abstract fun syncQueueDao(): SyncQueueDao

    companion object {
        @Volatile
        private var INSTANCE: DoziDatabase? = null

        fun getDatabase(context: Context): DoziDatabase {
            return INSTANCE ?: synchronized(this) {
                val instance = Room.databaseBuilder(
                    context.applicationContext,
                    DoziDatabase::class.java,
                    "dozi_database"
                )
                    .fallbackToDestructiveMigration()
                    .build()
                INSTANCE = instance
                instance
            }
        }
    }
}

// ============================================================================
// FILE: MedicationLogDao.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/local/dao/MedicationLogDao.kt
// [22 of 122]
// ============================================================================

package com.bardino.dozi.core.data.local.dao

import androidx.room.*
import com.bardino.dozi.core.data.local.entity.MedicationLogEntity
import kotlinx.coroutines.flow.Flow

@Dao
interface MedicationLogDao {

    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insert(log: MedicationLogEntity)

    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertAll(logs: List<MedicationLogEntity>)

    @Update
    suspend fun update(log: MedicationLogEntity)

    @Delete
    suspend fun delete(log: MedicationLogEntity)

    @Query("SELECT * FROM medication_logs WHERE id = :logId")
    suspend fun getById(logId: String): MedicationLogEntity?

    @Query("SELECT * FROM medication_logs WHERE userId = :userId ORDER BY scheduledTime DESC")
    fun getAllByUserFlow(userId: String): Flow<List<MedicationLogEntity>>

    @Query("SELECT * FROM medication_logs WHERE userId = :userId ORDER BY scheduledTime DESC")
    suspend fun getAllByUser(userId: String): List<MedicationLogEntity>

    @Query("SELECT * FROM medication_logs ORDER BY scheduledTime DESC")
    suspend fun getAllLogsList(): List<MedicationLogEntity>

    @Query("SELECT * FROM medication_logs WHERE userId = :userId AND scheduledTime >= :startTime AND scheduledTime < :endTime ORDER BY scheduledTime ASC")
    suspend fun getByDateRange(userId: String, startTime: Long, endTime: Long): List<MedicationLogEntity>

    @Query("SELECT * FROM medication_logs WHERE userId = :userId AND isSynced = 0")
    suspend fun getUnsyncedLogs(userId: String): List<MedicationLogEntity>

    @Query("UPDATE medication_logs SET isSynced = 1 WHERE id = :logId")
    suspend fun markAsSynced(logId: String)

    @Query("UPDATE medication_logs SET isSynced = 1 WHERE id IN (:logIds)")
    suspend fun markAllAsSynced(logIds: List<String>)

    @Query("DELETE FROM medication_logs WHERE userId = :userId")
    suspend fun deleteAllByUser(userId: String)

    @Query("SELECT COUNT(*) FROM medication_logs WHERE userId = :userId AND status = 'TAKEN' AND scheduledTime >= :startTime AND scheduledTime < :endTime")
    suspend fun getTakenCount(userId: String, startTime: Long, endTime: Long): Int

    @Query("SELECT COUNT(*) FROM medication_logs WHERE userId = :userId AND status = 'MISSED' AND scheduledTime >= :startTime AND scheduledTime < :endTime")
    suspend fun getMissedCount(userId: String, startTime: Long, endTime: Long): Int

    @Query("SELECT COUNT(*) FROM medication_logs WHERE userId = :userId AND status = 'SKIPPED' AND scheduledTime >= :startTime AND scheduledTime < :endTime")
    suspend fun getSkippedCount(userId: String, startTime: Long, endTime: Long): Int

    /**
     * üî• Belirli bir ila√ß i√ßin belirli bir zamanda log var mƒ± kontrol et
     * Escalation handler'larƒ± i√ßin (duplicate bildirim √∂nleme)
     * ¬±5 dakika toleransla kontrol eder
     */
    @Query("""
        SELECT * FROM medication_logs
        WHERE medicineId = :medicineId
        AND userId = :userId
        AND scheduledTime >= :scheduledTime - 300000
        AND scheduledTime <= :scheduledTime + 300000
        LIMIT 1
    """)
    suspend fun getLogForMedicineAndTime(
        medicineId: String,
        scheduledTime: Long,
        userId: String
    ): MedicationLogEntity?
}

// ============================================================================
// FILE: SyncQueueDao.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/local/dao/SyncQueueDao.kt
// [23 of 122]
// ============================================================================

package com.bardino.dozi.core.data.local.dao

import androidx.room.*
import com.bardino.dozi.core.data.local.entity.SyncQueueEntity

@Dao
interface SyncQueueDao {

    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insert(action: SyncQueueEntity): Long

    @Update
    suspend fun update(action: SyncQueueEntity)

    @Delete
    suspend fun delete(action: SyncQueueEntity)

    @Query("SELECT * FROM sync_queue WHERE userId = :userId ORDER BY createdAt ASC")
    suspend fun getAllPending(userId: String): List<SyncQueueEntity>

    @Query("SELECT * FROM sync_queue WHERE userId = :userId AND retryCount < 5 ORDER BY createdAt ASC")
    suspend fun getPendingWithRetries(userId: String): List<SyncQueueEntity>

    @Query("DELETE FROM sync_queue WHERE id = :id")
    suspend fun deleteById(id: Long)

    @Query("DELETE FROM sync_queue WHERE userId = :userId")
    suspend fun deleteAllByUser(userId: String)

    @Query("SELECT COUNT(*) FROM sync_queue WHERE userId = :userId")
    suspend fun getPendingCount(userId: String): Int

    @Query("UPDATE sync_queue SET retryCount = retryCount + 1, lastAttemptAt = :attemptTime, errorMessage = :error WHERE id = :id")
    suspend fun incrementRetryCount(id: Long, attemptTime: Long, error: String?)
}

// ============================================================================
// FILE: MedicationLogEntity.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/local/entity/MedicationLogEntity.kt
// [24 of 122]
// ============================================================================

package com.bardino.dozi.core.data.local.entity

import androidx.room.Entity
import androidx.room.PrimaryKey
import com.bardino.dozi.core.data.model.MedicationStatus

/**
 * Room entity for local medication log caching
 * Offline-first approach: Data saved locally first, then synced to Firestore
 */
@Entity(tableName = "medication_logs")
data class MedicationLogEntity(
    @PrimaryKey
    val id: String,
    val userId: String,
    val medicineId: String,
    val medicineName: String,
    val dosage: String,
    val scheduledTime: Long,            // Epoch millis
    val takenAt: Long? = null,          // Epoch millis
    val status: String,                 // MedicationStatus enum as string
    val notes: String? = null,
    val sideEffects: String? = null,    // JSON array string
    val mood: String? = null,
    val locationLat: Double? = null,
    val locationLng: Double? = null,
    val createdAt: Long,                // Epoch millis
    val updatedAt: Long,                // Epoch millis
    val isSynced: Boolean = false       // ‚úÖ Firestore'a sync oldu mu?
)

/**
 * Convert to Firestore-compatible format
 */
fun MedicationLogEntity.toMedicationStatus(): MedicationStatus {
    return try {
        MedicationStatus.valueOf(status)
    } catch (e: Exception) {
        MedicationStatus.PENDING
    }
}

// ============================================================================
// FILE: SyncQueueEntity.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/local/entity/SyncQueueEntity.kt
// [25 of 122]
// ============================================================================

package com.bardino.dozi.core.data.local.entity

import androidx.room.Entity
import androidx.room.PrimaryKey

/**
 * Queue for pending Firestore sync operations
 * Used for offline-first approach
 */
@Entity(tableName = "sync_queue")
data class SyncQueueEntity(
    @PrimaryKey(autoGenerate = true)
    val id: Long = 0,
    val actionType: String,             // "MEDICATION_TAKEN", "MEDICATION_SKIPPED", "MEDICINE_ADDED", etc.
    val dataJson: String,               // JSON payload for the action
    val userId: String,
    val retryCount: Int = 0,
    val createdAt: Long,                // Epoch millis
    val lastAttemptAt: Long? = null,    // Epoch millis
    val errorMessage: String? = null
)

/**
 * Sync action types
 */
object SyncActionType {
    const val MEDICATION_TAKEN = "MEDICATION_TAKEN"
    const val MEDICATION_SKIPPED = "MEDICATION_SKIPPED"
    const val MEDICATION_SNOOZED = "MEDICATION_SNOOZED"
    const val MEDICINE_ADDED = "MEDICINE_ADDED"
    const val MEDICINE_UPDATED = "MEDICINE_UPDATED"
    const val MEDICINE_DELETED = "MEDICINE_DELETED"
}

// ============================================================================
// FILE: AchievementRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/repository/AchievementRepository.kt
// [26 of 122]
// ============================================================================

package com.bardino.dozi.core.data.repository

import android.util.Log
import com.bardino.dozi.core.data.model.*
import com.google.firebase.Timestamp
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.tasks.await
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.callbackFlow
import kotlinx.coroutines.channels.awaitClose
import javax.inject.Inject
import javax.inject.Singleton

/**
 * üèÜ Achievement Repository - Rozet sistemi y√∂netimi
 */
@Singleton
class AchievementRepository @Inject constructor() {
    private val firestore = FirebaseFirestore.getInstance()
    private val auth = FirebaseAuth.getInstance()
    private val TAG = "AchievementRepository"

    /**
     * Get achievements collection for current user
     */
    private fun getAchievementsCollection() = auth.currentUser?.let { user ->
        firestore.collection("users").document(user.uid).collection("achievements")
    }

    /**
     * Kullanƒ±cƒ±nƒ±n t√ºm ba≈üarƒ±larƒ±nƒ± getir
     */
    suspend fun getAllAchievements(): List<Achievement> {
        return try {
            val userId = auth.currentUser?.uid ?: return emptyList()
            val collection = getAchievementsCollection() ?: return emptyList()

            val snapshot = collection.get().await()

            if (snapshot.isEmpty) {
                // ƒ∞lk kez - T√ºm ba≈üarƒ±larƒ± olu≈ütur (kilitli halde)
                Log.d(TAG, "First time - Creating all achievements")
                initializeAchievements(userId)
                return getAllAchievements() // Recursive call after initialization
            }

            snapshot.documents.mapNotNull { it.toObject(Achievement::class.java) }
        } catch (e: Exception) {
            Log.e(TAG, "Error getting achievements", e)
            emptyList()
        }
    }

    /**
     * Real-time achievements flow
     */
    fun getAchievementsFlow(): Flow<List<Achievement>> {
        val collection = getAchievementsCollection()
        if (collection == null) {
            return callbackFlow {
                trySend(emptyList())
                awaitClose {}
            }
        }

        return callbackFlow {
            val listener = collection.addSnapshotListener { snapshot, error ->
                if (error != null) {
                    Log.e(TAG, "Error listening to achievements", error)
                    trySend(emptyList())
                    return@addSnapshotListener
                }

                val achievements = snapshot?.documents?.mapNotNull {
                    it.toObject(Achievement::class.java)
                } ?: emptyList()

                trySend(achievements)
            }

            awaitClose { listener.remove() }
        }
    }

    /**
     * Belirli bir ba≈üarƒ±yƒ± getir
     */
    suspend fun getAchievement(achievementId: String): Achievement? {
        return try {
            val collection = getAchievementsCollection() ?: return null
            val doc = collection.document(achievementId).get().await()
            doc.toObject(Achievement::class.java)
        } catch (e: Exception) {
            Log.e(TAG, "Error getting achievement: $achievementId", e)
            null
        }
    }

    /**
     * Ba≈üarƒ± ilerlemesini g√ºncelle
     */
    suspend fun updateAchievementProgress(
        achievementType: AchievementType,
        currentProgress: Int
    ): Boolean {
        return try {
            val userId = auth.currentUser?.uid ?: return false
            val collection = getAchievementsCollection() ?: return false

            val achievementId = "${userId}_${achievementType.name}"

            // Ba≈üarƒ± var mƒ± kontrol et
            val doc = collection.document(achievementId).get().await()

            if (!doc.exists()) {
                // Yoksa olu≈ütur
                val newAchievement = Achievement(
                    id = achievementId,
                    userId = userId,
                    type = achievementType,
                    progress = currentProgress,
                    target = achievementType.target,
                    isUnlocked = currentProgress >= achievementType.target
                )
                collection.document(achievementId).set(newAchievement).await()
                Log.d(TAG, "Achievement created: ${achievementType.displayName}")
            } else {
                val achievement = doc.toObject(Achievement::class.java)
                if (achievement != null && !achievement.isUnlocked) {
                    // Hen√ºz kilitli - ƒ∞lerlemeyi g√ºncelle
                    val isNowUnlocked = currentProgress >= achievementType.target

                    collection.document(achievementId).update(
                        mapOf(
                            "progress" to currentProgress,
                            "isUnlocked" to isNowUnlocked,
                            "unlockedAt" to if (isNowUnlocked) Timestamp.now() else null
                        )
                    ).await()

                    if (isNowUnlocked) {
                        Log.d(TAG, "üéâ Achievement UNLOCKED: ${achievementType.displayName}")
                        // Bildirim g√∂nder
                        val unlockedAchievement = achievement.copy(
                            isUnlocked = true,
                            progress = currentProgress,
                            unlockedAt = Timestamp.now()
                        )
                        sendAchievementUnlockedNotification(unlockedAchievement)
                    }
                }
            }
            true
        } catch (e: Exception) {
            Log.e(TAG, "Error updating achievement progress", e)
            false
        }
    }

    /**
     * Kullanƒ±cƒ± i√ßin t√ºm ba≈üarƒ±larƒ± ba≈ülat (ilk kez kullanƒ±mda)
     */
    private suspend fun initializeAchievements(userId: String) {
        try {
            val collection = getAchievementsCollection() ?: return

            AchievementType.entries.forEach { type ->
                val achievementId = "${userId}_${type.name}"
                val achievement = Achievement(
                    id = achievementId,
                    userId = userId,
                    type = type,
                    isUnlocked = false,
                    progress = 0,
                    target = type.target
                )

                collection.document(achievementId).set(achievement).await()
            }

            Log.d(TAG, "‚úÖ Initialized ${AchievementType.entries.size} achievements")
        } catch (e: Exception) {
            Log.e(TAG, "Error initializing achievements", e)
        }
    }

    /**
     * Kullanƒ±cƒ±nƒ±n kazandƒ±ƒüƒ± (unlocked) ba≈üarƒ±larƒ± getir
     */
    suspend fun getUnlockedAchievements(): List<Achievement> {
        return getAllAchievements().filter { it.isUnlocked }
    }

    /**
     * Kullanƒ±cƒ±nƒ±n hen√ºz kazanmadƒ±ƒüƒ± (locked) ba≈üarƒ±larƒ± getir
     */
    suspend fun getLockedAchievements(): List<Achievement> {
        return getAllAchievements().filter { !it.isUnlocked }
    }

    /**
     * Ba≈üarƒ± sayƒ±larƒ±nƒ± getir
     */
    suspend fun getAchievementStats(): Pair<Int, Int> {
        val all = getAllAchievements()
        val unlocked = all.count { it.isUnlocked }
        val total = all.size
        return Pair(unlocked, total)
    }

    /**
     * Streak ba≈üarƒ±larƒ±nƒ± kontrol et ve g√ºncelle
     */
    suspend fun checkStreakAchievements(currentStreak: Int) {
        listOf(
            AchievementType.STREAK_7_DAYS,
            AchievementType.STREAK_30_DAYS,
            AchievementType.STREAK_100_DAYS,
            AchievementType.STREAK_365_DAYS
        ).forEach { type ->
            if (currentStreak >= type.target) {
                updateAchievementProgress(type, currentStreak)
            }
        }
    }

    /**
     * Perfect week/month ba≈üarƒ±larƒ±nƒ± kontrol et
     */
    suspend fun checkPerfectComplianceAchievements(consecutivePerfectDays: Int) {
        when {
            consecutivePerfectDays >= 30 -> {
                updateAchievementProgress(AchievementType.PERFECT_MONTH, consecutivePerfectDays)
            }
            consecutivePerfectDays >= 7 -> {
                updateAchievementProgress(AchievementType.PERFECT_WEEK, consecutivePerfectDays)
            }
        }
    }

    /**
     * ƒ∞lk adƒ±m ba≈üarƒ±larƒ±nƒ± kontrol et
     */
    suspend fun checkFirstStepAchievements(
        hasMedicine: Boolean = false,
        hasTakenDose: Boolean = false
    ) {
        if (hasMedicine) {
            updateAchievementProgress(AchievementType.FIRST_MEDICINE, 1)
        }
        if (hasTakenDose) {
            updateAchievementProgress(AchievementType.FIRST_DOSE_TAKEN, 1)
        }
    }

    /**
     * Koleksiyon ba≈üarƒ±larƒ±nƒ± kontrol et (ila√ß sayƒ±sƒ±)
     */
    suspend fun checkMedicineCollectorAchievements(totalMedicines: Int) {
        if (totalMedicines >= 5) {
            updateAchievementProgress(AchievementType.MEDICINE_COLLECTOR_5, totalMedicines)
        }
        if (totalMedicines >= 10) {
            updateAchievementProgress(AchievementType.MEDICINE_COLLECTOR_10, totalMedicines)
        }
    }

    /**
     * Toplam doz ba≈üarƒ±larƒ±nƒ± kontrol et
     */
    suspend fun checkTotalDosesAchievements(totalDoses: Int) {
        listOf(
            AchievementType.TOTAL_DOSES_50,
            AchievementType.TOTAL_DOSES_100,
            AchievementType.TOTAL_DOSES_365,
            AchievementType.TOTAL_DOSES_1000
        ).forEach { type ->
            if (totalDoses >= type.target) {
                updateAchievementProgress(type, totalDoses)
            }
        }
    }

    /**
     * T√ºm ba≈üarƒ±larƒ± kontrol et ve g√ºncelle
     * (ƒ∞la√ß alƒ±ndƒ±ƒüƒ±nda, ila√ß eklendiƒüinde, vb. √ßaƒürƒ±lƒ±r)
     */
    suspend fun checkAllAchievements(userStats: UserStats) {
        // Streak ba≈üarƒ±larƒ±
        checkStreakAchievements(userStats.currentStreak)

        // Perfect compliance ba≈üarƒ±larƒ±
        // TODO: consecutivePerfectDays hesapla

        // First step ba≈üarƒ±larƒ±
        checkFirstStepAchievements(
            hasMedicine = userStats.totalMedicines > 0,
            hasTakenDose = userStats.totalDosesTaken > 0
        )

        // Koleksiyon ba≈üarƒ±larƒ±
        checkMedicineCollectorAchievements(userStats.totalMedicines)

        // Toplam doz ba≈üarƒ±larƒ±
        checkTotalDosesAchievements(userStats.totalDosesTaken)
    }

    /**
     * Ba≈üarƒ± kilidi a√ßƒ±ldƒ±ƒüƒ±nda bildirim g√∂nder
     */
    private suspend fun sendAchievementUnlockedNotification(achievement: Achievement) {
        try {
            val userId = auth.currentUser?.uid ?: return
            val notification = mapOf(
                "userId" to userId,
                "type" to "ACHIEVEMENT",
                "title" to "üèÜ Ba≈üarƒ± Kazandƒ±n!",
                "body" to "${achievement.type.emoji} ${achievement.type.displayName}: ${achievement.type.description}",
                "isRead" to false,
                "achievementId" to achievement.id,
                "createdAt" to Timestamp.now()
            )

            firestore.collection("notifications").add(notification).await()
            Log.d(TAG, "Achievement notification sent")
        } catch (e: Exception) {
            Log.e(TAG, "Error sending achievement notification", e)
        }
    }
}

// ============================================================================
// FILE: BadiRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/repository/BadiRepository.kt
// [27 of 122]
// ============================================================================

package com.bardino.dozi.core.data.repository

import com.bardino.dozi.core.data.model.*
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FieldValue
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.firestore.Query
import com.google.firebase.Timestamp
import kotlinx.coroutines.channels.awaitClose
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.callbackFlow
import kotlinx.coroutines.launch
import kotlinx.coroutines.tasks.await
import java.util.*
import kotlin.random.Random

/**
 * Badi sistemini y√∂neten repository
 */
class BadiRepository(
    private val auth: FirebaseAuth = FirebaseAuth.getInstance(),
    private val db: FirebaseFirestore = FirebaseFirestore.getInstance()
) {

    private val currentUserId: String?
        get() = auth.currentUser?.uid

    // ==================== Badi ƒ∞≈ülemleri ====================

    /**
     * Kullanƒ±cƒ±nƒ±n badilerini real-time olarak dinle
     * ACTIVE ve PAUSED badileri g√∂sterir, REMOVED olanlarƒ± hari√ß tutar
     */
    fun getBadisFlow(): Flow<List<BadiWithUser>> = callbackFlow {
        val userId = currentUserId ?: run {
            android.util.Log.w("BadiRepository", "getBadisFlow: No user logged in")
            close()
            return@callbackFlow
        }

        android.util.Log.d("BadiRepository", "getBadisFlow: Listening for badis of userId=$userId")

        val scope = this

        val listener = db.collection("buddies")
            .whereEqualTo("userId", userId)
            .addSnapshotListener { snapshot, error ->
                if (error != null) {
                    android.util.Log.e("BadiRepository", "getBadisFlow: Error", error)
                    close(error)
                    return@addSnapshotListener
                }

                // Client-side filtreleme: REMOVED olanlarƒ± hari√ß tut
                val badis = snapshot?.documents?.mapNotNull { doc ->
                    val badi = doc.toObject(Badi::class.java)?.copy(id = doc.id)
                    android.util.Log.d("BadiRepository", "getBadisFlow: Found badi record - id=${doc.id}, userId=${badi?.userId}, buddyUserId=${badi?.buddyUserId}, status=${badi?.status}")

                    // REMOVED olanlarƒ± ve self-buddy'leri filtrele
                    when {
                        badi?.status == BadiStatus.REMOVED -> {
                            android.util.Log.d("BadiRepository", "getBadisFlow: Filtering out REMOVED badi ${doc.id}")
                            null
                        }
                        badi?.userId == badi?.buddyUserId -> {
                            android.util.Log.w("BadiRepository", "getBadisFlow: Filtering out self-buddy ${doc.id}")
                            null
                        }
                        else -> badi
                    }
                } ?: emptyList()

                android.util.Log.d("BadiRepository", "getBadisFlow: Total ${badis.size} badi records found")

                // ‚ùó Suspend fonksiyon kullanacaƒüƒ±mƒ±z i√ßin coroutine a√ßƒ±yoruz
                scope.launch {
                    val list = badis.map { badi ->
                        android.util.Log.d("BadiRepository", "getBadisFlow: Fetching user info for buddyUserId=${badi.buddyUserId}")
                        val user = getUserById(badi.buddyUserId)
                        android.util.Log.d("BadiRepository", "getBadisFlow: Got user - uid=${user.uid}, name=${user.name}, email=${user.email}")
                        BadiWithUser(badi, user)
                    }
                    android.util.Log.d("BadiRepository", "getBadisFlow: Sending ${list.size} badis to UI")
                    trySend(list).isSuccess
                }
            }

        awaitClose { listener.remove() }
    }


    /**
     * Belirli bir badiyi ID ile getir
     */
    suspend fun getBadiById(badiId: String): Badi? {
        return try {
            db.collection("buddies")
                .document(badiId)
                .get()
                .await()
                .toObject(Badi::class.java)
        } catch (e: Exception) {
            null
        }
    }

    /**
     * ƒ∞ki kullanƒ±cƒ± arasƒ±nda badi ili≈ükisi var mƒ± kontrol et
     */
    suspend fun isBadi(otherUserId: String): Boolean {
        val userId = currentUserId ?: return false

        return try {
            val snapshot = db.collection("buddies")
                .whereEqualTo("userId", userId)
                .whereEqualTo("buddyUserId", otherUserId)
                .whereEqualTo("status", BadiStatus.ACTIVE.name)
                .get()
                .await()

            !snapshot.isEmpty
        } catch (e: Exception) {
            false
        }
    }

    /**
     * Badi izinlerini g√ºncelle
     */
    suspend fun updateBadiPermissions(
        badiId: String,
        permissions: BadiPermissions
    ): Result<Unit> {
        return try {
            db.collection("buddies")
                .document(badiId)
                .update("permissions", permissions)
                .await()
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    /**
     * Badi bildirim tercihlerini g√ºncelle
     */
    suspend fun updateBadiNotificationPreferences(
        badiId: String,
        preferences: BadiNotificationPreferences
    ): Result<Unit> {
        return try {
            db.collection("buddies")
                .document(badiId)
                .update("notificationPreferences", preferences)
                .await()
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    /**
     * Badiye nickname (takma isim) ekle
     */
    suspend fun updateBadiNickname(
        badiId: String,
        nickname: String?
    ): Result<Unit> {
        return try {
            db.collection("buddies")
                .document(badiId)
                .update("nickname", nickname)
                .await()
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    /**
     * Badi durumunu g√ºncelle (ACTIVE, PAUSED, REMOVED)
     */
    suspend fun updateBadiStatus(
        badiId: String,
        status: BadiStatus
    ): Result<Unit> {
        return try {
            db.collection("buddies")
                .document(badiId)
                .update("status", status.name)
                .await()
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    /**
     * Badi ili≈ükisini kaldƒ±r
     */
    suspend fun removeBadi(badiId: String): Result<Unit> {
        return try {
            db.collection("buddies")
                .document(badiId)
                .update("status", BadiStatus.REMOVED.name)
                .await()
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    // ==================== Badi ƒ∞stekleri ====================

    /**
     * Badi kodu olu≈ütur (6 haneli)
     */
    suspend fun generateBadiCode(): String {
        val userId = currentUserId ?: return ""

        val code = Random.nextInt(100000, 999999).toString()

        // User'a badi kodu kaydet
        db.collection("users")
            .document(userId)
            .update("buddyCode", code)
            .await()

        return code
    }

    /**
     * Badi kodu ile kullanƒ±cƒ± bul
     */
    suspend fun findUserByBadiCode(code: String): User? {
        return try {
            val snapshot = db.collection("users")
                .whereEqualTo("buddyCode", code)
                .limit(1)
                .get()
                .await()

            snapshot.documents.firstOrNull()?.toObject(User::class.java)
        } catch (e: Exception) {
            null
        }
    }

    /**
     * Email ile kullanƒ±cƒ± bul
     */
    suspend fun findUserByEmail(email: String): User? {
        return try {
            val snapshot = db.collection("users")
                .whereEqualTo("email", email)
                .limit(1)
                .get()
                .await()

            snapshot.documents.firstOrNull()?.toObject(User::class.java)
        } catch (e: Exception) {
            null
        }
    }

    /**
     * Badi isteƒüi g√∂nder
     */
    suspend fun sendBadiRequest(
        toUserId: String,
        message: String? = null
    ): Result<String> {
        val userId = currentUserId ?: return Result.failure(Exception("User not logged in"))

        // Kendine istek g√∂ndermeyi engelle
        if (userId == toUserId) {
            return Result.failure(Exception("Kendinize badi isteƒüi g√∂nderemezsiniz"))
        }

        return try {
            // Kullanƒ±cƒ± bilgilerini al
            val currentUser = db.collection("users").document(userId).get().await()
                .toObject(User::class.java) ?: return Result.failure(Exception("User not found"))

            // Daha √∂nce istek g√∂nderilmi≈ü mi kontrol et
            val existingRequest = db.collection("buddy_requests")
                .whereEqualTo("fromUserId", userId)
                .whereEqualTo("toUserId", toUserId)
                .whereEqualTo("status", BadiRequestStatus.PENDING.name)
                .get()
                .await()

            if (!existingRequest.isEmpty) {
                return Result.failure(Exception("Zaten bekleyen bir istek var"))
            }

            // Yeni istek olu≈ütur
            val request = BadiRequest(
                fromUserId = userId,
                toUserId = toUserId,
                fromUserName = currentUser.name,
                fromUserPhoto = currentUser.photoUrl,
                message = message,
                status = BadiRequestStatus.PENDING,
                expiresAt = Timestamp(Date(System.currentTimeMillis() + 7 * 24 * 60 * 60 * 1000)) // 7 g√ºn
            )

            val docRef = db.collection("buddy_requests").add(request).await()
            Result.success(docRef.id)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    /**
     * Bekleyen badi isteklerini real-time dinle
     * Not: respondedAt NULL olan (hen√ºz yanƒ±t verilmemi≈ü) istekleri getir
     * Firestore null deƒüerleri index'lemediƒüi i√ßin client-side filtreleme yapƒ±yoruz
     */
    fun getPendingBadiRequestsFlow(): Flow<List<BadiRequestWithUser>> = callbackFlow {
        val userId = currentUserId ?: run {
            android.util.Log.w("BadiRepository", "getPendingBadiRequestsFlow: No user logged in")
            close()
            return@callbackFlow
        }

        android.util.Log.d("BadiRepository", "getPendingBadiRequestsFlow: Listening for requests to userId=$userId")

        val scope = this

        val listener = db.collection("buddy_requests")
            .whereEqualTo("toUserId", userId)
            .whereEqualTo("status", BadiRequestStatus.PENDING.name)
            .orderBy("createdAt", Query.Direction.DESCENDING)
            .addSnapshotListener { snapshot, error ->
                if (error != null) {
                    android.util.Log.e("BadiRepository", "getPendingBadiRequestsFlow error", error)
                    close(error)
                    return@addSnapshotListener
                }

                // Client-side filtreleme: SADECE respondedAt NULL olanlarƒ± al
                val requests = snapshot?.documents?.mapNotNull { doc ->
                    val request = doc.toObject(BadiRequest::class.java)?.copy(id = doc.id)
                    if (request?.respondedAt != null) {
                        android.util.Log.w("BadiRepository", "Found request with respondedAt but still PENDING: ${doc.id}")
                        null // Filtrele
                    } else {
                        android.util.Log.d("BadiRepository", "Found valid pending request: ${doc.id}")
                        request
                    }
                } ?: emptyList()

                android.util.Log.d("BadiRepository", "Total valid pending requests: ${requests.size}")

                scope.launch {
                    val list = requests.map { request ->
                        val user = getUserById(request.fromUserId)
                        BadiRequestWithUser(request, user)
                    }
                    android.util.Log.d("BadiRepository", "Sending ${list.size} pending requests to UI")
                    trySend(list).isSuccess
                }
            }

        awaitClose { listener.remove() }
    }


    /**
     * Badi isteƒüini kabul et
     */
    suspend fun acceptBadiRequest(requestId: String): Result<Unit> {
        val userId = currentUserId ?: run {
            android.util.Log.e("BadiRepository", "acceptBadiRequest: User not logged in")
            return Result.failure(Exception("User not logged in"))
        }

        return try {
            android.util.Log.d("BadiRepository", "acceptBadiRequest: Getting request $requestId")

            // ƒ∞steƒüi al
            val requestDoc = db.collection("buddy_requests").document(requestId).get().await()
            val request = requestDoc.toObject(BadiRequest::class.java)
                ?: run {
                    android.util.Log.e("BadiRepository", "acceptBadiRequest: Request not found")
                    return Result.failure(Exception("Request not found"))
                }

            // ƒ∞stek zaten kabul edilmi≈ü mi kontrol et
            if (request.status != BadiRequestStatus.PENDING) {
                android.util.Log.w("BadiRepository", "acceptBadiRequest: Request already processed (status=${request.status})")
                return Result.failure(Exception("Bu istek zaten i≈üleme alƒ±nmƒ±≈ü"))
            }

            android.util.Log.d("BadiRepository", "acceptBadiRequest: From ${request.fromUserId} to $userId")

            // üî• FIX: Self-buddy kontrol√º - kendine badi isteƒüi kabul edilemez
            if (request.fromUserId == userId) {
                android.util.Log.e("BadiRepository", "acceptBadiRequest: Cannot add yourself as badi (self-buddy)")
                return Result.failure(Exception("Kendinizi badi olarak ekleyemezsiniz"))
            }

            // Bu kullanƒ±cƒ±lar arasƒ±nda zaten badi ili≈ükisi var mƒ± kontrol et
            val existingBadi = db.collection("buddies")
                .whereEqualTo("userId", userId)
                .whereEqualTo("buddyUserId", request.fromUserId)
                .whereEqualTo("status", BadiStatus.ACTIVE.name)
                .get()
                .await()

            if (!existingBadi.isEmpty) {
                android.util.Log.w("BadiRepository", "acceptBadiRequest: Badi relationship already exists")
                // ƒ∞steƒüi kabul edildi olarak i≈üaretle
                db.collection("buddy_requests").document(requestId)
                    .update(
                        mapOf(
                            "status" to BadiRequestStatus.ACCEPTED.name,
                            "respondedAt" to FieldValue.serverTimestamp()
                        )
                    ).await()
                return Result.success(Unit)
            }

            // ƒ∞ki y√∂nl√º badi ili≈ükisi olu≈ütur
            val badi1 = Badi(
                userId = request.fromUserId,
                buddyUserId = userId,
                status = BadiStatus.ACTIVE
            )

            val badi2 = Badi(
                userId = userId,
                buddyUserId = request.fromUserId,
                status = BadiStatus.ACTIVE
            )

            android.util.Log.d("BadiRepository", "acceptBadiRequest: Creating badis - badi1(userId=${badi1.userId}, buddyUserId=${badi1.buddyUserId}), badi2(userId=${badi2.userId}, buddyUserId=${badi2.buddyUserId})")

            // Firestore batch i≈ülemi
            val batch = db.batch()

            // Badi ili≈ükilerini ekle
            val badi1Ref = db.collection("buddies").document()
            val badi2Ref = db.collection("buddies").document()

            batch.set(badi1Ref, badi1)
            batch.set(badi2Ref, badi2)

            // ƒ∞stek durumunu g√ºncelle
            batch.update(
                db.collection("buddy_requests").document(requestId),
                mapOf(
                    "status" to BadiRequestStatus.ACCEPTED.name,
                    "respondedAt" to FieldValue.serverTimestamp()
                )
            )

            android.util.Log.d("BadiRepository", "acceptBadiRequest: Committing batch...")
            batch.commit().await()

            android.util.Log.d("BadiRepository", "acceptBadiRequest: ‚úÖ Success - Badi relationship created")
            Result.success(Unit)
        } catch (e: Exception) {
            android.util.Log.e("BadiRepository", "acceptBadiRequest: ‚ùå Error", e)
            Result.failure(e)
        }
    }

    /**
     * Kirli badi request kayƒ±tlarƒ±nƒ± temizle
     * (respondedAt varsa ama status hala PENDING olanlarƒ± d√ºzelt)
     */
    suspend fun cleanupStaleRequests(): Result<Int> {
        val userId = currentUserId ?: return Result.failure(Exception("User not logged in"))

        return try {
            android.util.Log.d("BadiRepository", "cleanupStaleRequests: Starting cleanup")

            // Status=PENDING ama respondedAt olan kayƒ±tlarƒ± bul
            val staleRequests = db.collection("buddy_requests")
                .whereEqualTo("toUserId", userId)
                .whereEqualTo("status", BadiRequestStatus.PENDING.name)
                .get()
                .await()

            val requestsToUpdate = staleRequests.documents.filter { doc ->
                val respondedAt = doc.get("respondedAt")
                respondedAt != null
            }

            android.util.Log.d("BadiRepository", "cleanupStaleRequests: Found ${requestsToUpdate.size} stale requests")

            if (requestsToUpdate.isEmpty()) {
                return Result.success(0)
            }

            // Bu istekleri EXPIRED olarak i≈üaretle (veya sil)
            val batch = db.batch()
            requestsToUpdate.forEach { doc ->
                android.util.Log.d("BadiRepository", "cleanupStaleRequests: Deleting stale request ${doc.id}")
                batch.delete(doc.reference)
            }

            batch.commit().await()
            android.util.Log.d("BadiRepository", "cleanupStaleRequests: ‚úÖ Cleaned up ${requestsToUpdate.size} stale requests")

            Result.success(requestsToUpdate.size)
        } catch (e: Exception) {
            android.util.Log.e("BadiRepository", "cleanupStaleRequests: ‚ùå Error", e)
            Result.failure(e)
        }
    }

    /**
     * Duplicate badi kayƒ±tlarƒ±nƒ± temizle
     * (Her userId-buddyUserId kombinasyonundan sadece birini bƒ±rak)
     */
    suspend fun cleanupDuplicateBadis(): Result<Int> {
        val userId = currentUserId ?: return Result.failure(Exception("User not logged in"))

        return try {
            android.util.Log.d("BadiRepository", "cleanupDuplicateBadis: Starting cleanup for user $userId")

            // Kullanƒ±cƒ±nƒ±n t√ºm aktif badi kayƒ±tlarƒ±nƒ± al (ACTIVE ve PAUSED)
            val badisSnapshot = db.collection("buddies")
                .whereEqualTo("userId", userId)
                .get()
                .await()

            // REMOVED olanlarƒ± filtrele
            val activeDocs = badisSnapshot.documents.filter { doc ->
                val status = doc.toObject(Badi::class.java)?.status
                status != BadiStatus.REMOVED
            }

            // buddyUserId'ye g√∂re grupla
            val grouped = activeDocs.groupBy { doc ->
                doc.toObject(Badi::class.java)?.buddyUserId ?: ""
            }

            var deletedCount = 0
            val batch = db.batch()

            // Her grup i√ßin sadece ilkini tut, diƒüerlerini sil
            grouped.forEach { (buddyUserId, docs) ->
                if (docs.size > 1) {
                    android.util.Log.d("BadiRepository", "cleanupDuplicateBadis: Found ${docs.size} duplicates for badi $buddyUserId")
                    // ƒ∞lkini hari√ß tut, diƒüerlerini sil
                    docs.drop(1).forEach { doc ->
                        batch.delete(doc.reference)
                        deletedCount++
                    }
                }
            }

            if (deletedCount > 0) {
                batch.commit().await()
                android.util.Log.d("BadiRepository", "cleanupDuplicateBadis: ‚úÖ Deleted $deletedCount duplicate records")
            } else {
                android.util.Log.d("BadiRepository", "cleanupDuplicateBadis: No duplicates found")
            }

            Result.success(deletedCount)
        } catch (e: Exception) {
            android.util.Log.e("BadiRepository", "cleanupDuplicateBadis: ‚ùå Error", e)
            Result.failure(e)
        }
    }

    /**
     * Self-buddy kayƒ±tlarƒ±nƒ± temizle
     * (userId == buddyUserId olan hatalƒ± kayƒ±tlarƒ± sil)
     */
    suspend fun cleanupSelfBuddies(): Result<Int> {
        val userId = currentUserId ?: return Result.failure(Exception("User not logged in"))

        return try {
            android.util.Log.d("BadiRepository", "cleanupSelfBuddies: Starting cleanup for user $userId")

            // Kullanƒ±cƒ±nƒ±n t√ºm badi kayƒ±tlarƒ±nƒ± al
            val badisSnapshot = db.collection("buddies")
                .whereEqualTo("userId", userId)
                .get()
                .await()

            var deletedCount = 0
            val batch = db.batch()

            // Self-buddy kayƒ±tlarƒ±nƒ± bul ve sil
            badisSnapshot.documents.forEach { doc ->
                val badi = doc.toObject(Badi::class.java)
                if (badi != null && badi.userId == badi.buddyUserId) {
                    android.util.Log.w("BadiRepository", "cleanupSelfBuddies: Found self-buddy record ${doc.id}")
                    batch.delete(doc.reference)
                    deletedCount++
                }
            }

            if (deletedCount > 0) {
                batch.commit().await()
                android.util.Log.d("BadiRepository", "cleanupSelfBuddies: ‚úÖ Deleted $deletedCount self-buddy records")
            } else {
                android.util.Log.d("BadiRepository", "cleanupSelfBuddies: No self-buddy records found")
            }

            Result.success(deletedCount)
        } catch (e: Exception) {
            android.util.Log.e("BadiRepository", "cleanupSelfBuddies: ‚ùå Error", e)
            Result.failure(e)
        }
    }

    /**
     * Badi isteƒüini reddet
     */
    suspend fun rejectBadiRequest(requestId: String): Result<Unit> {
        return try {
            db.collection("buddy_requests")
                .document(requestId)
                .update(
                    mapOf(
                        "status" to BadiRequestStatus.REJECTED.name,
                        "respondedAt" to FieldValue.serverTimestamp()
                    )
                )
                .await()
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    // ==================== Yardƒ±mcƒ± Fonksiyonlar ====================

    private suspend fun getUserById(userId: String): User {
        return try {
            android.util.Log.d("BadiRepository", "getUserById: Fetching user with userId=$userId")
            val userDoc = db.collection("users")
                .document(userId)
                .get()
                .await()

            val user = userDoc.toObject(User::class.java)
            if (user != null) {
                android.util.Log.d("BadiRepository", "getUserById: Found user - uid=${user.uid}, name=${user.name}, email=${user.email}")
                user
            } else {
                android.util.Log.w("BadiRepository", "getUserById: User not found in Firestore, using placeholder")
                User(uid = userId, name = "Bilinmeyen")
            }
        } catch (e: Exception) {
            android.util.Log.e("BadiRepository", "getUserById: Error fetching user $userId", e)
            User(uid = userId, name = "Bilinmeyen")
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üìè PLAN Lƒ∞Mƒ∞T KONTROL METODLARƒ∞
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * Kullanƒ±cƒ±nƒ±n aktif badi sayƒ±sƒ±nƒ± d√∂nd√ºr
     * ACTIVE ve PAUSED badileri sayar
     */
    suspend fun getActiveBadiCount(): Int {
        val userId = currentUserId ?: return 0

        return try {
            val snapshot = db.collection("buddies")
                .whereEqualTo("userId", userId)
                .get()
                .await()

            snapshot.documents.count { doc ->
                val status = doc.getString("status")
                status == BadiStatus.ACTIVE.name || status == BadiStatus.PAUSED.name
            }
        } catch (e: Exception) {
            android.util.Log.e("BadiRepository", "getActiveBadiCount: Error", e)
            0
        }
    }

    /**
     * Daha fazla badi eklenebilir mi kontrol et
     * @param limit Maksimum izin verilen badi sayƒ±sƒ± (-1 = sƒ±nƒ±rsƒ±z)
     */
    suspend fun canAddMoreBadis(limit: Int): Boolean {
        if (limit == -1) return true // Sƒ±nƒ±rsƒ±z
        if (limit == 0) return false // Badi yok (Free plan)
        return getActiveBadiCount() < limit
    }

    /**
     * Badi isteƒüi kabul edilebilir mi kontrol et
     * Her iki kullanƒ±cƒ±nƒ±n da limitini kontrol eder
     */
    suspend fun canAcceptBadiRequest(requestId: String, userLimit: Int, requesterLimit: Int): Result<Boolean> {
        val userId = currentUserId ?: return Result.failure(Exception("User not logged in"))

        return try {
            // ƒ∞steƒüi al
            val request = db.collection("buddy_requests")
                .document(requestId)
                .get()
                .await()
                .toObject(BadiRequest::class.java)
                ?: return Result.failure(Exception("Request not found"))

            // Kabul eden kullanƒ±cƒ±nƒ±n limitini kontrol et
            if (!canAddMoreBadis(userLimit)) {
                return Result.success(false)
            }

            // ƒ∞steƒüi g√∂nderen kullanƒ±cƒ±nƒ±n limitini kontrol et
            val requesterBadiCount = try {
                val snapshot = db.collection("buddies")
                    .whereEqualTo("userId", request.fromUserId)
                    .get()
                    .await()

                snapshot.documents.count { doc ->
                    val status = doc.getString("status")
                    status == BadiStatus.ACTIVE.name || status == BadiStatus.PAUSED.name
                }
            } catch (e: Exception) {
                0
            }

            if (requesterLimit != -1 && requesterBadiCount >= requesterLimit) {
                return Result.success(false)
            }

            Result.success(true)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}

// ============================================================================
// FILE: FAQRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/repository/FAQRepository.kt
// [28 of 122]
// ============================================================================

package com.bardino.dozi.core.data.repository

import android.util.Log
import com.bardino.dozi.core.data.model.FAQ
import com.bardino.dozi.core.data.model.FAQCategory
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.tasks.await

class FAQRepository(
    private val db: FirebaseFirestore = FirebaseFirestore.getInstance()
) {

    /**
     * Tum SSS'leri kategoriye gore gruplu getir
     * Firestore bossa seed data yukler
     */
    suspend fun getAllFAQs(): List<FAQ> {
        return try {
            val snapshot = db.collection("faqs")
                .whereEqualTo("isActive", true)
                .get()
                .await()

            val faqs = snapshot.documents
                .mapNotNull { it.toObject(FAQ::class.java)?.copy(id = it.id) }
                .sortedBy { it.order }

            // Firestore bossa seed data yukle
            if (faqs.isEmpty()) {
                seedFAQs()
                return getDefaultFAQs()
            }

            faqs
        } catch (e: Exception) {
            Log.e("FAQRepository", "Error fetching FAQs: ${e.message}")
            // Hata durumunda varsayilan verileri don
            getDefaultFAQs()
        }
    }

    /**
     * Firestore'a seed data yukle
     */
    private suspend fun seedFAQs() {
        try {
            val batch = db.batch()
            getDefaultFAQs().forEach { faq ->
                val docRef = db.collection("faqs").document(faq.id)
                batch.set(docRef, faq)
            }
            batch.commit().await()
            Log.d("FAQRepository", "Seed data yuklendi: ${getDefaultFAQs().size} soru")
        } catch (e: Exception) {
            Log.e("FAQRepository", "Seed data yuklenemedi: ${e.message}")
        }
    }

    /**
     * Kategorileri getir
     */
    suspend fun getCategories(): List<FAQCategory> {
        return try {
            val snapshot = db.collection("faq_categories")
                .get()
                .await()

            snapshot.documents
                .mapNotNull { it.toObject(FAQCategory::class.java)?.copy(id = it.id) }
                .sortedBy { it.order }
        } catch (e: Exception) {
            Log.e("FAQRepository", "Error fetching categories: ${e.message}")
            emptyList()
        }
    }

    /**
     * Belirli bir kategorideki SSS'leri getir
     */
    suspend fun getFAQsByCategory(category: String): List<FAQ> {
        return try {
            val snapshot = db.collection("faqs")
                .whereEqualTo("category", category)
                .whereEqualTo("isActive", true)
                .get()
                .await()

            snapshot.documents
                .mapNotNull { it.toObject(FAQ::class.java)?.copy(id = it.id) }
                .sortedBy { it.order }
        } catch (e: Exception) {
            Log.e("FAQRepository", "Error fetching FAQs by category: ${e.message}")
            emptyList()
        }
    }

    /**
     * SSS'lerde arama yap
     */
    suspend fun searchFAQs(query: String): List<FAQ> {
        val allFaqs = getAllFAQs()
        val lowerQuery = query.lowercase()

        return allFaqs.filter { faq ->
            faq.question.lowercase().contains(lowerQuery) ||
            faq.answer.lowercase().contains(lowerQuery)
        }
    }

    /**
     * Varsayilan SSS verileri
     */
    private fun getDefaultFAQs(): List<FAQ> = listOf(
        // Ilac Yonetimi
        FAQ(
            id = "faq_1",
            category = "Ilac Yonetimi",
            question = "Nasil yeni ilac eklerim?",
            answer = "Ana sayfada '+' butonuna tiklayin veya Ilaclarim sekmesinden 'Ilac Ekle' butonuna basin. Ilac adini arayarak veritabanindan secebilir ya da 'Ozel Ilac Ekle' ile manuel olarak girebilirsiniz.",
            order = 1,
            isActive = true
        ),
        FAQ(
            id = "faq_2",
            category = "Ilac Yonetimi",
            question = "Ilac bilgilerini nasil duzenlerim?",
            answer = "Ilaclarim sekmesinden duzenlemek istediginiz ilaca tiklayin. Acilan detay sayfasinda sag ustteki kalem ikonuna basarak ilac adini, dozajini, stok miktarini ve diger bilgileri guncelleyebilirsiniz.",
            order = 2,
            isActive = true
        ),
        FAQ(
            id = "faq_3",
            category = "Ilac Yonetimi",
            question = "Ilaci nasil silerim?",
            answer = "Ilac detay sayfasina gidin ve sag ustteki cop kutusu ikonuna basin. Onay dialogunda 'Sil' butonuna basarak ilaci kalici olarak silebilirsiniz. Bu islem geri alinamaz.",
            order = 3,
            isActive = true
        ),
        FAQ(
            id = "faq_4",
            category = "Ilac Yonetimi",
            question = "Ilac stok takibi nasil calisir?",
            answer = "Ilac eklerken veya duzenlerken stok miktarini girin. Her ilac aldiginizda stok otomatik duser. Stok azaldiginda size bildirim gondeririz. Stok bittiginde ilaci yeniden temin etmeniz gerektigini hatirlatiriz.",
            order = 4,
            isActive = true
        ),

        // Hatirlaticilar
        FAQ(
            id = "faq_5",
            category = "Hatirlaticilar",
            question = "Nasil hatirlatici eklerim?",
            answer = "Ilac ekledikten sonra otomatik olarak hatirlatici ekleme ekranina yonlendirilirsiniz. Alternatif olarak Hatirlaticilar sekmesinden '+' butonuna basarak da yeni hatirlatici olusturabilirsiniz.",
            order = 5,
            isActive = true
        ),
        FAQ(
            id = "faq_6",
            category = "Hatirlaticilar",
            question = "Hatirlatici saatlerini nasil degistiririm?",
            answer = "Hatirlaticilar sekmesinden duzenlemek istediginiz hatirlaticinizi secin. Saat, siklik (her gun, gun asiri, vb.) ve bitis tarihini guncelleyebilirsiniz. Degisiklikler kaydedildiginde alarmlar otomatik guncellenir.",
            order = 6,
            isActive = true
        ),
        FAQ(
            id = "faq_7",
            category = "Hatirlaticilar",
            question = "Hatirlatiyi nasil silerim?",
            answer = "Hatirlatici duzenleme ekraninda en altta 'Hatirlatiyi Sil' butonuna basin. Bu islem sadece hatirlatiyi siler, ilac kaydiniz korunur.",
            order = 7,
            isActive = true
        ),
        FAQ(
            id = "faq_8",
            category = "Hatirlaticilar",
            question = "Bildirimler neden gelmiyor?",
            answer = "1) Telefon ayarlarindan Dozi icin bildirim iznini kontrol edin.\n2) Pil tasarrufu modunda Dozi'yi istisnalara ekleyin.\n3) Tam alarm izni verildiginden emin olun.\n4) Rahatsiz Etme modunun kapali oldugunu kontrol edin.",
            order = 8,
            isActive = true
        ),
        FAQ(
            id = "faq_9",
            category = "Hatirlaticilar",
            question = "Sesli hatirlatici nasil aktif edilir?",
            answer = "Sesli hatirlaticilar Dozi Ekstra ozelligidir. Premium'a yukselttiginizde Profil > Bildirim Ayarlari > Sesli Hatirlatici bolumunden erkek veya kadin sesi secebilirsiniz.",
            order = 9,
            isActive = true
        ),

        // Premium
        FAQ(
            id = "faq_10",
            category = "Premium",
            question = "Dozi Ekstra nedir?",
            answer = "Dozi Ekstra premium aboneliktir. Sinirsiz ilac ve hatirlatici, bulut yedekleme, sesli hatirlaticilar, detayli istatistikler, tema ozellestirme ve oncelikli destek icermektedir.",
            order = 10,
            isActive = true
        ),
        FAQ(
            id = "faq_11",
            category = "Premium",
            question = "Ucretsiz planda kac ilac ekleyebilirim?",
            answer = "Ucretsiz planda 1 ilac ve 2 hatirlatma saati ekleyebilirsiniz. Daha fazlasi icin Dozi Ekstra'ya yukseltmeniz gerekir.",
            order = 11,
            isActive = true
        ),
        FAQ(
            id = "faq_12",
            category = "Premium",
            question = "Aboneligimi nasil iptal ederim?",
            answer = "Google Play Store > Abonelikler bolumunden Dozi aboneliginizi iptal edebilirsiniz. Iptal ettiginizde mevcut donem sonuna kadar premium ozellikler devam eder.",
            order = 12,
            isActive = true
        ),
        FAQ(
            id = "faq_13",
            category = "Premium",
            question = "Aile plani nedir?",
            answer = "Aile plani ile 4 kisiye kadar aile uyelerinin ilac takibini yapabilirsiniz. Her uye kendi ilaclari ve hatirlaticilarina sahip olur. Organizator tum aileyi gorebilir.",
            order = 13,
            isActive = true
        ),

        // Hesap
        FAQ(
            id = "faq_14",
            category = "Hesap",
            question = "Verilerim guvenli mi?",
            answer = "Evet! Verileriniz Google Firebase altyapisinda sifrelenerek saklanir. Google hesabinizla giris yaptiginizda verileriniz bulutta yedeklenir ve tum cihazlarinizda senkronize olur.",
            order = 14,
            isActive = true
        ),
        FAQ(
            id = "faq_15",
            category = "Hesap",
            question = "Cihaz degistirdigimde verilerim kaybolur mu?",
            answer = "Hayir! Google hesabinizla giris yaptiginiz surece verileriniz bulutta saklanir. Yeni cihazinizda ayni Google hesabiyla giris yaptiginizda tum ilac ve hatirlaticilariniz otomatik yuklenir.",
            order = 15,
            isActive = true
        ),
        FAQ(
            id = "faq_16",
            category = "Hesap",
            question = "Hesabimi nasil silerim?",
            answer = "Hesabinizi silmek icin info@dozi.app adresine e-posta gonderin. Hesap silme islemi tum verilerinizin kalici olarak silinmesine neden olur ve geri alinamaz.",
            order = 16,
            isActive = true
        ),

        // Badi Sistemi
        FAQ(
            id = "faq_17",
            category = "Badi Sistemi",
            question = "Badi nedir?",
            answer = "Badi, ilac takibini yaptiginiz yakinlarinizdir (anne, baba, vb.). Badi'nin ilac saati geldiginde hem siz hem de badi bildirim alir. Badi'nin ilaclari sizin uygulamanizda gorunur.",
            order = 17,
            isActive = true
        ),
        FAQ(
            id = "faq_18",
            category = "Badi Sistemi",
            question = "Nasil Badi eklerim?",
            answer = "Alt menuden Badi sekmesine gidin ve '+' butonuna basin. Badi'nin ismini girin ve olusturulan 6 haneli kodu badi'nin telefonundaki Dozi uygulamasinda giriniz.",
            order = 18,
            isActive = true
        ),

        // Genel
        FAQ(
            id = "faq_19",
            category = "Genel",
            question = "Uygulama cokuyorsa ne yapmaliyim?",
            answer = "1) Uygulamayi kapatip tekrar acin.\n2) Telefonu yeniden baslatin.\n3) Uygulamayi guncelleyin.\n4) Onbellegi temizleyin (Ayarlar > Uygulamalar > Dozi > Onbellegi Temizle).\n\nSorun devam ederse info@dozi.app adresine yazin.",
            order = 19,
            isActive = true
        ),
        FAQ(
            id = "faq_20",
            category = "Genel",
            question = "Uygulamayi nasil guncellerim?",
            answer = "Google Play Store'da Dozi'yi arayin ve 'Guncelle' butonuna basin. Otomatik guncelleme icin Play Store ayarlarindan otomatik guncellemeyi aktif edin.",
            order = 20,
            isActive = true
        )
    )
}

// ============================================================================
// FILE: FamilyPlanRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/repository/FamilyPlanRepository.kt
// [29 of 122]
// ============================================================================

package com.bardino.dozi.core.data.repository

import android.util.Log
import com.bardino.dozi.core.data.model.FamilyPlan
import com.bardino.dozi.core.data.model.FamilyPlanStatus
import com.bardino.dozi.core.data.model.PremiumPlanType
import com.bardino.dozi.core.premium.PremiumFields
import com.google.firebase.Timestamp
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.tasks.await
import java.util.*
import kotlin.random.Random

/**
 * Aile Planƒ± Repository
 *
 * Dozi Ekstra Aile Paketi y√∂netimi i√ßin repository.
 * Ana hesap (organizer) bir plan olu≈üturur, davet kodu ile √ºye ekler.
 */
class FamilyPlanRepository(
    private val auth: FirebaseAuth = FirebaseAuth.getInstance(),
    private val db: FirebaseFirestore = FirebaseFirestore.getInstance()
) {
    companion object {
        private const val TAG = "FamilyPlanRepository"
        private const val COLLECTION_FAMILY_PLANS = "family_plans"
        private const val COLLECTION_USERS = "users"
    }

    /**
     * Yeni bir aile planƒ± olu≈ütur (Ana hesap i√ßin)
     *
     * @param expiryDate Premium biti≈ü tarihi
     * @return Olu≈üturulan aile planƒ±
     */
    suspend fun createFamilyPlan(expiryDate: Timestamp): Result<FamilyPlan> {
        val userId = auth.currentUser?.uid ?: return Result.failure(Exception("Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü"))

        return try {
            // Kullanƒ±cƒ± bilgilerini al
            val userDoc = db.collection(COLLECTION_USERS).document(userId).get().await()
            val userEmail = userDoc.getString("email") ?: ""
            val userName = userDoc.getString("name") ?: "Kullanƒ±cƒ±"

            // Benzersiz davet kodu olu≈ütur
            val invitationCode = generateUniqueInvitationCode()

            // Aile planƒ± olu≈ütur
            val familyPlan = FamilyPlan(
                organizerId = userId,
                organizerEmail = userEmail,
                organizerName = userName,
                planType = "FAMILY_PREMIUM",
                maxMembers = com.bardino.dozi.core.common.Constants.AILE_MAX_MEMBERS,
                currentMembers = emptyList(),
                invitationCode = invitationCode,
                status = FamilyPlanStatus.ACTIVE,
                createdAt = Timestamp.now(),
                expiresAt = expiryDate,
                updatedAt = Timestamp.now()
            )

            // Firestore'a kaydet
            val docRef = db.collection(COLLECTION_FAMILY_PLANS).document()
            val familyPlanWithId = familyPlan.copy(id = docRef.id)
            docRef.set(familyPlanWithId).await()

            // Kullanƒ±cƒ±nƒ±n familyPlanId ve familyRole'√ºn√º g√ºncelle
            val planStart = familyPlan.createdAt?.toDate()?.time ?: System.currentTimeMillis()
            val planExpiry = familyPlan.expiresAt?.toDate()?.time ?: 0L

            db.collection(COLLECTION_USERS).document(userId).update(
                PremiumFields.activePlan(PremiumPlanType.AILE_YEARLY, planStart, planExpiry) +
                    mapOf(
                        "familyPlanId" to docRef.id,
                        "familyRole" to "ORGANIZER"
                    )
            ).await()

            Log.d(TAG, "‚úÖ Aile planƒ± olu≈üturuldu: ${docRef.id}")
            Result.success(familyPlanWithId)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Aile planƒ± olu≈üturma hatasƒ±", e)
            Result.failure(e)
        }
    }

    /**
     * Benzersiz davet kodu olu≈ütur (6 haneli)
     */
    private suspend fun generateUniqueInvitationCode(): String {
        var code: String
        var isUnique: Boolean

        do {
            // 6 haneli rastgele kod olu≈ütur (A-Z, 0-9)
            code = (1..6).map {
                val chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
                chars[Random.nextInt(chars.length)]
            }.joinToString("")

            // Kodun benzersiz olup olmadƒ±ƒüƒ±nƒ± kontrol et
            val querySnapshot = db.collection(COLLECTION_FAMILY_PLANS)
                .whereEqualTo("invitationCode", code)
                .whereEqualTo("status", "ACTIVE")
                .get()
                .await()

            isUnique = querySnapshot.isEmpty
        } while (!isUnique)

        return code
    }

    /**
     * Davet kodu ile aile planƒ±na katƒ±l
     *
     * @param invitationCode Davet kodu
     * @return Katƒ±lƒ±nan aile planƒ±
     */
    suspend fun joinFamilyPlan(invitationCode: String): Result<FamilyPlan> {
        val userId = auth.currentUser?.uid ?: return Result.failure(Exception("Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü"))

        return try {
            // Davet kodunu kontrol et
            val querySnapshot = db.collection(COLLECTION_FAMILY_PLANS)
                .whereEqualTo("invitationCode", invitationCode.uppercase())
                .whereEqualTo("status", "ACTIVE")
                .get()
                .await()

            if (querySnapshot.isEmpty) {
                return Result.failure(Exception("Ge√ßersiz davet kodu"))
            }

            val familyPlanDoc = querySnapshot.documents[0]
            val familyPlan = familyPlanDoc.toObject(FamilyPlan::class.java)
                ?: return Result.failure(Exception("Aile planƒ± bulunamadƒ±"))

            // Yer var mƒ± kontrol et
            if (!familyPlan.hasAvailableSlots()) {
                return Result.failure(Exception("Aile planƒ± dolu (maksimum 3 √ºye)"))
            }

            // Kullanƒ±cƒ± zaten √ºye mi kontrol et
            if (familyPlan.isMember(userId)) {
                return Result.failure(Exception("Zaten bu aile planƒ±nƒ±n √ºyesisiniz"))
            }

            // Kullanƒ±cƒ±nƒ±n ba≈üka bir aile planƒ± var mƒ± kontrol et
            val userDoc = db.collection(COLLECTION_USERS).document(userId).get().await()
            val existingFamilyPlanId = userDoc.getString("familyPlanId")
            if (!existingFamilyPlanId.isNullOrEmpty()) {
                return Result.failure(Exception("Zaten bir aile planƒ± √ºyesisiniz"))
            }

            // √úyeleri g√ºncelle
            val updatedMembers = familyPlan.currentMembers.toMutableList()
            updatedMembers.add(userId)

            // Aile planƒ±nƒ± g√ºncelle
            db.collection(COLLECTION_FAMILY_PLANS).document(familyPlan.id).update(
                mapOf(
                    "currentMembers" to updatedMembers,
                    "updatedAt" to Timestamp.now()
                )
            ).await()

            // Kullanƒ±cƒ±yƒ± g√ºncelle
            val planStart = familyPlan.createdAt?.toDate()?.time ?: System.currentTimeMillis()
            val planExpiry = familyPlan.expiresAt?.toDate()?.time ?: 0L

            db.collection(COLLECTION_USERS).document(userId).update(
                PremiumFields.activePlan(PremiumPlanType.AILE_YEARLY, planStart, planExpiry) +
                    mapOf(
                        "familyPlanId" to familyPlan.id,
                        "familyRole" to "MEMBER"
                    )
            ).await()

            Log.d(TAG, "‚úÖ Kullanƒ±cƒ± aile planƒ±na katƒ±ldƒ±: ${familyPlan.id}")
            Result.success(familyPlan.copy(currentMembers = updatedMembers))
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Aile planƒ±na katƒ±lma hatasƒ±", e)
            Result.failure(e)
        }
    }

    /**
     * Kullanƒ±cƒ±nƒ±n aile planƒ±nƒ± getir
     */
    suspend fun getUserFamilyPlan(): Result<FamilyPlan?> {
        val userId = auth.currentUser?.uid ?: return Result.failure(Exception("Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü"))

        return try {
            // Kullanƒ±cƒ±nƒ±n familyPlanId'sini al
            val userDoc = db.collection(COLLECTION_USERS).document(userId).get().await()
            val familyPlanId = userDoc.getString("familyPlanId")

            if (familyPlanId.isNullOrEmpty()) {
                return Result.success(null)
            }

            // Aile planƒ±nƒ± getir
            val familyPlanDoc = db.collection(COLLECTION_FAMILY_PLANS).document(familyPlanId).get().await()
            val familyPlan = familyPlanDoc.toObject(FamilyPlan::class.java)

            Result.success(familyPlan)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Aile planƒ± getirme hatasƒ±", e)
            Result.failure(e)
        }
    }

    /**
     * Aile √ºyelerini getir (organizat√∂r i√ßin)
     */
    suspend fun getFamilyMembers(familyPlanId: String): Result<List<Map<String, Any>>> {
        return try {
            // Aile planƒ±nƒ± getir
            val familyPlanDoc = db.collection(COLLECTION_FAMILY_PLANS).document(familyPlanId).get().await()
            val familyPlan = familyPlanDoc.toObject(FamilyPlan::class.java)
                ?: return Result.failure(Exception("Aile planƒ± bulunamadƒ±"))

            // √úye bilgilerini getir
            val members = mutableListOf<Map<String, Any>>()

            for (memberId in familyPlan.currentMembers) {
                val memberDoc = db.collection(COLLECTION_USERS).document(memberId).get().await()
                val memberData = mutableMapOf<String, Any>(
                    "uid" to memberId,
                    "name" to (memberDoc.getString("name") ?: "ƒ∞simsiz"),
                    "email" to (memberDoc.getString("email") ?: ""),
                    "photoUrl" to (memberDoc.getString("photoUrl") ?: ""),
                    "joinedAt" to (memberDoc.getLong("createdAt") ?: 0L)
                )
                members.add(memberData)
            }

            Result.success(members)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Aile √ºyeleri getirme hatasƒ±", e)
            Result.failure(e)
        }
    }

    /**
     * Aile √ºyesini √ßƒ±kar (sadece organizat√∂r yapabilir)
     */
    suspend fun removeFamilyMember(memberId: String): Result<Unit> {
        val userId = auth.currentUser?.uid ?: return Result.failure(Exception("Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü"))

        return try {
            // Kullanƒ±cƒ±nƒ±n familyPlanId'sini al
            val userDoc = db.collection(COLLECTION_USERS).document(userId).get().await()
            val familyPlanId = userDoc.getString("familyPlanId")
                ?: return Result.failure(Exception("Aile planƒ± bulunamadƒ±"))
            val familyRole = userDoc.getString("familyRole")

            // Organizat√∂r kontrol√º
            if (familyRole != "ORGANIZER") {
                return Result.failure(Exception("Sadece plan sahibi √ºye √ßƒ±karabilir"))
            }

            // Aile planƒ±nƒ± getir
            val familyPlanDoc = db.collection(COLLECTION_FAMILY_PLANS).document(familyPlanId).get().await()
            val familyPlan = familyPlanDoc.toObject(FamilyPlan::class.java)
                ?: return Result.failure(Exception("Aile planƒ± bulunamadƒ±"))

            // √úyeyi listeden √ßƒ±kar
            val updatedMembers = familyPlan.currentMembers.toMutableList()
            if (!updatedMembers.remove(memberId)) {
                return Result.failure(Exception("√úye bulunamadƒ±"))
            }

            // Aile planƒ±nƒ± g√ºncelle
            db.collection(COLLECTION_FAMILY_PLANS).document(familyPlanId).update(
                mapOf(
                    "currentMembers" to updatedMembers,
                    "updatedAt" to Timestamp.now()
                )
            ).await()

            // √úyenin planƒ±nƒ± kaldƒ±r
            db.collection(COLLECTION_USERS).document(memberId).update(
                PremiumFields.reset() +
                    mapOf(
                        "familyPlanId" to null,
                        "familyRole" to null
                    )
            ).await()

            Log.d(TAG, "‚úÖ √úye aile planƒ±ndan √ßƒ±karƒ±ldƒ±: $memberId")
            Result.success(Unit)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå √úye √ßƒ±karma hatasƒ±", e)
            Result.failure(e)
        }
    }

    /**
     * Aile planƒ±ndan ayrƒ±l (√ºye i√ßin)
     */
    suspend fun leaveFamilyPlan(): Result<Unit> {
        val userId = auth.currentUser?.uid ?: return Result.failure(Exception("Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü"))

        return try {
            // Kullanƒ±cƒ±nƒ±n familyPlanId'sini al
            val userDoc = db.collection(COLLECTION_USERS).document(userId).get().await()
            val familyPlanId = userDoc.getString("familyPlanId")
                ?: return Result.failure(Exception("Aile planƒ± bulunamadƒ±"))
            val familyRole = userDoc.getString("familyRole")

            // Organizat√∂r ayrƒ±lamaz
            if (familyRole == "ORGANIZER") {
                return Result.failure(Exception("Plan sahibi ayrƒ±lamaz. Planƒ± iptal edebilirsiniz."))
            }

            // Aile planƒ±nƒ± getir
            val familyPlanDoc = db.collection(COLLECTION_FAMILY_PLANS).document(familyPlanId).get().await()
            val familyPlan = familyPlanDoc.toObject(FamilyPlan::class.java)
                ?: return Result.failure(Exception("Aile planƒ± bulunamadƒ±"))

            // √úyeyi listeden √ßƒ±kar
            val updatedMembers = familyPlan.currentMembers.toMutableList()
            updatedMembers.remove(userId)

            // Aile planƒ±nƒ± g√ºncelle
            db.collection(COLLECTION_FAMILY_PLANS).document(familyPlanId).update(
                mapOf(
                    "currentMembers" to updatedMembers,
                    "updatedAt" to Timestamp.now()
                )
            ).await()

            // Kullanƒ±cƒ±yƒ± g√ºncelle
            db.collection(COLLECTION_USERS).document(userId).update(
                PremiumFields.reset() +
                    mapOf(
                        "familyPlanId" to null,
                        "familyRole" to null
                    )
            ).await()

            Log.d(TAG, "‚úÖ Kullanƒ±cƒ± aile planƒ±ndan ayrƒ±ldƒ±")
            Result.success(Unit)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Aile planƒ±ndan ayrƒ±lma hatasƒ±", e)
            Result.failure(e)
        }
    }

    /**
     * Aile planƒ±nƒ± iptal et (organizat√∂r i√ßin)
     */
    suspend fun cancelFamilyPlan(): Result<Unit> {
        val userId = auth.currentUser?.uid ?: return Result.failure(Exception("Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü"))

        return try {
            // Kullanƒ±cƒ±nƒ±n familyPlanId'sini al
            val userDoc = db.collection(COLLECTION_USERS).document(userId).get().await()
            val familyPlanId = userDoc.getString("familyPlanId")
                ?: return Result.failure(Exception("Aile planƒ± bulunamadƒ±"))
            val familyRole = userDoc.getString("familyRole")

            // Organizat√∂r kontrol√º
            if (familyRole != "ORGANIZER") {
                return Result.failure(Exception("Sadece plan sahibi iptal edebilir"))
            }

            // Aile planƒ±nƒ± getir
            val familyPlanDoc = db.collection(COLLECTION_FAMILY_PLANS).document(familyPlanId).get().await()
            val familyPlan = familyPlanDoc.toObject(FamilyPlan::class.java)
                ?: return Result.failure(Exception("Aile planƒ± bulunamadƒ±"))

            // T√ºm √ºyelerin premium'unu kaldƒ±r
            val allMembers = familyPlan.currentMembers + familyPlan.organizerId

            for (memberId in allMembers) {
                db.collection(COLLECTION_USERS).document(memberId).update(
                    PremiumFields.reset() +
                        mapOf(
                            "familyPlanId" to null,
                            "familyRole" to null
                        )
                ).await()
            }

            // Aile planƒ±nƒ± iptal et
            db.collection(COLLECTION_FAMILY_PLANS).document(familyPlanId).update(
                mapOf(
                    "status" to "CANCELLED",
                    "updatedAt" to Timestamp.now()
                )
            ).await()

            Log.d(TAG, "‚úÖ Aile planƒ± iptal edildi")
            Result.success(Unit)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Aile planƒ± iptal etme hatasƒ±", e)
            Result.failure(e)
        }
    }
}

// ============================================================================
// FILE: LocationRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/repository/LocationRepository.kt
// [30 of 122]
// ============================================================================

package com.bardino.dozi.core.data.repository

import android.content.Context
import android.util.Log
import com.bardino.dozi.core.data.LocationPreferences
import com.bardino.dozi.core.data.SavedLocation
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FieldValue
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.tasks.await

/**
 * üìç LocationRepository
 *
 * Konumlarƒ± Firestore'da saklar ve senkronize eder.
 * - Uygulama silinse bile konumlar kaybolmaz
 * - Kullanƒ±cƒ± farklƒ± cihazlarda giri≈ü yapsa aynƒ± konumlarƒ± g√∂r√ºr
 */
class LocationRepository(
    private val auth: FirebaseAuth = FirebaseAuth.getInstance(),
    private val db: FirebaseFirestore = FirebaseFirestore.getInstance()
) {
    companion object {
        private const val TAG = "LocationRepository"
        private const val USERS_COLLECTION = "users"
        private const val LOCATIONS_FIELD = "locations"
        const val MAX_LOCATIONS = 5
    }

    /**
     * üì• Firestore'dan konumlarƒ± getir
     */
    suspend fun getLocations(): List<SavedLocation> {
        return try {
            val user = auth.currentUser ?: return emptyList()
            val doc = db.collection(USERS_COLLECTION)
                .document(user.uid)
                .get()
                .await()

            val locationsList = doc.get(LOCATIONS_FIELD) as? List<Map<String, Any>> ?: emptyList()

            locationsList.mapNotNull { locationMap ->
                try {
                    SavedLocation(
                        id = locationMap["id"] as? String ?: return@mapNotNull null,
                        name = locationMap["name"] as? String ?: "",
                        lat = (locationMap["lat"] as? Number)?.toDouble() ?: 0.0,
                        lng = (locationMap["lng"] as? Number)?.toDouble() ?: 0.0,
                        address = locationMap["address"] as? String ?: ""
                    )
                } catch (e: Exception) {
                    Log.e(TAG, "‚ùå Error parsing location: ${e.message}")
                    null
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Error getting locations from Firestore: ${e.message}")
            emptyList()
        }
    }

    /**
     * üíæ Firestore'a konum ekle
     */
    suspend fun addLocation(location: SavedLocation): Result<Unit> {
        return try {
            val user = auth.currentUser ?: return Result.failure(Exception("Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü"))

            // √ñnce mevcut konumlarƒ± al
            val currentLocations = getLocations()

            // Max limit kontrol√º
            if (currentLocations.size >= MAX_LOCATIONS) {
                return Result.failure(Exception("En fazla $MAX_LOCATIONS konum kaydedebilirsiniz"))
            }

            val locationMap = mapOf(
                "id" to location.id,
                "name" to location.name,
                "lat" to location.lat,
                "lng" to location.lng,
                "address" to location.address
            )

            db.collection(USERS_COLLECTION)
                .document(user.uid)
                .update(LOCATIONS_FIELD, FieldValue.arrayUnion(locationMap))
                .await()

            Log.d(TAG, "‚úÖ Location added to Firestore: ${location.name}")
            Result.success(Unit)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Error adding location to Firestore: ${e.message}")
            Result.failure(e)
        }
    }

    /**
     * üóëÔ∏è Firestore'dan konum sil
     */
    suspend fun removeLocation(locationId: String): Result<Unit> {
        return try {
            val user = auth.currentUser ?: return Result.failure(Exception("Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü"))

            // √ñnce t√ºm konumlarƒ± al
            val allLocations = getLocations()

            // Silinecek konumu bul
            val locationToRemove = allLocations.find { it.id == locationId }
                ?: return Result.failure(Exception("Konum bulunamadƒ±"))

            val locationMap = mapOf(
                "id" to locationToRemove.id,
                "name" to locationToRemove.name,
                "lat" to locationToRemove.lat,
                "lng" to locationToRemove.lng,
                "address" to locationToRemove.address
            )

            db.collection(USERS_COLLECTION)
                .document(user.uid)
                .update(LOCATIONS_FIELD, FieldValue.arrayRemove(locationMap))
                .await()

            Log.d(TAG, "‚úÖ Location removed from Firestore: ${locationToRemove.name}")
            Result.success(Unit)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Error removing location from Firestore: ${e.message}")
            Result.failure(e)
        }
    }

    /**
     * üßπ T√ºm konumlarƒ± sil
     */
    suspend fun clearAllLocations(): Result<Unit> {
        return try {
            val user = auth.currentUser ?: return Result.failure(Exception("Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü"))

            db.collection(USERS_COLLECTION)
                .document(user.uid)
                .update(LOCATIONS_FIELD, emptyList<Map<String, Any>>())
                .await()

            Log.d(TAG, "‚úÖ All locations cleared from Firestore")
            Result.success(Unit)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Error clearing locations from Firestore: ${e.message}")
            Result.failure(e)
        }
    }

    /**
     * üîÑ Local SharedPreferences'dan Firestore'a migrate et
     *
     * ƒ∞lk kullanƒ±mda eski local konumlarƒ± Firestore'a ta≈üƒ±r
     */
    suspend fun migrateLocalLocationsToFirestore(context: Context): Result<Unit> {
        return try {
            val user = auth.currentUser ?: return Result.failure(Exception("Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü"))

            // Local konumlarƒ± al
            val localLocations = LocationPreferences.getLocations(context)

            if (localLocations.isEmpty()) {
                Log.d(TAG, "‚ÑπÔ∏è No local locations to migrate")
                return Result.success(Unit)
            }

            // Firestore'daki mevcut konumlarƒ± kontrol et
            val firestoreLocations = getLocations()

            if (firestoreLocations.isNotEmpty()) {
                Log.d(TAG, "‚ÑπÔ∏è Firestore already has locations, skipping migration")
                return Result.success(Unit)
            }

            // Local konumlarƒ± Firestore'a aktar
            val locationMaps = localLocations.map { location ->
                mapOf(
                    "id" to location.id,
                    "name" to location.name,
                    "lat" to location.lat,
                    "lng" to location.lng,
                    "address" to location.address
                )
            }

            db.collection(USERS_COLLECTION)
                .document(user.uid)
                .update(LOCATIONS_FIELD, locationMaps)
                .await()

            Log.d(TAG, "‚úÖ Successfully migrated ${localLocations.size} locations to Firestore")

            // Migration ba≈üarƒ±lƒ± olursa local konumlarƒ± temizle
            LocationPreferences.clearAllLocations(context)
            Log.d(TAG, "‚úÖ Local locations cleared after successful migration")

            Result.success(Unit)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Error migrating locations to Firestore: ${e.message}")
            Result.failure(e)
        }
    }
}

// ============================================================================
// FILE: MedicationLogRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/repository/MedicationLogRepository.kt
// [31 of 122]
// ============================================================================

package com.bardino.dozi.core.data.repository

import android.content.Context
import android.util.Log
import com.bardino.dozi.core.data.local.DoziDatabase
import com.bardino.dozi.core.data.local.entity.MedicationLogEntity
import com.bardino.dozi.core.data.local.entity.SyncQueueEntity
import com.bardino.dozi.core.data.local.entity.SyncActionType
import com.bardino.dozi.core.data.model.*
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.firestore.Query
import com.google.firebase.Timestamp
import com.google.gson.Gson
import kotlinx.coroutines.channels.awaitClose
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.callbackFlow
import kotlinx.coroutines.tasks.await
import java.text.SimpleDateFormat
import java.time.LocalDate
import java.time.ZoneId
import java.util.*

/**
 * ƒ∞la√ß alma ge√ßmi≈üini y√∂neten repository (Offline-first with Room DB)
 */
class MedicationLogRepository(
    private val context: Context,
    private val auth: FirebaseAuth = FirebaseAuth.getInstance(),
    private val db: FirebaseFirestore = FirebaseFirestore.getInstance()
) {

    private val localDb = DoziDatabase.getDatabase(context)
    private val medicationLogDao = localDb.medicationLogDao()
    private val syncQueueDao = localDb.syncQueueDao()
    private val gson = Gson()

    private val currentUserId: String?
        get() = auth.currentUser?.uid

    companion object {
        private const val TAG = "MedicationLogRepository"
    }

    /**
     * ƒ∞la√ß log'u olu≈ütur (Offline-first)
     * 1. Room DB'ye kaydet (hemen)
     * 2. Sync queue'ya ekle
     * 3. Firestore'a sync et (online ise)
     */
    suspend fun createMedicationLog(log: MedicationLog): Result<String> {
        val userId = currentUserId ?: return Result.failure(Exception("User not logged in"))

        return try {
            val logId = UUID.randomUUID().toString()
            val now = System.currentTimeMillis()

            // 1. ‚úÖ Save to Room DB immediately (offline support)
            val entity = MedicationLogEntity(
                id = logId,
                userId = userId,
                medicineId = log.medicineId,
                medicineName = log.medicineName,
                dosage = log.dosage,
                scheduledTime = log.scheduledTime?.toDate()?.time ?: now,
                takenAt = log.takenAt?.toDate()?.time,
                status = log.status.name,
                notes = log.notes,
                sideEffects = gson.toJson(log.sideEffects),
                mood = log.mood,
                locationLat = log.location?.latitude,
                locationLng = log.location?.longitude,
                createdAt = now,
                updatedAt = now,
                isSynced = false
            )
            medicationLogDao.insert(entity)

            // 2. ‚úÖ Queue for Firestore sync
            val syncData = mapOf(
                "logId" to logId,
                "log" to gson.toJson(log.copy(id = logId, userId = userId))
            )
            queueForSync(SyncActionType.MEDICATION_TAKEN, syncData)

            // 3. ‚úÖ Try to sync immediately (if online)
            syncPendingLogs()

            Log.d(TAG, "‚úÖ Medication log created: $logId")
            Result.success(logId)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Error creating medication log", e)
            Result.failure(e)
        }
    }

    /**
     * Quick helpers for common actions (used by HomeScreen)
     */
    suspend fun logMedicationTaken(
        medicineId: String,
        medicineName: String,
        dosage: String,
        scheduledTime: Long,
        notes: String? = null
    ): Result<String> {
        val log = MedicationLog(
            medicineId = medicineId,
            medicineName = medicineName,
            dosage = dosage,
            scheduledTime = Timestamp(Date(scheduledTime)),
            takenAt = Timestamp(Date()),
            status = MedicationStatus.TAKEN,
            notes = notes
        )
        return createMedicationLog(log)
    }

    suspend fun logMedicationSkipped(
        medicineId: String,
        medicineName: String,
        dosage: String,
        scheduledTime: Long,
        reason: String? = null
    ): Result<String> {
        val log = MedicationLog(
            medicineId = medicineId,
            medicineName = medicineName,
            dosage = dosage,
            scheduledTime = Timestamp(Date(scheduledTime)),
            status = MedicationStatus.SKIPPED,
            notes = reason
        )
        return createMedicationLog(log)
    }

    suspend fun logMedicationMissed(
        medicineId: String,
        medicineName: String,
        dosage: String,
        scheduledTime: Long,
        reason: String? = null
    ): Result<String> {
        val log = MedicationLog(
            medicineId = medicineId,
            medicineName = medicineName,
            dosage = dosage,
            scheduledTime = Timestamp(Date(scheduledTime)),
            status = MedicationStatus.MISSED,
            notes = reason
        )
        return createMedicationLog(log)
    }

    suspend fun logMedicationSnoozed(
        medicineId: String,
        medicineName: String,
        dosage: String,
        scheduledTime: Long,
        snoozeMinutes: Int
    ): Result<String> {
        val log = MedicationLog(
            medicineId = medicineId,
            medicineName = medicineName,
            dosage = dosage,
            scheduledTime = Timestamp(Date(scheduledTime)),
            status = MedicationStatus.SNOOZED,
            notes = "Snoozed for $snoozeMinutes minutes"
        )
        return createMedicationLog(log)
    }

    /**
     * Queue action for Firestore sync
     */
    private suspend fun queueForSync(actionType: String, data: Map<String, Any?>) {
        try {
            val userId = currentUserId ?: return
            val action = SyncQueueEntity(
                actionType = actionType,
                dataJson = gson.toJson(data),
                userId = userId,
                retryCount = 0,
                createdAt = System.currentTimeMillis()
            )
            syncQueueDao.insert(action)
            Log.d(TAG, "üì• Queued for sync: $actionType")
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Error queuing for sync", e)
        }
    }

    /**
     * Sync pending logs to Firestore
     */
    suspend fun syncPendingLogs(): Int {
        val userId = currentUserId ?: return 0

        return try {
            val pendingActions = syncQueueDao.getPendingWithRetries(userId)
            var syncedCount = 0

            pendingActions.forEach { action ->
                try {
                    val data = gson.fromJson(action.dataJson, Map::class.java) as Map<String, Any?>
                    val logJson = data["log"] as? String
                    val logId = data["logId"] as? String

                    if (logJson != null && logId != null) {
                        val log = gson.fromJson(logJson, MedicationLog::class.java)

                        // Sync to Firestore
                        db.collection("medication_logs")
                            .document(logId)
                            .set(log)
                            .await()

                        // Mark as synced in Room
                        medicationLogDao.markAsSynced(logId)

                        // Remove from sync queue
                        syncQueueDao.deleteById(action.id)
                        syncedCount++

                        Log.d(TAG, "‚úÖ Synced: ${action.actionType}")
                    }
                } catch (e: Exception) {
                    Log.e(TAG, "‚ùå Sync failed for action ${action.id}", e)
                    syncQueueDao.incrementRetryCount(
                        action.id,
                        System.currentTimeMillis(),
                        e.message
                    )
                }
            }

            Log.d(TAG, "üîÑ Synced $syncedCount / ${pendingActions.size} logs to Firestore")
            syncedCount
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Error syncing pending logs", e)
            0
        }
    }

    /**
     * Get unsynced logs count
     */
    suspend fun getUnsyncedCount(): Int {
        val userId = currentUserId ?: return 0
        return syncQueueDao.getPendingCount(userId)
    }

    /**
     * ƒ∞la√ß log'unu g√ºncelle
     */
    suspend fun updateMedicationLog(logId: String, updates: Map<String, Any>): Result<Unit> {
        return try {
            db.collection("medication_logs")
                .document(logId)
                .update(updates)
                .await()
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    /**
     * ƒ∞la√ß durumunu g√ºncelle (Alƒ±ndƒ±, Atlandƒ±, vb.)
     */
    suspend fun updateMedicationStatus(
        logId: String,
        status: MedicationStatus,
        takenAt: Timestamp? = null
    ): Result<Unit> {
        return try {
            val updates = mutableMapOf<String, Any>(
                "status" to status.name,
                "updatedAt" to com.google.firebase.firestore.FieldValue.serverTimestamp()
            )

            if (takenAt != null) {
                updates["takenAt"] = takenAt
            }

            db.collection("medication_logs")
                .document(logId)
                .update(updates)
                .await()
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    /**
     * Kullanƒ±cƒ±nƒ±n t√ºm ila√ß ge√ßmi≈üini real-time dinle
     */
    fun getMedicationLogsFlow(): Flow<List<MedicationLog>> = callbackFlow {
        val userId = currentUserId ?: run {
            close()
            return@callbackFlow
        }

        val listener = db.collection("medication_logs")
            .whereEqualTo("userId", userId)
            .orderBy("scheduledTime", Query.Direction.DESCENDING)
            .limit(100)
            .addSnapshotListener { snapshot, error ->
                if (error != null) {
                    close(error)
                    return@addSnapshotListener
                }

                val logs = snapshot?.documents?.mapNotNull { doc ->
                    doc.toObject(MedicationLog::class.java)?.copy(id = doc.id)
                } ?: emptyList()

                trySend(logs)
            }

        awaitClose { listener.remove() }
    }

    /**
     * Belirli bir tarih aralƒ±ƒüƒ±ndaki ila√ß ge√ßmi≈üini getir
     */
    suspend fun getMedicationLogsByDateRange(
        startDate: Timestamp,
        endDate: Timestamp
    ): List<MedicationLog> {
        val userId = currentUserId ?: return emptyList()

        return try {
            val snapshot = db.collection("medication_logs")
                .whereEqualTo("userId", userId)
                .whereGreaterThanOrEqualTo("scheduledTime", startDate)
                .whereLessThanOrEqualTo("scheduledTime", endDate)
                .orderBy("scheduledTime", Query.Direction.DESCENDING)
                .get()
                .await()

            snapshot.documents.mapNotNull { doc ->
                doc.toObject(MedicationLog::class.java)?.copy(id = doc.id)
            }
        } catch (e: Exception) {
            emptyList()
        }
    }

    /**
     * Belirli bir LocalDate i√ßin ila√ß loglarƒ±nƒ± getir
     */
    suspend fun getMedicationLogsForDate(date: LocalDate): List<MedicationLog> {
        val startOfDay = date.atStartOfDay(ZoneId.systemDefault())
        val endOfDay = date.plusDays(1).atStartOfDay(ZoneId.systemDefault())

        val startTimestamp = Timestamp(Date.from(startOfDay.toInstant()))
        val endTimestamp = Timestamp(Date.from(endOfDay.toInstant()))

        return getMedicationLogsByDateRange(startTimestamp, endTimestamp)
    }

    /**
     * üî• Belirli bir ila√ß i√ßin belirli bir zamanda log var mƒ± kontrol et
     * Escalation handler'larƒ± i√ßin kullanƒ±lƒ±r (duplicate bildirim √∂nleme)
     *
     * TAKEN, SKIPPED veya SNOOZED durumlarƒ±ndan biri varsa true d√∂ner
     */
    suspend fun isMedicationLoggedForTime(
        medicineId: String,
        scheduledTime: Long
    ): Boolean {
        val userId = currentUserId ?: return false

        return try {
            // 1. √ñnce Room DB'yi kontrol et (hƒ±zlƒ±, offline)
            val localLog = medicationLogDao.getLogForMedicineAndTime(
                medicineId = medicineId,
                scheduledTime = scheduledTime,
                userId = userId
            )

            if (localLog != null && localLog.status in listOf("TAKEN", "SKIPPED", "SNOOZED")) {
                Log.d(TAG, "‚úÖ Local DB'de log bulundu: $medicineId - ${localLog.status}")
                return true
            }

            // 2. Firestore'u kontrol et (online)
            // scheduledTime ¬±5 dakika toleransla kontrol et
            val tolerance = 5 * 60 * 1000 // 5 dakika
            val startTime = Timestamp(Date(scheduledTime - tolerance))
            val endTime = Timestamp(Date(scheduledTime + tolerance))

            val snapshot = db.collection("medication_logs")
                .whereEqualTo("userId", userId)
                .whereEqualTo("medicineId", medicineId)
                .whereGreaterThanOrEqualTo("scheduledTime", startTime)
                .whereLessThanOrEqualTo("scheduledTime", endTime)
                .get()
                .await()

            val hasLog = snapshot.documents.any { doc ->
                val status = doc.getString("status")
                status in listOf("TAKEN", "SKIPPED", "SNOOZED")
            }

            if (hasLog) {
                Log.d(TAG, "‚úÖ Firestore'da log bulundu: $medicineId")
            }

            hasLog
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå isMedicationLoggedForTime hatasƒ±", e)
            // Hata durumunda false d√∂n (bildirim g√∂sterilsin)
            false
        }
    }

    /**
     * Bug√ºnk√º ila√ß ge√ßmi≈üini getir
     */
    suspend fun getTodayMedicationLogs(): DailyMedicationLogs {
        val today = Calendar.getInstance().apply {
            set(Calendar.HOUR_OF_DAY, 0)
            set(Calendar.MINUTE, 0)
            set(Calendar.SECOND, 0)
            set(Calendar.MILLISECOND, 0)
        }

        val tomorrow = Calendar.getInstance().apply {
            timeInMillis = today.timeInMillis
            add(Calendar.DAY_OF_YEAR, 1)
        }

        val logs = getMedicationLogsByDateRange(
            Timestamp(today.time),
            Timestamp(tomorrow.time)
        )

        return DailyMedicationLogs(
            date = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault()).format(today.time),
            logs = logs,
            takenCount = logs.count { it.status == MedicationStatus.TAKEN },
            missedCount = logs.count { it.status == MedicationStatus.MISSED },
            skippedCount = logs.count { it.status == MedicationStatus.SKIPPED },
            totalCount = logs.size
        )
    }

    /**
     * Son 7 g√ºnl√ºk ila√ß ge√ßmi≈üini getir
     */
    suspend fun getWeeklyMedicationLogs(): List<DailyMedicationLogs> {
        val result = mutableListOf<DailyMedicationLogs>()

        for (i in 0..6) {
            val day = Calendar.getInstance().apply {
                add(Calendar.DAY_OF_YEAR, -i)
                set(Calendar.HOUR_OF_DAY, 0)
                set(Calendar.MINUTE, 0)
                set(Calendar.SECOND, 0)
                set(Calendar.MILLISECOND, 0)
            }

            val nextDay = Calendar.getInstance().apply {
                timeInMillis = day.timeInMillis
                add(Calendar.DAY_OF_YEAR, 1)
            }

            val logs = getMedicationLogsByDateRange(
                Timestamp(day.time),
                Timestamp(nextDay.time)
            )

            result.add(
                DailyMedicationLogs(
                    date = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault()).format(day.time),
                    logs = logs,
                    takenCount = logs.count { it.status == MedicationStatus.TAKEN },
                    missedCount = logs.count { it.status == MedicationStatus.MISSED },
                    skippedCount = logs.count { it.status == MedicationStatus.SKIPPED },
                    totalCount = logs.size
                )
            )
        }

        return result
    }

    /**
     * Belirli bir ila√ß i√ßin ge√ßmi≈üi getir
     */
    suspend fun getMedicationLogsByMedicineId(medicineId: String): List<MedicationLog> {
        val userId = currentUserId ?: return emptyList()

        return try {
            val snapshot = db.collection("medication_logs")
                .whereEqualTo("userId", userId)
                .whereEqualTo("medicineId", medicineId)
                .orderBy("scheduledTime", Query.Direction.DESCENDING)
                .limit(50)
                .get()
                .await()

            snapshot.documents.mapNotNull { doc ->
                doc.toObject(MedicationLog::class.java)?.copy(id = doc.id)
            }
        } catch (e: Exception) {
            emptyList()
        }
    }

    /**
     * Belirli bir ila√ß i√ßin belirli bir zamandan sonraki loglarƒ± getir
     * EscalationManager ve SmartReminderHelper tarafƒ±ndan kullanƒ±lƒ±r
     */
    suspend fun getLogsForMedicine(medicineId: String, startTime: Long): List<MedicationLog> {
        val userId = currentUserId ?: return emptyList()

        return try {
            val startTimestamp = Timestamp(Date(startTime))

            val snapshot = db.collection("medication_logs")
                .whereEqualTo("userId", userId)
                .whereEqualTo("medicineId", medicineId)
                .whereGreaterThanOrEqualTo("scheduledTime", startTimestamp)
                .orderBy("scheduledTime", Query.Direction.DESCENDING)
                .get()
                .await()

            snapshot.documents.mapNotNull { doc ->
                doc.toObject(MedicationLog::class.java)?.copy(id = doc.id)
            }
        } catch (e: Exception) {
            Log.e(TAG, "Error getting logs for medicine $medicineId from $startTime", e)
            emptyList()
        }
    }

    /**
     * Badinin ila√ß ge√ßmi≈üini getir (buddy permission kontrol√º yapƒ±lmalƒ±)
     */
    suspend fun getBuddyMedicationLogs(buddyUserId: String): List<MedicationLog> {
        return try {
            val snapshot = db.collection("medication_logs")
                .whereEqualTo("userId", buddyUserId)
                .orderBy("scheduledTime", Query.Direction.DESCENDING)
                .limit(100)
                .get()
                .await()

            snapshot.documents.mapNotNull { doc ->
                doc.toObject(MedicationLog::class.java)?.copy(id = doc.id)
            }
        } catch (e: Exception) {
            emptyList()
        }
    }

    /**
     * ƒ∞la√ß alma istatistikleri
     */
    suspend fun getMedicationStats(days: Int = 30): MedicationStats {
        val userId = currentUserId ?: return MedicationStats()

        val startDate = Calendar.getInstance().apply {
            add(Calendar.DAY_OF_YEAR, -days)
        }

        val logs = getMedicationLogsByDateRange(
            Timestamp(startDate.time),
            Timestamp(Date())
        )

        val takenCount = logs.count { it.status == MedicationStatus.TAKEN }
        val missedCount = logs.count { it.status == MedicationStatus.MISSED }
        val skippedCount = logs.count { it.status == MedicationStatus.SKIPPED }
        val totalCount = logs.size

        return MedicationStats(
            totalCount = totalCount,
            takenCount = takenCount,
            missedCount = missedCount,
            skippedCount = skippedCount,
            adherenceRate = if (totalCount > 0) takenCount.toFloat() / totalCount else 0f
        )
    }
}

/**
 * ƒ∞la√ß alma istatistikleri
 */
data class MedicationStats(
    val totalCount: Int = 0,
    val takenCount: Int = 0,
    val missedCount: Int = 0,
    val skippedCount: Int = 0,
    val adherenceRate: Float = 0f // 0.0 - 1.0 arasƒ± (uyum oranƒ±)
)

// ============================================================================
// FILE: MedicineRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/repository/MedicineRepository.kt
// [32 of 122]
// ============================================================================

package com.bardino.dozi.core.data.repository

import android.content.Context
import android.os.Build
import android.util.Log
import androidx.annotation.RequiresApi
import com.bardino.dozi.core.data.model.Medicine
import com.bardino.dozi.core.sync.SyncManager
import com.bardino.dozi.core.sync.SyncWorker
import com.bardino.dozi.core.utils.NetworkUtils
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.firestore.Query
import kotlinx.coroutines.tasks.await
import kotlinx.coroutines.channels.awaitClose
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.callbackFlow
import kotlinx.coroutines.flow.flowOf
import javax.inject.Inject
import javax.inject.Singleton

/**
 * Repository for managing Medicine data in Firestore
 * All medicines are stored under: /users/{userId}/medicines/{medicineId}
 */
@Singleton
class MedicineRepository @Inject constructor() {
    private val auth = FirebaseAuth.getInstance()
    private val db = FirebaseFirestore.getInstance()

    /**
     * Get current user's medicine collection reference
     */
    private fun getMedicinesCollection() = auth.currentUser?.let { user ->
        db.collection("users").document(user.uid).collection("medicines")
    }

    /**
     * Get all medicines for current user
     */
    suspend fun getAllMedicines(): List<Medicine> {
        val collection = getMedicinesCollection() ?: return emptyList()

        return try {
            val snapshot = collection
                .orderBy("createdAt", Query.Direction.DESCENDING)
                .get()
                .await()

            snapshot.documents.mapNotNull { it.toObject(Medicine::class.java) }
        } catch (e: Exception) {
            android.util.Log.e("MedicineRepository", "‚ùå Error getting medicines: ${e.message}")
            emptyList()
        }
    }

    /**
     * Get medicines with real-time updates
     */
    fun getMedicinesFlow(): Flow<List<Medicine>> {
        val collection = getMedicinesCollection()
        if (collection == null) {
            return flowOf(emptyList())
        }

        return callbackFlow {
            val listener = collection
                .orderBy("createdAt", Query.Direction.DESCENDING)
                .addSnapshotListener { snapshot, error ->
                    if (error != null) {
                        android.util.Log.e("MedicineRepository", "Error listening to medicines: ${error.message}")
                        trySend(emptyList())
                        return@addSnapshotListener
                    }

                    val medicines = snapshot?.documents?.mapNotNull {
                        it.toObject(Medicine::class.java)
                    } ?: emptyList()

                    android.util.Log.d("MedicineRepository", "‚úÖ Loaded ${medicines.size} medicines")
                    trySend(medicines)
                }

            awaitClose { listener.remove() }
        }
    }

    /**
     * Get medicines for today's schedule
     */
    @RequiresApi(Build.VERSION_CODES.O)
    suspend fun getTodaysMedicines(): List<Medicine> {
        val allMedicines = getAllMedicines()
        val today = System.currentTimeMillis()
        val todayDateString = getCurrentDateString() // "dd/MM/yyyy" format

        return allMedicines.filter { medicine ->
            // Check if medicine is active today
            val isActive = medicine.startDate <= today &&
                          (medicine.endDate == null || medicine.endDate >= today)

            if (!isActive || !medicine.reminderEnabled) return@filter false

            // Check frequency-based schedule
            when (medicine.frequency) {
                "Her g√ºn" -> true

                "G√ºn a≈üƒ±rƒ±" -> {
                    // Ba≈ülangƒ±√ßtan bug√ºne ka√ß g√ºn ge√ßti?
                    val daysSinceStart = getDaysBetween(medicine.startDate, today)
                    (daysSinceStart % 2).toInt() == 0 // √áift g√ºnlerde al (0, 2, 4, ...)
                }

                "Haftada bir" -> {
                    // Ba≈ülangƒ±√ß tarihinin haftanƒ±n g√ºn√º ile aynƒ± g√ºnlerde al
                    val startCal = java.util.Calendar.getInstance().apply { timeInMillis = medicine.startDate }
                    val todayCal = java.util.Calendar.getInstance().apply { timeInMillis = today }
                    startCal.get(java.util.Calendar.DAY_OF_WEEK) == todayCal.get(java.util.Calendar.DAY_OF_WEEK)
                }

                "15 g√ºnde bir" -> {
                    val daysSinceStart = getDaysBetween(medicine.startDate, today)
                    (daysSinceStart % 15).toInt() == 0
                }

                "Ayda bir" -> {
                    val daysSinceStart = getDaysBetween(medicine.startDate, today)
                    (daysSinceStart % 30).toInt() == 0
                }

                "Her X g√ºnde bir" -> {
                    val daysSinceStart = getDaysBetween(medicine.startDate, today)
                    (daysSinceStart % medicine.frequencyValue).toInt() == 0
                }

                "ƒ∞stediƒüim tarihlerde" -> {
                    // Se√ßilen tarihler listesinde bug√ºn var mƒ±?
                    medicine.days.contains(todayDateString)
                }

                else -> {
                    // Eski sistem ile uyumluluk: days listesine bak
                    medicine.days.isEmpty() || medicine.days.contains(getCurrentDayName())
                }
            }
        }
    }

    /**
     * Helper: Calculate days between two timestamps
     */
    private fun getDaysBetween(startMillis: Long, endMillis: Long): Long {
        val millisecondsPerDay = 24 * 60 * 60 * 1000
        return (endMillis - startMillis) / millisecondsPerDay
    }

    /**
     * Helper: Get current date in dd/MM/yyyy format
     */
    private fun getCurrentDateString(): String {
        val calendar = java.util.Calendar.getInstance()
        val day = calendar.get(java.util.Calendar.DAY_OF_MONTH)
        val month = calendar.get(java.util.Calendar.MONTH) + 1
        val year = calendar.get(java.util.Calendar.YEAR)
        return "%02d/%02d/%d".format(day, month, year)
    }

    /**
     * Get a single medicine by ID
     */
    suspend fun getMedicine(medicineId: String): Medicine? {
        android.util.Log.d("MedicineRepository", "getMedicine called with ID: $medicineId")

        val collection = getMedicinesCollection()
        if (collection == null) {
            android.util.Log.e("MedicineRepository", "getMedicine: User not authenticated!")
            return null
        }

        return try {
            android.util.Log.d("MedicineRepository", "Fetching medicine from Firestore...")
            val doc = collection.document(medicineId).get().await()

            if (!doc.exists()) {
                android.util.Log.w("MedicineRepository", "Medicine document does not exist: $medicineId")
                return null
            }

            val medicine = doc.toObject(Medicine::class.java)
            android.util.Log.d("MedicineRepository", "Medicine fetched successfully: ${medicine?.name}")
            medicine
        } catch (e: Exception) {
            android.util.Log.e("MedicineRepository", "Error fetching medicine: $medicineId", e)
            null
        }
    }

    /**
     * Get a single medicine by ID (alias for compatibility)
     */
    suspend fun getMedicineById(medicineId: String): Medicine? {
        return getMedicine(medicineId)
    }

    /**
     * Add a new medicine
     * Uses offline-first approach: saves to Firestore if online, queues if offline
     */
    suspend fun addMedicine(medicine: Medicine, context: Context? = null): Medicine? {
        val collection = getMedicinesCollection() ?: return null
        val user = auth.currentUser ?: return null

        val medicineWithUser = medicine.copy(
            userId = user.uid,
            id = if (medicine.id.isEmpty()) collection.document().id else medicine.id,
            createdAt = System.currentTimeMillis(),
            updatedAt = System.currentTimeMillis()
        )

        // Try direct Firestore write if online
        if (context != null && NetworkUtils.isNetworkAvailable(context)) {
            return try {
                collection.document(medicineWithUser.id).set(medicineWithUser).await()
                Log.d("MedicineRepository", "‚úÖ Medicine added directly to Firestore: ${medicineWithUser.id}")
                medicineWithUser
            } catch (e: Exception) {
                Log.w("MedicineRepository", "‚ö†Ô∏è Firestore write failed, queueing for sync", e)
                // Queue for later sync
                val syncManager = SyncManager(context)
                syncManager.queueMedicineAdd(medicineWithUser)
                SyncWorker.requestImmediateSync(context)
                medicineWithUser
            }
        } else if (context != null) {
            // Offline - queue for sync
            Log.d("MedicineRepository", "üì• Offline - queueing medicine add: ${medicineWithUser.id}")
            val syncManager = SyncManager(context)
            syncManager.queueMedicineAdd(medicineWithUser)
            SyncWorker.requestImmediateSync(context)
            return medicineWithUser
        } else {
            // No context - fall back to direct write (legacy behavior)
            return try {
                collection.document(medicineWithUser.id).set(medicineWithUser).await()
                Log.d("MedicineRepository", "‚úÖ Medicine added: ${medicineWithUser.id}")
                medicineWithUser
            } catch (e: Exception) {
                Log.e("MedicineRepository", "‚ùå Error adding medicine", e)
                null
            }
        }
    }

    /**
     * Update an existing medicine
     * Uses offline-first approach: saves to Firestore if online, queues if offline
     */
    suspend fun updateMedicine(medicine: Medicine, context: Context? = null): Boolean {
        val collection = getMedicinesCollection() ?: return false

        val updatedMedicine = medicine.copy(
            updatedAt = System.currentTimeMillis()
        )

        // Try direct Firestore write if online
        if (context != null && NetworkUtils.isNetworkAvailable(context)) {
            return try {
                collection.document(medicine.id).set(updatedMedicine).await()
                Log.d("MedicineRepository", "‚úÖ Medicine updated directly in Firestore: ${medicine.id}")
                true
            } catch (e: Exception) {
                Log.w("MedicineRepository", "‚ö†Ô∏è Firestore update failed, queueing for sync", e)
                // Queue for later sync
                val syncManager = SyncManager(context)
                syncManager.queueMedicineUpdate(updatedMedicine)
                SyncWorker.requestImmediateSync(context)
                true // Return true since we've queued the update
            }
        } else if (context != null) {
            // Offline - queue for sync
            Log.d("MedicineRepository", "üì• Offline - queueing medicine update: ${medicine.id}")
            val syncManager = SyncManager(context)
            syncManager.queueMedicineUpdate(updatedMedicine)
            SyncWorker.requestImmediateSync(context)
            return true
        } else {
            // No context - fall back to direct write (legacy behavior)
            return try {
                collection.document(medicine.id).set(updatedMedicine).await()
                true
            } catch (e: Exception) {
                false
            }
        }
    }

    /**
     * Update a specific field of a medicine
     */
    suspend fun updateMedicineField(medicineId: String, field: String, value: Any): Boolean {
        val collection = getMedicinesCollection() ?: return false
        return try {
            collection.document(medicineId).update(
                mapOf(
                    field to value,
                    "updatedAt" to System.currentTimeMillis()
                )
            ).await()
            true
        } catch (e: Exception) {
            false
        }
    }

    /**
     * Delete a medicine
     * Uses offline-first approach: deletes from Firestore if online, queues if offline
     */
    suspend fun deleteMedicine(medicineId: String, context: Context? = null): Boolean {
        val collection = getMedicinesCollection() ?: return false

        // Try direct Firestore delete if online
        if (context != null && NetworkUtils.isNetworkAvailable(context)) {
            return try {
                collection.document(medicineId).delete().await()
                Log.d("MedicineRepository", "‚úÖ Medicine deleted from Firestore: $medicineId")
                true
            } catch (e: Exception) {
                Log.w("MedicineRepository", "‚ö†Ô∏è Firestore delete failed, queueing for sync", e)
                // Queue for later sync
                val syncManager = SyncManager(context)
                syncManager.queueMedicineDelete(medicineId)
                SyncWorker.requestImmediateSync(context)
                true // Return true since we've queued the delete
            }
        } else if (context != null) {
            // Offline - queue for sync
            Log.d("MedicineRepository", "üì• Offline - queueing medicine delete: $medicineId")
            val syncManager = SyncManager(context)
            syncManager.queueMedicineDelete(medicineId)
            SyncWorker.requestImmediateSync(context)
            return true
        } else {
            // No context - fall back to direct write (legacy behavior)
            return try {
                collection.document(medicineId).delete().await()
                true
            } catch (e: Exception) {
                false
            }
        }
    }

    /**
     * Get medicine count for user
     */
    suspend fun getMedicineCount(): Int {
        return getAllMedicines().size
    }

    /**
     * Get upcoming medicines (rest of today) - excludes taken/skipped
     */
    @RequiresApi(Build.VERSION_CODES.O)
    suspend fun getUpcomingMedicines(context: android.content.Context): List<Pair<Medicine, String>> {
        val todaysMedicines = getTodaysMedicines()
        val currentHour = java.time.LocalTime.now().hour
        val currentMinute = java.time.LocalTime.now().minute
        val today = getCurrentDateString()

        val upcoming = mutableListOf<Pair<Medicine, String>>()

        todaysMedicines.forEach { medicine ->
            medicine.times.forEach { time ->
                val (hour, minute) = time.split(":").map { it.toInt() }
                val medicineTime = hour * 60 + minute
                val currentTime = currentHour * 60 + currentMinute

                // Bug√ºn√ºn geri kalan t√ºm ila√ßlarƒ±
                if (medicineTime >= currentTime) {
                    // Status kontrol√º yap
                    val status = getMedicineStatus(context, medicine.id, today, time)
                    // Sadece alƒ±nmamƒ±≈ü veya atlanmamƒ±≈ü ila√ßlarƒ± ekle
                    if (status != "taken" && status != "skipped") {
                        upcoming.add(Pair(medicine, time))
                    }
                }
            }
        }

        return upcoming.sortedBy { it.second }
    }

    /**
     * Helper: Get medicine status from SharedPreferences
     */
    private fun getMedicineStatus(context: android.content.Context, medicineId: String, date: String, time: String): String? {
        val prefs = context.getSharedPreferences("medicine_status", android.content.Context.MODE_PRIVATE)
        val key = "dose_${medicineId}_${date}_${time}"
        return prefs.getString(key, null)
    }

    /**
     * Helper: Get current day name in Turkish
     */
    @RequiresApi(Build.VERSION_CODES.O)
    private fun getCurrentDayName(): String {
        val dayOfWeek = java.time.LocalDate.now().dayOfWeek.value
        return when (dayOfWeek) {
            1 -> "Pazartesi"
            2 -> "Salƒ±"
            3 -> "√áar≈üamba"
            4 -> "Per≈üembe"
            5 -> "Cuma"
            6 -> "Cumartesi"
            7 -> "Pazar"
            else -> ""
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üìè PLAN Lƒ∞Mƒ∞T KONTROL METODLARƒ∞
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * Toplam aktif time slot sayƒ±sƒ±nƒ± hesapla
     * Her ilacƒ±n her hatƒ±rlatma saati 1 slot olarak sayƒ±lƒ±r
     */
    suspend fun getActiveTimeSlotCount(): Int {
        val medicines = getAllMedicines()
        return medicines
            .filter { it.reminderEnabled }
            .sumOf { it.times.size }
    }

    /**
     * Belirli bir ila√ß hari√ß time slot sayƒ±sƒ±nƒ± hesapla
     * (D√ºzenleme modunda mevcut ilacƒ±n slotlarƒ±nƒ± √ßƒ±karmak i√ßin)
     */
    suspend fun getActiveTimeSlotCountExcluding(medicineId: String): Int {
        val medicines = getAllMedicines()
        return medicines
            .filter { it.reminderEnabled && it.id != medicineId }
            .sumOf { it.times.size }
    }

    /**
     * Yeni time slotlar eklenebilir mi kontrol et
     * @param newSlotCount Eklenmek istenen slot sayƒ±sƒ±
     * @param excludeMedicineId D√ºzenleme modunda mevcut ilacƒ±n ID'si (null ise yeni ekleme)
     * @param limit Maksimum izin verilen slot sayƒ±sƒ± (-1 = sƒ±nƒ±rsƒ±z)
     */
    suspend fun canAddTimeSlots(newSlotCount: Int, excludeMedicineId: String? = null, limit: Int): Boolean {
        if (limit == -1) return true // Sƒ±nƒ±rsƒ±z

        val currentCount = if (excludeMedicineId != null) {
            getActiveTimeSlotCountExcluding(excludeMedicineId)
        } else {
            getActiveTimeSlotCount()
        }

        return (currentCount + newSlotCount) <= limit
    }

    /**
     * Yeni ila√ß eklenebilir mi kontrol et
     * @param limit Maksimum izin verilen ila√ß sayƒ±sƒ± (-1 = sƒ±nƒ±rsƒ±z)
     */
    suspend fun canAddMedicine(limit: Int): Boolean {
        if (limit == -1) return true // Sƒ±nƒ±rsƒ±z
        return getMedicineCount() < limit
    }
}

// ============================================================================
// FILE: NotificationRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/repository/NotificationRepository.kt
// [33 of 122]
// ============================================================================

package com.bardino.dozi.core.data.repository

import android.Manifest
import android.content.Context
import android.content.pm.PackageManager
import androidx.core.content.ContextCompat
import com.bardino.dozi.core.data.model.*
import com.bardino.dozi.notifications.NotificationHelper
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FieldValue
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.firestore.Query
import com.google.firebase.functions.FirebaseFunctions
import com.google.firebase.messaging.FirebaseMessaging
import kotlinx.coroutines.channels.awaitClose
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.callbackFlow
import kotlinx.coroutines.tasks.await

/**
 * Bildirim sistemini y√∂neten repository
 */
class NotificationRepository(
    private val auth: FirebaseAuth = FirebaseAuth.getInstance(),
    private val db: FirebaseFirestore = FirebaseFirestore.getInstance(),
    private val functions: FirebaseFunctions = FirebaseFunctions.getInstance(),
    private val messaging: FirebaseMessaging = FirebaseMessaging.getInstance()
) {

    private val currentUserId: String?
        get() = auth.currentUser?.uid

    // ==================== FCM Token ƒ∞≈ülemleri ====================

    /**
     * FCM token'ƒ± al ve Firestore'a kaydet
     */
    suspend fun refreshFCMToken(): Result<String> {
        val userId = currentUserId ?: return Result.failure(Exception("User not logged in"))

        return try {
            val token = messaging.token.await()

            db.collection("users")
                .document(userId)
                .update("fcmToken", token)
                .await()

            Result.success(token)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    // ==================== Notification CRUD ====================

    /**
     * Bildirim olu≈ütur
     */
    suspend fun createNotification(notification: DoziNotification): Result<String> {
        return try {
            val docRef = db.collection("notifications").add(notification).await()
            Result.success(docRef.id)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    /**
     * Kullanƒ±cƒ±nƒ±n bildirimlerini real-time dinle
     */
    fun getNotificationsFlow(): Flow<List<DoziNotification>> = callbackFlow {
        val userId = currentUserId ?: run {
            close()
            return@callbackFlow
        }

        val listener = db.collection("notifications")
            .whereEqualTo("userId", userId)
            .orderBy("createdAt", Query.Direction.DESCENDING)
            .limit(50)
            .addSnapshotListener { snapshot, error ->
                if (error != null) {
                    close(error)
                    return@addSnapshotListener
                }

                val notifications = snapshot?.documents?.mapNotNull { doc ->
                    doc.toObject(DoziNotification::class.java)?.copy(id = doc.id)
                } ?: emptyList()

                trySend(notifications)
            }

        awaitClose { listener.remove() }
    }

    /**
     * Okunmamƒ±≈ü bildirim sayƒ±sƒ±nƒ± al
     */
    fun getUnreadCountFlow(): Flow<Int> = callbackFlow {
        val userId = currentUserId ?: run {
            close()
            return@callbackFlow
        }

        val listener = db.collection("notifications")
            .whereEqualTo("userId", userId)
            .whereEqualTo("isRead", false)
            .addSnapshotListener { snapshot, error ->
                if (error != null) {
                    close(error)
                    return@addSnapshotListener
                }

                trySend(snapshot?.size() ?: 0)
            }

        awaitClose { listener.remove() }
    }

    /**
     * Bildirimi okundu olarak i≈üaretle
     */
    suspend fun markAsRead(notificationId: String): Result<Unit> {
        return try {
            db.collection("notifications")
                .document(notificationId)
                .update(
                    mapOf(
                        "isRead" to true,
                        "readAt" to FieldValue.serverTimestamp()
                    )
                )
                .await()
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    /**
     * T√ºm bildirimleri okundu olarak i≈üaretle
     */
    suspend fun markAllAsRead(): Result<Unit> {
        val userId = currentUserId ?: return Result.failure(Exception("User not logged in"))

        return try {
            val snapshot = db.collection("notifications")
                .whereEqualTo("userId", userId)
                .whereEqualTo("isRead", false)
                .get()
                .await()

            val batch = db.batch()
            snapshot.documents.forEach { doc ->
                batch.update(
                    doc.reference,
                    mapOf(
                        "isRead" to true,
                        "readAt" to FieldValue.serverTimestamp()
                    )
                )
            }
            batch.commit().await()

            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    /**
     * Bildirimi sil
     */
    suspend fun deleteNotification(notificationId: String): Result<Unit> {
        return try {
            db.collection("notifications")
                .document(notificationId)
                .delete()
                .await()
            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    // ==================== Push Notification G√∂nderme ====================

    /**
     * ƒ∞la√ß hatƒ±rlatmasƒ± i√ßin badilere bildirim g√∂nder
     */
    suspend fun sendMedicationReminderToBadis(
        medicineId: String,
        medicineName: String,
        dosage: String,
        time: String
    ): Result<Int> {
        return try {
            val data = hashMapOf(
                "reminderId" to medicineId,
                "medicineName" to medicineName,
                "dosage" to dosage,
                "time" to time
            )

            val result = functions
                .getHttpsCallable("sendMedicationReminderToBadis")
                .call(data)
                .await()

            val sentCount = (result.data as? Map<*, *>)?.get("sentCount") as? Int ?: 0
            Result.success(sentCount)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    /**
     * Local notification g√∂ster (Android)
     */
    suspend fun showLocalNotification(
        context: Context,
        title: String,
        body: String,
        type: NotificationType = NotificationType.GENERAL
    ): Result<Unit> {
        return try {
            // Notification permission kontrol√º
            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.TIRAMISU) {
                if (ContextCompat.checkSelfPermission(
                        context,
                        Manifest.permission.POST_NOTIFICATIONS
                    ) != PackageManager.PERMISSION_GRANTED
                ) {
                    return Result.failure(Exception("Notification permission not granted"))
                }
            }

            // Bildirim g√∂ster
            when (type) {
                NotificationType.MEDICATION_REMINDER -> {
                    // √ñzel ila√ß hatƒ±rlatma bildirimi
                    NotificationHelper.showMedicationNotification(
                        context = context,
                        medicineName = title,
                        dosage = body
                    )
                }
                else -> {
                    // Genel bildirim (NotificationHelper'a eklenebilir)
                    NotificationHelper.showMedicationNotification(
                        context = context,
                        medicineName = title,
                        dosage = body
                    )
                }
            }

            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    // ==================== Bildirim ƒ∞statistikleri ====================

    /**
     * Bildirim istatistiklerini al
     */
    suspend fun getNotificationStats(): NotificationStats {
        val userId = currentUserId ?: return NotificationStats()

        return try {
            val snapshot = db.collection("notifications")
                .whereEqualTo("userId", userId)
                .get()
                .await()

            val notifications = snapshot.documents.mapNotNull {
                it.toObject(DoziNotification::class.java)
            }

            NotificationStats(
                totalCount = notifications.size,
                unreadCount = notifications.count { !it.isRead },
                buddyRequestCount = notifications.count { it.type == NotificationType.BADI_REQUEST },
                medicationReminderCount = notifications.count { it.type == NotificationType.MEDICATION_REMINDER }
            )
        } catch (e: Exception) {
            NotificationStats()
        }
    }
}

/**
 * Bildirim istatistikleri
 */
data class NotificationStats(
    val totalCount: Int = 0,
    val unreadCount: Int = 0,
    val buddyRequestCount: Int = 0,
    val medicationReminderCount: Int = 0
)

// ============================================================================
// FILE: PremiumRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/repository/PremiumRepository.kt
// [34 of 122]
// ============================================================================

package com.bardino.dozi.core.data.repository

import com.bardino.dozi.core.data.model.*
import com.bardino.dozi.core.premium.PremiumFields
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.firestore.ListenerRegistration
import kotlinx.coroutines.channels.awaitClose
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.callbackFlow
import kotlinx.coroutines.tasks.await
import java.util.Calendar
import javax.inject.Inject
import javax.inject.Singleton

/**
 * üåü Premium Repository
 *
 * Premium (Dozi Ekstra) ile ilgili t√ºm i≈ülemleri y√∂netir:
 * - Premium durumu kontrol√º
 * - Deneme s√ºr√ºm√º aktivasyonu
 * - Satƒ±n alma i≈ülemleri
 * - Real-time premium status updates
 */
@Singleton
class PremiumRepository @Inject constructor(
    private val firestore: FirebaseFirestore,
    private val auth: FirebaseAuth
) {
    companion object {
        private const val USERS_COLLECTION = "users"
        private const val PREMIUM_ANALYTICS_DOC = "premium_analytics"
        private const val DAILY_ANALYTICS_COLLECTION = "daily_analytics"
        private const val USER_BANS_COLLECTION = "user_bans"
    }

    /**
     * Real-time kullanƒ±cƒ± premium durumunu dinle
     */
    fun observePremiumStatus(): Flow<User?> = callbackFlow {
        val userId = auth.currentUser?.uid
        if (userId == null) {
            trySend(null)
            close()
            return@callbackFlow
        }

        val listener = firestore.collection(USERS_COLLECTION)
            .document(userId)
            .addSnapshotListener { snapshot, error ->
                if (error != null) {
                    close(error)
                    return@addSnapshotListener
                }

                val user = snapshot?.toObject(User::class.java)
                trySend(user)
            }

        awaitClose { listener.remove() }
    }

    /**
     * Kullanƒ±cƒ±nƒ±n ≈üu anki premium durumunu getir
     */
    suspend fun getCurrentPremiumStatus(): User? {
        val userId = auth.currentUser?.uid ?: return null
        return try {
            firestore.collection(USERS_COLLECTION)
                .document(userId)
                .get()
                .await()
                .toObject(User::class.java)
        } catch (e: Exception) {
            null
        }
    }

    /**
     * 3 g√ºnl√ºk √ºcretsiz deneme ba≈ülat (onboarding i√ßin)
     */
    suspend fun activateTrialPeriod(userId: String): Boolean {
        return try {
            val now = System.currentTimeMillis()
            val expiryDate = now + (com.bardino.dozi.core.common.Constants.TRIAL_DURATION_DAYS * 24 * 60 * 60 * 1000L)

            firestore.collection(USERS_COLLECTION)
                .document(userId)
                .update(PremiumFields.activePlan(PremiumPlanType.TRIAL, now, expiryDate, isTrial = true))
                .await()

            // Analytics g√ºncelle
            incrementTrialStarts()

            true
        } catch (e: Exception) {
            false
        }
    }

    /**
     * Premium satƒ±n alƒ±mƒ±nƒ± kaydet
     */
    suspend fun activatePremium(
        userId: String,
        planType: PremiumPlanType,
        purchaseToken: String?,
        orderId: String?
    ): Boolean {
        return try {
            val now = System.currentTimeMillis()
            val durationMillis = when (planType) {
                PremiumPlanType.EKSTRA_MONTHLY, PremiumPlanType.AILE_MONTHLY -> 30 * 24 * 60 * 60 * 1000L
                PremiumPlanType.EKSTRA_YEARLY, PremiumPlanType.AILE_YEARLY -> 365 * 24 * 60 * 60 * 1000L
                PremiumPlanType.TRIAL -> com.bardino.dozi.core.common.Constants.TRIAL_DURATION_DAYS * 24 * 60 * 60 * 1000L
                else -> 0L
            }

            val expiryDate = now + durationMillis

            firestore.collection(USERS_COLLECTION)
                .document(userId)
                .update(PremiumFields.activePlan(planType, now, expiryDate))
                .await()

            // Analytics g√ºncelle
            incrementPremiumPurchases(planType)

            true
        } catch (e: Exception) {
            false
        }
    }

    /**
     * Premium'u manuel olarak ayarla (Admin i√ßin DB'den)
     */
    suspend fun setUserPremium(
        userId: String,
        planType: PremiumPlanType,
        durationDays: Int = 0
    ): Boolean {
        return try {
            val now = System.currentTimeMillis()
            val durationMillis = durationDays * 24 * 60 * 60 * 1000L
            val expiryDate = now + durationMillis

            firestore.collection(USERS_COLLECTION)
                .document(userId)
                .update(PremiumFields.activePlan(planType, now, expiryDate))
                .await()

            true
        } catch (e: Exception) {
            false
        }
    }

    /**
     * Premium'u iptal et
     */
    suspend fun cancelPremium(userId: String): Boolean {
        return try {
            firestore.collection(USERS_COLLECTION)
                .document(userId)
                .update(PremiumFields.reset())
                .await()

            true
        } catch (e: Exception) {
            false
        }
    }

    /**
     * Kullanƒ±cƒ±yƒ± banla
     */
    suspend fun banUser(
        userId: String,
        reason: String,
        adminUserId: String,
        isPermanent: Boolean = true,
        durationDays: Int = 0
    ): Boolean {
        return try {
            val now = System.currentTimeMillis()
            val expiresAt = if (isPermanent) {
                Long.MAX_VALUE
            } else {
                now + (durationDays * 24 * 60 * 60 * 1000L)
            }

            // User'ƒ± g√ºncelle
            val userUpdates = hashMapOf<String, Any>(
                "isBanned" to true,
                "banReason" to reason
            )

            firestore.collection(USERS_COLLECTION)
                .document(userId)
                .update(userUpdates)
                .await()

            // Ban dok√ºmanƒ± olu≈ütur
            val banData = UserBan(
                userId = userId,
                isBanned = true,
                reason = reason,
                bannedBy = adminUserId,
                isPermanent = isPermanent
            )

            firestore.collection(USER_BANS_COLLECTION)
                .document(userId)
                .set(banData)
                .await()

            true
        } catch (e: Exception) {
            false
        }
    }

    /**
     * Kullanƒ±cƒ±nƒ±n ban'ƒ±nƒ± kaldƒ±r
     */
    suspend fun unbanUser(userId: String): Boolean {
        return try {
            val userUpdates = hashMapOf<String, Any>(
                "isBanned" to false,
                "banReason" to ""
            )

            firestore.collection(USERS_COLLECTION)
                .document(userId)
                .update(userUpdates)
                .await()

            firestore.collection(USER_BANS_COLLECTION)
                .document(userId)
                .delete()
                .await()

            true
        } catch (e: Exception) {
            false
        }
    }

    /**
     * Kullanƒ±cƒ±nƒ±n ban durumunu kontrol et
     */
    suspend fun checkBanStatus(userId: String): UserBan? {
        return try {
            firestore.collection(USER_BANS_COLLECTION)
                .document(userId)
                .get()
                .await()
                .toObject(UserBan::class.java)
        } catch (e: Exception) {
            null
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üìä ANALYTICS METHODS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * Premium analytics verilerini getir
     */
    suspend fun getPremiumAnalytics(): PremiumAnalytics? {
        return try {
            firestore.collection("analytics")
                .document(PREMIUM_ANALYTICS_DOC)
                .get()
                .await()
                .toObject(PremiumAnalytics::class.java)
        } catch (e: Exception) {
            null
        }
    }

    /**
     * G√ºnl√ºk analytics verilerini getir
     */
    suspend fun getDailyAnalytics(date: String): DailyAnalytics? {
        return try {
            firestore.collection(DAILY_ANALYTICS_COLLECTION)
                .document(date)
                .get()
                .await()
                .toObject(DailyAnalytics::class.java)
        } catch (e: Exception) {
            null
        }
    }

    /**
     * Son N g√ºn√ºn analytics verilerini getir
     */
    suspend fun getRecentAnalytics(days: Int = 30): List<DailyAnalytics> {
        return try {
            val calendar = Calendar.getInstance()
            val dates = mutableListOf<String>()

            repeat(days) {
                val date = String.format(
                    "%04d-%02d-%02d",
                    calendar.get(Calendar.YEAR),
                    calendar.get(Calendar.MONTH) + 1,
                    calendar.get(Calendar.DAY_OF_MONTH)
                )
                dates.add(date)
                calendar.add(Calendar.DAY_OF_MONTH, -1)
            }

            firestore.collection(DAILY_ANALYTICS_COLLECTION)
                .whereIn("date", dates)
                .get()
                .await()
                .documents
                .mapNotNull { it.toObject(DailyAnalytics::class.java) }
                .sortedByDescending { it.date }
        } catch (e: Exception) {
            emptyList()
        }
    }

    private suspend fun incrementTrialStarts() {
        try {
            val today = getTodayString()
            firestore.collection(DAILY_ANALYTICS_COLLECTION)
                .document(today)
                .update("trialStarts", com.google.firebase.firestore.FieldValue.increment(1))
                .await()
        } catch (e: Exception) {
            // Create new document if doesn't exist
        }
    }

    private suspend fun incrementPremiumPurchases(planType: PremiumPlanType) {
        try {
            val today = getTodayString()
            val updates = hashMapOf<String, Any>(
                "premiumPurchases" to com.google.firebase.firestore.FieldValue.increment(1)
            )

            firestore.collection(DAILY_ANALYTICS_COLLECTION)
                .document(today)
                .update(updates)
                .await()
        } catch (e: Exception) {
            // Create new document if doesn't exist
        }
    }

    private fun getTodayString(): String {
        val calendar = Calendar.getInstance()
        return String.format(
            "%04d-%02d-%02d",
            calendar.get(Calendar.YEAR),
            calendar.get(Calendar.MONTH) + 1,
            calendar.get(Calendar.DAY_OF_MONTH)
        )
    }
}

// ============================================================================
// FILE: PricingRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/repository/PricingRepository.kt
// [35 of 122]
// ============================================================================

package com.bardino.dozi.core.data.repository

import android.util.Log
import com.bardino.dozi.core.data.model.DefaultPricing
import com.bardino.dozi.core.data.model.PlanPricing
import com.bardino.dozi.core.data.model.PremiumPlanType
import com.bardino.dozi.core.data.model.PricingConfig
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.tasks.await
import javax.inject.Inject
import javax.inject.Singleton

/**
 * üí∞ Fiyatlandƒ±rma Repository
 *
 * Firestore'dan fiyat bilgilerini √ßeker ve cache'ler.
 * Offline durumda varsayƒ±lan fiyatlarƒ± kullanƒ±r.
 */
@Singleton
class PricingRepository @Inject constructor(
    private val firestore: FirebaseFirestore
) {
    companion object {
        private const val TAG = "PricingRepository"
        private const val CONFIG_COLLECTION = "config"
        private const val PRICING_DOCUMENT = "pricing"
    }

    private val _pricingConfig = MutableStateFlow(DefaultPricing.config)
    val pricingConfig: Flow<PricingConfig> = _pricingConfig.asStateFlow()

    private var isInitialized = false

    /**
     * Fiyatlarƒ± Firestore'dan y√ºkler
     */
    suspend fun loadPricing(): Result<PricingConfig> {
        return try {
            val document = firestore
                .collection(CONFIG_COLLECTION)
                .document(PRICING_DOCUMENT)
                .get()
                .await()

            if (document.exists()) {
                val config = parsePricingDocument(document.data)
                _pricingConfig.value = config
                isInitialized = true
                Log.d(TAG, "Pricing loaded from Firestore")
                Result.success(config)
            } else {
                Log.w(TAG, "Pricing document not found, using defaults")
                _pricingConfig.value = DefaultPricing.config
                isInitialized = true
                Result.success(DefaultPricing.config)
            }
        } catch (e: Exception) {
            Log.e(TAG, "Failed to load pricing, using defaults", e)
            _pricingConfig.value = DefaultPricing.config
            isInitialized = true
            Result.failure(e)
        }
    }

    /**
     * Mevcut fiyat konfig√ºrasyonunu d√∂nd√ºr√ºr
     */
    fun getCurrentPricing(): PricingConfig {
        return _pricingConfig.value
    }

    /**
     * Belirli bir plan i√ßin fiyat bilgisi d√∂nd√ºr√ºr
     */
    fun getPricingForPlan(planType: PremiumPlanType): PlanPricing? {
        val config = _pricingConfig.value
        return when (planType) {
            PremiumPlanType.EKSTRA_MONTHLY -> config.ekstraMonthly
            PremiumPlanType.EKSTRA_YEARLY -> config.ekstraYearly
            PremiumPlanType.AILE_MONTHLY -> config.aileMonthly
            PremiumPlanType.AILE_YEARLY -> config.aileYearly
            else -> null
        }
    }

    /**
     * Plan s√ºresini g√ºn olarak d√∂nd√ºr√ºr
     */
    fun getDurationDays(planType: PremiumPlanType): Int {
        return when (planType) {
            PremiumPlanType.FREE -> 0
            PremiumPlanType.TRIAL -> _pricingConfig.value.trialDurationDays
            PremiumPlanType.EKSTRA_MONTHLY -> _pricingConfig.value.ekstraMonthly.durationDays
            PremiumPlanType.EKSTRA_YEARLY -> _pricingConfig.value.ekstraYearly.durationDays
            PremiumPlanType.AILE_MONTHLY -> _pricingConfig.value.aileMonthly.durationDays
            PremiumPlanType.AILE_YEARLY -> _pricingConfig.value.aileYearly.durationDays
        }
    }

    /**
     * Trial s√ºresini d√∂nd√ºr√ºr
     */
    fun getTrialDurationDays(): Int {
        return _pricingConfig.value.trialDurationDays
    }

    /**
     * Fiyatlarƒ± real-time olarak dinler
     */
    fun observePricing() {
        firestore
            .collection(CONFIG_COLLECTION)
            .document(PRICING_DOCUMENT)
            .addSnapshotListener { snapshot, error ->
                if (error != null) {
                    Log.e(TAG, "Pricing listener error", error)
                    return@addSnapshotListener
                }

                if (snapshot != null && snapshot.exists()) {
                    val config = parsePricingDocument(snapshot.data)
                    _pricingConfig.value = config
                    Log.d(TAG, "Pricing updated from real-time listener")
                }
            }
    }

    /**
     * Firestore document'ƒ±nƒ± PricingConfig'e parse eder
     */
    @Suppress("UNCHECKED_CAST")
    private fun parsePricingDocument(data: Map<String, Any>?): PricingConfig {
        if (data == null) return DefaultPricing.config

        return try {
            PricingConfig(
                ekstraMonthly = parsePlanPricing(data["ekstra_monthly"] as? Map<String, Any>)
                    ?: DefaultPricing.config.ekstraMonthly,
                ekstraYearly = parsePlanPricing(data["ekstra_yearly"] as? Map<String, Any>)
                    ?: DefaultPricing.config.ekstraYearly,
                aileMonthly = parsePlanPricing(data["aile_monthly"] as? Map<String, Any>)
                    ?: DefaultPricing.config.aileMonthly,
                aileYearly = parsePlanPricing(data["aile_yearly"] as? Map<String, Any>)
                    ?: DefaultPricing.config.aileYearly,
                trialDurationDays = (data["trial_duration_days"] as? Long)?.toInt()
                    ?: DefaultPricing.config.trialDurationDays
            )
        } catch (e: Exception) {
            Log.e(TAG, "Failed to parse pricing document", e)
            DefaultPricing.config
        }
    }

    /**
     * Plan fiyat bilgisini parse eder
     */
    private fun parsePlanPricing(data: Map<String, Any>?): PlanPricing? {
        if (data == null) return null

        return try {
            PlanPricing(
                price = (data["price"] as? Number)?.toFloat() ?: 0f,
                currency = data["currency"] as? String ?: "TRY",
                durationDays = (data["duration_days"] as? Long)?.toInt() ?: 30,
                displayName = data["display_name"] as? String ?: "",
                isActive = data["is_active"] as? Boolean ?: true,
                savingsPercent = (data["savings_percent"] as? Long)?.toInt() ?: 0,
                discountPercent = (data["discount_percent"] as? Long)?.toInt() ?: 0
            )
        } catch (e: Exception) {
            Log.e(TAG, "Failed to parse plan pricing", e)
            null
        }
    }

    /**
     * Fiyatlarƒ± Firestore'a kaydeder (Admin kullanƒ±mƒ± i√ßin)
     */
    suspend fun savePricing(config: PricingConfig): Result<Unit> {
        return try {
            val data = mapOf(
                "ekstra_monthly" to planPricingToMap(config.ekstraMonthly),
                "ekstra_yearly" to planPricingToMap(config.ekstraYearly),
                "aile_monthly" to planPricingToMap(config.aileMonthly),
                "aile_yearly" to planPricingToMap(config.aileYearly),
                "trial_duration_days" to config.trialDurationDays,
                "last_updated" to com.google.firebase.firestore.FieldValue.serverTimestamp()
            )

            firestore
                .collection(CONFIG_COLLECTION)
                .document(PRICING_DOCUMENT)
                .set(data)
                .await()

            _pricingConfig.value = config
            Log.d(TAG, "Pricing saved to Firestore")
            Result.success(Unit)
        } catch (e: Exception) {
            Log.e(TAG, "Failed to save pricing", e)
            Result.failure(e)
        }
    }

    private fun planPricingToMap(pricing: PlanPricing): Map<String, Any?> {
        return mapOf(
            "price" to pricing.price,
            "currency" to pricing.currency,
            "duration_days" to pricing.durationDays,
            "display_name" to pricing.displayName,
            "is_active" to pricing.isActive,
            "savings_percent" to pricing.savingsPercent,
            "discount_percent" to pricing.discountPercent,
            "campaign_end_date" to pricing.campaignEndDate
        )
    }
}

// ============================================================================
// FILE: UserPreferencesRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/repository/UserPreferencesRepository.kt
// [36 of 122]
// ============================================================================

package com.bardino.dozi.core.data.repository

import android.content.Context
import android.util.Log
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.firestore.SetOptions
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken
import kotlinx.coroutines.tasks.await

/**
 * Kullanƒ±cƒ± tercihlerini ve verilerini Firebase ile senkronize eden repository
 * SharedPreferences'taki verileri Firestore'a yedekler ve √ßoklu cihaz desteƒüi saƒülar
 */
class UserPreferencesRepository(
    private val context: Context,
    private val auth: FirebaseAuth = FirebaseAuth.getInstance(),
    private val db: FirebaseFirestore = FirebaseFirestore.getInstance()
) {
    private val gson = Gson()

    private val currentUserId: String?
        get() = auth.currentUser?.uid

    companion object {
        private const val TAG = "UserPreferencesRepo"
        private const val COLLECTION_USERS = "users"
        private const val SUBCOLLECTION_PREFERENCES = "preferences"

        // Document IDs
        private const val DOC_SNOOZE = "snooze"
        private const val DOC_STOCK_WARNINGS = "stock_warnings"
        private const val DOC_LOCATIONS = "locations"
        private const val DOC_SMART_PATTERNS = "smart_patterns"
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üí§ SNOOZE VERƒ∞LERƒ∞
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * Snooze verilerini Firestore'a kaydet
     */
    suspend fun syncSnoozeData(
        snoozeMinutes: Int,
        snoozeUntil: Long,
        snoozeTimestamp: Long,
        medicineId: String? = null
    ): Result<Unit> {
        val userId = currentUserId ?: return Result.failure(Exception("User not logged in"))

        return try {
            val data = hashMapOf(
                "snoozeMinutes" to snoozeMinutes,
                "snoozeUntil" to snoozeUntil,
                "snoozeTimestamp" to snoozeTimestamp,
                "medicineId" to medicineId,
                "updatedAt" to System.currentTimeMillis()
            )

            db.collection(COLLECTION_USERS)
                .document(userId)
                .collection(SUBCOLLECTION_PREFERENCES)
                .document(DOC_SNOOZE)
                .set(data, SetOptions.merge())
                .await()

            Log.d(TAG, "‚úÖ Snooze verisi senkronize edildi: $snoozeMinutes dk")
            Result.success(Unit)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Snooze verisi senkronize edilemedi", e)
            Result.failure(e)
        }
    }

    /**
     * Snooze ge√ßmi≈üini kaydet (SmartReminder i√ßin)
     */
    suspend fun syncSnoozeHistory(medicineId: String, history: List<Int>): Result<Unit> {
        val userId = currentUserId ?: return Result.failure(Exception("User not logged in"))

        return try {
            val data = hashMapOf(
                "history_$medicineId" to history,
                "updatedAt" to System.currentTimeMillis()
            )

            db.collection(COLLECTION_USERS)
                .document(userId)
                .collection(SUBCOLLECTION_PREFERENCES)
                .document(DOC_SNOOZE)
                .set(data, SetOptions.merge())
                .await()

            Log.d(TAG, "‚úÖ Snooze ge√ßmi≈üi senkronize edildi: $medicineId")
            Result.success(Unit)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Snooze ge√ßmi≈üi senkronize edilemedi", e)
            Result.failure(e)
        }
    }

    /**
     * Snooze verilerini Firestore'dan al
     */
    suspend fun getSnoozeData(): Map<String, Any>? {
        val userId = currentUserId ?: return null

        return try {
            val doc = db.collection(COLLECTION_USERS)
                .document(userId)
                .collection(SUBCOLLECTION_PREFERENCES)
                .document(DOC_SNOOZE)
                .get()
                .await()

            doc.data
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Snooze verisi alƒ±namadƒ±", e)
            null
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚ö†Ô∏è STOCK WARNING VERƒ∞LERƒ∞
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * Stock warning zamanƒ±nƒ± kaydet
     */
    suspend fun syncStockWarning(medicineId: String, lastWarningTime: Long): Result<Unit> {
        val userId = currentUserId ?: return Result.failure(Exception("User not logged in"))

        return try {
            val data = hashMapOf(
                "last_warning_$medicineId" to lastWarningTime,
                "updatedAt" to System.currentTimeMillis()
            )

            db.collection(COLLECTION_USERS)
                .document(userId)
                .collection(SUBCOLLECTION_PREFERENCES)
                .document(DOC_STOCK_WARNINGS)
                .set(data, SetOptions.merge())
                .await()

            Log.d(TAG, "‚úÖ Stock warning senkronize edildi: $medicineId")
            Result.success(Unit)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Stock warning senkronize edilemedi", e)
            Result.failure(e)
        }
    }

    /**
     * Stock warning verilerini al
     */
    suspend fun getStockWarnings(): Map<String, Long>? {
        val userId = currentUserId ?: return null

        return try {
            val doc = db.collection(COLLECTION_USERS)
                .document(userId)
                .collection(SUBCOLLECTION_PREFERENCES)
                .document(DOC_STOCK_WARNINGS)
                .get()
                .await()

            doc.data?.filterKeys { it.startsWith("last_warning_") }
                ?.mapValues { (it.value as? Long) ?: 0L }
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Stock warnings alƒ±namadƒ±", e)
            null
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üìç KONUM VERƒ∞LERƒ∞
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * Kayƒ±tlƒ± konumlarƒ± senkronize et
     */
    suspend fun syncLocations(locationsJson: String): Result<Unit> {
        val userId = currentUserId ?: return Result.failure(Exception("User not logged in"))

        return try {
            val data = hashMapOf(
                "locationsJson" to locationsJson,
                "updatedAt" to System.currentTimeMillis()
            )

            db.collection(COLLECTION_USERS)
                .document(userId)
                .collection(SUBCOLLECTION_PREFERENCES)
                .document(DOC_LOCATIONS)
                .set(data, SetOptions.merge())
                .await()

            Log.d(TAG, "‚úÖ Konumlar senkronize edildi")
            Result.success(Unit)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Konumlar senkronize edilemedi", e)
            Result.failure(e)
        }
    }

    /**
     * Kayƒ±tlƒ± konumlarƒ± al
     */
    suspend fun getLocations(): String? {
        val userId = currentUserId ?: return null

        return try {
            val doc = db.collection(COLLECTION_USERS)
                .document(userId)
                .collection(SUBCOLLECTION_PREFERENCES)
                .document(DOC_LOCATIONS)
                .get()
                .await()

            doc.getString("locationsJson")
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Konumlar alƒ±namadƒ±", e)
            null
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üß† SMART REMINDER PATTERNS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * Smart reminder pattern'ƒ±nƒ± senkronize et
     */
    suspend fun syncSmartPattern(
        medicineId: String,
        modeSnoozeMinutes: Int? = null,
        avgSnoozeMinutes: Int? = null,
        avgDelayMinutes: Int? = null,
        lastSnoozeMinutes: Int? = null
    ): Result<Unit> {
        val userId = currentUserId ?: return Result.failure(Exception("User not logged in"))

        return try {
            val data = hashMapOf<String, Any>(
                "updatedAt" to System.currentTimeMillis()
            )

            modeSnoozeMinutes?.let { data["mode_snooze_$medicineId"] = it }
            avgSnoozeMinutes?.let { data["avg_snooze_$medicineId"] = it }
            avgDelayMinutes?.let { data["avg_delay_$medicineId"] = it }
            lastSnoozeMinutes?.let { data["last_snooze_$medicineId"] = it }

            db.collection(COLLECTION_USERS)
                .document(userId)
                .collection(SUBCOLLECTION_PREFERENCES)
                .document(DOC_SMART_PATTERNS)
                .set(data, SetOptions.merge())
                .await()

            Log.d(TAG, "‚úÖ Smart pattern senkronize edildi: $medicineId")
            Result.success(Unit)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Smart pattern senkronize edilemedi", e)
            Result.failure(e)
        }
    }

    /**
     * Smart reminder patterns'ƒ± al
     */
    suspend fun getSmartPatterns(): Map<String, Any>? {
        val userId = currentUserId ?: return null

        return try {
            val doc = db.collection(COLLECTION_USERS)
                .document(userId)
                .collection(SUBCOLLECTION_PREFERENCES)
                .document(DOC_SMART_PATTERNS)
                .get()
                .await()

            doc.data
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Smart patterns alƒ±namadƒ±", e)
            null
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üîÑ TOPLU SENKRONIZASYON
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * T√ºm tercihleri Firestore'dan √ßek ve local'e kaydet
     */
    suspend fun pullAllPreferences() {
        val userId = currentUserId ?: return

        try {
            // Snooze verilerini √ßek
            getSnoozeData()?.let { data ->
                val prefs = context.getSharedPreferences("dozi_prefs", Context.MODE_PRIVATE)
                prefs.edit().apply {
                    (data["snoozeMinutes"] as? Long)?.toInt()?.let { putInt("snooze_minutes", it) }
                    (data["snoozeUntil"] as? Long)?.let { putLong("snooze_until", it) }
                    (data["snoozeTimestamp"] as? Long)?.let { putLong("snooze_timestamp", it) }
                    apply()
                }
            }

            // Stock warnings √ßek
            getStockWarnings()?.let { warnings ->
                val prefs = context.getSharedPreferences("stock_warnings", Context.MODE_PRIVATE)
                prefs.edit().apply {
                    warnings.forEach { (key, value) ->
                        putLong(key, value)
                    }
                    apply()
                }
            }

            // Locations √ßek
            getLocations()?.let { json ->
                val prefs = context.getSharedPreferences("location_prefs", Context.MODE_PRIVATE)
                prefs.edit().putString("saved_locations", json).apply()
            }

            Log.d(TAG, "‚úÖ T√ºm tercihler Firestore'dan √ßekildi")
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Tercihler √ßekilirken hata", e)
        }
    }
}

// ============================================================================
// FILE: UserRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/repository/UserRepository.kt
// [37 of 122]
// ============================================================================

package com.bardino.dozi.core.data.repository

import com.bardino.dozi.core.data.model.PremiumPlanType
import com.bardino.dozi.core.data.model.User
import com.bardino.dozi.core.premium.PremiumFields
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.tasks.await

class UserRepository(
    private val auth: FirebaseAuth = FirebaseAuth.getInstance(),
    private val db: FirebaseFirestore = FirebaseFirestore.getInstance()
) {

    suspend fun getUserData(): User? {
        val user = auth.currentUser ?: return null
        val doc = db.collection("users").document(user.uid).get().await()
        return doc.toObject(User::class.java)
    }

    suspend fun createUserIfNotExists() {
        val user = auth.currentUser ?: return
        val docRef = db.collection("users").document(user.uid)
        val snapshot = docRef.get().await()
        if (!snapshot.exists()) {
            val newUser = User(
                uid = user.uid,
                name = user.displayName ?: "",
                email = user.email ?: "",
                photoUrl = user.photoUrl?.toString() ?: "",
                createdAt = System.currentTimeMillis(),
                timezone = "Europe/Istanbul",
                language = "tr",
                planType = "free",
                vibration = true,
                theme = "light",
                onboardingCompleted = false
            )
            docRef.set(newUser).await()
        }
    }

    suspend fun updateUser(user: User) {
        val currentUser = auth.currentUser ?: return
        val docRef = db.collection("users").document(currentUser.uid)
        docRef.set(user).await()
    }

    suspend fun updateUserField(field: String, value: Any) {
        val currentUser = auth.currentUser ?: return
        val docRef = db.collection("users").document(currentUser.uid)

        // √ñnce dok√ºmanƒ±n var olup olmadƒ±ƒüƒ±nƒ± kontrol et
        val snapshot = docRef.get().await()
        if (snapshot.exists()) {
            // Dok√ºman varsa update et
            docRef.update(field, value).await()
        } else {
            // Dok√ºman yoksa √∂nce olu≈ütur, sonra update et
            createUserIfNotExists()
            docRef.update(field, value).await()
        }
    }

    fun signOut() {
        auth.signOut()
    }

    /**
     * üì± DeviceId ile kullanƒ±cƒ± bul
     * Uygulama silinip tekrar y√ºklendiƒüinde deviceId ile kullanƒ±cƒ±yƒ± tanƒ±mak i√ßin
     */
    suspend fun getUserByDeviceId(deviceId: String): User? {
        return try {
            val snapshot = db.collection("users")
                .whereEqualTo("deviceId", deviceId)
                .limit(1)
                .get()
                .await()

            if (snapshot.documents.isNotEmpty()) {
                snapshot.documents.first().toObject(User::class.java)
            } else {
                null
            }
        } catch (e: Exception) {
            android.util.Log.e("UserRepository", "‚ùå Error finding user by deviceId: ${e.message}")
            null
        }
    }

    /**
     * üéÅ Yeni kullanƒ±cƒ±ya 3 g√ºnl√ºk √ºcretsiz trial ba≈ülat
     */
    suspend fun activateTrialForNewUser() {
        val user = auth.currentUser ?: return
        val docRef = db.collection("users").document(user.uid)
        val snapshot = docRef.get().await()
        val userData = snapshot.toObject(User::class.java) ?: return

        // Eƒüer kullanƒ±cƒ± zaten premium veya trial almƒ±≈üsa, tekrar verme
        if (userData.isPremium || userData.premiumExpiryDate > 0) {
            return
        }

        // 3 g√ºnl√ºk trial ver
        val now = System.currentTimeMillis()
        val expiryDate = now + (3 * 24 * 60 * 60 * 1000L) // 3 g√ºn

        docRef.update(PremiumFields.activePlan(PremiumPlanType.TRIAL, now, expiryDate, isTrial = true)).await()
    }

    /**
     * üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Kullanƒ±cƒ±nƒ±n premium durumunu kontrol et (Aile planƒ± dahil)
     *
     * Premium durumu iki ≈üekilde olabilir:
     * 1. Bireysel premium (isPremium = true, premiumExpiryDate kontrol)
     * 2. Aile planƒ± √ºyesi (familyPlanId var, aile planƒ± aktif)
     */
    suspend fun isPremiumUser(): Boolean {
        val userData = getUserData() ?: return false

        // 1. Bireysel premium kontrol√º
        if (userData.premiumStatus().isActive) {
            return true
        }

        // 2. Aile planƒ± kontrol√º
        if (userData.isInFamilyPlan()) {
            // Aile planƒ±nƒ±n aktif olup olmadƒ±ƒüƒ±nƒ± kontrol et
            try {
                val familyPlanId = userData.familyPlanId ?: return false
                val familyPlanDoc = db.collection("family_plans").document(familyPlanId).get().await()

                if (familyPlanDoc.exists()) {
                    val status = familyPlanDoc.getString("status") ?: ""
                    val expiresAt = familyPlanDoc.getTimestamp("expiresAt")

                    // Plan aktif mi ve s√ºresi dolmamƒ±≈ü mƒ±?
                    if (status == "ACTIVE" && expiresAt != null) {
                        val now = System.currentTimeMillis()
                        return now < expiresAt.toDate().time
                    }
                }
            } catch (e: Exception) {
                android.util.Log.e("UserRepository", "‚ùå Error checking family plan: ${e.message}")
            }
        }

        return false
    }

    /**
     * üåü Premium √∂zelliklere eri≈üim kontrol√º
     *
     * Premium gerektiren √∂zellikler i√ßin kullan
     */
    suspend fun requiresPremium(): Boolean {
        return !isPremiumUser()
    }
}

// ============================================================================
// FILE: UserStatsRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/repository/UserStatsRepository.kt
// [38 of 122]
// ============================================================================

package com.bardino.dozi.core.data.repository

import android.os.Build
import android.util.Log
import androidx.annotation.RequiresApi
import com.bardino.dozi.core.data.model.*
import com.google.firebase.Timestamp
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.tasks.await
import java.time.LocalDate
import java.time.ZoneId
import java.util.Date
import javax.inject.Inject
import javax.inject.Singleton

/**
 * UserStats Repository - Kullanƒ±cƒ± istatistikleri ve gamification
 */
@Singleton
class UserStatsRepository @Inject constructor(
    private val achievementRepository: AchievementRepository
) {
    private val firestore = FirebaseFirestore.getInstance()
    private val auth = FirebaseAuth.getInstance()
    private val TAG = "UserStatsRepository"

    /**
     * Kullanƒ±cƒ±nƒ±n stats belgesini al
     */
    suspend fun getUserStats(): UserStats? {
        return try {
            val userId = auth.currentUser?.uid ?: return null
            val doc = firestore.collection("user_stats")
                .document(userId)
                .get()
                .await()

            if (doc.exists()) {
                doc.toObject(UserStats::class.java)
            } else {
                // ƒ∞lk kez olu≈ütur
                val initialStats = UserStats(
                    id = userId,
                    userId = userId,
                    currentStreak = 0,
                    longestStreak = 0,
                    lastStreakDate = null
                )
                firestore.collection("user_stats")
                    .document(userId)
                    .set(initialStats)
                    .await()
                initialStats
            }
        } catch (e: Exception) {
            Log.e(TAG, "Error getting user stats", e)
            null
        }
    }

    /**
     * Streak'i g√ºncelle (her g√ºn ila√ß alƒ±ndƒ±ƒüƒ±nda √ßaƒürƒ±lƒ±r)
     */
    @RequiresApi(Build.VERSION_CODES.O)
    suspend fun updateStreak(medicationLogRepository: MedicationLogRepository) {
        try {
            val userId = auth.currentUser?.uid ?: return
            val stats = getUserStats() ?: return

            // Bug√ºn√ºn tarihini al
            val today = LocalDate.now()
            val yesterday = today.minusDays(1)

            // Son streak tarihini kontrol et
            val lastStreakDate = stats.lastStreakDate?.toDate()?.toInstant()
                ?.atZone(ZoneId.systemDefault())?.toLocalDate()

            // Bug√ºn t√ºm ila√ßlar alƒ±ndƒ± mƒ± kontrol et
            val todayLogs = medicationLogRepository.getMedicationLogsForDate(today)
            val allTakenToday = todayLogs.isNotEmpty() &&
                    todayLogs.all { it.status == MedicationStatus.TAKEN }

            if (!allTakenToday) {
                Log.d(TAG, "Not all medications taken today, streak not updated")
                return
            }

            // Streak hesapla
            val newStreak = when {
                lastStreakDate == null -> 1 // ƒ∞lk g√ºn
                lastStreakDate == yesterday -> stats.currentStreak + 1 // Ardƒ±≈üƒ±k
                lastStreakDate == today -> stats.currentStreak // Bug√ºn zaten sayƒ±lmƒ±≈ü
                else -> 1 // Kopmu≈ü, yeniden ba≈üla
            }

            val newLongestStreak = maxOf(newStreak, stats.longestStreak)

            // Firestore'u g√ºncelle
            firestore.collection("user_stats")
                .document(userId)
                .update(
                    mapOf(
                        "currentStreak" to newStreak,
                        "longestStreak" to newLongestStreak,
                        "lastStreakDate" to Timestamp(Date.from(today.atStartOfDay(ZoneId.systemDefault()).toInstant())),
                        "totalMedicationsTaken" to (stats.totalMedicationsTaken + 1)
                    )
                )
                .await()

            Log.d(TAG, "Streak updated: $newStreak days")

            // Achievement kontrol√º (AchievementRepository'ye delege et)
            achievementRepository.checkStreakAchievements(newStreak)

        } catch (e: Exception) {
            Log.e(TAG, "Error updating streak", e)
        }
    }

    /**
     * ƒ∞la√ß ka√ßƒ±rƒ±ldƒ±ƒüƒ±nda streak'i sƒ±fƒ±rla
     */
    suspend fun breakStreak() {
        try {
            val userId = auth.currentUser?.uid ?: return

            firestore.collection("user_stats")
                .document(userId)
                .update(
                    mapOf(
                        "currentStreak" to 0,
                        "totalMedicationsMissed" to com.google.firebase.firestore.FieldValue.increment(1)
                    )
                )
                .await()

            Log.d(TAG, "Streak broken")
        } catch (e: Exception) {
            Log.e(TAG, "Error breaking streak", e)
        }
    }

    /**
     * Note: Achievement kontrolleri artƒ±k AchievementRepository tarafƒ±ndan yapƒ±lƒ±yor.
     * Bu repository sadece UserStats verilerini y√∂netir.
     */

    /**
     * Uyumluluk oranƒ±nƒ± hesapla ve g√ºncelle
     */
    suspend fun updateComplianceRate(medicationLogRepository: MedicationLogRepository) {
        try {
            val userId = auth.currentUser?.uid ?: return

            // Son 30 g√ºn√ºn loglarƒ±nƒ± al
            val last30Days = (0..29).map { LocalDate.now().minusDays(it.toLong()) }
            var totalScheduled = 0
            var totalTaken = 0

            for (date in last30Days) {
                val logs = medicationLogRepository.getMedicationLogsForDate(date)
                totalScheduled += logs.size
                totalTaken += logs.count { it.status == MedicationStatus.TAKEN }
            }

            val complianceRate = if (totalScheduled > 0) {
                (totalTaken.toFloat() / totalScheduled * 100)
            } else {
                0f
            }

            firestore.collection("user_stats")
                .document(userId)
                .update("complianceRate", complianceRate)
                .await()

            Log.d(TAG, "Compliance rate updated: $complianceRate%")
        } catch (e: Exception) {
            Log.e(TAG, "Error updating compliance rate", e)
        }
    }

    /**
     * ƒ∞la√ß alƒ±ndƒ± - stats g√ºncelle
     */
    suspend fun onMedicationTaken(medicationLogRepository: MedicationLogRepository) {
        updateStreak(medicationLogRepository)
        updateComplianceRate(medicationLogRepository)

        // T√ºm achievement'larƒ± kontrol et
        val stats = getUserStats()
        if (stats != null) {
            achievementRepository.checkAllAchievements(stats)
        }
    }

    /**
     * ƒ∞la√ß ka√ßƒ±rƒ±ldƒ± - stats g√ºncelle
     */
    suspend fun onMedicationMissed(medicationLogRepository: MedicationLogRepository) {
        breakStreak()
        updateComplianceRate(medicationLogRepository)
    }
}
// ============================================================================
// FILE: IlacJsonRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/IlacJsonRepository.kt
// [39 of 122]
// ============================================================================

package com.bardino.dozi.core.data

import android.content.Context

// üîé JSON'daki resmi ila√ß veritabanƒ±nda arama yapan sƒ±nƒ±f
object IlacJsonRepository {

    /**
     * Uygulama a√ßƒ±ldƒ±ƒüƒ±nda MedicineLookupRepository.initialize() √ßaƒürƒ±ldƒ±ƒüƒ± i√ßin
     * burada ilaclar.json tekrar okunmaz.
     */
    fun search(context: Context, query: String): List<IlacSearchResult> {
        android.util.Log.d("IlacJsonRepository", "Search called with query: '$query'")

        // Eƒüer cache hen√ºz hazƒ±r deƒüilse veya bo≈üsa, initialize et
        if (!MedicineLookupRepository.isInitialized()) {
            android.util.Log.d("IlacJsonRepository", "Cache not initialized, initializing now...")
            MedicineLookupRepository.initialize(context)
        }

        // Cache bo≈üsa, force reload ile tekrar dene
        var ilaclar = MedicineLookupRepository.ilaclarCache ?: emptyList()
        if (ilaclar.isEmpty()) {
            android.util.Log.w("IlacJsonRepository", "‚ö†Ô∏è Cache is empty, forcing reload from JSON...")
            MedicineLookupRepository.initialize(context, forceReload = true)
            ilaclar = MedicineLookupRepository.ilaclarCache ?: emptyList()
        }

        val clean = query.trim().lowercase()
        android.util.Log.d("IlacJsonRepository", "Cache size: ${ilaclar.size}, searching for: '$clean'")

        val results = ilaclar
            .filter {
                it.Product_Name?.lowercase()?.contains(clean) == true ||
                        it.Active_Ingredient?.lowercase()?.contains(clean) == true
            }
            .take(50) // üí° sadece ilk 50 sonucu getir
            .map { IlacSearchResult(it) }

        android.util.Log.d("IlacJsonRepository", "Search results: ${results.size} medicines found")
        return results
    }

    fun searchByBarcode(context: Context, barcode: String): Ilac? {
        // Cache hazƒ±r deƒüilse initialize et
        if (!MedicineLookupRepository.isInitialized()) {
            MedicineLookupRepository.initialize(context)
        }

        // Cache'teki ila√ß listesini al
        var ilacList = MedicineLookupRepository.ilaclarCache ?: emptyList()

        // Cache bo≈üsa, force reload ile tekrar dene
        if (ilacList.isEmpty()) {
            android.util.Log.w("IlacJsonRepository", "‚ö†Ô∏è Cache is empty for barcode search, forcing reload from JSON...")
            MedicineLookupRepository.initialize(context, forceReload = true)
            ilacList = MedicineLookupRepository.ilaclarCache ?: emptyList()
        }

        val cleanBarcode = barcode.trim()

        // Barkoda g√∂re arama yap
        return ilacList.firstOrNull { it.barcode == cleanBarcode }
    }


}

// üîπ Arama sonucu modeli
data class IlacSearchResult(
    val item: Ilac,
    val dosage: String? = null
)

// ============================================================================
// FILE: IlacModels.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/IlacModels.kt
// [40 of 122]
// ============================================================================

package com.bardino.dozi.core.data

import android.os.Parcelable
import kotlinx.parcelize.Parcelize

@Parcelize
data class IlacItem(
    val ID: String,
    val barcode: String?,
    val ATC_code: String?,
    val Active_Ingredient: String?,
    val Product_Name: String,
    val Category_1: String?,
    val Category_2: String?,
    val Category_3: String?,
    val Category_4: String?,
    val Category_5: String?,
    val Description: String?
) : Parcelable

// ============================================================================
// FILE: IlacRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/IlacRepository.kt
// [41 of 122]
// ============================================================================

package com.bardino.dozi.core.data

import android.content.Context
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken

// Tƒ∞TCK veritabanƒ±ndan gelen ila√ß
data class Ilac(
    val ID: String?,
    val barcode: String?,
    val Active_Ingredient: String?,
    val Product_Name: String?,
    val Category_1: String?,
    val Description: String?,
    val Company_Name: String? = null
)

// Tƒ∞TCK ila√ß arama repository
object IlacRepository {
    private var cachedIlaclar: List<Ilac>? = null

    fun initialize(context: Context) {
        if (cachedIlaclar != null) return // zaten y√ºklenmi≈ü
        try {
            val json = context.assets.open("ilaclar.json").bufferedReader().use { it.readText() }
            val type = object : TypeToken<List<Map<String, Any>>>() {}.type
            val raw = Gson().fromJson<List<Map<String, Any>>>(json, type)
            val dataSection = raw.firstOrNull { it["type"] == "table" }?.get("data") as? List<Map<String, Any>>
            cachedIlaclar = dataSection?.map {
                Ilac(
                    ID = it["ID"]?.toString(),
                    barcode = it["barcode"]?.toString(),
                    Active_Ingredient = it["Active_Ingredient"]?.toString(),
                    Product_Name = it["Product_Name"]?.toString(),
                    Category_1 = it["Category_1"]?.toString(),
                    Description = null, // devasa a√ßƒ±klamalarƒ± y√ºkleme
                    Company_Name = it["Company_Name"]?.toString()
                )
            } ?: emptyList()
        } catch (e: Exception) {
            e.printStackTrace()
            cachedIlaclar = emptyList()
        }
    }

    fun getAll(): List<Ilac> = cachedIlaclar ?: emptyList()

    fun findByNameOrIngredient(query: String): Ilac? {
        val clean = query.trim().lowercase()
        return cachedIlaclar?.firstOrNull {
            it.Product_Name?.lowercase()?.contains(clean) == true ||
                    it.Active_Ingredient?.lowercase()?.contains(clean) == true
        }
    }
}
// ============================================================================
// FILE: LocationPreferences.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/LocationPreferences.kt
// [42 of 122]
// ============================================================================

package com.bardino.dozi.core.data

import android.content.Context
import com.bardino.dozi.core.data.repository.UserPreferencesRepository
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch

data class SavedLocation(
    val id: String,
    val name: String,
    val lat: Double,
    val lng: Double,
    val address: String = ""
)

object LocationPreferences {
    private const val PREF_NAME = "location_prefs"
    private const val KEY_LOCATIONS = "saved_locations"
    private val gson = Gson()

    fun saveLocations(context: Context, locations: List<SavedLocation>) {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        val json = gson.toJson(locations)
        prefs.edit()
            .putString(KEY_LOCATIONS, json)
            .apply()

        // ‚úÖ Firebase'e senkronize et
        CoroutineScope(Dispatchers.IO).launch {
            try {
                val userPrefsRepo = UserPreferencesRepository(context)
                userPrefsRepo.syncLocations(json)
            } catch (e: Exception) {
                android.util.Log.e("LocationPreferences", "‚ùå Konumlar Firebase'e senkronize edilemedi", e)
            }
        }
    }

    fun getLocations(context: Context): List<SavedLocation> {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        val json = prefs.getString(KEY_LOCATIONS, null) ?: return emptyList()

        return try {
            val type = object : TypeToken<List<SavedLocation>>() {}.type
            gson.fromJson(json, type) ?: emptyList()
        } catch (e: Exception) {
            emptyList()
        }
    }

    fun addLocation(context: Context, location: SavedLocation) {
        val currentLocations = getLocations(context).toMutableList()
        currentLocations.add(location)
        saveLocations(context, currentLocations)
    }

    fun removeLocation(context: Context, locationId: String) {
        val currentLocations = getLocations(context).toMutableList()
        currentLocations.removeAll { it.id == locationId }
        saveLocations(context, currentLocations)
    }

    fun clearAllLocations(context: Context) {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        prefs.edit()
            .remove(KEY_LOCATIONS)
            .apply()
    }
}

// ============================================================================
// FILE: MedicineLookupRepository.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/MedicineLookupRepository.kt
// [43 of 122]
// ============================================================================

package com.bardino.dozi.core.data

import android.content.Context
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken

// üíä Kullanƒ±cƒ±nƒ±n kendi kaydettiƒüi ila√ß modeli (Local/Onboarding i√ßin)
data class LocalMedicine(
    val id: String,
    val name: String,
    val dosage: String = "",
    val stock: Int
)

/**
 * üß† ƒ∞la√ß Arama ve Lokal Depolama Repository'si
 *
 * ƒ∞ki ana g√∂revi var:
 * 1. ilaclar.json'dan ila√ß veritabanƒ±nƒ± y√ºkler (autocomplete i√ßin)
 * 2. Kullanƒ±cƒ±nƒ±n lokal ila√ßlarƒ±nƒ± SharedPreferences'da saklar (onboarding i√ßin)
 *
 * NOT: Firestore'daki ila√ßlar i√ßin MedicineRepository (repository paketi) kullanƒ±lƒ±r
 */
object MedicineLookupRepository {
    private const val PREF_NAME = "medicines_prefs"
    private const val KEY_MEDICINES = "medicines_json"
    private val gson = Gson()

    private var cachedIlaclar: List<Ilac>? = null
    private var initialized = false

    // üîπ Belleƒüe y√ºklenmi≈ü listeye salt-okunur eri≈üim
    val ilaclarCache: List<Ilac>?
        get() = cachedIlaclar

    // ‚úÖ Tek seferlik JSON y√ºkleme
    fun initialize(context: Context, forceReload: Boolean = false) {
        if (initialized && !forceReload) {
            android.util.Log.d("MedicineLookup", "Already initialized, skipping...")
            // Ama cache bo≈üsa, reload et
            if (cachedIlaclar.isNullOrEmpty()) {
                android.util.Log.w("MedicineLookup", "Cache is empty despite initialization, forcing reload...")
                initialized = false
            } else {
                return  // zaten y√ºklendiyse ve cache doluysa tekrar y√ºkleme
            }
        }

        try {
            android.util.Log.d("MedicineLookup", "Starting to initialize ilaclar.json...")
            val json = context.assets.open("ilaclar.json").bufferedReader().use { it.readText() }
            android.util.Log.d("MedicineLookup", "JSON file read successfully, length: ${json.length}")

            val type = object : TypeToken<List<Map<String, Any>>>() {}.type
            val raw = gson.fromJson<List<Map<String, Any>>>(json, type)
            android.util.Log.d("MedicineLookup", "JSON parsed, raw size: ${raw?.size}")

            val dataSection = raw.firstOrNull { it["type"] == "table" }?.get("data") as? List<Map<String, Any>>
            android.util.Log.d("MedicineLookup", "Data section extracted, size: ${dataSection?.size}")

            cachedIlaclar = dataSection?.map {
                Ilac(
                    ID = it["ID"]?.toString(),
                    barcode = it["barcode"]?.toString(),
                    Active_Ingredient = it["Active_Ingredient"]?.toString(),
                    Product_Name = it["Product_Name"]?.toString(),
                    Category_1 = it["Category_1"]?.toString(),
                    Description = it["Description"]?.toString()
                )
            } ?: emptyList()

            // Sadece ba≈üarƒ±lƒ± y√ºklemede initialized = true yap
            if (!cachedIlaclar.isNullOrEmpty()) {
                initialized = true
                android.util.Log.d("MedicineLookup", "‚úÖ Initialize successful! Loaded ${cachedIlaclar?.size ?: 0} medicines")
            } else {
                initialized = false
                android.util.Log.e("MedicineLookup", "‚ùå Initialize failed: cache is empty after loading")
            }

            // Debug: ƒ∞lk 3 ilacƒ± logla
            cachedIlaclar?.take(3)?.forEachIndexed { index, ilac ->
                android.util.Log.d("MedicineLookup", "Sample[$index]: ${ilac.Product_Name} | ${ilac.Active_Ingredient}")
            }
        } catch (e: Exception) {
            android.util.Log.e("MedicineLookup", "‚ùå Error initializing ilaclar.json: ${e.message}", e)
            android.util.Log.e("MedicineLookup", "Stack trace:", e)
            cachedIlaclar = emptyList()
            initialized = false
        }
    }

    fun isInitialized(): Boolean = initialized

    // üóÇ Kullanƒ±cƒ±nƒ±n kendi eklediƒüi ila√ßlarƒ± y√ºkle (Local storage)
    fun loadLocalMedicines(context: Context): List<LocalMedicine> {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        val json = prefs.getString(KEY_MEDICINES, null) ?: return emptyList()
        return try {
            val type = object : TypeToken<List<LocalMedicine>>() {}.type
            gson.fromJson(json, type) ?: emptyList()
        } catch (e: Exception) {
            emptyList()
        }
    }

    fun saveLocalMedicines(context: Context, medicines: List<LocalMedicine>) {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        prefs.edit().putString(KEY_MEDICINES, gson.toJson(medicines)).apply()
    }

    fun saveLocalMedicine(context: Context, medicine: LocalMedicine) {
        val medicines = loadLocalMedicines(context).toMutableList()
        val index = medicines.indexOfFirst { it.id == medicine.id }
        if (index >= 0) medicines[index] = medicine else medicines.add(medicine)
        saveLocalMedicines(context, medicines)
    }

    fun deleteLocalMedicine(context: Context, id: String) {
        val newList = loadLocalMedicines(context).filterNot { it.id == id }
        saveLocalMedicines(context, newList)
    }

    fun getLocalMedicine(context: Context, id: String): LocalMedicine? {
        return loadLocalMedicines(context).find { it.id == id }
    }

    fun findByNameOrIngredient(query: String): Ilac? {
        val clean = query.trim().lowercase()
        return cachedIlaclar?.firstOrNull {
            it.Product_Name?.lowercase()?.contains(clean) == true ||
                    it.Active_Ingredient?.lowercase()?.contains(clean) == true
        }
    }

    // üîÑ Backward compatibility - eski methodlar
    @Deprecated("Use loadLocalMedicines instead", ReplaceWith("loadLocalMedicines(context)"))
    fun loadMedicines(context: Context) = loadLocalMedicines(context)

    @Deprecated("Use saveLocalMedicine instead", ReplaceWith("saveLocalMedicine(context, medicine)"))
    fun saveMedicine(context: Context, medicine: LocalMedicine) = saveLocalMedicine(context, medicine)

    @Deprecated("Use getLocalMedicine instead", ReplaceWith("getLocalMedicine(context, id)"))
    fun getMedicine(context: Context, id: String) = getLocalMedicine(context, id)
}

// Backward compatibility type alias
@Deprecated("Use LocalMedicine instead", ReplaceWith("LocalMedicine"))
typealias Medicine = LocalMedicine

// ============================================================================
// FILE: OnboardingPreferences.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/OnboardingPreferences.kt
// [44 of 122]
// ============================================================================

package com.bardino.dozi.core.data

import android.content.Context
import android.util.Log
import com.bardino.dozi.core.data.model.Medicine
import com.bardino.dozi.core.data.repository.MedicineRepository
import com.bardino.dozi.notifications.ReminderScheduler
import org.json.JSONArray
import org.json.JSONObject

object OnboardingPreferences {
    private const val PREF_NAME = "onboarding_prefs"
    private const val KEY_FIRST_TIME = "is_first_time"
    private const val KEY_COMPLETED = "onboarding_completed"
    private const val KEY_USER_NAME = "user_name"
    private const val KEY_COMPLETED_AT = "completed_at"
    private const val KEY_CURRENT_STEP = "current_onboarding_step"
    private const val KEY_IN_ONBOARDING = "is_in_onboarding"
    private const val KEY_NEVER_SHOW_AGAIN = "never_show_onboarding_again"

    fun isFirstTime(context: Context): Boolean {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        return prefs.getBoolean(KEY_FIRST_TIME, true)
    }

    fun setFirstTimeComplete(context: Context) {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        prefs.edit()
            .putBoolean(KEY_FIRST_TIME, false)
            .putBoolean(KEY_COMPLETED, true)
            .putLong(KEY_COMPLETED_AT, System.currentTimeMillis())
            .apply()
    }

    fun saveUserName(context: Context, name: String) {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        prefs.edit().putString(KEY_USER_NAME, name).apply()
    }

    fun getUserName(context: Context): String? {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        return prefs.getString(KEY_USER_NAME, null)
    }

    fun skipOnboarding(context: Context) {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        prefs.edit()
            .putBoolean(KEY_FIRST_TIME, false)
            .apply()
    }

    // Onboarding state y√∂netimi
    fun setOnboardingStep(context: Context, step: String) {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        prefs.edit()
            .putString(KEY_CURRENT_STEP, step)
            .putBoolean(KEY_IN_ONBOARDING, true)
            .apply()
    }

    fun getOnboardingStep(context: Context): String? {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        return prefs.getString(KEY_CURRENT_STEP, null)
    }

    fun isInOnboarding(context: Context): Boolean {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        return prefs.getBoolean(KEY_IN_ONBOARDING, false)
    }

    fun clearOnboardingState(context: Context) {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        prefs.edit()
            .remove(KEY_CURRENT_STEP)
            .putBoolean(KEY_IN_ONBOARDING, false)
            .apply()
    }

    // "Bir daha g√∂sterme" tercihi
    fun setNeverShowOnboardingAgain(context: Context, neverShow: Boolean) {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        prefs.edit()
            .putBoolean(KEY_NEVER_SHOW_AGAIN, neverShow)
            .apply()
    }

    fun shouldNeverShowOnboardingAgain(context: Context): Boolean {
        val prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        return prefs.getBoolean(KEY_NEVER_SHOW_AGAIN, false)
    }

    // Onboarding g√∂sterilmeli mi? (hem ilk sefer hem de "bir daha g√∂sterme" kontrol√º)
    fun shouldShowOnboarding(context: Context): Boolean {
        return isFirstTime(context) && !shouldNeverShowOnboardingAgain(context)
    }

    /**
     * üî• Onboarding sƒ±rasƒ±nda lokale kaydedilen ila√ßlarƒ± Firebase'e sync et
     * Bu fonksiyon onboarding tamamlandƒ±ƒüƒ±nda √ßaƒürƒ±lmalƒ±
     */
    suspend fun syncLocalRemindersToFirebase(context: Context) {
        try {
            val prefs = context.getSharedPreferences("local_reminders", Context.MODE_PRIVATE)
            val remindersJson = prefs.getString("reminders", "[]") ?: "[]"

            val remindersArray = try {
                JSONArray(remindersJson)
            } catch (e: Exception) {
                Log.e("OnboardingPreferences", "‚ùå JSON parse hatasƒ±", e)
                return
            }

            if (remindersArray.length() == 0) {
                Log.d("OnboardingPreferences", "‚ÑπÔ∏è Sync edilecek lokal ila√ß yok")
                return
            }

            val medicineRepository = MedicineRepository()
            var syncedCount = 0

            for (i in 0 until remindersArray.length()) {
                try {
                    val reminderObj = remindersArray.getJSONObject(i)

                    // Zamanlarƒ± parse et
                    val timesArray = reminderObj.getJSONArray("times")
                    val times = mutableListOf<String>()
                    for (j in 0 until timesArray.length()) {
                        times.add(timesArray.getString(j))
                    }

                    // Tarihleri parse et
                    val datesArray = reminderObj.optJSONArray("selectedDates") ?: JSONArray()
                    val selectedDates = mutableListOf<String>()
                    for (j in 0 until datesArray.length()) {
                        selectedDates.add(datesArray.getString(j))
                    }

                    // Frequency value hesapla
                    val frequency = reminderObj.getString("frequency")
                    val xValue = reminderObj.optInt("xValue", 1)
                    val frequencyValue = when (frequency) {
                        "Her g√ºn" -> 1
                        "G√ºn a≈üƒ±rƒ±" -> 2
                        "Haftada bir" -> 7
                        "15 g√ºnde bir" -> 15
                        "Ayda bir" -> 30
                        "Her X g√ºnde bir" -> xValue
                        else -> 1
                    }

                    val medicine = Medicine(
                        id = "", // Repository tarafƒ±ndan olu≈üturulacak
                        userId = "", // Repository tarafƒ±ndan olu≈üturulacak
                        name = reminderObj.getString("name"),
                        dosage = reminderObj.optString("dosage", ""),
                        unit = reminderObj.optString("unit", "hap"),
                        form = "tablet",
                        times = times,
                        days = if (frequency == "ƒ∞stediƒüim tarihlerde") selectedDates else emptyList(),
                        frequency = frequency,
                        frequencyValue = frequencyValue,
                        startDate = reminderObj.optLong("startDate", System.currentTimeMillis()),
                        endDate = null,
                        stockCount = 0,
                        boxSize = 0,
                        notes = "",
                        reminderEnabled = true,
                        reminderName = reminderObj.getString("name"),
                        icon = "üíä"
                    )

                    val savedMedicine = medicineRepository.addMedicine(medicine)

                    if (savedMedicine != null) {
                        // Alarmlarƒ± planla
                        ReminderScheduler.scheduleReminders(context, savedMedicine)
                        syncedCount++
                        Log.d("OnboardingPreferences", "‚úÖ Firebase'e sync edildi: ${savedMedicine.name}")
                    } else {
                        Log.e("OnboardingPreferences", "‚ùå Firebase'e kayƒ±t ba≈üarƒ±sƒ±z: ${medicine.name}")
                    }
                } catch (e: Exception) {
                    Log.e("OnboardingPreferences", "‚ùå ƒ∞la√ß sync hatasƒ±: ${e.message}", e)
                }
            }

            // Sync ba≈üarƒ±lƒ± olduysa lokal verileri temizle
            if (syncedCount > 0) {
                prefs.edit().remove("reminders").apply()
                Log.d("OnboardingPreferences", "üî• $syncedCount ila√ß Firebase'e sync edildi ve lokal veriler temizlendi")
            }
        } catch (e: Exception) {
            Log.e("OnboardingPreferences", "‚ùå Sync hatasƒ±", e)
        }
    }
}
// ============================================================================
// FILE: ThemePreferences.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/data/ThemePreferences.kt
// [45 of 122]
// ============================================================================

package com.bardino.dozi.core.data

import android.content.Context
import androidx.datastore.core.DataStore
import androidx.datastore.preferences.core.Preferences
import androidx.datastore.preferences.core.edit
import androidx.datastore.preferences.core.stringPreferencesKey
import androidx.datastore.preferences.preferencesDataStore
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.map

/**
 * üé® Tema Tercih Y√∂netimi (DataStore)
 *
 * Kullanƒ±cƒ±nƒ±n tema tercihi (light/dark/system) lokal olarak saklanƒ±r
 * ve ger√ßek zamanlƒ± olarak uygulamada kullanƒ±lƒ±r.
 */

// DataStore Extension
private val Context.themeDataStore: DataStore<Preferences> by preferencesDataStore(name = "theme_preferences")

object ThemePreferences {

    private val THEME_KEY = stringPreferencesKey("theme_mode")

    /**
     * Tema tercihini kaydet
     * @param theme "light", "dark" veya "system"
     */
    suspend fun saveTheme(context: Context, theme: String) {
        context.themeDataStore.edit { preferences ->
            preferences[THEME_KEY] = theme
        }
    }

    /**
     * Tema tercihini oku (Flow)
     * Default: "system" (sistem ayarƒ±nƒ± takip et)
     */
    fun getThemeFlow(context: Context): Flow<String> {
        return context.themeDataStore.data.map { preferences ->
            preferences[THEME_KEY] ?: "system"
        }
    }

    /**
     * Tema tercihini senkron oku
     * Not: Bu suspend function, coroutine i√ßinde √ßaƒürƒ±lmalƒ±
     */
    suspend fun getTheme(context: Context): String {
        var theme = "system"
        context.themeDataStore.data.collect { preferences ->
            theme = preferences[THEME_KEY] ?: "system"
        }
        return theme
    }
}

// ============================================================================
// FILE: DoziError.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/error/DoziError.kt
// [46 of 122]
// ============================================================================

package com.bardino.dozi.core.error

import com.google.firebase.FirebaseException
import com.google.firebase.FirebaseNetworkException
import com.google.firebase.auth.FirebaseAuthException
import com.google.firebase.firestore.FirebaseFirestoreException
import java.io.IOException
import java.net.UnknownHostException

/**
 * üö® Merkezi Hata Y√∂netimi Sistemi
 *
 * Uygulamadaki t√ºm hatalarƒ± tek bir sealed class hiyerar≈üisiyle y√∂netir.
 * Bu sayede:
 * - Tutarlƒ± hata mesajlarƒ±
 * - Kullanƒ±cƒ± dostu mesajlar
 * - Kolay hata takibi
 * - Test edilebilir error handling
 */
sealed class DoziError {
    abstract val message: String
    abstract val userMessage: String
    abstract fun log()

    /**
     * üåê Aƒü Hatalarƒ±
     */
    data class Network(
        override val message: String,
        val cause: Throwable? = null
    ) : DoziError() {
        override val userMessage: String
            get() = "ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin"

        override fun log() {
            android.util.Log.e("DoziError.Network", message, cause)
        }
    }

    /**
     * üî• Firebase Hatalarƒ±
     */
    data class Firebase(
        val code: String,
        override val message: String,
        val cause: FirebaseException? = null
    ) : DoziError() {
        override val userMessage: String
            get() = when (code) {
                "permission-denied" -> "Bu i≈ülem i√ßin yetkiniz yok"
                "not-found" -> "ƒ∞stenen veri bulunamadƒ±"
                "already-exists" -> "Bu veri zaten mevcut"
                "unauthenticated" -> "L√ºtfen giri≈ü yapƒ±n"
                "unavailable" -> "Sunucu ≈üu anda kullanƒ±lamƒ±yor"
                else -> "Bir hata olu≈ütu. L√ºtfen tekrar deneyin"
            }

        override fun log() {
            android.util.Log.e("DoziError.Firebase", "[$code] $message", cause)
        }
    }

    /**
     * üîê Kimlik Doƒürulama Hatalarƒ±
     */
    data class Authentication(
        val code: String,
        override val message: String,
        val cause: FirebaseAuthException? = null
    ) : DoziError() {
        override val userMessage: String
            get() = when (code) {
                "invalid-email" -> "Ge√ßersiz email adresi"
                "user-disabled" -> "Hesabƒ±nƒ±z devre dƒ±≈üƒ± bƒ±rakƒ±lmƒ±≈ü"
                "user-not-found" -> "Kullanƒ±cƒ± bulunamadƒ±"
                "wrong-password" -> "Hatalƒ± ≈üifre"
                "email-already-in-use" -> "Bu email zaten kullanƒ±mda"
                "weak-password" -> "≈ûifre √ßok zayƒ±f"
                "network-request-failed" -> "ƒ∞nternet baƒülantƒ±sƒ± yok"
                else -> "Giri≈ü yapƒ±lƒ±rken hata olu≈ütu"
            }

        override fun log() {
            android.util.Log.e("DoziError.Auth", "[$code] $message", cause)
        }
    }

    /**
     * ‚úÖ Doƒürulama Hatalarƒ±
     */
    data class Validation(
        val field: String,
        val reason: String,
        override val message: String
    ) : DoziError() {
        override val userMessage: String = ""
            get() = when (field) {
                "medicine_name" -> "ƒ∞la√ß adƒ± bo≈ü olamaz"
                "dosage" -> "Doz bilgisi gerekli"
                "time" -> "Ge√ßerli bir saat girin"
                "email" -> "Ge√ßerli bir email girin"
                "password" -> "≈ûifre en az 6 karakter olmalƒ±"
                else -> "L√ºtfen t√ºm alanlarƒ± doldurun"
            }

        override fun log() {
            android.util.Log.w("DoziError.Validation", "[$field] $reason: $message")
        }
    }

    /**
     * üîí ƒ∞zin Hatalarƒ±
     */
    data class Permission(
        val permission: String,
        override val message: String
    ) : DoziError() {
        override val userMessage: String
            get() = when (permission) {
                "POST_NOTIFICATIONS" -> "Bildirim izni gerekli. L√ºtfen ayarlardan izin verin"
                "SCHEDULE_EXACT_ALARM" -> "Tam zamanlƒ± alarm izni gerekli"
                "ACCESS_FINE_LOCATION" -> "Konum izni gerekli"
                "CAMERA" -> "Kamera izni gerekli"
                else -> "Bu √∂zellik i√ßin izin gerekli"
            }

        override fun log() {
            android.util.Log.w("DoziError.Permission", "[$permission] $message")
        }
    }

    /**
     * üóÑÔ∏è Veritabanƒ± Hatalarƒ±
     */
    data class Database(
        override val message: String,
        val cause: Throwable? = null
    ) : DoziError() {
        override val userMessage: String
            get() = "Veri kaydedilemedi. L√ºtfen tekrar deneyin"

        override fun log() {
            android.util.Log.e("DoziError.Database", message, cause)
        }
    }

    /**
     * üí≥ Billing Hatalarƒ±
     */
    data class Billing(
        val code: Int,
        override val message: String
    ) : DoziError() {
        override val userMessage: String
            get() = when (code) {
                1 -> "Satƒ±n alma iptal edildi"
                2 -> "Hizmet kullanƒ±lamƒ±yor"
                3 -> "Billing servisi baƒülanamadƒ±"
                4 -> "√úr√ºn mevcut deƒüil"
                5 -> "Ge√ßersiz √ºr√ºn t√ºr√º"
                6 -> "Hata: ƒ∞≈ülem ba≈üarƒ±sƒ±z"
                7 -> "√úr√ºn zaten sahipsiniz"
                8 -> "√úr√ºn satƒ±n alƒ±namƒ±yor"
                else -> "Satƒ±n alma hatasƒ±"
            }

        override fun log() {
            android.util.Log.e("DoziError.Billing", "[$code] $message")
        }
    }

    /**
     * ‚ùì Bilinmeyen Hatalar
     */
    data class Unknown(
        override val message: String,
        val cause: Throwable? = null
    ) : DoziError() {
        override val userMessage: String
            get() = "Beklenmeyen bir hata olu≈ütu"

        override fun log() {
            android.util.Log.e("DoziError.Unknown", message, cause)
        }
    }

    companion object {
        /**
         * Exception'dan DoziError olu≈ütur
         */
        fun from(exception: Throwable): DoziError {
            return when (exception) {
                is UnknownHostException, is IOException -> Network(
                    message = exception.message ?: "Network error",
                    cause = exception
                )

                is FirebaseNetworkException -> Network(
                    message = "Firebase network error",
                    cause = exception
                )

                is FirebaseAuthException -> Authentication(
                    code = exception.errorCode,
                    message = exception.message ?: "Auth error",
                    cause = exception
                )

                is FirebaseFirestoreException -> Firebase(
                    code = exception.code.name,
                    message = exception.message ?: "Firestore error",
                    cause = exception
                )

                is FirebaseException -> Firebase(
                    code = "unknown",
                    message = exception.message ?: "Firebase error",
                    cause = exception
                )

                else -> Unknown(
                    message = exception.message ?: "Unknown error",
                    cause = exception
                )
            }
        }
    }
}

/**
 * üì¶ Result Wrapper - Ba≈üarƒ± veya Hata
 */
sealed class Result<out T> {
    data class Success<T>(val data: T) : Result<T>()
    data class Error(val error: DoziError) : Result<Nothing>()

    fun getOrNull(): T? = when (this) {
        is Success -> data
        is Error -> null
    }

    fun errorOrNull(): DoziError? = when (this) {
        is Success -> null
        is Error -> error
    }

    inline fun onSuccess(action: (T) -> Unit): Result<T> {
        if (this is Success) action(data)
        return this
    }

    inline fun onError(action: (DoziError) -> Unit): Result<T> {
        if (this is Error) action(error)
        return this
    }
}

/**
 * Extension: Try-catch bloƒüunu Result'a d√∂n√º≈üt√ºr
 */
inline fun <T> resultOf(block: () -> T): Result<T> {
    return try {
        Result.Success(block())
    } catch (e: Exception) {
        val error = DoziError.from(e)
        error.log()
        Result.Error(error)
    }
}

/**
 * Extension: Suspend fonksiyonlar i√ßin try-catch
 */
suspend inline fun <T> suspendResultOf(crossinline block: suspend () -> T): Result<T> {
    return try {
        Result.Success(block())
    } catch (e: Exception) {
        val error = DoziError.from(e)
        error.log()
        Result.Error(error)
    }
}

// ============================================================================
// FILE: PremiumFields.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/premium/PremiumFields.kt
// [47 of 122]
// ============================================================================

package com.bardino.dozi.core.premium

import com.bardino.dozi.core.data.model.PremiumPlanType

/**
 * Tek noktadan premium alanlarƒ±nƒ±n Firestore g√ºncellemelerini √ºretir.
 */
object PremiumFields {
    fun activePlan(
        planType: PremiumPlanType,
        startDate: Long,
        expiryDate: Long,
        isTrial: Boolean = false
    ): Map<String, Any> = mapOf(
        "isPremium" to true,
        "isTrial" to isTrial,
        "planType" to planType.id,
        "premiumStartDate" to startDate,
        "premiumExpiryDate" to expiryDate
    )

    fun reset(): Map<String, Any> = mapOf(
        "isPremium" to false,
        "isTrial" to false,
        "planType" to PremiumPlanType.FREE.id,
        "premiumStartDate" to 0L,
        "premiumExpiryDate" to 0L
    )
}

// ============================================================================
// FILE: PremiumManager.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/premium/PremiumManager.kt
// [48 of 122]
// ============================================================================

package com.bardino.dozi.core.premium

import com.bardino.dozi.core.common.Constants
import com.bardino.dozi.core.data.model.PlanCategory
import com.bardino.dozi.core.data.model.PremiumPlanType
import com.bardino.dozi.core.data.repository.PremiumRepository
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.map
import javax.inject.Inject
import javax.inject.Singleton

/**
 * üåü Premium Manager
 *
 * Uygulama genelinde premium durumunu ve plan kategorisini kontrol eder.
 * Feature gating (√∂zellik kƒ±sƒ±tlama) i√ßin merkezi y√∂netim saƒülar.
 */
@Singleton
class PremiumManager @Inject constructor(
    private val premiumRepository: PremiumRepository
) {
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üìä PLAN DURUMU KONTROL√ú
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * Real-time premium durumunu Flow olarak d√∂nd√ºr√ºr
     */
    fun isPremiumFlow(): Flow<Boolean> {
        return premiumRepository.observePremiumStatus()
            .map { user ->
                user?.premiumStatus()?.isActive ?: false
            }
    }

    /**
     * Plan kategorisini Flow olarak d√∂nd√ºr√ºr
     */
    fun planCategoryFlow(): Flow<PlanCategory> {
        return premiumRepository.observePremiumStatus()
            .map { user ->
                user?.premiumStatus()?.planType?.category ?: PlanCategory.FREE
            }
    }

    /**
     * Senkron olarak premium durumunu kontrol eder
     */
    suspend fun isPremium(): Boolean {
        val user = premiumRepository.getCurrentPremiumStatus()
        return user?.premiumStatus()?.isActive ?: false
    }

    /**
     * Plan kategorisini d√∂nd√ºr√ºr
     */
    suspend fun getPlanCategory(): PlanCategory {
        val user = premiumRepository.getCurrentPremiumStatus()
        return user?.premiumStatus()?.planType?.category ?: PlanCategory.FREE
    }

    /**
     * Plan tipini d√∂nd√ºr√ºr
     */
    suspend fun getPlanType(): PremiumPlanType {
        val user = premiumRepository.getCurrentPremiumStatus()
        return user?.premiumStatus()?.planType ?: PremiumPlanType.FREE
    }

    /**
     * Kullanƒ±cƒ± trial s√ºrecinde mi?
     */
    suspend fun isTrial(): Boolean {
        val user = premiumRepository.getCurrentPremiumStatus()
        return user?.premiumStatus()?.isTrial == true
    }

    /**
     * Kullanƒ±cƒ± banlandƒ± mƒ±?
     */
    suspend fun isBanned(): Boolean {
        val user = premiumRepository.getCurrentPremiumStatus()
        return user?.isBanned == true
    }

    /**
     * Premium kalan g√ºn sayƒ±sƒ±
     */
    suspend fun daysRemaining(): Int {
        val user = premiumRepository.getCurrentPremiumStatus()
        return user?.premiumStatus()?.daysRemaining() ?: 0
    }

    /**
     * Ekstra veya √ºst√º m√º?
     */
    suspend fun isEkstraOrAbove(): Boolean {
        val category = getPlanCategory()
        return category == PlanCategory.EKSTRA || category == PlanCategory.AILE
    }

    /**
     * Aile planƒ± mƒ±?
     */
    suspend fun isAile(): Boolean {
        return getPlanCategory() == PlanCategory.AILE
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üìè Lƒ∞Mƒ∞T KONTROL METODLARƒ∞
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * ƒ∞la√ß limitini d√∂nd√ºr√ºr
     * -1 = sƒ±nƒ±rsƒ±z
     */
    suspend fun getMedicineLimit(): Int {
        return when (getPlanCategory()) {
            PlanCategory.FREE -> Constants.FREE_MEDICINE_LIMIT
            PlanCategory.EKSTRA, PlanCategory.AILE -> Constants.UNLIMITED
        }
    }

    /**
     * Hatƒ±rlatma limitini d√∂nd√ºr√ºr (time slot bazlƒ±)
     * -1 = sƒ±nƒ±rsƒ±z
     */
    suspend fun getReminderLimit(): Int {
        return when (getPlanCategory()) {
            PlanCategory.FREE -> Constants.FREE_REMINDER_LIMIT
            PlanCategory.EKSTRA, PlanCategory.AILE -> Constants.UNLIMITED
        }
    }

    /**
     * Badi limitini d√∂nd√ºr√ºr
     * -1 = sƒ±nƒ±rsƒ±z
     */
    suspend fun getBadiLimit(): Int {
        return when (getPlanCategory()) {
            PlanCategory.FREE -> 0
            PlanCategory.EKSTRA -> Constants.EKSTRA_BADI_LIMIT
            PlanCategory.AILE -> Constants.UNLIMITED
        }
    }

    /**
     * Daha fazla ila√ß ekleyebilir mi?
     */
    suspend fun canAddMoreMedicines(currentCount: Int): Boolean {
        val limit = getMedicineLimit()
        return limit == Constants.UNLIMITED || currentCount < limit
    }

    /**
     * Daha fazla hatƒ±rlatma ekleyebilir mi?
     */
    suspend fun canAddMoreReminders(currentCount: Int): Boolean {
        val limit = getReminderLimit()
        return limit == Constants.UNLIMITED || currentCount < limit
    }

    /**
     * Daha fazla badi ekleyebilir mi?
     */
    suspend fun canAddMoreBadis(currentCount: Int): Boolean {
        val limit = getBadiLimit()
        return limit == Constants.UNLIMITED || currentCount < limit
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üéØ FEATURE GATES (√ñzellik Kƒ±sƒ±tlamalarƒ±)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * √ñzel bildirim sesi kullanabilir mi? (Ekstra+)
     */
    suspend fun canUseCustomNotificationSound(): Boolean = isEkstraOrAbove()

    /**
     * Geli≈ümi≈ü istatistikler g√∂rebilir mi? (Ekstra+)
     */
    suspend fun canViewAdvancedStats(): Boolean = isEkstraOrAbove()

    /**
     * Bulut yedekleme kullanabilir mi? (Ekstra+)
     */
    suspend fun canUseCloudBackup(): Boolean = isEkstraOrAbove()

    /**
     * Akƒ±llƒ± hatƒ±rlatmalar kullanabilir mi? (Ekstra+)
     */
    suspend fun canUseSmartReminders(): Boolean = isEkstraOrAbove()

    /**
     * Sesli hatƒ±rlatƒ±cƒ± kullanabilir mi? (Ekstra+)
     */
    suspend fun canUseVoiceReminders(): Boolean = isEkstraOrAbove()

    /**
     * Kritik bildirimler kullanabilir mi? (Ekstra+)
     */
    suspend fun canUseCriticalNotifications(): Boolean = isEkstraOrAbove()

    /**
     * Tema √∂zelle≈ütirme yapabilir mi? (Ekstra+)
     */
    suspend fun canUseThemeCustomization(): Boolean = isEkstraOrAbove()

    /**
     * √ñncelikli destek alabilir mi? (Ekstra+)
     */
    suspend fun hasPrioritySupport(): Boolean = isEkstraOrAbove()

    /**
     * Badi sistemi kullanabilir mi? (Ekstra: 1, Aile: sƒ±nƒ±rsƒ±z)
     */
    suspend fun canUseBadiSystem(): Boolean {
        val category = getPlanCategory()
        return category == PlanCategory.EKSTRA || category == PlanCategory.AILE
    }

    /**
     * Birden fazla badi ekleyebilir mi? (Sadece Aile)
     */
    suspend fun canUseMultipleBadis(): Boolean = isAile()

    /**
     * Aile kontrol paneli kullanabilir mi? (Sadece Aile)
     */
    suspend fun canUseFamilyDashboard(): Boolean = isAile()

    /**
     * Aile takibi kullanabilir mi? (Sadece Aile)
     */
    suspend fun canUseFamilyTracking(): Boolean = isAile()

    /**
     * Premium √∂zelliƒüe eri≈üimi kontrol et
     */
    suspend fun checkPremiumFeature(feature: PremiumFeature): Boolean {
        if (isBanned()) return false

        return when (feature) {
            // Ekstra+ √∂zellikleri
            PremiumFeature.CUSTOM_NOTIFICATION_SOUND -> canUseCustomNotificationSound()
            PremiumFeature.ADVANCED_STATS -> canViewAdvancedStats()
            PremiumFeature.CLOUD_BACKUP -> canUseCloudBackup()
            PremiumFeature.SMART_REMINDERS -> canUseSmartReminders()
            PremiumFeature.VOICE_REMINDERS -> canUseVoiceReminders()
            PremiumFeature.CRITICAL_NOTIFICATIONS -> canUseCriticalNotifications()
            PremiumFeature.THEME_CUSTOMIZATION -> canUseThemeCustomization()
            PremiumFeature.PRIORITY_SUPPORT -> hasPrioritySupport()
            PremiumFeature.UNLIMITED_MEDICINES -> isEkstraOrAbove()
            PremiumFeature.UNLIMITED_REMINDERS -> isEkstraOrAbove()

            // Badi √∂zellikleri
            PremiumFeature.BADI_SYSTEM -> canUseBadiSystem()
            PremiumFeature.MULTIPLE_BADIS -> canUseMultipleBadis()

            // Aile √∂zellikleri
            PremiumFeature.FAMILY_TRACKING -> canUseFamilyTracking()
            PremiumFeature.FAMILY_DASHBOARD -> canUseFamilyDashboard()
        }
    }

    /**
     * √ñzelliƒüin hangi planda a√ßƒ±ldƒ±ƒüƒ±nƒ± d√∂nd√ºr√ºr
     */
    fun getRequiredPlanForFeature(feature: PremiumFeature): PlanCategory {
        return when (feature) {
            // Sadece Aile planƒ±nda olan √∂zellikler
            PremiumFeature.FAMILY_TRACKING,
            PremiumFeature.FAMILY_DASHBOARD,
            PremiumFeature.MULTIPLE_BADIS -> PlanCategory.AILE

            // Ekstra ve √ºst√ºnde olan √∂zellikler
            else -> PlanCategory.EKSTRA
        }
    }

    /**
     * Premium √∂zellik i√ßin kullanƒ±cƒ±ya mesaj g√∂ster
     */
    fun getPremiumFeatureMessage(feature: PremiumFeature): String {
        val requiredPlan = getRequiredPlanForFeature(feature)
        val planName = requiredPlan.toTurkish()

        return when (feature) {
            PremiumFeature.CUSTOM_NOTIFICATION_SOUND ->
                "√ñzel bildirim sesleri $planName'ya √∂zeldir"

            PremiumFeature.ADVANCED_STATS ->
                "Geli≈ümi≈ü istatistikler i√ßin $planName'ya katƒ±l"

            PremiumFeature.CLOUD_BACKUP ->
                "Bulut yedekleme √∂zelliƒüi $planName'da"

            PremiumFeature.SMART_REMINDERS ->
                "Akƒ±llƒ± hatƒ±rlatmalar i√ßin $planName'ya ge√ß"

            PremiumFeature.VOICE_REMINDERS ->
                "Sesli hatƒ±rlatƒ±cƒ±lar $planName'ya √∂zeldir"

            PremiumFeature.CRITICAL_NOTIFICATIONS ->
                "Kritik bildirimler i√ßin $planName'ya ge√ß"

            PremiumFeature.THEME_CUSTOMIZATION ->
                "Tema √∂zelle≈ütirme $planName'da m√ºmk√ºn"

            PremiumFeature.PRIORITY_SUPPORT ->
                "√ñncelikli destek $planName √ºyelerine √∂zeldir"

            PremiumFeature.UNLIMITED_MEDICINES ->
                "Sƒ±nƒ±rsƒ±z ila√ß ekleme i√ßin $planName'ya ge√ß"

            PremiumFeature.UNLIMITED_REMINDERS ->
                "Sƒ±nƒ±rsƒ±z hatƒ±rlatma i√ßin $planName'ya ge√ß"

            PremiumFeature.BADI_SYSTEM ->
                "Badi sistemi i√ßin $planName'ya katƒ±l"

            PremiumFeature.MULTIPLE_BADIS ->
                "Birden fazla badi i√ßin $planName'ya ge√ß"

            PremiumFeature.FAMILY_TRACKING ->
                "Aile takibi $planName ile m√ºmk√ºn"

            PremiumFeature.FAMILY_DASHBOARD ->
                "Aile kontrol paneli $planName'ya √∂zeldir"
        }
    }
}

/**
 * üíé Premium √ñzellikler Enum
 */
enum class PremiumFeature(val displayName: String) {
    // Ekstra+ √∂zellikleri
    CUSTOM_NOTIFICATION_SOUND("√ñzel Bildirim Sesi"),
    ADVANCED_STATS("Geli≈ümi≈ü ƒ∞statistikler"),
    CLOUD_BACKUP("Bulut Yedekleme"),
    SMART_REMINDERS("Akƒ±llƒ± Hatƒ±rlatmalar"),
    VOICE_REMINDERS("Sesli Hatƒ±rlatƒ±cƒ±lar"),
    CRITICAL_NOTIFICATIONS("Kritik Bildirimler"),
    THEME_CUSTOMIZATION("Tema √ñzelle≈ütirme"),
    PRIORITY_SUPPORT("√ñncelikli Destek"),
    UNLIMITED_MEDICINES("Sƒ±nƒ±rsƒ±z ƒ∞la√ß"),
    UNLIMITED_REMINDERS("Sƒ±nƒ±rsƒ±z Hatƒ±rlatma"),

    // Badi √∂zellikleri
    BADI_SYSTEM("Badi Sistemi"),
    MULTIPLE_BADIS("√áoklu Badi"),

    // Aile √∂zellikleri
    FAMILY_TRACKING("Aile Takibi"),
    FAMILY_DASHBOARD("Aile Kontrol Paneli")
}

/**
 * üó∫Ô∏è Feature Matrix
 * Hangi √∂zelliƒüin hangi planlarda a√ßƒ±k olduƒüunu tanƒ±mlar
 */
object FeatureMatrix {
    private val matrix: Map<PremiumFeature, Set<PlanCategory>> = mapOf(
        // Ekstra ve Aile'de a√ßƒ±k
        PremiumFeature.CUSTOM_NOTIFICATION_SOUND to setOf(PlanCategory.EKSTRA, PlanCategory.AILE),
        PremiumFeature.ADVANCED_STATS to setOf(PlanCategory.EKSTRA, PlanCategory.AILE),
        PremiumFeature.CLOUD_BACKUP to setOf(PlanCategory.EKSTRA, PlanCategory.AILE),
        PremiumFeature.SMART_REMINDERS to setOf(PlanCategory.EKSTRA, PlanCategory.AILE),
        PremiumFeature.VOICE_REMINDERS to setOf(PlanCategory.EKSTRA, PlanCategory.AILE),
        PremiumFeature.CRITICAL_NOTIFICATIONS to setOf(PlanCategory.EKSTRA, PlanCategory.AILE),
        PremiumFeature.THEME_CUSTOMIZATION to setOf(PlanCategory.EKSTRA, PlanCategory.AILE),
        PremiumFeature.PRIORITY_SUPPORT to setOf(PlanCategory.EKSTRA, PlanCategory.AILE),
        PremiumFeature.UNLIMITED_MEDICINES to setOf(PlanCategory.EKSTRA, PlanCategory.AILE),
        PremiumFeature.UNLIMITED_REMINDERS to setOf(PlanCategory.EKSTRA, PlanCategory.AILE),
        PremiumFeature.BADI_SYSTEM to setOf(PlanCategory.EKSTRA, PlanCategory.AILE),

        // Sadece Aile'de a√ßƒ±k
        PremiumFeature.MULTIPLE_BADIS to setOf(PlanCategory.AILE),
        PremiumFeature.FAMILY_TRACKING to setOf(PlanCategory.AILE),
        PremiumFeature.FAMILY_DASHBOARD to setOf(PlanCategory.AILE)
    )

    /**
     * √ñzellik belirtilen planda a√ßƒ±k mƒ±?
     */
    fun isFeatureAvailable(feature: PremiumFeature, category: PlanCategory): Boolean {
        return matrix[feature]?.contains(category) ?: false
    }

    /**
     * Belirtilen planda a√ßƒ±k olan t√ºm √∂zellikleri d√∂nd√ºr√ºr
     */
    fun getFeaturesForPlan(category: PlanCategory): List<PremiumFeature> {
        return matrix.filter { it.value.contains(category) }.keys.toList()
    }

    /**
     * √ñzelliƒüin a√ßƒ±k olduƒüu minimum planƒ± d√∂nd√ºr√ºr
     */
    fun getMinimumPlanForFeature(feature: PremiumFeature): PlanCategory {
        val plans = matrix[feature] ?: return PlanCategory.AILE
        return when {
            plans.contains(PlanCategory.FREE) -> PlanCategory.FREE
            plans.contains(PlanCategory.EKSTRA) -> PlanCategory.EKSTRA
            else -> PlanCategory.AILE
        }
    }
}

// ============================================================================
// FILE: SyncManager.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/sync/SyncManager.kt
// [49 of 122]
// ============================================================================

package com.bardino.dozi.core.sync

import android.content.Context
import android.util.Log
import com.bardino.dozi.core.data.local.DoziDatabase
import com.bardino.dozi.core.data.local.entity.SyncActionType
import com.bardino.dozi.core.data.local.entity.SyncQueueEntity
import com.bardino.dozi.core.data.model.Medicine
import com.bardino.dozi.core.utils.NetworkUtils
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import com.google.gson.Gson
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.tasks.await
import kotlinx.coroutines.withContext

/**
 * Manages offline sync queue for medicine operations
 * Implements offline-first approach with conflict resolution
 */
class SyncManager(private val context: Context) {

    private val db = DoziDatabase.getDatabase(context)
    private val syncQueueDao = db.syncQueueDao()
    private val firestore = FirebaseFirestore.getInstance()
    private val auth = FirebaseAuth.getInstance()
    private val gson = Gson()

    companion object {
        private const val TAG = "SyncManager"
        private const val MAX_RETRIES = 5
    }

    /**
     * Add a medicine add operation to the sync queue
     */
    suspend fun queueMedicineAdd(medicine: Medicine): Long {
        val userId = auth.currentUser?.uid ?: return -1

        val entity = SyncQueueEntity(
            actionType = SyncActionType.MEDICINE_ADDED,
            dataJson = gson.toJson(medicine),
            userId = userId,
            createdAt = System.currentTimeMillis()
        )

        val id = syncQueueDao.insert(entity)
        Log.d(TAG, "‚úÖ Medicine ADD queued: ${medicine.name} (queueId: $id)")

        // Try immediate sync if online
        if (NetworkUtils.isNetworkAvailable(context)) {
            processPendingSync()
        }

        return id
    }

    /**
     * Add a medicine update operation to the sync queue
     */
    suspend fun queueMedicineUpdate(medicine: Medicine): Long {
        val userId = auth.currentUser?.uid ?: return -1

        val entity = SyncQueueEntity(
            actionType = SyncActionType.MEDICINE_UPDATED,
            dataJson = gson.toJson(medicine),
            userId = userId,
            createdAt = System.currentTimeMillis()
        )

        val id = syncQueueDao.insert(entity)
        Log.d(TAG, "‚úÖ Medicine UPDATE queued: ${medicine.name} (queueId: $id)")

        // Try immediate sync if online
        if (NetworkUtils.isNetworkAvailable(context)) {
            processPendingSync()
        }

        return id
    }

    /**
     * Add a medicine delete operation to the sync queue
     */
    suspend fun queueMedicineDelete(medicineId: String): Long {
        val userId = auth.currentUser?.uid ?: return -1

        // Store just the ID for deletion
        val dataJson = gson.toJson(mapOf("medicineId" to medicineId))

        val entity = SyncQueueEntity(
            actionType = SyncActionType.MEDICINE_DELETED,
            dataJson = dataJson,
            userId = userId,
            createdAt = System.currentTimeMillis()
        )

        val id = syncQueueDao.insert(entity)
        Log.d(TAG, "‚úÖ Medicine DELETE queued: $medicineId (queueId: $id)")

        // Try immediate sync if online
        if (NetworkUtils.isNetworkAvailable(context)) {
            processPendingSync()
        }

        return id
    }

    /**
     * Process all pending sync operations
     * @return Number of successfully processed items
     */
    suspend fun processPendingSync(): Int = withContext(Dispatchers.IO) {
        val userId = auth.currentUser?.uid
        if (userId == null) {
            Log.w(TAG, "‚ö†Ô∏è Cannot sync: user not authenticated")
            return@withContext 0
        }

        if (!NetworkUtils.isNetworkAvailable(context)) {
            Log.w(TAG, "‚ö†Ô∏è Cannot sync: no network available")
            return@withContext 0
        }

        val pendingItems = syncQueueDao.getPendingWithRetries(userId)

        if (pendingItems.isEmpty()) {
            Log.d(TAG, "‚ÑπÔ∏è No pending sync items")
            return@withContext 0
        }

        Log.d(TAG, "üîÑ Processing ${pendingItems.size} pending sync items...")

        var successCount = 0

        for (item in pendingItems) {
            try {
                val success = when (item.actionType) {
                    SyncActionType.MEDICINE_ADDED -> processMedicineAdd(item)
                    SyncActionType.MEDICINE_UPDATED -> processMedicineUpdate(item)
                    SyncActionType.MEDICINE_DELETED -> processMedicineDelete(item)
                    else -> {
                        Log.w(TAG, "‚ö†Ô∏è Unknown action type: ${item.actionType}")
                        false
                    }
                }

                if (success) {
                    syncQueueDao.deleteById(item.id)
                    successCount++
                    Log.d(TAG, "‚úÖ Sync successful for item ${item.id}")
                } else {
                    syncQueueDao.incrementRetryCount(
                        id = item.id,
                        attemptTime = System.currentTimeMillis(),
                        error = "Sync failed"
                    )
                    Log.w(TAG, "‚ö†Ô∏è Sync failed for item ${item.id}, retry count: ${item.retryCount + 1}")
                }
            } catch (e: Exception) {
                Log.e(TAG, "‚ùå Error processing sync item ${item.id}", e)
                syncQueueDao.incrementRetryCount(
                    id = item.id,
                    attemptTime = System.currentTimeMillis(),
                    error = e.message
                )
            }
        }

        Log.d(TAG, "üî• Sync complete: $successCount/${pendingItems.size} items processed")
        return@withContext successCount
    }

    /**
     * Process a medicine add operation
     */
    private suspend fun processMedicineAdd(item: SyncQueueEntity): Boolean {
        return try {
            val medicine = gson.fromJson(item.dataJson, Medicine::class.java)
            val collection = getMedicinesCollection() ?: return false

            // Set timestamps
            val medicineToSave = medicine.copy(
                userId = item.userId,
                createdAt = item.createdAt,
                updatedAt = System.currentTimeMillis()
            )

            collection.document(medicine.id).set(medicineToSave).await()
            Log.d(TAG, "‚úÖ Medicine added to Firestore: ${medicine.name}")
            true
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Failed to add medicine to Firestore", e)
            false
        }
    }

    /**
     * Process a medicine update operation with conflict resolution
     */
    private suspend fun processMedicineUpdate(item: SyncQueueEntity): Boolean {
        return try {
            val localMedicine = gson.fromJson(item.dataJson, Medicine::class.java)
            val collection = getMedicinesCollection() ?: return false

            // Get server version for conflict check
            val serverDoc = collection.document(localMedicine.id).get().await()

            if (serverDoc.exists()) {
                val serverMedicine = serverDoc.toObject(Medicine::class.java)

                if (serverMedicine != null) {
                    // Timestamp-based conflict resolution
                    // Local wins if it was queued after server's last update
                    val localUpdateTime = item.createdAt
                    val serverUpdateTime = serverMedicine.updatedAt

                    if (serverUpdateTime > localUpdateTime) {
                        // Server version is newer - need merge
                        Log.d(TAG, "üîÄ Conflict detected: server version newer, merging...")

                        // Smart merge: keep server values for some fields, local for others
                        val mergedMedicine = mergeConflict(localMedicine, serverMedicine, item.createdAt)
                        collection.document(localMedicine.id).set(mergedMedicine).await()
                        Log.d(TAG, "‚úÖ Medicine merged and saved: ${localMedicine.name}")
                    } else {
                        // Local version is newer - safe to overwrite
                        val updatedMedicine = localMedicine.copy(
                            updatedAt = System.currentTimeMillis()
                        )
                        collection.document(localMedicine.id).set(updatedMedicine).await()
                        Log.d(TAG, "‚úÖ Medicine updated in Firestore: ${localMedicine.name}")
                    }
                } else {
                    // Document exists but can't parse - overwrite
                    val updatedMedicine = localMedicine.copy(
                        updatedAt = System.currentTimeMillis()
                    )
                    collection.document(localMedicine.id).set(updatedMedicine).await()
                }
            } else {
                // Document doesn't exist - create it
                val updatedMedicine = localMedicine.copy(
                    updatedAt = System.currentTimeMillis()
                )
                collection.document(localMedicine.id).set(updatedMedicine).await()
            }

            true
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Failed to update medicine in Firestore", e)
            false
        }
    }

    /**
     * Smart merge for conflict resolution
     * Local changes win for most fields, but server wins for certain important fields
     */
    private fun mergeConflict(local: Medicine, server: Medicine, localQueueTime: Long): Medicine {
        return local.copy(
            // Server wins for these (important not to lose server state)
            sharedWithBadis = server.sharedWithBadis,

            // Use latest stockCount (could be updated from multiple devices)
            stockCount = if (server.updatedAt > localQueueTime) server.stockCount else local.stockCount,

            // Always use latest timestamp
            updatedAt = System.currentTimeMillis(),

            // Keep server creation time
            createdAt = server.createdAt
        )
    }

    /**
     * Process a medicine delete operation
     */
    private suspend fun processMedicineDelete(item: SyncQueueEntity): Boolean {
        return try {
            val data = gson.fromJson(item.dataJson, Map::class.java) as Map<String, Any>
            val medicineId = data["medicineId"] as String

            val collection = getMedicinesCollection() ?: return false
            collection.document(medicineId).delete().await()

            Log.d(TAG, "‚úÖ Medicine deleted from Firestore: $medicineId")
            true
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Failed to delete medicine from Firestore", e)
            false
        }
    }

    /**
     * Get current user's medicine collection reference
     */
    private fun getMedicinesCollection() = auth.currentUser?.let { user ->
        firestore.collection("users").document(user.uid).collection("medicines")
    }

    /**
     * Get pending sync count for the current user
     */
    suspend fun getPendingSyncCount(): Int {
        val userId = auth.currentUser?.uid ?: return 0
        return syncQueueDao.getPendingCount(userId)
    }

    /**
     * Clear all pending sync items for the current user
     * Use with caution - this will discard unsent changes
     */
    suspend fun clearPendingSync() {
        val userId = auth.currentUser?.uid ?: return
        syncQueueDao.deleteAllByUser(userId)
        Log.d(TAG, "üóëÔ∏è All pending sync items cleared for user")
    }
}

// ============================================================================
// FILE: SyncWorker.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/sync/SyncWorker.kt
// [50 of 122]
// ============================================================================

package com.bardino.dozi.core.sync

import android.content.Context
import android.util.Log
import androidx.work.Constraints
import androidx.work.CoroutineWorker
import androidx.work.ExistingPeriodicWorkPolicy
import androidx.work.NetworkType
import androidx.work.OneTimeWorkRequestBuilder
import androidx.work.PeriodicWorkRequestBuilder
import androidx.work.WorkManager
import androidx.work.WorkerParameters
import java.util.concurrent.TimeUnit

/**
 * WorkManager worker for background sync operations
 * Handles periodic sync and network-dependent sync
 */
class SyncWorker(
    context: Context,
    params: WorkerParameters
) : CoroutineWorker(context, params) {

    companion object {
        private const val TAG = "SyncWorker"
        private const val PERIODIC_SYNC_WORK_NAME = "dozi_periodic_sync"
        private const val ONE_TIME_SYNC_WORK_NAME = "dozi_one_time_sync"

        /**
         * Schedule periodic background sync
         * Runs every 15 minutes when network is available
         */
        fun schedulePeriodicSync(context: Context) {
            val constraints = Constraints.Builder()
                .setRequiredNetworkType(NetworkType.CONNECTED)
                .build()

            val syncRequest = PeriodicWorkRequestBuilder<SyncWorker>(
                repeatInterval = 15,
                repeatIntervalTimeUnit = TimeUnit.MINUTES,
                flexTimeInterval = 5,
                flexTimeIntervalUnit = TimeUnit.MINUTES
            )
                .setConstraints(constraints)
                .addTag("sync")
                .build()

            WorkManager.getInstance(context)
                .enqueueUniquePeriodicWork(
                    PERIODIC_SYNC_WORK_NAME,
                    ExistingPeriodicWorkPolicy.KEEP,
                    syncRequest
                )

            Log.d(TAG, "‚úÖ Periodic sync scheduled (every 15 minutes)")
        }

        /**
         * Cancel periodic sync
         */
        fun cancelPeriodicSync(context: Context) {
            WorkManager.getInstance(context)
                .cancelUniqueWork(PERIODIC_SYNC_WORK_NAME)
            Log.d(TAG, "üóëÔ∏è Periodic sync cancelled")
        }

        /**
         * Request immediate sync when network becomes available
         */
        fun requestImmediateSync(context: Context) {
            val constraints = Constraints.Builder()
                .setRequiredNetworkType(NetworkType.CONNECTED)
                .build()

            val syncRequest = OneTimeWorkRequestBuilder<SyncWorker>()
                .setConstraints(constraints)
                .addTag("immediate_sync")
                .build()

            WorkManager.getInstance(context)
                .enqueue(syncRequest)

            Log.d(TAG, "‚úÖ Immediate sync requested (will run when network available)")
        }

        /**
         * Force sync now (no network constraint - may fail if offline)
         */
        fun forceSyncNow(context: Context) {
            val syncRequest = OneTimeWorkRequestBuilder<SyncWorker>()
                .addTag("force_sync")
                .build()

            WorkManager.getInstance(context)
                .enqueue(syncRequest)

            Log.d(TAG, "‚úÖ Force sync requested")
        }
    }

    override suspend fun doWork(): Result {
        Log.d(TAG, "üîÑ SyncWorker started")

        return try {
            val syncManager = SyncManager(applicationContext)
            val syncedCount = syncManager.processPendingSync()

            Log.d(TAG, "‚úÖ SyncWorker completed: $syncedCount items synced")

            if (syncedCount > 0 || syncManager.getPendingSyncCount() == 0) {
                Result.success()
            } else {
                // Still have pending items - retry later
                Log.w(TAG, "‚ö†Ô∏è Some items still pending, will retry")
                Result.retry()
            }
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå SyncWorker failed", e)
            Result.retry()
        }
    }
}

// ============================================================================
// FILE: BillingManager.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/billing/BillingManager.kt
// [51 of 122]
// ============================================================================

package com.bardino.dozi.core.billing

import android.app.Activity
import android.content.Context
import android.util.Log
import com.android.billingclient.api.*
import dagger.hilt.android.qualifiers.ApplicationContext
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import javax.inject.Inject
import javax.inject.Singleton

/**
 * üí≥ Billing Manager
 *
 * Manages Google Play Billing operations:
 * - Product queries
 * - Purchase flow
 * - Purchase verification
 * - Subscription management
 *
 * Usage:
 * 1. Initialize billing connection
 * 2. Query available products
 * 3. Launch purchase flow
 * 4. Handle purchase results
 * 5. Verify purchases on server
 */
@Singleton
class BillingManager @Inject constructor(
    @ApplicationContext private val context: Context
) : PurchasesUpdatedListener {

    companion object {
        private const val TAG = "BillingManager"

        // Product IDs - MUST match Google Play Console configuration
        const val PRODUCT_EKSTRA_MONTHLY = "dozi_ekstra_monthly"
        const val PRODUCT_EKSTRA_YEARLY = "dozi_ekstra_yearly"
        const val PRODUCT_AILE_MONTHLY = "dozi_aile_monthly"
        const val PRODUCT_AILE_YEARLY = "dozi_aile_yearly"
    }

    // Billing client instance
    private var billingClient: BillingClient? = null
    private val scope = CoroutineScope(Dispatchers.IO)

    // Available products
    private val _products = MutableStateFlow<List<ProductDetails>>(emptyList())
    val products: StateFlow<List<ProductDetails>> = _products.asStateFlow()

    // Purchase result
    private val _purchaseResult = MutableStateFlow<PurchaseResult?>(null)
    val purchaseResult: StateFlow<PurchaseResult?> = _purchaseResult.asStateFlow()

    // Billing connection state
    private val _isReady = MutableStateFlow(false)
    val isReady: StateFlow<Boolean> = _isReady.asStateFlow()

    /**
     * Initialize billing client and connect
     */
    fun initialize() {
        billingClient = BillingClient.newBuilder(context)
            .setListener(this)
            .enablePendingPurchases()
            .build()

        connectToBilling()
    }

    /**
     * Connect to Google Play Billing
     */
    private fun connectToBilling() {
        billingClient?.startConnection(object : BillingClientStateListener {
            override fun onBillingSetupFinished(billingResult: BillingResult) {
                if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {
                    Log.d(TAG, "‚úÖ Billing client connected")
                    _isReady.value = true
                    queryProducts()
                    queryPurchases() // Check existing purchases
                } else {
                    Log.e(TAG, "‚ùå Billing setup failed: ${billingResult.debugMessage}")
                    _isReady.value = false
                }
            }

            override fun onBillingServiceDisconnected() {
                Log.w(TAG, "‚ö†Ô∏è Billing service disconnected. Retrying...")
                _isReady.value = false
                // Retry connection
                connectToBilling()
            }
        })
    }

    /**
     * Query available subscription products from Google Play
     */
    private fun queryProducts() {
        scope.launch {
            try {
                val productList = listOf(
                    QueryProductDetailsParams.Product.newBuilder()
                        .setProductId(PRODUCT_EKSTRA_MONTHLY)
                        .setProductType(BillingClient.ProductType.SUBS)
                        .build(),
                    QueryProductDetailsParams.Product.newBuilder()
                        .setProductId(PRODUCT_EKSTRA_YEARLY)
                        .setProductType(BillingClient.ProductType.SUBS)
                        .build(),
                    QueryProductDetailsParams.Product.newBuilder()
                        .setProductId(PRODUCT_AILE_MONTHLY)
                        .setProductType(BillingClient.ProductType.SUBS)
                        .build(),
                    QueryProductDetailsParams.Product.newBuilder()
                        .setProductId(PRODUCT_AILE_YEARLY)
                        .setProductType(BillingClient.ProductType.SUBS)
                        .build()
                )

                val params = QueryProductDetailsParams.newBuilder()
                    .setProductList(productList)
                    .build()

                withContext(Dispatchers.Main) {
                    billingClient?.queryProductDetailsAsync(params) { billingResult, productDetailsList ->
                        if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {
                            Log.d(TAG, "‚úÖ Products queried: ${productDetailsList.size}")
                            _products.value = productDetailsList
                        } else {
                            Log.e(TAG, "‚ùå Product query failed: ${billingResult.debugMessage}")
                        }
                    }
                }
            } catch (e: Exception) {
                Log.e(TAG, "‚ùå Exception querying products", e)
            }
        }
    }

    /**
     * Launch purchase flow for a product
     */
    fun launchPurchaseFlow(activity: Activity, productId: String) {
        val product = _products.value.find { it.productId == productId }

        if (product == null) {
            Log.e(TAG, "‚ùå Product not found: $productId")
            _purchaseResult.value = PurchaseResult.Error("Product not found")
            return
        }

        // Get subscription offer token (usually the first one)
        val offerToken = product.subscriptionOfferDetails?.firstOrNull()?.offerToken

        if (offerToken == null) {
            Log.e(TAG, "‚ùå No offer token for product: $productId")
            _purchaseResult.value = PurchaseResult.Error("No subscription offer available")
            return
        }

        val productDetailsParamsList = listOf(
            BillingFlowParams.ProductDetailsParams.newBuilder()
                .setProductDetails(product)
                .setOfferToken(offerToken)
                .build()
        )

        val billingFlowParams = BillingFlowParams.newBuilder()
            .setProductDetailsParamsList(productDetailsParamsList)
            .build()

        billingClient?.launchBillingFlow(activity, billingFlowParams)
    }

    /**
     * Callback when purchases are updated
     */
    override fun onPurchasesUpdated(
        billingResult: BillingResult,
        purchases: List<Purchase>?
    ) {
        when (billingResult.responseCode) {
            BillingClient.BillingResponseCode.OK -> {
                purchases?.forEach { purchase ->
                    handlePurchase(purchase)
                }
            }

            BillingClient.BillingResponseCode.USER_CANCELED -> {
                Log.d(TAG, "‚ö†Ô∏è User canceled purchase")
                _purchaseResult.value = PurchaseResult.Cancelled
            }

            BillingClient.BillingResponseCode.ITEM_ALREADY_OWNED -> {
                Log.d(TAG, "‚úÖ Item already owned")
                _purchaseResult.value = PurchaseResult.AlreadyOwned
            }

            else -> {
                Log.e(TAG, "‚ùå Purchase failed: ${billingResult.debugMessage}")
                _purchaseResult.value = PurchaseResult.Error(billingResult.debugMessage)
            }
        }
    }

    /**
     * Handle successful purchase
     */
    private fun handlePurchase(purchase: Purchase) {
        scope.launch {
            if (purchase.purchaseState == Purchase.PurchaseState.PURCHASED) {
                // Verify purchase on your server here
                Log.d(TAG, "‚úÖ Purchase successful: ${purchase.products}")

                // Acknowledge purchase if not already acknowledged
                if (!purchase.isAcknowledged) {
                    acknowledgePurchase(purchase)
                }

                _purchaseResult.value = PurchaseResult.Success(
                    productId = purchase.products.firstOrNull() ?: "",
                    purchaseToken = purchase.purchaseToken,
                    orderId = purchase.orderId ?: ""
                )
            } else if (purchase.purchaseState == Purchase.PurchaseState.PENDING) {
                Log.d(TAG, "‚è≥ Purchase pending")
                _purchaseResult.value = PurchaseResult.Pending
            }
        }
    }

    /**
     * Acknowledge purchase (required for subscriptions)
     */
    private suspend fun acknowledgePurchase(purchase: Purchase) {
        val acknowledgePurchaseParams = AcknowledgePurchaseParams.newBuilder()
            .setPurchaseToken(purchase.purchaseToken)
            .build()

        withContext(Dispatchers.Main) {
            billingClient?.acknowledgePurchase(acknowledgePurchaseParams) { billingResult ->
                if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {
                    Log.d(TAG, "‚úÖ Purchase acknowledged")
                } else {
                    Log.e(TAG, "‚ùå Acknowledge failed: ${billingResult.debugMessage}")
                }
            }
        }
    }

    /**
     * Query existing purchases (subscriptions)
     */
    fun queryPurchases() {
        scope.launch {
            try {
                val params = QueryPurchasesParams.newBuilder()
                    .setProductType(BillingClient.ProductType.SUBS)
                    .build()

                withContext(Dispatchers.Main) {
                    billingClient?.queryPurchasesAsync(params) { billingResult, purchases ->
                        if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {
                            Log.d(TAG, "‚úÖ Existing purchases: ${purchases.size}")
                            purchases.forEach { purchase ->
                                if (purchase.purchaseState == Purchase.PurchaseState.PURCHASED) {
                                    // User has active subscription
                                    Log.d(TAG, "‚úÖ Active subscription: ${purchase.products}")
                                }
                            }
                        } else {
                            Log.e(TAG, "‚ùå Query purchases failed: ${billingResult.debugMessage}")
                        }
                    }
                }
            } catch (e: Exception) {
                Log.e(TAG, "‚ùå Exception querying purchases", e)
            }
        }
    }

    /**
     * End billing connection
     */
    fun endConnection() {
        billingClient?.endConnection()
        _isReady.value = false
        Log.d(TAG, "üîå Billing connection ended")
    }
}

/**
 * Purchase result sealed class
 */
sealed class PurchaseResult {
    data class Success(
        val productId: String,
        val purchaseToken: String,
        val orderId: String
    ) : PurchaseResult()

    object Pending : PurchaseResult()
    object Cancelled : PurchaseResult()
    object AlreadyOwned : PurchaseResult()
    data class Error(val message: String) : PurchaseResult()
}

// ============================================================================
// FILE: Color.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/theme/Color.kt
// [52 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.theme

import androidx.compose.ui.graphics.Color

/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * üé® DOZI RENK PALETƒ∞ - Pastel & Canlƒ± Saƒülƒ±k Temasƒ±
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 *
 * Bu dosya Dozi saƒülƒ±k uygulamasƒ±nƒ±n renk paletini tanƒ±mlar.
 *
 * üè• HEDEF KULLANICILAR:
 * ‚Ä¢ Ya≈ülƒ±lar - Y√ºksek kontrast, kolay okunabilir
 * ‚Ä¢ Hamileler - Yumu≈üak, sakinle≈ütirici tonlar
 * ‚Ä¢ Sporcular - Enerji veren canlƒ± renkler
 * ‚Ä¢ ƒ∞la√ß kullanan gen√ßler - Modern ve profesyonel
 *
 * ü©µ DOZƒ∞ KARAKTERƒ∞:
 * Dozi karakteri turkuaz (#2DE1FF ‚Üí #009FD1) tondadƒ±r.
 * UI renkleri Dozi'yi √∂ne √ßƒ±karmak i√ßin sƒ±cak tonlarda (lavender/coral/amber)
 * se√ßilmi≈ütir. Turkuaz sadece Dozi karakteri ve √∂zel vurgular i√ßin kullanƒ±lƒ±r.
 *
 * üìò KULLANIM REHBERƒ∞:
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 *
 * üíú DoziPrimary (Lavender)    ‚Üí Ana tema, ba≈ülƒ±klar, se√ßimler, checkbox, radio
 * üß° DoziSecondary (Coral)     ‚Üí √ñnemli butonlar, aksiyonlar, vurgular
 * üçë DoziAccent (Amber)        ‚Üí Uyarƒ±lar, dikkat √ßekici elementler
 * ü©µ DoziCharacter (Turkuaz)   ‚Üí SADECE Dozi karakteri ve √∂zel marker'lar
 *
 * üü¢ SuccessGreen              ‚Üí Ba≈üarƒ± mesajlarƒ±, tamamlama
 * üü° WarningAmber              ‚Üí Uyarƒ±lar, dikkat
 * üî¥ ErrorRed                  ‚Üí Hatalar, kritik durumlar
 * üîµ InfoBlue                  ‚Üí Bilgilendirme
 *
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 */

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üé® ANA MARKA RENKLERƒ∞ (Primary Brand Colors)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * üíú DoziPrimary - Ana tema rengi (Soft Lavender/Purple)
 * Kullanƒ±m: Ba≈ülƒ±klar, se√ßimler, primary butonlar, checkbox, radio, switch
 * Premium ve sakinle≈ütirici etki, saƒülƒ±k sekt√∂r√ºne uygun
 */
val DoziPrimary = Color(0xFFA78BFA)             // Violet 400 - yumu≈üak mor
val DoziPrimaryLight = Color(0xFFDDD6FE)        // Violet 200 - pastel a√ßƒ±k mor
val DoziPrimaryDark = Color(0xFF8B5CF6)         // Violet 500 - koyu mor

/**
 * üß° DoziSecondary - ƒ∞kincil vurgu rengi (Soft Coral/Rose)
 * Kullanƒ±m: √ñnemli aksiyonlar, secondary butonlar, badges, etiketler
 * Sƒ±cak ve enerji veren, hamileler i√ßin yumu≈üak
 */
val DoziSecondary = Color(0xFFFDA4AF)           // Rose 300 - yumu≈üak pembe-coral
val DoziSecondaryLight = Color(0xFFFECDD3)      // Rose 200 - √ßok a√ßƒ±k pembe
val DoziSecondaryDark = Color(0xFFFB7185)       // Rose 400 - canlƒ± coral

/**
 * üçë DoziAccent - Dikkat √ßekici renk (Soft Peach/Amber)
 * Kullanƒ±m: Uyarƒ±lar, √∂zel vurgular, tertiary butonlar, notification badges
 * Enerji veren ama agresif olmayan
 */
val DoziAccent = Color(0xFFFBBF24)              // Amber 400 - yumu≈üak amber
val DoziAccentLight = Color(0xFFFDE68A)         // Amber 200 - a√ßƒ±k sarƒ±
val DoziAccentDark = Color(0xFFF59E0B)          // Amber 500 - koyu amber

/**
 * ü©µ DoziCharacter - Dozi maskot renkleri (Turkuaz/Cyan)
 * ‚ö†Ô∏è √ñZEL KULLANIM: SADECE Dozi karakteri, logo ve √∂zel marker'lar i√ßin!
 * UI elementlerinde KULLANMAYIN - karakterin √∂ne √ßƒ±kmasƒ± i√ßin ayrƒ±ldƒ±
 */
val DoziCharacterLight = Color(0xFF2DE1FF)      // √úst b√∂lge - parlak cyan
val DoziCharacterDark = Color(0xFF009FD1)       // Alt b√∂lge - koyu turkuaz
val DoziCharacterAccent = Color(0xFF00D4FF)     // √ñzel vurgular i√ßin

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ö° DURUM RENKLERƒ∞ (Semantic Colors)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * üü¢ Success - Ba≈üarƒ± durumlarƒ± (Soft Mint Green)
 * SADECE: ‚úì Onay ikonlarƒ±, ba≈üarƒ±lƒ± i≈ülem mesajlarƒ±, tamamlama bildirimleri
 * Turkuazdan farklƒ± - daha ye≈üil tonunda
 */
val SuccessGreen = Color(0xFF6EE7B7)            // Emerald 300 - yumu≈üak mint

/**
 * üü° Warning - Uyarƒ± durumlarƒ± (Soft Gold/Amber)
 * Dikkat gereken durumlar, √∂nemli bilgiler, potansiyel sorunlar
 */
val WarningAmber = Color(0xFFFCD34D)            // Amber 300 - yumu≈üak altƒ±n

/**
 * üî¥ Error - Hata durumlarƒ± (Soft Red-Pink)
 * Hatalar, silme i≈ülemleri, kritik uyarƒ±lar, validation hatalarƒ±
 * Ya≈ülƒ±lar i√ßin agresif olmayan yumu≈üak kƒ±rmƒ±zƒ±
 */
val ErrorRed = Color(0xFFF87171)                // Red 400 - yumu≈üak kƒ±rmƒ±zƒ±

/**
 * üîµ Info - Bilgilendirme (Soft Indigo)
 * Bilgi mesajlarƒ±, ipu√ßlarƒ±, y√∂nlendirmeler
 * Turkuazdan farklƒ± - daha mavi-mor tonunda
 */
val InfoBlue = Color(0xFF818CF8)                // Indigo 400 - yumu≈üak mavi-mor

/**
 * üåü Premium - Dozi Ekstra i√ßin √∂zel renkler (Gold/Pink)
 * Premium kullanƒ±cƒ±lar i√ßin badge, √ßer√ßeve ve vurgular
 */
val DoziGold = Color(0xFFFFD700)                // Altƒ±n rengi - premium badge
val DoziGoldLight = Color(0xFFFFF8DC)           // A√ßƒ±k altƒ±n - premium gradient start
val DoziGoldDark = Color(0xFFDAA520)            // Koyu altƒ±n - premium gradient end
val DoziPink = Color(0xFFFFC0CB)                // Pembe - premium gradient
val DoziRose = Color(0xFFFDA4AF)                // Rose - premium accent

// Premium gradient paleti
val GradientPremium = listOf(Color(0xFFFFD700), Color(0xFFFF8C00))  // Gold ‚Üí Orange
val GradientPremiumSubtle = listOf(Color(0xFFFFF8DC), Color(0xFFFFE4B5))  // Soft gold

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üå´Ô∏è GRƒ∞ SKALASƒ∞ (Neutral Colors)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * üé® Material Design Gray Scale (100 ‚Üí 900)
 * Ya≈ülƒ±lar i√ßin y√ºksek kontrast saƒülamak √ºzere optimize edilmi≈ü
 *
 * 100-300: Arka planlar, kenarlƒ±klar, ayƒ±rƒ±cƒ±lar
 * 400-600: ƒ∞konlar, ikincil metinler, devre dƒ±≈üƒ± durumlar
 * 700-900: Ana metinler, ba≈ülƒ±klar (WCAG AA uyumlu)
 */
val Gray100 = Color(0xFFF5F5F5)                 // En a√ßƒ±k gri - backgrounds
val Gray200 = Color(0xFFEEEEEE)                 // A√ßƒ±k gri - dividers, borders
val Gray300 = Color(0xFFE0E0E0)                 // Orta-a√ßƒ±k gri - disabled backgrounds
val Gray400 = Color(0xFFBDBDBD)                 // Orta gri - disabled text
val Gray500 = Color(0xFF9E9E9E)                 // Orta-koyu gri - placeholders
val Gray600 = Color(0xFF757575)                 // Koyu gri - secondary text
val Gray700 = Color(0xFF616161)                 // Daha koyu - tertiary text
val Gray800 = Color(0xFF424242)                 // √áok koyu - dark mode surfaces
val Gray900 = Color(0xFF212121)                 // En koyu - primary text

// Alias'lar (daha kolay kullanƒ±m i√ßin)
val VeryLightGray = Gray100
val LightGray = Gray200
val MediumGray = Gray500
val DarkGray = Gray700

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìù METƒ∞N RENKLERƒ∞ (Text Colors) - WCAG AA Uyumlu
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Light Mode (Aydƒ±nlƒ±k Mod)
 * Ya≈ülƒ±lar i√ßin 10:1+ kontrast oranƒ±
 */
val TextPrimary = Gray900                       // Ana metinler - en koyu
val TextSecondary = Gray600                     // ƒ∞kincil metinler, a√ßƒ±klamalar
val TextTertiary = Gray500                      // √ú√ß√ºnc√ºl metinler, timestamp'ler

val TextPrimaryLight = TextPrimary              // Alias (geriye uyumluluk)
val TextSecondaryLight = TextSecondary          // Alias (geriye uyumluluk)

/**
 * Dark Mode (Karanlƒ±k Mod)
 */
val TextPrimaryDark = Color(0xFFF9FAFB)        // Ana metinler (dark mode)
val TextSecondaryDark = Color(0xFFD1D5DB)      // ƒ∞kincil metinler (dark mode)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üé® ARKA PLAN RENKLERƒ∞ (Background Colors) - PASTEL & CANLI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Light Mode (Aydƒ±nlƒ±k Mod)
 * Daha canlƒ± ve karakterli arka planlar - pastel tonlarda
 */
val BackgroundLight = Color(0xFFF3E8FF)         // Purple 100 - belirgin lavanta
val BackgroundWarm = Color(0xFFFED7AA)          // Orange 200 - canlƒ± peach
val BackgroundNeutral = Color(0xFFFEF3C7)       // Amber 100 - hafif sarƒ±msƒ±

// Surface renkleri - depth ve hiyerar≈üi i√ßin
val SurfaceLight = Color(0xFFFFFFFF)            // Kartlar - beyaz
val SurfaceElevated = Color(0xFFFEF3C7)         // Y√ºkseltilmi≈ü kartlar - sarƒ± glow
val SurfaceTinted = Color(0xFFFCE7F3)           // √ñzel alanlar - pembe tint
val SurfaceLavender = Color(0xFFEDE9FE)         // Lavender tint - mor tonlu alanlar

/**
 * Dark Mode (Karanlƒ±k Mod)
 */
val BackgroundDark = Color(0xFF121212)          // Ana arka plan (dark mode)
val SurfaceDark = Color(0xFF1E1E1E)             // Kartlar (dark mode)
val SurfaceDarkElevated = Color(0xFF2C2C2E)     // Y√ºkseltilmi≈ü kartlar (dark mode)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üåà GRADƒ∞ENT PALETLERƒ∞ (Gradient Palettes)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Gradient'ler i√ßin √∂nceden tanƒ±mlƒ± renk √ßiftleri
 * Kullanƒ±m: Brush.horizontalGradient(GradientPrimary)
 */
val GradientPrimary = listOf(DoziPrimaryLight, DoziPrimaryDark)
val GradientSecondary = listOf(DoziSecondaryLight, DoziSecondaryDark)
val GradientAccent = listOf(DoziAccentLight, DoziAccentDark)
val GradientCharacter = listOf(DoziCharacterLight, DoziCharacterDark)
val GradientHero = listOf(DoziPrimaryLight, DoziSecondaryLight) // Lavender ‚Üí Coral

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üé≠ YARDIMCI RENKLER (Utility Colors)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Overlay, g√∂lgeler ve √∂zel durumlar i√ßin
 */
val Overlay = Color(0x80000000)                 // %50 siyah g√∂lge (modallar i√ßin)
val OverlayLight = Color(0x40000000)            // %25 siyah g√∂lge (hafif)
val White10 = Color.White.copy(alpha = 0.1f)    // %10 beyaz
val White20 = Color.White.copy(alpha = 0.2f)    // %20 beyaz
val White85 = Color.White.copy(alpha = 0.85f)   // %85 beyaz

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üîÑ GERƒ∞YE UYUMLULUK (Backward Compatibility)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * ‚ö†Ô∏è DEPRECATED - Eski renk isimleri
 * Geriye uyumluluk i√ßin korunuyor, yeni kodda KULLANMAYIN
 * Mevcut kod zamanla yeni isimlere migrate edilecek
 */
@Deprecated("Use DoziPrimary instead (color changed from turkuaz to lavender)", ReplaceWith("DoziPrimary"))
val DoziTurquoise = DoziPrimary

@Deprecated("Use DoziPrimaryLight instead", ReplaceWith("DoziPrimaryLight"))
val DoziTurquoiseLight = DoziPrimaryLight

@Deprecated("Use DoziPrimaryDark instead", ReplaceWith("DoziPrimaryDark"))
val DoziTurquoiseDark = DoziPrimaryDark

@Deprecated("Use DoziSecondary instead (coral is now secondary)", ReplaceWith("DoziSecondary"))
val DoziCoral = DoziSecondary

@Deprecated("Use DoziSecondaryLight instead", ReplaceWith("DoziSecondaryLight"))
val DoziCoralLight = DoziSecondaryLight

@Deprecated("Use DoziSecondaryDark instead", ReplaceWith("DoziSecondaryDark"))
val DoziCoralDark = DoziSecondaryDark

@Deprecated("Use DoziCharacterLight instead (reserved for character only)", ReplaceWith("DoziCharacterLight"))
val DoziBlue = DoziCharacterLight

@Deprecated("Use DoziSecondary instead (misleading name)", ReplaceWith("DoziSecondary"))
val DoziRed = DoziSecondary

@Deprecated("Use DoziSecondary instead (misleading name)", ReplaceWith("DoziSecondary"))
val DoziPurple = DoziSecondary

@Deprecated("Use DoziSecondaryLight instead", ReplaceWith("DoziSecondaryLight"))
val DoziPurpleLight = DoziSecondaryLight

@Deprecated("Use WarningAmber instead", ReplaceWith("WarningAmber"))
val WarningOrange = WarningAmber

// GRADƒ∞ENTLER (geriye uyumluluk)
@Deprecated("Use GradientPrimary instead", ReplaceWith("GradientPrimary"))
val GradientTurquoise = GradientPrimary

@Deprecated("Use GradientSecondary instead", ReplaceWith("GradientSecondary"))
val GradientCoral = GradientSecondary

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìö KULLANIM √ñRNEKLERƒ∞ (Usage Examples)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * DOƒûRU KULLANIM ‚úÖ:
 *
 * // Ana sayfa arka planƒ±
 * Surface(color = BackgroundLight) { ... }
 *
 * // Primary button (lavender)
 * Button(colors = ButtonDefaults.buttonColors(containerColor = DoziPrimary))
 *
 * // Secondary button - √∂nemli aksiyon (coral)
 * Button(colors = ButtonDefaults.buttonColors(containerColor = DoziSecondary))
 *
 * // Tertiary button - uyarƒ±/dikkat (amber)
 * Button(colors = ButtonDefaults.buttonColors(containerColor = DoziAccent))
 *
 * // Checkbox se√ßili (lavender)
 * Checkbox(colors = CheckboxDefaults.colors(checkedColor = DoziPrimary))
 *
 * // Dozi karakteri g√∂sterimi (turkuaz)
 * Image(
 *     painter = painterResource(R.drawable.dozi_character),
 *     colorFilter = ColorFilter.tint(DoziCharacterLight)
 * )
 *
 * // Ba≈üarƒ± mesajƒ±
 * Icon(Icons.Default.Check, tint = SuccessGreen)
 *
 * // Hata mesajƒ±
 * Text("Hata!", color = ErrorRed)
 *
 * // ƒ∞kincil metin (ya≈ülƒ±lar i√ßin y√ºksek kontrast)
 * Text("A√ßƒ±klama", color = TextSecondary)
 *
 *
 * YANLI≈û KULLANIM ‚ùå:
 *
 * // UI elementlerinde turkuaz kullanma (karaktere √∂zel!)
 * Button(colors = ButtonDefaults.buttonColors(
 *     containerColor = DoziCharacterLight  // ‚ùå YANLI≈û
 * ))
 *
 * // Checkbox i√ßin ye≈üil kullanma (success i√ßindir)
 * Checkbox(colors = CheckboxDefaults.colors(
 *     checkedColor = SuccessGreen  // ‚ùå YANLI≈û
 * ))
 *
 * // Primary button i√ßin kƒ±rmƒ±zƒ±
 * Button(colors = ButtonDefaults.buttonColors(
 *     containerColor = ErrorRed  // ‚ùå YANLI≈û (sadece kritik aksiyonlar i√ßin)
 * ))
 *
 *
 * KONTRAST ORANLARI (WCAG AA Uyumlu):
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 *
 * DoziPrimary + White:        4.5:1 ‚úÖ (Normal text)
 * DoziSecondary + White:      4.8:1 ‚úÖ (Normal text)
 * TextPrimary + BackgroundLight: 12:1 ‚úÖ (M√ºkemmel - ya≈ülƒ±lar i√ßin ideal)
 * TextSecondary + BackgroundLight: 6:1 ‚úÖ (ƒ∞yi)
 */

// ============================================================================
// FILE: Shape.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/theme/Shape.kt
// [53 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.theme

import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Shapes
import androidx.compose.ui.unit.dp

/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * üé® DOZI SHAPE PALETƒ∞ - Extra Soft Rounded Design
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 *
 * Dozi uygulamasƒ±nƒ±n t√ºm k√∂≈üe yuvarlaklƒ±k deƒüerlerini tanƒ±mlar.
 *
 * üè• TASARIM PRENSƒ∞PLERƒ∞:
 * ‚Ä¢ Extra Soft - √áok yumu≈üak k√∂≈üeler, sert kenarlar yok
 * ‚Ä¢ Dostane ve modern g√∂r√ºn√ºm
 * ‚Ä¢ Saƒülƒ±k uygulamasƒ± i√ßin profesyonel ama sƒ±cak
 * ‚Ä¢ Ya≈ülƒ±lar i√ßin kolay algƒ±lanƒ±r
 * ‚Ä¢ Hamileler i√ßin rahatlatƒ±cƒ±
 *
 * üìò KULLANIM REHBERƒ∞:
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 *
 * Extra Small (16dp)  ‚Üí Chips, badges, k√º√ß√ºk indicator'lar
 * Small (20dp)        ‚Üí Text fields, k√º√ß√ºk butonlar, tags
 * Medium (28dp)       ‚Üí Butonlar, standart kartlar, input'lar
 * Large (36dp)        ‚Üí B√ºy√ºk kartlar, dialog'lar, modal'lar
 * Extra Large (48dp)  ‚Üí Bottom sheets, hero sections, √∂zel kartlar
 *
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 */

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üé® MATERIAL 3 STANDART SHAPES (Extra Soft)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Material 3 Shapes tanƒ±mlarƒ± - Extra Soft yakla≈üƒ±mƒ±
 * T√ºm Material 3 bile≈üenleri bu deƒüerleri kullanƒ±r
 */
val DoziShapes = Shapes(
    extraSmall = RoundedCornerShape(16.dp),     // Chips, badges, k√º√ß√ºk elementler
    small = RoundedCornerShape(20.dp),          // Text fields, k√º√ß√ºk butonlar
    medium = RoundedCornerShape(28.dp),         // Butonlar, kartlar - EN √áOK KULLANILAN
    large = RoundedCornerShape(36.dp),          // Dialog'lar, b√ºy√ºk kartlar
    extraLarge = RoundedCornerShape(48.dp)      // Bottom sheets, hero sections
)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üéØ √ñZEL SHAPE TANIMLARI (Component-Specific)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Buton Shapes - Farklƒ± buton tipleri i√ßin
 */
val ButtonShapePrimary = RoundedCornerShape(28.dp)          // Ana butonlar - extra soft
val ButtonShapeSecondary = RoundedCornerShape(24.dp)        // ƒ∞kincil butonlar - biraz daha az
val ButtonShapeSmall = RoundedCornerShape(20.dp)            // K√º√ß√ºk butonlar
val ButtonShapeLarge = RoundedCornerShape(32.dp)            // B√ºy√ºk CTA butonlarƒ±
val ButtonShapePill = RoundedCornerShape(percent = 50)      // Pill style (tamamen yuvarlak)

/**
 * Kart Shapes - Farklƒ± kart tipleri i√ßin
 */
val CardShapeDefault = RoundedCornerShape(28.dp)            // Standart kartlar
val CardShapeSmall = RoundedCornerShape(20.dp)              // K√º√ß√ºk kartlar, list items
val CardShapeLarge = RoundedCornerShape(36.dp)              // B√ºy√ºk kartlar, featured items
val CardShapeHero = RoundedCornerShape(40.dp)               // Hero kartlar, splash screens

/**
 * Input/TextField Shapes
 */
val TextFieldShape = RoundedCornerShape(20.dp)              // Input alanlarƒ± - rahat yazma
val TextFieldShapeLarge = RoundedCornerShape(24.dp)         // B√ºy√ºk input alanlarƒ± (search)

/**
 * Dialog & Modal Shapes
 */
val DialogShape = RoundedCornerShape(36.dp)                 // Dialog pencereler
val BottomSheetShape = RoundedCornerShape(
    topStart = 48.dp,                                       // Bottom sheet - sadece √ºst k√∂≈üeler
    topEnd = 48.dp,
    bottomStart = 0.dp,
    bottomEnd = 0.dp
)
val ModalShape = RoundedCornerShape(40.dp)                  // Modal pencereler

/**
 * √ñzel Kullanƒ±m Shapes
 */
val ShapeNone = RoundedCornerShape(0.dp)                    // K√∂≈üesiz (image backgrounds)
val ShapePill = RoundedCornerShape(percent = 50)            // Tamamen yuvarlak (pills, FAB)
val ShapeCircle = RoundedCornerShape(percent = 50)          // Daireler i√ßin alias

/**
 * Sadece √ºst k√∂≈üeler yuvarlatƒ±lmƒ±≈ü - HomeScreen i√ßin
 */
val ShapeTopOnly = RoundedCornerShape(
    topStart = 40.dp,                                       // Daha yumu≈üak √ºst k√∂≈üeler
    topEnd = 40.dp,
    bottomStart = 0.dp,
    bottomEnd = 0.dp
)

/**
 * Sadece alt k√∂≈üeler yuvarlatƒ±lmƒ±≈ü
 */
val ShapeBottomOnly = RoundedCornerShape(
    topStart = 0.dp,
    topEnd = 0.dp,
    bottomStart = 40.dp,
    bottomEnd = 40.dp
)

/**
 * Asimetrik yuvarlaklƒ±k - √∂zel tasarƒ±mlar i√ßin
 */
val ShapeAsymmetric = RoundedCornerShape(
    topStart = 48.dp,                                       // Sol √ºst √ßok yumu≈üak
    topEnd = 24.dp,                                         // Saƒü √ºst orta
    bottomStart = 24.dp,                                    // Sol alt orta
    bottomEnd = 48.dp                                       // Saƒü alt √ßok yumu≈üak
)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üè• SAƒûLIK UYGULAMASI √ñZEL SHAPES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * ƒ∞la√ß kartlarƒ± - ekstra yumu≈üak ve dostane
 */
val MedicineCardShape = RoundedCornerShape(32.dp)

/**
 * Bildirim kartlarƒ± - dikkat √ßekici ama yumu≈üak
 */
val NotificationCardShape = RoundedCornerShape(24.dp)

/**
 * Profil avatarlarƒ± - yuvarlak
 */
val AvatarShape = RoundedCornerShape(percent = 50)

/**
 * √ñl√ß√ºm kartlarƒ± (tansiyon, nabƒ±z vb.)
 */
val MetricCardShape = RoundedCornerShape(28.dp)

/**
 * Takvim g√ºn se√ßimi
 */
val CalendarDayShape = RoundedCornerShape(16.dp)

/**
 * Badge/Etiket shapes
 */
val BadgeShape = RoundedCornerShape(12.dp)                  // K√º√ß√ºk badge'ler
val BadgeShapePill = RoundedCornerShape(percent = 50)       // Pill style badge'ler

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìö KULLANIM √ñRNEKLERƒ∞ (Usage Examples)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * DOƒûRU KULLANIM ‚úÖ:
 *
 * // Primary button - extra soft
 * Button(
 *     onClick = { },
 *     shape = ButtonShapePrimary  // veya MaterialTheme.shapes.medium
 * ) { Text("Kaydet") }
 *
 * // ƒ∞la√ß kartƒ±
 * Card(
 *     shape = MedicineCardShape,
 *     modifier = Modifier.fillMaxWidth()
 * ) { ... }
 *
 * // Text input - rahat yazma i√ßin yumu≈üak
 * TextField(
 *     value = "",
 *     onValueChange = {},
 *     shape = TextFieldShape
 * )
 *
 * // Dialog - profesyonel ama dostane
 * AlertDialog(
 *     onDismissRequest = {},
 *     shape = DialogShape
 * ) { ... }
 *
 * // Bottom sheet - √ßok yumu≈üak √ºst k√∂≈üeler
 * ModalBottomSheet(
 *     onDismissRequest = {},
 *     shape = BottomSheetShape
 * ) { ... }
 *
 * // Profil avatarƒ± - tamamen yuvarlak
 * Image(
 *     painter = painterResource(R.drawable.avatar),
 *     modifier = Modifier
 *         .size(64.dp)
 *         .clip(AvatarShape)
 * )
 *
 * // FAB (Floating Action Button) - pill shape
 * FloatingActionButton(
 *     onClick = {},
 *     shape = ShapePill
 * ) { Icon(...) }
 *
 *
 * YANLI≈û KULLANIM ‚ùå:
 *
 * // K√∂≈üesiz buton (sert g√∂r√ºn√ºr)
 * Button(
 *     onClick = {},
 *     shape = ShapeNone  // ‚ùå YANLI≈û - dostane deƒüil
 * )
 *
 * // √áok k√º√ß√ºk radius (material 2 tarzƒ±)
 * Card(
 *     shape = RoundedCornerShape(4.dp)  // ‚ùå YANLI≈û - √ßok sert
 * )
 *
 *
 * üí° ƒ∞PUCU:
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 *
 * Material 3 bile≈üenleri otomatik olarak MaterialTheme.shapes deƒüerlerini kullanƒ±r:
 * - Button ‚Üí shapes.medium (28dp) ‚úÖ
 * - Card ‚Üí shapes.medium (28dp) ‚úÖ
 * - TextField ‚Üí shapes.small (20dp) ‚úÖ
 *
 * √ñzel shape kullanmak istiyorsanƒ±z, shape parametresini override edin.
 */

// ============================================================================
// FILE: Theme.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/theme/Theme.kt
// [54 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.theme

import androidx.compose.foundation.isSystemInDarkTheme
import androidx.compose.material3.ColorScheme
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.darkColorScheme
import androidx.compose.material3.lightColorScheme
import androidx.compose.runtime.Composable
import androidx.compose.ui.graphics.Color

/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * üé® DOZI TEMA TANIMLARI
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 *
 * Material 3 ColorScheme tanƒ±mlarƒ±
 * Yeni pastel-canlƒ± renk paletini kullanƒ±r
 *
 * Ana Renkler:
 * ‚Ä¢ Primary: Lavender (Mor) - Ana tema rengi
 * ‚Ä¢ Secondary: Coral (Pembe-Coral) - ƒ∞kincil vurgu
 * ‚Ä¢ Tertiary: Amber - Ek vurgular
 */

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üåû LIGHT COLOR SCHEME (Aydƒ±nlƒ±k Mod)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

private val LightColorScheme = lightColorScheme(
    // Primary renk ailesi - Lavender (Mor)
    primary = DoziPrimary,                          // Ana lavender
    onPrimary = Color.White,                        // Lavender √ºzerindeki yazƒ±lar beyaz
    primaryContainer = DoziPrimaryLight,            // A√ßƒ±k lavender container'lar
    onPrimaryContainer = DoziPrimaryDark,           // Container i√ßi yazƒ±lar koyu mor

    // Secondary renk ailesi - Coral (Pembe)
    secondary = DoziSecondary,                      // Ana coral
    onSecondary = Color.White,                      // Coral √ºzerindeki yazƒ±lar beyaz
    secondaryContainer = DoziSecondaryLight,        // A√ßƒ±k coral container'lar
    onSecondaryContainer = DoziSecondaryDark,       // Container i√ßi yazƒ±lar koyu coral

    // Tertiary renk ailesi - Amber (Sarƒ±-Turuncu)
    tertiary = DoziAccent,                          // Ana amber
    onTertiary = Color.White,                       // Amber √ºzerindeki yazƒ±lar beyaz
    tertiaryContainer = DoziAccentLight,            // A√ßƒ±k amber container'lar
    onTertiaryContainer = DoziAccentDark,           // Container i√ßi yazƒ±lar koyu amber

    // Error renk ailesi
    error = ErrorRed,                               // Soft kƒ±rmƒ±zƒ± - ya≈ülƒ±lar i√ßin agresif deƒüil
    onError = Color.White,                          // Hata √ºzerindeki yazƒ±lar beyaz
    errorContainer = ErrorRed.copy(alpha = 0.1f),   // A√ßƒ±k hata arka planƒ±
    onErrorContainer = ErrorRed,                    // Hata container yazƒ±larƒ±

    // Background ve Surface - Pastel & Canlƒ±
    background = BackgroundLight,                   // Ana arka plan - belirgin lavanta
    onBackground = TextPrimary,                     // Arka plan √ºzerindeki yazƒ±lar

    surface = SurfaceLight,                         // Kartlar - beyaz
    onSurface = TextPrimary,                        // Kart √ºzerindeki yazƒ±lar
    surfaceVariant = SurfaceLavender,               // Varyant surface - lavender tint
    onSurfaceVariant = TextSecondary,               // Varyant surface yazƒ±larƒ±

    // Outline ve diƒüerleri
    outline = DoziPrimaryLight,                     // Kenarlƒ±klar - a√ßƒ±k lavender
    outlineVariant = Gray300,                       // Alternatif kenarlƒ±klar

    surfaceTint = DoziPrimary,                      // Surface tint - lavender
    inverseSurface = Gray900,                       // Ters surface (dark)
    inverseOnSurface = Color.White,                 // Ters surface yazƒ±larƒ±
    inversePrimary = DoziPrimaryLight,              // Ters primary
)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üåô DARK COLOR SCHEME (Karanlƒ±k Mod)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

private val DarkColorScheme = darkColorScheme(
    // Primary renk ailesi - Lavender (daha a√ßƒ±k tonlar dark mode i√ßin)
    primary = DoziPrimaryLight,                     // A√ßƒ±k lavender (dark mode'da daha g√∂r√ºn√ºr)
    onPrimary = Gray900,                            // Lavender √ºzerindeki yazƒ±lar koyu
    primaryContainer = DoziPrimaryDark,             // Koyu lavender container'lar
    onPrimaryContainer = DoziPrimaryLight,          // Container i√ßi yazƒ±lar a√ßƒ±k

    // Secondary renk ailesi - Coral
    secondary = DoziSecondaryLight,                 // A√ßƒ±k coral (dark mode'da daha g√∂r√ºn√ºr)
    onSecondary = Gray900,                          // Coral √ºzerindeki yazƒ±lar koyu
    secondaryContainer = DoziSecondaryDark,         // Koyu coral container'lar
    onSecondaryContainer = DoziSecondaryLight,      // Container i√ßi yazƒ±lar a√ßƒ±k

    // Tertiary renk ailesi - Amber
    tertiary = DoziAccentLight,                     // A√ßƒ±k amber
    onTertiary = Gray900,                           // Amber √ºzerindeki yazƒ±lar koyu
    tertiaryContainer = DoziAccentDark,             // Koyu amber container'lar
    onTertiaryContainer = DoziAccentLight,          // Container i√ßi yazƒ±lar a√ßƒ±k

    // Error renk ailesi
    error = ErrorRed,                               // Soft kƒ±rmƒ±zƒ±
    onError = Color.White,                          // Hata √ºzerindeki yazƒ±lar beyaz
    errorContainer = ErrorRed.copy(alpha = 0.2f),   // Hafif kƒ±rmƒ±zƒ± arka plan
    onErrorContainer = ErrorRed,                    // Hata container yazƒ±larƒ±

    // Background ve Surface - Dark Mode
    background = BackgroundDark,                    // Koyu arka plan
    onBackground = TextPrimaryDark,                 // Arka plan √ºzerindeki yazƒ±lar a√ßƒ±k

    surface = SurfaceDark,                          // Kartlar - koyu gri
    onSurface = TextPrimaryDark,                    // Kart √ºzerindeki yazƒ±lar a√ßƒ±k
    surfaceVariant = SurfaceDarkElevated,           // Varyant surface - daha a√ßƒ±k koyu
    onSurfaceVariant = TextSecondaryDark,           // Varyant surface yazƒ±larƒ±

    // Outline ve diƒüerleri
    outline = Color(0xFF383838),                    // Kenarlƒ±klar - koyu gri
    outlineVariant = Gray700,                       // Alternatif kenarlƒ±klar

    surfaceTint = DoziPrimaryLight,                 // Surface tint - a√ßƒ±k lavender
    inverseSurface = Color.White,                   // Ters surface (light)
    inverseOnSurface = Gray900,                     // Ters surface yazƒ±larƒ±
    inversePrimary = DoziPrimaryDark,               // Ters primary
)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üé® DOZI APP THEME (Ana Tema Composable)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Dozi uygulamasƒ±nƒ±n ana tema composable'ƒ±
 *
 * @param darkTheme Karanlƒ±k mod aktif mi? (varsayƒ±lan: sistem ayarƒ±)
 * @param content ƒ∞√ßerik composable'ƒ±
 */
@Composable
fun DoziAppTheme(
    darkTheme: Boolean = isSystemInDarkTheme(),
    content: @Composable () -> Unit
) {
    val colorScheme = if (darkTheme) DarkColorScheme else LightColorScheme

    MaterialTheme(
        colorScheme = colorScheme,
        typography = DoziTypography,    // Typography tanƒ±mƒ± (ayrƒ± dosyada)
        shapes = DoziShapes,            // Shapes tanƒ±mƒ± (ayrƒ± dosyada)
        content = content
    )
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üé® EK YARDIMCI √ñZELLƒ∞KLER (Extension Properties)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Y√ºkseltilmi≈ü surface rengi
 * Kartlarƒ±n √ºzerindeki kartlar, dropdown'lar vb. i√ßin
 */
val ColorScheme.surfaceElevated: Color
    @Composable
    get() = if (MaterialTheme.colorScheme.background.luminance() > 0.5f) {
        // Light mode - hafif amber glow
        SurfaceElevated
    } else {
        // Dark mode - daha a√ßƒ±k koyu gri
        SurfaceDarkElevated
    }

/**
 * Pembe tintli surface
 * √ñzel vurgu alanlarƒ± i√ßin
 */
val ColorScheme.surfacePink: Color
    @Composable
    get() = if (MaterialTheme.colorScheme.background.luminance() > 0.5f) {
        SurfaceTinted // Light mode
    } else {
        Color(0xFF2C1B2E) // Dark mode - koyu pembe
    }

/**
 * Arka plan varyantƒ± (sƒ±cak ton)
 * Alternatif arka planlar i√ßin
 */
val ColorScheme.backgroundWarm: Color
    @Composable
    get() = if (MaterialTheme.colorScheme.background.luminance() > 0.5f) {
        BackgroundWarm // Light mode - peach
    } else {
        Color(0xFF1A1616) // Dark mode - ƒ±lƒ±k koyu
    }

/**
 * Renk luminance'ƒ± (parlaklƒ±k seviyesi)
 * ƒ∞√ß kullanƒ±m i√ßin yardƒ±mcƒ± fonksiyon
 */
private fun Color.luminance(): Float {
    return (0.299f * red + 0.587f * green + 0.114f * blue)
}

// ============================================================================
// FILE: Typography.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/theme/Typography.kt
// [55 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.theme

import androidx.compose.material3.Typography
import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.font.Font
import androidx.compose.ui.text.font.FontFamily
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.sp
import com.bardino.dozi.R // R.font tanƒ±mlƒ± olduƒüu varsayƒ±lƒ±r

// Font ailesi (Poppins Font ailesini kullanmaya devam ediyorum)
val PoppinsFont = FontFamily(
    Font(R.font.poppins_thin, FontWeight.Thin),
    Font(R.font.poppins_light, FontWeight.Light),
    Font(R.font.poppins_regular, FontWeight.Normal),
    Font(R.font.poppins_medium, FontWeight.Medium),
    Font(R.font.poppins_semibold, FontWeight.SemiBold),
    Font(R.font.poppins_bold, FontWeight.Bold),
    Font(R.font.poppins_extrabold, FontWeight.ExtraBold),
    Font(R.font.poppins_black, FontWeight.Black)
)

val DoziTypography = Typography(
    headlineLarge = TextStyle(
        fontFamily = PoppinsFont,
        fontWeight = FontWeight.ExtraBold,
        fontSize = 32.sp,
        lineHeight = 36.sp,
        // color burada belirtilmez, MaterialTheme.colorScheme.onBackground kullanƒ±r
    ),
    headlineSmall = TextStyle(
        fontFamily = PoppinsFont,
        fontWeight = FontWeight.SemiBold,
        fontSize = 24.sp,
        lineHeight = 28.sp,
    ),
    titleLarge = TextStyle(
        fontFamily = PoppinsFont,
        fontWeight = FontWeight.SemiBold,
        fontSize = 20.sp,
        lineHeight = 26.sp,
    ),
    titleMedium = TextStyle(
        fontFamily = PoppinsFont,
        fontWeight = FontWeight.Medium,
        fontSize = 16.sp,
        lineHeight = 22.sp,
    ),
    titleSmall = TextStyle(
        fontFamily = PoppinsFont,
        fontWeight = FontWeight.Medium,
        fontSize = 13.sp,
        lineHeight = 18.sp,
    ),
    bodyLarge = TextStyle(
        fontFamily = PoppinsFont,
        fontWeight = FontWeight.Normal,
        fontSize = 16.sp,
        lineHeight = 22.sp,
    ),
    bodyMedium = TextStyle(
        fontFamily = PoppinsFont,
        fontWeight = FontWeight.Normal,
        fontSize = 14.sp,
        lineHeight = 20.sp,
    ),
    labelMedium = TextStyle(
        fontFamily = PoppinsFont,
        fontWeight = FontWeight.Medium,
        fontSize = 12.sp,
        lineHeight = 16.sp,
    ),
    labelSmall = TextStyle(
        fontFamily = PoppinsFont,
        fontWeight = FontWeight.SemiBold,
        fontSize = 10.sp,
        lineHeight = 14.sp,
    )
)
// ============================================================================
// FILE: UiEvent.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/state/UiEvent.kt
// [56 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.state

sealed interface UiEvent {
    data class ShowSnackbar(val message: String) : UiEvent
    data class ShowToast(val message: String) : UiEvent
    data class Navigate(val route: String) : UiEvent
    data object NavigateBack : UiEvent
}
// ============================================================================
// FILE: UiState.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/state/UiState.kt
// [57 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.state

sealed interface UiState<out T> {
    object Idle : UiState<Nothing>
    object Loading : UiState<Nothing>
    data class Success<T>(val data: T) : UiState<T>
    data class Error(val error: UiError) : UiState<Nothing>
}

sealed class UiError(open val message: String) {
    data class Network(override val message: String = "ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin") : UiError(message)
    data class Validation(override val message: String) : UiError(message)
    data class Unknown(override val message: String = "Bir hata olu≈ütu") : UiError(message)
}
// ============================================================================
// FILE: DoziBottomBar.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/components/DoziBottomBar.kt
// [58 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.components

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.bardino.dozi.core.ui.theme.*
import com.google.firebase.auth.FirebaseAuth

sealed class BottomNavItem(
    val route: String,
    val icon: ImageVector,
    val label: String
) {
    object Home : BottomNavItem("home", Icons.Default.Home, "Ana Sayfa")
    object Medicines : BottomNavItem("medicine_list", Icons.Default.MedicalServices, "ƒ∞la√ßlarƒ±m")
    object Profile : BottomNavItem("profile", Icons.Default.Person, "Profil")
    object More : BottomNavItem("more", Icons.Default.MoreHoriz, "Daha Fazla")
}

sealed class MoreMenuItem(
    val route: String,
    val icon: ImageVector,
    val label: String,
    val description: String
) {
    object Reminders : MoreMenuItem("reminder_list", Icons.Default.Notifications, "Hatƒ±rlatmalar", "Hatƒ±rlatma ayarlarƒ±nƒ± y√∂net")
    object Stats : MoreMenuItem("stats", Icons.Default.BarChart, "ƒ∞statistikler", "ƒ∞la√ß takip istatistikleri")
    object Badis : MoreMenuItem("badi_list", Icons.Default.People, "Badi", "Arkada≈ülarƒ±nla birlikte takip et")
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun DoziBottomBar(
    currentRoute: String?,
    onNavigate: (String) -> Unit,
    onLoginRequired: () -> Unit = {}
) {
    val auth = remember { FirebaseAuth.getInstance() }
    var isLoggedIn by remember { mutableStateOf(auth.currentUser != null) }
    var showMoreMenu by remember { mutableStateOf(false) }

    // Auth durumu deƒüi≈ütiƒüinde otomatik g√ºncelle
    DisposableEffect(Unit) {
        val listener = FirebaseAuth.AuthStateListener { firebaseAuth ->
            isLoggedIn = firebaseAuth.currentUser != null
        }
        auth.addAuthStateListener(listener)
        onDispose { auth.removeAuthStateListener(listener) }
    }

    val mainItems = listOf(
        BottomNavItem.Home,
        BottomNavItem.Medicines,
        BottomNavItem.Profile,
        BottomNavItem.More
    )

    Box {
        NavigationBar(
            containerColor = Color(0xFF1A237E),
            contentColor = Color.White,
            tonalElevation = 8.dp
        ) {
            mainItems.forEach { item ->
                val selected = when (item) {
                    is BottomNavItem.More -> currentRoute in listOf("stats", "badi_list", "reminder_list")
                    else -> currentRoute == item.route
                }

                val requiresLogin = item is BottomNavItem.Medicines

                // Profil i√ßin √∂zel label ve icon
                val displayLabel = if (item is BottomNavItem.Profile && !isLoggedIn) "Giri≈ü" else item.label
                val displayIcon = if (item is BottomNavItem.Profile && !isLoggedIn) Icons.Default.Login else item.icon

                NavigationBarItem(
                    icon = {
                        Icon(
                            displayIcon,
                            contentDescription = displayLabel,
                            modifier = Modifier.size(if (selected) 24.dp else 22.dp)
                        )
                    },
                    label = {
                        Text(
                            displayLabel,
                            style = MaterialTheme.typography.labelSmall.copy(
                                fontSize = 11.sp,
                                lineHeight = 12.sp
                            ),
                            maxLines = 1,
                            overflow = TextOverflow.Ellipsis
                        )
                    },
                    selected = selected,
                    onClick = {
                        when (item) {
                            is BottomNavItem.More -> {
                                showMoreMenu = true
                            }
                            is BottomNavItem.Profile -> {
                                if (!isLoggedIn) {
                                    onLoginRequired()
                                } else {
                                    if (currentRoute != item.route) {
                                        onNavigate(item.route)
                                    }
                                }
                            }
                            is BottomNavItem.Home -> {
                                // Ana Sayfa'ya her zaman navigate et
                                if (currentRoute != item.route) {
                                    onNavigate(item.route)
                                }
                            }
                            else -> {
                                if (currentRoute != item.route) {
                                    if (requiresLogin && !isLoggedIn) {
                                        onLoginRequired()
                                    } else {
                                        onNavigate(item.route)
                                    }
                                }
                            }
                        }
                    },
                    colors = NavigationBarItemDefaults.colors(
                        selectedIconColor = DoziTurquoise,
                        selectedTextColor = DoziTurquoise,
                        unselectedIconColor = if (requiresLogin && !isLoggedIn) {
                            Color.White.copy(alpha = 0.4f)
                        } else {
                            Color.White.copy(alpha = 0.6f)
                        },
                        unselectedTextColor = if (requiresLogin && !isLoggedIn) {
                            Color.White.copy(alpha = 0.4f)
                        } else {
                            Color.White.copy(alpha = 0.6f)
                        },
                        indicatorColor = Color.White.copy(alpha = 0.15f)
                    )
                )
            }
        }

        // More Menu BottomSheet
        if (showMoreMenu) {
            MoreMenuBottomSheet(
                isLoggedIn = isLoggedIn,
                currentRoute = currentRoute,
                onDismiss = { showMoreMenu = false },
                onNavigate = { route ->
                    showMoreMenu = false
                    onNavigate(route)
                },
                onLoginRequired = {
                    showMoreMenu = false
                    onLoginRequired()
                }
            )
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
private fun MoreMenuBottomSheet(
    isLoggedIn: Boolean,
    currentRoute: String?,
    onDismiss: () -> Unit,
    onNavigate: (String) -> Unit,
    onLoginRequired: () -> Unit
) {
    val sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)

    ModalBottomSheet(
        onDismissRequest = onDismiss,
        sheetState = sheetState,
        containerColor = Color(0xFFF8F9FA),
        tonalElevation = 0.dp
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(bottom = 32.dp)
        ) {
            // Gradient ba≈ülƒ±k alanƒ±
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .background(
                        androidx.compose.ui.graphics.Brush.horizontalGradient(
                            listOf(DoziTurquoise, DoziPurple)
                        )
                    )
                    .padding(horizontal = 24.dp, vertical = 20.dp)
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    Icon(
                        Icons.Default.MoreHoriz,
                        contentDescription = null,
                        tint = Color.White,
                        modifier = Modifier.size(28.dp)
                    )
                    Text(
                        text = "Daha Fazla",
                        style = MaterialTheme.typography.titleLarge.copy(
                            fontWeight = FontWeight.ExtraBold,
                            fontSize = 24.sp
                        ),
                        color = Color.White
                    )
                }
            }

            Spacer(modifier = Modifier.height(16.dp))

            val menuItems = listOf(
                MoreMenuItem.Reminders,
                MoreMenuItem.Stats,
                MoreMenuItem.Badis
            )

            menuItems.forEach { item ->
                val requiresLogin = item is MoreMenuItem.Badis || item is MoreMenuItem.Reminders
                val isSelected = currentRoute == item.route

                MoreMenuItemCard(
                    item = item,
                    isSelected = isSelected,
                    isEnabled = !requiresLogin || isLoggedIn,
                    onClick = {
                        if (requiresLogin && !isLoggedIn) {
                            onLoginRequired()
                        } else {
                            onNavigate(item.route)
                        }
                    }
                )
            }
        }
    }
}

@Composable
private fun MoreMenuItemCard(
    item: MoreMenuItem,
    isSelected: Boolean,
    isEnabled: Boolean,
    onClick: () -> Unit
) {
    androidx.compose.material3.Card(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 16.dp, vertical = 6.dp),
        shape = RoundedCornerShape(16.dp),
        colors = androidx.compose.material3.CardDefaults.cardColors(
            containerColor = if (isSelected)
                androidx.compose.ui.graphics.Brush.horizontalGradient(
                    listOf(DoziTurquoise.copy(alpha = 0.15f), DoziPurple.copy(alpha = 0.15f))
                ).let { Color.White }
            else Color.White
        ),
        elevation = androidx.compose.material3.CardDefaults.cardElevation(
            defaultElevation = if (isSelected) 6.dp else 2.dp
        ),
        onClick = { if (isEnabled) onClick() }
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .background(
                    if (isSelected) androidx.compose.ui.graphics.Brush.horizontalGradient(
                        listOf(DoziTurquoise.copy(alpha = 0.12f), DoziPurple.copy(alpha = 0.12f))
                    ) else androidx.compose.ui.graphics.Brush.horizontalGradient(
                        listOf(Color.White, Color.White)
                    )
                )
                .padding(horizontal = 16.dp, vertical = 14.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            // Icon
            Box(
                modifier = Modifier
                    .size(52.dp)
                    .background(
                        brush = if (isSelected) androidx.compose.ui.graphics.Brush.linearGradient(
                            listOf(DoziTurquoise, DoziPurple)
                        ) else androidx.compose.ui.graphics.Brush.linearGradient(
                            listOf(Color(0xFFE3F2FD), Color(0xFFE1F5FE))
                        ),
                        shape = RoundedCornerShape(14.dp)
                    ),
                contentAlignment = Alignment.Center
            ) {
                Icon(
                    imageVector = item.icon,
                    contentDescription = item.label,
                    tint = if (isSelected) Color.White else DoziTurquoise,
                    modifier = Modifier.size(26.dp)
                )
            }

            Spacer(modifier = Modifier.width(16.dp))

            // Text
            Column(modifier = Modifier.weight(1f)) {
                Text(
                    text = item.label,
                    style = MaterialTheme.typography.bodyLarge.copy(
                        fontWeight = if (isSelected) FontWeight.ExtraBold else FontWeight.Bold,
                        fontSize = 17.sp
                    ),
                    color = if (isEnabled) Color(0xFF1A237E) else Color.Gray
                )
                Spacer(modifier = Modifier.height(2.dp))
                Text(
                    text = item.description,
                    style = MaterialTheme.typography.bodySmall.copy(fontSize = 13.sp),
                    color = if (isEnabled) Color(0xFF546E7A) else Color.LightGray
                )
            }

            // Arrow or lock icon
            if (isEnabled) {
                Icon(
                    imageVector = Icons.Default.ChevronRight,
                    contentDescription = null,
                    tint = if (isSelected) DoziTurquoise else Color(0xFF90A4AE),
                    modifier = Modifier.size(26.dp)
                )
            } else {
                Icon(
                    imageVector = Icons.Default.Lock,
                    contentDescription = "Giri≈ü gerekli",
                    tint = Color.Gray,
                    modifier = Modifier.size(22.dp)
                )
            }
        }
    }
}

// ============================================================================
// FILE: DoziCharacter.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/components/DoziCharacter.kt
// [59 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.components

import android.os.Build
import androidx.annotation.RequiresApi
import androidx.compose.animation.*
import androidx.compose.animation.core.*
import androidx.compose.foundation.Image
import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.scale
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import com.bardino.dozi.R
import com.bardino.dozi.core.ui.theme.*
import java.time.LocalTime

@RequiresApi(Build.VERSION_CODES.O)
@Composable
fun DoziCharacter(
    modifier: Modifier = Modifier,
    showMessage: Boolean = true,
    hasUpcomingMedicine: Boolean = false,
    customMessage: String? = null
) {
    // Animasyon i√ßin state
    val infiniteTransition = rememberInfiniteTransition(label = "dozi_float")
    val floatAnimation by infiniteTransition.animateFloat(
        initialValue = 0f,
        targetValue = 10f,
        animationSpec = infiniteRepeatable(
            animation = tween(2000, easing = EaseInOutSine),
            repeatMode = RepeatMode.Reverse
        ),
        label = "float"
    )

    val hour = LocalTime.now().hour
    val message = customMessage ?: when {
        hasUpcomingMedicine -> "Yakla≈üan ila√ß saatin var ‚è∞"
        hour in 5..11 -> "G√ºnaydƒ±n! ‚òÄÔ∏è"
        hour in 12..17 -> "ƒ∞yi g√ºnler! üëã"
        hour in 18..21 -> "ƒ∞yi ak≈üamlar! üåÜ"
        else -> "ƒ∞yi geceler! üåô"
    }

    Column(
        modifier = modifier,
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        // Dozi karakteri (float animasyonu ile)
        Box(
            modifier = Modifier
                .size(120.dp)
                .offset(y = floatAnimation.dp)
        ) {
            Image(
                painter = painterResource(id = R.drawable.dozi),
                contentDescription = "Dozi Maskot",
                modifier = Modifier.fillMaxSize()
            )
        }

        Spacer(Modifier.height(16.dp))

        // Mesaj
        AnimatedVisibility(
            visible = showMessage,
            enter = fadeIn() + expandVertically(),
            exit = fadeOut() + shrinkVertically()
        ) {
            Card(
                colors = CardDefaults.cardColors(
                    containerColor = DoziTurquoise.copy(alpha = 0.1f)
                ),
                shape = MaterialTheme.shapes.medium,
                elevation = CardDefaults.cardElevation(0.dp)
            ) {
                Text(
                    text = message,
                    color = DoziTurquoise,
                    style = MaterialTheme.typography.bodyMedium,
                    fontWeight = FontWeight.Medium,
                    textAlign = TextAlign.Center,
                    modifier = Modifier.padding(horizontal = 20.dp, vertical = 12.dp)
                )
            }
        }
    }
}

// üé≠ DOZI EXPRESSIONS (gelecekte farklƒ± duygular i√ßin)
@RequiresApi(Build.VERSION_CODES.O)
@Composable
fun DoziHappy(modifier: Modifier = Modifier) {
    DoziCharacter(
        modifier = modifier,
        customMessage = "Harika gidiyorsun! üéâ"
    )
}

@Composable
fun DoziThinking(modifier: Modifier = Modifier) {
    DoziCharacter(
        modifier = modifier,
        customMessage = "Hmm... ü§î"
    )
}

@Composable
fun DoziReminder(modifier: Modifier = Modifier) {
    DoziCharacter(
        modifier = modifier,
        hasUpcomingMedicine = true
    )
}
// ============================================================================
// FILE: DoziTopBar.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/components/DoziTopBar.kt
// [60 of 122]
// ============================================================================

// üìÅ com.bardino.dozi.core.ui.components.DoziTopBar.kt
package com.bardino.dozi.core.ui.components

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import com.bardino.dozi.core.ui.theme.*

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun DoziTopBar(
    title: String,
    canNavigateBack: Boolean = false,
    onNavigateBack: () -> Unit = {},
    actions: @Composable (RowScope.() -> Unit)? = null,
    backgroundColor: Color = Color.White
) {
    TopAppBar(
        title = {
            Text(
                text = title,
                style = MaterialTheme.typography.titleLarge.copy(
                    fontWeight = FontWeight.Bold,
                    color = TextPrimaryLight
                )
            )
        },
        navigationIcon = {
            if (canNavigateBack) {
                IconButton(
                    onClick = onNavigateBack,
                    modifier = Modifier
                        .padding(start = 8.dp)
                        .size(40.dp)
                        .background(DoziTurquoise.copy(alpha = 0.1f), CircleShape)
                ) {
                    Icon(
                        imageVector = Icons.AutoMirrored.Filled.ArrowBack,
                        contentDescription = "Geri",
                        tint = DoziTurquoise
                    )
                }
            }
        },
        actions = {
            actions?.invoke(this)
        },
        colors = TopAppBarDefaults.topAppBarColors(
            containerColor = backgroundColor,
            titleContentColor = TextPrimaryLight,
            navigationIconContentColor = DoziTurquoise
        )
    )
}

// ============================================================================
// FILE: EmptyState.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/components/EmptyState.kt
// [61 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.components

import androidx.annotation.DrawableRes
import androidx.compose.foundation.Image
import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import com.bardino.dozi.core.ui.theme.*

@Composable
fun EmptyState(
    icon: Int,
    title: String,
    description: String,
    actionButton: @Composable (() -> Unit)? = null
) {
    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(horizontal = 32.dp)
            .padding(bottom = 32.dp) // üìè Bottombar‚Äôdan kurtulmak i√ßin alt bo≈üluk
            .navigationBarsPadding(), // üì± Sistem alt √ßubuƒüuna g√∂re otomatik bo≈üluk
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center // üéØ dikeyde tam ortalama
    ) {
        // üñºÔ∏è G√∂rsel
        Image(
            painter = painterResource(id = icon),
            contentDescription = null,
            modifier = Modifier.size(170.dp) // üìè biraz k√º√ß√ºlt√ºp tam orantƒ±
        )

        Spacer(Modifier.height(28.dp))

        // üß© Ba≈ülƒ±k
        Text(
            text = title,
            style = MaterialTheme.typography.headlineMedium,
            fontWeight = FontWeight.ExtraBold,
            color = TextPrimaryLight,
            textAlign = TextAlign.Center
        )

        Spacer(Modifier.height(12.dp))

        // üß† A√ßƒ±klama
        Text(
            text = description,
            style = MaterialTheme.typography.bodyLarge,
            color = TextSecondaryLight,
            textAlign = TextAlign.Center,
            lineHeight = MaterialTheme.typography.bodyLarge.lineHeight * 1.1f,
            modifier = Modifier.padding(horizontal = 12.dp)
        )

        if (actionButton != null) {
            Spacer(Modifier.height(36.dp))
            actionButton()
        }
    }
}


@Composable
fun EmptyMedicineList(
    onAddMedicine: () -> Unit
) {
    EmptyState(
        icon = com.bardino.dozi.R.drawable.dozi_idea,
        title = "Hen√ºz ila√ß eklemediniz",
        description = "ƒ∞la√ßlarƒ±nƒ±zƒ± ekleyerek takibini kolayla≈ütƒ±rƒ±n",
        actionButton = {
            Button(
                onClick = onAddMedicine,
                colors = ButtonDefaults.buttonColors(
                    containerColor = DoziCoral
                ),
                shape = MaterialTheme.shapes.medium
            ) {
                Text("ƒ∞lk ƒ∞lacƒ± Ekle")
            }
        }
    )
}


@Composable
fun EmptyReminderList(
    onAddReminder: () -> Unit
) {
    EmptyState(
        icon = com.bardino.dozi.R.drawable.dozi_time,
        title = "Hen√ºz hatƒ±rlatma yok",
        description = "ƒ∞la√ß hatƒ±rlatmalarƒ± kurarak hi√ßbir dozu ka√ßƒ±rmayƒ±n",
        actionButton = {
            Button(
                onClick = onAddReminder,
                colors = ButtonDefaults.buttonColors(
                    containerColor = DoziCoral
                ),
                shape = MaterialTheme.shapes.medium
            ) {
                Text("Hatƒ±rlatma Ekle")
            }
        }
    )
}

@Composable
fun EmptySearchResults() {
    EmptyState(
        icon = com.bardino.dozi.R.drawable.dozi_unhappy,
        title = "Sonu√ß bulunamadƒ±",
        description = "Arama kriterlerinizi deƒüi≈ütirip tekrar deneyin"
    )
}
// ============================================================================
// FILE: MedicineCard.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/components/MedicineCard.kt
// [62 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.components

import androidx.compose.animation.*
import androidx.compose.animation.core.animateFloatAsState
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.rotate
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import com.bardino.dozi.core.data.model.Medicine
import com.bardino.dozi.core.ui.theme.*

@Composable
fun MedicineCard(
    medicineName: String,
    dosage: String,
    stockCount: Int,
    onClick: () -> Unit,
    modifier: Modifier = Modifier,
    reminders: List<Medicine> = emptyList(),
    onAddReminder: (() -> Unit)? = null,
    onReminderClick: ((String) -> Unit)? = null
) {
    var expanded by remember { mutableStateOf(false) }
    val rotationAngle by animateFloatAsState(
        targetValue = if (expanded) 180f else 0f,
        label = "rotation"
    )

    Card(
        modifier = modifier
            .fillMaxWidth()
            .shadow(8.dp, RoundedCornerShape(20.dp)),
        shape = RoundedCornerShape(20.dp),
        colors = CardDefaults.cardColors(
            containerColor = Color.White
        ),
        elevation = CardDefaults.cardElevation(defaultElevation = 0.dp)
    ) {
        Column {
            Box {
                // Sol tarafta renkli accent bar
                Box(
                    modifier = Modifier
                        .width(6.dp)
                        .fillMaxHeight()
                        .background(
                            brush = Brush.verticalGradient(
                                colors = listOf(
                                    DoziPrimary,
                                    DoziSecondary
                                )
                            )
                        )
                )

                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(start = 6.dp)
                        .background(
                            brush = Brush.horizontalGradient(
                                colors = listOf(
                                    DoziPrimaryLight.copy(alpha = 0.08f),
                                    Color.White
                                )
                            )
                        )
                        .clickable(onClick = onClick)
                        .padding(16.dp),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Row(
                        horizontalArrangement = Arrangement.spacedBy(14.dp),
                        verticalAlignment = Alignment.CenterVertically,
                        modifier = Modifier.weight(1f)
                    ) {
                        // ƒ∞kon arka planƒ±
                        Surface(
                            modifier = Modifier.size(56.dp),
                            shape = RoundedCornerShape(16.dp),
                            color = DoziPrimary.copy(alpha = 0.15f)
                        ) {
                            Box(
                                contentAlignment = Alignment.Center
                            ) {
                                Icon(
                                    imageVector = Icons.Default.Medication,
                                    contentDescription = null,
                                    tint = DoziPrimaryDark,
                                    modifier = Modifier.size(30.dp)
                                )
                            }
                        }

                        Column(
                            verticalArrangement = Arrangement.spacedBy(4.dp)
                        ) {
                            Text(
                                text = medicineName,
                                style = MaterialTheme.typography.titleMedium,
                                fontWeight = FontWeight.Bold,
                                color = Gray900
                            )
                            Text(
                                text = dosage,
                                style = MaterialTheme.typography.bodyMedium,
                                color = Gray600,
                                fontWeight = FontWeight.Medium
                            )
                        }
                    }

                    // Stok b√∂l√ºm√º
                    Surface(
                        shape = RoundedCornerShape(14.dp),
                        color = when {
                            stockCount < 5 -> ErrorRed.copy(alpha = 0.12f)
                            stockCount < 10 -> WarningAmber.copy(alpha = 0.12f)
                            else -> SuccessGreen.copy(alpha = 0.12f)
                        }
                    ) {
                        Column(
                            horizontalAlignment = Alignment.CenterHorizontally,
                            verticalArrangement = Arrangement.spacedBy(2.dp),
                            modifier = Modifier.padding(horizontal = 16.dp, vertical = 10.dp)
                        ) {
                            Text(
                                text = "Stok",
                                style = MaterialTheme.typography.labelSmall,
                                color = Gray600,
                                fontWeight = FontWeight.Medium
                            )
                            Text(
                                text = "$stockCount",
                                style = MaterialTheme.typography.headlineSmall,
                                fontWeight = FontWeight.Bold,
                                color = when {
                                    stockCount < 5 -> ErrorRed
                                    stockCount < 10 -> Color(0xFFF59E0B)
                                    else -> Color(0xFF059669)
                                }
                            )
                        }
                    }
                }
            }

            // Hatƒ±rlatmalar b√∂l√ºm√º
            if (reminders.isNotEmpty() || onAddReminder != null) {
                HorizontalDivider(color = Gray200.copy(alpha = 0.5f))

                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .clickable { expanded = !expanded }
                        .padding(horizontal = 22.dp, vertical = 12.dp),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Row(
                        horizontalArrangement = Arrangement.spacedBy(8.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Icon(
                            Icons.Default.NotificationsActive,
                            contentDescription = null,
                            tint = DoziTurquoise,
                            modifier = Modifier.size(20.dp)
                        )
                        Text(
                            text = "Hatƒ±rlatmalar (${reminders.size})",
                            style = MaterialTheme.typography.bodyMedium,
                            fontWeight = FontWeight.Bold,
                            color = DoziTurquoise
                        )
                    }
                    Icon(
                        Icons.Default.ExpandMore,
                        contentDescription = if (expanded) "Kapat" else "A√ß",
                        tint = DoziTurquoise,
                        modifier = Modifier
                            .size(24.dp)
                            .rotate(rotationAngle)
                    )
                }
            }

            // Expandable hatƒ±rlatma listesi
            AnimatedVisibility(
                visible = expanded,
                enter = expandVertically() + fadeIn(),
                exit = shrinkVertically() + fadeOut()
            ) {
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .background(Gray100.copy(alpha = 0.3f))
                        .padding(horizontal = 22.dp, vertical = 12.dp),
                    verticalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    if (reminders.isEmpty()) {
                        Text(
                            text = "Hen√ºz hatƒ±rlatma eklenmemi≈ü",
                            style = MaterialTheme.typography.bodySmall,
                            color = Gray600,
                            modifier = Modifier.padding(vertical = 8.dp)
                        )
                    } else {
                        reminders.forEach { reminder ->
                            ReminderItem(
                                reminder = reminder,
                                onClick = { onReminderClick?.invoke(reminder.id) }
                            )
                        }
                    }

                    // Yeni hatƒ±rlatma ekle butonu
                    if (onAddReminder != null) {
                        OutlinedButton(
                            onClick = onAddReminder,
                            modifier = Modifier.fillMaxWidth(),
                            colors = ButtonDefaults.outlinedButtonColors(
                                contentColor = DoziTurquoise
                            ),
                            border = BorderStroke(
                                1.dp,
                                DoziTurquoise
                            )
                        ) {
                            Icon(
                                Icons.Default.Add,
                                contentDescription = null,
                                modifier = Modifier.size(18.dp)
                            )
                            Spacer(Modifier.width(8.dp))
                            Text(
                                "Yeni Hatƒ±rlatma Ekle",
                                fontWeight = FontWeight.Medium,
                                style = MaterialTheme.typography.bodyMedium
                            )
                        }
                    }
                }
            }
        }
    }
}

@Composable
private fun ReminderItem(
    reminder: Medicine,
    onClick: () -> Unit
) {
    Surface(
        modifier = Modifier
            .fillMaxWidth()
            .clickable(onClick = onClick),
        shape = RoundedCornerShape(12.dp),
        color = Color.White,
        shadowElevation = 2.dp
    ) {
        Row(
            modifier = Modifier
                .padding(12.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Column(
                verticalArrangement = Arrangement.spacedBy(4.dp),
                modifier = Modifier.weight(1f)
            ) {
                Row(
                    horizontalArrangement = Arrangement.spacedBy(8.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(
                        Icons.Default.Schedule,
                        contentDescription = null,
                        tint = DoziCoral,
                        modifier = Modifier.size(16.dp)
                    )
                    Text(
                        text = reminder.times.joinToString(", "),
                        style = MaterialTheme.typography.bodyMedium,
                        fontWeight = FontWeight.Bold,
                        color = Gray900
                    )
                }
                Text(
                    text = "${reminder.dosage} ${reminder.unit} ‚Ä¢ ${reminder.frequency}",
                    style = MaterialTheme.typography.bodySmall,
                    color = Gray600
                )
            }
            Icon(
                Icons.Default.ChevronRight,
                contentDescription = null,
                tint = Gray400,
                modifier = Modifier.size(20.dp)
            )
        }
    }
}
// ============================================================================
// FILE: PinDialog.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/components/PinDialog.kt
// [63 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.components

import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.focus.FocusRequester
import androidx.compose.ui.focus.focusRequester
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.text.input.PasswordVisualTransformation
import androidx.compose.ui.text.input.VisualTransformation
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import java.security.MessageDigest

/**
 * PIN Dialog for profile security
 * 4-digit PIN entry
 */
@Composable
fun PinDialog(
    title: String = "PIN Giri≈üi",
    message: String = "4 haneli PIN kodunuzu girin",
    onDismiss: () -> Unit,
    onPinEntered: (String) -> Unit,
    isError: Boolean = false
) {
    var pin by remember { mutableStateOf("") }
    val focusRequester = remember { FocusRequester() }

    LaunchedEffect(Unit) {
        focusRequester.requestFocus()
    }

    AlertDialog(
        onDismissRequest = onDismiss,
        icon = {
            Icon(
                Icons.Default.Lock,
                contentDescription = null,
                modifier = Modifier.size(32.dp)
            )
        },
        title = {
            Text(
                title,
                style = MaterialTheme.typography.titleLarge,
                fontWeight = FontWeight.Bold
            )
        },
        text = {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                Text(
                    message,
                    style = MaterialTheme.typography.bodyMedium,
                    textAlign = TextAlign.Center
                )

                // PIN dots display
                Row(
                    horizontalArrangement = Arrangement.spacedBy(12.dp),
                    modifier = Modifier.padding(vertical = 8.dp)
                ) {
                    repeat(4) { index ->
                        Box(
                            modifier = Modifier
                                .size(16.dp)
                                .clip(CircleShape)
                                .background(
                                    if (index < pin.length) {
                                        MaterialTheme.colorScheme.primary
                                    } else {
                                        MaterialTheme.colorScheme.surfaceVariant
                                    }
                                )
                        )
                    }
                }

                // Hidden text field for input
                OutlinedTextField(
                    value = pin,
                    onValueChange = { newPin ->
                        if (newPin.length <= 4 && newPin.all { it.isDigit() }) {
                            pin = newPin
                            if (newPin.length == 4) {
                                onPinEntered(hashPin(newPin))
                            }
                        }
                    },
                    modifier = Modifier
                        .width(1.dp)
                        .height(1.dp)
                        .focusRequester(focusRequester),
                    visualTransformation = PasswordVisualTransformation(),
                    keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.NumberPassword),
                    singleLine = true
                )

                if (isError) {
                    Text(
                        "Hatalƒ± PIN! Tekrar deneyin.",
                        color = MaterialTheme.colorScheme.error,
                        style = MaterialTheme.typography.bodySmall
                    )
                }
            }
        },
        confirmButton = {
            TextButton(
                onClick = {
                    if (pin.length == 4) {
                        onPinEntered(hashPin(pin))
                    }
                },
                enabled = pin.length == 4
            ) {
                Text("Onayla")
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text("ƒ∞ptal")
            }
        }
    )
}

/**
 * Create/Set PIN Dialog
 */
@Composable
fun SetPinDialog(
    title: String = "PIN Belirle",
    message: String = "Profil i√ßin 4 haneli PIN belirleyin",
    onDismiss: () -> Unit,
    onPinSet: (String) -> Unit
) {
    var pin by remember { mutableStateOf("") }
    var confirmPin by remember { mutableStateOf("") }
    var step by remember { mutableStateOf(1) } // 1: enter, 2: confirm
    var showError by remember { mutableStateOf(false) }

    AlertDialog(
        onDismissRequest = onDismiss,
        icon = {
            Icon(
                Icons.Default.Lock,
                contentDescription = null,
                modifier = Modifier.size(32.dp)
            )
        },
        title = {
            Text(
                title,
                style = MaterialTheme.typography.titleLarge,
                fontWeight = FontWeight.Bold
            )
        },
        text = {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                Text(
                    if (step == 1) message else "PIN kodunu tekrar girin",
                    style = MaterialTheme.typography.bodyMedium,
                    textAlign = TextAlign.Center
                )

                // PIN dots display
                Row(
                    horizontalArrangement = Arrangement.spacedBy(12.dp),
                    modifier = Modifier.padding(vertical = 8.dp)
                ) {
                    val currentPin = if (step == 1) pin else confirmPin
                    repeat(4) { index ->
                        Box(
                            modifier = Modifier
                                .size(16.dp)
                                .clip(CircleShape)
                                .background(
                                    if (index < currentPin.length) {
                                        MaterialTheme.colorScheme.primary
                                    } else {
                                        MaterialTheme.colorScheme.surfaceVariant
                                    }
                                )
                        )
                    }
                }

                // Hidden text field
                OutlinedTextField(
                    value = if (step == 1) pin else confirmPin,
                    onValueChange = { newPin ->
                        if (newPin.length <= 4 && newPin.all { it.isDigit() }) {
                            if (step == 1) {
                                pin = newPin
                                if (newPin.length == 4) {
                                    step = 2
                                    showError = false
                                }
                            } else {
                                confirmPin = newPin
                                if (newPin.length == 4) {
                                    if (newPin == pin) {
                                        onPinSet(hashPin(newPin))
                                    } else {
                                        showError = true
                                        confirmPin = ""
                                    }
                                }
                            }
                        }
                    },
                    modifier = Modifier
                        .width(1.dp)
                        .height(1.dp),
                    visualTransformation = PasswordVisualTransformation(),
                    keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.NumberPassword),
                    singleLine = true
                )

                if (showError) {
                    Text(
                        "PIN kodlarƒ± e≈üle≈ümiyor!",
                        color = MaterialTheme.colorScheme.error,
                        style = MaterialTheme.typography.bodySmall
                    )
                }
            }
        },
        confirmButton = {
            if (step == 2) {
                TextButton(
                    onClick = {
                        step = 1
                        pin = ""
                        confirmPin = ""
                        showError = false
                    }
                ) {
                    Text("Geri")
                }
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text("ƒ∞ptal")
            }
        }
    )
}

/**
 * Hash PIN using SHA-256
 */
fun hashPin(pin: String): String {
    val bytes = MessageDigest.getInstance("SHA-256").digest(pin.toByteArray())
    return bytes.joinToString("") { "%02x".format(it) }
}

// ============================================================================
// FILE: PremiumComponents.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/components/PremiumComponents.kt
// [64 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.components

import androidx.compose.animation.*
import androidx.compose.animation.core.*
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.scale
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.Dp
import androidx.compose.ui.unit.dp
import androidx.compose.ui.window.Dialog
import coil.compose.AsyncImage
import com.bardino.dozi.R
import com.bardino.dozi.core.ui.theme.*

// Compatibility aliases for deprecated colors used in this file
private val DoziTurquoise = DoziPrimary
private val DoziCoral = DoziSecondary
private val DoziBlue = DoziCharacterLight

/**
 * üëë Premium Badge Component
 *
 * Kullanƒ±cƒ± adƒ±nƒ±n yanƒ±nda premium rozeti g√∂sterir
 */
@Composable
fun PremiumBadge(
    modifier: Modifier = Modifier,
    size: Dp = 20.dp,
    animated: Boolean = true
) {
    val infiniteTransition = rememberInfiniteTransition(label = "premium_badge")
    val scale by infiniteTransition.animateFloat(
        initialValue = 1f,
        targetValue = 1.15f,
        animationSpec = infiniteRepeatable(
            animation = tween(1200, easing = EaseInOutSine),
            repeatMode = RepeatMode.Reverse
        ),
        label = "scale"
    )

    Image(
        painter = painterResource(R.drawable.dozi_king),
        contentDescription = "Dozi Ekstra",
        modifier = modifier
            .size(size)
            .then(
                if (animated) Modifier.scale(scale) else Modifier
            )
    )
}

/**
 * ‚ú® Premium Avatar with Frame
 *
 * Premium kullanƒ±cƒ±lar i√ßin √∂zel √ßer√ßeveli avatar
 */
@Composable
fun PremiumAvatar(
    photoUrl: String?,
    isPremium: Boolean,
    size: Dp = 64.dp,
    modifier: Modifier = Modifier,
    onClick: (() -> Unit)? = null
) {
    Box(
        modifier = modifier
            .size(size)
            .then(
                if (onClick != null) Modifier.clickable { onClick() }
                else Modifier
            ),
        contentAlignment = Alignment.Center
    ) {
        // Premium gradient √ßer√ßeve
        if (isPremium) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .background(
                        brush = Brush.sweepGradient(
                            colors = listOf(
                                DoziGold,
                                DoziCoral,
                                DoziPink,
                                DoziGold
                            )
                        ),
                        shape = CircleShape
                    )
            )
        }

        // Avatar resmi
        if (photoUrl.isNullOrEmpty()) {
            // Varsayƒ±lan avatar
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(if (isPremium) 4.dp else 0.dp)
                    .background(DoziTurquoise.copy(alpha = 0.2f), CircleShape),
                contentAlignment = Alignment.Center
            ) {
                Icon(
                    Icons.Default.Person,
                    contentDescription = "Avatar",
                    tint = DoziTurquoise,
                    modifier = Modifier.size(size * 0.6f)
                )
            }
        } else {
            // Kullanƒ±cƒ± fotoƒürafƒ±
            AsyncImage(
                model = photoUrl,
                contentDescription = "Profil Fotoƒürafƒ±",
                modifier = Modifier
                    .fillMaxSize()
                    .padding(if (isPremium) 4.dp else 0.dp)
                    .clip(CircleShape),
                contentScale = ContentScale.Crop
            )
        }

        // Premium badge (saƒü √ºst k√∂≈üe)
        if (isPremium) {
            Box(
                modifier = Modifier
                    .align(Alignment.TopEnd)
                    .offset(x = 4.dp, y = (-4).dp)
            ) {
                PremiumBadge(size = size * 0.35f)
            }
        }
    }
}

/**
 * üéÅ Premium Feature Gate Dialog
 *
 * Premium olmayan kullanƒ±cƒ±lara √∂zelliƒüi tanƒ±tan popup
 */
@Composable
fun PremiumGateDialog(
    visible: Boolean,
    featureName: String,
    featureDescription: String,
    onDismiss: () -> Unit,
    onUpgrade: () -> Unit
) {
    if (!visible) return

    Dialog(onDismissRequest = onDismiss) {
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            shape = RoundedCornerShape(24.dp),
            colors = CardDefaults.cardColors(containerColor = Color.White)
        ) {
            Column(
                modifier = Modifier.padding(24.dp),
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                // Dozi King logosu
                Image(
                    painter = painterResource(R.drawable.dozi_king),
                    contentDescription = "Dozi Ekstra",
                    modifier = Modifier.size(80.dp)
                )

                // Ba≈ülƒ±k
                Text(
                    text = "Dozi Ekstra √ñzelliƒüi",
                    style = MaterialTheme.typography.headlineSmall,
                    fontWeight = FontWeight.Bold,
                    color = TextPrimary,
                    textAlign = TextAlign.Center
                )

                // √ñzellik adƒ±
                Surface(
                    color = DoziTurquoise.copy(alpha = 0.1f),
                    shape = RoundedCornerShape(12.dp)
                ) {
                    Text(
                        text = featureName,
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold,
                        color = DoziTurquoise,
                        modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp)
                    )
                }

                // A√ßƒ±klama
                Text(
                    text = featureDescription,
                    style = MaterialTheme.typography.bodyMedium,
                    color = TextSecondary,
                    textAlign = TextAlign.Center
                )

                // √ñzellikler listesi (kƒ±sa)
                Column(
                    verticalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    PremiumFeatureItem("Geli≈ümi≈ü istatistikler")
                    PremiumFeatureItem("√ñzel bildirim sesleri")
                    PremiumFeatureItem("Bulut yedekleme")
                }

                Divider(color = Gray200)

                // Butonlar
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    // Daha sonra
                    OutlinedButton(
                        onClick = onDismiss,
                        modifier = Modifier.weight(1f),
                        shape = RoundedCornerShape(12.dp),
                        border = BorderStroke(1.dp, Gray200)
                    ) {
                        Text("Daha Sonra", color = TextSecondary)
                    }

                    // Premium'a ge√ß
                    Button(
                        onClick = onUpgrade,
                        modifier = Modifier.weight(1f),
                        shape = RoundedCornerShape(12.dp),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = DoziCoral
                        )
                    ) {
                        Icon(
                            Icons.Default.StarRate,
                            contentDescription = null,
                            modifier = Modifier.size(18.dp)
                        )
                        Spacer(Modifier.width(4.dp))
                        Text("Premium'a Ge√ß", fontWeight = FontWeight.Bold)
                    }
                }
            }
        }
    }
}

/**
 * Premium √∂zellik maddesi
 */
@Composable
private fun PremiumFeatureItem(text: String) {
    Row(
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        Icon(
            Icons.Default.CheckCircle,
            contentDescription = null,
            tint = SuccessGreen,
            modifier = Modifier.size(18.dp)
        )
        Text(
            text = text,
            style = MaterialTheme.typography.bodySmall,
            color = TextPrimary
        )
    }
}

/**
 * üåü Premium Banner
 *
 * Premium'a y√ºkseltmeyi te≈üvik eden banner
 */
@Composable
fun PremiumPromoBanner(
    onUpgradeClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier
            .fillMaxWidth()
            .clickable { onUpgradeClick() },
        shape = RoundedCornerShape(16.dp),
        colors = CardDefaults.cardColors(
            containerColor = Color.Transparent
        )
    ) {
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .background(
                    Brush.horizontalGradient(
                        colors = listOf(
                            DoziTurquoise,
                            DoziBlue
                        )
                    )
                )
                .padding(16.dp)
        ) {
            Row(
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.SpaceBetween,
                modifier = Modifier.fillMaxWidth()
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.spacedBy(12.dp),
                    modifier = Modifier.weight(1f)
                ) {
                    Image(
                        painter = painterResource(R.drawable.dozi_king),
                        contentDescription = "Dozi Ekstra",
                        modifier = Modifier.size(40.dp)
                    )

                    Column {
                        Text(
                            text = "Dozi Ekstra'ya Ge√ß",
                            style = MaterialTheme.typography.titleMedium,
                            fontWeight = FontWeight.Bold,
                            color = Color.White
                        )
                        Text(
                            text = "Premium √∂zellikleri ke≈üfet",
                            style = MaterialTheme.typography.bodySmall,
                            color = Color.White.copy(alpha = 0.9f)
                        )
                    }
                }

                Icon(
                    Icons.Default.ArrowForward,
                    contentDescription = null,
                    tint = Color.White,
                    modifier = Modifier.size(24.dp)
                )
            }
        }
    }
}

/**
 * üíé Premium Status Card
 *
 * Kullanƒ±cƒ±nƒ±n premium durumunu g√∂steren kart
 */
@Composable
fun PremiumStatusCard(
    isPremium: Boolean,
    planType: String,
    daysRemaining: Int,
    onManageClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier.fillMaxWidth(),
        shape = RoundedCornerShape(20.dp),
        colors = CardDefaults.cardColors(
            containerColor = if (isPremium) DoziGold.copy(alpha = 0.1f) else Gray100
        ),
        border = if (isPremium) BorderStroke(2.dp, DoziGold) else null
    ) {
        Column(
            modifier = Modifier.padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Row(
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.SpaceBetween,
                modifier = Modifier.fillMaxWidth()
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    if (isPremium) {
                        PremiumBadge(size = 28.dp)
                    }
                    Text(
                        text = if (isPremium) "Dozi Ekstra" else "√úcretsiz Plan",
                        style = MaterialTheme.typography.titleLarge,
                        fontWeight = FontWeight.Bold,
                        color = if (isPremium) DoziGold else TextPrimary
                    )
                }

                if (isPremium) {
                    Surface(
                        color = DoziGold.copy(alpha = 0.2f),
                        shape = RoundedCornerShape(8.dp)
                    ) {
                        Text(
                            text = planType.uppercase(),
                            style = MaterialTheme.typography.labelMedium,
                            fontWeight = FontWeight.Bold,
                            color = DoziGold,
                            modifier = Modifier.padding(horizontal = 12.dp, vertical = 4.dp)
                        )
                    }
                }
            }

            if (isPremium && daysRemaining > 0) {
                Text(
                    text = "$daysRemaining g√ºn kaldƒ±",
                    style = MaterialTheme.typography.bodyMedium,
                    color = TextSecondary
                )
            }

            Button(
                onClick = onManageClick,
                modifier = Modifier.fillMaxWidth(),
                shape = RoundedCornerShape(12.dp),
                colors = ButtonDefaults.buttonColors(
                    containerColor = if (isPremium) DoziGold else DoziCoral
                )
            ) {
                Text(
                    text = if (isPremium) "Planƒ± Y√∂net" else "Premium'a Ge√ß",
                    fontWeight = FontWeight.Bold,
                    color = Color.White
                )
            }
        }
    }
}

/**
 * üö´ Premium Limit Dialog
 *
 * Limit a≈üƒ±ldƒ±ƒüƒ±nda kullanƒ±cƒ±ya g√∂sterilecek dialog
 */
@Composable
fun PremiumLimitDialog(
    title: String,
    message: String,
    currentCount: Int,
    maxCount: Int,
    requiredPlan: String,
    onDismiss: () -> Unit,
    onUpgrade: () -> Unit,
    onSupportClick: (() -> Unit)? = null
) {
    Dialog(onDismissRequest = onDismiss) {
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            shape = RoundedCornerShape(24.dp),
            colors = CardDefaults.cardColors(containerColor = Color.White)
        ) {
            Column(
                modifier = Modifier.padding(24.dp),
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                // Icon
                Box(
                    modifier = Modifier
                        .size(64.dp)
                        .background(
                            color = DoziSecondary.copy(alpha = 0.1f),
                            shape = CircleShape
                        ),
                    contentAlignment = Alignment.Center
                ) {
                    Icon(
                        imageVector = Icons.Default.Lock,
                        contentDescription = null,
                        tint = DoziSecondary,
                        modifier = Modifier.size(32.dp)
                    )
                }

                // Title
                Text(
                    text = title,
                    style = MaterialTheme.typography.titleLarge,
                    fontWeight = FontWeight.Bold,
                    textAlign = TextAlign.Center
                )

                // Limit indicator
                Column(
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    Text(
                        text = "$currentCount / $maxCount",
                        style = MaterialTheme.typography.headlineMedium,
                        fontWeight = FontWeight.Bold,
                        color = DoziSecondary
                    )
                    LinearProgressIndicator(
                        progress = { currentCount.toFloat() / maxCount.toFloat() },
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(8.dp)
                            .clip(RoundedCornerShape(4.dp)),
                        color = DoziSecondary,
                        trackColor = Gray100
                    )
                }

                // Message
                Text(
                    text = message,
                    style = MaterialTheme.typography.bodyMedium,
                    color = TextSecondary,
                    textAlign = TextAlign.Center
                )

                // Required plan badge
                Surface(
                    color = DoziGold.copy(alpha = 0.1f),
                    shape = RoundedCornerShape(8.dp)
                ) {
                    Row(
                        modifier = Modifier.padding(horizontal = 12.dp, vertical = 8.dp),
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        PremiumBadge(size = 20.dp, animated = false)
                        Text(
                            text = "$requiredPlan ile sƒ±nƒ±rsƒ±z",
                            style = MaterialTheme.typography.labelMedium,
                            fontWeight = FontWeight.Bold,
                            color = DoziGold
                        )
                    }
                }

                // Support link
                if (onSupportClick != null) {
                    TextButton(onClick = onSupportClick) {
                        Icon(
                            Icons.Default.HelpOutline,
                            contentDescription = null,
                            modifier = Modifier.size(16.dp),
                            tint = TextSecondary
                        )
                        Spacer(Modifier.width(4.dp))
                        Text(
                            "Sorulariniz mi var? Destek'e bakin",
                            style = MaterialTheme.typography.bodySmall,
                            color = TextSecondary
                        )
                    }
                }

                // Buttons
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    OutlinedButton(
                        onClick = onDismiss,
                        modifier = Modifier.weight(1f),
                        shape = RoundedCornerShape(12.dp)
                    ) {
                        Text("Vazgec")
                    }
                    Button(
                        onClick = onUpgrade,
                        modifier = Modifier.weight(1f),
                        shape = RoundedCornerShape(12.dp),
                        colors = ButtonDefaults.buttonColors(containerColor = DoziGold)
                    ) {
                        Text("Yukselt", color = Color.White, fontWeight = FontWeight.Bold)
                    }
                }
            }
        }
    }
}

/**
 * üìä Limit Indicator
 *
 * Mevcut kullanƒ±mƒ± g√∂steren kompakt g√∂sterge
 */
@Composable
fun LimitIndicator(
    label: String,
    currentCount: Int,
    maxCount: Int,
    modifier: Modifier = Modifier,
    showWarning: Boolean = currentCount >= maxCount
) {
    val isUnlimited = maxCount == -1
    val progress = if (isUnlimited) 0f else currentCount.toFloat() / maxCount.toFloat()
    val color = when {
        isUnlimited -> DoziPrimary
        progress >= 1f -> DoziSecondary
        progress >= 0.8f -> Color(0xFFFF9800) // Orange
        else -> DoziPrimary
    }

    Row(
        modifier = modifier
            .background(
                color = color.copy(alpha = 0.1f),
                shape = RoundedCornerShape(8.dp)
            )
            .padding(horizontal = 12.dp, vertical = 6.dp),
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        if (showWarning && !isUnlimited) {
            Icon(
                imageVector = Icons.Default.Warning,
                contentDescription = null,
                tint = color,
                modifier = Modifier.size(16.dp)
            )
        }
        Text(
            text = if (isUnlimited) "$label: $currentCount" else "$label: $currentCount/$maxCount",
            style = MaterialTheme.typography.labelMedium,
            fontWeight = FontWeight.Medium,
            color = color
        )
    }
}

// ============================================================================
// FILE: BadiViewModel.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/viewmodel/BadiViewModel.kt
// [65 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.viewmodel

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.bardino.dozi.core.data.model.*
import com.bardino.dozi.core.data.repository.BadiRepository
import com.bardino.dozi.core.data.repository.MedicationLogRepository
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.*
import kotlinx.coroutines.launch
import javax.inject.Inject

/**
 * Badi sistem UI durumu
 */
data class BadiUiState(
    val badis: List<BadiWithUser> = emptyList(),
    val pendingRequests: List<BadiRequestWithUser> = emptyList(),
    val isLoading: Boolean = false,
    val error: String? = null,
    val badiCode: String? = null
)

/**
 * Badi arama durumu
 */
data class BadiSearchState(
    val searchQuery: String = "",
    val foundUser: User? = null,
    val isSearching: Boolean = false,
    val error: String? = null
)

/**
 * Badi ViewModel
 */
@HiltViewModel
class BadiViewModel @Inject constructor(
    private val badiRepository: BadiRepository,
    private val medicationLogRepository: MedicationLogRepository
) : ViewModel() {

    private val _uiState = MutableStateFlow(BadiUiState())
    val uiState: StateFlow<BadiUiState> = _uiState.asStateFlow()

    private val _searchState = MutableStateFlow(BadiSearchState())
    val searchState: StateFlow<BadiSearchState> = _searchState.asStateFlow()

    private val _selectedBadiLogs = MutableStateFlow<List<MedicationLog>>(emptyList())
    val selectedBadiLogs: StateFlow<List<MedicationLog>> = _selectedBadiLogs.asStateFlow()

    // Expose badis for direct access
    val badis: StateFlow<List<BadiWithUser>> = _uiState.map { it.badis }.stateIn(
        viewModelScope,
        SharingStarted.WhileSubscribed(5000),
        emptyList()
    )

    init {
        loadBadis()
        loadPendingRequests()
        // Duplicate ve stale kayƒ±tlarƒ± temizle
        cleanupData()
    }

    /**
     * Duplicate badi ve stale request kayƒ±tlarƒ±nƒ± temizle
     */
    private fun cleanupData() {
        viewModelScope.launch {
            // Stale request'leri temizle (√ñNCE!)
            badiRepository.cleanupStaleRequests()
                .onSuccess { deletedCount ->
                    if (deletedCount > 0) {
                        android.util.Log.d("BadiViewModel", "üßπ Cleaned up $deletedCount stale requests")
                    }
                }
                .onFailure { error ->
                    android.util.Log.e("BadiViewModel", "Request cleanup failed", error as? Throwable)
                }

            // Duplicate badileri temizle
            badiRepository.cleanupDuplicateBadis()
                .onSuccess { deletedCount ->
                    if (deletedCount > 0) {
                        android.util.Log.d("BadiViewModel", "üßπ Cleaned up $deletedCount duplicate badis")
                    }
                }
                .onFailure { error ->
                    android.util.Log.e("BadiViewModel", "Badi cleanup failed", error as? Throwable)
                }

            // üî• Self-buddy kayƒ±tlarƒ±nƒ± temizle
            badiRepository.cleanupSelfBuddies()
                .onSuccess { deletedCount ->
                    if (deletedCount > 0) {
                        android.util.Log.d("BadiViewModel", "üßπ Cleaned up $deletedCount self-buddy records")
                    }
                }
                .onFailure { error ->
                    android.util.Log.e("BadiViewModel", "Self-buddy cleanup failed", error as? Throwable)
                }
        }
    }

    // ==================== Badi ƒ∞≈ülemleri ====================

    /**
     * Badileri y√ºkle
     */
    private fun loadBadis() {
        viewModelScope.launch {
            badiRepository.getBadisFlow()
                .catch { error ->
                    _uiState.update { it.copy(error = error.message) }
                }
                .collect { badis ->
                    _uiState.update { it.copy(badis = badis) }
                }
        }
    }

    /**
     * Bekleyen istekleri y√ºkle
     */
    private fun loadPendingRequests() {
        viewModelScope.launch {
            android.util.Log.d("BadiViewModel", "Starting to load pending requests...")
            badiRepository.getPendingBadiRequestsFlow()
                .catch { error ->
                    android.util.Log.e("BadiViewModel", "Error loading pending requests", error)
                    _uiState.update { it.copy(error = error.message) }
                }
                .collect { requests ->
                    android.util.Log.d("BadiViewModel", "Received ${requests.size} pending requests in ViewModel")
                    _uiState.update { it.copy(pendingRequests = requests) }
                }
        }
    }

    /**
     * Badi izinlerini g√ºncelle
     */
    fun updateBadiPermissions(badiId: String, permissions: BadiPermissions) {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            badiRepository.updateBadiPermissions(badiId, permissions)
                .onSuccess {
                    _uiState.update { it.copy(isLoading = false, error = null) }
                }
                .onFailure { error ->
                    _uiState.update { it.copy(isLoading = false, error = error.message) }
                }
        }
    }

    /**
     * Badi bildirim tercihlerini g√ºncelle
     */
    fun updateBadiNotificationPreferences(
        badiId: String,
        preferences: BadiNotificationPreferences
    ) {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            badiRepository.updateBadiNotificationPreferences(badiId, preferences)
                .onSuccess {
                    _uiState.update { it.copy(isLoading = false, error = null) }
                }
                .onFailure { error ->
                    _uiState.update { it.copy(isLoading = false, error = error.message) }
                }
        }
    }

    /**
     * Badiye nickname ekle
     */
    fun updateBadiNickname(badiId: String, nickname: String?) {
        viewModelScope.launch {
            badiRepository.updateBadiNickname(badiId, nickname)
                .onFailure { error ->
                    _uiState.update { it.copy(error = error.message) }
                }
        }
    }

    /**
     * Badiyi kaldƒ±r
     */
    fun removeBadi(badiId: String) {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            badiRepository.removeBadi(badiId)
                .onSuccess {
                    _uiState.update { it.copy(isLoading = false, error = null) }
                }
                .onFailure { error ->
                    _uiState.update { it.copy(isLoading = false, error = error.message) }
                }
        }
    }

    // ==================== Badi ƒ∞stekleri ====================

    /**
     * Badi kodu olu≈ütur
     */
    fun generateBadiCode() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            val code = badiRepository.generateBadiCode()
            _uiState.update { it.copy(isLoading = false, badiCode = code) }
        }
    }

    /**
     * Badi kodu ile kullanƒ±cƒ± ara
     */
    fun searchUserByBadiCode(code: String) {
        viewModelScope.launch {
            _searchState.update { it.copy(isSearching = true, searchQuery = code) }
            val user = badiRepository.findUserByBadiCode(code)
            if (user != null) {
                _searchState.update { it.copy(isSearching = false, foundUser = user, error = null) }
            } else {
                _searchState.update {
                    it.copy(
                        isSearching = false,
                        foundUser = null,
                        error = "Kullanƒ±cƒ± bulunamadƒ±"
                    )
                }
            }
        }
    }

    /**
     * Email ile kullanƒ±cƒ± ara
     */
    fun searchUserByEmail(email: String) {
        viewModelScope.launch {
            _searchState.update { it.copy(isSearching = true, searchQuery = email) }
            val user = badiRepository.findUserByEmail(email)
            if (user != null) {
                _searchState.update { it.copy(isSearching = false, foundUser = user, error = null) }
            } else {
                _searchState.update {
                    it.copy(
                        isSearching = false,
                        foundUser = null,
                        error = "Kullanƒ±cƒ± bulunamadƒ±"
                    )
                }
            }
        }
    }

    /**
     * Badi isteƒüi g√∂nder
     */
    fun sendBadiRequest(toUserId: String, message: String? = null) {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            badiRepository.sendBadiRequest(toUserId, message)
                .onSuccess {
                    _uiState.update { it.copy(isLoading = false, error = null) }
                    _searchState.update { BadiSearchState() } // Reset search state
                }
                .onFailure { error ->
                    _uiState.update { it.copy(isLoading = false, error = error.message) }
                }
        }
    }

    /**
     * Badi isteƒüini kabul et
     */
    fun acceptBadiRequest(requestId: String) {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            badiRepository.acceptBadiRequest(requestId)
                .onSuccess {
                    _uiState.update { it.copy(isLoading = false, error = null) }
                }
                .onFailure { error ->
                    _uiState.update { it.copy(isLoading = false, error = error.message) }
                }
        }
    }

    /**
     * Badi isteƒüini reddet
     */
    fun rejectBadiRequest(requestId: String) {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            badiRepository.rejectBadiRequest(requestId)
                .onSuccess {
                    _uiState.update { it.copy(isLoading = false, error = null) }
                }
                .onFailure { error ->
                    _uiState.update { it.copy(isLoading = false, error = error.message) }
                }
        }
    }

    // ==================== Badi ƒ∞la√ß Takibi ====================

    /**
     * Badinin ila√ß ge√ßmi≈üini y√ºkle
     */
    fun loadBadiMedicationLogs(badiUserId: String) {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            val logs = medicationLogRepository.getBuddyMedicationLogs(badiUserId)
            _selectedBadiLogs.value = logs
            _uiState.update { it.copy(isLoading = false) }
        }
    }

    // ==================== Badi Y√∂netimi ====================

    /**
     * Badi rol√ºn√º g√ºncelle
     */
    fun updateBadiRole(badiId: String, newRole: BadiRole) {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            badiRepository.updateBadiPermissions(badiId, BadiPermissions.fromRole(newRole))
                .onSuccess {
                    _uiState.update { it.copy(isLoading = false, error = null) }
                }
                .onFailure { error ->
                    _uiState.update { it.copy(isLoading = false, error = error.message) }
                }
        }
    }

    /**
     * Badi durumunu g√ºncelle (aktif/duraklatƒ±lmƒ±≈ü)
     */
    fun updateBadiStatus(badiId: String, status: BadiStatus) {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            badiRepository.updateBadiStatus(badiId, status)
                .onSuccess {
                    _uiState.update { it.copy(isLoading = false, error = null) }
                }
                .onFailure { error ->
                    _uiState.update { it.copy(isLoading = false, error = error.message) }
                }
        }
    }

    // ==================== Yardƒ±mcƒ± Fonksiyonlar ====================

    /**
     * Arama durumunu sƒ±fƒ±rla
     */
    fun clearSearchState() {
        _searchState.value = BadiSearchState()
    }

    /**
     * Hata mesajƒ±nƒ± temizle
     */
    fun clearError() {
        _uiState.update { it.copy(error = null) }
    }

    /**
     * Mevcut badi sayƒ±sƒ±nƒ± d√∂nd√ºr
     */
    suspend fun getBadiCount(): Int {
        return badiRepository.getActiveBadiCount()
    }
}

// ============================================================================
// FILE: NotificationViewModel.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/viewmodel/NotificationViewModel.kt
// [66 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.viewmodel

import android.content.Context
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.bardino.dozi.core.data.model.DoziNotification
import com.bardino.dozi.core.data.model.NotificationType
import com.bardino.dozi.core.data.repository.NotificationRepository
import com.bardino.dozi.core.data.repository.BadiRepository
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.*
import kotlinx.coroutines.launch
import javax.inject.Inject

/**
 * Bildirim UI durumu
 */
data class NotificationUiState(
    val notifications: List<DoziNotification> = emptyList(),
    val unreadCount: Int = 0,
    val isLoading: Boolean = false,
    val error: String? = null
)

/**
 * Notification ViewModel
 */
@HiltViewModel
class NotificationViewModel @Inject constructor(
    private val notificationRepository: NotificationRepository,
    private val badiRepository: BadiRepository
) : ViewModel() {

    private val _uiState = MutableStateFlow(NotificationUiState())
    val uiState: StateFlow<NotificationUiState> = _uiState.asStateFlow()

    init {
        loadNotifications()
        loadUnreadCount()
    }

    // ==================== Bildirim ƒ∞≈ülemleri ====================

    /**
     * Bildirimleri y√ºkle
     */
    private fun loadNotifications() {
        viewModelScope.launch {
            notificationRepository.getNotificationsFlow()
                .catch { error ->
                    _uiState.update { it.copy(error = error.message) }
                }
                .collect { notifications ->
                    _uiState.update { it.copy(notifications = notifications) }
                }
        }
    }

    /**
     * Okunmamƒ±≈ü bildirim sayƒ±sƒ±nƒ± y√ºkle
     */
    private fun loadUnreadCount() {
        viewModelScope.launch {
            notificationRepository.getUnreadCountFlow()
                .catch { error ->
                    _uiState.update { it.copy(error = error.message) }
                }
                .collect { count ->
                    _uiState.update { it.copy(unreadCount = count) }
                }
        }
    }

    /**
     * Bildirimi okundu olarak i≈üaretle
     */
    fun markAsRead(notificationId: String) {
        viewModelScope.launch {
            notificationRepository.markAsRead(notificationId)
                .onFailure { error ->
                    _uiState.update { it.copy(error = error.message) }
                }
        }
    }

    /**
     * T√ºm bildirimleri okundu olarak i≈üaretle
     */
    fun markAllAsRead() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            notificationRepository.markAllAsRead()
                .onSuccess {
                    _uiState.update { it.copy(isLoading = false, error = null) }
                }
                .onFailure { error ->
                    _uiState.update { it.copy(isLoading = false, error = error.message) }
                }
        }
    }

    /**
     * Bildirimi sil
     */
    fun deleteNotification(notificationId: String) {
        viewModelScope.launch {
            notificationRepository.deleteNotification(notificationId)
                .onFailure { error ->
                    _uiState.update { it.copy(error = error.message) }
                }
        }
    }

    /**
     * FCM token'ƒ± yenile
     */
    fun refreshFCMToken() {
        viewModelScope.launch {
            notificationRepository.refreshFCMToken()
                .onFailure { error ->
                    _uiState.update { it.copy(error = error.message) }
                }
        }
    }

    /**
     * Local notification g√∂ster
     */
    fun showLocalNotification(
        context: Context,
        title: String,
        body: String,
        type: NotificationType = NotificationType.GENERAL
    ) {
        viewModelScope.launch {
            notificationRepository.showLocalNotification(context, title, body, type)
                .onFailure { error ->
                    _uiState.update { it.copy(error = error.message) }
                }
        }
    }

    /**
     * ƒ∞la√ß hatƒ±rlatmasƒ± i√ßin badilere bildirim g√∂nder
     */
    fun sendMedicationReminderToBadis(
        medicineId: String,
        medicineName: String,
        dosage: String,
        time: String
    ) {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            notificationRepository.sendMedicationReminderToBadis(
                medicineId, medicineName, dosage, time
            )
                .onSuccess { sentCount ->
                    _uiState.update { it.copy(isLoading = false, error = null) }
                }
                .onFailure { error ->
                    _uiState.update { it.copy(isLoading = false, error = error.message) }
                }
        }
    }

    /**
     * Badi isteƒüini kabul et
     */
    fun acceptBadiRequest(requestId: String) {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            badiRepository.acceptBadiRequest(requestId)
                .onSuccess {
                    _uiState.update { it.copy(isLoading = false, error = null) }
                }
                .onFailure { error ->
                    _uiState.update { it.copy(isLoading = false, error = error.message) }
                }
        }
    }

    /**
     * Badi isteƒüini reddet
     */
    fun rejectBadiRequest(requestId: String) {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            badiRepository.rejectBadiRequest(requestId)
                .onSuccess {
                    _uiState.update { it.copy(isLoading = false, error = null) }
                }
                .onFailure { error ->
                    _uiState.update { it.copy(isLoading = false, error = error.message) }
                }
        }
    }

    // ==================== Yardƒ±mcƒ± Fonksiyonlar ====================

    /**
     * Hata mesajƒ±nƒ± temizle
     */
    fun clearError() {
        _uiState.update { it.copy(error = null) }
    }

    /**
     * Bildirimleri t√ºre g√∂re filtrele
     */
    fun getNotificationsByType(type: NotificationType): List<DoziNotification> {
        return _uiState.value.notifications.filter { it.type == type }
    }

    /**
     * Okunmamƒ±≈ü bildirimleri getir
     */
    fun getUnreadNotifications(): List<DoziNotification> {
        return _uiState.value.notifications.filter { !it.isRead }
    }
}

// ============================================================================
// FILE: AnalyticsDashboardScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/admin/AnalyticsDashboardScreen.kt
// [67 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.admin

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import com.bardino.dozi.core.data.model.PremiumAnalytics
import com.bardino.dozi.core.data.model.DailyAnalytics
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*

/**
 * üìä Analytics Dashboard (Admin Only)
 *
 * Premium kullanƒ±cƒ± istatistikleri, retention metrikleri ve kullanƒ±m verileri
 *
 * NOT: Bu ekran sadece admin kullanƒ±cƒ±larƒ± i√ßin. Production'da
 * eri≈üim kontrol√º eklenmeli.
 */
@Composable
fun AnalyticsDashboardScreen(
    premiumAnalytics: PremiumAnalytics?,
    recentDailyAnalytics: List<DailyAnalytics>,
    onNavigateBack: () -> Unit,
    onRefresh: () -> Unit
) {
    var isRefreshing by remember { mutableStateOf(false) }

    Scaffold(
        topBar = {
            DoziTopBar(
                title = "Analytics Dashboard",
                canNavigateBack = true,
                onNavigateBack = onNavigateBack,
                actions = {
                    IconButton(onClick = {
                        isRefreshing = true
                        onRefresh()
                        isRefreshing = false
                    }) {
                        Icon(
                            Icons.Default.Refresh,
                            contentDescription = "Yenile",
                            tint = if (isRefreshing) DoziPrimary else Gray600
                        )
                    }
                }
            )
        },
        containerColor = MaterialTheme.colorScheme.background
    ) { padding ->
        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding),
            contentPadding = PaddingValues(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // Premium Overview
            item {
                Text(
                    text = "Premium √ñzeti",
                    style = MaterialTheme.typography.titleLarge,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
            }

            if (premiumAnalytics != null) {
                item {
                    PremiumOverviewCard(premiumAnalytics)
                }

                item {
                    PremiumBreakdownCard(premiumAnalytics)
                }
            } else {
                item {
                    Card(
                        modifier = Modifier.fillMaxWidth(),
                        colors = CardDefaults.cardColors(containerColor = Color.White)
                    ) {
                        Box(
                            modifier = Modifier
                                .fillMaxWidth()
                                .padding(32.dp),
                            contentAlignment = Alignment.Center
                        ) {
                            Text(
                                text = "Analytics verileri y√ºkleniyor...",
                                style = MaterialTheme.typography.bodyMedium,
                                color = MaterialTheme.colorScheme.onSurfaceVariant
                            )
                        }
                    }
                }
            }

            // Daily Analytics
            item {
                Text(
                    text = "G√ºnl√ºk ƒ∞statistikler (Son 7 G√ºn)",
                    style = MaterialTheme.typography.titleLarge,
                    fontWeight = FontWeight.Bold,

                    color = MaterialTheme.colorScheme.onSurface,
                  
                    modifier = Modifier.padding(top = 16.dp)
                )
            }

            items(recentDailyAnalytics.take(7)) { daily ->
                DailyAnalyticsCard(daily)
            }

            // Footer note
            item {
                Card(
                    colors = CardDefaults.cardColors(
                        containerColor = InfoBlue.copy(alpha = 0.1f)
                    ),
                    shape = RoundedCornerShape(12.dp)
                ) {
                    Row(
                        modifier = Modifier.padding(16.dp),
                        horizontalArrangement = Arrangement.spacedBy(12.dp)
                    ) {
                        Icon(
                            Icons.Default.Info,
                            contentDescription = null,
                            tint = InfoBlue
                        )
                        Text(
                            text = "Bu veriler Firestore'daki analytics ve daily_analytics koleksiyonlarƒ±ndan gelir. Manuel olarak g√ºncellenmelidir.",
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
            }
        }
    }
}

@Composable
private fun PremiumOverviewCard(analytics: PremiumAnalytics) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        shape = RoundedCornerShape(16.dp)
    ) {
        Column(
            modifier = Modifier.padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // Toplam kullanƒ±cƒ±lar
            MetricRow(
                icon = Icons.Default.People,
                label = "Toplam Kullanƒ±cƒ±",
                value = analytics.totalUsers.toString(),
                color = DoziPrimary
            )

            Divider()

            // Premium kullanƒ±cƒ±lar
            MetricRow(
                icon = Icons.Default.StarRate,
                label = "Premium Kullanƒ±cƒ±",
                value = analytics.premiumUsers.toString(),
                color = DoziGold
            )

            // Trial kullanƒ±cƒ±lar
            MetricRow(
                icon = Icons.Default.CardGiftcard,
                label = "Trial Kullanƒ±cƒ±",
                value = analytics.trialUsers.toString(),
                color = DoziPrimary
            )

            Divider()

            // Conversion rate
            MetricRow(
                icon = Icons.Default.TrendingUp,
                label = "D√∂n√º≈ü√ºm Oranƒ±",
                value = String.format("%.1f%%", analytics.conversionRate * 100),
                color = SuccessGreen
            )

            // Revenue
            MetricRow(
                icon = Icons.Default.AttachMoney,
                label = "Toplam Gelir",
                value = "‚Ç∫${String.format("%.2f", analytics.totalRevenue)}",
                color = DoziGold
            )
        }
    }
}

@Composable
private fun PremiumBreakdownCard(analytics: PremiumAnalytics) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        shape = RoundedCornerShape(16.dp)
    ) {
        Column(
            modifier = Modifier.padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Text(
                text = "Plan Daƒüƒ±lƒ±mƒ±",
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )

            PlanBreakdownRow("Haftalƒ±k", analytics.weeklyUsers, DoziRose)
            PlanBreakdownRow("Aylƒ±k", analytics.monthlyUsers, DoziPrimary)
            PlanBreakdownRow("Yƒ±llƒ±k", analytics.yearlyUsers, DoziGold)
            PlanBreakdownRow("√ñm√ºr Boyu", analytics.lifetimeUsers, DoziGold)
        }
    }
}

@Composable
private fun DailyAnalyticsCard(daily: DailyAnalytics) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        shape = RoundedCornerShape(12.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            Text(
                text = daily.date,
                style = MaterialTheme.typography.titleSmall,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )

            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween
            ) {
                SmallMetric("Aktif", daily.activeUsers.toString(), DoziPrimary)
                SmallMetric("Yeni", daily.newSignups.toString(), SuccessGreen)
                SmallMetric("Premium", daily.premiumPurchases.toString(), DoziGold)
                SmallMetric("Trial", daily.trialStarts.toString(), DoziRose)
            }

            Divider()

            Text(
                text = "Retention: 1d ${(daily.retention1Day * 100).toInt()}% | 7d ${(daily.retention7Day * 100).toInt()}% | 30d ${(daily.retention30Day * 100).toInt()}%",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
}

@Composable
private fun MetricRow(
    icon: androidx.compose.ui.graphics.vector.ImageVector,
    label: String,
    value: String,
    color: Color
) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Row(
            horizontalArrangement = Arrangement.spacedBy(12.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Icon(
                icon,
                contentDescription = null,
                tint = color,
                modifier = Modifier.size(24.dp)
            )
            Text(
                text = label,
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
        Text(
            text = value,
            style = MaterialTheme.typography.titleMedium,
            fontWeight = FontWeight.Bold,
            color = color
        )
    }
}

@Composable
private fun PlanBreakdownRow(
    planName: String,
    count: Int,
    color: Color
) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Row(
            horizontalArrangement = Arrangement.spacedBy(8.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Box(
                modifier = Modifier
                    .size(12.dp)
                    .background(color, shape = RoundedCornerShape(3.dp))
            )
            Text(
                text = planName,
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
        Text(
            text = count.toString(),
            style = MaterialTheme.typography.bodyLarge,
            fontWeight = FontWeight.Bold,
            color = MaterialTheme.colorScheme.onSurface
        )
    }
}

@Composable
private fun SmallMetric(
    label: String,
    value: String,
    color: Color
) {
    Column(
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.spacedBy(4.dp)
    ) {
        Text(
            text = value,
            style = MaterialTheme.typography.titleSmall,
            fontWeight = FontWeight.Bold,
            color = color
        )
        Text(
            text = label,
            style = MaterialTheme.typography.labelSmall,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
    }
}

// ============================================================================
// FILE: AddBadiScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/badi/AddBadiScreen.kt
// [68 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.badi

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.KeyboardActions
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalClipboardManager
import androidx.compose.ui.platform.LocalFocusManager
import androidx.compose.ui.text.AnnotatedString
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.input.ImeAction
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import androidx.navigation.NavController
import dagger.hilt.EntryPoint
import dagger.hilt.InstallIn
import dagger.hilt.android.EntryPointAccessors
import dagger.hilt.components.SingletonComponent
import com.bardino.dozi.core.premium.PremiumManager
import com.bardino.dozi.core.ui.components.PremiumLimitDialog
import com.bardino.dozi.core.common.Constants
import com.bardino.dozi.core.ui.viewmodel.BadiViewModel
import com.bardino.dozi.navigation.Screen

// EntryPoint for accessing PremiumManager in Composable
@EntryPoint
@InstallIn(SingletonComponent::class)
interface AddBadiEntryPoint {
    fun premiumManager(): PremiumManager
}

/**
 * Badi Ekleme Ekranƒ±
 * Kullanƒ±cƒ± badi kodu veya email ile badi ekleyebilir
 */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun AddBadiScreen(
    onNavigateBack: () -> Unit,
    navController: NavController,
    viewModel: BadiViewModel = hiltViewModel()
) {
    val context = androidx.compose.ui.platform.LocalContext.current
    val uiState by viewModel.uiState.collectAsState()
    val searchState by viewModel.searchState.collectAsState()

    // üíé Premium Manager i√ßin EntryPoint eri≈üimi
    val premiumManager = remember {
        EntryPointAccessors.fromApplication(
            context.applicationContext,
            AddBadiEntryPoint::class.java
        ).premiumManager()
    }

    // üìä Badi limit state'leri
    var showLimitDialog by remember { mutableStateOf(false) }
    var currentBadiCount by remember { mutableStateOf(0) }
    var badiLimit by remember { mutableStateOf(0) }

    // Limit bilgilerini y√ºkle
    LaunchedEffect(Unit) {
        try {
            currentBadiCount = viewModel.getBadiCount()
            badiLimit = premiumManager.getBadiLimit()
            android.util.Log.d("AddBadiScreen", "üìä Badi limits loaded - Current: $currentBadiCount, Limit: $badiLimit")
        } catch (e: Exception) {
            android.util.Log.e("AddBadiScreen", "Error loading badi limits", e)
        }
    }

    var selectedTab by remember { mutableStateOf(0) }
    var searchQuery by remember { mutableStateOf("") }
    var message by remember { mutableStateOf("") }
    var showMyCodeDialog by remember { mutableStateOf(false) }

    val focusManager = LocalFocusManager.current

    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Icon(
                            Icons.Default.People,
                            contentDescription = null,
                            tint = Color.White
                        )
                        Text("Badi Ekle", color = Color.White, fontWeight = FontWeight.ExtraBold)
                    }
                },
                navigationIcon = {
                    IconButton(onClick = onNavigateBack) {
                        Icon(Icons.Default.ArrowBack, "Geri", tint = Color.White)
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = Color.Transparent
                ),
                modifier = Modifier.background(
                    androidx.compose.ui.graphics.Brush.horizontalGradient(
                        listOf(com.bardino.dozi.core.ui.theme.DoziTurquoise, com.bardino.dozi.core.ui.theme.DoziPurple)
                    )
                )
            )
        },
        containerColor = androidx.compose.ui.graphics.Color(0xFFF5F7FA)
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .verticalScroll(rememberScrollState())
                .padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // Kodumu g√∂ster butonu
            MyBadiCodeCard(
                onClick = {
                    viewModel.generateBadiCode()
                    showMyCodeDialog = true
                }
            )

            Divider()

            // Tab se√ßimi
            TabRow(selectedTabIndex = selectedTab) {
                Tab(
                    selected = selectedTab == 0,
                    onClick = { selectedTab = 0 },
                    text = { Text("üî¢ Kod ile") }
                )
                Tab(
                    selected = selectedTab == 1,
                    onClick = { selectedTab = 1 },
                    text = { Text("üìß Email ile") }
                )
            }

            Spacer(modifier = Modifier.height(8.dp))

            // Arama alanƒ±
            when (selectedTab) {
                0 -> {
                    // Kod ile arama
                    OutlinedTextField(
                        value = searchQuery,
                        onValueChange = { searchQuery = it },
                        modifier = Modifier.fillMaxWidth(),
                        label = { Text("BadiKodu") },
                        placeholder = { Text("6 haneli kod girin") },
                        leadingIcon = { Icon(Icons.Default.Pin, null) },
                        keyboardOptions = KeyboardOptions(
                            keyboardType = KeyboardType.Number,
                            imeAction = ImeAction.Search
                        ),
                        keyboardActions = KeyboardActions(
                            onSearch = {
                                if (searchQuery.length == 6) {
                                    viewModel.searchUserByBadiCode(searchQuery)
                                    focusManager.clearFocus()
                                }
                            }
                        ),
                        singleLine = true
                    )
                }
                1 -> {
                    // Email ile arama
                    OutlinedTextField(
                        value = searchQuery,
                        onValueChange = { searchQuery = it },
                        modifier = Modifier.fillMaxWidth(),
                        label = { Text("Email Adresi") },
                        placeholder = { Text("ornek@email.com") },
                        leadingIcon = { Icon(Icons.Default.Email, null) },
                        keyboardOptions = KeyboardOptions(
                            keyboardType = KeyboardType.Email,
                            imeAction = ImeAction.Search
                        ),
                        keyboardActions = KeyboardActions(
                            onSearch = {
                                if (searchQuery.isNotEmpty()) {
                                    viewModel.searchUserByEmail(searchQuery)
                                    focusManager.clearFocus()
                                }
                            }
                        ),
                        singleLine = true
                    )
                }
            }

            // Ara butonu
            Button(
                onClick = {
                    when (selectedTab) {
                        0 -> viewModel.searchUserByBadiCode(searchQuery)
                        1 -> viewModel.searchUserByEmail(searchQuery)
                    }
                },
                modifier = Modifier.fillMaxWidth(),
                enabled = searchQuery.isNotEmpty() && !searchState.isSearching
            ) {
                if (searchState.isSearching) {
                    CircularProgressIndicator(
                        modifier = Modifier.size(20.dp),
                        color = MaterialTheme.colorScheme.onPrimary
                    )
                } else {
                    Icon(Icons.Default.Search, "Ara")
                    Spacer(modifier = Modifier.width(8.dp))
                    Text("Kullanƒ±cƒ± Ara")
                }
            }

            // Kullanƒ±cƒ± bulundu mu?
            searchState.foundUser?.let { user ->
                Card(
                    modifier = Modifier.fillMaxWidth(),
                    shape = RoundedCornerShape(20.dp),
                    colors = CardDefaults.cardColors(containerColor = Color.White),
                    elevation = CardDefaults.cardElevation(defaultElevation = 6.dp)
                ) {
                    Box(
                        modifier = Modifier
                            .fillMaxWidth()
                            .background(
                                androidx.compose.ui.graphics.Brush.verticalGradient(
                                    listOf(
                                        com.bardino.dozi.core.ui.theme.SuccessGreen.copy(alpha = 0.12f),
                                        com.bardino.dozi.core.ui.theme.DoziTurquoise.copy(alpha = 0.12f)
                                    )
                                )
                            )
                    ) {
                        Column(
                            modifier = Modifier.padding(20.dp),
                            verticalArrangement = Arrangement.spacedBy(16.dp)
                        ) {
                            Row(
                                verticalAlignment = Alignment.CenterVertically,
                                horizontalArrangement = Arrangement.spacedBy(10.dp)
                            ) {
                                Box(
                                    modifier = Modifier
                                        .size(40.dp)
                                        .background(
                                            brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                                listOf(com.bardino.dozi.core.ui.theme.SuccessGreen, com.bardino.dozi.core.ui.theme.DoziTurquoise)
                                            ),
                                            shape = androidx.compose.foundation.shape.CircleShape
                                        ),
                                    contentAlignment = Alignment.Center
                                ) {
                                    Icon(
                                        Icons.Default.CheckCircle,
                                        contentDescription = null,
                                        tint = Color.White,
                                        modifier = Modifier.size(24.dp)
                                    )
                                }
                                Text(
                                    "Kullanƒ±cƒ± Bulundu",
                                    style = MaterialTheme.typography.titleLarge,
                                    fontWeight = FontWeight.ExtraBold,
                                    color = MaterialTheme.colorScheme.onSurface
                                )
                            }

                            Row(
                                verticalAlignment = Alignment.CenterVertically,
                                horizontalArrangement = Arrangement.spacedBy(14.dp)
                            ) {
                                Box(
                                    modifier = Modifier
                                        .size(56.dp)
                                        .background(
                                            brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                                listOf(com.bardino.dozi.core.ui.theme.DoziTurquoise.copy(alpha = 0.2f), com.bardino.dozi.core.ui.theme.DoziPurple.copy(alpha = 0.2f))
                                            ),
                                            shape = androidx.compose.foundation.shape.CircleShape
                                        ),
                                    contentAlignment = Alignment.Center
                                ) {
                                    Icon(
                                        Icons.Default.Person,
                                        null,
                                        modifier = Modifier.size(32.dp),
                                        tint = com.bardino.dozi.core.ui.theme.DoziTurquoise
                                    )
                                }
                                Column {
                                    Text(
                                        user.name,
                                        style = MaterialTheme.typography.titleLarge,
                                        fontWeight = FontWeight.Bold,
                                        color = MaterialTheme.colorScheme.onSurface
                                    )
                                    Text(
                                        user.email,
                                        style = MaterialTheme.typography.bodyMedium,
                                        color = MaterialTheme.colorScheme.onSurfaceVariant
                                    )
                                }
                            }

                            // Mesaj alanƒ±
                            OutlinedTextField(
                            value = message,
                            onValueChange = { message = it },
                            modifier = Modifier.fillMaxWidth(),
                            label = { Text("Mesaj (Opsiyonel)") },
                            placeholder = { Text("Bir mesaj ekleyin") },
                            maxLines = 3
                            )

                            // ƒ∞stek g√∂nder butonu
                            Button(
                                onClick = {
                                    // üìä Badi limit kontrol√º
                                    if (badiLimit != Constants.UNLIMITED && currentBadiCount >= badiLimit) {
                                        showLimitDialog = true
                                        return@Button
                                    }

                                    viewModel.sendBadiRequest(
                                        user.uid,
                                        message.ifEmpty { null }
                                    )
                                    searchQuery = ""
                                    message = ""
                                    viewModel.clearSearchState()
                                },
                                modifier = Modifier.fillMaxWidth(),
                                enabled = !uiState.isLoading
                            ) {
                                Icon(Icons.Default.Send, "G√∂nder")
                                Spacer(modifier = Modifier.width(8.dp))
                                Text("Badiƒ∞steƒüi G√∂nder")
                            }
                        }
                    }
                }
            }

            // Hata mesajƒ±
            searchState.error?.let { error ->
                Card(
                    modifier = Modifier.fillMaxWidth(),
                    colors = CardDefaults.cardColors(
                        containerColor = MaterialTheme.colorScheme.errorContainer
                    )
                ) {
                    Row(
                        modifier = Modifier.padding(16.dp),
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Icon(
                            Icons.Default.Error,
                            null,
                            tint = MaterialTheme.colorScheme.error
                        )
                        Text(
                            error,
                            color = MaterialTheme.colorScheme.onErrorContainer
                        )
                    }
                }
            }

            // ƒ∞pu√ßlarƒ±
            Card(
                modifier = Modifier.fillMaxWidth(),
                colors = CardDefaults.cardColors(containerColor = Color.White),
                shape = RoundedCornerShape(20.dp),
                elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
            ) {
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .background(
                            androidx.compose.ui.graphics.Brush.verticalGradient(
                                listOf(
                                    com.bardino.dozi.core.ui.theme.WarningOrange.copy(alpha = 0.08f),
                                    com.bardino.dozi.core.ui.theme.DoziTurquoise.copy(alpha = 0.08f)
                                )
                            )
                        )
                ) {
                    Column(
                        modifier = Modifier.padding(20.dp),
                        verticalArrangement = Arrangement.spacedBy(12.dp)
                    ) {
                        Row(
                            verticalAlignment = Alignment.CenterVertically,
                            horizontalArrangement = Arrangement.spacedBy(10.dp)
                        ) {
                            Box(
                                modifier = Modifier
                                    .size(40.dp)
                                    .background(
                                        brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                            listOf(com.bardino.dozi.core.ui.theme.WarningOrange, com.bardino.dozi.core.ui.theme.DoziTurquoise)
                                        ),
                                        shape = androidx.compose.foundation.shape.CircleShape
                                    ),
                                contentAlignment = Alignment.Center
                            ) {
                                Text(
                                    "üí°",
                                    style = MaterialTheme.typography.titleMedium
                                )
                            }
                            Text(
                                "ƒ∞pu√ßlarƒ±",
                                style = MaterialTheme.typography.titleLarge,
                                fontWeight = FontWeight.ExtraBold,
                                color = MaterialTheme.colorScheme.onSurface
                            )
                        }
                        Text(
                            "‚Ä¢ Badi kodunuz ile arkada≈ülarƒ±nƒ±z sizi kolayca bulabilir",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                        Text(
                            "‚Ä¢ Email ile arama yapmak i√ßin kayƒ±tlƒ± email adresi gereklidir",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                        Text(
                            "‚Ä¢ Badi istekleri 7 g√ºn ge√ßerlidir",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
            }
        }
    }

    // üìä Premium limit dialog'u
    if (showLimitDialog) {
        PremiumLimitDialog(
            title = "Badi Limitine Ula≈ütƒ±nƒ±z",
            message = "√úcretsiz planda badi ekleyemezsiniz. Daha fazla badi eklemek i√ßin Dozi Ekstra'ya y√ºkseltin.",
            currentCount = currentBadiCount,
            maxCount = badiLimit,
            requiredPlan = "Dozi Ekstra",
            onDismiss = {
                showLimitDialog = false
            },
            onUpgrade = {
                showLimitDialog = false
                navController.navigate(Screen.Premium.route)
            }
        )
    }

    // Kodumu g√∂ster dialog
    if (showMyCodeDialog && uiState.badiCode != null) {
        MyBuddyCodeDialog(
            code = uiState.badiCode!!,
            onDismiss = { showMyCodeDialog = false }
        )
    }
}

@Composable
fun MyBadiCodeCard(onClick: () -> Unit) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        onClick = onClick,
        colors = CardDefaults.cardColors(containerColor = Color.White),
        shape = RoundedCornerShape(20.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 6.dp)
    ) {
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .background(
                    androidx.compose.ui.graphics.Brush.horizontalGradient(
                        listOf(
                            com.bardino.dozi.core.ui.theme.DoziTurquoise.copy(alpha = 0.15f),
                            com.bardino.dozi.core.ui.theme.DoziPurple.copy(alpha = 0.15f)
                        )
                    )
                )
        ) {
            Row(
                modifier = Modifier.padding(20.dp),
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.SpaceBetween
            ) {
                Column(modifier = Modifier.weight(1f)) {
                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Text(
                            "üé´",
                            style = MaterialTheme.typography.headlineMedium
                        )
                        Text(
                            "Kodumu G√∂ster",
                            style = MaterialTheme.typography.titleLarge,
                            fontWeight = FontWeight.ExtraBold,
                            color = MaterialTheme.colorScheme.onSurface
                        )
                    }
                    Spacer(modifier = Modifier.height(6.dp))
                    Text(
                        "Arkada≈ülarƒ±nƒ±z bu kodu kullanarak sizi bulabilir",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
                Box(
                    modifier = Modifier
                        .size(52.dp)
                        .background(
                            brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                listOf(com.bardino.dozi.core.ui.theme.DoziTurquoise, com.bardino.dozi.core.ui.theme.DoziPurple)
                            ),
                            shape = RoundedCornerShape(14.dp)
                        ),
                    contentAlignment = Alignment.Center
                ) {
                    Icon(
                        Icons.Default.QrCode,
                        "Kod",
                        tint = Color.White,
                        modifier = Modifier.size(28.dp)
                    )
                }
            }
        }
    }
}

@Composable
fun MyBuddyCodeDialog(
    code: String,
    onDismiss: () -> Unit
) {
    val clipboardManager = LocalClipboardManager.current

    AlertDialog(
        onDismissRequest = onDismiss,
        icon = { Icon(Icons.Default.QrCode, null, modifier = Modifier.size(48.dp)) },
        title = {
            Text(
                "BadiKodunuz",
                textAlign = TextAlign.Center
            )
        },
        text = {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                Text(
                    "Bu kodu arkada≈ülarƒ±nƒ±zla payla≈üƒ±n",
                    style = MaterialTheme.typography.bodyMedium,
                    textAlign = TextAlign.Center
                )
                Card(
                    colors = CardDefaults.cardColors(
                        containerColor = MaterialTheme.colorScheme.primaryContainer
                    )
                ) {
                    Text(
                        code,
                        modifier = Modifier.padding(24.dp),
                        style = MaterialTheme.typography.displaySmall,
                        fontWeight = FontWeight.Bold,
                        textAlign = TextAlign.Center
                    )
                }
            }
        },
        confirmButton = {
            Button(
                onClick = {
                    clipboardManager.setText(AnnotatedString(code))
                }
            ) {
                Icon(Icons.Default.ContentCopy, "Kopyala")
                Spacer(modifier = Modifier.width(8.dp))
                Text("Kopyala")
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text("Kapat")
            }
        }

    )
}


// ============================================================================
// FILE: BadiDetailScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/badi/BadiDetailScreen.kt
// [69 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.badi

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import coil.compose.AsyncImage
import com.bardino.dozi.core.data.model.*
import com.bardino.dozi.core.ui.theme.DoziPurple
import com.bardino.dozi.core.ui.theme.DoziTurquoise
import com.bardino.dozi.core.ui.viewmodel.BadiViewModel
import java.text.SimpleDateFormat
import java.util.*

/**
 * Badi Detay Ekranƒ±
 * Bir badinin detaylarƒ±nƒ±, izinlerini ve ayarlarƒ±nƒ± g√∂sterir
 */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun BadiDetailScreen(
    badiId: String,
    onNavigateBack: () -> Unit,
    viewModel: BadiViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsState()
    val badiWithUser = uiState.badis.firstOrNull { it.badi.id == badiId }

    var showRemoveDialog by remember { mutableStateOf(false) }
    var showRoleDialog by remember { mutableStateOf(false) }

    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Icon(
                            Icons.Default.Person,
                            contentDescription = null,
                            tint = Color.White
                        )
                        Text("Badi Detaylarƒ±", color = Color.White, fontWeight = FontWeight.ExtraBold)
                    }
                },
                navigationIcon = {
                    IconButton(onClick = onNavigateBack) {
                        Icon(Icons.Default.ArrowBack, "Geri", tint = Color.White)
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = Color.Transparent
                ),
                modifier = Modifier.background(
                    androidx.compose.ui.graphics.Brush.horizontalGradient(
                        listOf(DoziTurquoise, DoziPurple)
                    )
                )
            )
        },
        containerColor = Color(0xFFF5F7FA)
    ) { padding ->
        if (badiWithUser == null) {
            // Badi bulunamadƒ±
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding),
                contentAlignment = Alignment.Center
            ) {
                Column(
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    Icon(
                        Icons.Default.Error,
                        contentDescription = null,
                        modifier = Modifier.size(64.dp),
                        tint = MaterialTheme.colorScheme.error
                    )
                    Text(
                        "Badi bulunamadƒ±",
                        style = MaterialTheme.typography.titleLarge,
                        fontWeight = FontWeight.Bold
                    )
                    Button(onClick = onNavigateBack) {
                        Text("Geri D√∂n")
                    }
                }
            }
        } else {
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding)
                    .verticalScroll(rememberScrollState())
                    .padding(16.dp),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                // Badi Profil Kartƒ±
                BadiProfileCard(badiWithUser)

                // Rol ve ƒ∞zinler Kartƒ±
                RoleAndPermissionsCard(
                    badi = badiWithUser.badi,
                    onEditRole = { showRoleDialog = true }
                )

                // Bildirim Tercihleri Kartƒ±
                NotificationPreferencesCard(
                    preferences = badiWithUser.badi.notificationPreferences,
                    onUpdatePreferences = { prefs ->
                        viewModel.updateBadiNotificationPreferences(badiId, prefs)
                    }
                )

                // Tehlikeli ƒ∞≈ülemler
                DangerZoneCard(
                    badiStatus = badiWithUser.badi.status,
                    onPauseBadi = {
                        viewModel.updateBadiStatus(badiId, BadiStatus.PAUSED)
                    },
                    onActivateBadi = {
                        viewModel.updateBadiStatus(badiId, BadiStatus.ACTIVE)
                    },
                    onRemoveBadi = { showRemoveDialog = true }
                )
            }

            // Rol Deƒüi≈ütirme Dialog
            if (showRoleDialog) {
                RoleSelectionDialog(
                    currentRole = badiWithUser.badi.permissions.role,
                    onDismiss = { showRoleDialog = false },
                    onRoleSelected = { role ->
                        viewModel.updateBadiRole(badiId, role)
                        showRoleDialog = false
                    }
                )
            }

            // Badi Kaldƒ±rma Dialog
            if (showRemoveDialog) {
                AlertDialog(
                    onDismissRequest = { showRemoveDialog = false },
                    title = { Text("Badi'yi Kaldƒ±r") },
                    text = {
                        Text(
                            "${badiWithUser.user.name} adlƒ± badi'yi kaldƒ±rmak istediƒüinizden emin misiniz? " +
                                    "Bu i≈ülem geri alƒ±namaz."
                        )
                    },
                    confirmButton = {
                        TextButton(
                            onClick = {
                                viewModel.removeBadi(badiId)
                                showRemoveDialog = false
                                onNavigateBack()
                            },
                            colors = ButtonDefaults.textButtonColors(
                                contentColor = MaterialTheme.colorScheme.error
                            )
                        ) {
                            Text("Kaldƒ±r")
                        }
                    },
                    dismissButton = {
                        TextButton(onClick = { showRemoveDialog = false }) {
                            Text("ƒ∞ptal")
                        }
                    }
                )
            }
        }
    }
}

@Composable
private fun BadiProfileCard(badiWithUser: BadiWithUser) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        shape = RoundedCornerShape(16.dp),
        colors = CardDefaults.cardColors(containerColor = Color.White)
    ) {
        Column(
            modifier = Modifier.padding(20.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            // Profil Resmi
            AsyncImage(
                model = badiWithUser.user.photoUrl ?: "https://via.placeholder.com/150",
                contentDescription = "Profil Resmi",
                modifier = Modifier
                    .size(80.dp)
                    .clip(CircleShape)
                    .background(DoziTurquoise.copy(alpha = 0.2f))
            )

            // ƒ∞sim ve Nickname
            Text(
                text = badiWithUser.user.name,
                style = MaterialTheme.typography.titleLarge,
                fontWeight = FontWeight.Bold
            )

            if (!badiWithUser.badi.nickname.isNullOrBlank()) {
                Text(
                    text = "\"${badiWithUser.badi.nickname}\"",
                    style = MaterialTheme.typography.bodyMedium,
                    color = Color.Gray,
                    fontStyle = androidx.compose.ui.text.font.FontStyle.Italic
                )
            }

            // Email
            Row(
                horizontalArrangement = Arrangement.spacedBy(8.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Icon(
                    Icons.Default.Email,
                    contentDescription = null,
                    modifier = Modifier.size(16.dp),
                    tint = Color.Gray
                )
                Text(
                    text = badiWithUser.user.email,
                    style = MaterialTheme.typography.bodyMedium,
                    color = Color.Gray
                )
            }

            // Badi olma tarihi
            badiWithUser.badi.createdAt?.let { timestamp ->
                val date = timestamp.toDate()
                val formatter = SimpleDateFormat("dd MMM yyyy", Locale("tr"))
                Row(
                    horizontalArrangement = Arrangement.spacedBy(8.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(
                        Icons.Default.CalendarToday,
                        contentDescription = null,
                        modifier = Modifier.size(16.dp),
                        tint = Color.Gray
                    )
                    Text(
                        text = "Badi olma tarihi: ${formatter.format(date)}",
                        style = MaterialTheme.typography.bodySmall,
                        color = Color.Gray
                    )
                }
            }

            // Durum Badge
            BadiStatusBadge(status = badiWithUser.badi.status)
        }
    }
}

@Composable
private fun BadiStatusBadge(status: BadiStatus) {
    val (text, color) = when (status) {
        BadiStatus.ACTIVE -> "Aktif" to Color(0xFF4CAF50)
        BadiStatus.PAUSED -> "Duraklatƒ±ldƒ±" to Color(0xFFFF9800)
        BadiStatus.REMOVED -> "Kaldƒ±rƒ±ldƒ±" to Color(0xFFF44336)
    }

    Surface(
        shape = RoundedCornerShape(12.dp),
        color = color.copy(alpha = 0.1f)
    ) {
        Text(
            text = text,
            modifier = Modifier.padding(horizontal = 12.dp, vertical = 6.dp),
            color = color,
            style = MaterialTheme.typography.labelMedium,
            fontWeight = FontWeight.Bold
        )
    }
}

@Composable
private fun RoleAndPermissionsCard(
    badi: Badi,
    onEditRole: () -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        shape = RoundedCornerShape(16.dp),
        colors = CardDefaults.cardColors(containerColor = Color.White)
    ) {
        Column(
            modifier = Modifier.padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = "Rol ve ƒ∞zinler",
                    style = MaterialTheme.typography.titleMedium,
                    fontWeight = FontWeight.Bold
                )
                IconButton(onClick = onEditRole) {
                    Icon(Icons.Default.Edit, "Rol√º D√ºzenle", tint = DoziTurquoise)
                }
            }

            Divider()

            // Rol
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Column {
                    Text(
                        text = badi.permissions.role.toTurkish(),
                        style = MaterialTheme.typography.titleSmall,
                        fontWeight = FontWeight.Bold,
                        color = DoziPurple
                    )
                    Text(
                        text = badi.permissions.role.toDescription(),
                        style = MaterialTheme.typography.bodySmall,
                        color = Color.Gray
                    )
                }
            }

            Divider()

            // ƒ∞zin Listesi
            Text(
                text = "ƒ∞zinler:",
                style = MaterialTheme.typography.labelMedium,
                color = Color.Gray
            )

            PermissionItem("Hatƒ±rlatmalarƒ± G√∂r√ºnt√ºleme", badi.permissions.canViewReminders)
            PermissionItem("Bildirim Alma", badi.permissions.canReceiveNotifications)
            PermissionItem("ƒ∞la√ß Aldƒ± ƒ∞≈üaretleme", badi.permissions.canMarkAsTaken)
            PermissionItem("Hatƒ±rlatmalarƒ± D√ºzenleme", badi.permissions.canEditReminders)
            PermissionItem("ƒ∞la√ß Ekleme", badi.permissions.canAddMedicine)
            PermissionItem("ƒ∞la√ß Silme", badi.permissions.canDeleteMedicine)
            PermissionItem("ƒ∞la√ß Ge√ßmi≈üini G√∂r√ºnt√ºleme", badi.permissions.canViewMedicationHistory)
            PermissionItem("Badileri Y√∂netme", badi.permissions.canManageBadis)
        }
    }
}

@Composable
private fun PermissionItem(permission: String, hasPermission: Boolean) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        Icon(
            if (hasPermission) Icons.Default.CheckCircle else Icons.Default.Cancel,
            contentDescription = null,
            modifier = Modifier.size(20.dp),
            tint = if (hasPermission) Color(0xFF4CAF50) else Color.Gray.copy(alpha = 0.3f)
        )
        Text(
            text = permission,
            style = MaterialTheme.typography.bodyMedium,
            color = if (hasPermission) Color.Black else Color.Gray
        )
    }
}

@Composable
private fun NotificationPreferencesCard(
    preferences: BadiNotificationPreferences,
    onUpdatePreferences: (BadiNotificationPreferences) -> Unit
) {
    var currentPrefs by remember { mutableStateOf(preferences) }

    Card(
        modifier = Modifier.fillMaxWidth(),
        shape = RoundedCornerShape(16.dp),
        colors = CardDefaults.cardColors(containerColor = Color.White)
    ) {
        Column(
            modifier = Modifier.padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Text(
                text = "Bildirim Tercihleri",
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.Bold
            )

            Divider()

            NotificationToggleItem(
                title = "ƒ∞la√ß Zamanƒ±",
                description = "ƒ∞la√ß zamanƒ± geldiƒüinde bildir",
                checked = currentPrefs.onMedicationTime,
                onCheckedChange = {
                    currentPrefs = currentPrefs.copy(onMedicationTime = it)
                    onUpdatePreferences(currentPrefs)
                }
            )

            NotificationToggleItem(
                title = "ƒ∞la√ß Alƒ±ndƒ±",
                description = "ƒ∞la√ß alƒ±ndƒ±ƒüƒ±nda bildir",
                checked = currentPrefs.onMedicationTaken,
                onCheckedChange = {
                    currentPrefs = currentPrefs.copy(onMedicationTaken = it)
                    onUpdatePreferences(currentPrefs)
                }
            )

            NotificationToggleItem(
                title = "ƒ∞la√ß Atlandƒ±",
                description = "ƒ∞la√ß atlandƒ±ƒüƒ±nda bildir",
                checked = currentPrefs.onMedicationSkipped,
                onCheckedChange = {
                    currentPrefs = currentPrefs.copy(onMedicationSkipped = it)
                    onUpdatePreferences(currentPrefs)
                }
            )

            NotificationToggleItem(
                title = "ƒ∞la√ß Ka√ßƒ±rƒ±ldƒ±",
                description = "ƒ∞la√ß ka√ßƒ±rƒ±ldƒ±ƒüƒ±nda bildir",
                checked = currentPrefs.onMedicationMissed,
                onCheckedChange = {
                    currentPrefs = currentPrefs.copy(onMedicationMissed = it)
                    onUpdatePreferences(currentPrefs)
                }
            )
        }
    }
}

@Composable
private fun NotificationToggleItem(
    title: String,
    description: String,
    checked: Boolean,
    onCheckedChange: (Boolean) -> Unit
) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Column(modifier = Modifier.weight(1f)) {
            Text(
                text = title,
                style = MaterialTheme.typography.bodyMedium,
                fontWeight = FontWeight.Medium
            )
            Text(
                text = description,
                style = MaterialTheme.typography.bodySmall,
                color = Color.Gray
            )
        }
        Switch(
            checked = checked,
            onCheckedChange = onCheckedChange,
            colors = SwitchDefaults.colors(
                checkedThumbColor = DoziTurquoise,
                checkedTrackColor = DoziTurquoise.copy(alpha = 0.5f)
            )
        )
    }
}

@Composable
private fun DangerZoneCard(
    badiStatus: BadiStatus,
    onPauseBadi: () -> Unit,
    onActivateBadi: () -> Unit,
    onRemoveBadi: () -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        shape = RoundedCornerShape(16.dp),
        colors = CardDefaults.cardColors(containerColor = Color(0xFFFFF3E0))
    ) {
        Column(
            modifier = Modifier.padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Row(
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Icon(
                    Icons.Default.Warning,
                    contentDescription = null,
                    tint = Color(0xFFFF9800)
                )
                Text(
                    text = "Tehlikeli ƒ∞≈ülemler",
                    style = MaterialTheme.typography.titleMedium,
                    fontWeight = FontWeight.Bold,
                    color = Color(0xFFFF9800)
                )
            }

            Divider(color = Color(0xFFFF9800).copy(alpha = 0.3f))

            when (badiStatus) {
                BadiStatus.ACTIVE -> {
                    OutlinedButton(
                        onClick = onPauseBadi,
                        modifier = Modifier.fillMaxWidth(),
                        colors = ButtonDefaults.outlinedButtonColors(
                            contentColor = Color(0xFFFF9800)
                        )
                    ) {
                        Icon(Icons.Default.Pause, contentDescription = null)
                        Spacer(modifier = Modifier.width(8.dp))
                        Text("Badi ƒ∞li≈ükisini Duraklat")
                    }
                }
                BadiStatus.PAUSED -> {
                    Button(
                        onClick = onActivateBadi,
                        modifier = Modifier.fillMaxWidth(),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = Color(0xFF4CAF50)
                        )
                    ) {
                        Icon(Icons.Default.PlayArrow, contentDescription = null)
                        Spacer(modifier = Modifier.width(8.dp))
                        Text("Badi ƒ∞li≈ükisini Aktifle≈ütir")
                    }
                }
                BadiStatus.REMOVED -> {
                    // Kaldƒ±rƒ±lmƒ±≈ü badi i√ßin bir ≈üey g√∂sterme
                }
            }

            Button(
                onClick = onRemoveBadi,
                modifier = Modifier.fillMaxWidth(),
                colors = ButtonDefaults.buttonColors(
                    containerColor = MaterialTheme.colorScheme.error
                )
            ) {
                Icon(Icons.Default.PersonRemove, contentDescription = null)
                Spacer(modifier = Modifier.width(8.dp))
                Text("Badi ƒ∞li≈ükisini Kaldƒ±r")
            }
        }
    }
}

@Composable
private fun RoleSelectionDialog(
    currentRole: BadiRole,
    onDismiss: () -> Unit,
    onRoleSelected: (BadiRole) -> Unit
) {
    var selectedRole by remember { mutableStateOf(currentRole) }

    AlertDialog(
        onDismissRequest = onDismiss,
        title = { Text("Badi Rol√ºn√º Se√ß") },
        text = {
            Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                BadiRole.values().forEach { role ->
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .clickable { selectedRole = role }
                            .padding(8.dp),
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(12.dp)
                    ) {
                        RadioButton(
                            selected = selectedRole == role,
                            onClick = { selectedRole = role },
                            colors = RadioButtonDefaults.colors(
                                selectedColor = DoziTurquoise
                            )
                        )
                        Column {
                            Text(
                                text = role.toTurkish(),
                                fontWeight = FontWeight.Bold
                            )
                            Text(
                                text = role.toDescription(),
                                style = MaterialTheme.typography.bodySmall,
                                color = Color.Gray
                            )
                        }
                    }
                }
            }
        },
        confirmButton = {
            TextButton(
                onClick = { onRoleSelected(selectedRole) },
                colors = ButtonDefaults.textButtonColors(
                    contentColor = DoziTurquoise
                )
            ) {
                Text("Kaydet")
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text("ƒ∞ptal")
            }
        }
    )
}

// ============================================================================
// FILE: BadiListScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/badi/BadiListScreen.kt
// [70 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.badi

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import com.bardino.dozi.core.data.model.BadiWithUser
import com.bardino.dozi.core.data.model.BadiRequestWithUser
import com.bardino.dozi.core.ui.viewmodel.BadiViewModel
import coil.compose.AsyncImage

/**
 * Badi Listesi Ekranƒ±
 * Kullanƒ±cƒ±nƒ±n badilerini ve bekleyen isteklerini g√∂sterir
 */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun BadiListScreen(
    onNavigateBack: () -> Unit,
    onNavigateToAddBadi: () -> Unit,
    onNavigateToBadiDetail: (String) -> Unit,
    onNavigateToBadiPermissions: (String) -> Unit = {},
    viewModel: BadiViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsState()

    // Log UI state changes
    LaunchedEffect(uiState.pendingRequests.size, uiState.badis.size) {
        android.util.Log.d("BadiListScreen", "UI State - Pending requests: ${uiState.pendingRequests.size}, Badis: ${uiState.badis.size}")
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Icon(
                            Icons.Default.People,
                            contentDescription = null,
                            tint = Color.White
                        )
                        Text("Badilerim", color = Color.White, fontWeight = FontWeight.ExtraBold)
                    }
                },
                navigationIcon = {
                    IconButton(onClick = onNavigateBack) {
                        Icon(Icons.Default.ArrowBack, "Geri", tint = Color.White)
                    }
                },
                actions = {
                    IconButton(onClick = onNavigateToAddBadi) {
                        Icon(Icons.Default.PersonAdd, "Badi Ekle", tint = Color.White)
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = Color.Transparent
                ),
                modifier = Modifier.background(
                    androidx.compose.ui.graphics.Brush.horizontalGradient(
                        listOf(com.bardino.dozi.core.ui.theme.DoziTurquoise, com.bardino.dozi.core.ui.theme.DoziPurple)
                    )
                )
            )
        },
        containerColor = androidx.compose.ui.graphics.Color(0xFFF5F7FA),
        floatingActionButton = {
            FloatingActionButton(
                onClick = onNavigateToAddBadi,
                containerColor = com.bardino.dozi.core.ui.theme.DoziTurquoise
            ) {
                Icon(Icons.Default.PersonAdd, "Badi Ekle", tint = Color.White)
            }
        }
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
        ) {
            // Bekleyen istekler
            if (uiState.pendingRequests.isNotEmpty()) {
                PendingRequestsSection(
                    requests = uiState.pendingRequests,
                    onAccept = { viewModel.acceptBadiRequest(it) },
                    onReject = { viewModel.rejectBadiRequest(it) }
                )
                Divider()
            }

            // Badi listesi
            if (uiState.badis.isEmpty()) {
                EmptyBadiState(onAddBadi = onNavigateToAddBadi)
            } else {
                BadiList(
                    badis = uiState.badis,
                    onBadiClick = { badi ->
                        android.util.Log.d("BadiListScreen", "Badi clicked: id=${badi.badi.id}, userId=${badi.badi.userId}, buddyUserId=${badi.badi.buddyUserId}, userName=${badi.user.name}")
                        onNavigateToBadiDetail(badi.badi.id)
                    },
                    onPermissionsClick = { badiId ->
                        onNavigateToBadiPermissions(badiId)
                    }
                )
            }

            // Loading indicator
            if (uiState.isLoading) {
                Box(
                    modifier = Modifier.fillMaxSize(),
                    contentAlignment = Alignment.Center
                ) {
                    CircularProgressIndicator()
                }
            }

            // Error message
            uiState.error?.let { error ->
                Snackbar(
                    modifier = Modifier.padding(16.dp),
                    action = {
                        TextButton(onClick = { viewModel.clearError() }) {
                            Text("Tamam")
                        }
                    }
                ) {
                    Text(error)
                }
            }
        }
    }
}

@Composable
fun PendingRequestsSection(
    requests: List<BadiRequestWithUser>,
    onAccept: (String) -> Unit,
    onReject: (String) -> Unit
) {
    Column(
        modifier = Modifier
            .fillMaxWidth()
            .background(
                androidx.compose.ui.graphics.Brush.verticalGradient(
                    listOf(
                        com.bardino.dozi.core.ui.theme.WarningOrange.copy(alpha = 0.1f),
                        com.bardino.dozi.core.ui.theme.DoziTurquoise.copy(alpha = 0.08f)
                    )
                )
            )
            .padding(16.dp)
    ) {
        Row(
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            Box(
                modifier = Modifier
                    .size(36.dp)
                    .background(
                        brush = androidx.compose.ui.graphics.Brush.linearGradient(
                            listOf(com.bardino.dozi.core.ui.theme.WarningOrange, com.bardino.dozi.core.ui.theme.DoziTurquoise)
                        ),
                        shape = CircleShape
                    ),
                contentAlignment = Alignment.Center
            ) {
                Text(
                    "üì¨",
                    style = MaterialTheme.typography.titleMedium
                )
            }
            Text(
                "Bekleyen ƒ∞stekler (${requests.size})",
                style = MaterialTheme.typography.titleLarge,
                fontWeight = FontWeight.ExtraBold,
                color = MaterialTheme.colorScheme.onSurface
            )
        }
        Spacer(modifier = Modifier.height(12.dp))

        requests.forEach { request ->
            BadiRequestCard(
                request = request,
                onAccept = { onAccept(request.request.id) },
                onReject = { onReject(request.request.id) }
            )
            Spacer(modifier = Modifier.height(8.dp))
        }
    }
}

@Composable
fun BadiRequestCard(
    request: BadiRequestWithUser,
    onAccept: () -> Unit,
    onReject: () -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        shape = RoundedCornerShape(20.dp),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
    ) {
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .background(
                    androidx.compose.ui.graphics.Brush.horizontalGradient(
                        listOf(
                            com.bardino.dozi.core.ui.theme.WarningOrange.copy(alpha = 0.08f),
                            com.bardino.dozi.core.ui.theme.DoziTurquoise.copy(alpha = 0.08f)
                        )
                    )
                )
        ) {
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(16.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                // Profil fotoƒürafƒ±
                Box(
                    modifier = Modifier
                        .size(56.dp)
                        .background(
                            brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                listOf(com.bardino.dozi.core.ui.theme.WarningOrange, com.bardino.dozi.core.ui.theme.DoziTurquoise)
                            ),
                            shape = CircleShape
                        )
                        .padding(2.dp)
                ) {
                    AsyncImage(
                        model = request.fromUser.photoUrl,
                        contentDescription = "Profil",
                        modifier = Modifier
                            .fillMaxSize()
                            .clip(CircleShape)
                            .background(Color.White)
                    )
                }

                Spacer(modifier = Modifier.width(14.dp))

                // Kullanƒ±cƒ± bilgisi
                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        request.fromUser.name,
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.ExtraBold,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                    Text(
                        request.fromUser.email,
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                    request.request.message?.let { message ->
                        Spacer(modifier = Modifier.height(4.dp))
                        Text(
                            "\"$message\"",
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant,
                            fontWeight = FontWeight.Medium
                        )
                    }
                }

                // Butonlar
                Row(
                    horizontalArrangement = Arrangement.spacedBy(6.dp)
                ) {
                    Box(
                        modifier = Modifier
                            .size(44.dp)
                            .background(
                                brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                    listOf(com.bardino.dozi.core.ui.theme.SuccessGreen, com.bardino.dozi.core.ui.theme.DoziTurquoise)
                                ),
                                shape = RoundedCornerShape(12.dp)
                            )
                            .clickable(onClick = onAccept),
                        contentAlignment = Alignment.Center
                    ) {
                        Icon(
                            Icons.Default.Check,
                            "Kabul Et",
                            tint = Color.White,
                            modifier = Modifier.size(24.dp)
                        )
                    }
                    Box(
                        modifier = Modifier
                            .size(44.dp)
                            .background(
                                brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                    listOf(com.bardino.dozi.core.ui.theme.ErrorRed, com.bardino.dozi.core.ui.theme.WarningOrange)
                                ),
                                shape = RoundedCornerShape(12.dp)
                            )
                            .clickable(onClick = onReject),
                        contentAlignment = Alignment.Center
                    ) {
                        Icon(
                            Icons.Default.Close,
                            "Reddet",
                            tint = Color.White,
                            modifier = Modifier.size(24.dp)
                        )
                    }
                }
            }
        }
    }
}

@Composable
fun BadiList(
    badis: List<BadiWithUser>,
    onBadiClick: (BadiWithUser) -> Unit,
    onPermissionsClick: (String) -> Unit
) {
    LazyColumn(
        modifier = Modifier.fillMaxSize(),
        contentPadding = PaddingValues(16.dp),
        verticalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        items(badis, key = { it.badi.id }) { badi ->
            BadiCard(
                badi = badi,
                onClick = { onBadiClick(badi) },
                onPermissionsClick = { onPermissionsClick(badi.badi.id) }
            )
        }
    }
}

@Composable
fun BadiCard(
    badi: BadiWithUser,
    onClick: () -> Unit,
    onPermissionsClick: () -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        shape = RoundedCornerShape(20.dp),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
    ) {
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .background(
                    androidx.compose.ui.graphics.Brush.horizontalGradient(
                        listOf(
                            com.bardino.dozi.core.ui.theme.DoziTurquoise.copy(alpha = 0.08f),
                            com.bardino.dozi.core.ui.theme.DoziPurple.copy(alpha = 0.08f)
                        )
                    )
                )
                .clickable(onClick = onClick)
        ) {
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(16.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                // Profil fotoƒürafƒ±
                Box(
                    modifier = Modifier
                        .size(64.dp)
                        .background(
                            brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                listOf(com.bardino.dozi.core.ui.theme.DoziTurquoise, com.bardino.dozi.core.ui.theme.DoziPurple)
                            ),
                            shape = CircleShape
                        )
                        .padding(3.dp)
                ) {
                    AsyncImage(
                        model = badi.user.photoUrl,
                        contentDescription = "Profil",
                        modifier = Modifier
                            .fillMaxSize()
                            .clip(CircleShape)
                            .background(Color.White)
                    )
                }

                Spacer(modifier = Modifier.width(16.dp))

                // Kullanƒ±cƒ± bilgisi
                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        badi.badi.nickname ?: badi.user.name,
                        style = MaterialTheme.typography.titleLarge,
                        fontWeight = FontWeight.ExtraBold,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                    Text(
                        badi.user.email,
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )

                    // ƒ∞zin durumu
                    Row(
                        modifier = Modifier.padding(top = 6.dp),
                        horizontalArrangement = Arrangement.spacedBy(6.dp)
                    ) {
                        if (badi.badi.permissions.canViewReminders) {
                            Chip(text = "üìã ƒ∞la√ßlar", color = com.bardino.dozi.core.ui.theme.DoziTurquoise)
                        }
                        if (badi.badi.notificationPreferences.onMedicationTime) {
                            Chip(text = "üîî Bildirim", color = com.bardino.dozi.core.ui.theme.DoziPurple)
                        }
                    }
                }

                // ƒ∞zin Ayarlarƒ± butonu
                Box(
                    modifier = Modifier
                        .size(40.dp)
                        .background(
                            brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                listOf(com.bardino.dozi.core.ui.theme.WarningOrange, com.bardino.dozi.core.ui.theme.DoziTurquoise)
                            ),
                            shape = RoundedCornerShape(12.dp)
                        )
                        .clickable(onClick = onPermissionsClick),
                    contentAlignment = Alignment.Center
                ) {
                    Icon(
                        Icons.Default.Settings,
                        "ƒ∞zinler",
                        tint = Color.White,
                        modifier = Modifier.size(22.dp)
                    )
                }

                Spacer(modifier = Modifier.width(8.dp))

                // Detay butonu
                Box(
                    modifier = Modifier
                        .size(40.dp)
                        .background(
                            brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                listOf(com.bardino.dozi.core.ui.theme.DoziTurquoise, com.bardino.dozi.core.ui.theme.DoziPurple)
                            ),
                            shape = RoundedCornerShape(12.dp)
                        ),
                    contentAlignment = Alignment.Center
                ) {
                    Icon(
                        Icons.Default.ChevronRight,
                        "Detay",
                        tint = Color.White,
                        modifier = Modifier.size(24.dp)
                    )
                }
            }
        }
    }
}

@Composable
fun Chip(text: String, color: Color = com.bardino.dozi.core.ui.theme.DoziTurquoise) {
    Surface(
        shape = RoundedCornerShape(12.dp),
        color = color.copy(alpha = 0.15f),
        modifier = Modifier.padding(2.dp)
    ) {
        Text(
            text,
            modifier = Modifier.padding(horizontal = 10.dp, vertical = 5.dp),
            style = MaterialTheme.typography.labelSmall,
            fontWeight = FontWeight.Bold,
            color = color
        )
    }
}

@Composable
fun EmptyBadiState(onAddBadi: () -> Unit) {
    Box(
        modifier = Modifier.fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(20.dp),
            modifier = Modifier.padding(32.dp)
        ) {
            Box(
                modifier = Modifier
                    .size(120.dp)
                    .background(
                        brush = androidx.compose.ui.graphics.Brush.linearGradient(
                            listOf(
                                com.bardino.dozi.core.ui.theme.DoziTurquoise.copy(alpha = 0.2f),
                                com.bardino.dozi.core.ui.theme.DoziPurple.copy(alpha = 0.2f)
                            )
                        ),
                        shape = CircleShape
                    ),
                contentAlignment = Alignment.Center
            ) {
                Text(
                    "ü§ù",
                    style = MaterialTheme.typography.displayLarge
                )
            }
            Text(
                "Hen√ºz Badiniz Yok",
                style = MaterialTheme.typography.headlineSmall,
                fontWeight = FontWeight.ExtraBold,
                color = MaterialTheme.colorScheme.onSurface
            )
            Text(
                "Sevdiklerinizi badi olarak ekleyin\nila√ß takibinizi birlikte y√∂netin",
                style = MaterialTheme.typography.bodyLarge,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                textAlign = androidx.compose.ui.text.style.TextAlign.Center
            )
            Spacer(modifier = Modifier.height(8.dp))
            Button(
                onClick = onAddBadi,
                modifier = Modifier
                    .fillMaxWidth(0.7f)
                    .height(56.dp),
                colors = ButtonDefaults.buttonColors(
                    containerColor = Color.Transparent
                ),
                contentPadding = PaddingValues(0.dp)
            ) {
                Box(
                    modifier = Modifier
                        .fillMaxSize()
                        .background(
                            brush = androidx.compose.ui.graphics.Brush.horizontalGradient(
                                listOf(com.bardino.dozi.core.ui.theme.DoziTurquoise, com.bardino.dozi.core.ui.theme.DoziPurple)
                            ),
                            shape = RoundedCornerShape(16.dp)
                        ),
                    contentAlignment = Alignment.Center
                ) {
                    Row(
                        horizontalArrangement = Arrangement.spacedBy(8.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Icon(Icons.Default.PersonAdd, "Ekle", tint = Color.White)
                        Text("Badi Ekle", color = Color.White, fontWeight = FontWeight.Bold)
                    }
                }
            }
        }
    }
}

// ============================================================================
// FILE: BadiMedicationTrackingScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/badi/BadiMedicationTrackingScreen.kt
// [71 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.badi

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import com.bardino.dozi.core.data.model.*
import com.bardino.dozi.core.ui.viewmodel.BadiViewModel
import coil.compose.AsyncImage
import java.text.SimpleDateFormat
import java.util.*

/**
 * Badi ƒ∞la√ß Takibi Ekranƒ±
 * Badinin ila√ß alma ge√ßmi≈üini ve istatistiklerini g√∂sterir
 */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun BadiMedicationTrackingScreen(
    badiId: String,
    onNavigateBack: () -> Unit,
    viewModel: BadiViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsState()
    val medicationLogs by viewModel.selectedBadiLogs.collectAsState()

    // Badiyi bul
    val badi = uiState.badis.find { it.badi.id == badiId }

    LaunchedEffect(badiId) {
        badi?.let {
            viewModel.loadBadiMedicationLogs(it.badi.buddyUserId)
        }
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Text(badi?.badi?.nickname ?: badi?.user?.name ?: "Badi Takibi")
                },
                navigationIcon = {
                    IconButton(onClick = onNavigateBack) {
                        Icon(Icons.Default.ArrowBack, "Geri")
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = MaterialTheme.colorScheme.primaryContainer
                )
            )
        }
    ) { padding ->
        if (badi == null) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding),
                contentAlignment = Alignment.Center
            ) {
                Text("Badi bulunamadƒ±")
            }
            return@Scaffold
        }

        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding),
            contentPadding = PaddingValues(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // Badi bilgisi
            item {
                BadiInfoCard(badi = badi)
            }

            // ƒ∞statistikler
            item {
                MedicationStatsCard(logs = medicationLogs)
            }

            // Ge√ßmi≈ü ba≈ülƒ±k
            item {
                Text(
                    "üìã ƒ∞la√ß Ge√ßmi≈üi",
                    style = MaterialTheme.typography.titleMedium,
                    fontWeight = FontWeight.Bold
                )
            }

            // ƒ∞la√ß ge√ßmi≈üi
            if (medicationLogs.isEmpty()) {
                item {
                    EmptyMedicationLogsCard()
                }
            } else {
                items(medicationLogs, key = { it.id }) { log ->
                    MedicationLogCard(log = log)
                }
            }

            // Loading
            if (uiState.isLoading) {
                item {
                    Box(
                        modifier = Modifier.fillMaxWidth(),
                        contentAlignment = Alignment.Center
                    ) {
                        CircularProgressIndicator()
                    }
                }
            }
        }
    }
}

@Composable
fun BadiInfoCard(badi: BadiWithUser) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        shape = RoundedCornerShape(16.dp),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.primaryContainer
        )
    ) {
        Row(
            modifier = Modifier.padding(16.dp),
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            AsyncImage(
                model = badi.user.photoUrl,
                contentDescription = "Profil",
                modifier = Modifier
                    .size(64.dp)
                    .clip(CircleShape)
                    .background(MaterialTheme.colorScheme.primary.copy(alpha = 0.2f))
            )

            Column {
                Text(
                    badi.badi.nickname ?: badi.user.name,
                    style = MaterialTheme.typography.titleLarge,
                    fontWeight = FontWeight.Bold
                )
                Text(
                    badi.user.email,
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
                )
            }
        }
    }
}

@Composable
fun MedicationStatsCard(logs: List<MedicationLog>) {
    val takenCount = logs.count { it.status == MedicationStatus.TAKEN }
    val missedCount = logs.count { it.status == MedicationStatus.MISSED }
    val skippedCount = logs.count { it.status == MedicationStatus.SKIPPED }
    val totalCount = logs.size

    val adherenceRate = if (totalCount > 0) {
        (takenCount.toFloat() / totalCount * 100).toInt()
    } else 0

    Card(
        modifier = Modifier.fillMaxWidth(),
        shape = RoundedCornerShape(16.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Text(
                "üìä ƒ∞statistikler",
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.Bold
            )

            // Uyum oranƒ±
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    "Uyum Oranƒ±",
                    style = MaterialTheme.typography.bodyLarge
                )
                Text(
                    "%$adherenceRate",
                    style = MaterialTheme.typography.headlineMedium,
                    fontWeight = FontWeight.Bold,
                    color = when {
                        adherenceRate >= 80 -> MaterialTheme.colorScheme.primary
                        adherenceRate >= 60 -> MaterialTheme.colorScheme.tertiary
                        else -> MaterialTheme.colorScheme.error
                    }
                )
            }

            LinearProgressIndicator(
                progress = adherenceRate / 100f,
                modifier = Modifier
                    .fillMaxWidth()
                    .height(8.dp)
                    .clip(RoundedCornerShape(4.dp))
            )

            Divider()

            // Detaylƒ± istatistikler
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceEvenly
            ) {
                StatItem(
                    icon = "‚úÖ",
                    label = "Alƒ±nan",
                    value = takenCount.toString()
                )
                StatItem(
                    icon = "‚ùå",
                    label = "Ka√ßƒ±rƒ±lan",
                    value = missedCount.toString()
                )
                StatItem(
                    icon = "‚è≠Ô∏è",
                    label = "Atlanan",
                    value = skippedCount.toString()
                )
            }
        }
    }
}

@Composable
fun StatItem(
    icon: String,
    label: String,
    value: String
) {
    Column(
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.spacedBy(4.dp)
    ) {
        Text(
            icon,
            style = MaterialTheme.typography.headlineMedium
        )
        Text(
            value,
            style = MaterialTheme.typography.titleLarge,
            fontWeight = FontWeight.Bold
        )
        Text(
            label,
            style = MaterialTheme.typography.bodySmall,
            color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
        )
    }
}

@Composable
fun MedicationLogCard(log: MedicationLog) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        shape = RoundedCornerShape(12.dp)
    ) {
        Row(
            modifier = Modifier.padding(16.dp),
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            // Durum ikonu
            Surface(
                shape = CircleShape,
                color = when (log.status) {
                    MedicationStatus.TAKEN -> MaterialTheme.colorScheme.primaryContainer
                    MedicationStatus.MISSED -> MaterialTheme.colorScheme.errorContainer
                    MedicationStatus.SKIPPED -> MaterialTheme.colorScheme.tertiaryContainer
                    else -> MaterialTheme.colorScheme.surfaceVariant
                }
            ) {
                Text(
                    log.status.toEmoji(),
                    modifier = Modifier.padding(12.dp),
                    style = MaterialTheme.typography.headlineSmall
                )
            }

            // ƒ∞la√ß bilgisi
            Column(modifier = Modifier.weight(1f)) {
                Text(
                    log.medicineName,
                    style = MaterialTheme.typography.titleMedium,
                    fontWeight = FontWeight.Bold
                )
                Text(
                    log.dosage,
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
                )
                log.scheduledTime?.let { time ->
                    Text(
                        formatTimestamp(time),
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.5f)
                    )
                }
            }

            // Durum metni
            Surface(
                shape = RoundedCornerShape(8.dp),
                color = when (log.status) {
                    MedicationStatus.TAKEN -> MaterialTheme.colorScheme.primaryContainer
                    MedicationStatus.MISSED -> MaterialTheme.colorScheme.errorContainer
                    MedicationStatus.SKIPPED -> MaterialTheme.colorScheme.tertiaryContainer
                    else -> MaterialTheme.colorScheme.surfaceVariant
                }
            ) {
                Text(
                    log.status.toTurkish(),
                    modifier = Modifier.padding(horizontal = 12.dp, vertical = 6.dp),
                    style = MaterialTheme.typography.labelMedium,
                    fontWeight = FontWeight.Bold
                )
            }
        }
    }
}

@Composable
fun EmptyMedicationLogsCard() {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surfaceVariant.copy(alpha = 0.5f)
        )
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(32.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            Text(
                "üì≠",
                style = MaterialTheme.typography.displayMedium
            )
            Text(
                "Hen√ºz kayƒ±t yok",
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.Bold
            )
            Text(
                "Badi hen√ºz ila√ß kaydƒ± olu≈üturmamƒ±≈ü",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
            )
        }
    }
}

private fun formatTimestamp(timestamp: com.google.firebase.Timestamp): String {
    val date = timestamp.toDate()
    val dateFormat = SimpleDateFormat("dd MMM yyyy, HH:mm", Locale("tr"))
    return dateFormat.format(date)
}

// ============================================================================
// FILE: BadiPermissionsScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/badi/BadiPermissionsScreen.kt
// [72 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.badi

import android.os.Build
import androidx.annotation.RequiresApi
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.hilt.navigation.compose.hiltViewModel
import com.bardino.dozi.core.data.model.*
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*
import com.bardino.dozi.core.ui.viewmodel.BadiViewModel

@RequiresApi(Build.VERSION_CODES.O)
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun BadiPermissionsScreen(
    badiId: String,
    onNavigateBack: () -> Unit
) {
    val viewModel: BadiViewModel = hiltViewModel()
    val badis by viewModel.badis.collectAsState()

    val currentBadi = badis.find { it.badi.id == badiId }

    if (currentBadi == null) {
        // Badi bulunamadƒ±
        Scaffold(
            topBar = {
                DoziTopBar(
                    title = "Badi ƒ∞zinleri",
                    canNavigateBack = true,
                    onNavigateBack = onNavigateBack
                )
            }
        ) { padding ->
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding),
                contentAlignment = Alignment.Center
            ) {
                Text("Badi bulunamadƒ±")
            }
        }
        return
    }

    var permissions by remember { mutableStateOf(currentBadi.badi.permissions) }
    var hasChanges by remember { mutableStateOf(false) }

    Scaffold(
        topBar = {
            androidx.compose.material3.TopAppBar(
                title = {
                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Icon(
                            Icons.Default.Security,
                            contentDescription = null,
                            tint = Color.White
                        )
                        Text(
                            "${currentBadi.user.name} ƒ∞zinleri",
                            color = Color.White,
                            fontWeight = FontWeight.ExtraBold
                        )
                    }
                },
                navigationIcon = {
                    IconButton(onClick = onNavigateBack) {
                        Icon(Icons.Default.ArrowBack, "Geri", tint = Color.White)
                    }
                },
                actions = {
                    if (hasChanges) {
                        TextButton(onClick = {
                            viewModel.updateBadiPermissions(badiId, permissions)
                            hasChanges = false
                            onNavigateBack()
                        }) {
                            Text("Kaydet", color = Color.White, fontWeight = FontWeight.ExtraBold)
                        }
                    }
                },
                colors = androidx.compose.material3.TopAppBarDefaults.topAppBarColors(
                    containerColor = Color.Transparent
                ),
                modifier = Modifier.background(
                    androidx.compose.ui.graphics.Brush.horizontalGradient(
                        listOf(DoziTurquoise, DoziPurple)
                    )
                )
            )
        },
        containerColor = androidx.compose.ui.graphics.Color(0xFFF5F7FA)
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .verticalScroll(rememberScrollState())
                .padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // Badi Info Card
            BadiInfoCard(currentBadi.user)

            // Rol Se√ßimi
            RoleSelectionCard(
                currentRole = permissions.role,
                onRoleChange = { newRole ->
                    permissions = BadiPermissions.fromRole(newRole)
                    hasChanges = true
                }
            )

            // Detaylƒ± ƒ∞zinler
            Text(
                text = "Detaylƒ± ƒ∞zinler",
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.Bold,
                modifier = Modifier.padding(top = 8.dp)
            )

            PermissionCard(
                icon = Icons.Default.Visibility,
                title = "Hatƒ±rlatmalarƒ± G√∂r√ºnt√ºleme",
                description = "Badin ila√ß hatƒ±rlatmalarƒ±nƒ± g√∂rebilir",
                isEnabled = permissions.canViewReminders,
                onToggle = {
                    permissions = permissions.copy(canViewReminders = it)
                    hasChanges = true
                },
                color = DoziBlue
            )

            PermissionCard(
                icon = Icons.Default.Notifications,
                title = "Bildirim Alma",
                description = "Badin hatƒ±rlatma bildirimleri alƒ±r",
                isEnabled = permissions.canReceiveNotifications,
                onToggle = {
                    permissions = permissions.copy(canReceiveNotifications = it)
                    hasChanges = true
                },
                color = DoziTurquoise
            )

            PermissionCard(
                icon = Icons.Default.CheckCircle,
                title = "ƒ∞la√ß Alƒ±ndƒ± ƒ∞≈üaretleme",
                description = "Badin senin adƒ±na ila√ß alƒ±ndƒ± i≈üaretleyebilir",
                isEnabled = permissions.canMarkAsTaken,
                onToggle = {
                    permissions = permissions.copy(canMarkAsTaken = it)
                    hasChanges = true
                },
                color = Color(0xFF4CAF50)
            )

            PermissionCard(
                icon = Icons.Default.Edit,
                title = "Hatƒ±rlatma D√ºzenleme",
                description = "Badin ila√ß hatƒ±rlatmalarƒ±nƒ± d√ºzenleyebilir",
                isEnabled = permissions.canEditReminders,
                onToggle = {
                    permissions = permissions.copy(canEditReminders = it)
                    hasChanges = true
                },
                color = Color(0xFFFF9800)
            )

            PermissionCard(
                icon = Icons.Default.Add,
                title = "ƒ∞la√ß Ekleme",
                description = "Badin yeni ila√ß ekleyebilir",
                isEnabled = permissions.canAddMedicine,
                onToggle = {
                    permissions = permissions.copy(canAddMedicine = it)
                    hasChanges = true
                },
                color = Color(0xFF9C27B0)
            )

            PermissionCard(
                icon = Icons.Default.Delete,
                title = "ƒ∞la√ß Silme",
                description = "Badin ila√ßlarƒ± silebilir",
                isEnabled = permissions.canDeleteMedicine,
                onToggle = {
                    permissions = permissions.copy(canDeleteMedicine = it)
                    hasChanges = true
                },
                color = DoziCoralDark,
                isWarning = true
            )

            PermissionCard(
                icon = Icons.Default.History,
                title = "ƒ∞la√ß Ge√ßmi≈üini G√∂r√ºnt√ºleme",
                description = "Badin ila√ß alƒ±m ge√ßmi≈üini g√∂rebilir",
                isEnabled = permissions.canViewMedicationHistory,
                onToggle = {
                    permissions = permissions.copy(canViewMedicationHistory = it)
                    hasChanges = true
                },
                color = DoziBlue
            )

            PermissionCard(
                icon = Icons.Default.People,
                title = "Badi Y√∂netimi",
                description = "Badin diƒüer badileri y√∂netebilir",
                isEnabled = permissions.canManageBadis,
                onToggle = {
                    permissions = permissions.copy(canManageBadis = it)
                    hasChanges = true
                },
                color = Color(0xFFE91E63),
                isWarning = true
            )

            // Bottom padding for fab
            Spacer(modifier = Modifier.height(80.dp))
        }
    }
}

@Composable
private fun BadiInfoCard(user: User) {
    androidx.compose.material3.Card(
        shape = RoundedCornerShape(20.dp),
        colors = androidx.compose.material3.CardDefaults.cardColors(containerColor = Color.White),
        elevation = androidx.compose.material3.CardDefaults.cardElevation(defaultElevation = 4.dp),
        modifier = Modifier.fillMaxWidth()
    ) {
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .background(
                    androidx.compose.ui.graphics.Brush.horizontalGradient(
                        listOf(
                            DoziTurquoise.copy(alpha = 0.08f),
                            DoziPurple.copy(alpha = 0.08f)
                        )
                    )
                )
        ) {
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(16.dp),
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.spacedBy(14.dp)
            ) {
                // Avatar with gradient border
                Box(
                    modifier = Modifier
                        .size(56.dp)
                        .background(
                            brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                listOf(DoziTurquoise, DoziPurple)
                            ),
                            shape = androidx.compose.foundation.shape.CircleShape
                        )
                        .padding(2.dp),
                    contentAlignment = Alignment.Center
                ) {
                    Box(
                        modifier = Modifier
                            .fillMaxSize()
                            .clip(androidx.compose.foundation.shape.CircleShape)
                            .background(DoziTurquoise.copy(alpha = 0.1f)),
                        contentAlignment = Alignment.Center
                    ) {
                        Icon(
                            Icons.Default.Person,
                            contentDescription = null,
                            tint = DoziTurquoise,
                            modifier = Modifier.size(28.dp)
                        )
                    }
                }

                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        text = user.name,
                        style = MaterialTheme.typography.titleLarge,
                        fontWeight = FontWeight.ExtraBold,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                    Text(
                        text = user.email,
                        style = MaterialTheme.typography.bodyMedium,

                        color = MaterialTheme.colorScheme.onSurfaceVariant,

                        fontSize = 14.sp
                    )
                }
            }
        }
    }
}

@Composable
private fun RoleSelectionCard(
    currentRole: BadiRole,
    onRoleChange: (BadiRole) -> Unit
) {
    androidx.compose.material3.Card(
        shape = RoundedCornerShape(20.dp),
        colors = androidx.compose.material3.CardDefaults.cardColors(containerColor = Color.White),
        elevation = androidx.compose.material3.CardDefaults.cardElevation(defaultElevation = 4.dp),
        modifier = Modifier.fillMaxWidth()
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Row(
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Box(
                    modifier = Modifier
                        .size(32.dp)
                        .background(
                            brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                listOf(DoziTurquoise, DoziPurple)
                            ),
                            shape = androidx.compose.foundation.shape.CircleShape
                        ),
                    contentAlignment = Alignment.Center
                ) {
                    Icon(
                        Icons.Default.AdminPanelSettings,
                        contentDescription = null,
                        tint = Color.White,
                        modifier = Modifier.size(18.dp)
                    )
                }
                Text(
                    text = "Hƒ±zlƒ± Rol Se√ßimi",
                    style = MaterialTheme.typography.titleMedium,
                    fontWeight = FontWeight.ExtraBold
                )
            }

            Text(
                text = "√ñnceden tanƒ±mlƒ± rolleri kullanarak hƒ±zlƒ±ca izin ayarlayabilirsiniz",
                style = MaterialTheme.typography.bodySmall,

                color = MaterialTheme.colorScheme.onSurfaceVariant,

                fontSize = 13.sp
            )

            BadiRole.values().forEach { role ->
                RoleOption(
                    role = role,
                    isSelected = currentRole == role,
                    onClick = { onRoleChange(role) }
                )
            }
        }
    }
}

@Composable
private fun RoleOption(
    role: BadiRole,
    isSelected: Boolean,
    onClick: () -> Unit
) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .clip(RoundedCornerShape(12.dp))
            .background(
                if (isSelected) DoziTurquoise.copy(alpha = 0.1f) else Color.Transparent
            )
            .clickable(onClick = onClick)
            .padding(12.dp),
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.spacedBy(12.dp)
    ) {
        RadioButton(
            selected = isSelected,
            onClick = onClick,
            colors = RadioButtonDefaults.colors(selectedColor = DoziTurquoise)
        )

        Column(modifier = Modifier.weight(1f)) {
            Text(
                text = role.toTurkish(),
                style = MaterialTheme.typography.bodyLarge,
                fontWeight = if (isSelected) FontWeight.Bold else FontWeight.Medium,
                color = if (isSelected) DoziTurquoise else MaterialTheme.colorScheme.onSurface
            )
            Text(
                text = role.toDescription(),
                style = MaterialTheme.typography.bodySmall,

                color = MaterialTheme.colorScheme.onSurfaceVariant,

                fontSize = 12.sp
            )
        }
    }
}

@Composable
private fun PermissionCard(
    icon: ImageVector,
    title: String,
    description: String,
    isEnabled: Boolean,
    onToggle: (Boolean) -> Unit,
    color: Color,
    isWarning: Boolean = false
) {
    androidx.compose.material3.Card(
        shape = RoundedCornerShape(16.dp),
        colors = androidx.compose.material3.CardDefaults.cardColors(containerColor = Color.White),
        elevation = androidx.compose.material3.CardDefaults.cardElevation(defaultElevation = 3.dp),
        modifier = Modifier.fillMaxWidth()
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.spacedBy(12.dp)
        ) {
        // Icon
        Box(
            modifier = Modifier
                .size(44.dp)
                .clip(RoundedCornerShape(12.dp))
                .background(color.copy(alpha = 0.1f)),
            contentAlignment = Alignment.Center
        ) {
            Icon(
                icon,
                contentDescription = null,
                tint = color,
                modifier = Modifier.size(22.dp)
            )
        }

        // Text
        Column(
            modifier = Modifier.weight(1f),
            verticalArrangement = Arrangement.spacedBy(3.dp)
        ) {
            Row(
                horizontalArrangement = Arrangement.spacedBy(8.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = title,
                    style = MaterialTheme.typography.bodyLarge,
                    fontWeight = FontWeight.SemiBold,

                    color = MaterialTheme.colorScheme.onSurface,
                  
                    fontSize = 15.sp
                )
                if (isWarning) {
                    Icon(
                        Icons.Default.Warning,
                        contentDescription = null,
                        tint = Color(0xFFFF9800),
                        modifier = Modifier.size(16.dp)
                    )
                }
            }
            Text(
                text = description,
                style = MaterialTheme.typography.bodySmall,

                color = MaterialTheme.colorScheme.onSurfaceVariant,

                fontSize = 12.sp
            )
        }

            // Toggle
            Switch(
                checked = isEnabled,
                onCheckedChange = onToggle,
                colors = SwitchDefaults.colors(
                    checkedThumbColor = color,
                    checkedTrackColor = color.copy(alpha = 0.5f)
                )
            )
        }
    }
}

// ============================================================================
// FILE: FamilyManagementScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/family/FamilyManagementScreen.kt
// [73 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.family

import android.content.ClipData
import android.content.ClipboardManager
import android.content.Context
import android.widget.Toast
import androidx.compose.animation.*
import androidx.compose.animation.core.*
import androidx.compose.foundation.*
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.scale
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.window.Dialog
import com.bardino.dozi.R
import com.bardino.dozi.core.data.model.FamilyPlan
import com.bardino.dozi.core.data.repository.FamilyPlanRepository
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*
import com.google.firebase.auth.FirebaseAuth
import kotlinx.coroutines.launch

// Aile √ºyesi data class (UI i√ßin)
data class FamilyMember(
    val uid: String,
    val name: String,
    val email: String,
    val role: MemberRole,
    val joinedDate: Long = System.currentTimeMillis()
)

enum class MemberRole {
    ORGANIZER,
    MEMBER
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun FamilyManagementScreen(
    onNavigateBack: () -> Unit
) {
    val context = LocalContext.current
    val scope = rememberCoroutineScope()
    val familyPlanRepository = remember { FamilyPlanRepository() }
    val auth = remember { FirebaseAuth.getInstance() }

    // State'ler
    var familyPlan by remember { mutableStateOf<FamilyPlan?>(null) }
    var members by remember { mutableStateOf<List<FamilyMember>>(emptyList()) }
    var isLoading by remember { mutableStateOf(true) }
    var showRemoveDialog by remember { mutableStateOf<FamilyMember?>(null) }
    var isVisible by remember { mutableStateOf(false) }
    var errorMessage by remember { mutableStateOf<String?>(null) }

    // Verileri y√ºkle
    LaunchedEffect(Unit) {
        scope.launch {
            isLoading = true
            try {
                // Kullanƒ±cƒ±nƒ±n aile planƒ±nƒ± getir
                val result = familyPlanRepository.getUserFamilyPlan()
                result.onSuccess { plan ->
                    familyPlan = plan

                    // Aile √ºyelerini getir
                    plan?.let {
                        val membersResult = familyPlanRepository.getFamilyMembers(it.id)
                        membersResult.onSuccess { memberList ->
                            // Organizer'ƒ± da ekle
                            val allMembers = mutableListOf<FamilyMember>()

                            // Organizer
                            allMembers.add(
                                FamilyMember(
                                    uid = it.organizerId,
                                    name = it.organizerName,
                                    email = it.organizerEmail,
                                    role = MemberRole.ORGANIZER
                                )
                            )

                            // Diƒüer √ºyeler
                            memberList.forEach { memberData ->
                                allMembers.add(
                                    FamilyMember(
                                        uid = memberData["uid"] as String,
                                        name = memberData["name"] as String,
                                        email = memberData["email"] as String,
                                        role = MemberRole.MEMBER,
                                        joinedDate = memberData["joinedAt"] as? Long ?: 0L
                                    )
                                )
                            }

                            members = allMembers
                        }.onFailure { e ->
                            errorMessage = "√úyeler y√ºklenemedi: ${e.message}"
                        }
                    }
                }.onFailure { e ->
                    errorMessage = "Aile planƒ± y√ºklenemedi: ${e.message}"
                }
            } catch (e: Exception) {
                errorMessage = "Bir hata olu≈ütu: ${e.message}"
            } finally {
                isLoading = false
                isVisible = true
            }
        }
    }

    Scaffold(
        topBar = {
            DoziTopBar(
                title = "Aile Y√∂netimi",
                canNavigateBack = true,
                onNavigateBack = onNavigateBack
            )
        },
        containerColor = MaterialTheme.colorScheme.background
    ) { padding ->
        if (isLoading) {
            // Loading state
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding),
                contentAlignment = Alignment.Center
            ) {
                Column(
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    CircularProgressIndicator(color = DoziTurquoise)
                    Text(
                        text = "Y√ºkleniyor...",
                        style = MaterialTheme.typography.bodyLarge,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }
        } else if (errorMessage != null) {
            // Error state
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding)
                    .padding(24.dp),
                contentAlignment = Alignment.Center
            ) {
                Column(
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    Icon(
                        imageVector = Icons.Default.ErrorOutline,
                        contentDescription = null,
                        tint = ErrorRed,
                        modifier = Modifier.size(64.dp)
                    )
                    Text(
                        text = errorMessage ?: "Bir hata olu≈ütu",
                        style = MaterialTheme.typography.bodyLarge,
                        color = MaterialTheme.colorScheme.onSurfaceVariant,
                        textAlign = TextAlign.Center
                    )
                    Button(
                        onClick = { onNavigateBack() },
                        colors = ButtonDefaults.buttonColors(containerColor = DoziTurquoise)
                    ) {
                        Text("Geri D√∂n")
                    }
                }
            }
        } else if (familyPlan == null) {
            // No family plan
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding)
                    .padding(24.dp),
                contentAlignment = Alignment.Center
            ) {
                Column(
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    Image(
                        painter = painterResource(R.drawable.dozi_family),
                        contentDescription = null,
                        modifier = Modifier.size(120.dp)
                    )
                    Text(
                        text = "Aile Planƒ±nƒ±z Yok",
                        style = MaterialTheme.typography.headlineSmall,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                    Text(
                        text = "Aile paketi satƒ±n alarak aile √ºyelerinizle birlikte Dozi'yi kullanabilirsiniz.",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant,
                        textAlign = TextAlign.Center
                    )
                }
            }
        } else {
            // Main content
            LazyColumn(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding),
                contentPadding = PaddingValues(horizontal = 24.dp, vertical = 16.dp),
                verticalArrangement = Arrangement.spacedBy(20.dp)
            ) {
                // üé® Hero B√∂l√ºm√º
                item {
                    AnimatedVisibility(
                        visible = isVisible,
                        enter = fadeIn() + slideInVertically(initialOffsetY = { -50 })
                    ) {
                        HeroSection()
                    }
                }

                // üîë Davet Kodu B√∂l√ºm√º (Sadece organizer i√ßin)
                val currentUserId = auth.currentUser?.uid
                val isOrganizer = currentUserId == familyPlan?.organizerId

                if (isOrganizer) {
                    item {
                        AnimatedVisibility(
                            visible = isVisible,
                            enter = fadeIn() + slideInVertically(initialOffsetY = { 50 })
                        ) {
                            InviteCodeCard(
                                inviteCode = familyPlan?.invitationCode ?: "",
                                onCopy = {
                                    copyToClipboard(context, familyPlan?.invitationCode ?: "")
                                    Toast.makeText(context, "Davet kodu kopyalandƒ±!", Toast.LENGTH_SHORT).show()
                                },
                                availableSlots = familyPlan?.getAvailableSlots() ?: 0
                            )
                        }
                    }
                }

                // üë• √úye Listesi
                item {
                    Text(
                        text = "Aile √úyeleri (${members.size}/${(familyPlan?.maxMembers ?: 0) + 1})",
                        style = MaterialTheme.typography.titleLarge,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                }

                items(members, key = { it.uid }) { member ->
                    AnimatedVisibility(
                        visible = isVisible,
                        enter = fadeIn() + slideInVertically(initialOffsetY = { 100 })
                    ) {
                        MemberCard(
                            member = member,
                            currentUserId = currentUserId,
                            isOrganizer = isOrganizer,
                            onRemove = {
                                if (isOrganizer && member.role != MemberRole.ORGANIZER) {
                                    showRemoveDialog = member
                                }
                            }
                        )
                    }
                }

                // Alt bo≈üluk
                item {
                    Spacer(Modifier.height(40.dp))
                }
            }
        }
    }

    // ‚ùå √úye √ßƒ±karma dialog'u
    showRemoveDialog?.let { member ->
        RemoveMemberDialog(
            memberName = member.name,
            onConfirm = {
                scope.launch {
                    val result = familyPlanRepository.removeFamilyMember(member.uid)
                    result.onSuccess {
                        members = members.filter { it.uid != member.uid }
                        Toast.makeText(context, "${member.name} aileden √ßƒ±karƒ±ldƒ±", Toast.LENGTH_SHORT).show()
                    }.onFailure { e ->
                        Toast.makeText(context, "Hata: ${e.message}", Toast.LENGTH_SHORT).show()
                    }
                    showRemoveDialog = null
                }
            },
            onDismiss = { showRemoveDialog = null }
        )
    }
}

@Composable
private fun HeroSection() {
    val infiniteTransition = rememberInfiniteTransition(label = "hero_anim")
    val scale by infiniteTransition.animateFloat(
        initialValue = 1f,
        targetValue = 1.08f,
        animationSpec = infiniteRepeatable(
            animation = tween(1800, easing = EaseInOutSine),
            repeatMode = RepeatMode.Reverse
        ),
        label = "scale"
    )

    Box(
        modifier = Modifier
            .fillMaxWidth()
            .background(
                Brush.horizontalGradient(GradientHero),
                shape = RoundedCornerShape(24.dp)
            )
            .padding(24.dp),
        contentAlignment = Alignment.Center
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Image(
                painter = painterResource(R.drawable.dozi_happy2),
                contentDescription = "Aile",
                modifier = Modifier
                    .size(80.dp)
                    .scale(scale)
            )
            Text(
                text = "Ailecek Saƒülƒ±klƒ± Kalƒ±n",
                style = MaterialTheme.typography.headlineSmall,
                fontWeight = FontWeight.Bold,
                color = Color.White,
                textAlign = TextAlign.Center
            )
            Text(
                text = "Ailenizle ila√ßlarƒ±nƒ±zƒ± payla≈üƒ±n ve birbirinizi takip edin",
                style = MaterialTheme.typography.bodyMedium,
                color = Color.White.copy(alpha = 0.9f),
                textAlign = TextAlign.Center
            )
        }
    }
}

@Composable
private fun InviteCodeCard(
    inviteCode: String,
    onCopy: () -> Unit,
    availableSlots: Int
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        shape = RoundedCornerShape(20.dp),
        elevation = CardDefaults.cardElevation(4.dp)
    ) {
        Column(
            modifier = Modifier.padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Row(
                    horizontalArrangement = Arrangement.spacedBy(8.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(
                        Icons.Default.Key,
                        contentDescription = null,
                        tint = DoziTurquoise,
                        modifier = Modifier.size(24.dp)
                    )
                    Text(
                        text = "Davet Kodu",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                }

                Surface(
                    color = if (availableSlots > 0) DoziTurquoise.copy(alpha = 0.2f) else ErrorRed.copy(alpha = 0.2f),
                    shape = RoundedCornerShape(8.dp)
                ) {
                    Text(
                        text = "$availableSlots yer kaldƒ±",
                        style = MaterialTheme.typography.labelSmall,
                        fontWeight = FontWeight.Bold,
                        color = if (availableSlots > 0) DoziTurquoise else ErrorRed,
                        modifier = Modifier.padding(horizontal = 10.dp, vertical = 6.dp)
                    )
                }
            }

            // Davet kodu g√∂sterimi
            Surface(
                color = DoziTurquoise.copy(alpha = 0.1f),
                shape = RoundedCornerShape(16.dp),
                border = BorderStroke(2.dp, DoziTurquoise.copy(alpha = 0.3f))
            ) {
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(horizontal = 20.dp, vertical = 16.dp),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(
                        text = inviteCode,
                        style = MaterialTheme.typography.headlineMedium,
                        fontWeight = FontWeight.Bold,
                        color = DoziTurquoise,
                        letterSpacing = 4.sp
                    )
                    IconButton(onClick = onCopy) {
                        Icon(
                            Icons.Default.ContentCopy,
                            contentDescription = "Kopyala",
                            tint = DoziTurquoise
                        )
                    }
                }
            }

            Text(
                text = "Bu kodu aile √ºyelerinizle payla≈üƒ±n. Kodunuzu kullanarak ailenize katƒ±labilirler.",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                textAlign = TextAlign.Center,
                modifier = Modifier.fillMaxWidth()
            )
        }
    }
}

@Composable
private fun MemberCard(
    member: FamilyMember,
    currentUserId: String?,
    isOrganizer: Boolean,
    onRemove: () -> Unit
) {
    val isCurrentUser = member.uid == currentUserId

    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = when {
                member.role == MemberRole.ORGANIZER -> DoziTurquoise.copy(alpha = 0.08f)
                isCurrentUser -> DoziCoral.copy(alpha = 0.05f)
                else -> Color.White
            }
        ),
        shape = RoundedCornerShape(16.dp),
        border = BorderStroke(
            width = 1.dp,
            color = when {
                member.role == MemberRole.ORGANIZER -> DoziTurquoise.copy(alpha = 0.3f)
                else -> Gray200
            }
        )
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Row(
                horizontalArrangement = Arrangement.spacedBy(12.dp),
                verticalAlignment = Alignment.CenterVertically,
                modifier = Modifier.weight(1f)
            ) {
                // Avatar
                Surface(
                    modifier = Modifier.size(56.dp),
                    shape = CircleShape,
                    color = if (member.role == MemberRole.ORGANIZER)
                        DoziTurquoise.copy(alpha = 0.2f)
                    else
                        DoziCoral.copy(alpha = 0.2f)
                ) {
                    Box(contentAlignment = Alignment.Center) {
                        Text(
                            text = member.name.firstOrNull()?.uppercase() ?: "?",
                            style = MaterialTheme.typography.titleLarge,
                            fontWeight = FontWeight.Bold,
                            color = if (member.role == MemberRole.ORGANIZER) DoziTurquoise else DoziCoral
                        )
                    }
                }

                Column(
                    verticalArrangement = Arrangement.spacedBy(4.dp)
                ) {
                    Row(
                        horizontalArrangement = Arrangement.spacedBy(8.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Text(
                            text = if (isCurrentUser) "${member.name} (Sen)" else member.name,
                            style = MaterialTheme.typography.titleMedium,
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.onSurface
                        )
                        if (member.role == MemberRole.ORGANIZER) {
                            Surface(
                                color = DoziTurquoise,
                                shape = RoundedCornerShape(6.dp)
                            ) {
                                Text(
                                    text = "Y√∂netici",
                                    style = MaterialTheme.typography.labelSmall,
                                    color = Color.White,
                                    modifier = Modifier.padding(horizontal = 8.dp, vertical = 2.dp)
                                )
                            }
                        }
                    }
                    Text(
                        text = member.email,
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }

            // √áƒ±kar butonu (sadece organizer ve √ºyeler i√ßin)
            if (isOrganizer && member.role != MemberRole.ORGANIZER && !isCurrentUser) {
                IconButton(
                    onClick = onRemove,
                    modifier = Modifier.size(40.dp)
                ) {
                    Icon(
                        Icons.Default.PersonRemove,
                        contentDescription = "√áƒ±kar",
                        tint = ErrorRed
                    )
                }
            }
        }
    }
}

@Composable
private fun RemoveMemberDialog(
    memberName: String,
    onConfirm: () -> Unit,
    onDismiss: () -> Unit
) {
    Dialog(onDismissRequest = onDismiss) {
        Surface(
            shape = RoundedCornerShape(28.dp),
            color = Color.White,
            tonalElevation = 8.dp
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(28.dp),
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(20.dp)
            ) {
                Surface(
                    modifier = Modifier.size(80.dp),
                    color = WarningOrange.copy(alpha = 0.15f),
                    shape = CircleShape
                ) {
                    Box(contentAlignment = Alignment.Center) {
                        Icon(
                            Icons.Default.Warning,
                            contentDescription = null,
                            tint = WarningOrange,
                            modifier = Modifier.size(40.dp)
                        )
                    }
                }

                Column(
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    Text(
                        text = "√úyeyi √áƒ±kar?",
                        style = MaterialTheme.typography.headlineSmall,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface
                    )

                    Text(
                        text = "$memberName adlƒ± ki≈üiyi aileden √ßƒ±karmak istediƒüinize emin misiniz?",
                        style = MaterialTheme.typography.bodyLarge,
                        color = MaterialTheme.colorScheme.onSurfaceVariant,
                        textAlign = TextAlign.Center
                    )
                }

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    OutlinedButton(
                        onClick = onDismiss,
                        modifier = Modifier
                            .weight(1f)
                            .height(50.dp),
                        shape = RoundedCornerShape(14.dp),
                        border = BorderStroke(2.dp, Gray200)
                    ) {
                        Text(
                            "ƒ∞ptal",
                            style = MaterialTheme.typography.titleSmall,
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }

                    Button(
                        onClick = onConfirm,
                        modifier = Modifier
                            .weight(1f)
                            .height(50.dp),
                        shape = RoundedCornerShape(14.dp),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = ErrorRed
                        )
                    ) {
                        Icon(
                            Icons.Default.PersonRemove,
                            contentDescription = null,
                            modifier = Modifier.size(20.dp)
                        )
                        Spacer(Modifier.width(8.dp))
                        Text(
                            "√áƒ±kar",
                            style = MaterialTheme.typography.titleSmall,
                            fontWeight = FontWeight.Bold
                        )
                    }
                }
            }
        }
    }
}

// Utility fonksiyonlar
private fun copyToClipboard(context: Context, text: String) {
    val clipboard = context.getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
    val clip = ClipData.newPlainText("Davet Kodu", text)
    clipboard.setPrimaryClip(clip)
}

// ============================================================================
// FILE: HomeScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/home/HomeScreen.kt
// [74 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.home

import android.content.Context
import android.os.Build
import androidx.annotation.RequiresApi
import androidx.compose.animation.*
import androidx.compose.animation.core.*
import androidx.compose.animation.core.Spring
import androidx.compose.animation.core.spring
import androidx.compose.foundation.*
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.foundation.interaction.MutableInteractionSource
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.LazyRow
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.lazy.rememberLazyListState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.ClickableText
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.runtime.getValue
import androidx.hilt.navigation.compose.hiltViewModel
import androidx.lifecycle.compose.collectAsStateWithLifecycle
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.blur
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.graphicsLayer
import androidx.compose.ui.hapticfeedback.HapticFeedbackType
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalFocusManager
import androidx.compose.ui.platform.LocalHapticFeedback
import androidx.compose.ui.platform.LocalLifecycleOwner
import androidx.lifecycle.Lifecycle
import androidx.lifecycle.LifecycleEventObserver
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.SpanStyle
import androidx.compose.ui.text.buildAnnotatedString
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.text.style.TextDecoration
import androidx.compose.ui.text.withStyle
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.window.Dialog
import androidx.compose.ui.window.DialogProperties
import androidx.navigation.NavController
import com.bardino.dozi.DoziApplication
import com.bardino.dozi.R
import com.bardino.dozi.core.data.model.Medicine
import com.bardino.dozi.core.data.model.User
import com.bardino.dozi.core.data.repository.MedicineRepository
import com.bardino.dozi.core.data.repository.UserRepository
import com.bardino.dozi.core.ui.screens.home.MedicineStatus
import com.bardino.dozi.core.ui.theme.*
import com.bardino.dozi.core.utils.SoundHelper
import com.bardino.dozi.navigation.Screen
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.delay
import kotlinx.coroutines.launch
import java.time.Instant
import java.time.LocalDate
import java.time.LocalTime
import java.time.ZoneId
import java.time.format.TextStyle
import java.time.temporal.ChronoUnit
import java.util.*

// Helper function: Belirli bir tarihte ilacƒ±n g√∂sterilip g√∂sterilmeyeceƒüini kontrol eder
@RequiresApi(Build.VERSION_CODES.O)
fun shouldMedicineShowOnDate(medicine: Medicine, date: LocalDate): Boolean {
    // startDate kontrol√º
    val startLocalDate = Instant.ofEpochMilli(medicine.startDate)
        .atZone(ZoneId.systemDefault())
        .toLocalDate()

    if (date.isBefore(startLocalDate)) {
        return false // Ba≈ülangƒ±√ß tarihinden √∂nce g√∂sterme
    }

    // endDate kontrol√º
    if (medicine.endDate != null) {
        val endLocalDate = Instant.ofEpochMilli(medicine.endDate!!)
            .atZone(ZoneId.systemDefault())
            .toLocalDate()
        if (date.isAfter(endLocalDate)) {
            return false // Biti≈ü tarihinden sonra g√∂sterme
        }
    }

    when (medicine.frequency) {
        "Her g√ºn" -> return true

        "G√ºn a≈üƒ±rƒ±" -> {
            // Ba≈ülangƒ±√ß g√ºn√ºnden itibaren g√ºn a≈üƒ±rƒ±: g√ºn 0 (al), g√ºn 1 (alma), g√ºn 2 (al), ...
            val daysSinceStart = ChronoUnit.DAYS.between(startLocalDate, date)
            return daysSinceStart % 2 == 0L
        }

        "Haftada bir" -> {
            // Ba≈ülangƒ±√ß tarihinin haftanƒ±n g√ºn√º ile aynƒ± g√ºnlerde al
            // ANCAK: Ba≈ülangƒ±√ß g√ºn√ºnden itibaren tam hafta ge√ßtiyse g√∂ster
            if (date.isBefore(startLocalDate)) return false
            val daysSinceStart = ChronoUnit.DAYS.between(startLocalDate, date)
            return startLocalDate.dayOfWeek == date.dayOfWeek && daysSinceStart % 7 == 0L
        }

        "15 g√ºnde bir" -> {
            // Her 15 g√ºnde bir: g√ºn 0, 15, 30, 45, ...
            if (date.isBefore(startLocalDate)) return false
            val daysSinceStart = ChronoUnit.DAYS.between(startLocalDate, date)
            return daysSinceStart % 15 == 0L
        }

        "Ayda bir" -> {
            // Her 30 g√ºnde bir: g√ºn 0, 30, 60, 90, ...
            if (date.isBefore(startLocalDate)) return false
            val daysSinceStart = ChronoUnit.DAYS.between(startLocalDate, date)
            return daysSinceStart % 30 == 0L
        }

        "Her X g√ºnde bir" -> {
            // Her X g√ºnde bir: g√ºn 0, X, 2X, 3X, ...
            val daysSinceStart = ChronoUnit.DAYS.between(startLocalDate, date)
            return daysSinceStart % medicine.frequencyValue.toLong() == 0L
        }

        "ƒ∞stediƒüim tarihlerde" -> {
            // Kullanƒ±cƒ±nƒ±n se√ßtiƒüi √∂zel tarihlerde
            val dateString = "%02d/%02d/%d".format(date.dayOfMonth, date.monthValue, date.year)
            return medicine.days.contains(dateString)
        }

        else -> return false
    }
}

// Helper function: Get medicine status for a specific date with percentage-based logic
fun getMedicineStatusForDate(context: Context, date: LocalDate, medicines: List<Medicine>): MedicineStatus {
    val dateString = "%02d/%02d/%d".format(date.dayOfMonth, date.monthValue, date.year)
    val prefs = context.getSharedPreferences("medicine_status", Context.MODE_PRIVATE)

    var totalDoses = 0
    var takenCount = 0
    var skippedCount = 0
    var upcomingCount = 0

    medicines.forEach { medicine ->
        // ‚úÖ Sadece bu tarihte g√∂sterilmesi gereken ila√ßlarƒ± kontrol et
        if (!shouldMedicineShowOnDate(medicine, date)) {
            return@forEach
        }

        medicine.times.forEach { time ->
            totalDoses++
            val key = "dose_${medicine.id}_${dateString}_$time"
            val status = prefs.getString(key, null)

            when {
                status == "taken" -> takenCount++
                status?.startsWith("skipped") == true -> skippedCount++
                status == null && date >= LocalDate.now() -> upcomingCount++
            }
        }
    }

    // Eƒüer hi√ß doz yoksa
    if (totalDoses == 0) return MedicineStatus.NONE

    // Y√ºzde hesapla
    val takenPercentage = (takenCount * 100) / totalDoses

    return when {
        // %100 alƒ±ndƒ± -> Ye≈üil
        takenPercentage == 100 && skippedCount == 0 -> MedicineStatus.TAKEN

        // Karƒ±≈üƒ±k durum: hem alƒ±ndƒ± hem atlandƒ± -> Turuncu (PARTIAL)
        takenCount > 0 && skippedCount > 0 -> MedicineStatus.PARTIAL

        // Sadece atlandƒ± -> Kƒ±rmƒ±zƒ±
        skippedCount > 0 && takenCount == 0 -> MedicineStatus.SKIPPED

        // Gelecek ila√ßlar
        upcomingCount > 0 -> if (date == LocalDate.now()) MedicineStatus.UPCOMING else MedicineStatus.PLANNED

        // Hi√ßbiri
        else -> MedicineStatus.NONE
    }
}

// Helper function: Get medicine records for a specific date
fun getMedicineRecordsForDate(context: Context, date: LocalDate, medicines: List<Medicine>): List<MedicineRecord> {
    val dateString = "%02d/%02d/%d".format(date.dayOfMonth, date.monthValue, date.year)
    val prefs = context.getSharedPreferences("medicine_status", Context.MODE_PRIVATE)

    val records = mutableListOf<MedicineRecord>()

    medicines.forEach { medicine ->
        // ‚úÖ Sadece bu tarihte g√∂sterilmesi gereken ila√ßlarƒ± kontrol et
        if (!shouldMedicineShowOnDate(medicine, date)) {
            return@forEach
        }

        medicine.times.forEach { time ->
            val key = "dose_${medicine.id}_${dateString}_$time"
            val statusValue = prefs.getString(key, null)

            val status = when {
                statusValue == "taken" -> MedicineStatus.TAKEN
                statusValue?.startsWith("skipped") == true -> MedicineStatus.SKIPPED
                statusValue?.startsWith("snoozed") == true -> MedicineStatus.UPCOMING
                date == LocalDate.now() -> MedicineStatus.UPCOMING
                date > LocalDate.now() -> MedicineStatus.PLANNED
                else -> MedicineStatus.NONE
            }

            if (status != MedicineStatus.NONE) {
                records.add(MedicineRecord(
                    time = time,
                    name = "${medicine.name} ${medicine.dosage}",
                    status = status
                ))
            }
        }
    }

    return records.sortedBy { it.time }
}

data class MedicineRecord(
    val time: String,
    val name: String,
    val status: MedicineStatus
)

@RequiresApi(Build.VERSION_CODES.O)
@Composable
fun HomeScreen(
    navController: NavController,
    contentPadding: PaddingValues = PaddingValues(),
    onNavigateToMedicines: () -> Unit,
    onNavigateToReminders: () -> Unit,
    onNavigateToProfile: () -> Unit
) {
    val context = LocalContext.current

    // ‚úÖ Hilt ile ViewModel inject et
    val viewModel: HomeViewModel = hiltViewModel()

    // ‚úÖ ViewModel'den state'leri al
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()

    // Local UI state'leri (sadece UI i√ßin)
    var timelineExpanded by remember { mutableStateOf(false) }
    var selectedDate by remember { mutableStateOf<LocalDate?>(null) }

    val scrollState = rememberScrollState()
    val coroutineScope = rememberCoroutineScope()
    val lifecycleOwner = LocalLifecycleOwner.current

    // ‚úÖ Context gerektiren ViewModel fonksiyonlarƒ±nƒ± √ßaƒüƒ±r
    LaunchedEffect(context) {
        // üî• Not: refreshMedicines artƒ±k Flow ile otomatik - polling kaldƒ±rƒ±ldƒ±
        viewModel.loadSnoozeStateFromContext(context)
        viewModel.startSnoozeTimerWithContext(context)
    }

    // ‚úÖ Uygulama √∂n plana geldiƒüinde state'i yenile (Widget senkronizasyonu i√ßin)
    DisposableEffect(lifecycleOwner) {
        val observer = LifecycleEventObserver { _, event ->
            if (event == Lifecycle.Event.ON_RESUME) {
                viewModel.refreshMedicines(context)
            }
        }
        lifecycleOwner.lifecycle.addObserver(observer)
        onDispose {
            lifecycleOwner.lifecycle.removeObserver(observer)
        }
    }

    // üé® Tema renklerini al
    val backgroundColor = MaterialTheme.colorScheme.background
    val surfaceColor = MaterialTheme.colorScheme.surface

    Box(modifier = Modifier.fillMaxSize()) {
        Column(
            modifier = Modifier
                .fillMaxSize()
                .background(backgroundColor)
                .padding(contentPadding)
                .then(
                    if (uiState.showSuccessPopup || uiState.showSkippedPopup) Modifier.blur(10.dp)
                    else Modifier
                )
        ) {
            DoziHeader(firestoreUser = uiState.user, isLoggedIn = uiState.isLoggedIn)

            // üë• Profil Deƒüi≈ütirici
            // Profil y√∂netimi kaldƒ±rƒ±ldƒ±

            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .verticalScroll(scrollState)
                    .pointerInput(Unit) {
                        detectTapGestures(onTap = {
                            if (selectedDate != null) {
                                selectedDate = null
                            }
                        })
                    }
            ) {
                Spacer(Modifier.height(12.dp))

                HorizontalCalendar(
                    selectedDate = selectedDate,
                    onDateSelected = { date ->
                        selectedDate = if (selectedDate == date) null else date
                    },
                    onNavigateToReminders = {
                        navController.navigate(Screen.AddReminder.route)
                    },
                    isLoggedIn = uiState.isLoggedIn
                )

                Spacer(Modifier.height(20.dp))

                AnimatedVisibility(
                    visible = true,
                    enter = fadeIn(animationSpec = tween(600)) +
                            slideInVertically(
                                initialOffsetY = { it / 2 },
                                animationSpec = tween(600, easing = FastOutSlowInEasing)
                            )
                ) {
                    if (uiState.currentMedicineStatus == MedicineStatus.UPCOMING && uiState.upcomingMedicine != null) {
                        val sameTimeMedicines = uiState.allUpcomingMedicines.filter { it.second == uiState.upcomingMedicine!!.second }

                        if (sameTimeMedicines.size == 1) {
                            CurrentMedicineCard(
                                medicine = uiState.upcomingMedicine!!.first,
                                time = uiState.upcomingMedicine!!.second,
                                snoozeMinutes = uiState.snoozeMinutes,
                                onTaken = {
                                    SoundHelper.playSound(context, SoundHelper.SoundType.HERSEY_TAMAM)
                                    viewModel.onMedicineTaken(context, uiState.upcomingMedicine!!.first, uiState.upcomingMedicine!!.second)
                                },
                                onSnooze = { viewModel.setShowSnoozeDialog(true) },
                                onSkip = { viewModel.setShowSkipDialog(true) }
                            )
                        } else {
                            MultiMedicineCard(
                                medicines = sameTimeMedicines,
                                time = uiState.upcomingMedicine!!.second,
                                onTaken = { medicine ->
                                    SoundHelper.playSound(context, SoundHelper.SoundType.HERSEY_TAMAM)
                                    viewModel.onMedicineTaken(context, medicine, uiState.upcomingMedicine!!.second)
                                },
                                onSnooze = { viewModel.setShowSnoozeDialog(true) },
                                onSkip = { medicine ->
                                    SoundHelper.playSound(context, SoundHelper.SoundType.PEKALA)
                                    viewModel.onMedicineSkipped(context, medicine, uiState.upcomingMedicine!!.second)
                                }
                            )
                        }
                    } else {
                        EmptyMedicineCard(
                            currentMedicineStatus = uiState.currentMedicineStatus,
                            nextMedicine = uiState.allUpcomingMedicines.firstOrNull(),
                            isLoggedIn = uiState.isLoggedIn
                        )
                    }
                }

                Spacer(Modifier.height(16.dp))

                // üî• Streak ve Badi Promotion - Yan yana daha k√º√ß√ºk kartlar
                if (uiState.isLoggedIn) {
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(horizontal = 4.dp),
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        // Streak Kartƒ± - Kompakt
                        CompactStreakCard(
                            context = context,
                            medicines = uiState.todaysMedicines,
                            onNavigateToStats = { navController.navigate(Screen.Stats.route) },
                            modifier = Modifier.weight(1f)
                        )

                        // Badi Promotion - Kompakt
                        CompactBadiPromotionCard(
                            onNavigateToBadi = { navController.navigate(Screen.BadiList.route) },
                            modifier = Modifier.weight(1f)
                        )
                    }
                }

                Spacer(Modifier.height(24.dp))

                TimelineSection(
                    medicines = uiState.todaysMedicines,
                    expanded = timelineExpanded,
                    context = context,
                    onToggle = {
                        timelineExpanded = !timelineExpanded
                        if (timelineExpanded) {
                            coroutineScope.launch {
                                scrollState.animateScrollTo(
                                    scrollState.maxValue,
                                    animationSpec = tween(300, easing = FastOutSlowInEasing)
                                )
                            }
                        }
                    }
                )

                Spacer(Modifier.height(100.dp))
            }
        }

        // ‚úÖ Popup'lar
        if (uiState.showSuccessPopup) {
            Box(
                modifier = Modifier.fillMaxSize(),
                contentAlignment = Alignment.Center
            ) {
                Image(
                    painter = painterResource(id = R.drawable.dozi_perfect),
                    contentDescription = null,
                    modifier = Modifier.size(200.dp)
                )
            }
        }

        if (uiState.showSkippedPopup) {
            Box(
                modifier = Modifier.fillMaxSize(),
                contentAlignment = Alignment.Center
            ) {
                Image(
                    painter = painterResource(id = R.drawable.dozi_happy2),
                    contentDescription = null,
                    modifier = Modifier.size(200.dp)
                )
            }
        }

    }

    // ‚úÖ Dialog'lar (ViewModel ile entegre)
    if (uiState.showSkipDialog) {
        val currentMedicine = uiState.upcomingMedicine
        SkipReasonDialog(
            onDismiss = {
                SoundHelper.playSound(context, SoundHelper.SoundType.PEKALA)
                viewModel.setShowSkipDialog(false)
            },
            onConfirm = { reason ->
                SoundHelper.playSound(context, SoundHelper.SoundType.PEKALA)
                currentMedicine?.let {
                    viewModel.onMedicineSkipped(context, it.first, it.second)
                }
            }
        )
    }

    if (uiState.showSnoozeDialog) {
        val currentMedicine = uiState.upcomingMedicine
        SnoozeDialog(
            onDismiss = { viewModel.setShowSnoozeDialog(false) },
            onConfirm = { minutes ->
                currentMedicine?.let {
                    viewModel.onMedicineSnoozed(context, it.first, it.second, minutes)
                }
            }
        )
    }
}


// TODO: Bu helper fonksiyonlar (getMedicineStatus, shouldMedicineShowOnDate, getMedicineRecordsForDate)
// ViewModel'e veya Repository'e ta≈üƒ±nmalƒ±dƒ±r. UI katmanƒ±nda business logic bulunmamalƒ±.

fun getMedicineStatus(context: Context, medicineId: String, date: String, time: String): String? {
    val prefs = context.getSharedPreferences("medicine_status", Context.MODE_PRIVATE)
    val key = "dose_${medicineId}_${date}_${time}"
    return prefs.getString(key, null)
}

fun getCurrentDateString(): String {
    val calendar = java.util.Calendar.getInstance()
    val day = calendar.get(java.util.Calendar.DAY_OF_MONTH)
    val month = calendar.get(java.util.Calendar.MONTH) + 1
    val year = calendar.get(java.util.Calendar.YEAR)
    return "%02d/%02d/%d".format(day, month, year)
}

@RequiresApi(Build.VERSION_CODES.O)
@Composable
private fun DoziHeader(firestoreUser: User?, isLoggedIn: Boolean) {
    val hour = LocalTime.now().hour
    val greeting = remember(hour) {
        when (hour) {
            in 6..11 -> "G√ºnaydƒ±n"
            in 12..17 -> "ƒ∞yi g√ºnler"
            in 18..21 -> "ƒ∞yi ak≈üamlar"
            else -> "ƒ∞yi geceler"
        }
    }

    // Kullanƒ±cƒ± adƒ±nƒ± al - login olmamƒ±≈üsa isim g√∂sterme
    val userName = if (isLoggedIn) {
        firestoreUser?.name?.split(" ")?.firstOrNull() ?: "Arkada≈üƒ±m"
    } else {
        null
    }
    val planType = firestoreUser?.planType ?: "free"
    val isPremium = planType != "free"
    var showEditNameDialog by remember { mutableStateOf(false) }
    val canEditName = firestoreUser?.name.isNullOrBlank()

    // ‚úÖ G√ºn√ºn saatine g√∂re renk deƒüi≈üimi
    val (baseGradientStart, baseGradientEnd) = remember(hour) {
        when (hour) {
            in 6..11 -> Pair(Color(0xFFFFB74D), Color(0xFFFF9800)) // Sabah: Turuncu tonlarƒ±
            in 12..17 -> Pair(DoziTurquoise, DoziBlue) // √ñƒülen: Turkuaz-Mavi
            in 18..21 -> Pair(DoziCoral, DoziPurple) // Ak≈üam: Mercan-Mor
            else -> Pair(Color(0xFF5E35B1), Color(0xFF311B92)) // Gece: Koyu mor tonlarƒ±
        }
    }

    val gradientStart by animateColorAsState(
        targetValue = if (isPremium) Color(0xFFFFB300) else baseGradientStart,
        animationSpec = tween(800, easing = FastOutSlowInEasing),
        label = "gradientStart"
    )
    val gradientEnd by animateColorAsState(
        targetValue = if (isPremium) Color(0xFFFF6F00) else baseGradientEnd,
        animationSpec = tween(800, easing = FastOutSlowInEasing),
        label = "gradientEnd"
    )

    Box(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 16.dp, vertical = 8.dp)
            .clip(RoundedCornerShape(24.dp))
            .then(
                if (isPremium) {
                    Modifier.border(
                        width = 2.dp,
                        brush = Brush.horizontalGradient(listOf(DoziGold, Color(0xFFFF8C00))),
                        shape = RoundedCornerShape(24.dp)
                    )
                } else Modifier
            )
            .background(
                Brush.horizontalGradient(
                    listOf(gradientStart, gradientEnd)
                )
            )
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 20.dp, vertical = 14.dp),
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.SpaceBetween
        ) {
            Column(modifier = Modifier.weight(1f)) {
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    // Login olmayan kullanƒ±cƒ±lar i√ßin sadece greeting
                    if (userName == null) {
                        Text(
                            text = "$greeting!",
                            style = MaterialTheme.typography.titleLarge,
                            fontWeight = FontWeight.ExtraBold,
                            color = Color.White
                        )
                    } else {
                        // Tƒ±klanabilir kullanƒ±cƒ± adƒ±
                        if (canEditName) {
                            Text(
                                text = buildAnnotatedString {
                                    append("$greeting, ")
                                    withStyle(
                                        style = SpanStyle(
                                            textDecoration = TextDecoration.Underline,
                                            color = Color.White.copy(alpha = 0.9f)
                                        )
                                    ) {
                                        append(userName)
                                    }
                                    append("!")
                                },
                                style = MaterialTheme.typography.titleLarge,
                                fontWeight = FontWeight.ExtraBold,
                                color = Color.White,
                                modifier = Modifier.clickable { showEditNameDialog = true }
                            )
                        } else {
                            Text(
                                text = "$greeting, $userName!",
                                style = MaterialTheme.typography.titleLarge,
                                fontWeight = FontWeight.ExtraBold,
                                color = Color.White
                            )
                        }
                    }

                    if (isPremium) {
                        Icon(
                            Icons.Default.Star,
                            contentDescription = "Premium",
                            tint = Color(0xFFFFD700),
                            modifier = Modifier.size(20.dp)
                        )
                    }
                }
                Spacer(Modifier.height(2.dp))
                Text(
                    text = if (isLoggedIn) "ƒ∞la√ßlarƒ±nƒ± d√ºzenli almayƒ± unutma" else "Dozi ile ila√ß takibini kolayla≈ütƒ±r",
                    style = MaterialTheme.typography.labelLarge,
                    color = Color.White.copy(alpha = 0.8f)
                )
            }

            Image(
                painter = painterResource(id = R.drawable.dozi_brand),
                contentDescription = "Dozi brand",
                modifier = Modifier
                    .size(64.dp)
                    .offset(y = (-2).dp)
            )
        }
    }

    // Kullanƒ±cƒ± adƒ± d√ºzenleme dialogu
    if (showEditNameDialog) {
        EditNameDialog(
            currentName = firestoreUser?.name ?: "",
            onDismiss = { showEditNameDialog = false },
            onConfirm = { newName ->
                showEditNameDialog = false
                // Firestore'a kaydet
                val userRepository = UserRepository()
                CoroutineScope(Dispatchers.IO).launch {
                    userRepository.updateUserField("name", newName)
                }
            }
        )
    }
}

@RequiresApi(Build.VERSION_CODES.O)
@Composable
fun HorizontalCalendar(
    selectedDate: LocalDate?,
    onDateSelected: (LocalDate) -> Unit,
    onNavigateToReminders: () -> Unit,
    isLoggedIn: Boolean
) {
    val today = LocalDate.now()
    val context = LocalContext.current

    // üîπ Ay ba≈üƒ±ndan ay sonuna kadar t√ºm g√ºnler
    val dates = remember(today) {
        val firstDayOfMonth = today.withDayOfMonth(1)
        val lastDayOfMonth = today.withDayOfMonth(today.lengthOfMonth())
        val daysBetween = java.time.temporal.ChronoUnit.DAYS.between(firstDayOfMonth, lastDayOfMonth).toInt()
        (0..daysBetween).map { firstDayOfMonth.plusDays(it.toLong()) }
    }

    // üîπ Bug√ºn√ºn listede g√∂r√ºnmesi i√ßin index'i hesapla
    val todayIndex = remember(today, dates) {
        dates.indexOfFirst { it == today }.coerceAtLeast(0)
    }
    val listState = rememberLazyListState(initialFirstVisibleItemIndex = todayIndex)
    val coroutineScope = rememberCoroutineScope()

    // üîπ Medicines listesini Firebase'den al (Real-time Flow ile)
    val medicineRepository = remember { MedicineRepository() }

    // üî• BUG FIX: getMedicinesFlow() ile profil deƒüi≈üikliklerini dinle
    val allMedicines by medicineRepository.getMedicinesFlow()
        .collectAsState(initial = emptyList())

    // üîπ Ger√ßek stat√º verisi - SharedPreferences'tan hesapla
    val dayStatuses = remember(allMedicines) {
        dates.associateWith { date ->
            getMedicineStatusForDate(context, date, allMedicines)
        }
    }

    LaunchedEffect(selectedDate) {
        selectedDate?.let { date ->
            val index = dates.indexOf(date)
            if (index != -1) {
                coroutineScope.launch {
                    listState.animateScrollToItem(index)
                }
            }
        }
    }

    Column(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 12.dp)
            .pointerInput(Unit) {
                detectTapGestures(onTap = {})
            }
    ) {
        Card(
            shape = RoundedCornerShape(20.dp),
            colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
            elevation = CardDefaults.cardElevation(0.dp),
            modifier = Modifier.border(1.dp, DoziPrimaryLight, RoundedCornerShape(20.dp))
        ) {
            Column(
                modifier = Modifier.fillMaxWidth(),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Text(
                    text = today.month.getDisplayName(TextStyle.FULL, Locale("tr")).uppercase(),
                    style = MaterialTheme.typography.titleSmall,
                    color = MaterialTheme.colorScheme.onSurface,
                    fontWeight = FontWeight.Bold,
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(top = 10.dp),
                    textAlign = TextAlign.Center
                )

                HorizontalDivider(
                    color = VeryLightGray,
                    thickness = 1.dp,
                    modifier = Modifier.padding(vertical = 6.dp, horizontal = 8.dp)
                )

                // üîπ Ay ba≈üƒ±ndan ay sonuna kadar t√ºm g√ºnler
                LazyRow(
                    state = listState,
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(vertical = 8.dp),
                    horizontalArrangement = Arrangement.SpaceEvenly
                ) {
                    items(dates) { date ->
                        val status = dayStatuses[date] ?: MedicineStatus.NONE
                        val isSelected = date == selectedDate
                        CalendarDayCircle(
                            date = date,
                            status = status,
                            isSelected = isSelected,
                            onClick = {
                                onDateSelected(date)
                            }
                        )
                    }
                }
            }
        }

        AnimatedVisibility(
            visible = selectedDate != null,
            enter = expandVertically(animationSpec = tween(400)) + fadeIn(),
            exit = shrinkVertically(animationSpec = tween(300)) + fadeOut()
        ) {
            selectedDate?.let { date ->
                val status = dayStatuses[date] ?: MedicineStatus.NONE
                CalendarExpandedContent(
                    date = date,
                    status = status,
                    onNavigateToReminders = onNavigateToReminders,
                    context = context,
                    allMedicines = allMedicines,
                    isLoggedIn = isLoggedIn
                )
            }
        }
    }
}

@RequiresApi(Build.VERSION_CODES.O)
@Composable
private fun CalendarDayCircle(
    date: LocalDate,
    status: MedicineStatus,
    isSelected: Boolean,
    onClick: () -> Unit
) {
    val interaction = remember { MutableInteractionSource() }
    val today = LocalDate.now()
    val isToday = date == today
    val haptic = LocalHapticFeedback.current

    // üîπ Ya≈ülƒ±lar i√ßin daha a√ßƒ±k ve ayƒ±rt edici renkler
    val color = when (status) {
        MedicineStatus.TAKEN -> SuccessGreen          // ‚úÖ Ye≈üil: Alƒ±ndƒ±
        MedicineStatus.PARTIAL -> WarningOrange       // üü† Turuncu: Kƒ±smen alƒ±ndƒ±
        MedicineStatus.SKIPPED -> ErrorRed            // ‚ùå Kƒ±rmƒ±zƒ±: Atlandƒ±
        MedicineStatus.PLANNED -> DoziBlue            // üìÖ Mavi: ƒ∞leride planlanmƒ±≈ü
        MedicineStatus.UPCOMING -> DoziTurquoise      // ‚è∞ Turkuaz: Bug√ºn sƒ±rada
        else -> Gray200                               // ‚ö™ Gri: ƒ∞la√ß yok
    }

    val displayDay = date.dayOfMonth.toString()

    // Animated scale for selection
    val scale by animateFloatAsState(
        targetValue = if (isSelected) 1.08f else 1f,
        animationSpec = spring(
            dampingRatio = Spring.DampingRatioMediumBouncy,
            stiffness = Spring.StiffnessLow
        ),
        label = "calendarScale"
    )

    // Animated ring for selected day
    val infiniteTransition = rememberInfiniteTransition(label = "ringPulse")
    val ringAlpha by infiniteTransition.animateFloat(
        initialValue = 0.3f,
        targetValue = 0.7f,
        animationSpec = infiniteRepeatable(
            animation = tween(1200, easing = FastOutSlowInEasing),
            repeatMode = RepeatMode.Reverse
        ),
        label = "ringAlpha"
    )

    Column(
        horizontalAlignment = Alignment.CenterHorizontally,
        modifier = Modifier
            .padding(horizontal = 4.dp)
            .graphicsLayer {
                scaleX = scale
                scaleY = scale
            }
            .clickable {
                haptic.performHapticFeedback(HapticFeedbackType.TextHandleMove)
                onClick()
            }
    ) {
        Box(
            modifier = Modifier
                .size(if (isSelected) 52.dp else 44.dp)
                .then(
                    if (isSelected) {
                        Modifier.border(
                            width = 3.dp,
                            color = color.copy(alpha = ringAlpha),
                            shape = CircleShape
                        )
                    } else Modifier
                )
                .clip(CircleShape)
                .background(color.copy(alpha = if (status == MedicineStatus.NONE) 0.15f else 0.25f))
                .border(
                    width = if (isSelected) 2.dp else 2.dp,
                    color = color,
                    shape = CircleShape
                ),
            contentAlignment = Alignment.Center
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.Center
            ) {
                // Bug√ºn ise k√º√ß√ºk Dozi emoji g√∂ster
                if (isToday) {
                    Text(
                        text = "üíä",
                        style = MaterialTheme.typography.labelSmall,
                        fontSize = 10.sp,
                        modifier = Modifier.offset(y = (-2).dp)
                    )
                }
                Text(
                    text = displayDay,
                    color = if (status == MedicineStatus.NONE) MaterialTheme.colorScheme.onSurfaceVariant else MaterialTheme.colorScheme.onSurface,
                    fontWeight = if (isToday) FontWeight.ExtraBold else FontWeight.Bold,
                    fontSize = if (isSelected) 17.sp else if (isToday) 16.sp else 15.sp,
                    modifier = if (isToday) Modifier.offset(y = (-1).dp) else Modifier
                )
            }
        }

        Text(
            text = date.dayOfWeek.getDisplayName(TextStyle.SHORT, Locale("tr", "TR")),
            style = MaterialTheme.typography.labelSmall,
            color = if (isToday) DoziTurquoise else MaterialTheme.colorScheme.onSurfaceVariant,
            fontWeight = if (isToday) FontWeight.Bold else FontWeight.Normal,
            modifier = Modifier.padding(top = 2.dp)
        )
    }
}

@RequiresApi(Build.VERSION_CODES.O)
@Composable
private fun CalendarExpandedContent(
    date: LocalDate,
    status: MedicineStatus,
    onNavigateToReminders: () -> Unit,
    context: Context,
    allMedicines: List<Medicine>,
    isLoggedIn: Boolean
) {
    val dayLabel = "${date.dayOfMonth} ${date.month.getDisplayName(TextStyle.FULL, Locale("tr", "TR"))}"
    val medicines = remember(date, allMedicines) {
        getMedicineRecordsForDate(context, date, allMedicines)
    }

    val character = when (status) {
        MedicineStatus.TAKEN -> R.drawable.dozi_perfect
        MedicineStatus.PARTIAL -> R.drawable.dozi_bravo
        MedicineStatus.SKIPPED -> R.drawable.dozi_unhappy
        MedicineStatus.PLANNED -> R.drawable.dozi_time
        else -> R.drawable.dozi
    }

    Box(
        modifier = Modifier
            .fillMaxWidth()
            .padding(top = 8.dp)
            .clip(RoundedCornerShape(20.dp))
            .background(MaterialTheme.colorScheme.surface)
            .border(1.dp, DoziPrimaryLight, RoundedCornerShape(20.dp))
            .padding(16.dp)
    ) {
        Row(
            verticalAlignment = Alignment.Top,
            horizontalArrangement = Arrangement.Start
        ) {
            Image(
                painter = painterResource(id = character),
                contentDescription = "Dozi durumu",
                modifier = Modifier
                    .size(64.dp)
                    .padding(end = 12.dp)
            )

            Column(modifier = Modifier.weight(1f)) {
                Text(
                    text = dayLabel.uppercase(),
                    style = MaterialTheme.typography.titleSmall,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
                Spacer(Modifier.height(8.dp))

                if (status == MedicineStatus.NONE) {
                    ClickableReminderText(onNavigateToReminders, isLoggedIn, date)
                } else {
                    medicines.forEach { med ->
                        Row(
                            modifier = Modifier
                                .fillMaxWidth()
                                .padding(vertical = 4.dp)
                                .clip(RoundedCornerShape(10.dp))
                                .background(
                                    when (med.status) {
                                        MedicineStatus.TAKEN -> SuccessGreen.copy(alpha = 0.15f)
                                        MedicineStatus.SKIPPED -> ErrorRed.copy(alpha = 0.15f)
                                        MedicineStatus.UPCOMING -> DoziPurple.copy(alpha = 0.1f)
                                        else -> VeryLightGray.copy(alpha = 0.4f)
                                    }
                                )
                                .padding(horizontal = 12.dp, vertical = 8.dp),
                            horizontalArrangement = Arrangement.SpaceBetween,
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Text(
                                text = "${med.time}  ‚Ä¢  ${med.name}",
                                style = MaterialTheme.typography.bodySmall,
                                color = MaterialTheme.colorScheme.onSurface,
                                fontWeight = FontWeight.Medium
                            )
                            Icon(
                                imageVector = when (med.status) {
                                    MedicineStatus.TAKEN -> Icons.Default.Check
                                    MedicineStatus.SKIPPED -> Icons.Default.Close
                                    MedicineStatus.UPCOMING -> Icons.Default.Alarm
                                    else -> Icons.Default.Info
                                },
                                contentDescription = null,
                                tint = when (med.status) {
                                    MedicineStatus.TAKEN -> SuccessGreen
                                    MedicineStatus.SKIPPED -> ErrorRed
                                    MedicineStatus.UPCOMING -> DoziPurple
                                    else -> MaterialTheme.colorScheme.onSurfaceVariant
                                },
                                modifier = Modifier.size(18.dp)
                            )
                        }
                    }
                }
            }
        }
    }
}

@RequiresApi(Build.VERSION_CODES.O)
@Composable
private fun ClickableReminderText(onNavigateToReminders: () -> Unit, isLoggedIn: Boolean, date: LocalDate) {
    val today = LocalDate.now()
    val isToday = date == today
    val isFuture = date.isAfter(today)

    if (isLoggedIn) {
        // Sadece bug√ºn ve gelecek tarihler i√ßin hatƒ±rlatma ekleme se√ßeneƒüi g√∂ster
        if (isToday || isFuture) {
            ClickableText(
                text = buildAnnotatedString {
                    append("üíß ${if (isToday) "Bug√ºn" else "Bu tarih"} i√ßin planlanmƒ±≈ü bir ilacƒ±n yok.\n\n")
                    append("Yeni bir hatƒ±rlatma eklemek i√ßin ")
                    withStyle(
                        style = SpanStyle(
                            fontWeight = FontWeight.Bold,
                            color = DoziPurple,
                            textDecoration = TextDecoration.Underline
                        )
                    ) {
                        append("buraya tƒ±klayabilirsin.")
                    }
                },
                style = MaterialTheme.typography.bodyMedium.copy(color = MaterialTheme.colorScheme.onSurfaceVariant, lineHeight = 20.sp),
                onClick = { offset ->
                    // T√ºm metin tƒ±klanƒ±nca Hatƒ±rlatmalar ekranƒ±na y√∂nlendir
                    onNavigateToReminders()
                }
            )
        } else {
            // Ge√ßmi≈ü tarihler i√ßin sadece bilgilendirme g√∂ster
            Text(
                text = "üíß Bu tarih i√ßin planlanmƒ±≈ü bir ilacƒ±n yoktu.",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                textAlign = TextAlign.Center
            )
        }
    } else {
        Text(
            text = "üíß Giri≈ü yaparsan ila√ßlarƒ±nƒ± beraber takip edebiliriz!",
            style = MaterialTheme.typography.bodyMedium,
            color = MaterialTheme.colorScheme.onSurfaceVariant,
            textAlign = TextAlign.Center
        )
    }
}


@RequiresApi(Build.VERSION_CODES.O)
@Composable
private fun CurrentMedicineCard(
    medicine: Medicine,
    time: String,
    snoozeMinutes: Int,
    onTaken: () -> Unit,
    onSnooze: () -> Unit,
    onSkip: () -> Unit
) {
    val context = LocalContext.current
    var remainingSeconds by remember { mutableStateOf(0) }
    var snoozeTargetTime by remember { mutableStateOf("") }

    // ‚úÖ Bug√ºn bu ilacƒ±n ka√ß dozu olduƒüunu g√∂ster
    val todayDosesForThisMedicine = medicine.times.size
    val currentDoseIndex = medicine.times.indexOf(time) + 1

    // ‚è∞ Zaman kontrol√º
    val currentTime = LocalTime.now()
    val (hour, minute) = time.split(":").map { it.toInt() }
    val medicineTime = LocalTime.of(hour, minute)

    // 30 dakika √∂ncesinden itibaren "AL" aktif olsun
    val minutesUntilMedicine = java.time.Duration.between(currentTime, medicineTime).toMinutes()
    val canTakeMedicine = minutesUntilMedicine <= 30
    val canSnooze = minutesUntilMedicine <= 60 && minutesUntilMedicine > -15 // 1 saat √∂nceden, 15 dk sonrasƒ±na kadar
    val isOverdue = minutesUntilMedicine < 0 // Vakti ge√ßti mi?

    // Zaman durumu mesajƒ±
    val timeStatusMessage = when {
        minutesUntilMedicine > 30 -> "ƒ∞la√ß vaktinize ${if (minutesUntilMedicine < 60) "${minutesUntilMedicine} dakika" else "${minutesUntilMedicine / 60} saat ${minutesUntilMedicine % 60} dakika"} var"
        minutesUntilMedicine in 1..30 -> "Vakti yakla≈üƒ±yor"
        minutesUntilMedicine >= -15 -> "Vakti ge√ßti!"
        else -> "√áok ge√ß!"
    }

    // ‚úÖ Pulsing animation for the badge
    val infiniteTransition = rememberInfiniteTransition(label = "pulse")
    val pulseScale by infiniteTransition.animateFloat(
        initialValue = 1f,
        targetValue = 1.08f,
        animationSpec = infiniteRepeatable(
            animation = tween(800, easing = FastOutSlowInEasing),
            repeatMode = RepeatMode.Reverse
        ),
        label = "pulseScale"
    )

    // ‚úÖ Vakti ge√ßmi≈ü ila√ßlar i√ßin kartƒ±n tamamƒ± yanƒ±p s√∂ns√ºn
    val cardPulseAlpha by infiniteTransition.animateFloat(
        initialValue = if (isOverdue) 0.6f else 1f,
        targetValue = 1f,
        animationSpec = infiniteRepeatable(
            animation = tween(if (isOverdue) 600 else 800, easing = FastOutSlowInEasing),
            repeatMode = RepeatMode.Reverse
        ),
        label = "cardPulseAlpha"
    )

    // ‚úÖ snooze_until'e g√∂re kalan s√ºreyi hesapla
    LaunchedEffect(snoozeMinutes) {
        if (snoozeMinutes > 0) {
            val prefs = context.getSharedPreferences("dozi_prefs", Context.MODE_PRIVATE)
            val snoozeUntil = prefs.getLong("snooze_until", 0)

            // Hedef saati hesapla
            val calendar = java.util.Calendar.getInstance().apply {
                timeInMillis = snoozeUntil
            }
            val targetHour = calendar.get(java.util.Calendar.HOUR_OF_DAY)
            val targetMinute = calendar.get(java.util.Calendar.MINUTE)
            snoozeTargetTime = String.format("%02d:%02d", targetHour, targetMinute)

            while (snoozeUntil > System.currentTimeMillis()) {
                val remainingMillis = snoozeUntil - System.currentTimeMillis()
                remainingSeconds = (remainingMillis / 1000).toInt()

                if (remainingSeconds <= 0) break

                delay(1000)
            }

            // S√ºre doldu
            remainingSeconds = 0
            snoozeTargetTime = ""
        }
    }

    // Glow efekti i√ßin animated border
    val glowTransition = rememberInfiniteTransition(label = "cardGlow")
    val glowAlpha by glowTransition.animateFloat(
        initialValue = 0.3f,
        targetValue = 0.6f,
        animationSpec = infiniteRepeatable(
            animation = tween(1500, easing = FastOutSlowInEasing),
            repeatMode = RepeatMode.Reverse
        ),
        label = "glowAlpha"
    )

    Box(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 16.dp)
    ) {
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .graphicsLayer {
                    alpha = cardPulseAlpha
                }
                .border(
                    width = 2.dp,
                    brush = Brush.verticalGradient(
                        listOf(
                            DoziPrimary.copy(alpha = glowAlpha),
                            DoziSecondary.copy(alpha = glowAlpha)
                        )
                    ),
                    shape = RoundedCornerShape(24.dp)
                ),
            colors = CardDefaults.cardColors(
                containerColor = if (isOverdue)
                    MaterialTheme.colorScheme.errorContainer.copy(alpha = 0.3f)
                else
                    MaterialTheme.colorScheme.surface.copy(alpha = 0.95f)
            ),
            shape = RoundedCornerShape(24.dp),
            elevation = CardDefaults.cardElevation(0.dp)
        ) {
            Row(modifier = Modifier.fillMaxWidth()) {
                // Gradient accent bar
                Box(
                    modifier = Modifier
                        .width(4.dp)
                        .fillMaxHeight()
                        .background(
                            brush = Brush.verticalGradient(
                                listOf(DoziPrimary, DoziSecondary)
                            )
                        )
                )

                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(20.dp),
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.spacedBy(16.dp)
                ) {
            Surface(
                color = if (isOverdue) ErrorRed else DoziTurquoise,
                shape = RoundedCornerShape(14.dp),
                shadowElevation = 0.dp,
                modifier = Modifier.graphicsLayer {
                    scaleX = pulseScale
                    scaleY = pulseScale
                }
            ) {
                Row(
                    modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp),
                    horizontalArrangement = Arrangement.Center,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(
                        Icons.Default.Place,
                        contentDescription = null,
                        tint = Color.White,
                        modifier = Modifier.size(18.dp)
                    )
                    Spacer(Modifier.width(6.dp))
                    Text(
                        "SIRADA",
                        color = Color.White,
                        fontWeight = FontWeight.Bold,
                        style = MaterialTheme.typography.titleSmall,
                        letterSpacing = 1.sp
                    )
                }
            }

            if (remainingSeconds > 0 && snoozeTargetTime.isNotEmpty()) {
                Surface(
                    color = WarningOrange.copy(alpha = 0.15f),
                    shape = RoundedCornerShape(12.dp),
                    modifier = Modifier.fillMaxWidth()
                ) {
                    Column(
                        modifier = Modifier.padding(12.dp),
                        horizontalAlignment = Alignment.CenterHorizontally
                    ) {
                        Text(
                            "‚è∞ Saat $snoozeTargetTime'de hatƒ±rlatƒ±lacak",
                            style = MaterialTheme.typography.titleMedium,
                            fontWeight = FontWeight.Bold,
                            color = WarningOrange
                        )
                        Text(
                            "${remainingSeconds / 60} dk ${remainingSeconds % 60} sn kaldƒ±",
                            style = MaterialTheme.typography.bodySmall,
                            color = WarningOrange.copy(alpha = 0.8f)
                        )
                    }
                }
            }

            Row(
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.spacedBy(10.dp)
            ) {
                Icon(
                    Icons.Default.Schedule,
                    contentDescription = null,
                    tint = if (isOverdue) ErrorRed else DoziPrimary,
                    modifier = Modifier.size(32.dp)
                )
                Text(
                    time,
                    style = MaterialTheme.typography.displaySmall,
                    fontWeight = FontWeight.Bold,
                    color = if (isOverdue) ErrorRed else DoziPrimary
                )
            }

            Text(
                "${medicine.icon} ${medicine.name}",
                style = MaterialTheme.typography.headlineSmall,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )

            Row(
                horizontalArrangement = Arrangement.spacedBy(12.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    "üì¶ ${medicine.dosage}",
                    style = MaterialTheme.typography.titleSmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                // ‚úÖ Bug√ºn ka√ß doz olduƒüunu g√∂ster
                Surface(
                    color = DoziTurquoise.copy(alpha = 0.15f),
                    shape = RoundedCornerShape(8.dp)
                ) {
                    Text(
                        "$currentDoseIndex/$todayDosesForThisMedicine. doz",
                        modifier = Modifier.padding(horizontal = 10.dp, vertical = 4.dp),
                        style = MaterialTheme.typography.labelMedium,
                        fontWeight = FontWeight.Bold,
                        color = DoziTurquoise
                    )
                }
            }

            HorizontalDivider(color = VeryLightGray, thickness = 1.dp)

            // Zaman durumu uyarƒ±sƒ±
            if (minutesUntilMedicine != 0L) {
                Surface(
                    color = when {
                        isOverdue -> DoziRed.copy(alpha = 0.15f)
                        minutesUntilMedicine in 1..30 -> WarningOrange.copy(alpha = 0.15f)
                        else -> DoziTurquoise.copy(alpha = 0.1f)
                    },
                    shape = RoundedCornerShape(12.dp),
                    modifier = Modifier.fillMaxWidth()
                ) {
                    Row(
                        modifier = Modifier.padding(12.dp),
                        horizontalArrangement = Arrangement.Center,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Icon(
                            when {
                                isOverdue -> Icons.Default.Warning
                                minutesUntilMedicine in 1..30 -> Icons.Default.Schedule
                                else -> Icons.Default.Info
                            },
                            contentDescription = null,
                            tint = when {
                                isOverdue -> ErrorRed
                                minutesUntilMedicine in 1..30 -> WarningOrange
                                else -> DoziTurquoise
                            },
                            modifier = Modifier.size(20.dp)
                        )
                        Spacer(Modifier.width(8.dp))
                        Text(
                            timeStatusMessage,
                            style = MaterialTheme.typography.bodyMedium,
                            color = when {
                                isOverdue -> ErrorRed
                                minutesUntilMedicine in 1..30 -> WarningOrange
                                else -> DoziTurquoise
                            },
                            fontWeight = FontWeight.Medium
                        )
                    }
                }
                Spacer(Modifier.height(8.dp))
            }

            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.spacedBy(10.dp)
            ) {
                ActionButton(
                    text = "AL",
                    icon = Icons.Default.Check,
                    color = if (canTakeMedicine) SuccessGreen else Gray200,
                    modifier = Modifier.weight(1f),
                    enabled = canTakeMedicine,
                    onClick = onTaken
                )

                ActionButton(
                    text = "ERTELE",
                    icon = Icons.Default.AccessTime,
                    color = if (canSnooze) WarningOrange else Gray200,
                    modifier = Modifier.weight(1f),
                    enabled = canSnooze,
                    onClick = {
                        SoundHelper.playSound(context, SoundHelper.SoundType.ERTELE)
                        onSnooze()
                    }
                )

                ActionButton(
                    text = "ATLA",
                    icon = Icons.Default.Close,
                    color = ErrorRed,
                    modifier = Modifier.weight(1f),
                    onClick = onSkip
                )
            }
                }
            }
        }
    }
}

@RequiresApi(Build.VERSION_CODES.O)
@Composable
private fun EmptyMedicineCard(
    currentMedicineStatus: MedicineStatus,
    nextMedicine: Pair<Medicine, String>?,
    isLoggedIn: Boolean
) {
    // ‚úÖ Bug√ºn kalan ila√ß sayƒ±sƒ±nƒ± hesapla
    val context = LocalContext.current
    val today = getCurrentDateString()
    val medicineRepository = remember { MedicineRepository() }
    val allMedicines by medicineRepository.getMedicinesFlow()
        .collectAsState(initial = emptyList())
    val todayDate = LocalDate.now()
    val todaysMedicines = allMedicines.filter { shouldMedicineShowOnDate(it, todayDate) }
    val totalDosesToday = todaysMedicines.sumOf { it.times.size }
    val takenDosesToday = todaysMedicines.sumOf { medicine ->
        medicine.times.count { time ->
            getMedicineStatus(context, medicine.id, today, time) == "taken"
        }
    }
    val skippedDosesToday = todaysMedicines.sumOf { medicine ->
        medicine.times.count { time ->
            getMedicineStatus(context, medicine.id, today, time)?.startsWith("skipped") == true
        }
    }
    val remainingDoses = totalDosesToday - takenDosesToday - skippedDosesToday

    // Vakti ge√ßmi≈ü ama alƒ±nmamƒ±≈ü/atlanmamƒ±≈ü dozlarƒ± say
    val currentTime = LocalTime.now()
    val overdueDoses = todaysMedicines.sumOf { medicine ->
        medicine.times.count { time ->
            val status = getMedicineStatus(context, medicine.id, today, time)
            if (status == "taken" || status?.startsWith("skipped") == true) {
                false
            } else {
                // Zamanƒ± ge√ßmi≈ü mi kontrol et
                val (hour, minute) = time.split(":").map { it.toInt() }
                val medicineTime = LocalTime.of(hour, minute)
                currentTime.isAfter(medicineTime)
            }
        }
    }

    Card(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 16.dp)
            .border(1.dp, DoziPrimaryLight, RoundedCornerShape(24.dp)),
        colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
        shape = RoundedCornerShape(24.dp),
        elevation = CardDefaults.cardElevation(0.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(32.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            Image(
                painter = painterResource(id = R.drawable.dozi_happy2),
                contentDescription = null,
                modifier = Modifier.size(100.dp)
            )

            Text(
                if (!isLoggedIn) {
                    "Dozi ile tanƒ±≈üalƒ±m!"
                } else {
                    when (currentMedicineStatus) {
                        MedicineStatus.TAKEN -> "Harika! ƒ∞lacƒ±nƒ± aldƒ±n"
                        MedicineStatus.SKIPPED -> "Bug√ºn i√ßin ba≈üka ila√ß yok"
                        else -> "Hen√ºz ila√ß zamanƒ± deƒüil"
                    }
                },
                style = MaterialTheme.typography.titleLarge,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface,
                textAlign = TextAlign.Center
            )

            // ‚úÖ Kalan doz bilgisi g√∂ster (eƒüer varsa)
            if (!isLoggedIn) {
                Text(
                    "Giri≈ü yaparsan ila√ßlarƒ±nƒ± beraber takip edebiliriz! üíä",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                    textAlign = TextAlign.Center
                )
                Spacer(Modifier.height(8.dp))
                Text(
                    "ƒ∞la√ß hatƒ±rlatmalarƒ±, d√ºzenli takip ve senkronize edilmi≈ü veriler i√ßin giri≈ü yapman yeterli.",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.8f),
                    textAlign = TextAlign.Center
                )
            } else if (overdueDoses > 0 && currentMedicineStatus != MedicineStatus.TAKEN) {
                // Vakti ge√ßmi≈ü dozlar varsa kƒ±rmƒ±zƒ± uyarƒ± g√∂ster
                Surface(
                    color = DoziRed.copy(alpha = 0.1f),
                    shape = RoundedCornerShape(12.dp)
                ) {
                    Column(
                        modifier = Modifier.padding(16.dp),
                        horizontalAlignment = Alignment.CenterHorizontally,
                        verticalArrangement = Arrangement.spacedBy(4.dp)
                    ) {
                        Text(
                            "‚ö†Ô∏è $overdueDoses doz vakti ge√ßti!",
                            style = MaterialTheme.typography.bodyLarge,
                            fontWeight = FontWeight.Bold,
                            color = DoziRed
                        )
                        if (nextMedicine != null) {
                            Text(
                                "L√ºtfen ilacƒ±nƒ±zƒ± almayƒ± unutmayƒ±n",
                                style = MaterialTheme.typography.bodySmall,
                                color = MaterialTheme.colorScheme.onSurfaceVariant
                            )
                        }
                    }
                }
            } else if (remainingDoses > 0 && currentMedicineStatus != MedicineStatus.TAKEN) {
                // Kalan doz varsa g√∂ster
                Surface(
                    color = DoziTurquoise.copy(alpha = 0.1f),
                    shape = RoundedCornerShape(12.dp)
                ) {
                    Column(
                        modifier = Modifier.padding(16.dp),
                        horizontalAlignment = Alignment.CenterHorizontally,
                        verticalArrangement = Arrangement.spacedBy(4.dp)
                    ) {
                        Text(
                            "Bug√ºn $remainingDoses doz daha var",
                            style = MaterialTheme.typography.bodyLarge,
                            fontWeight = FontWeight.Bold,
                            color = DoziTurquoise
                        )
                        if (nextMedicine != null) {
                            Text(
                                "Sƒ±radaki: ${nextMedicine.first.name} ‚Ä¢ ${nextMedicine.second}",
                                style = MaterialTheme.typography.bodySmall,
                                color = MaterialTheme.colorScheme.onSurfaceVariant
                            )
                        }
                    }
                }
            } else if (nextMedicine != null && currentMedicineStatus != MedicineStatus.TAKEN && currentMedicineStatus != MedicineStatus.SKIPPED) {
                Spacer(Modifier.height(8.dp))
                Surface(
                    color = DoziTurquoise.copy(alpha = 0.1f),
                    shape = RoundedCornerShape(12.dp)
                ) {
                    Column(
                        modifier = Modifier.padding(16.dp),
                        horizontalAlignment = Alignment.CenterHorizontally,
                        verticalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Text(
                            "Sƒ±radaki Hatƒ±rlatma",
                            style = MaterialTheme.typography.labelMedium,
                            color = DoziTurquoise,
                            fontWeight = FontWeight.Bold
                        )
                        Text(
                            "${nextMedicine.first.icon} ${nextMedicine.first.name}",
                            style = MaterialTheme.typography.titleMedium,
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.onSurface
                        )
                        Row(
                            horizontalArrangement = Arrangement.spacedBy(8.dp),
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Icon(
                                Icons.Default.Schedule,
                                contentDescription = null,
                                tint = DoziTurquoise,
                                modifier = Modifier.size(16.dp)
                            )
                            Text(
                                nextMedicine.second,
                                style = MaterialTheme.typography.bodyLarge,
                                color = DoziTurquoise,
                                fontWeight = FontWeight.Bold
                            )
                        }
                    }
                }
            } else {
                Text(
                    when (currentMedicineStatus) {
                        MedicineStatus.TAKEN -> "Saƒülƒ±ƒüƒ±nla ilgilendiƒüin i√ßin te≈üekk√ºrler!"
                        MedicineStatus.SKIPPED -> "Yarƒ±n i√ßin planlanmƒ±≈ü ila√ßlarƒ±n var"
                        else -> "Vakti gelince seni uyaracaƒüƒ±m"
                    },
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                    textAlign = TextAlign.Center
                )
            }
        }
    }
}

@Composable
private fun ActionButton(
    text: String,
    icon: androidx.compose.ui.graphics.vector.ImageVector,
    color: Color,
    modifier: Modifier = Modifier,
    enabled: Boolean = true,
    onClick: () -> Unit
) {
    var isPressed by remember { mutableStateOf(false) }
    val haptic = LocalHapticFeedback.current
    val scale by animateFloatAsState(
        targetValue = if (isPressed) 0.92f else 1f,
        animationSpec = spring(
            dampingRatio = Spring.DampingRatioMediumBouncy,
            stiffness = Spring.StiffnessLow
        ),
        label = "buttonScale"
    )

    Button(
        onClick = {
            haptic.performHapticFeedback(HapticFeedbackType.LongPress)
            onClick()
        },
        enabled = enabled,
        modifier = modifier
            .height(54.dp)
            .graphicsLayer {
                scaleX = scale
                scaleY = scale
            }
            .pointerInput(Unit) {
                detectTapGestures(
                    onPress = {
                        isPressed = true
                        tryAwaitRelease()
                        isPressed = false
                    }
                )
            },
        colors = ButtonDefaults.buttonColors(
            containerColor = color,
            disabledContainerColor = color.copy(alpha = 0.4f)
        ),
        shape = RoundedCornerShape(14.dp),
        elevation = ButtonDefaults.buttonElevation(0.dp)
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.Center
        ) {
            Icon(
                icon,
                contentDescription = null,
                modifier = Modifier.size(22.dp),
                tint = Color.White
            )
            Spacer(Modifier.height(3.dp))
            Text(
                text,
                fontWeight = FontWeight.Bold,
                fontSize = 10.sp,
                color = Color.White
            )
        }
    }
}

@RequiresApi(Build.VERSION_CODES.O)
@Composable
private fun TimelineSection(
    medicines: List<Medicine>,
    expanded: Boolean,
    context: Context,
    onToggle: () -> Unit
) {
    val currentTime = LocalTime.now()
    val today = getCurrentDateString()

    // Create timeline items from medicines with their times
    val timelineItems = medicines.flatMap { medicine ->
        medicine.times.map { time ->
            val savedStatus = getMedicineStatus(context, medicine.id, today, time)
            val status = when {
                savedStatus == "taken" -> TimelineStatus.TAKEN
                savedStatus == "skipped" -> TimelineStatus.SKIPPED
                savedStatus?.startsWith("snoozed_") == true -> TimelineStatus.SNOOZED
                else -> determineTimelineStatus(time, currentTime)
            }
            Triple(medicine, time, status to savedStatus)
        }
    }.sortedBy { it.second }

    Column(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 16.dp)
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .clickable(onClick = onToggle)
                .padding(horizontal = 8.dp, vertical = 12.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Row(
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                Text(
                    "Bug√ºn√ºn ƒ∞la√ßlarƒ±",
                    style = MaterialTheme.typography.titleLarge,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
                Surface(
                    color = DoziTurquoise,
                    shape = RoundedCornerShape(8.dp)
                ) {
                    Text(
                        timelineItems.size.toString(),
                        modifier = Modifier.padding(horizontal = 10.dp, vertical = 4.dp),
                        color = Color.White,
                        fontWeight = FontWeight.Bold,
                        fontSize = 14.sp
                    )
                }
            }

            Icon(
                if (expanded) Icons.Default.KeyboardArrowUp else Icons.Default.KeyboardArrowDown,
                contentDescription = null,
                tint = DoziTurquoise,
                modifier = Modifier.size(28.dp)
            )
        }

        AnimatedVisibility(
            visible = expanded,
            enter = expandVertically() + fadeIn(),
            exit = shrinkVertically() + fadeOut()
        ) {
            if (timelineItems.isEmpty()) {
                // Show empty state
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(vertical = 24.dp),
                    horizontalAlignment = Alignment.CenterHorizontally
                ) {
                    Text(
                        "Bug√ºn i√ßin planlanmƒ±≈ü ila√ß yok",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            } else {
                Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {
                    Spacer(Modifier.height(8.dp))

                    timelineItems.forEachIndexed { index, (medicine, time, status) ->
                        AnimatedVisibility(
                            visible = true,
                            enter = fadeIn(
                                animationSpec = tween(
                                    durationMillis = 400,
                                    delayMillis = index * 100,
                                    easing = FastOutSlowInEasing
                                )
                            ) + slideInVertically(
                                animationSpec = tween(
                                    durationMillis = 400,
                                    delayMillis = index * 100,
                                    easing = FastOutSlowInEasing
                                ),
                                initialOffsetY = { it / 3 }
                            )
                        ) {
                            TimelineItem(
                                time = time,
                                medicineName = "${medicine.icon} ${medicine.name}",
                                dosageText = "${medicine.dosage} ${medicine.unit}",
                                status = status.first,
                                savedStatus = status.second,
                                currentTime = currentTime
                            )
                        }
                    }
                }
            }
        }
    }
}

@RequiresApi(Build.VERSION_CODES.O)
private fun determineTimelineStatus(time: String, currentTime: LocalTime): TimelineStatus {
    val (hour, minute) = time.split(":").map { it.toInt() }
    val medicineTime = LocalTime.of(hour, minute)

    return when {
        medicineTime.isBefore(currentTime.minusMinutes(30)) -> TimelineStatus.COMPLETED
        medicineTime.isAfter(currentTime.plusMinutes(30)) -> TimelineStatus.UPCOMING
        else -> TimelineStatus.CURRENT
    }
}

enum class TimelineStatus {
    COMPLETED, CURRENT, UPCOMING, TAKEN, SKIPPED, SNOOZED
}

@RequiresApi(Build.VERSION_CODES.O)
@Composable
private fun TimelineItem(
    time: String,
    medicineName: String,
    dosageText: String,
    status: TimelineStatus,
    savedStatus: String?,
    currentTime: LocalTime
) {
    val subtitle = when (status) {
        TimelineStatus.TAKEN -> "‚úÖ Alƒ±ndƒ±"
        TimelineStatus.SKIPPED -> "‚è≠Ô∏è Atlandƒ±"
        TimelineStatus.SNOOZED -> {
            val snoozeUntil = savedStatus?.substringAfter("snoozed_")?.toLongOrNull()
            if (snoozeUntil != null && snoozeUntil > System.currentTimeMillis()) {
                val remainingMs = snoozeUntil - System.currentTimeMillis()
                val remainingMin = (remainingMs / 60_000).toInt()
                "‚è∞ $remainingMin dk ertelendi"
            } else {
                "‚è∞ Ertelendi"
            }
        }
        else -> {
            val (hour, minute) = time.split(":").map { it.toInt() }
            val medicineTime = LocalTime.of(hour, minute)
            when (status) {
                TimelineStatus.COMPLETED -> {
                    val diff = java.time.Duration.between(medicineTime, currentTime)
                    val hours = diff.toHours()
                    if (hours > 0) "$hours saat √∂nce" else "Az √∂nce"
                }
                TimelineStatus.CURRENT -> "≈ûƒ∞MDƒ∞"
                TimelineStatus.UPCOMING -> {
                    val diff = java.time.Duration.between(currentTime, medicineTime)
                    val hours = diff.toHours()
                    if (hours > 0) "$hours saat sonra" else "${diff.toMinutes()} dk sonra"
                }
                else -> ""
            }
        }
    }
    Card(
        colors = CardDefaults.cardColors(
            containerColor = when (status) {
                TimelineStatus.TAKEN -> SuccessGreen.copy(alpha = 0.1f)
                TimelineStatus.SKIPPED -> ErrorRed.copy(alpha = 0.1f)
                TimelineStatus.SNOOZED -> WarningOrange.copy(alpha = 0.1f)
                TimelineStatus.COMPLETED -> Color.White
                TimelineStatus.CURRENT -> DoziCoralLight.copy(alpha = 0.15f)
                TimelineStatus.UPCOMING -> Color.White
            } as Color
        ),
        shape = RoundedCornerShape(16.dp),
        border = BorderStroke(
            width = when (status) {
                TimelineStatus.CURRENT -> 2.dp
                TimelineStatus.TAKEN, TimelineStatus.SKIPPED, TimelineStatus.SNOOZED -> 2.dp
                else -> 1.dp
            },
            color = when (status) {
                TimelineStatus.TAKEN -> SuccessGreen
                TimelineStatus.SKIPPED -> ErrorRed
                TimelineStatus.SNOOZED -> WarningOrange
                TimelineStatus.COMPLETED -> DoziTurquoise.copy(alpha = 0.4f)
                TimelineStatus.CURRENT -> DoziRed
                TimelineStatus.UPCOMING -> VeryLightGray
            }
        ),
        elevation = CardDefaults.cardElevation(0.dp),
        modifier = Modifier.fillMaxWidth()
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            // Sol taraf: ƒ∞la√ß bilgileri
            Row(
                modifier = Modifier.weight(1f),
                horizontalArrangement = Arrangement.spacedBy(12.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Box(
                    modifier = Modifier
                        .size(12.dp)
                        .clip(CircleShape)
                        .background(
                            when (status) {
                                TimelineStatus.TAKEN -> SuccessGreen
                                TimelineStatus.SKIPPED -> ErrorRed
                                TimelineStatus.SNOOZED -> WarningOrange
                                TimelineStatus.COMPLETED -> DoziTurquoise
                                TimelineStatus.CURRENT -> DoziRed
                                TimelineStatus.UPCOMING -> LightGray
                            }
                        )
                )

                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        medicineName,
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface,
                        maxLines = 1,
                        overflow = androidx.compose.ui.text.style.TextOverflow.Ellipsis
                    )
                    Row(
                        horizontalArrangement = Arrangement.spacedBy(8.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Text(
                            dosageText,
                            style = MaterialTheme.typography.bodyMedium,
                            color = DoziTurquoise,
                            fontWeight = FontWeight.SemiBold
                        )
                        Text(
                            "‚Ä¢",
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                        Text(
                            subtitle,
                            style = MaterialTheme.typography.bodySmall,
                            color = when (status) {
                                TimelineStatus.TAKEN -> SuccessGreen
                                TimelineStatus.SKIPPED -> ErrorRed
                                TimelineStatus.SNOOZED -> WarningOrange
                                TimelineStatus.CURRENT -> DoziRed
                                else -> MaterialTheme.colorScheme.onSurfaceVariant
                            },
                            fontWeight = if (status == TimelineStatus.CURRENT) FontWeight.Bold else FontWeight.Normal
                        )
                    }
                }
            }

            // Saƒü taraf: Saat
            Column(
                horizontalAlignment = Alignment.End,
                modifier = Modifier.padding(start = 8.dp)
            ) {
                Text(
                    time,
                    style = MaterialTheme.typography.headlineSmall,
                    fontWeight = FontWeight.Bold,
                    color = when (status) {
                        TimelineStatus.CURRENT -> DoziRed
                        TimelineStatus.COMPLETED -> DoziTurquoise
                        else -> MaterialTheme.colorScheme.onSurfaceVariant
                    }
                )
            }
        }
    }
}

@Composable
private fun SnoozeDialog(
    onDismiss: () -> Unit,
    onConfirm: (Int) -> Unit
) {
    var selectedMinutes by remember { mutableStateOf(10) }
    val options = listOf(10, 15, 30, 60)
    val context = LocalContext.current

    Dialog(onDismissRequest = onDismiss) {
        Card(
            shape = RoundedCornerShape(24.dp),
            colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
            elevation = CardDefaults.cardElevation(8.dp)
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(24.dp),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                Text(
                    "Ne Kadar Erteleyelim?",
                    style = MaterialTheme.typography.titleLarge,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )

                Text(
                    "ƒ∞lacƒ±nƒ± almak i√ßin biraz daha zamana mƒ± ihtiyacƒ±n var?",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )

                Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                    options.forEach { minutes ->
                        SnoozeOption(
                            minutes = minutes,
                            selected = selectedMinutes == minutes,
                            onClick = { selectedMinutes = minutes }
                        )
                    }
                }

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    OutlinedButton(
                        onClick = onDismiss,
                        modifier = Modifier.weight(1f),
                        shape = RoundedCornerShape(12.dp)
                    ) {
                        Text("ƒ∞ptal")
                    }

                    Button(
                        onClick = {
                            // ‚úÖ SharedPreferences'a kaydet
                            context.getSharedPreferences("dozi_prefs", Context.MODE_PRIVATE).edit()
                                .putInt("snooze_minutes", selectedMinutes)
                                .putLong("snooze_until", System.currentTimeMillis() + selectedMinutes * 60_000L)
                                .putLong("snooze_timestamp", System.currentTimeMillis()) // ‚úÖ Zaman damgasƒ±
                                .apply()

                            onConfirm(selectedMinutes)
                        },
                        modifier = Modifier.weight(1f),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = WarningOrange
                        ),
                        shape = RoundedCornerShape(12.dp)
                    ) {
                        Text("Ertele")
                    }
                }
            }
        }
    }
}

@Composable
private fun SnoozeOption(
    minutes: Int,
    selected: Boolean,
    onClick: () -> Unit
) {
    Surface(
        onClick = onClick,
        shape = RoundedCornerShape(12.dp),
        color = if (selected) WarningOrange.copy(alpha = 0.1f) else VeryLightGray,
        border = BorderStroke(
            width = if (selected) 2.dp else 1.dp,
            color = if (selected) WarningOrange else Color.Transparent
        )
    ) {
        Text(
            "$minutes dakika",
            modifier = Modifier.padding(horizontal = 16.dp, vertical = 12.dp),
            color = if (selected) WarningOrange else MaterialTheme.colorScheme.onSurface,
            fontWeight = if (selected) FontWeight.Bold else FontWeight.Normal
        )
    }
}

@Composable
private fun SkipReasonDialog(
    onDismiss: () -> Unit,
    onConfirm: (String) -> Unit
) {
    var selectedReason by remember { mutableStateOf<String?>(null) }
    var customNote by remember { mutableStateOf("") }
    var showCustomNoteField by remember { mutableStateOf(false) }
    val focusManager = LocalFocusManager.current

    val reasons = listOf(
        "üíä ƒ∞lacƒ±m bitti",
        "üò¥ Unutmu≈üum",
        "üè• Doktor deƒüi≈ütirdi",
        "ü§¢ Yan etki ya≈üƒ±yorum",
        "‚ú® Kendimi iyi hissediyorum",
        "üïê Daha sonra alacaƒüƒ±m",
        "‚úèÔ∏è Ba≈üka bir neden (not yaz)"
    )

    Dialog(onDismissRequest = onDismiss) {
        Card(
            shape = RoundedCornerShape(24.dp),
            colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
            elevation = CardDefaults.cardElevation(8.dp)
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(24.dp)
                    .verticalScroll(rememberScrollState())
                    .pointerInput(Unit) {
                        detectTapGestures(onTap = {
                            focusManager.clearFocus()
                        })
                    },
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    Icon(
                        Icons.Default.Info,
                        contentDescription = null,
                        tint = WarningOrange,
                        modifier = Modifier.size(28.dp)
                    )
                    Text(
                        "Neden Atlamak ƒ∞stiyorsun?",
                        style = MaterialTheme.typography.titleLarge,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                }

                Text(
                    "Sebebini bilmek, ila√ß takibini daha iyi yapmamƒ± saƒülar.",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )

                Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                    reasons.forEach { reason ->
                        ReasonChip(
                            text = reason,
                            selected = selectedReason == reason,
                            onClick = {
                                selectedReason = reason
                                showCustomNoteField = reason.contains("Ba≈üka bir neden")
                            }
                        )
                    }
                }

                // √ñzel not alanƒ±
                AnimatedVisibility(visible = showCustomNoteField) {
                    OutlinedTextField(
                        value = customNote,
                        onValueChange = { customNote = it },
                        label = { Text("Notunuz (opsiyonel)") },
                        placeholder = { Text("√ñrn: Bug√ºn mide bulantƒ±m var") },
                        modifier = Modifier.fillMaxWidth(),
                        shape = RoundedCornerShape(12.dp),
                        colors = OutlinedTextFieldDefaults.colors(
                            focusedBorderColor = DoziTurquoise,
                            focusedLabelColor = DoziTurquoise
                        ),
                        maxLines = 3
                    )
                }

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    OutlinedButton(
                        onClick = onDismiss,
                        modifier = Modifier.weight(1f),
                        shape = RoundedCornerShape(12.dp),
                        border = BorderStroke(2.dp, Gray200)
                    ) {
                        Text("ƒ∞ptal", color = MaterialTheme.colorScheme.onSurfaceVariant)
                    }

                    Button(
                        onClick = {
                            val finalReason = if (showCustomNoteField && customNote.isNotBlank()) {
                                "Diƒüer: $customNote"
                            } else {
                                selectedReason ?: ""
                            }
                            onConfirm(finalReason)
                        },
                        modifier = Modifier.weight(1f),
                        enabled = selectedReason != null,
                        colors = ButtonDefaults.buttonColors(
                            containerColor = WarningOrange,
                            disabledContainerColor = Gray200
                        ),
                        shape = RoundedCornerShape(12.dp)
                    ) {
                        Icon(Icons.Default.Close, contentDescription = null, modifier = Modifier.size(18.dp))
                        Spacer(Modifier.width(4.dp))
                        Text("Atla", fontWeight = FontWeight.Bold)
                    }
                }
            }
        }
    }
}

@Composable
private fun ReasonChip(
    text: String,
    selected: Boolean,
    onClick: () -> Unit
) {
    Surface(
        onClick = onClick,
        shape = RoundedCornerShape(12.dp),
        color = if (selected) DoziTurquoise.copy(alpha = 0.15f) else Color.White,
        border = BorderStroke(
            width = 2.dp,
            color = if (selected) DoziTurquoise else Gray200
        ),
        shadowElevation = if (selected) 4.dp else 0.dp
    ) {
        Row(
            modifier = Modifier.padding(14.dp),
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.spacedBy(10.dp)
        ) {
            if (selected) {
                Icon(
                    Icons.Default.CheckCircle,
                    contentDescription = null,
                    tint = DoziTurquoise,
                    modifier = Modifier.size(22.dp)
                )
            }
            Text(
                text = text,
                style = MaterialTheme.typography.bodyLarge,
                color = if (selected) DoziTurquoise else MaterialTheme.colorScheme.onSurfaceVariant,
                fontWeight = if (selected) FontWeight.Bold else FontWeight.Medium
            )
        }
    }
}

@Composable
private fun EditNameDialog(
    currentName: String,
    onDismiss: () -> Unit,
    onConfirm: (String) -> Unit
) {
    var nameText by remember { mutableStateOf(currentName) }
    var isError by remember { mutableStateOf(false) }
    val focusManager = LocalFocusManager.current

    Dialog(onDismissRequest = onDismiss) {
        Card(
            shape = RoundedCornerShape(24.dp),
            colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
            elevation = CardDefaults.cardElevation(8.dp)
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(24.dp)
                    .pointerInput(Unit) {
                        detectTapGestures(onTap = {
                            focusManager.clearFocus()
                        })
                    },
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    Icon(
                        Icons.Default.Person,
                        contentDescription = null,
                        tint = DoziTurquoise,
                        modifier = Modifier.size(32.dp)
                    )
                    Text(
                        "Adƒ±nƒ± D√ºzenle",
                        style = MaterialTheme.typography.titleLarge,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                }

                Text(
                    "Seni nasƒ±l √ßaƒüƒ±rayƒ±m?",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )

                OutlinedTextField(
                    value = nameText,
                    onValueChange = {
                        nameText = it
                        isError = it.isBlank()
                    },
                    label = { Text("Adƒ±n") },
                    placeholder = { Text("√ñrn: Ufuk") },
                    leadingIcon = {
                        Icon(Icons.Default.Badge, contentDescription = null, tint = DoziTurquoise)
                    },
                    isError = isError,
                    supportingText = if (isError) {
                        { Text("L√ºtfen bir isim girin", color = ErrorRed) }
                    } else null,
                    modifier = Modifier.fillMaxWidth(),
                    singleLine = true,
                    shape = RoundedCornerShape(12.dp),
                    colors = OutlinedTextFieldDefaults.colors(
                        focusedBorderColor = DoziTurquoise,
                        focusedLabelColor = DoziTurquoise,
                        cursorColor = DoziTurquoise,
                        unfocusedBorderColor = VeryLightGray,
                        focusedContainerColor = DoziTurquoise.copy(alpha = 0.05f),
                        unfocusedContainerColor = Color.White,
                        errorBorderColor = ErrorRed,
                        errorLabelColor = ErrorRed
                    )
                )

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    OutlinedButton(
                        onClick = onDismiss,
                        modifier = Modifier.weight(1f),
                        shape = RoundedCornerShape(12.dp),
                        border = BorderStroke(2.dp, VeryLightGray)
                    ) {
                        Text("ƒ∞ptal", color = MaterialTheme.colorScheme.onSurfaceVariant)
                    }

                    Button(
                        onClick = {
                            if (nameText.isNotBlank()) {
                                onConfirm(nameText)
                            } else {
                                isError = true
                            }
                        },
                        modifier = Modifier.weight(1f),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = DoziTurquoise
                        ),
                        shape = RoundedCornerShape(12.dp)
                    ) {
                        Icon(Icons.Default.Check, contentDescription = null)
                        Spacer(Modifier.width(8.dp))
                        Text("Kaydet", fontWeight = FontWeight.Bold)
                    }
                }
            }
        }
    }
}
/**
 * üî• Streak ve G√ºnl√ºk √ñzet Kartƒ±
 */
@RequiresApi(Build.VERSION_CODES.O)
@Composable
private fun StreakAndDailySummaryCard(
    context: Context,
    medicines: List<Medicine>,
    onNavigateToStats: () -> Unit
) {
    val today = getCurrentDateString()

    // ‚úÖ Doz bazlƒ± hesaplama: Her bir ilacƒ±n her bir saatini ayrƒ± ayrƒ± say
    val takenCount = medicines.sumOf { medicine ->
        medicine.times.count { time ->
            getMedicineStatus(context, medicine.id, today, time) == "taken"
        }
    }
    val totalDoses = medicines.sumOf { it.times.size }
    val progress = if (totalDoses > 0) takenCount.toFloat() / totalDoses else 0f

    // ‚úÖ Streak bilgisi - Bug√ºn %100 ba≈üarƒ±lƒ±ysa streak'i artƒ±r
    val prefs = context.getSharedPreferences("dozi_streak", Context.MODE_PRIVATE)
    var currentStreak by remember { mutableStateOf(prefs.getInt("current_streak", 0)) }

    // ‚úÖ Bug√ºn√ºn streak'ini g√ºncelle (sadece bir kez, g√ºn deƒüi≈ütiƒüinde)
    LaunchedEffect(today, takenCount, totalDoses) {
        val lastStreakDate = prefs.getString("last_streak_date", "")

        // Bug√ºn i√ßin streak g√ºncellemesi yapƒ±ldƒ± mƒ±?
        if (lastStreakDate != today && totalDoses > 0) {
            // Bug√ºn %100 ba≈üarƒ±lƒ±ysa streak'i artƒ±r
            if (takenCount == totalDoses) {
                val newStreak = currentStreak + 1
                prefs.edit()
                    .putInt("current_streak", newStreak)
                    .putString("last_streak_date", today)
                    .apply()
                currentStreak = newStreak
            } else if (takenCount < totalDoses && !LocalTime.now().isBefore(LocalTime.of(23, 0))) {
                // G√ºn sonunda %100 deƒüilse streak sƒ±fƒ±rla (sadece saat 23:00'dan sonra)
                prefs.edit()
                    .putInt("current_streak", 0)
                    .putString("last_streak_date", today)
                    .apply()
                currentStreak = 0
            }
        }
    }

    Card(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 16.dp)
            .clickable(onClick = onNavigateToStats),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surface
        ),
        shape = RoundedCornerShape(16.dp),
        elevation = CardDefaults.cardElevation(2.dp)
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(12.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            // Sol: G√ºnl√ºk √ñzet (Kompakt)
            Row(
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.spacedBy(8.dp),
                modifier = Modifier.weight(1f)
            ) {
                // Progress bar circle
                Box(contentAlignment = Alignment.Center) {
                    CircularProgressIndicator(
                        progress = { progress },
                        modifier = Modifier.size(48.dp),
                        color = DoziTurquoise,
                        strokeWidth = 4.dp,
                        trackColor = DoziTurquoise.copy(alpha = 0.15f)
                    )
                    Text(
                        "$takenCount",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.ExtraBold,
                        color = DoziTurquoise
                    )
                }
                Column(verticalArrangement = Arrangement.spacedBy(2.dp)) {
                    Text(
                        "Bug√ºn",
                        style = MaterialTheme.typography.labelSmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                    Text(
                        "$takenCount/$totalDoses doz",
                        style = MaterialTheme.typography.bodyMedium,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                }
            }

            // Divider
            VerticalDivider(
                modifier = Modifier
                    .height(40.dp)
                    .width(1.dp),
                color = Gray200
            )

            // Saƒü: Streak (Kompakt)
            Row(
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.spacedBy(6.dp),
                modifier = Modifier.padding(start = 8.dp)
            ) {
                Text(
                    "üî•",
                    style = MaterialTheme.typography.headlineMedium
                )
                Column(
                    horizontalAlignment = Alignment.Start,
                    verticalArrangement = Arrangement.spacedBy(0.dp)
                ) {
                    Text(
                        "$currentStreak g√ºn",
                        style = MaterialTheme.typography.titleLarge,
                        fontWeight = FontWeight.ExtraBold,
                        color = DoziRed
                    )
                    Text(
                        "seri",
                        style = MaterialTheme.typography.labelSmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }
        }
    }
}

// MultiMedicineCard - Aynƒ± saatte birden fazla ila√ß olduƒüunda
@Composable
private fun MultiMedicineCard(
    medicines: List<Pair<Medicine, String>>,
    time: String,
    onTaken: (Medicine) -> Unit,
    onSnooze: () -> Unit,
    onSkip: (Medicine) -> Unit
) {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 16.dp),
        colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
        shape = RoundedCornerShape(24.dp),
        elevation = CardDefaults.cardElevation(8.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(24.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // Header
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Column {
                    Text(
                        "ƒ∞la√ß Zamanƒ±",
                        style = MaterialTheme.typography.titleLarge,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                    Row(
                        horizontalArrangement = Arrangement.spacedBy(4.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Icon(
                            Icons.Default.Schedule,
                            contentDescription = null,
                            tint = DoziTurquoise,
                            modifier = Modifier.size(18.dp)
                        )
                        Text(
                            time,
                            style = MaterialTheme.typography.bodyLarge,
                            fontWeight = FontWeight.Bold,
                            color = DoziTurquoise
                        )
                    }
                }
                Surface(
                    color = DoziCoral.copy(alpha = 0.15f),
                    shape = RoundedCornerShape(12.dp)
                ) {
                    Text(
                        "${medicines.size} ila√ß",
                        modifier = Modifier.padding(horizontal = 12.dp, vertical = 6.dp),
                        style = MaterialTheme.typography.labelLarge,
                        fontWeight = FontWeight.Bold,
                        color = DoziCoral
                    )
                }
            }

            Divider(color = Gray200)

            // ƒ∞la√ß Listesi
            medicines.forEach { (medicine, _) ->
                Card(

                    modifier = Modifier.fillMaxWidth(),

                    colors = CardDefaults.cardColors(containerColor = DoziTurquoise.copy(alpha = 0.05f)),

                    shape = RoundedCornerShape(16.dp),

                    elevation = CardDefaults.cardElevation(0.dp)

                ) {

                    Column(

                        modifier = Modifier

                            .fillMaxWidth()

                            .padding(16.dp),

                        verticalArrangement = Arrangement.spacedBy(12.dp)

                    ) {

                        Row(

                            modifier = Modifier.fillMaxWidth(),

                            horizontalArrangement = Arrangement.spacedBy(12.dp),

                            verticalAlignment = Alignment.CenterVertically

                        ) {

                            Text(

                                medicine.icon,

                                style = MaterialTheme.typography.headlineMedium

                            )

                            Column(modifier = Modifier.weight(1f)) {

                                Text(

                                    medicine.name,

                                    style = MaterialTheme.typography.titleMedium,

                                    fontWeight = FontWeight.Bold,

                                    color = MaterialTheme.colorScheme.onSurface

                                )

                                Text(

                                    medicine.dosage,

                                    style = MaterialTheme.typography.bodyMedium,

                                    color = MaterialTheme.colorScheme.onSurfaceVariant

                                )

                            }

                        }



                        // Butonlar

                        Row(

                            modifier = Modifier.fillMaxWidth(),

                            horizontalArrangement = Arrangement.spacedBy(8.dp)

                        ) {

                            ActionButton(

                                text = "AL",

                                icon = Icons.Default.Check,

                                color = SuccessGreen,

                                modifier = Modifier.weight(1f),

                                onClick = { onTaken(medicine) }

                            )



                            ActionButton(

                                text = "ERTELE",

                                icon = Icons.Default.AccessTime,

                                color = WarningOrange,

                                modifier = Modifier.weight(1f),

                                onClick = onSnooze

                            )
                            ActionButton(

                                text = "ATLA",

                                icon = Icons.Default.Close,

                                color = ErrorRed,

                                modifier = Modifier.weight(1f),

                                onClick = { onSkip(medicine) }
                            )
                        }
                    }
                }
            }
        }
    }
}

// üë• Badi Promotion Card - Kullanƒ±cƒ±larƒ± Badi √∂zelliƒüine y√∂nlendirir
@Composable
private fun BadiPromotionCard(
    onNavigateToBadi: () -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier
            .fillMaxWidth()
            .padding(horizontal = 16.dp)
            .clickable { onNavigateToBadi() },
        shape = RoundedCornerShape(20.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 4.dp),
        colors = CardDefaults.cardColors(containerColor = Color.White)
    ) {
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .background(
                    Brush.horizontalGradient(
                        listOf(DoziTurquoise.copy(alpha = 0.15f), DoziPurple.copy(alpha = 0.15f))
                    )
                )
                .padding(16.dp)
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                // Icon
                Box(
                    modifier = Modifier
                        .size(64.dp)
                        .background(
                            brush = Brush.linearGradient(listOf(DoziTurquoise, DoziPurple)),
                            shape = RoundedCornerShape(16.dp)
                        ),
                    contentAlignment = Alignment.Center
                ) {
                    Icon(
                        imageVector = Icons.Default.People,
                        contentDescription = null,
                        tint = Color.White,
                        modifier = Modifier.size(32.dp)
                    )
                }

                // Text content
                Column(
                    modifier = Modifier.weight(1f),
                    verticalArrangement = Arrangement.spacedBy(4.dp)
                ) {
                    Text(
                        text = "Badi ile Birlikte Takip Et",
                        style = MaterialTheme.typography.titleMedium.copy(
                            fontWeight = FontWeight.Bold,
                            fontSize = 17.sp
                        ),
                        color = Color(0xFF1A237E)
                    )
                    Text(
                        text = "Sevdiklerinle ila√ß takibini payla≈ü, onlar da senin i√ßin hatƒ±rlatsƒ±n!",
                        style = MaterialTheme.typography.bodySmall.copy(fontSize = 13.sp),
                        color = Color(0xFF546E7A),
                        lineHeight = 16.sp
                    )
                }

                // Arrow icon
                Icon(
                    imageVector = Icons.Default.ChevronRight,
                    contentDescription = null,
                    tint = DoziTurquoise,
                    modifier = Modifier.size(28.dp)
                )
            }
        }
    }
}


/**
 * üî• Kompakt Streak Kartƒ± - Yan yana kullanƒ±m i√ßin
 */
@RequiresApi(Build.VERSION_CODES.O)
@Composable
private fun CompactStreakCard(
    context: Context,
    medicines: List<Medicine>,
    onNavigateToStats: () -> Unit,
    modifier: Modifier = Modifier
) {
    val today = getCurrentDateString()
    val takenCount = medicines.sumOf { medicine ->
        medicine.times.count { time ->
            getMedicineStatus(context, medicine.id, today, time) == "taken"
        }
    }
    val totalDoses = medicines.sumOf { it.times.size }

    val prefs = context.getSharedPreferences("dozi_streak", Context.MODE_PRIVATE)
    val currentStreak = prefs.getInt("current_streak", 0)

    // Streak seviyesine g√∂re emoji
    val streakEmoji = when {
        currentStreak == 0 -> "üíß"
        currentStreak in 1..6 -> "üî•"
        currentStreak in 7..29 -> "üî•üî•"
        currentStreak in 30..99 -> "üí™"
        currentStreak in 100..364 -> "üåü"
        else -> "üëë" // 365+ g√ºn
    }

    val streakTitle = when {
        currentStreak == 0 -> "Ba≈üla"
        currentStreak in 1..6 -> "Streak"
        currentStreak in 7..29 -> "G√º√ßl√º"
        currentStreak in 30..99 -> "Harika"
        currentStreak in 100..364 -> "Efsane"
        else -> "Kral"
    }

    Card(
        modifier = modifier
            .fillMaxWidth()
            .padding(horizontal = 12.dp)
            .clickable { onNavigateToStats() }
            .border(1.dp, DoziSecondaryLight, RoundedCornerShape(16.dp)),
        shape = RoundedCornerShape(16.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 0.dp),
        colors = CardDefaults.cardColors(containerColor = Color.White)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .background(
                    Brush.verticalGradient(
                        listOf(DoziSecondary.copy(alpha = 0.1f), DoziSecondary.copy(alpha = 0.05f))
                    )
                )
                .padding(12.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(6.dp)
        ) {
            Text(
                text = streakEmoji,
                style = MaterialTheme.typography.headlineMedium
            )
            Text(
                text = "$currentStreak g√ºn",
                style = MaterialTheme.typography.titleLarge,
                fontWeight = FontWeight.ExtraBold,
                color = DoziSecondary
            )
            Text(
                text = streakTitle,
                style = MaterialTheme.typography.bodySmall,
                color = TextSecondary
            )
        }
    }
}

/**
 * üë• Kompakt Badi Promotion Kartƒ± - Yan yana kullanƒ±m i√ßin
 */
@Composable
private fun CompactBadiPromotionCard(
    onNavigateToBadi: () -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier
            .fillMaxWidth()
            .padding(horizontal = 12.dp)
            .clickable { onNavigateToBadi() }
            .border(1.dp, DoziPrimaryLight, RoundedCornerShape(16.dp)),
        shape = RoundedCornerShape(16.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 0.dp),
        colors = CardDefaults.cardColors(containerColor = Color.White)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .background(
                    Brush.verticalGradient(
                        listOf(DoziPrimary.copy(alpha = 0.1f), DoziPrimary.copy(alpha = 0.05f))
                    )
                )
                .padding(12.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(6.dp)
        ) {
            Icon(
                imageVector = Icons.Default.People,
                contentDescription = null,
                tint = DoziTurquoise,
                modifier = Modifier.size(36.dp)
            )
            Text(
                text = "Badi",
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.Bold,
                color = DoziTurquoise
            )
            Text(
                text = "Birlikte takip et",
                style = MaterialTheme.typography.bodySmall,
                color = TextSecondary,
                textAlign = TextAlign.Center
            )
        }
    }
}

// ============================================================================
// FILE: HomeViewModel.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/home/HomeViewModel.kt
// [75 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.home

import android.content.Context
import android.os.Build
import android.util.Log
import androidx.annotation.RequiresApi
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.bardino.dozi.core.data.model.Medicine
import com.bardino.dozi.core.data.model.User
import com.bardino.dozi.core.data.model.decrementStock
import com.bardino.dozi.core.data.model.daysRemainingInStock
import com.bardino.dozi.core.data.model.isStockLow
import com.bardino.dozi.core.data.model.isStockCritical
import com.bardino.dozi.core.data.model.isStockEmpty
import com.bardino.dozi.core.data.repository.MedicineRepository
import com.bardino.dozi.core.data.repository.MedicationLogRepository
import com.bardino.dozi.core.data.repository.UserRepository
import com.bardino.dozi.core.data.repository.AchievementRepository
import com.bardino.dozi.core.data.repository.UserStatsRepository
import com.bardino.dozi.core.data.repository.UserPreferencesRepository
import com.bardino.dozi.core.utils.EscalationManager
import com.bardino.dozi.notifications.ReminderScheduler
import dagger.hilt.android.lifecycle.HiltViewModel
import dagger.hilt.android.qualifiers.ApplicationContext
import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.flow.catch
import kotlinx.coroutines.flow.update
import kotlinx.coroutines.launch
import java.util.Calendar
import javax.inject.Inject

/**
 * HomeScreen i√ßin ViewModel
 * State management ve business logic burada
 * ‚úÖ Offline-first: MedicationLogRepository kullanƒ±r
 */
@RequiresApi(Build.VERSION_CODES.O)
@HiltViewModel
class HomeViewModel @Inject constructor(
    @ApplicationContext private val context: Context,
    private val medicineRepository: MedicineRepository,
    private val medicationLogRepository: MedicationLogRepository,
    private val userRepository: UserRepository,
    private val achievementRepository: AchievementRepository,
    private val userStatsRepository: UserStatsRepository
) : ViewModel() {

    companion object {
        private const val TAG = "HomeViewModel"
    }

    /**
     * UI State data class
     * T√ºm UI state'leri tek bir yerde
     */
    data class HomeUiState(
        val user: User? = null,
        val isLoggedIn: Boolean = false,
        val todaysMedicines: List<Medicine> = emptyList(),
        val upcomingMedicine: Pair<Medicine, String>? = null,
        val allUpcomingMedicines: List<Pair<Medicine, String>> = emptyList(),
        val currentMedicineStatus: MedicineStatus = MedicineStatus.UPCOMING,
        val snoozeMinutes: Int = 0,
        val lastSnoozeTimestamp: Long = 0L,
        val isLoading: Boolean = true,
        val error: String? = null,
        val showSuccessPopup: Boolean = false,
        val showSkippedPopup: Boolean = false,
        val showSkipDialog: Boolean = false,
        val showSnoozeDialog: Boolean = false
    )

    private val _uiState = MutableStateFlow(HomeUiState())
    val uiState: StateFlow<HomeUiState> = _uiState.asStateFlow()

    init {
        loadData()
        // üî• Medicines Flow'u dinle (polling yerine)
        observeMedicinesFlow()
        loadSnoozeState()
        startSnoozeTimer()
        // üî• FIX: Kritik ila√ß eskalasyonlarƒ±nƒ± kontrol et
        checkEscalations()
    }

    /**
     * üö® Kritik ila√ß eskalasyonlarƒ±nƒ± kontrol et
     * Ka√ßƒ±rƒ±lan kritik ila√ßlar i√ßin buddy'lere bildirim g√∂nder
     */
    private fun checkEscalations() {
        viewModelScope.launch {
            try {
                val escalationManager = EscalationManager(context)
                escalationManager.checkAndEscalate()
                Log.d(TAG, "‚úÖ Escalation check completed")
            } catch (e: Exception) {
                Log.e(TAG, "‚ùå Escalation check failed: ${e.message}", e)
            }
        }
    }

    /**
     * üî• Medicines Flow
     * Automatically reloads when medicines change
     */
    private fun observeMedicinesFlow() {
        viewModelScope.launch {
            medicineRepository.getMedicinesFlow()
                .catch { error ->
                    android.util.Log.e(TAG, "‚ùå Error observing medicines: ${error.message}")
                }
                .collect { medicines ->
                    android.util.Log.d(TAG, "üîÑ Medicines updated: ${medicines.size} medicines")
                    updateMedicinesState(medicines)
                }
        }
    }

    /**
     * Medicines state'ini g√ºncelle
     */
    @RequiresApi(Build.VERSION_CODES.O)
    private suspend fun updateMedicinesState(allMedicines: List<Medicine>) {
        try {
            // ‚úÖ Bug√ºn√ºn tarihini al
            val today = java.time.LocalDate.now()
            val todayMillis = System.currentTimeMillis()

            // ‚úÖ Bug√ºn i√ßin ge√ßerli olan ila√ßlarƒ± filtrele
            val todaysMeds = allMedicines.filter { medicine ->
                // Hatƒ±rlatma aktif mi ve tarih aralƒ±ƒüƒ±nda mƒ±?
                if (!medicine.reminderEnabled) return@filter false
                if (medicine.startDate > todayMillis) return@filter false
                if (medicine.endDate != null && medicine.endDate < todayMillis) return@filter false

                // shouldMedicineShowOnDate() mantƒ±ƒüƒ±nƒ± kullan
                shouldMedicineShowOnDate(medicine, today)
            }

            val upcoming = todaysMeds.flatMap { medicine ->
                medicine.times.map { time -> Pair(medicine, time) }
            }.filter { (medicine, time) ->
                val (hour, minute) = time.split(":").map { it.toInt() }
                val currentHour = java.time.LocalTime.now().hour
                val currentMinute = java.time.LocalTime.now().minute
                val medicineTime = hour * 60 + minute
                val currentTime = currentHour * 60 + currentMinute
                medicineTime >= currentTime
            }.sortedBy { it.second }

            _uiState.update {
                it.copy(
                    todaysMedicines = todaysMeds,
                    allUpcomingMedicines = upcoming,
                    upcomingMedicine = upcoming.firstOrNull()
                )
            }
        } catch (e: Exception) {
            android.util.Log.e(TAG, "Error updating medicines state: ${e.message}")
        }
    }

    /**
     * Helper: Get current day name in Turkish
     */
    @RequiresApi(Build.VERSION_CODES.O)
    private fun getCurrentDayName(): String {
        val dayOfWeek = java.time.LocalDate.now().dayOfWeek.value
        return when (dayOfWeek) {
            1 -> "Pazartesi"
            2 -> "Salƒ±"
            3 -> "√áar≈üamba"
            4 -> "Per≈üembe"
            5 -> "Cuma"
            6 -> "Cumartesi"
            7 -> "Pazar"
            else -> ""
        }
    }

    /**
     * Helper: Belirli bir tarihte ilacƒ±n g√∂sterilip g√∂sterilmeyeceƒüini kontrol eder
     */
    @RequiresApi(Build.VERSION_CODES.O)
    private fun shouldMedicineShowOnDate(medicine: Medicine, date: java.time.LocalDate): Boolean {
        // startDate kontrol√º
        val startLocalDate = java.time.Instant.ofEpochMilli(medicine.startDate)
            .atZone(java.time.ZoneId.systemDefault())
            .toLocalDate()

        if (date.isBefore(startLocalDate)) {
            return false // Ba≈ülangƒ±√ß tarihinden √∂nce g√∂sterme
        }

        // endDate kontrol√º
        if (medicine.endDate != null) {
            val endLocalDate = java.time.Instant.ofEpochMilli(medicine.endDate!!)
                .atZone(java.time.ZoneId.systemDefault())
                .toLocalDate()
            if (date.isAfter(endLocalDate)) {
                return false // Biti≈ü tarihinden sonra g√∂sterme
            }
        }

        when (medicine.frequency) {
            "Her g√ºn" -> return true

            "G√ºn a≈üƒ±rƒ±" -> {
                // Ba≈ülangƒ±√ß g√ºn√ºnden itibaren g√ºn a≈üƒ±rƒ±: g√ºn 0 (al), g√ºn 1 (alma), g√ºn 2 (al), ...
                val daysSinceStart = java.time.temporal.ChronoUnit.DAYS.between(startLocalDate, date)
                return daysSinceStart % 2 == 0L
            }

            "Haftada bir" -> {
                // Ba≈ülangƒ±√ß tarihinin haftanƒ±n g√ºn√º ile aynƒ± g√ºnlerde al
                return startLocalDate.dayOfWeek == date.dayOfWeek
            }

            "15 g√ºnde bir" -> {
                // Her 15 g√ºnde bir: g√ºn 0, 15, 30, 45, ...
                val daysSinceStart = java.time.temporal.ChronoUnit.DAYS.between(startLocalDate, date)
                return daysSinceStart % 15 == 0L
            }

            "Ayda bir" -> {
                // Her 30 g√ºnde bir: g√ºn 0, 30, 60, 90, ...
                val daysSinceStart = java.time.temporal.ChronoUnit.DAYS.between(startLocalDate, date)
                return daysSinceStart % 30 == 0L
            }

            "Her X g√ºnde bir" -> {
                // Her X g√ºnde bir: g√ºn 0, X, 2X, 3X, ...
                val daysSinceStart = java.time.temporal.ChronoUnit.DAYS.between(startLocalDate, date)
                return daysSinceStart % medicine.frequencyValue.toLong() == 0L
            }

            "ƒ∞stediƒüim tarihlerde" -> {
                // Kullanƒ±cƒ±nƒ±n se√ßtiƒüi √∂zel tarihlerde
                val dateString = "%02d/%02d/%d".format(date.dayOfMonth, date.monthValue, date.year)
                return medicine.days.contains(dateString)
            }

            else -> return false
        }
    }

    /**
     * Kullanƒ±cƒ± ve ila√ß verilerini y√ºkle
     */
    private fun loadData() {
        viewModelScope.launch {
            try {
                // Kullanƒ±cƒ± verilerini √ßek
                val userData = userRepository.getUserData()
                val isLoggedIn = userData != null
                _uiState.update { it.copy(user = userData, isLoggedIn = isLoggedIn) }

                // ƒ∞la√ß verilerini √ßek (sadece login olduysa)
                if (isLoggedIn) {
                    refreshMedicines(null)
                }

                _uiState.update { it.copy(isLoading = false) }
            } catch (e: Exception) {
                _uiState.update {
                    it.copy(
                        error = e.message ?: "Bilinmeyen hata",
                        isLoading = false
                    )
                }
            }
        }
    }

    /**
     * Periyodik veri g√ºncellemesi (Firebase i√ßin polling)
     */
    private fun startPollingData() {
        viewModelScope.launch {
            while (true) {
                try {
                    // Kullanƒ±cƒ± verilerini g√ºncelle
                    val userData = userRepository.getUserData()
                    val isLoggedIn = userData != null
                    _uiState.update { it.copy(user = userData, isLoggedIn = isLoggedIn) }
                } catch (e: Exception) {
                    // Sessizce devam et
                }
                delay(2000) // Her 2 saniyede bir
            }
        }

        viewModelScope.launch {
            while (true) {
                try {
                    // ƒ∞la√ß verilerini g√ºncelle (sadece context varsa)
                    // Not: Context lazy olarak verilecek
                } catch (e: Exception) {
                    // Sessizce devam et
                }
                delay(3000) // Her 3 saniyede bir
            }
        }
    }

    /**
     * ƒ∞la√ßlarƒ± yenile
     */
    fun refreshMedicines(context: Context?) {
        viewModelScope.launch {
            try {
                val todaysMeds = medicineRepository.getTodaysMedicines()
                _uiState.update { it.copy(todaysMedicines = todaysMeds) }

                // Context varsa upcoming ila√ßlarƒ± da √ßek
                context?.let { ctx ->
                    val upcoming = medicineRepository.getUpcomingMedicines(ctx)
                    _uiState.update {
                        it.copy(
                            allUpcomingMedicines = upcoming,
                            upcomingMedicine = upcoming.firstOrNull()
                        )
                    }
                }
            } catch (e: Exception) {
                _uiState.update { it.copy(error = e.message) }
            }
        }
    }

    /**
     * Snooze state'ini SharedPreferences'tan y√ºkle
     */
    private fun loadSnoozeState() {
        // Not: Context gerekli, HomeScreen'den √ßaƒürƒ±lacak
    }

    fun loadSnoozeStateFromContext(context: Context) {
        viewModelScope.launch {
            val prefs = context.getSharedPreferences("dozi_prefs", Context.MODE_PRIVATE)
            val snoozeUntil = prefs.getLong("snooze_until", 0)
            val timestamp = prefs.getLong("snooze_timestamp", 0)

            if (snoozeUntil > System.currentTimeMillis()) {
                val remainingMillis = snoozeUntil - System.currentTimeMillis()
                val remainingMinutes = (remainingMillis / 60_000).toInt() + 1
                _uiState.update {
                    it.copy(
                        snoozeMinutes = remainingMinutes,
                        lastSnoozeTimestamp = timestamp
                    )
                }
            } else if (snoozeUntil > 0) {
                // S√ºresi dolmu≈ü, temizle
                prefs.edit()
                    .remove("snooze_minutes")
                    .remove("snooze_until")
                    .remove("snooze_timestamp")
                    .apply()
            }
        }
    }

    /**
     * Snooze timer'ƒ± ba≈ülat
     */
    private fun startSnoozeTimer() {
        // Not: Context gerekli, HomeScreen'den √ßaƒürƒ±lacak
    }

    fun startSnoozeTimerWithContext(context: Context) {
        viewModelScope.launch {
            while (true) {
                delay(1000)
                val prefs = context.getSharedPreferences("dozi_prefs", Context.MODE_PRIVATE)
                val snoozeUntil = prefs.getLong("snooze_until", 0)
                val timestamp = prefs.getLong("snooze_timestamp", 0)

                val currentState = _uiState.value

                if (timestamp > currentState.lastSnoozeTimestamp && snoozeUntil > System.currentTimeMillis()) {
                    val remainingMillis = snoozeUntil - System.currentTimeMillis()
                    val remainingMinutes = (remainingMillis / 60_000).toInt() + 1
                    _uiState.update {
                        it.copy(
                            snoozeMinutes = remainingMinutes,
                            lastSnoozeTimestamp = timestamp
                        )
                    }
                } else if (snoozeUntil > 0 && snoozeUntil <= System.currentTimeMillis()) {
                    _uiState.update {
                        it.copy(
                            snoozeMinutes = 0,
                            lastSnoozeTimestamp = 0
                        )
                    }
                    prefs.edit()
                        .remove("snooze_minutes")
                        .remove("snooze_until")
                        .remove("snooze_timestamp")
                        .apply()
                }
            }
        }
    }

    /**
     * ƒ∞la√ß alƒ±ndƒ± (Offline-first)
     * 1. Local DB'ye kaydet
     * 2. Firestore'a sync et
     * 3. Stok azalt
     */
    fun onMedicineTaken(context: Context, medicine: Medicine, time: String) {
        viewModelScope.launch {
            _uiState.update { it.copy(currentMedicineStatus = MedicineStatus.TAKEN) }

            // ‚úÖ Offline-first: MedicationLogRepository kullan
            try {
                val scheduledTime = getScheduledTimeInMillis(time)
                medicationLogRepository.logMedicationTaken(
                    medicineId = medicine.id,
                    medicineName = medicine.name,
                    dosage = medicine.dosage,
                    scheduledTime = scheduledTime,
                    notes = null
                ).onSuccess {
                    Log.d(TAG, "‚úÖ Medication logged to Room DB and queued for sync")
                }.onFailure {
                    Log.e(TAG, "‚ùå Failed to log medication", it)
                }

                // ‚ö†Ô∏è Fallback: SharedPreferences i√ßin backward compatibility
                saveMedicineStatus(context, medicine.id, getCurrentDateString(), time, "taken")
            } catch (e: Exception) {
                Log.e(TAG, "‚ùå Error logging medication taken", e)
            }

            // üì¶ Stok azalt (extension function kullan)
            if (medicine.autoDecrementEnabled && medicine.stockCount > 0) {
                try {
                    val updatedMedicine = medicine.decrementStock()
                    medicineRepository.updateMedicineField(medicine.id, "stockCount", updatedMedicine.stockCount)
                    Log.d(TAG, "üì¶ Stock decreased: ${medicine.name} -> ${updatedMedicine.stockCount} (${updatedMedicine.daysRemainingInStock()} days remaining)")

                    // ‚ö†Ô∏è Stok uyarƒ±larƒ± kontrol et
                    checkStockWarnings(context, updatedMedicine)
                } catch (e: Exception) {
                    Log.e(TAG, "Failed to decrease stock", e)
                }
            } else if (medicine.stockCount == 0) {
                // üö® Stok bitti uyarƒ±sƒ±
                showOutOfStockNotification(context, medicine)
            }

            // üèÜ Achievement kontrol√º
            checkAchievementsAfterMedicineTaken()

            // üìä UserStats g√ºncelle (streak, compliance, etc.)
            userStatsRepository.onMedicationTaken(medicationLogRepository)

            // üö´ Escalation alarmlarƒ±nƒ± iptal et
            cancelEscalationAlarms(context, medicine.id, time)

            // üî• FIX: Ana hatƒ±rlatma alarmƒ±nƒ± iptal et
            // Bu olmadan, ilacƒ± uygulamadan aldƒ±m i≈üaretlesen bile saatinde bildirim gelir
            ReminderScheduler.cancelReminders(context, medicine.id, listOf(time))

            // üö´ T√ºm bildirimleri iptal et (notification drawer'dan temizle)
            com.bardino.dozi.notifications.NotificationHelper.cancelAllNotificationsForMedicine(
                context, medicine.id, time
            )

            // Success popup g√∂ster
            _uiState.update { it.copy(showSuccessPopup = true) }

            // Listeyi g√ºncelle
            delay(100)
            val updated = medicineRepository.getUpcomingMedicines(context)
            _uiState.update {
                it.copy(
                    allUpcomingMedicines = updated,
                    upcomingMedicine = updated.firstOrNull(),
                    currentMedicineStatus = if (updated.isNotEmpty()) MedicineStatus.UPCOMING else MedicineStatus.TAKEN
                )
            }

            // Popup'ƒ± kapat
            delay(1500)
            _uiState.update { it.copy(showSuccessPopup = false) }
        }
    }

    /**
     * ƒ∞la√ß atlandƒ± (Offline-first)
     */
    fun onMedicineSkipped(context: Context, medicine: Medicine, time: String) {
        viewModelScope.launch {
            _uiState.update {
                it.copy(
                    currentMedicineStatus = MedicineStatus.SKIPPED,
                    showSkipDialog = false,
                    showSkippedPopup = true
                )
            }

            // ‚úÖ Offline-first: MedicationLogRepository kullan
            try {
                val scheduledTime = getScheduledTimeInMillis(time)
                medicationLogRepository.logMedicationSkipped(
                    medicineId = medicine.id,
                    medicineName = medicine.name,
                    dosage = medicine.dosage,
                    scheduledTime = scheduledTime,
                    reason = null
                ).onSuccess {
                    Log.d(TAG, "‚úÖ Medication skipped logged to Room DB")
                }.onFailure {
                    Log.e(TAG, "‚ùå Failed to log skipped medication", it)
                }

                // ‚ö†Ô∏è Fallback: SharedPreferences i√ßin backward compatibility
                saveMedicineStatus(context, medicine.id, getCurrentDateString(), time, "skipped")
            } catch (e: Exception) {
                Log.e(TAG, "‚ùå Error logging medication skipped", e)
            }

            // üö´ Escalation alarmlarƒ±nƒ± iptal et
            cancelEscalationAlarms(context, medicine.id, time)

            // üö´ T√ºm bildirimleri iptal et (notification drawer'dan temizle)
            com.bardino.dozi.notifications.NotificationHelper.cancelAllNotificationsForMedicine(
                context, medicine.id, time
            )

            // Listeyi g√ºncelle
            delay(100)
            val updated = medicineRepository.getUpcomingMedicines(context)
            _uiState.update {
                it.copy(
                    allUpcomingMedicines = updated,
                    upcomingMedicine = updated.firstOrNull(),
                    currentMedicineStatus = if (updated.isNotEmpty()) MedicineStatus.UPCOMING else MedicineStatus.SKIPPED
                )
            }

            // Popup'ƒ± kapat
            delay(1500)
            _uiState.update { it.copy(showSkippedPopup = false) }
        }
    }

    /**
     * ƒ∞la√ß ertelendi (Offline-first)
     */
    fun onMedicineSnoozed(context: Context, medicine: Medicine, time: String, minutes: Int) {
        viewModelScope.launch {
            _uiState.update {
                it.copy(
                    snoozeMinutes = minutes,
                    showSnoozeDialog = false
                )
            }

            // ‚úÖ Offline-first: MedicationLogRepository kullan
            try {
                val scheduledTime = getScheduledTimeInMillis(time)
                medicationLogRepository.logMedicationSnoozed(
                    medicineId = medicine.id,
                    medicineName = medicine.name,
                    dosage = medicine.dosage,
                    scheduledTime = scheduledTime,
                    snoozeMinutes = minutes
                ).onSuccess {
                    Log.d(TAG, "‚úÖ Medication snoozed logged to Room DB")
                }.onFailure {
                    Log.e(TAG, "‚ùå Failed to log snoozed medication", it)
                }

                // ‚ö†Ô∏è Fallback: SharedPreferences i√ßin backward compatibility
                val snoozeUntil = System.currentTimeMillis() + minutes * 60_000L
                saveMedicineStatus(context, medicine.id, getCurrentDateString(), time, "snoozed_$snoozeUntil")
            } catch (e: Exception) {
                Log.e(TAG, "‚ùå Error logging medication snoozed", e)
            }
        }
    }

    /**
     * Dialog a√ßma/kapama
     */
    fun setShowSkipDialog(show: Boolean) {
        _uiState.update { it.copy(showSkipDialog = show) }
    }

    fun setShowSnoozeDialog(show: Boolean) {
        _uiState.update { it.copy(showSnoozeDialog = show) }
    }

    /**
     * Helper: Medicine status kaydet
     */
    private fun saveMedicineStatus(context: Context, medicineId: String, date: String, time: String, status: String) {
        val prefs = context.getSharedPreferences("medicine_status", Context.MODE_PRIVATE)
        val key = "dose_${medicineId}_${date}_${time}"
        prefs.edit().putString(key, status).commit()
        android.util.Log.d("HomeViewModel", "Status saved: $key = $status")
    }

    /**
     * Helper: Tarih string'i
     */
    private fun getCurrentDateString(): String {
        val calendar = java.util.Calendar.getInstance()
        val day = calendar.get(java.util.Calendar.DAY_OF_MONTH)
        val month = calendar.get(java.util.Calendar.MONTH) + 1
        val year = calendar.get(java.util.Calendar.YEAR)
        return "%02d/%02d/%d".format(day, month, year)
    }

    /**
     * Helper: Time string'i (HH:mm) epoch millis'e √ßevir
     * √ñrn: "08:00" -> bug√ºn√ºn 08:00'i i√ßin epoch millis
     */
    private fun getScheduledTimeInMillis(time: String): Long {
        return try {
            val parts = time.split(":")
            val hour = parts.getOrNull(0)?.toIntOrNull() ?: 0
            val minute = parts.getOrNull(1)?.toIntOrNull() ?: 0

            val calendar = Calendar.getInstance()
            calendar.set(Calendar.HOUR_OF_DAY, hour)
            calendar.set(Calendar.MINUTE, minute)
            calendar.set(Calendar.SECOND, 0)
            calendar.set(Calendar.MILLISECOND, 0)

            calendar.timeInMillis
        } catch (e: Exception) {
            Log.e(TAG, "Error parsing time: $time", e)
            System.currentTimeMillis()
        }
    }

    /**
     * Stok uyarƒ±larƒ±nƒ± kontrol et
     */
    /**
     * Stok uyarƒ±larƒ±nƒ± kontrol et (Extension fonksiyonlar kullan)
     * 24 saat i√ßinde aynƒ± ila√ß i√ßin tekrar bildirim g√∂ndermez
     */
    private fun checkStockWarnings(context: Context, medicine: Medicine) {
        val prefs = context.getSharedPreferences("stock_warnings", Context.MODE_PRIVATE)
        val lastWarningKey = "last_warning_${medicine.id}"
        val lastWarningTime = prefs.getLong(lastWarningKey, 0)
        val currentTime = System.currentTimeMillis()
        val twentyFourHours = 24 * 60 * 60 * 1000L

        // Stok yeterli seviyedeyse, uyarƒ± timestamp'ini temizle
        if (!medicine.isStockLow() && !medicine.isStockCritical() && !medicine.isStockEmpty()) {
            if (lastWarningTime > 0) {
                prefs.edit().remove(lastWarningKey).apply()
                Log.d(TAG, "‚úÖ Stok yeterli seviyede, uyarƒ± sƒ±fƒ±rlandƒ±: ${medicine.name}")
            }
            return
        }

        // Son 24 saat i√ßinde bildirim g√∂nderildiyse, tekrar g√∂nderme
        if (currentTime - lastWarningTime < twentyFourHours) {
            Log.d(TAG, "‚è±Ô∏è Stok uyarƒ±sƒ± son 24 saat i√ßinde g√∂nderildi, atlanƒ±yor: ${medicine.name}")
            return
        }

        when {
            medicine.isStockEmpty() -> {
                // üö® Stok bitti
                showOutOfStockNotification(context, medicine)
                Log.w(TAG, "‚ö†Ô∏è STOK Bƒ∞TTƒ∞: ${medicine.name}")
                // Son uyarƒ± zamanƒ±nƒ± kaydet
                prefs.edit().putLong(lastWarningKey, currentTime).apply()
                // ‚úÖ Firebase'e senkronize et
                syncStockWarningToFirebase(medicine.id, currentTime)
            }
            medicine.isStockCritical() -> {
                // üî¥ Kritik seviye (3 g√ºn kaldƒ±)
                showLowStockNotification(context, medicine)
                Log.w(TAG, "üî¥ KRƒ∞Tƒ∞K STOK: ${medicine.name} - ${medicine.daysRemainingInStock()} g√ºn kaldƒ±")
                // Son uyarƒ± zamanƒ±nƒ± kaydet
                prefs.edit().putLong(lastWarningKey, currentTime).apply()
                // ‚úÖ Firebase'e senkronize et
                syncStockWarningToFirebase(medicine.id, currentTime)
            }
            medicine.isStockLow() -> {
                // üü° D√º≈ü√ºk stok (threshold'a g√∂re)
                showLowStockNotification(context, medicine)
                Log.w(TAG, "üü° D√ú≈û√úK STOK: ${medicine.name} - ${medicine.daysRemainingInStock()} g√ºn kaldƒ± (${medicine.stockCount} doz)")
                // Son uyarƒ± zamanƒ±nƒ± kaydet
                prefs.edit().putLong(lastWarningKey, currentTime).apply()
                // ‚úÖ Firebase'e senkronize et
                syncStockWarningToFirebase(medicine.id, currentTime)
            }
        }
    }

    /**
     * Stock warning'i Firebase'e senkronize et
     */
    private fun syncStockWarningToFirebase(medicineId: String, lastWarningTime: Long) {
        viewModelScope.launch {
            try {
                val userPrefsRepo = UserPreferencesRepository(context)
                userPrefsRepo.syncStockWarning(medicineId, lastWarningTime)
            } catch (e: Exception) {
                Log.e(TAG, "‚ùå Stock warning Firebase'e senkronize edilemedi", e)
            }
        }
    }

    /**
     * Stok uyarƒ±sƒ±nƒ± manuel olarak sƒ±fƒ±rla (stok eklendiƒüinde kullan)
     */
    fun resetStockWarning(medicineId: String) {
        val prefs = context.getSharedPreferences("stock_warnings", Context.MODE_PRIVATE)
        prefs.edit().remove("last_warning_$medicineId").apply()
        Log.d(TAG, "üîÑ Stok uyarƒ±sƒ± manuel olarak sƒ±fƒ±rlandƒ±: $medicineId")
    }

    /**
     * üö´ Escalation alarmlarƒ±nƒ± iptal et (ila√ß alƒ±ndƒ±ƒüƒ±nda)
     */
    private fun cancelEscalationAlarms(context: Context, medicineId: String, time: String) {
        try {
            val alarmManager = context.getSystemService(Context.ALARM_SERVICE) as android.app.AlarmManager

            // Escalation 1, 2, 3 alarmlarƒ±nƒ± iptal et
            listOf(
                Triple("ACTION_ESCALATION_1", "escalation1", 1),
                Triple("ACTION_ESCALATION_2", "escalation2", 2),
                Triple("ACTION_ESCALATION_3", "escalation3", 3)
            ).forEach { (action, escalationType, level) ->
                val intent = android.content.Intent(context, Class.forName("com.bardino.dozi.notifications.NotificationActionReceiver")).apply {
                    this.action = action
                }
                val requestCode = "${escalationType}_${medicineId}_$time".hashCode()
                val pendingIntent = android.app.PendingIntent.getBroadcast(
                    context,
                    requestCode,
                    intent,
                    if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.S) {
                        android.app.PendingIntent.FLAG_NO_CREATE or android.app.PendingIntent.FLAG_IMMUTABLE
                    } else {
                        android.app.PendingIntent.FLAG_NO_CREATE
                    }
                )
                if (pendingIntent != null) {
                    alarmManager.cancel(pendingIntent)
                    pendingIntent.cancel()
                    Log.d(TAG, "‚úÖ Escalation Level $level iptal edildi: $medicineId")
                }
            }
            Log.d(TAG, "üö´ T√ºm escalation alarmlarƒ± iptal edildi (HomeViewModel): $medicineId - $time")
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Escalation alarmlarƒ± iptal edilirken hata", e)
        }
    }

    /**
     * D√º≈ü√ºk stok bildirimi g√∂ster
     */
    private fun showLowStockNotification(context: Context, medicine: Medicine) {
        try {
            val notificationHelper = Class.forName("com.bardino.dozi.notifications.NotificationHelper")
            val method = notificationHelper.getDeclaredMethod(
                "showLowStockNotification",
                Context::class.java,
                String::class.java,
                Int::class.java
            )
            method.invoke(null, context, medicine.name, medicine.stockCount)
        } catch (e: Exception) {
            Log.e(TAG, "Failed to show low stock notification", e)
        }
    }

    /**
     * Stok bitti bildirimi g√∂ster
     */
    private fun showOutOfStockNotification(context: Context, medicine: Medicine) {
        try {
            val notificationHelper = Class.forName("com.bardino.dozi.notifications.NotificationHelper")
            val method = notificationHelper.getDeclaredMethod(
                "showOutOfStockNotification",
                Context::class.java,
                String::class.java
            )
            method.invoke(null, context, medicine.name)
        } catch (e: Exception) {
            Log.e(TAG, "Failed to show out of stock notification", e)
        }
    }

    /**
     * üèÜ ƒ∞la√ß alƒ±ndƒ±ktan sonra ba≈üarƒ±larƒ± kontrol et
     */
    private fun checkAchievementsAfterMedicineTaken() {
        viewModelScope.launch {
            try {
                // UserStats'ƒ± getir
                val userStats = userStatsRepository.getUserStats() ?: return@launch

                // T√ºm ila√ßlarƒ± ve loglarƒ± al
                val allMedicines = medicineRepository.getAllMedicines()
                val totalMedicines = allMedicines.size

                Log.d(TAG, "üèÜ Checking achievements: streak=${userStats.currentStreak}, totalDoses=${userStats.totalMedicationsTaken}, medicines=$totalMedicines")

                // üî• Streak achievements
                achievementRepository.checkStreakAchievements(userStats.currentStreak)

                // üèÖ First step achievements
                // Note: hasTakenDose = true because we just took a dose (stats not yet updated)
                achievementRepository.checkFirstStepAchievements(
                    hasMedicine = totalMedicines > 0,
                    hasTakenDose = true
                )

                // üìö Medicine collector achievements
                achievementRepository.checkMedicineCollectorAchievements(totalMedicines)

                // üíØ Total doses achievements
                achievementRepository.checkTotalDosesAchievements(userStats.totalMedicationsTaken)

                // üéØ Perfect compliance achievements (TODO: calculate consecutive perfect days)
                // achievementRepository.checkPerfectComplianceAchievements(consecutivePerfectDays)

                Log.d(TAG, "‚úÖ Achievement check completed")
            } catch (e: Exception) {
                Log.e(TAG, "‚ùå Error checking achievements", e)
            }
        }
    }
}

enum class MedicineStatus {
    TAKEN, SKIPPED, PARTIAL, PLANNED, UPCOMING, NONE
}

// ============================================================================
// FILE: LoginScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/login/LoginScreen.kt
// [76 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.login

import android.app.Activity
import android.content.Intent
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.animation.AnimatedVisibility
import androidx.compose.animation.fadeIn
import androidx.compose.animation.fadeOut
import androidx.compose.animation.slideInVertically
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.alpha
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.google.android.gms.auth.api.signin.GoogleSignIn
import com.google.android.gms.auth.api.signin.GoogleSignInOptions
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.auth.GoogleAuthProvider
import com.bardino.dozi.R
import com.bardino.dozi.core.data.repository.UserRepository
import com.bardino.dozi.core.ui.theme.*
import kotlinx.coroutines.delay
import kotlinx.coroutines.launch

@Composable
fun LoginScreen(
    onLoginSuccess: () -> Unit,
    onSkip: (() -> Unit)? = null
) {
    val context = androidx.compose.ui.platform.LocalContext.current
    val auth = FirebaseAuth.getInstance()
    val repo = UserRepository()
    val scope = rememberCoroutineScope()

    var isLoading by remember { mutableStateOf(false) }
    var showContent by remember { mutableStateOf(false) }

    // Animasyon i√ßin
    LaunchedEffect(Unit) {
        delay(200)
        showContent = true
    }

    val launcher = rememberLauncherForActivityResult(ActivityResultContracts.StartActivityForResult()) { result ->
        if (result.resultCode == Activity.RESULT_OK) {
            val task = GoogleSignIn.getSignedInAccountFromIntent(result.data)
            val account = task.result
            val credential = GoogleAuthProvider.getCredential(account.idToken, null)
            isLoading = true
            auth.signInWithCredential(credential).addOnSuccessListener {
                scope.launch {
                    repo.createUserIfNotExists()
                    isLoading = false
                    onLoginSuccess()
                }
            }.addOnFailureListener {
                isLoading = false
            }
        } else {
            isLoading = false
        }
    }

    val googleSignInClient = GoogleSignIn.getClient(
        context,
        GoogleSignInOptions.Builder(GoogleSignInOptions.DEFAULT_SIGN_IN)
            .requestIdToken(context.getString(R.string.default_web_client_id))
            .requestEmail()
            .build()
    )

    // Surface ile bottombar'ƒ±n √ºzerine √ßƒ±kmasƒ± i√ßin
    Surface(
        modifier = Modifier.fillMaxSize(),
        color = Color.Transparent
    ) {
        Box(
            modifier = Modifier
                .fillMaxSize()
                .background(
                    brush = Brush.verticalGradient(
                        colors = listOf(
                            DoziTurquoise,
                            DoziTurquoiseDark,
                            DoziTurquoiseDark.copy(alpha = 0.9f)
                        )
                    )
                ),
            contentAlignment = Alignment.Center
        ) {
        AnimatedVisibility(
            visible = showContent,
            enter = fadeIn() + slideInVertically(initialOffsetY = { it / 2 }),
            exit = fadeOut()
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(32.dp),
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(24.dp)
            ) {
                // Dozi Logo
                Surface(
                    modifier = Modifier.size(120.dp),
                    shape = RoundedCornerShape(30.dp),
                    color = Color.White,
                    tonalElevation = 8.dp
                ) {
                    Image(
                        painter = painterResource(R.drawable.dozi_hosgeldin),
                        contentDescription = "Dozi Logo",
                        modifier = Modifier
                            .fillMaxSize()
                            .padding(18.dp)
                    )
                }

                Spacer(modifier = Modifier.height(8.dp))

                // Ba≈ülƒ±k
                Text(
                    text = "Dozi'ye Ho≈ü Geldin!",
                    style = MaterialTheme.typography.headlineMedium,
                    fontWeight = FontWeight.Bold,
                    color = Color.White,
                    textAlign = TextAlign.Center
                )

                // Alt Ba≈ülƒ±k
                Text(
                    text = "ƒ∞la√ß takibini kolayla≈ütƒ±r,\nsaƒülƒ±ƒüƒ±nƒ± kontrol altƒ±nda tut",
                    style = MaterialTheme.typography.bodyLarge,
                    color = Color.White.copy(alpha = 0.9f),
                    textAlign = TextAlign.Center,
                    lineHeight = 24.sp
                )

                Spacer(modifier = Modifier.height(24.dp))

                // Google Sign-In Butonu
                Button(
                    onClick = {
                        if (!isLoading) {
                            googleSignInClient.signOut().addOnCompleteListener {
                                launcher.launch(googleSignInClient.signInIntent)
                            }
                        }
                    },
                    modifier = Modifier
                        .fillMaxWidth(0.85f)
                        .height(56.dp),
                    shape = RoundedCornerShape(16.dp),
                    colors = ButtonDefaults.buttonColors(
                        containerColor = Color.White,
                        contentColor = Color.Black
                    ),
                    elevation = ButtonDefaults.buttonElevation(
                        defaultElevation = 4.dp,
                        pressedElevation = 8.dp
                    ),
                    enabled = !isLoading
                ) {
                    if (isLoading) {
                        CircularProgressIndicator(
                            modifier = Modifier.size(24.dp),
                            color = DoziTurquoise,
                            strokeWidth = 3.dp
                        )
                    } else {
                        Row(
                            verticalAlignment = Alignment.CenterVertically,
                            horizontalArrangement = Arrangement.Center
                        ) {
                            Image(
                                painter = painterResource(id = R.drawable.ic_google),
                                contentDescription = "Google logo",
                                modifier = Modifier.size(24.dp)
                            )
                            Spacer(modifier = Modifier.width(12.dp))
                            Text(
                                text = "Google ile Giri≈ü Yap",
                                style = MaterialTheme.typography.bodyLarge,
                                fontWeight = FontWeight.SemiBold
                            )
                        }
                    }
                }

                // Skip Button (Daha Sonra)
                if (onSkip != null) {
                    Spacer(modifier = Modifier.height(16.dp))
                    TextButton(
                        onClick = onSkip,
                        modifier = Modifier.fillMaxWidth(0.85f),
                        enabled = !isLoading
                    ) {
                        Text(
                            text = "Daha Sonra",
                            color = Color.White,
                            style = MaterialTheme.typography.bodyLarge,
                            fontWeight = FontWeight.Medium
                        )
                    }
                }

                Spacer(modifier = Modifier.height(40.dp))

                // √ñzellikler
                Column(
                    modifier = Modifier.alpha(0.9f),
                    verticalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    FeatureItem(
                        icon = Icons.Default.Notifications,
                        text = "Zamanƒ±nda hatƒ±rlatmalar"
                    )
                    FeatureItem(
                        icon = Icons.Default.MedicalServices,
                        text = "ƒ∞la√ß takibi ve y√∂netimi"
                    )
                    FeatureItem(
                        icon = Icons.Default.CloudSync,
                        text = "T√ºm cihazlarƒ±nda senkronize"
                    )
                }
            }
        }
        }
    }
}

@Composable
private fun FeatureItem(icon: androidx.compose.ui.graphics.vector.ImageVector, text: String) {
    Row(
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.spacedBy(12.dp)
    ) {
        Icon(
            imageVector = icon,
            contentDescription = null,
            tint = Color.White,
            modifier = Modifier.size(20.dp)
        )
        Text(
            text = text,
            style = MaterialTheme.typography.bodyMedium,
            color = Color.White,
            fontWeight = FontWeight.Medium
        )
    }
}

// ============================================================================
// FILE: MedicationActionScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/medication/MedicationActionScreen.kt
// [77 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.medication

import android.content.Context
import android.os.Build
import androidx.annotation.RequiresApi
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.bardino.dozi.core.data.model.Medicine
import com.bardino.dozi.core.data.repository.MedicineRepository
import com.bardino.dozi.core.utils.saveMedicineStatus
import com.bardino.dozi.core.utils.getCurrentDateString
import com.bardino.dozi.core.ui.theme.*
import com.bardino.dozi.core.utils.SoundHelper
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch

/**
 * Medication Action Screen
 * Bu ekran sadece bildirimden a√ßƒ±lƒ±r ve aynƒ± saatteki t√ºm ila√ßlarƒ± g√∂sterir
 * Kullanƒ±cƒ± her ila√ß i√ßin ayrƒ± ayrƒ± i≈ülem yapabilir (Al, Atla, Ertele)
 */
@RequiresApi(Build.VERSION_CODES.O)
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MedicationActionScreen(
    time: String,
    onNavigateBack: () -> Unit
) {
    val context = LocalContext.current
    val medicineRepository = remember { MedicineRepository() }
    var medicines by remember { mutableStateOf<List<Medicine>>(emptyList()) }
    var completedMedicines by remember { mutableStateOf<Set<String>>(emptySet()) }
    var isLoading by remember { mutableStateOf(true) }

    // Aynƒ± saatteki ila√ßlarƒ± y√ºkle
    LaunchedEffect(time) {
        try {
            val allMedicines = medicineRepository.getAllMedicines()
            val filteredMedicines = allMedicines.filter { medicine ->
                medicine.times.contains(time) && medicine.reminderEnabled
            }
            medicines = filteredMedicines
            isLoading = false
        } catch (e: Exception) {
            e.printStackTrace()
            isLoading = false
        }
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Column {
                        Text(
                            "ƒ∞la√ß Zamanƒ±",
                            style = MaterialTheme.typography.titleLarge,
                            fontWeight = FontWeight.Bold
                        )
                        Text(
                            "Saat: $time",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.7f)
                        )
                    }
                },
                navigationIcon = {
                    IconButton(onClick = onNavigateBack) {
                        Icon(Icons.Default.Close, contentDescription = "Kapat")
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = Color.White,
                    titleContentColor = MaterialTheme.colorScheme.onSurface
                )
            )
        },
        containerColor = MaterialTheme.colorScheme.background
    ) { padding ->
        when {
            isLoading -> {
                Box(
                    modifier = Modifier
                        .fillMaxSize()
                        .padding(padding),
                    contentAlignment = Alignment.Center
                ) {
                    CircularProgressIndicator(color = DoziTurquoise)
                }
            }
            medicines.isEmpty() -> {
                Box(
                    modifier = Modifier
                        .fillMaxSize()
                        .padding(padding),
                    contentAlignment = Alignment.Center
                ) {
                    Column(
                        horizontalAlignment = Alignment.CenterHorizontally,
                        verticalArrangement = Arrangement.spacedBy(16.dp)
                    ) {
                        Icon(
                            Icons.Default.CheckCircle,
                            contentDescription = null,
                            modifier = Modifier.size(64.dp),
                            tint = SuccessGreen
                        )
                        Text(
                            "Bu saatte ila√ß yok",
                            style = MaterialTheme.typography.titleLarge,
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.onSurface
                        )
                        Text(
                            "T√ºm ila√ßlarƒ±nƒ±z alƒ±ndƒ± veya bu saatte planlanmƒ±≈ü ila√ß bulunamadƒ±",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
            }
            else -> {
                LazyColumn(
                    modifier = Modifier
                        .fillMaxSize()
                        .padding(padding),
                    contentPadding = PaddingValues(16.dp),
                    verticalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    item {
                        Card(
                            colors = CardDefaults.cardColors(
                                containerColor = DoziTurquoise.copy(alpha = 0.1f)
                            ),
                            shape = RoundedCornerShape(16.dp),
                            elevation = CardDefaults.cardElevation(0.dp)
                        ) {
                            Row(
                                modifier = Modifier
                                    .fillMaxWidth()
                                    .padding(16.dp),
                                verticalAlignment = Alignment.CenterVertically,
                                horizontalArrangement = Arrangement.spacedBy(12.dp)
                            ) {
                                Icon(
                                    Icons.Default.Info,
                                    contentDescription = null,
                                    tint = DoziTurquoise
                                )
                                Column(modifier = Modifier.weight(1f)) {
                                    Text(
                                        "${medicines.size} ila√ß almanƒ±z gerekiyor",
                                        style = MaterialTheme.typography.titleSmall,
                                        fontWeight = FontWeight.Bold,
                                        color = DoziTurquoise
                                    )
                                    Text(
                                        "Her ila√ß i√ßin ayrƒ± ayrƒ± i≈ülem yapabilirsiniz",
                                        style = MaterialTheme.typography.bodySmall,
                                        color = MaterialTheme.colorScheme.onSurfaceVariant
                                    )
                                }
                            }
                        }
                    }

                    items(medicines) { medicine ->
                        val isCompleted = completedMedicines.contains(medicine.id)

                        MedicationActionCard(
                            medicine = medicine,
                            time = time,
                            isCompleted = isCompleted,
                            onTaken = {
                                SoundHelper.playSound(context, SoundHelper.SoundType.HERSEY_TAMAM)
                                handleMedicineTaken(context, medicine, time, medicineRepository)
                                completedMedicines = completedMedicines + medicine.id
                            },
                            onSkipped = {
                                SoundHelper.playSound(context, SoundHelper.SoundType.PEKALA)
                                handleMedicineSkipped(context, medicine, time)
                                completedMedicines = completedMedicines + medicine.id
                            },
                            onSnoozed = { minutes ->
                                SoundHelper.playSound(context, SoundHelper.SoundType.ERTELE)
                                handleMedicineSnoozed(context, medicine, time, minutes)
                                completedMedicines = completedMedicines + medicine.id
                            }
                        )
                    }

                    item {
                        Spacer(Modifier.height(32.dp))
                    }
                }
            }
        }
    }
}

@Composable
private fun MedicationActionCard(
    medicine: Medicine,
    time: String,
    isCompleted: Boolean,
    onTaken: () -> Unit,
    onSkipped: () -> Unit,
    onSnoozed: (Int) -> Unit
) {
    var showSnoozeDialog by remember { mutableStateOf(false) }
    var showSkipDialog by remember { mutableStateOf(false) }

    Card(
        modifier = Modifier.fillMaxWidth(),
        shape = RoundedCornerShape(20.dp),
        colors = CardDefaults.cardColors(
            containerColor = if (isCompleted) SuccessGreen.copy(alpha = 0.1f) else Color.White
        ),
        elevation = CardDefaults.cardElevation(0.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // Header
            Row(
                modifier = Modifier.fillMaxWidth(),
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                Surface(
                    shape = RoundedCornerShape(12.dp),
                    color = DoziTurquoise.copy(alpha = 0.15f),
                    modifier = Modifier.size(48.dp)
                ) {
                    Box(contentAlignment = Alignment.Center) {
                        Text(
                            medicine.icon,
                            style = MaterialTheme.typography.headlineSmall
                        )
                    }
                }

                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        medicine.name,
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                    Text(
                        medicine.dosage,
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                    if (medicine.stockCount > 0) {
                        Text(
                            "Stok: ${medicine.stockCount} adet",
                            style = MaterialTheme.typography.bodySmall,
                            color = when {
                                medicine.stockCount < 5 -> DoziRed
                                medicine.stockCount < 10 -> WarningOrange
                                else -> SuccessGreen
                            }
                        )
                    }
                }

                if (isCompleted) {
                    Icon(
                        Icons.Default.CheckCircle,
                        contentDescription = "Tamamlandƒ±",
                        tint = SuccessGreen,
                        modifier = Modifier.size(32.dp)
                    )
                }
            }

            if (!isCompleted) {
                HorizontalDivider(color = VeryLightGray)

                // Action buttons
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    Button(
                        onClick = onTaken,
                        modifier = Modifier.weight(1f),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = SuccessGreen
                        ),
                        shape = RoundedCornerShape(12.dp)
                    ) {
                        Column(
                            horizontalAlignment = Alignment.CenterHorizontally,
                            verticalArrangement = Arrangement.spacedBy(4.dp)
                        ) {
                            Icon(Icons.Default.Check, contentDescription = null)
                            Text("ALDIM", fontSize = 10.sp)
                        }
                    }

                    OutlinedButton(
                        onClick = { showSnoozeDialog = true },
                        modifier = Modifier.weight(1f),
                        colors = ButtonDefaults.outlinedButtonColors(
                            contentColor = WarningOrange
                        ),
                        shape = RoundedCornerShape(12.dp)
                    ) {
                        Column(
                            horizontalAlignment = Alignment.CenterHorizontally,
                            verticalArrangement = Arrangement.spacedBy(4.dp)
                        ) {
                            Icon(Icons.Default.AccessTime, contentDescription = null)
                            Text("ERTELE", fontSize = 10.sp)
                        }
                    }

                    OutlinedButton(
                        onClick = { showSkipDialog = true },
                        modifier = Modifier.weight(1f),
                        colors = ButtonDefaults.outlinedButtonColors(
                            contentColor = ErrorRed
                        ),
                        shape = RoundedCornerShape(12.dp)
                    ) {
                        Column(
                            horizontalAlignment = Alignment.CenterHorizontally,
                            verticalArrangement = Arrangement.spacedBy(4.dp)
                        ) {
                            Icon(Icons.Default.Close, contentDescription = null)
                            Text("ATLA", fontSize = 10.sp)
                        }
                    }
                }
            }
        }
    }

    // Snooze Dialog
    if (showSnoozeDialog) {
        SimpleSnoozeDialog(
            onDismiss = { showSnoozeDialog = false },
            onConfirm = { minutes ->
                onSnoozed(minutes)
                showSnoozeDialog = false
            }
        )
    }

    // Skip Dialog
    if (showSkipDialog) {
        SimpleSkipDialog(
            medicineName = medicine.name,
            onDismiss = { showSkipDialog = false },
            onConfirm = {
                onSkipped()
                showSkipDialog = false
            }
        )
    }
}

@Composable
private fun SimpleSnoozeDialog(
    onDismiss: () -> Unit,
    onConfirm: (Int) -> Unit
) {
    var selectedMinutes by remember { mutableStateOf(10) }
    val options = listOf(5, 10, 15, 30)

    AlertDialog(
        onDismissRequest = onDismiss,
        icon = {
            Icon(Icons.Default.AccessTime, contentDescription = null, tint = WarningOrange)
        },
        title = {
            Text("Ne kadar ertele?", fontWeight = FontWeight.Bold)
        },
        text = {
            Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                options.forEach { minutes ->
                    FilterChip(
                        selected = selectedMinutes == minutes,
                        onClick = { selectedMinutes = minutes },
                        label = { Text("$minutes dakika") },
                        leadingIcon = if (selectedMinutes == minutes) {
                            { Icon(Icons.Default.Check, contentDescription = null) }
                        } else null
                    )
                }
            }
        },
        confirmButton = {
            Button(
                onClick = { onConfirm(selectedMinutes) },
                colors = ButtonDefaults.buttonColors(containerColor = WarningOrange)
            ) {
                Text("Ertele")
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text("ƒ∞ptal")
            }
        }
    )
}

@Composable
private fun SimpleSkipDialog(
    medicineName: String,
    onDismiss: () -> Unit,
    onConfirm: () -> Unit
) {
    AlertDialog(
        onDismissRequest = onDismiss,
        icon = {
            Icon(Icons.Default.Warning, contentDescription = null, tint = ErrorRed)
        },
        title = {
            Text("ƒ∞lacƒ± Atla?", fontWeight = FontWeight.Bold)
        },
        text = {
            Text("$medicineName ilacƒ±nƒ± atlamak istediƒüinize emin misiniz?")
        },
        confirmButton = {
            Button(
                onClick = onConfirm,
                colors = ButtonDefaults.buttonColors(containerColor = ErrorRed)
            ) {
                Text("Evet, Atla")
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text("ƒ∞ptal")
            }
        }
    )
}

// Helper functions
private fun handleMedicineTaken(
    context: Context,
    medicine: Medicine,
    time: String,
    repository: MedicineRepository
) {
    saveMedicineStatus(context, medicine.id, getCurrentDateString(), time, "taken")

    // Stok azalt
    if (medicine.stockCount > 0) {
        CoroutineScope(Dispatchers.IO).launch {
            try {
                repository.updateMedicineField(medicine.id, "stockCount", medicine.stockCount - 1)
            } catch (e: Exception) {
                e.printStackTrace()
            }
        }
    }
}

private fun handleMedicineSkipped(
    context: Context,
    medicine: Medicine,
    time: String
) {
    saveMedicineStatus(context, medicine.id, getCurrentDateString(), time, "skipped")
}

private fun handleMedicineSnoozed(
    context: Context,
    medicine: Medicine,
    time: String,
    minutes: Int
) {
    val snoozeUntil = System.currentTimeMillis() + minutes * 60_000L
    saveMedicineStatus(context, medicine.id, getCurrentDateString(), time, "snoozed_$snoozeUntil")

    // SharedPreferences'a kaydet
    context.getSharedPreferences("dozi_prefs", Context.MODE_PRIVATE).edit()
        .putInt("snooze_minutes", minutes)
        .putLong("snooze_until", snoozeUntil)
        .putLong("snooze_timestamp", System.currentTimeMillis())
        .apply()
}

// ============================================================================
// FILE: CustomMedicineAddScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/medicine/CustomMedicineAddScreen.kt
// [78 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.medicine

import android.widget.Toast
import androidx.compose.animation.*
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyRow
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalFocusManager
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.bardino.dozi.core.data.LocalMedicine
import com.bardino.dozi.core.data.MedicineLookupRepository
import com.bardino.dozi.core.data.model.MedicineColor
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*
import kotlinx.coroutines.launch
import java.util.UUID

// Form tipleri
private val formTypes = listOf(
    "tablet" to "Tablet",
    "kaps√ºl" to "Kaps√ºl",
    "≈üurup" to "≈ûurup",
    "damla" to "Damla",
    "krem" to "Krem/Merhem",
    "enjeksiyon" to "Enjeksiyon",
    "sprey" to "Sprey",
    "takviye" to "Takviye",
    "diƒüer" to "Diƒüer"
)

// Emoji ikonlarƒ±
private val medicineEmojis = listOf(
    "üíä", "üíâ", "ü©π", "üß¥", "üåø", "üçÉ", "‚ú®", "‚ù§Ô∏è", "üß¨", "ü©∫"
)

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun CustomMedicineAddScreen(
    onNavigateBack: () -> Unit,
    onNavigateToReminder: ((String) -> Unit)? = null,
    initialName: String = ""
) {
    val context = LocalContext.current
    val focusManager = LocalFocusManager.current
    val scrollState = rememberScrollState()

    // Form state
    var name by remember { mutableStateOf(initialName) }
    var stock by remember { mutableStateOf("") }
    var selectedForm by remember { mutableStateOf("tablet") }
    var selectedEmoji by remember { mutableStateOf("üíä") }
    var selectedColor by remember { mutableStateOf(MedicineColor.GREEN) } // Takviyeler i√ßin ye≈üil default

    // Error states
    var nameError by remember { mutableStateOf(false) }
    var stockError by remember { mutableStateOf(false) }

    // Dialog states
    var showReminderDialog by remember { mutableStateOf(false) }
    var savedMedicineId by remember { mutableStateOf<String?>(null) }

    // Animasyon
    var isVisible by remember { mutableStateOf(false) }
    LaunchedEffect(Unit) { isVisible = true }

    Scaffold(
        topBar = {
            DoziTopBar(
                title = "√ñzel ƒ∞la√ß Ekle",
                canNavigateBack = true,
                onNavigateBack = onNavigateBack,
                backgroundColor = MaterialTheme.colorScheme.surface
            )
        },
        containerColor = MaterialTheme.colorScheme.background
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .pointerInput(Unit) {
                    detectTapGestures(onTap = { focusManager.clearFocus() })
                }
        ) {
            Column(
                modifier = Modifier
                    .weight(1f)
                    .verticalScroll(scrollState)
                    .padding(horizontal = 20.dp, vertical = 16.dp),
                verticalArrangement = Arrangement.spacedBy(20.dp)
            ) {
                // Ba≈ülƒ±k ve a√ßƒ±klama
                AnimatedVisibility(visible = isVisible, enter = fadeIn()) {
                    Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                        Row(
                            verticalAlignment = Alignment.CenterVertically,
                            horizontalArrangement = Arrangement.spacedBy(12.dp)
                        ) {
                            Surface(
                                modifier = Modifier.size(48.dp),
                                shape = CircleShape,
                                color = DoziTurquoise.copy(alpha = 0.15f)
                            ) {
                                Box(contentAlignment = Alignment.Center) {
                                    Text(
                                        text = selectedEmoji,
                                        fontSize = 24.sp
                                    )
                                }
                            }
                            Column {
                                Text(
                                    text = "√ñzel ƒ∞la√ß Ekle",
                                    style = MaterialTheme.typography.titleLarge,
                                    fontWeight = FontWeight.Bold,
                                    color = MaterialTheme.colorScheme.onSurface
                                )
                                Text(
                                    text = "Takviye, vitamin veya listede olmayan ila√ßlar",
                                    style = MaterialTheme.typography.bodySmall,
                                    color = MaterialTheme.colorScheme.onSurfaceVariant
                                )
                            }
                        }
                    }
                }

                AnimatedVisibility(
                    visible = isVisible,
                    enter = slideInVertically(initialOffsetY = { 50 }) + fadeIn()
                ) {
                    Column(verticalArrangement = Arrangement.spacedBy(16.dp)) {
                        // ƒ∞la√ß Adƒ±
                        Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                            Text(
                                text = "ƒ∞la√ß/Takviye Adƒ±",
                                style = MaterialTheme.typography.labelLarge,
                                fontWeight = FontWeight.Medium,
                                color = MaterialTheme.colorScheme.onSurface
                            )
                            OutlinedTextField(
                                value = name,
                                onValueChange = { name = it; nameError = it.isBlank() },
                                modifier = Modifier
                                    .fillMaxWidth()
                                    .background(Color(0xFFF9F9FB), RoundedCornerShape(12.dp)),
                                placeholder = {
                                    Text(
                                        "√ñrn: Omega-3, D Vitamini, Probiyotik...",
                                        color = MaterialTheme.colorScheme.onSurfaceVariant
                                    )
                                },
                                leadingIcon = {
                                    Icon(Icons.Default.Edit, null, tint = DoziTurquoise)
                                },
                                shape = RoundedCornerShape(12.dp),
                                colors = OutlinedTextFieldDefaults.colors(
                                    focusedBorderColor = DoziTurquoise,
                                    unfocusedBorderColor = VeryLightGray,
                                    cursorColor = DoziTurquoise,
                                    focusedContainerColor = Color(0xFFF9F9FB),
                                    unfocusedContainerColor = Color(0xFFF9F9FB)
                                ),
                                singleLine = true,
                                isError = nameError
                            )
                            if (nameError) {
                                Text(
                                    text = "ƒ∞la√ß adƒ± bo≈ü bƒ±rakƒ±lamaz",
                                    style = MaterialTheme.typography.bodySmall,
                                    color = MaterialTheme.colorScheme.error
                                )
                            }
                        }

                        // Stok Sayƒ±sƒ±
                        Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                            Text(
                                text = "Evdeki Stok Miktarƒ±",
                                style = MaterialTheme.typography.labelLarge,
                                fontWeight = FontWeight.Medium,
                                color = MaterialTheme.colorScheme.onSurface
                            )
                            OutlinedTextField(
                                value = stock,
                                onValueChange = { newValue ->
                                    if (newValue.isEmpty() || newValue.all { it.isDigit() }) {
                                        val num = newValue.toIntOrNull()
                                        if (num == null || num in 1..999) {
                                            stock = newValue
                                            stockError = newValue.isEmpty()
                                        }
                                    }
                                },
                                modifier = Modifier
                                    .fillMaxWidth()
                                    .background(Color(0xFFF9F9FB), RoundedCornerShape(12.dp)),
                                placeholder = {
                                    Text(
                                        "Ka√ß adet/tablet/kaps√ºl var?",
                                        color = MaterialTheme.colorScheme.onSurfaceVariant
                                    )
                                },
                                leadingIcon = {
                                    Icon(Icons.Default.Inventory, null, tint = DoziCoral)
                                },
                                shape = RoundedCornerShape(12.dp),
                                colors = OutlinedTextFieldDefaults.colors(
                                    focusedBorderColor = DoziTurquoise,
                                    unfocusedBorderColor = VeryLightGray,
                                    cursorColor = DoziTurquoise,
                                    focusedContainerColor = Color(0xFFF9F9FB),
                                    unfocusedContainerColor = Color(0xFFF9F9FB)
                                ),
                                singleLine = true,
                                keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number),
                                isError = stockError
                            )
                            if (stockError) {
                                Text(
                                    text = "Stok miktarƒ± giriniz (1-999)",
                                    style = MaterialTheme.typography.bodySmall,
                                    color = MaterialTheme.colorScheme.error
                                )
                            }
                        }

                        // Form Tipi Se√ßimi
                        Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                            Text(
                                text = "Form Tipi",
                                style = MaterialTheme.typography.labelLarge,
                                fontWeight = FontWeight.Medium,
                                color = MaterialTheme.colorScheme.onSurface
                            )
                            LazyRow(
                                horizontalArrangement = Arrangement.spacedBy(8.dp)
                            ) {
                                items(formTypes) { (value, label) ->
                                    FormTypeChip(
                                        label = label,
                                        selected = selectedForm == value,
                                        onClick = { selectedForm = value }
                                    )
                                }
                            }
                        }

                        // Emoji Se√ßimi
                        Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                            Text(
                                text = "ƒ∞kon Se√ß",
                                style = MaterialTheme.typography.labelLarge,
                                fontWeight = FontWeight.Medium,
                                color = MaterialTheme.colorScheme.onSurface
                            )
                            LazyRow(
                                horizontalArrangement = Arrangement.spacedBy(8.dp)
                            ) {
                                items(medicineEmojis) { emoji ->
                                    EmojiChip(
                                        emoji = emoji,
                                        selected = selectedEmoji == emoji,
                                        onClick = { selectedEmoji = emoji }
                                    )
                                }
                            }
                        }

                        // Renk Se√ßimi
                        Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                            Text(
                                text = "Renk Kategorisi",
                                style = MaterialTheme.typography.labelLarge,
                                fontWeight = FontWeight.Medium,
                                color = MaterialTheme.colorScheme.onSurface
                            )
                            LazyRow(
                                horizontalArrangement = Arrangement.spacedBy(8.dp)
                            ) {
                                items(MedicineColor.entries.toList()) { color ->
                                    ColorChip(
                                        color = color,
                                        selected = selectedColor == color,
                                        onClick = { selectedColor = color }
                                    )
                                }
                            }
                        }

                        // Bilgi kartƒ±
                        Card(
                            modifier = Modifier.fillMaxWidth(),
                            colors = CardDefaults.cardColors(
                                containerColor = DoziTurquoise.copy(alpha = 0.08f)
                            ),
                            shape = RoundedCornerShape(12.dp)
                        ) {
                            Row(
                                modifier = Modifier.padding(12.dp),
                                horizontalArrangement = Arrangement.spacedBy(12.dp),
                                verticalAlignment = Alignment.CenterVertically
                            ) {
                                Icon(
                                    Icons.Default.Info,
                                    contentDescription = null,
                                    tint = DoziTurquoise
                                )
                                Text(
                                    text = "√ñzel ila√ßlar resmi veritabanƒ±nda olmayan ila√ßlar i√ßin kullanƒ±lƒ±r. ƒ∞la√ß eklendikten sonra hatƒ±rlatma kurabilirsiniz.",
                                    style = MaterialTheme.typography.bodySmall,
                                    color = MaterialTheme.colorScheme.onSurfaceVariant
                                )
                            }
                        }
                    }
                }
            }

            // Kaydet Butonu - Altta sabit
            AnimatedVisibility(
                visible = isVisible,
                enter = slideInVertically(initialOffsetY = { 100 }) + fadeIn()
            ) {
                Surface(
                    modifier = Modifier.fillMaxWidth(),
                    shadowElevation = 8.dp,
                    color = MaterialTheme.colorScheme.surface
                ) {
                    Button(
                        onClick = {
                            nameError = name.isBlank()
                            stockError = stock.isEmpty() || stock.toIntOrNull() == null

                            if (!nameError && !stockError) {
                                val newId = UUID.randomUUID().toString()
                                val localMedicine = LocalMedicine(
                                    id = newId,
                                    name = name.trim(),
                                    dosage = "",
                                    stock = stock.toInt()
                                )

                                // Local'e kaydet
                                MedicineLookupRepository.saveLocalMedicine(context, localMedicine)

                                // Firestore'a kaydet (isCustom = true)
                                kotlinx.coroutines.CoroutineScope(kotlinx.coroutines.Dispatchers.IO).launch {
                                    try {
                                        val firestoreRepo = com.bardino.dozi.core.data.repository.MedicineRepository()
                                        val firestoreMedicine = com.bardino.dozi.core.data.model.Medicine(
                                            id = "",
                                            name = name.trim(),
                                            stockCount = stock.toInt(),
                                            boxSize = stock.toInt(),
                                            form = selectedForm,
                                            icon = selectedEmoji,
                                            color = selectedColor,
                                            reminderEnabled = false,
                                            isCustom = true  // √ñzel ila√ß olarak i≈üaretle
                                        )
                                        val saved = firestoreRepo.addMedicine(firestoreMedicine, context)

                                        kotlinx.coroutines.withContext(kotlinx.coroutines.Dispatchers.Main) {
                                            if (saved != null) {
                                                Toast.makeText(
                                                    context,
                                                    "‚úÖ ${name.trim()} eklendi!",
                                                    Toast.LENGTH_SHORT
                                                ).show()

                                                // Hatƒ±rlatma dialog'unu g√∂ster - Firestore ID kullan
                                                if (onNavigateToReminder != null) {
                                                    savedMedicineId = saved.id  // Firestore'dan d√∂nen ID'yi kullan
                                                    showReminderDialog = true
                                                } else {
                                                    onNavigateBack()
                                                }
                                            } else {
                                                Toast.makeText(
                                                    context,
                                                    "‚ö†Ô∏è ƒ∞la√ß yerel olarak kaydedildi",
                                                    Toast.LENGTH_SHORT
                                                ).show()
                                                // Firestore ba≈üarƒ±sƒ±z olsa da local ID ile devam et
                                                if (onNavigateToReminder != null) {
                                                    savedMedicineId = newId
                                                    showReminderDialog = true
                                                } else {
                                                    onNavigateBack()
                                                }
                                            }
                                        }
                                    } catch (e: Exception) {
                                        android.util.Log.e("CustomMedicineAdd", "Firestore kayƒ±t hatasƒ±", e)
                                        kotlinx.coroutines.withContext(kotlinx.coroutines.Dispatchers.Main) {
                                            Toast.makeText(
                                                context,
                                                "‚ö†Ô∏è ƒ∞la√ß yerel olarak kaydedildi",
                                                Toast.LENGTH_SHORT
                                            ).show()
                                            // Hata durumunda da local ID ile devam et
                                            if (onNavigateToReminder != null) {
                                                savedMedicineId = newId
                                                showReminderDialog = true
                                            } else {
                                                onNavigateBack()
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(16.dp)
                            .height(56.dp),
                        shape = RoundedCornerShape(16.dp),
                        colors = ButtonDefaults.buttonColors(containerColor = DoziTurquoise)
                    ) {
                        Icon(Icons.Default.Add, contentDescription = null, tint = Color.White)
                        Spacer(modifier = Modifier.width(8.dp))
                        Text(
                            text = "ƒ∞la√ß Ekle",
                            style = MaterialTheme.typography.titleMedium,
                            fontWeight = FontWeight.Bold,
                            color = Color.White
                        )
                    }
                }
            }
        }
    }

    // Hatƒ±rlatma ekleme dialog'u
    if (showReminderDialog && savedMedicineId != null) {
        AlertDialog(
            onDismissRequest = {
                showReminderDialog = false
                onNavigateBack()
            },
            icon = {
                Icon(
                    Icons.Default.Notifications,
                    contentDescription = null,
                    tint = DoziTurquoise,
                    modifier = Modifier.size(48.dp)
                )
            },
            title = {
                Text(
                    text = "Hatƒ±rlatma Ekle",
                    fontWeight = FontWeight.Bold,
                    style = MaterialTheme.typography.titleLarge
                )
            },
            text = {
                Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                    Text(
                        text = "$name i√ßin bir hatƒ±rlatma kurmak ister misin?",
                        style = MaterialTheme.typography.bodyLarge
                    )
                    Spacer(modifier = Modifier.height(8.dp))
                    Text(
                        text = "Hatƒ±rlatma kurarak ila√ßlarƒ±nƒ± d√ºzenli alabilirsin!",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            },
            confirmButton = {
                Button(
                    onClick = {
                        showReminderDialog = false
                        onNavigateToReminder?.invoke(savedMedicineId!!)
                    },
                    colors = ButtonDefaults.buttonColors(containerColor = DoziTurquoise)
                ) {
                    Icon(Icons.Default.Add, contentDescription = null)
                    Spacer(Modifier.width(8.dp))
                    Text("Evet, Ekle", fontWeight = FontWeight.Bold)
                }
            },
            dismissButton = {
                TextButton(onClick = {
                    showReminderDialog = false
                    onNavigateBack()
                }) {
                    Text("≈ûimdi Deƒüil", color = MaterialTheme.colorScheme.onSurfaceVariant)
                }
            }
        )
    }
}

@Composable
private fun FormTypeChip(
    label: String,
    selected: Boolean,
    onClick: () -> Unit
) {
    Surface(
        onClick = onClick,
        shape = RoundedCornerShape(20.dp),
        color = if (selected) DoziTurquoise else Color.Transparent,
        border = if (!selected) androidx.compose.foundation.BorderStroke(1.dp, VeryLightGray) else null
    ) {
        Text(
            text = label,
            modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp),
            style = MaterialTheme.typography.bodyMedium,
            fontWeight = if (selected) FontWeight.Bold else FontWeight.Normal,
            color = if (selected) Color.White else MaterialTheme.colorScheme.onSurfaceVariant
        )
    }
}

@Composable
private fun EmojiChip(
    emoji: String,
    selected: Boolean,
    onClick: () -> Unit
) {
    Surface(
        onClick = onClick,
        modifier = Modifier.size(48.dp),
        shape = CircleShape,
        color = if (selected) DoziTurquoise.copy(alpha = 0.15f) else Color(0xFFF5F5F5),
        border = if (selected) androidx.compose.foundation.BorderStroke(2.dp, DoziTurquoise) else null
    ) {
        Box(contentAlignment = Alignment.Center) {
            Text(text = emoji, fontSize = 20.sp)
        }
    }
}

@Composable
private fun ColorChip(
    color: MedicineColor,
    selected: Boolean,
    onClick: () -> Unit
) {
    val chipColor = Color(android.graphics.Color.parseColor(color.hexColor))

    Surface(
        onClick = onClick,
        modifier = Modifier.size(40.dp),
        shape = CircleShape,
        color = chipColor,
        border = if (selected) {
            androidx.compose.foundation.BorderStroke(3.dp, MaterialTheme.colorScheme.onSurface)
        } else {
            androidx.compose.foundation.BorderStroke(1.dp, VeryLightGray)
        }
    ) {
        if (selected) {
            Box(contentAlignment = Alignment.Center) {
                Icon(
                    Icons.Default.Check,
                    contentDescription = null,
                    tint = Color.White,
                    modifier = Modifier.size(20.dp)
                )
            }
        }
    }
}

// ============================================================================
// FILE: MedicineDetailScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/medicine/MedicineDetailScreen.kt
// [79 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.medicine

import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Edit
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import kotlinx.coroutines.withTimeout
import com.bardino.dozi.core.data.model.Medicine
import com.bardino.dozi.core.data.repository.MedicineRepository
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*

@Composable
fun MedicineDetailScreen(
    medicineId: String,
    onNavigateBack: () -> Unit,
    onEditMedicine: (String) -> Unit
) {
    val context = LocalContext.current
    val repository = remember { MedicineRepository() }

    // Mevcut ilacƒ± y√ºkle
    var medicine by remember { mutableStateOf<Medicine?>(null) }
    var isLoading by remember { mutableStateOf(true) }
    var error by remember { mutableStateOf<String?>(null) }

    // Debug log
    android.util.Log.d("MedicineDetailScreen", "Screen initialized with medicineId: $medicineId")

    LaunchedEffect(medicineId) {
        android.util.Log.d("MedicineDetailScreen", "LaunchedEffect started, loading medicine: $medicineId")
        try {
            // 10 saniye timeout
            medicine = withTimeout(10000L) {
                repository.getMedicine(medicineId)
            }
        } catch (e: kotlinx.coroutines.TimeoutCancellationException) {
            error = "ƒ∞la√ß y√ºkleme zaman a≈üƒ±mƒ±na uƒüradƒ±. ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin."
            android.util.Log.e("MedicineDetailScreen", "Timeout loading medicine", e)
        } catch (e: Exception) {
            error = "ƒ∞la√ß y√ºklenirken hata: ${e.message}"
            android.util.Log.e("MedicineDetailScreen", "Error loading medicine", e)
        } finally {
            isLoading = false
        }
    }

    // Loading durumu
    if (isLoading) {
        Box(
            modifier = Modifier.fillMaxSize(),
            contentAlignment = androidx.compose.ui.Alignment.Center
        ) {
            CircularProgressIndicator(color = DoziTurquoise)
        }
        return
    }

    // Hata durumu
    if (error != null) {
        Box(
            modifier = Modifier.fillMaxSize(),
            contentAlignment = androidx.compose.ui.Alignment.Center
        ) {
            Column(
                horizontalAlignment = androidx.compose.ui.Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                Text(
                    text = "‚ùå Hata",
                    style = MaterialTheme.typography.headlineSmall,
                    color = Color.Red
                )
                Text(
                    text = error ?: "Bilinmeyen hata",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                Button(onClick = onNavigateBack) {
                    Text("Geri D√∂n")
                }
            }
        }
        return
    }

    // ƒ∞la√ß bulunamadƒ± durumu
    if (medicine == null) {
        Box(
            modifier = Modifier.fillMaxSize(),
            contentAlignment = androidx.compose.ui.Alignment.Center
        ) {
            Column(
                horizontalAlignment = androidx.compose.ui.Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                Text(
                    text = "üîç ƒ∞la√ß Bulunamadƒ±",
                    style = MaterialTheme.typography.headlineSmall
                )
                Text(
                    text = "Bu ila√ß silinmi≈ü olabilir.",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                Button(onClick = onNavigateBack) {
                    Text("Geri D√∂n")
                }
            }
        }
        return
    }

    val med = medicine!! // Non-null assertion safe here

    Scaffold(
        topBar = {
            DoziTopBar(
                title = "ƒ∞la√ß Detayƒ±",
                canNavigateBack = true,
                onNavigateBack = onNavigateBack,
                backgroundColor = MaterialTheme.colorScheme.surface,
                actions = {
                    IconButton(
                        onClick = { onEditMedicine(med.id) },
                        modifier = Modifier
                            .size(46.dp)
                            .background(DoziTurquoise.copy(alpha = 0.1f), CircleShape)
                    ) {
                        Icon(
                            imageVector = Icons.Default.Edit,
                            contentDescription = "D√ºzenle",
                            tint = DoziTurquoise
                        )
                    }
                }
            )
        },
        containerColor = MaterialTheme.colorScheme.background
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // ƒ∞la√ß Bilgileri Kartƒ±
            Card(
                modifier = Modifier.fillMaxWidth(),
                colors = CardDefaults.cardColors(containerColor = Color.White),
                border = BorderStroke(1.dp, VeryLightGray),
                shape = RoundedCornerShape(20.dp)
            ) {
                Column(
                    Modifier.padding(20.dp),
                    verticalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    DetailRow("ƒ∞la√ß Adƒ±", med.name)
                    DetailRow("Dozaj", "${med.dosage} ${med.unit}")

                    // üìä Stok Progress Bar
                    StockProgressIndicator(
                        currentStock = med.stockCount,
                        boxSize = med.boxSize
                    )

                    DetailRow("Form", med.form)
                    DetailRow("Kullanƒ±m Sƒ±klƒ±ƒüƒ±", med.frequency)
                }
            }

            // Bilgilendirme Mesajƒ±
            Text(
                text = "Bu ekran sadece g√∂r√ºnt√ºleme i√ßindir. ƒ∞la√ß bilgilerini d√ºzenlemek i√ßin saƒü √ºstteki 'D√ºzenle' butonuna dokun.",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
}

@Composable
private fun DetailRow(label: String, value: String) {
    Column(verticalArrangement = Arrangement.spacedBy(4.dp)) {
        Text(
            text = label,
            style = MaterialTheme.typography.labelMedium,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
        Text(
            text = value,
            style = MaterialTheme.typography.titleMedium,
            fontWeight = FontWeight.Bold,
            color = MaterialTheme.colorScheme.onSurface
        )
    }
}

/**
 * üìä Stok g√∂stergesi (progress bar)
 */
@Composable
private fun StockProgressIndicator(
    currentStock: Int,
    boxSize: Int
) {
    Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
        // Label
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = "Stok Durumu",
                style = MaterialTheme.typography.labelMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
            Text(
                text = "$currentStock / $boxSize ${if (boxSize > 0) "adet" else ""}",
                style = MaterialTheme.typography.titleSmall,
                fontWeight = FontWeight.Bold,
                color = getStockColor(currentStock, boxSize)
            )
        }

        // Progress bar
        if (boxSize > 0) {
            val progress = (currentStock.toFloat() / boxSize.toFloat()).coerceIn(0f, 1f)

            LinearProgressIndicator(
                progress = progress,
                modifier = Modifier
                    .fillMaxWidth()
                    .height(12.dp),
                color = getStockColor(currentStock, boxSize),
                trackColor = VeryLightGray,
            )

            // Stok uyarƒ± mesajƒ±
            when {
                currentStock == 0 -> {
                    Text(
                        text = "üö® Stok bitti! Eczaneden temin edin.",
                        style = MaterialTheme.typography.bodySmall,
                        color = Color(0xFFEF5350),
                        fontWeight = FontWeight.Medium
                    )
                }
                currentStock <= 5 -> {
                    Text(
                        text = "‚ö†Ô∏è D√º≈ü√ºk stok! Eczaneden temin etmeyi unutmayƒ±n.",
                        style = MaterialTheme.typography.bodySmall,
                        color = Color(0xFFFFA726),
                        fontWeight = FontWeight.Medium
                    )
                }
            }
        } else {
            Text(
                text = "$currentStock adet",
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )
        }
    }
}

/**
 * Stok seviyesine g√∂re renk d√∂nd√ºr
 */
private fun getStockColor(currentStock: Int, boxSize: Int): Color {
    return when {
        currentStock == 0 -> Color(0xFFEF5350) // Kƒ±rmƒ±zƒ± - Stok bitti
        currentStock <= 5 -> Color(0xFFFFA726) // Turuncu - D√º≈ü√ºk stok
        boxSize > 0 && currentStock.toFloat() / boxSize.toFloat() < 0.25f -> Color(0xFFFFA726) // Turuncu - %25'in altƒ±nda
        else -> Color(0xFF66BB6A) // Ye≈üil - Yeterli stok
    }
}
// ============================================================================
// FILE: MedicineEditScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/medicine/MedicineEditScreen.kt
// [80 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.medicine

import android.content.Context
import android.net.Uri
import android.widget.Toast
import androidx.compose.animation.*
import androidx.compose.foundation.background
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalFocusManager
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.unit.dp
import androidx.core.content.FileProvider
import com.bardino.dozi.core.data.Ilac
import com.bardino.dozi.core.data.LocalMedicine
import com.bardino.dozi.core.data.MedicineLookupRepository
import com.bardino.dozi.core.data.model.Medicine
import com.bardino.dozi.core.data.model.MedicineColor
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*
import androidx.compose.foundation.lazy.LazyRow
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.clickable
import androidx.compose.foundation.border
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.ui.draw.clip
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import com.google.mlkit.vision.common.InputImage
import com.google.mlkit.vision.text.TextRecognition
import com.google.mlkit.vision.text.latin.TextRecognizerOptions
import kotlinx.coroutines.launch
import java.io.File
import java.io.IOException
import java.util.UUID
import androidx.compose.ui.unit.sp
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext

// Emoji ikonlarƒ± for custom medicines
private val medicineEmojis = listOf(
    "üíä", "üíâ", "ü©π", "üß¥", "üåø", "üçÉ", "‚ú®", "‚ù§Ô∏è", "üß¨", "ü©∫"
)

// --------------------------------------------------------------------
// üîç Bellekten ƒ∞la√ß Doƒürulama
// --------------------------------------------------------------------
fun verifyMedicine(name: String): Ilac? {
    return MedicineLookupRepository.findByNameOrIngredient(name)
}

// --------------------------------------------------------------------
// üì¶ ƒ∞la√ß isminden stok bilgisini √ßƒ±kart
// --------------------------------------------------------------------
fun extractStockFromName(productName: String?): Int {
    if (productName.isNullOrBlank()) return 0

    // "20 tablet", "x30", "30 kaps√ºl", "50'li kutu" gibi patternler
    val patterns = listOf(
        Regex("""(\d+)\s*tablet""", RegexOption.IGNORE_CASE),
        Regex("""(\d+)\s*kaps[√ºu]l""", RegexOption.IGNORE_CASE),
        Regex("""x\s*(\d+)""", RegexOption.IGNORE_CASE),
        Regex("""(\d+)'li\s*kutu""", RegexOption.IGNORE_CASE),
        Regex("""(\d+)\s*adet""", RegexOption.IGNORE_CASE),
        Regex("""\b(\d+)\s*(tb|kps|amp|flakon)\b""", RegexOption.IGNORE_CASE)
    )

    patterns.forEach { pattern ->
        pattern.find(productName)?.groups?.get(1)?.value?.toIntOrNull()?.let {
            android.util.Log.d("MedicineEdit", "‚úÖ Extracted stock: $it from '$productName'")
            return it
        }
    }

    android.util.Log.d("MedicineEdit", "‚ö†Ô∏è No stock found in '$productName', defaulting to 0")
    return 0
}

// --------------------------------------------------------------------
// üì∑ Ge√ßici fotoƒüraf dosyasƒ± URI'si olu≈üturur
// --------------------------------------------------------------------
private fun createImageUri(context: Context): Uri {
    val file = File.createTempFile(
        "ocr_photo_${System.currentTimeMillis()}",
        ".jpg",
        context.cacheDir
    )
    return FileProvider.getUriForFile(context, "${context.packageName}.provider", file)
}

// --------------------------------------------------------------------
// üß† OCR i≈ülemini √ßalƒ±≈ütƒ±rƒ±r
// --------------------------------------------------------------------
private fun processImageFromUri(
    context: Context,
    uri: Uri,
    onResult: (name: String, dosage: String, stock: String) -> Unit
) {
    val recognizer = TextRecognition.getClient(TextRecognizerOptions.DEFAULT_OPTIONS)
    try {
        val image = InputImage.fromFilePath(context, uri)
        recognizer.process(image)
            .addOnSuccessListener { result ->
                val lines = result.textBlocks.flatMap { it.lines }.map { it.text }
                val merged = lines.joinToString(" ")
                val (n, d, s) = extractMedicineInfo(lines, merged)
                onResult(n, d, s)
            }
            .addOnFailureListener {
                Toast.makeText(context, "Tanƒ±ma hatasƒ± olu≈ütu.", Toast.LENGTH_SHORT).show()
            }
    } catch (e: IOException) {
        Toast.makeText(context, "G√∂r√ºnt√º okunamadƒ±: ${e.message}", Toast.LENGTH_SHORT).show()
    }
}

// --------------------------------------------------------------------
// ‚ú≥Ô∏è Ana Ekran: Yeni ƒ∞la√ß Ekle / D√ºzenle
// --------------------------------------------------------------------
@Composable
fun MedicineEditScreen(
    medicineId: String,
    onNavigateBack: () -> Unit,
    onNavigateToReminder: ((String) -> Unit)? = null,
    savedStateHandle: androidx.lifecycle.SavedStateHandle? = null
) {
    val context = LocalContext.current
    val focusManager = LocalFocusManager.current
    val scope = rememberCoroutineScope()
    val scrollState = rememberScrollState()

    // Lookup ekranƒ±ndan gelen ila√ß bilgisi
    val selectedMedicine = savedStateHandle?.get<IlacSearchResultParcelable>("selectedMedicine")

    // Mevcut ila√ß bilgilerini y√ºkle
    val existing = MedicineLookupRepository.getLocalMedicine(context, medicineId)
    var name by remember { mutableStateOf(
        existing?.name
            ?: selectedMedicine?.item?.Product_Name
            ?: ""
    ) }

    // ‚úÖ Stok bilgisini akƒ±llƒ±ca belirle:
    // 1. Mevcut ila√ß varsa -> onun stoƒüunu kullan
    // 2. Yoksa -> 0 (ad yazƒ±ldƒ±k√ßa otomatik g√ºncellen ecek)
    var stock by remember { mutableStateOf(
        existing?.stock?.toString() ?: "0"
    ) }

    // Custom medicine fields
    var isCustomMedicine by remember { mutableStateOf(false) }
    var selectedColor by remember { mutableStateOf(MedicineColor.BLUE) }
    var selectedEmoji by remember { mutableStateOf("üíä") }
    var firestoreMedicine by remember { mutableStateOf<Medicine?>(null) }

    // Load from Firestore for existing medicines
    LaunchedEffect(medicineId) {
        if (medicineId != "new") {
            withContext(Dispatchers.IO) {
                try {
                    val repo = com.bardino.dozi.core.data.repository.MedicineRepository()
                    val medicine = repo.getMedicineById(medicineId)
                    if (medicine != null) {
                        withContext(Dispatchers.Main) {
                            firestoreMedicine = medicine
                            name = medicine.name
                            stock = medicine.stockCount.toString()
                            isCustomMedicine = medicine.isCustom
                            selectedColor = medicine.color
                            selectedEmoji = medicine.icon

                            android.util.Log.d(
                                "MedicineEditScreen",
                                "Loaded from Firestore: ${medicine.name}, isCustom: ${medicine.isCustom}"
                            )
                        }
                    } else {
                        Unit
                    }


                } catch (e: Exception) {
                    android.util.Log.e("MedicineEditScreen", "Failed to load from Firestore", e)
                }
            }
        }
    }


    // ƒ∞la√ß adƒ± deƒüi≈ütiƒüinde stok'u otomatik g√ºncelle
    LaunchedEffect(name) {
        if (existing == null && name.isNotBlank()) {
            val extracted = extractStockFromName(name)
            if (extracted > 0) {
                stock = extracted.toString()
            }
        }
    }

    // Lookup'tan gelen veriyi i≈üle ve temizle
    LaunchedEffect(selectedMedicine) {
        if (selectedMedicine != null) {
            // Se√ßilen ila√ßtan stok bilgisini √ßƒ±kart
            selectedMedicine.item.Product_Name?.let { productName ->
                val extracted = extractStockFromName(productName)
                android.util.Log.d("MedicineEdit", "üì¶ Product: $productName, Extracted stock: $extracted")
                if (extracted > 0 && existing == null) {
                    stock = extracted.toString()
                    android.util.Log.d("MedicineEdit", "‚úÖ Stock updated to: $stock")
                }
            }
            savedStateHandle?.remove<IlacSearchResultParcelable>("selectedMedicine")
        }
    }

    // Hata durumlarƒ±
    var nameError by remember { mutableStateOf(false) }
    var stockError by remember { mutableStateOf(false) }

    // Hatƒ±rlatma dialog'u
    var showReminderDialog by remember { mutableStateOf(false) }
    var savedMedicineId by remember { mutableStateOf<String?>(null) }

    // Animasyon
    var isVisible by remember { mutableStateOf(false) }
    LaunchedEffect(Unit) { isVisible = true }

    Scaffold(
        topBar = {
            DoziTopBar(
                title = if (medicineId == "new") "Yeni ƒ∞la√ß Ekle" else "ƒ∞la√ß D√ºzenle",
                canNavigateBack = true,
                onNavigateBack = onNavigateBack,
                backgroundColor = MaterialTheme.colorScheme.surface
            )
        },
        containerColor = MaterialTheme.colorScheme.background
    ) { padding ->

        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .pointerInput(Unit) {
                    detectTapGestures(onTap = {
                        focusManager.clearFocus()
                    })
                }
        ) {
            Column(
                modifier = Modifier
                    .weight(1f)
                    .verticalScroll(scrollState)
                    .padding(horizontal = 20.dp, vertical = 16.dp),
                verticalArrangement = Arrangement.spacedBy(20.dp)
            ) {
                // Ba≈ülƒ±k
                AnimatedVisibility(visible = isVisible, enter = fadeIn()) {
                    Text(
                        text = if (medicineId == "new") "‚ú® Yeni ila√ß ekle" else "ƒ∞la√ß bilgilerini d√ºzenle",
                        style = MaterialTheme.typography.titleLarge,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                }

                AnimatedVisibility(visible = isVisible, enter = slideInVertically() + fadeIn()) {
                    Column(verticalArrangement = Arrangement.spacedBy(16.dp)) {

                        // üîπ ƒ∞la√ß Adƒ±
                        OutlinedTextField(
                            value = name,
                            onValueChange = { name = it; nameError = it.isBlank() },
                            label = { Text("ƒ∞la√ß Adƒ± *", color = MaterialTheme.colorScheme.onSurfaceVariant) },
                            leadingIcon = {
                                Icon(Icons.Default.LocalPharmacy, null, tint = DoziCoralDark)
                            },
                            modifier = Modifier
                                .fillMaxWidth()
                                .background(Color(0xFFF9F9FB), RoundedCornerShape(12.dp))
                                .padding(1.dp),
                            shape = RoundedCornerShape(12.dp),
                            colors = OutlinedTextFieldDefaults.colors(
                                focusedBorderColor = DoziTurquoise,
                                unfocusedBorderColor = VeryLightGray,
                                cursorColor = DoziTurquoise,
                                focusedContainerColor = Color(0xFFF9F9FB),
                                unfocusedContainerColor = Color(0xFFF9F9FB)
                            ),
                            singleLine = true,
                            isError = nameError,
                            placeholder = { Text("ƒ∞la√ß adƒ±nƒ± girin", color = MaterialTheme.colorScheme.onSurfaceVariant) }
                        )

                        if (nameError) ErrorCard("ƒ∞la√ß adƒ± bo≈ü bƒ±rakƒ±lamaz.")

                        // üîπ Stok
                        OutlinedTextField(
                            value = stock,
                            onValueChange = { newValue ->
                                if (newValue.isEmpty() || newValue.all { it.isDigit() }) {
                                    val num = newValue.toIntOrNull()
                                    if (num == null || num in 1..999) {
                                        stock = newValue
                                        stockError = newValue.isEmpty()
                                    }
                                }
                            },
                            label = { Text("Evde Ka√ß Adet Var? (1‚Äì999) *", color = MaterialTheme.colorScheme.onSurfaceVariant) },
                            leadingIcon = { Icon(Icons.Default.Inventory, null, tint = DoziCoralDark) },
                            modifier = Modifier
                                .fillMaxWidth()
                                .background(Color(0xFFF9F9FB), RoundedCornerShape(12.dp))
                                .padding(1.dp),
                            shape = RoundedCornerShape(12.dp),
                            colors = OutlinedTextFieldDefaults.colors(
                                focusedBorderColor = DoziBlue,
                                unfocusedBorderColor = VeryLightGray,
                                cursorColor = DoziBlue,
                                focusedContainerColor = Color(0xFFF9F9FB),
                                unfocusedContainerColor = Color(0xFFF9F9FB)
                            ),
                            singleLine = true,
                            keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number),
                            isError = stockError,
                            placeholder = { Text("√ñrn: 20 (ka√ß tablet/kaps√ºl var)", color = MaterialTheme.colorScheme.onSurfaceVariant) }
                        )

                        if (stockError) ErrorCard("Stok bilgisi ge√ßersiz.")

                        // üé® Custom medicine fields - Emoji ve Renk se√ßimi
                        if (isCustomMedicine) {
                            Spacer(Modifier.height(8.dp))

                            // Emoji Se√ßimi
                            Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                                Text(
                                    text = "ƒ∞kon Se√ß",
                                    style = MaterialTheme.typography.labelLarge,
                                    fontWeight = FontWeight.Medium,
                                    color = MaterialTheme.colorScheme.onSurface
                                )
                                LazyRow(
                                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                                ) {
                                    items(medicineEmojis) { emoji ->
                                        Surface(
                                            modifier = Modifier
                                                .size(48.dp)
                                                .clip(CircleShape)
                                                .border(
                                                    width = if (selectedEmoji == emoji) 2.dp else 1.dp,
                                                    color = if (selectedEmoji == emoji) DoziTurquoise else VeryLightGray,
                                                    shape = CircleShape
                                                )
                                                .clickable { selectedEmoji = emoji },
                                            color = if (selectedEmoji == emoji) DoziTurquoise.copy(alpha = 0.15f) else Color.Transparent
                                        ) {
                                            Box(contentAlignment = Alignment.Center) {
                                                Text(text = emoji, fontSize = 24.sp)
                                            }
                                        }
                                    }
                                }
                            }

                            // Renk Se√ßimi
                            Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                                Text(
                                    text = "Renk Kategorisi",
                                    style = MaterialTheme.typography.labelLarge,
                                    fontWeight = FontWeight.Medium,
                                    color = MaterialTheme.colorScheme.onSurface
                                )
                                LazyRow(
                                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                                ) {
                                    items(MedicineColor.entries.toList()) { color ->
                                        val colorValue = try {
                                            Color(android.graphics.Color.parseColor(color.hexColor))
                                        } catch (e: Exception) {
                                            DoziTurquoise
                                        }
                                        Surface(
                                            modifier = Modifier
                                                .size(48.dp)
                                                .clip(CircleShape)
                                                .border(
                                                    width = if (selectedColor == color) 3.dp else 1.dp,
                                                    color = if (selectedColor == color) colorValue else VeryLightGray,
                                                    shape = CircleShape
                                                )
                                                .clickable { selectedColor = color },
                                            color = colorValue.copy(alpha = 0.3f)
                                        ) {
                                            Box(contentAlignment = Alignment.Center) {
                                                if (selectedColor == color) {
                                                    Icon(
                                                        Icons.Default.Check,
                                                        contentDescription = null,
                                                        tint = colorValue,
                                                        modifier = Modifier.size(20.dp)
                                                    )
                                                } else {
                                                    Spacer(modifier = Modifier.size(0.dp))
                                                }

                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // Save button at bottom
            Surface(
                modifier = Modifier.fillMaxWidth(),
                shadowElevation = 8.dp,
                color = MaterialTheme.colorScheme.background
            ) {
                // üíæ Kaydet Butonu
                AnimatedVisibility(
                    visible = isVisible,
                    enter = slideInVertically(initialOffsetY = { 100 }) + fadeIn(),
                    modifier = Modifier.padding(horizontal = 20.dp, vertical = 16.dp)
                ) {
                    Button(
                        onClick = {
                        nameError = name.isBlank()
                        stockError = stock.isEmpty() || stock.toIntOrNull() == null

                        if (!nameError && !stockError) {
                            val newId = if (medicineId == "new") UUID.randomUUID().toString() else medicineId
                            val updated = LocalMedicine(newId, name.trim(), stock = stock.toInt())

                            // ƒ∞la√ß doƒürulama
                            val match = MedicineLookupRepository.findByNameOrIngredient(name)
                            if (match != null) {
                                Toast.makeText(
                                    context,
                                    "‚úÖ Doƒürulandƒ±: ${match.Product_Name}",
                                    Toast.LENGTH_LONG
                                ).show()
                            }

                            MedicineLookupRepository.saveLocalMedicine(context, updated)

                            // üî• Firestore'a da kaydet (stockCount ile)
                            kotlinx.coroutines.CoroutineScope(kotlinx.coroutines.Dispatchers.IO).launch {
                                try {
                                    val firestoreRepo = com.bardino.dozi.core.data.repository.MedicineRepository()
                                    // Mevcut Firestore ila√ß var mƒ± kontrol et
                                    val existingMedicine = firestoreRepo.getMedicineById(newId)

                                    if (existingMedicine != null) {
                                        // Mevcut ilacƒ± g√ºncelle
                                        var allSuccess = true

                                        // Temel alanlarƒ± g√ºncelle
                                        if (!firestoreRepo.updateMedicineField(newId, "stockCount", stock.toInt())) {
                                            allSuccess = false
                                        }
                                        if (!firestoreRepo.updateMedicineField(newId, "name", name.trim())) {
                                            allSuccess = false
                                        }

                                        // Custom medicine ise ek alanlarƒ± da g√ºncelle
                                        if (isCustomMedicine) {
                                            if (!firestoreRepo.updateMedicineField(newId, "color", selectedColor.name)) {
                                                allSuccess = false
                                            }
                                            if (!firestoreRepo.updateMedicineField(newId, "icon", selectedEmoji)) {
                                                allSuccess = false
                                            }
                                        }

                                        kotlinx.coroutines.withContext(kotlinx.coroutines.Dispatchers.Main) {
                                            if (allSuccess) {
                                                android.util.Log.d("MedicineEditScreen", "‚úÖ Firestore g√ºncellendi: $newId -> ${name.trim()}, stock: ${stock.toInt()}")
                                                if (isCustomMedicine) {
                                                    android.util.Log.d("MedicineEditScreen", "‚úÖ Custom fields g√ºncellendi: color=${selectedColor.name}, icon=$selectedEmoji")
                                                }
                                            } else {
                                                android.util.Log.e("MedicineEditScreen", "‚ùå Firestore g√ºncelleme kƒ±smen ba≈üarƒ±sƒ±z: $newId")
                                                Toast.makeText(context, "‚ö†Ô∏è Bazƒ± deƒüi≈üiklikler kaydedilemedi", Toast.LENGTH_LONG).show()
                                            }
                                            // Mevcut ila√ß g√ºncelleme - geri d√∂n
                                            onNavigateBack()
                                        }
                                    } else {
                                        // Yeni ila√ß olu≈ütur (temel bilgilerle)
                                        val firestoreMedicine = com.bardino.dozi.core.data.model.Medicine(
                                            id = "",
                                            name = name.trim(),
                                            stockCount = stock.toInt(),
                                            boxSize = stock.toInt(),
                                            reminderEnabled = false
                                        )
                                        val savedMedicineResult = firestoreRepo.addMedicine(firestoreMedicine)
                                        kotlinx.coroutines.withContext(kotlinx.coroutines.Dispatchers.Main) {
                                            if (savedMedicineResult != null) {
                                                android.util.Log.d("MedicineEditScreen", "‚úÖ Firestore'a yeni ila√ß eklendi: ${name.trim()} with id: ${savedMedicineResult.id}")
                                                // Yeni ila√ß eklendiyse hatƒ±rlatma dialog'unu g√∂ster - Firestore ID kullan
                                                if (medicineId == "new" && onNavigateToReminder != null) {
                                                    savedMedicineId = savedMedicineResult.id  // Firestore'dan d√∂nen ID'yi kullan
                                                    showReminderDialog = true
                                                } else {
                                                    onNavigateBack()
                                                }
                                            } else {
                                                android.util.Log.e("MedicineEditScreen", "‚ùå Firestore kayƒ±t ba≈üarƒ±sƒ±z: ${name.trim()}")
                                                Toast.makeText(context, "‚ö†Ô∏è ƒ∞la√ß yerel olarak kaydedildi ama sunucuya g√∂nderilemedi", Toast.LENGTH_LONG).show()
                                                // Firestore ba≈üarƒ±sƒ±z olsa da local ID ile devam et
                                                if (medicineId == "new" && onNavigateToReminder != null) {
                                                    savedMedicineId = newId
                                                    showReminderDialog = true
                                                } else {
                                                    onNavigateBack()
                                                }
                                            }
                                        }
                                    }
                                } catch (e: Exception) {
                                    android.util.Log.e("MedicineEditScreen", "‚ùå Firestore kayƒ±t hatasƒ±", e)
                                    kotlinx.coroutines.withContext(kotlinx.coroutines.Dispatchers.Main) {
                                        Toast.makeText(context, "‚ö†Ô∏è ƒ∞la√ß yerel olarak kaydedildi ama sunucu baƒülantƒ±sƒ± ba≈üarƒ±sƒ±z", Toast.LENGTH_LONG).show()
                                        // Hata durumunda da local ID ile devam et
                                        if (medicineId == "new" && onNavigateToReminder != null) {
                                            savedMedicineId = newId
                                            showReminderDialog = true
                                        } else {
                                            onNavigateBack()
                                        }
                                    }
                                }
                            }
                        }
                        },
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(58.dp)
                            .shadow(4.dp, RoundedCornerShape(16.dp)),
                        shape = RoundedCornerShape(16.dp),
                        colors = ButtonDefaults.buttonColors(containerColor = DoziTurquoise)
                    ) {
                        Icon(Icons.Default.Check, contentDescription = null, tint = Color.White)
                        Spacer(modifier = Modifier.width(8.dp))
                        Text(
                            text = if (medicineId == "new") "ƒ∞la√ß Ekle" else "Kaydet",
                            style = MaterialTheme.typography.titleMedium,
                            fontWeight = FontWeight.Bold,
                            color = Color.White
                        )
                    }
                }
            }
        }
    }

    // Hatƒ±rlatma ekleme dialog'u
    if (showReminderDialog && savedMedicineId != null) {
        AddReminderDialog(
            medicineName = name,
            onAddReminder = {
                showReminderDialog = false
                onNavigateToReminder?.invoke(savedMedicineId!!)
            },
            onDismiss = {
                showReminderDialog = false
                onNavigateBack()
            }
        )
    }
}

// Hatƒ±rlatma ekleme dialog'u
@Composable
private fun AddReminderDialog(
    medicineName: String,
    onAddReminder: () -> Unit,
    onDismiss: () -> Unit
) {
    AlertDialog(
        onDismissRequest = onDismiss,
        icon = {
            Icon(
                Icons.Default.Notifications,
                contentDescription = null,
                tint = DoziTurquoise,
                modifier = Modifier.size(48.dp)
            )
        },
        title = {
            Text(
                text = "Hatƒ±rlatma Ekle",
                fontWeight = FontWeight.Bold,
                style = MaterialTheme.typography.titleLarge
            )
        },
        text = {
            Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                Text(
                    text = "$medicineName i√ßin bir hatƒ±rlatma kurmak ister misin?",
                    style = MaterialTheme.typography.bodyLarge
                )
                Spacer(modifier = Modifier.height(8.dp))
                Text(
                    text = "Hatƒ±rlatma kurarak ila√ßlarƒ±nƒ± d√ºzenli alabilirsin!",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        },
        confirmButton = {
            Button(
                onClick = onAddReminder,
                colors = ButtonDefaults.buttonColors(containerColor = DoziTurquoise)
            ) {
                Icon(Icons.Default.Add, contentDescription = null)
                Spacer(Modifier.width(8.dp))
                Text("Evet, Ekle", fontWeight = FontWeight.Bold)
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text("≈ûimdi Deƒüil", color = MaterialTheme.colorScheme.onSurfaceVariant)
            }
        }
    )
}

// --------------------------------------------------------------------
// üß† OCR Metin Analizi
// --------------------------------------------------------------------
private fun extractMedicineInfo(lines: List<String>, mergedRaw: String): Triple<String, String, String> {
    val forbidden = setOf("tablet", "kaps√ºl", "ampul", "flakon", "draje", "adet", "kutu", "mg", "ml", "¬µg", "mcg", "gr", "g", "iu", "film")

    fun normalize(s: String) = s.replace("\n", " ").replace(Regex("\\s+"), " ").replace(",", " ").trim()

    val merged = normalize(mergedRaw).lowercase()
    val normLines = lines.map { normalize(it).lowercase() }

    val dosageRx = Regex("""(\d{1,4}(?:[.,]\d{1,2})?)\s*(mg|ml|¬µg|mcg|gr|g|iu)\b""")
    val stockRx = Regex("""(\d{1,3})\s*(tablet|kaps√ºl|ampul|flakon|draje|adet|kutu)\b""")

    val dosage = normLines.firstNotNullOfOrNull { dosageRx.find(it)?.value }
        ?: dosageRx.find(merged)?.value ?: ""
    val stock = normLines.firstNotNullOfOrNull { stockRx.find(it)?.groupValues?.get(1) }
        ?: stockRx.find(merged)?.groupValues?.get(1) ?: ""

    val nameCandidates = merged.split(" ").filter {
        it.length > 2 && it !in forbidden && it.any { c -> c.isLetter() }
    }
    val name = nameCandidates.firstOrNull()?.capitalizeFirst() ?: ""

    return Triple(name, dosage, stock)
}

// --------------------------------------------------------------------
// UI Yardƒ±mcƒ±larƒ±
// --------------------------------------------------------------------
private fun String.capitalizeFirst(): String =
    if (isEmpty()) this else this[0].uppercase() + substring(1)

@Composable
private fun ErrorCard(message: String) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .background(ErrorRed.copy(alpha = 0.08f), RoundedCornerShape(8.dp))
            .padding(10.dp),
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        Icon(Icons.Default.Warning, contentDescription = null, tint = ErrorRed)
        Text(
            message,
            color = ErrorRed,
            style = MaterialTheme.typography.bodySmall.copy(fontWeight = FontWeight.Medium)
        )
    }
}
// ============================================================================
// FILE: MedicineListScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/medicine/MedicineListScreen.kt
// [81 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.medicine

import android.widget.Toast
import androidx.compose.animation.*
import androidx.compose.animation.core.animateFloatAsState
import androidx.compose.foundation.*
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.AssistChipDefaults
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.window.Dialog
import com.bardino.dozi.R
import com.bardino.dozi.core.data.model.Medicine
import com.bardino.dozi.core.data.repository.MedicineRepository
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*
import kotlinx.coroutines.launch

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MedicineListScreen(
    onNavigateBack: () -> Unit,
    onNavigateToDetail: (String) -> Unit,
    onNavigateToAddMedicine: (String) -> Unit = {},
    onNavigateToAddReminder: ((String) -> Unit)? = null,
    onNavigateToReminderDetail: ((String) -> Unit)? = null,
    showAddButton: Boolean = true
) {
    val context = LocalContext.current
    val scope = rememberCoroutineScope()
    var medicines by remember { mutableStateOf<List<Medicine>>(emptyList()) }
    var isVisible by remember { mutableStateOf(false) }

    // ‚úÖ Firestore'dan t√ºm ila√ßlarƒ± y√ºkle (payla≈üƒ±mlƒ± - t√ºm profiller)
    LaunchedEffect(Unit) {
        isVisible = true
        while (true) {
            try {
                val medicineRepository = MedicineRepository()
                medicines = medicineRepository.getAllMedicines()
                android.util.Log.d("MedicineListScreen", "‚úÖ Loaded ${medicines.size} medicines from Firestore")
                // üîç Her ilacƒ±n hatƒ±rlatma bilgilerini logla
                medicines.forEach { med ->
                    android.util.Log.d("MedicineListScreen", "üìã ${med.name}: reminderEnabled=${med.reminderEnabled}, times=${med.times.joinToString(", ")}, frequency=${med.frequency}")
                }
            } catch (e: Exception) {
                android.util.Log.e("MedicineListScreen", "‚ùå Error loading medicines", e)
            }
            kotlinx.coroutines.delay(3000) // Refresh every 3 seconds
        }
    }

    Scaffold(
        topBar = {
            DoziTopBar(
                title = "ƒ∞la√ßlarƒ±m",
                canNavigateBack = false,
                backgroundColor = Color.Transparent,
                actions = {
                    Surface(
                        shape = CircleShape,
                        color = DoziCoralLight.copy(alpha = 0.15f),
                        modifier = Modifier.padding(end = 8.dp)
                    ) {
                        IconButton(
                            onClick = { onNavigateToAddMedicine("lookup") }
                        ) {
                            Icon(
                                imageVector = Icons.Default.AddCircleOutline,
                                contentDescription = "Yeni ƒ∞la√ß Ekle",
                                tint = DoziCoralDark
                            )
                        }
                    }
                }
            )
        },
        floatingActionButton = {
            FloatingActionButton(
                onClick = { onNavigateToAddMedicine("new") },
                containerColor = DoziTurquoise,
                contentColor = Color.White,
                shape = RoundedCornerShape(16.dp),
                modifier = Modifier.shadow(12.dp, RoundedCornerShape(16.dp))
            ) {
                Icon(
                    Icons.Default.Add,
                    contentDescription = "ƒ∞la√ß Ekle",
                    modifier = Modifier.size(28.dp)
                )
            }
        },
        containerColor = MaterialTheme.colorScheme.background
    ) { padding ->

        if (medicines.isEmpty()) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding),
                contentAlignment = Alignment.Center
            ) {
                EmptyMedicineState(onAddMedicine = { onNavigateToAddMedicine("new") })
            }
        } else {
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding)
            ) {
                // √úst Bilgi Alanƒ±
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .background(
                            brush = Brush.horizontalGradient(
                                colors = listOf(
                                    DoziTurquoise,
                                    DoziBlue
                                )
                            ),
                            shape = RoundedCornerShape(bottomStart = 24.dp, bottomEnd = 24.dp)
                        )
                        .padding(horizontal = 20.dp, vertical = 18.dp)
                ) {
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Column(
                            verticalArrangement = Arrangement.spacedBy(4.dp)
                        ) {
                            Text(
                                text = "ƒ∞la√ßlarƒ±m",
                                color = Color.White,
                                style = MaterialTheme.typography.titleLarge,
                                fontWeight = FontWeight.Bold
                            )
                            Text(
                                text = "${medicines.size} ila√ß kaydedildi",
                                color = Color.White.copy(alpha = 0.9f),
                                style = MaterialTheme.typography.bodyMedium
                            )
                        }
                    }
                }

                Spacer(Modifier.height(16.dp))

                // ƒ∞la√ß Listesi
                LazyColumn(
                    contentPadding = PaddingValues(horizontal = 20.dp, vertical = 12.dp),
                    verticalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    items(medicines, key = { it.id }) { medicine ->
                        var dismissed by remember { mutableStateOf(false) }
                        var showDeleteConfirm by remember { mutableStateOf(false) }

                        AnimatedVisibility(
                            visible = isVisible && !dismissed,
                            enter = fadeIn() + slideInVertically(initialOffsetY = { 40 })
                        ) {
                            val dismissState = rememberSwipeToDismissBoxState(
                                confirmValueChange = { value ->
                                    when (value) {
                                        SwipeToDismissBoxValue.StartToEnd -> {
                                            showDeleteConfirm = true
                                            false
                                        }
                                        SwipeToDismissBoxValue.EndToStart -> {
                                            onNavigateToDetail(medicine.id)
                                            false
                                        }
                                        else -> false
                                    }
                                }
                            )

                            SwipeToDismissBox(
                                state = dismissState,
                                backgroundContent = {
                                    val direction = dismissState.targetValue
                                    val bgColor = when (direction) {
                                        SwipeToDismissBoxValue.StartToEnd -> DoziRed.copy(alpha = 0.15f)
                                        SwipeToDismissBoxValue.EndToStart -> DoziTurquoise.copy(alpha = 0.15f)
                                        else -> Color.Transparent
                                    }
                                    val iconColor = when (direction) {
                                        SwipeToDismissBoxValue.StartToEnd -> DoziRed
                                        SwipeToDismissBoxValue.EndToStart -> DoziTurquoise
                                        else -> Color.Transparent
                                    }
                                    val icon = when (direction) {
                                        SwipeToDismissBoxValue.StartToEnd -> Icons.Default.Delete
                                        SwipeToDismissBoxValue.EndToStart -> Icons.Default.Edit
                                        else -> null
                                    }

                                    Box(
                                        modifier = Modifier
                                            .fillMaxSize()
                                            .background(bgColor, shape = RoundedCornerShape(20.dp))
                                            .padding(horizontal = 24.dp),
                                        contentAlignment = when (direction) {
                                            SwipeToDismissBoxValue.StartToEnd -> Alignment.CenterStart
                                            SwipeToDismissBoxValue.EndToStart -> Alignment.CenterEnd
                                            else -> Alignment.Center
                                        }
                                    ) {
                                        icon?.let {
                                            Surface(
                                                modifier = Modifier.size(48.dp),
                                                color = iconColor.copy(alpha = 0.2f),
                                                shape = CircleShape
                                            ) {
                                                Box(contentAlignment = Alignment.Center) {
                                                    Icon(
                                                        imageVector = it,
                                                        contentDescription = null,
                                                        tint = iconColor,
                                                        modifier = Modifier.size(26.dp)
                                                    )
                                                }
                                            }
                                        }
                                    }
                                },
                                enableDismissFromStartToEnd = true,
                                enableDismissFromEndToStart = true,
                                content = {
                                    ModernMedicineCard(
                                        medicine = medicine,
                                        onClick = { onNavigateToDetail(medicine.id) },
                                        onEdit = { onNavigateToDetail(medicine.id) },
                                        onDelete = { showDeleteConfirm = true },
                                        onAddReminder = { onNavigateToAddReminder?.invoke(medicine.id) }
                                    )
                                }
                            )

                            if (showDeleteConfirm) {
                                DeleteConfirmDialog(
                                    medicineName = medicine.name,
                                    onConfirm = {
                                        scope.launch {
                                            try {
                                                val medicineRepository = MedicineRepository()
                                                medicineRepository.deleteMedicine(medicine.id)
                                                Toast.makeText(
                                                    context,
                                                    "${medicine.name} silindi",
                                                    Toast.LENGTH_SHORT
                                                ).show()
                                                showDeleteConfirm = false
                                                dismissed = true
                                            } catch (e: Exception) {
                                                Toast.makeText(
                                                    context,
                                                    "Silme i≈ülemi ba≈üarƒ±sƒ±z: ${e.message}",
                                                    Toast.LENGTH_SHORT
                                                ).show()
                                            }
                                        }
                                    },
                                    onDismiss = { showDeleteConfirm = false }
                                )
                            }
                        }
                    }

                    item { Spacer(Modifier.height(100.dp)) }
                }
            }
        }
    }
}

@Composable
fun ModernMedicineCard(
    medicine: Medicine,
    onClick: () -> Unit,
    onEdit: () -> Unit = {},
    onDelete: () -> Unit = {},
    onAddReminder: () -> Unit = {}
) {
    var expanded by remember { mutableStateOf(false) }
    val rotationAngle by animateFloatAsState(
        targetValue = if (expanded) 180f else 0f,
        label = "rotation"
    )

    Card(
        modifier = Modifier
            .fillMaxWidth()
            .shadow(8.dp, RoundedCornerShape(24.dp)),
        shape = RoundedCornerShape(24.dp),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        elevation = CardDefaults.cardElevation(defaultElevation = 0.dp),
        onClick = onClick
    ) {
        Column {
            // √úst renkli ≈üerit - ƒ∞lacƒ±n rengini kullan
            val medicineColor = try {
                Color(android.graphics.Color.parseColor(medicine.color.hexColor))
            } catch (e: Exception) {
                DoziTurquoise
            }
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .height(8.dp)
                    .background(
                        brush = Brush.horizontalGradient(
                            listOf(
                                medicineColor.copy(alpha = 0.8f),
                                medicineColor.copy(alpha = 0.5f)
                            )
                        ),
                        shape = RoundedCornerShape(topStart = 24.dp, topEnd = 24.dp)
                    )
            )

            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 20.dp, vertical = 20.dp),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.Top
                ) {
                    Column(
                        modifier = Modifier.weight(1f),
                        verticalArrangement = Arrangement.spacedBy(6.dp)
                    ) {
                        Text(
                            text = medicine.name,
                            style = MaterialTheme.typography.titleLarge,
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.onSurface
                        )
                        Text(
                            text = medicine.dosage,
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant,
                            fontWeight = FontWeight.Medium
                        )
                    }

                    Surface(
                        shape = CircleShape,
                        color = DoziTurquoise.copy(alpha = 0.1f)
                    ) {
                        Box(
                            modifier = Modifier.padding(10.dp),
                            contentAlignment = Alignment.Center
                        ) {
                            Icon(
                                Icons.Default.ChevronRight,
                                contentDescription = null,
                                tint = DoziTurquoise,
                                modifier = Modifier.size(24.dp)
                            )
                        }
                    }
                }

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(10.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    InfoTag(
                        Icons.Default.Inventory,
                        "Stok: ${medicine.stockCount}",
                        when {
                            medicine.stockCount < 5 -> DoziRed
                            medicine.stockCount < 10 -> WarningOrange
                            else -> SuccessGreen
                        }
                    )
                }

                // Hatƒ±rlatma bilgileri (varsa) - Geli≈ütirilmi≈ü versiyon
                HorizontalDivider(
                    modifier = Modifier.padding(vertical = 8.dp),
                    color = Gray200
                )

                val hasReminderTimes = medicine.times.any { it.isNotBlank() }

                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .background(
                            brush = Brush.horizontalGradient(
                                listOf(
                                    if (hasReminderTimes) DoziCoral.copy(alpha = 0.05f) else Gray200.copy(alpha = 0.3f),
                                    if (hasReminderTimes) DoziTurquoise.copy(alpha = 0.05f) else Gray200.copy(alpha = 0.3f),
                                    if (medicine.times.any { it.isNotBlank() }) DoziCoral.copy(alpha = 0.05f) else Gray200.copy(alpha = 0.3f),
                                    if (medicine.times.any { it.isNotBlank() }) DoziTurquoise.copy(alpha = 0.05f) else Gray200.copy(alpha = 0.3f)
                                )
                            ),
                            shape = RoundedCornerShape(12.dp)
                        )
                        .padding(12.dp),
                    verticalArrangement = Arrangement.spacedBy(10.dp)
                ) {
                    Row(
                        horizontalArrangement = Arrangement.spacedBy(8.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        val hasReminderTimes = medicine.times.any { it.isNotBlank() }
                        Surface(
                            color = if (hasReminderTimes) DoziCoral.copy(alpha = 0.2f) else Gray400.copy(alpha = 0.2f),
                            shape = CircleShape,
                            modifier = Modifier.size(28.dp)
                        ) {
                            Box(contentAlignment = Alignment.Center) {
                                Icon(
                                    if (hasReminderTimes) Icons.Default.Notifications else Icons.Default.NotificationsOff,
                                    contentDescription = null,
                                    tint = if (hasReminderTimes) DoziCoral else Gray400,
                                    modifier = Modifier.size(16.dp)
                                )
                            }
                        }
                        Text(
                            text = "Hatƒ±rlatmalar",
                            style = MaterialTheme.typography.titleSmall,
                            fontWeight = FontWeight.Bold,
                            color = if (hasReminderTimes) DoziCoral else Gray600
                        )
                    }

                    if (hasReminderTimes) {
                        // Hatƒ±rlatma saatleri - chip formatƒ±nda
                        Column(
                            verticalArrangement = Arrangement.spacedBy(6.dp)
                        ) {
                            Row(
                                horizontalArrangement = Arrangement.spacedBy(6.dp),
                                verticalAlignment = Alignment.CenterVertically
                            ) {
                                Icon(
                                    Icons.Default.Schedule,
                                    contentDescription = null,
                                    tint = DoziTurquoise,
                                    modifier = Modifier.size(16.dp)
                                )
                                Text(
                                    text = "Saatler:",
                                    style = MaterialTheme.typography.labelMedium,
                                    fontWeight = FontWeight.Bold,
                                    color = Gray700
                                )
                            }

                            Row(
                                modifier = Modifier.fillMaxWidth(),
                                horizontalArrangement = Arrangement.spacedBy(6.dp)
                            ) {
                                medicine.times.take(4).forEach { time ->
                                    Surface(
                                        color = DoziTurquoise.copy(alpha = 0.15f),
                                        shape = RoundedCornerShape(8.dp),
                                        border = BorderStroke(1.dp, DoziTurquoise.copy(alpha = 0.3f))
                                    ) {
                                        Text(
                                            text = time,
                                            style = MaterialTheme.typography.labelMedium,
                                            fontWeight = FontWeight.Bold,
                                            color = DoziTurquoise,
                                            modifier = Modifier.padding(horizontal = 10.dp, vertical = 4.dp)
                                        )
                                    }
                                }
                                if (medicine.times.size > 4) {
                                    Surface(
                                        color = Gray200,
                                        shape = RoundedCornerShape(8.dp)
                                    ) {
                                        Text(
                                            text = "+${medicine.times.size - 4}",
                                            style = MaterialTheme.typography.labelSmall,
                                            color = Gray700,
                                            modifier = Modifier.padding(horizontal = 8.dp, vertical = 4.dp)
                                        )
                                    }
                                }
                            }
                        }

                        // Sƒ±klƒ±k bilgisi
                        Row(
                            horizontalArrangement = Arrangement.spacedBy(8.dp),
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Icon(
                                Icons.Default.CalendarToday,
                                contentDescription = null,
                                tint = DoziCoral,
                                modifier = Modifier.size(16.dp)
                            )
                            Text(
                                text = medicine.frequency,
                                style = MaterialTheme.typography.bodyMedium,
                                fontWeight = FontWeight.Medium,
                                color = Gray900
                            )

                            if (!medicine.reminderEnabled) {
                                AssistChip(
                                    onClick = {},
                                    label = {
                                        Text(
                                            text = "Bildirim kapalƒ±",
                                            color = DoziCoral,
                                            style = MaterialTheme.typography.labelMedium
                                        )
                                    },
                                    leadingIcon = {
                                        Icon(
                                            imageVector = Icons.Default.NotificationsOff,
                                            contentDescription = null,
                                            tint = DoziCoral,
                                            modifier = Modifier.size(14.dp)
                                        )
                                    },
                                    colors = AssistChipDefaults.assistChipColors(
                                        containerColor = DoziCoral.copy(alpha = 0.08f)
                                    ),
                                    border = BorderStroke(
                                        width = 1.dp,
                                        color = DoziCoral.copy(alpha = 0.4f)
                                    )
                                )
                            }
                        }
                    } else {
                        // Hatƒ±rlatma yoksa bilgilendirme g√∂ster ve ekle butonu ekle
                        Column(
                            verticalArrangement = Arrangement.spacedBy(12.dp)
                        ) {
                            val reminderMessage = when {
                                !medicine.reminderEnabled && medicine.times.isEmpty() -> "Hatƒ±rlatmalar devre dƒ±≈üƒ±"
                                medicine.reminderEnabled && medicine.times.isEmpty() -> "Hen√ºz hatƒ±rlatma eklenmemi≈ü"
                                else -> "Hatƒ±rlatma bilgisi senkronize ediliyor"
                            }
                            Text(
                                text = reminderMessage,
                                style = MaterialTheme.typography.bodyMedium,
                                color = Gray600,
                                fontWeight = FontWeight.Medium
                            )

                            // Hatƒ±rlatma Ekle butonu
                            Button(
                                onClick = onAddReminder,
                                modifier = Modifier
                                    .fillMaxWidth()
                                    .height(44.dp),
                                colors = ButtonDefaults.buttonColors(
                                    containerColor = DoziCoral
                                ),
                                shape = RoundedCornerShape(12.dp),
                                elevation = ButtonDefaults.buttonElevation(
                                    defaultElevation = 2.dp
                                )
                            ) {
                                Icon(
                                    Icons.Default.Add,
                                    contentDescription = null,
                                    modifier = Modifier.size(18.dp)
                                )
                                Spacer(Modifier.width(8.dp))
                                Text(
                                    text = "Hatƒ±rlatma Ekle",
                                    fontWeight = FontWeight.Bold,
                                    style = MaterialTheme.typography.labelLarge
                                )
                            }
                        }
                    }
                }
            }
        }
    }
}

@Composable
private fun ReminderListItem(
    reminder: com.bardino.dozi.core.data.model.Medicine,
    onClick: () -> Unit
) {
    Surface(
        modifier = Modifier
            .fillMaxWidth()
            .clickable(onClick = onClick),
        shape = RoundedCornerShape(12.dp),
        color = Color.White,
        shadowElevation = 2.dp
    ) {
        Row(
            modifier = Modifier.padding(12.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Column(
                verticalArrangement = Arrangement.spacedBy(4.dp),
                modifier = Modifier.weight(1f)
            ) {
                Row(
                    horizontalArrangement = Arrangement.spacedBy(8.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(
                        Icons.Default.Schedule,
                        contentDescription = null,
                        tint = DoziCoral,
                        modifier = Modifier.size(16.dp)
                    )
                    Text(
                        text = reminder.times.joinToString(", "),
                        style = MaterialTheme.typography.bodyMedium,
                        fontWeight = FontWeight.Bold,
                        color = Gray900
                    )
                }

                Text(
                    text = "${reminder.dosage} ${reminder.unit} ‚Ä¢ ${reminder.frequency}",
                    style = MaterialTheme.typography.bodySmall,
                    color = Gray600
                )
            }

            Icon(
                Icons.Default.ChevronRight,
                contentDescription = null,
                tint = Gray400,
                modifier = Modifier.size(20.dp)
            )
        }
    }
}

@Composable
private fun InfoTag(
    icon: androidx.compose.ui.graphics.vector.ImageVector,
    text: String,
    color: Color
) {
    Surface(
        color = color.copy(alpha = 0.15f),
        shape = RoundedCornerShape(12.dp),
        border = BorderStroke(1.dp, color.copy(alpha = 0.3f)),
        modifier = Modifier.fillMaxWidth()
    ) {
        Row(
            modifier = Modifier.padding(horizontal = 14.dp, vertical = 10.dp),
            horizontalArrangement = Arrangement.spacedBy(8.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Icon(
                icon,
                null,
                tint = color,
                modifier = Modifier.size(18.dp)
            )
            Text(
                text = text,
                color = color,
                style = MaterialTheme.typography.labelLarge,
                fontWeight = FontWeight.Bold
            )
        }
    }
}

@Composable
private fun EmptyMedicineState(
    onAddMedicine: () -> Unit
) {
    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(32.dp),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        Image(
            painter = painterResource(id = R.drawable.dozi_idea),
            contentDescription = null,
            modifier = Modifier.size(140.dp)
        )

        Spacer(Modifier.height(24.dp))

        Text(
            text = "Hen√ºz ƒ∞la√ß Eklemediniz",
            style = MaterialTheme.typography.headlineSmall,
            fontWeight = FontWeight.Bold,
            color = MaterialTheme.colorScheme.onSurface,
            textAlign = TextAlign.Center
        )

        Spacer(Modifier.height(12.dp))

        Text(
            text = "ƒ∞la√ßlarƒ±nƒ±zƒ± ekleyerek takibini kolayla≈ütƒ±rƒ±n ve asla unutmayƒ±n!",
            style = MaterialTheme.typography.bodyLarge,
            color = MaterialTheme.colorScheme.onSurfaceVariant,
            textAlign = TextAlign.Center
        )

        Spacer(Modifier.height(40.dp))

        Button(
            onClick = onAddMedicine,
            shape = RoundedCornerShape(20.dp),
            colors = ButtonDefaults.buttonColors(
                containerColor = DoziCoralDark
            ),
            modifier = Modifier
                .fillMaxWidth(0.8f)
                .height(56.dp),
            elevation = ButtonDefaults.buttonElevation(6.dp)
        ) {
            Icon(
                Icons.Default.Add,
                contentDescription = null,
                modifier = Modifier.size(24.dp)
            )
            Spacer(Modifier.width(12.dp))
            Text(
                "ƒ∞lk ƒ∞lacƒ±nƒ± Ekle",
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.Bold,
                fontSize = 16.sp
            )
        }
    }
}

@Composable
private fun DeleteConfirmDialog(
    medicineName: String,
    onConfirm: () -> Unit,
    onDismiss: () -> Unit
) {
    Dialog(onDismissRequest = onDismiss) {
        Surface(
            shape = RoundedCornerShape(28.dp),
            color = Color.White,
            shadowElevation = 8.dp
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(28.dp),
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(20.dp)
            ) {
                Surface(
                    modifier = Modifier.size(72.dp),
                    color = DoziRed.copy(alpha = 0.15f),
                    shape = CircleShape
                ) {
                    Box(contentAlignment = Alignment.Center) {
                        Icon(
                            Icons.Default.Warning,
                            contentDescription = null,
                            tint = DoziRed,
                            modifier = Modifier.size(40.dp)
                        )
                    }
                }

                Column(
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    Text(
                        text = "ƒ∞lacƒ± Sil?",
                        style = MaterialTheme.typography.headlineSmall,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface
                    )

                    Text(
                        text = "$medicineName ilacƒ±nƒ± silmek istediƒüinize emin misiniz?",
                        style = MaterialTheme.typography.bodyLarge,
                        color = MaterialTheme.colorScheme.onSurfaceVariant,
                        textAlign = TextAlign.Center
                    )
                }

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    OutlinedButton(
                        onClick = onDismiss,
                        modifier = Modifier
                            .weight(1f)
                            .height(50.dp),
                        shape = RoundedCornerShape(14.dp),
                        border = BorderStroke(2.dp, VeryLightGray)
                    ) {
                        Text(
                            "ƒ∞ptal",
                            style = MaterialTheme.typography.titleSmall,
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }

                    Button(
                        onClick = onConfirm,
                        modifier = Modifier
                            .weight(1f)
                            .height(50.dp),
                        shape = RoundedCornerShape(14.dp),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = DoziRed
                        )
                    ) {
                        Icon(
                            Icons.Default.Delete,
                            contentDescription = null,
                            modifier = Modifier.size(20.dp)
                        )
                        Spacer(Modifier.width(8.dp))
                        Text(
                            "Sil",
                            style = MaterialTheme.typography.titleSmall,
                            fontWeight = FontWeight.Bold
                        )
                    }
                }
            }
        }
    }
}

// ============================================================================
// FILE: MedicineLookupScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/medicine/MedicineLookupScreen.kt
// [82 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.medicine

import android.Manifest
import android.content.Intent
import android.os.Parcelable
import android.speech.RecognizerIntent
import android.widget.Toast
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.KeyboardActions
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalFocusManager
import androidx.compose.ui.platform.LocalSoftwareKeyboardController
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.input.ImeAction
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.window.Dialog
import androidx.navigation.NavController
import com.bardino.dozi.core.data.Ilac
import com.bardino.dozi.core.data.IlacJsonRepository
import com.bardino.dozi.core.data.IlacSearchResult
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*
import com.bardino.dozi.navigation.Screen
import com.google.mlkit.vision.barcode.common.Barcode
import com.google.mlkit.vision.codescanner.GmsBarcodeScanner
import com.google.mlkit.vision.codescanner.GmsBarcodeScannerOptions
import com.google.mlkit.vision.codescanner.GmsBarcodeScanning
import kotlinx.coroutines.delay
import kotlinx.parcelize.Parcelize
import kotlinx.parcelize.RawValue

@Parcelize
data class IlacSearchResultParcelable(
    val item: @RawValue Ilac,
    val dosage: String? = null
) : Parcelable

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MedicineLookupScreen(
    navController: NavController,
    onNavigateBack: () -> Unit,
    modifier: Modifier = Modifier
) {
    val context = LocalContext.current
    val keyboardController = LocalSoftwareKeyboardController.current
    val focusManager = LocalFocusManager.current
    var query by remember { mutableStateOf("") }
    var results by remember { mutableStateOf<List<IlacSearchResult>>(emptyList()) }
    var selected by remember { mutableStateOf<IlacSearchResult?>(null) }
    var showDetail by remember { mutableStateOf(false) }
    var isSearching by remember { mutableStateOf(false) }
    var searchMode by remember { mutableStateOf("text") } // "text", "barcode", "voice"

    // Cache durumunu kontrol et
    LaunchedEffect(Unit) {
        if (!com.bardino.dozi.core.data.MedicineLookupRepository.isInitialized()) {
            android.util.Log.w("MedicineLookupScreen", "‚ö†Ô∏è Medicine repository not initialized on screen load!")
            com.bardino.dozi.core.data.MedicineLookupRepository.initialize(context)
        } else {
            val cacheSize = com.bardino.dozi.core.data.MedicineLookupRepository.ilaclarCache?.size ?: 0
            android.util.Log.d("MedicineLookupScreen", "‚úÖ Medicine cache loaded: $cacheSize medicines")

            if (cacheSize == 0) {
                android.util.Log.e("MedicineLookupScreen", "‚ùå Medicine cache is empty! Reinitializing...")
                // Force reinitialize
                com.bardino.dozi.core.data.MedicineLookupRepository.initialize(context)
            }
        }
    }

    // ‚úÖ Barkod Tarayƒ±cƒ±
    val barcodeOptions = GmsBarcodeScannerOptions.Builder()
        .setBarcodeFormats(Barcode.FORMAT_EAN_13, Barcode.FORMAT_EAN_8)
        .build()

    val barcodeScanner = remember { GmsBarcodeScanning.getClient(context, barcodeOptions) }

    // Ses tanƒ±ma
    val voiceLauncher = rememberLauncherForActivityResult(
        ActivityResultContracts.StartActivityForResult()
    ) { result ->
        result.data?.getStringArrayListExtra(RecognizerIntent.EXTRA_RESULTS)
            ?.firstOrNull()?.let {
                query = it
                searchMode = "text"
                Toast.makeText(context, "üéôÔ∏è \"$it\" algƒ±landƒ±", Toast.LENGTH_SHORT).show()
            }
    }

    val micPermissionLauncher = rememberLauncherForActivityResult(
        ActivityResultContracts.RequestPermission()
    ) { granted ->
        if (granted) {
            val intent = Intent(RecognizerIntent.ACTION_RECOGNIZE_SPEECH).apply {
                putExtra(
                    RecognizerIntent.EXTRA_LANGUAGE_MODEL,
                    RecognizerIntent.LANGUAGE_MODEL_FREE_FORM
                )
                putExtra(RecognizerIntent.EXTRA_LANGUAGE, "tr-TR")
                putExtra(RecognizerIntent.EXTRA_PROMPT, "ƒ∞la√ß adƒ±nƒ± s√∂yleyin")
            }
            voiceLauncher.launch(intent)
        } else Toast.makeText(context, "Mikrofon izni gerekli", Toast.LENGTH_SHORT).show()
    }

    // ‚úÖ Barkod Tarama Fonksiyonu
    fun startBarcodeScanning() {
        isSearching = true
        searchMode = "barcode"
        barcodeScanner.startScan()
            .addOnSuccessListener { barcode ->
                val rawValue = barcode.rawValue
                if (rawValue != null) {
                    Toast.makeText(context, "üì¶ Barkod: $rawValue", Toast.LENGTH_SHORT).show()
                    // Barkoda g√∂re arama yap
                    val foundMedicine = IlacJsonRepository.searchByBarcode(context, rawValue)
                    if (foundMedicine != null) {
                        results = listOf(IlacSearchResult(foundMedicine, foundMedicine.Product_Name))
                        query = foundMedicine.Product_Name ?: rawValue
                    } else {
                        Toast.makeText(context, "‚ùå Barkod bulunamadƒ±: $rawValue", Toast.LENGTH_LONG).show()
                        query = rawValue
                    }
                } else {
                    Toast.makeText(context, "Barkod okunamadƒ±", Toast.LENGTH_SHORT).show()
                }
                isSearching = false
                searchMode = "text"
            }
            .addOnCanceledListener {
                Toast.makeText(context, "Tarama iptal edildi", Toast.LENGTH_SHORT).show()
                isSearching = false
                searchMode = "text"
            }
            .addOnFailureListener { e ->
                Toast.makeText(context, "Barkod okuma hatasƒ±: ${e.message}", Toast.LENGTH_SHORT).show()
                isSearching = false
                searchMode = "text"
            }
    }

    // Debounce arama
    LaunchedEffect(query) {
        if (searchMode == "text" && query.length >= 2) {
            isSearching = true
            delay(700)

            // √ñnce initialize kontrol√º yap
            if (!com.bardino.dozi.core.data.MedicineLookupRepository.isInitialized()) {
                android.util.Log.w("MedicineLookupScreen", "Repository not initialized, initializing now...")
                com.bardino.dozi.core.data.MedicineLookupRepository.initialize(context)
            }

            results = IlacJsonRepository.search(context, query)
            android.util.Log.d("MedicineLookupScreen", "Search completed for '$query': ${results.size} results")
            isSearching = false
        } else if (query.isEmpty()) {
            results = emptyList()
        }
    }

    Scaffold(
        modifier = modifier,
        topBar = {
            DoziTopBar(
                title = "ƒ∞la√ß Arama",
                canNavigateBack = true,
                onNavigateBack = onNavigateBack,
                actions = {
                    // ‚úÖ Ses Butonu
                    IconButton(
                        onClick = { micPermissionLauncher.launch(Manifest.permission.RECORD_AUDIO) },
                        modifier = Modifier
                            .size(44.dp)
                            .background(DoziTurquoise.copy(alpha = 0.1f), shape = CircleShape)
                    ) {
                        Icon(Icons.Default.Mic, null, tint = DoziCoral)
                    }

                    Spacer(Modifier.width(8.dp))

                    // ‚úÖ Barkod Butonu
                    IconButton(
                        onClick = { startBarcodeScanning() },
                        modifier = Modifier
                            .size(44.dp)
                            .background(DoziCoral.copy(alpha = 0.1f), shape = CircleShape)
                    ) {
                        Icon(Icons.Default.QrCodeScanner, null, tint = DoziCoral)
                    }
                }
            )
        },
        containerColor = MaterialTheme.colorScheme.background
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .padding(horizontal = 16.dp, vertical = 8.dp)
                .pointerInput(Unit) {
                    detectTapGestures(onTap = {
                        focusManager.clearFocus()
                        keyboardController?.hide()
                    })
                },
            horizontalAlignment = Alignment.CenterHorizontally
        ) {

            // Arama kartƒ±
            Card(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(top = 12.dp),
                colors = CardDefaults.cardColors(containerColor = Color.White),
                shape = MaterialTheme.shapes.large,
                elevation = CardDefaults.cardElevation(6.dp)
            ) {
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(20.dp),
                    verticalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    OutlinedTextField(
                        value = query,
                        onValueChange = {
                            query = it
                            searchMode = "text"
                        },
                        modifier = Modifier.fillMaxWidth(),
                        placeholder = {
                            Text("ƒ∞la√ß adƒ±, barkod veya etken madde...", color = MaterialTheme.colorScheme.onSurfaceVariant)
                        },
                        leadingIcon = {
                            Icon(
                                if (searchMode == "barcode") Icons.Default.QrCodeScanner else Icons.Default.Search,
                                null,
                                tint = if (searchMode == "barcode") DoziCoral else DoziTurquoise
                            )
                        },
                        trailingIcon = {
                            if (query.isNotBlank()) {
                                IconButton(onClick = {
                                    query = ""
                                    searchMode = "text"
                                }) {
                                    Icon(Icons.Default.Clear, null, tint = MediumGray)
                                }
                            }
                        },
                        singleLine = true,
                        shape = MaterialTheme.shapes.medium,
                        colors = OutlinedTextFieldDefaults.colors(
                            focusedBorderColor = DoziTurquoise,
                            unfocusedBorderColor = VeryLightGray,
                            cursorColor = DoziTurquoise,
                            focusedContainerColor = DoziTurquoise.copy(alpha = 0.05f), // ‚úÖ YENƒ∞
                            unfocusedContainerColor = Color.White // ‚úÖ YENƒ∞
                        ),
                        keyboardOptions = KeyboardOptions(imeAction = ImeAction.Search),
                        keyboardActions = KeyboardActions(onSearch = {})
                    )

                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Text(
                            text = when (searchMode) {
                                "barcode" -> "Barkod ile aranƒ±yor..."
                                "voice" -> "Sesli arama..."
                                else -> "Yazarak, barkod okutarak veya sesli arayabilirsiniz"
                            },
                            style = MaterialTheme.typography.labelSmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant,
                            modifier = Modifier.padding(start = 4.dp)
                        )
                    }
                }
            }

            Spacer(Modifier.height(16.dp))

            // ƒ∞√ßerik b√∂l√ºm√º
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(horizontal = 4.dp),
                contentAlignment = Alignment.Center
            ) {
                when {
                    isSearching -> Column(
                        horizontalAlignment = Alignment.CenterHorizontally,
                        verticalArrangement = Arrangement.spacedBy(12.dp)
                    ) {
                        CircularProgressIndicator(
                            color = DoziTurquoise,
                            strokeWidth = 3.dp
                        )
                        Text(
                            if (searchMode == "barcode") "Barkod okunuyor..." else "Aranƒ±yor...",
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }

                    results.isNotEmpty() -> LazyColumn(
                        modifier = Modifier.fillMaxSize(),
                        contentPadding = PaddingValues(bottom = 80.dp, top = 8.dp),
                        verticalArrangement = Arrangement.spacedBy(12.dp)
                    ) {
                        items(results, key = { it.item.ID ?: it.item.Product_Name!! }) { res ->
                            MedicineResultCard(
                                result = res,
                                onClick = {
                                    selected = res
                                    showDetail = true
                                },
                                onQuickAdd = {
                                    navController.currentBackStackEntry?.savedStateHandle?.set(
                                        "selectedMedicine",
                                        IlacSearchResultParcelable(res.item, res.dosage)
                                    )
                                    navController.navigate(Screen.MedicineEdit.createRoute("new"))
                                }
                            )
                        }
                    }

                    query.isNotBlank() -> {
                        // Cache durumunu kontrol et
                        val cacheSize = com.bardino.dozi.core.data.MedicineLookupRepository.ilaclarCache?.size ?: 0

                        Column(
                            horizontalAlignment = Alignment.CenterHorizontally,
                            verticalArrangement = Arrangement.spacedBy(16.dp),
                            modifier = Modifier.padding(horizontal = 24.dp)
                        ) {
                            if (cacheSize == 0) {
                                Icon(
                                    Icons.Default.SearchOff,
                                    null,
                                    tint = MediumGray,
                                    modifier = Modifier.size(56.dp)
                                )
                                Text("ƒ∞la√ß veritabanƒ± y√ºklenemedi", color = MaterialTheme.colorScheme.error)
                                Spacer(Modifier.height(4.dp))
                                Text(
                                    "L√ºtfen uygulamayƒ± yeniden ba≈ülatƒ±n",
                                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                                    fontSize = 12.sp,
                                    textAlign = TextAlign.Center
                                )
                            } else {
                                // √ñzel ila√ß ekleme √∂nerisi
                                Surface(
                                    modifier = Modifier.size(72.dp),
                                    shape = MaterialTheme.shapes.extraLarge,
                                    color = DoziCoral.copy(alpha = 0.15f)
                                ) {
                                    Box(contentAlignment = Alignment.Center) {
                                        Icon(
                                            Icons.Default.Add,
                                            null,
                                            tint = DoziCoral,
                                            modifier = Modifier.size(36.dp)
                                        )
                                    }
                                }

                                Column(
                                    horizontalAlignment = Alignment.CenterHorizontally,
                                    verticalArrangement = Arrangement.spacedBy(4.dp)
                                ) {
                                    Text(
                                        "\"$query\" bulunamadƒ±",
                                        fontWeight = FontWeight.Bold,
                                        color = MaterialTheme.colorScheme.onSurface,
                                        textAlign = TextAlign.Center
                                    )
                                    Text(
                                        "Takviye, vitamin veya √∂zel ila√ß mƒ± eklemek istiyorsun?",
                                        color = MaterialTheme.colorScheme.onSurfaceVariant,
                                        fontSize = 14.sp,
                                        textAlign = TextAlign.Center
                                    )
                                }

                                // √ñzel ila√ß ekle butonu
                                Button(
                                    onClick = {
                                        navController.navigate(Screen.CustomMedicineAdd.route)
                                    },
                                    modifier = Modifier
                                        .fillMaxWidth()
                                        .height(52.dp),
                                    shape = MaterialTheme.shapes.medium,
                                    colors = ButtonDefaults.buttonColors(containerColor = DoziCoral)
                                ) {
                                    Icon(Icons.Default.Add, null, modifier = Modifier.size(20.dp))
                                    Spacer(Modifier.width(8.dp))
                                    Text(
                                        "√ñzel ƒ∞la√ß Olarak Ekle",
                                        fontWeight = FontWeight.Bold
                                    )
                                }

                                // Ya da farklƒ± arama √∂nerisi
                                Text(
                                    "veya farklƒ± bir arama terimi deneyin",
                                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                                    fontSize = 12.sp,
                                    textAlign = TextAlign.Center
                                )
                            }
                        }
                    }

                    else -> Column(horizontalAlignment = Alignment.CenterHorizontally) {
                        Surface(
                            modifier = Modifier.size(90.dp),
                            shape = MaterialTheme.shapes.extraLarge,
                            color = DoziTurquoise.copy(alpha = 0.15f)
                        ) {
                            Box(contentAlignment = Alignment.Center) {
                                Icon(
                                    Icons.Default.Medication,
                                    null,
                                    tint = DoziTurquoise,
                                    modifier = Modifier.size(48.dp)
                                )
                            }
                        }
                        Spacer(Modifier.height(16.dp))
                        Text(
                            "ƒ∞la√ß aramaya ba≈ülayƒ±n",
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.onSurface
                        )
                        Text(
                            "Yukarƒ±daki kutuya yazƒ±n, barkod okutun veya sesli arama yapƒ±n",
                            color = MaterialTheme.colorScheme.onSurfaceVariant,
                            textAlign = TextAlign.Center,
                            fontSize = 14.sp,
                            modifier = Modifier.padding(horizontal = 24.dp)
                        )
                    }
                }
            }
        }

        if (showDetail && selected != null) {
            MedicineDetailDialog(
                result = selected!!,
                onDismiss = { showDetail = false },
                onConfirm = {
                    navController.currentBackStackEntry?.savedStateHandle?.set(
                        "selectedMedicine",
                        IlacSearchResultParcelable(selected!!.item, selected!!.dosage)
                    )
                    navController.navigate(Screen.MedicineEdit.createRoute("new"))
                    showDetail = false
                }
            )
        }
    }
}

@Composable
private fun MedicineResultCard(
    result: IlacSearchResult,
    onClick: () -> Unit,
    onQuickAdd: () -> Unit
) {
    Card(
        onClick = onClick,
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        shape = MaterialTheme.shapes.medium,
        border = BorderStroke(1.dp, VeryLightGray)
    ) {
        Row(
            Modifier
                .fillMaxWidth()
                .padding(16.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Surface(
                Modifier.size(48.dp),
                color = DoziTurquoise.copy(alpha = 0.1f),
                shape = MaterialTheme.shapes.small
            ) {
                Box(contentAlignment = Alignment.Center) {
                    Icon(Icons.Default.Medication, null, tint = DoziTurquoise)
                }
            }

            Spacer(Modifier.width(12.dp))
            Column(Modifier.weight(1f)) {
                result.item.Product_Name?.let {
                    Text(it, fontWeight = FontWeight.Bold, color = MaterialTheme.colorScheme.onSurface)
                }
                result.item.Active_Ingredient?.takeIf { it.isNotBlank() }?.let {
                    Text(it, color = MaterialTheme.colorScheme.onSurfaceVariant, fontSize = 13.sp)
                }
                result.dosage?.let {
                    Surface(color = DoziTurquoise.copy(alpha = 0.15f), shape = MaterialTheme.shapes.small) {
                        Text(it, color = DoziTurquoise, fontWeight = FontWeight.Bold,
                            modifier = Modifier.padding(horizontal = 8.dp, vertical = 4.dp))
                    }
                }
            }

            Surface(
                onClick = onQuickAdd,
                color = SuccessGreen.copy(alpha = 0.15f),
                shape = MaterialTheme.shapes.small
            ) {
                Box(Modifier.size(44.dp), contentAlignment = Alignment.Center) {
                    Icon(Icons.Default.Add, null, tint = SuccessGreen)
                }
            }
        }
    }
}

@Composable
private fun MedicineDetailDialog(
    result: IlacSearchResult,
    onDismiss: () -> Unit,
    onConfirm: () -> Unit
) {
    Dialog(onDismissRequest = onDismiss) {
        Surface(shape = MaterialTheme.shapes.large, color = Color.White) {
            Column(Modifier.padding(24.dp), verticalArrangement = Arrangement.spacedBy(20.dp)) {
                Row(verticalAlignment = Alignment.CenterVertically) {
                    Surface(
                        Modifier.size(56.dp),
                        color = DoziTurquoise.copy(alpha = 0.15f),
                        shape = MaterialTheme.shapes.medium
                    ) {
                        Box(contentAlignment = Alignment.Center) {
                            Icon(Icons.Default.Medication, null, tint = DoziTurquoise)
                        }
                    }
                    Spacer(Modifier.width(12.dp))
                    Text("ƒ∞la√ß Detayƒ±", fontWeight = FontWeight.Bold, fontSize = 20.sp, color = MaterialTheme.colorScheme.onSurface)
                }
                Divider(color = VeryLightGray)
                Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                    DetailRow("ƒ∞la√ß Adƒ±", result.item.Product_Name)
                    result.item.Active_Ingredient?.takeIf { it.isNotBlank() }?.let {
                        DetailRow("Etken Madde", it)
                    }
                    result.dosage?.let { DetailRow("Dozaj", it) }
                }
                Divider(color = VeryLightGray)
                Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                    OutlinedButton(
                        onClick = onDismiss,
                        modifier = Modifier.weight(1f),
                        border = BorderStroke(1.dp, VeryLightGray),
                        shape = MaterialTheme.shapes.medium
                    ) { Text("ƒ∞ptal", color = MaterialTheme.colorScheme.onSurfaceVariant) }
                    Button(
                        onClick = onConfirm,
                        modifier = Modifier.weight(1f),
                        colors = ButtonDefaults.buttonColors(containerColor = DoziTurquoise),
                        shape = MaterialTheme.shapes.medium
                    ) {
                        Icon(Icons.Default.Add, null, modifier = Modifier.size(18.dp))
                        Spacer(Modifier.width(6.dp))
                        Text("Ekle")
                    }
                }
            }
        }
    }
}

@Composable
private fun DetailRow(label: String, value: String?) {
    Column {
        Text(label, color = MaterialTheme.colorScheme.onSurfaceVariant, fontSize = 11.sp)
        if (value != null) Text(value, fontWeight = FontWeight.Medium, color = MaterialTheme.colorScheme.onSurface)
    }
}

// ============================================================================
// FILE: NotificationsScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/notifications/NotificationsScreen.kt
// [83 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.notifications

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import com.bardino.dozi.core.data.model.*
import com.bardino.dozi.core.ui.viewmodel.NotificationViewModel
import java.text.SimpleDateFormat
import java.util.*

/**
 * Bildirimler Ekranƒ±
 * Kullanƒ±cƒ±nƒ±n t√ºm bildirimlerini g√∂sterir
 */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun NotificationsScreen(
    onNavigateBack: () -> Unit,
    onNotificationClick: (DoziNotification) -> Unit = {},
    viewModel: NotificationViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsState()

    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Text("üîî Bildirimler")
                        if (uiState.unreadCount > 0) {
                            Badge {
                                Text(uiState.unreadCount.toString())
                            }
                        }
                    }
                },
                navigationIcon = {
                    IconButton(onClick = onNavigateBack) {
                        Icon(Icons.Default.ArrowBack, "Geri")
                    }
                },
                actions = {
                    if (uiState.unreadCount > 0) {
                        IconButton(onClick = { viewModel.markAllAsRead() }) {
                            Icon(Icons.Default.DoneAll, "T√ºm√ºn√º Okundu ƒ∞≈üaretle")
                        }
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = MaterialTheme.colorScheme.primaryContainer
                )
            )
        }
    ) { padding ->
        if (uiState.notifications.isEmpty()) {
            // Bo≈ü durum
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding),
                contentAlignment = Alignment.Center
            ) {
                Column(
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    Text(
                        "üîï",
                        style = MaterialTheme.typography.displayLarge
                    )
                    Text(
                        "Bildirim yok",
                        style = MaterialTheme.typography.titleLarge,
                        fontWeight = FontWeight.Bold
                    )
                    Text(
                        "Hen√ºz bir bildiriminiz bulunmuyor",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
                    )
                }
            }
        } else {
            LazyColumn(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding),
                contentPadding = PaddingValues(16.dp),
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                items(uiState.notifications, key = { it.id }) { notification ->
                    NotificationCard(
                        notification = notification,
                        onClick = {
                            viewModel.markAsRead(notification.id)
                            onNotificationClick(notification)
                        },
                        onDelete = { viewModel.deleteNotification(notification.id) },
                        onAcceptBadiRequest = { requestId ->
                            viewModel.acceptBadiRequest(requestId)
                            viewModel.deleteNotification(notification.id)
                        },
                        onRejectBadiRequest = { requestId ->
                            viewModel.rejectBadiRequest(requestId)
                            viewModel.deleteNotification(notification.id)
                        }
                    )
                }
            }
        }

        // Loading
        if (uiState.isLoading) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding),
                contentAlignment = Alignment.Center
            ) {
                CircularProgressIndicator()
            }
        }

        // Error
        uiState.error?.let { error ->
            Snackbar(
                modifier = Modifier.padding(16.dp),
                action = {
                    TextButton(onClick = { viewModel.clearError() }) {
                        Text("Tamam")
                    }
                }
            ) {
                Text(error)
            }
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun NotificationCard(
    notification: DoziNotification,
    onClick: () -> Unit,
    onDelete: () -> Unit,
    onAcceptBadiRequest: (String) -> Unit = {},
    onRejectBadiRequest: (String) -> Unit = {}
) {
    var showDeleteDialog by remember { mutableStateOf(false) }

    Card(
        modifier = Modifier
            .fillMaxWidth()
            .clickable(onClick = onClick),
        shape = RoundedCornerShape(12.dp),
        colors = CardDefaults.cardColors(
            containerColor = if (notification.isRead) {
                MaterialTheme.colorScheme.surface
            } else {
                MaterialTheme.colorScheme.primaryContainer.copy(alpha = 0.3f)
            }
        )
    ) {
        Row(
            modifier = Modifier.padding(16.dp),
            horizontalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            // ƒ∞kon
            Surface(
                shape = CircleShape,
                color = getNotificationColor(notification.type).copy(alpha = 0.2f)
            ) {
                Text(
                    notification.type.toEmoji(),
                    modifier = Modifier.padding(12.dp),
                    style = MaterialTheme.typography.headlineSmall
                )
            }

            // ƒ∞√ßerik
            Column(
                modifier = Modifier.weight(1f),
                verticalArrangement = Arrangement.spacedBy(4.dp)
            ) {
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(
                        notification.title,
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = if (notification.isRead) FontWeight.Normal else FontWeight.Bold
                    )
                    if (!notification.isRead) {
                        Surface(
                            shape = CircleShape,
                            color = MaterialTheme.colorScheme.primary,
                            modifier = Modifier.size(8.dp)
                        ) {}
                    }
                }

                Text(
                    notification.body,
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurface.copy(
                        alpha = if (notification.isRead) 0.6f else 0.8f
                    )
                )

                // Badi request i√ßin action butonlarƒ±
                if (notification.type == NotificationType.BADI_REQUEST) {
                    Spacer(modifier = Modifier.height(8.dp))
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Button(
                            onClick = {
                                val requestId = notification.data["requestId"] ?: return@Button
                                onAcceptBadiRequest(requestId)
                            },
                            modifier = Modifier.weight(1f),
                            colors = ButtonDefaults.buttonColors(
                                containerColor = Color(0xFF4CAF50)
                            )
                        ) {
                            Icon(Icons.Default.Check, "Kabul Et", modifier = Modifier.size(18.dp))
                            Spacer(modifier = Modifier.width(4.dp))
                            Text("Kabul Et")
                        }
                        OutlinedButton(
                            onClick = {
                                val requestId = notification.data["requestId"] ?: return@OutlinedButton
                                onRejectBadiRequest(requestId)
                            },
                            modifier = Modifier.weight(1f),
                            colors = ButtonDefaults.outlinedButtonColors(
                                contentColor = Color(0xFFF44336)
                            )
                        ) {
                            Icon(Icons.Default.Close, "Reddet", modifier = Modifier.size(18.dp))
                            Spacer(modifier = Modifier.width(4.dp))
                            Text("Reddet")
                        }
                    }
                }

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    notification.createdAt?.let { time ->
                        Text(
                            formatTimestamp(time),
                            style = MaterialTheme.typography.labelSmall,
                            color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.5f)
                        )
                    }

                    // √ñncelik g√∂stergesi
                    if (notification.priority == NotificationPriority.HIGH) {
                        Surface(
                            shape = RoundedCornerShape(4.dp),
                            color = MaterialTheme.colorScheme.error.copy(alpha = 0.2f)
                        ) {
                            Text(
                                "√ñnemli",
                                modifier = Modifier.padding(horizontal = 6.dp, vertical = 2.dp),
                                style = MaterialTheme.typography.labelSmall,
                                color = MaterialTheme.colorScheme.error,
                                fontWeight = FontWeight.Bold
                            )
                        }
                    }
                }
            }

            // Sil butonu
            IconButton(
                onClick = { showDeleteDialog = true },
                modifier = Modifier.size(24.dp)
            ) {
                Icon(
                    Icons.Default.Close,
                    "Sil",
                    tint = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.5f),
                    modifier = Modifier.size(20.dp)
                )
            }
        }
    }

    // Silme onay dialog'u
    if (showDeleteDialog) {
        AlertDialog(
            onDismissRequest = { showDeleteDialog = false },
            icon = { Icon(Icons.Default.Delete, null) },
            title = { Text("Bildirimi Sil") },
            text = { Text("Bu bildirimi silmek istediƒüinizden emin misiniz?") },
            confirmButton = {
                Button(
                    onClick = {
                        onDelete()
                        showDeleteDialog = false
                    },
                    colors = ButtonDefaults.buttonColors(
                        containerColor = MaterialTheme.colorScheme.error
                    )
                ) {
                    Text("Sil")
                }
            },
            dismissButton = {
                TextButton(onClick = { showDeleteDialog = false }) {
                    Text("ƒ∞ptal")
                }
            }
        )
    }
}

@Composable
fun getNotificationColor(type: NotificationType) = when (type) {
    NotificationType.BADI_REQUEST -> MaterialTheme.colorScheme.primary
    NotificationType.BADI_ACCEPTED -> MaterialTheme.colorScheme.tertiary
    NotificationType.MEDICATION_REMINDER -> MaterialTheme.colorScheme.primary
    NotificationType.BADI_MEDICATION_ALERT -> MaterialTheme.colorScheme.error
    NotificationType.MEDICATION_TAKEN -> MaterialTheme.colorScheme.tertiary
    NotificationType.MEDICATION_MISSED -> MaterialTheme.colorScheme.error
    NotificationType.STOCK_LOW -> MaterialTheme.colorScheme.tertiary
    NotificationType.STOCK_EMPTY -> MaterialTheme.colorScheme.error
    else -> MaterialTheme.colorScheme.surface
}

private fun formatTimestamp(timestamp: com.google.firebase.Timestamp): String {
    val date = timestamp.toDate()
    val now = Date()
    val diff = now.time - date.time

    return when {
        diff < 60_000 -> "≈ûimdi"
        diff < 3600_000 -> "${diff / 60_000} dakika √∂nce"
        diff < 86400_000 -> "${diff / 3600_000} saat √∂nce"
        diff < 604800_000 -> "${diff / 86400_000} g√ºn √∂nce"
        else -> SimpleDateFormat("dd MMM yyyy", Locale("tr")).format(date)
    }
}

// ============================================================================
// FILE: PremiumIntroScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/premium/PremiumIntroScreen.kt
// [84 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.premium

import androidx.compose.animation.*
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.bardino.dozi.R
import com.bardino.dozi.core.ui.theme.*
import kotlinx.coroutines.delay

@Composable
fun PremiumIntroScreen(
    onContinue: () -> Unit
) {
    var showContent by remember { mutableStateOf(false) }

    LaunchedEffect(Unit) {
        delay(100)
        showContent = true
    }

    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(
                brush = Brush.verticalGradient(
                    colors = listOf(
                        DoziTurquoise,
                        DoziTurquoiseDark,
                        DoziTurquoiseDark.copy(alpha = 0.95f)
                    )
                )
            )
    ) {
        AnimatedVisibility(
            visible = showContent,
            enter = fadeIn() + slideInVertically(initialOffsetY = { it / 3 })
        ) {
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .verticalScroll(rememberScrollState())
                    .padding(24.dp),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Spacer(modifier = Modifier.height(40.dp))

                // Gift Icon
                Surface(
                    modifier = Modifier.size(100.dp),
                    shape = RoundedCornerShape(25.dp),
                    color = Color.White.copy(alpha = 0.2f)
                ) {
                    Box(contentAlignment = Alignment.Center) {
                        Icon(
                            imageVector = Icons.Default.CardGiftcard,
                            contentDescription = null,
                            modifier = Modifier.size(50.dp),
                            tint = Color.White
                        )
                    }
                }

                Spacer(modifier = Modifier.height(24.dp))

                // Title
                Text(
                    text = "3 Gun Ucretsiz Dozi Ekstra!",
                    style = MaterialTheme.typography.headlineMedium,
                    fontWeight = FontWeight.Bold,
                    color = Color.White,
                    textAlign = TextAlign.Center
                )

                Spacer(modifier = Modifier.height(8.dp))

                Text(
                    text = "Hos geldin hediyesi olarak tum premium ozelliklere erisim sagla",
                    style = MaterialTheme.typography.bodyLarge,
                    color = Color.White.copy(alpha = 0.9f),
                    textAlign = TextAlign.Center
                )

                Spacer(modifier = Modifier.height(32.dp))

                // Features Card
                Surface(
                    modifier = Modifier.fillMaxWidth(),
                    shape = RoundedCornerShape(20.dp),
                    color = Color.White.copy(alpha = 0.15f)
                ) {
                    Column(
                        modifier = Modifier.padding(20.dp),
                        verticalArrangement = Arrangement.spacedBy(16.dp)
                    ) {
                        Text(
                            text = "Premium Ozellikler",
                            style = MaterialTheme.typography.titleMedium,
                            fontWeight = FontWeight.Bold,
                            color = Color.White
                        )

                        PremiumFeatureItem(
                            icon = Icons.Default.AllInclusive,
                            text = "Sinirsiz ilac ve hatirlatici"
                        )
                        PremiumFeatureItem(
                            icon = Icons.Default.CloudSync,
                            text = "Bulut yedekleme ve senkronizasyon"
                        )
                        PremiumFeatureItem(
                            icon = Icons.Default.RecordVoiceOver,
                            text = "Sesli hatirlaticilar"
                        )
                        PremiumFeatureItem(
                            icon = Icons.Default.Analytics,
                            text = "Detayli ilac istatistikleri"
                        )
                        PremiumFeatureItem(
                            icon = Icons.Default.Palette,
                            text = "Tema ozellestirme"
                        )
                        PremiumFeatureItem(
                            icon = Icons.Default.Support,
                            text = "Oncelikli destek"
                        )
                    }
                }

                Spacer(modifier = Modifier.height(32.dp))

                // Continue Button
                Button(
                    onClick = onContinue,
                    modifier = Modifier
                        .fillMaxWidth()
                        .height(56.dp),
                    shape = RoundedCornerShape(16.dp),
                    colors = ButtonDefaults.buttonColors(
                        containerColor = Color.White,
                        contentColor = DoziTurquoiseDark
                    ),
                    elevation = ButtonDefaults.buttonElevation(
                        defaultElevation = 4.dp,
                        pressedElevation = 8.dp
                    )
                ) {
                    Text(
                        text = "Dozi'yi Kesfet",
                        style = MaterialTheme.typography.bodyLarge,
                        fontWeight = FontWeight.Bold
                    )
                }

                Spacer(modifier = Modifier.height(16.dp))

                // Info text
                Text(
                    text = "3 gunluk ucretsiz deneme. Sonrasinda aylik 149‚Ç∫ abonelik baslar. Istedigin zaman iptal edebilirsin.",
                    style = MaterialTheme.typography.bodySmall,
                    color = Color.White.copy(alpha = 0.7f),
                    textAlign = TextAlign.Center,
                    lineHeight = 18.sp
                )

                Spacer(modifier = Modifier.height(40.dp))
            }
        }
    }
}

@Composable
private fun PremiumFeatureItem(
    icon: ImageVector,
    text: String
) {
    Row(
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.spacedBy(12.dp)
    ) {
        Icon(
            imageVector = icon,
            contentDescription = null,
            tint = Color.White,
            modifier = Modifier.size(20.dp)
        )
        Text(
            text = text,
            style = MaterialTheme.typography.bodyMedium,
            color = Color.White,
            fontWeight = FontWeight.Medium
        )
    }
}

// ============================================================================
// FILE: PremiumScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/premium/PremiumScreen.kt
// [85 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.premium

import androidx.compose.animation.*
import androidx.compose.animation.core.*
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.scale
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.graphicsLayer
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.bardino.dozi.R
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*

data class PremiumPlan(
    val id: String,
    val title: String,
    val price: String,
    val period: String,
    val badge: String? = null,
    val features: List<String>,
    val badgeColor: Color = DoziCoral
)

@Composable
fun PremiumScreen(
    onNavigateBack: () -> Unit,
    onPurchase: (PlanType) -> Unit
) {
    var selectedPlan by remember { mutableStateOf("monthly") }

    val plans = listOf(
        PremiumPlan(
            id = "weekly",
            title = "Haftalƒ±k",
            price = "49‚Ç∫",
            period = "hafta",
            features = listOf(
                "Sƒ±nƒ±rsƒ±z ila√ß ekleme",
                "Bulut yedekleme",
                "Sesli hatƒ±rlatƒ±cƒ±lar"
            )
        ),
        PremiumPlan(
            id = "monthly",
            title = "Aylƒ±k",
            price = "149‚Ç∫",
            period = "ay",
            badge = "POP√úLER",
            badgeColor = DoziCoral,
            features = listOf(
                "Sƒ±nƒ±rsƒ±z ila√ß ekleme",
                "Bulut yedekleme",
                "Sesli hatƒ±rlatƒ±cƒ±lar",
                "√ñncelikli destek"
            )
        ),
        PremiumPlan(
            id = "yearly",
            title = "Yƒ±llƒ±k",
            price = "999‚Ç∫",
            period = "yƒ±l",
            badge = "EN AVANTAJLI",
            badgeColor = DoziTurquoise,
            features = listOf(
                "Sƒ±nƒ±rsƒ±z ila√ß ekleme",
                "Bulut yedekleme",
                "Sesli hatƒ±rlatƒ±cƒ±lar",
                "√ñncelikli destek",
                "%44 tasarruf"
            )
        ),
        PremiumPlan(
            id = "monthly_family",
            title = "Aylƒ±k Aile",
            price = "249‚Ç∫",
            period = "ay",
            badge = "Aƒ∞LE PAKETƒ∞",
            badgeColor = DoziPurple,
            features = listOf(
                "4 ki≈üiye kadar",
                "Sƒ±nƒ±rsƒ±z ila√ß ekleme",
                "Bulut yedekleme",
                "Sesli hatƒ±rlatƒ±cƒ±lar",
                "√ñncelikli destek",
                "Aile takip sistemi"
            )
        ),
        PremiumPlan(
            id = "yearly_family",
            title = "Yƒ±llƒ±k Aile",
            price = "1999‚Ç∫",
            period = "yƒ±l",
            badge = "EN AVANTAJLI Aƒ∞LE",
            badgeColor = DoziBlue,
            features = listOf(
                "4 ki≈üiye kadar",
                "Sƒ±nƒ±rsƒ±z ila√ß ekleme",
                "Bulut yedekleme",
                "Sesli hatƒ±rlatƒ±cƒ±lar",
                "√ñncelikli destek",
                "Aile takip sistemi",
                "%33 tasarruf"
            )
        )
    )

    Scaffold(
        topBar = {
            DoziTopBar(
                title = "Dozi Ekstra",
                canNavigateBack = true,
                onNavigateBack = onNavigateBack
            )
        },
        containerColor = BackgroundLight
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .verticalScroll(rememberScrollState())
        ) {
            // Hero B√∂l√ºm√º
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .background(BackgroundLight)
                    .padding(vertical = 32.dp, horizontal = 24.dp),
                contentAlignment = Alignment.Center
            ) {
                Column(
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    AnimatedDozi()
                    Text(
                        text = "Dozi Ekstra üíß",
                        style = MaterialTheme.typography.headlineMedium,
                        fontWeight = FontWeight.Bold,
                        color = DoziTurquoise,
                        textAlign = TextAlign.Center
                    )
                    Text(
                        text = "3 g√ºn √ºcretsiz dene, sonra 149‚Ç∫/ay",
                        style = MaterialTheme.typography.bodyLarge,
                        color = TextSecondary,
                        textAlign = TextAlign.Center
                    )
                }
            }

            Spacer(Modifier.height(8.dp))

            // √ñzellikler Ba≈ülƒ±k
            Text(
                text = "‚ú® Premium √ñzellikler",
                style = MaterialTheme.typography.titleLarge,
                fontWeight = FontWeight.Bold,
                color = TextPrimary,
                modifier = Modifier.padding(horizontal = 24.dp)
            )

            Spacer(Modifier.height(16.dp))

            // √ñzellik Grid
            Column(
                modifier = Modifier.padding(horizontal = 24.dp),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    FeatureCard(
                        icon = Icons.Default.AllInclusive,
                        title = "Sƒ±nƒ±rsƒ±z ƒ∞la√ß",
                        modifier = Modifier.weight(1f)
                    )
                    FeatureCard(
                        icon = Icons.Default.Cloud,
                        title = "Bulut Yedekleme",
                        modifier = Modifier.weight(1f)
                    )
                }

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    FeatureCard(
                        icon = Icons.Default.NotificationsActive,
                        title = "Akƒ±llƒ± Hatƒ±rlatma",
                        modifier = Modifier.weight(1f)
                    )
                    FeatureCard(
                        icon = Icons.Default.FamilyRestroom,
                        title = "Aile Y√∂netimi",
                        modifier = Modifier.weight(1f)
                    )
                }

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    FeatureCard(
                        icon = Icons.Default.MusicNote,
                        title = "√ñzel Sesler",
                        modifier = Modifier.weight(1f)
                    )
                    FeatureCard(
                        icon = Icons.Default.SupportAgent,
                        title = "√ñncelikli Destek",
                        modifier = Modifier.weight(1f)
                    )
                }
            }

            Spacer(Modifier.height(32.dp))

            // Planlar Ba≈ülƒ±k
            Text(
                text = "üéØ Planƒ±nƒ± Se√ß",
                style = MaterialTheme.typography.titleLarge,
                fontWeight = FontWeight.Bold,
                color = TextPrimary,
                modifier = Modifier.padding(horizontal = 24.dp)
            )

            Spacer(Modifier.height(16.dp))

            // Paket se√ßenekleri
            Column(
                modifier = Modifier.padding(horizontal = 24.dp),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                plans.forEach { plan ->
                    PremiumPlanCard(
                        plan = plan,
                        isSelected = selectedPlan == plan.id,
                        onClick = { selectedPlan = plan.id }
                    )
                }
            }

            Spacer(Modifier.height(32.dp))

            // Satƒ±n Al Butonu
            Column(
                modifier = Modifier
                    .padding(horizontal = 24.dp)
                    .padding(bottom = 24.dp),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                Button(
                    onClick = {
                        val planType = when (selectedPlan) {
                            "ekstra_monthly" -> PlanType.EKSTRA_MONTHLY
                            "ekstra_yearly" -> PlanType.EKSTRA_YEARLY
                            "aile_monthly" -> PlanType.AILE_MONTHLY
                            "aile_yearly" -> PlanType.AILE_YEARLY
                            else -> PlanType.EKSTRA_MONTHLY
                        }
                        onPurchase(planType)
                    },
                    modifier = Modifier
                        .fillMaxWidth()
                        .height(56.dp),
                    colors = ButtonDefaults.buttonColors(
                        containerColor = DoziTurquoise
                    ),
                    shape = RoundedCornerShape(16.dp)
                ) {
                    Text(
                        text = "√úcretsiz Denemeyi Ba≈ülat",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold
                    )
                }

                Text(
                    text = "ƒ∞stediƒüin zaman iptal edebilirsin",
                    style = MaterialTheme.typography.bodySmall,
                    color = TextSecondary,
                    textAlign = TextAlign.Center,
                    modifier = Modifier.fillMaxWidth()
                )
            }
        }
    }
}

@Composable
private fun AnimatedDozi() {
    // Sabit Dozi King - Nefes almayan versiyon
    Image(
        painter = painterResource(R.drawable.dozi_king),
        contentDescription = "Dozi Premium",
        modifier = Modifier.size(120.dp)
    )
}

@Composable
private fun FeatureCard(
    icon: androidx.compose.ui.graphics.vector.ImageVector,
    title: String,
    modifier: Modifier = Modifier
) {
    Box(
        modifier = modifier
            .height(90.dp)
            .clip(RoundedCornerShape(16.dp))
            .background(DoziTurquoise.copy(alpha = 0.08f))
            .padding(12.dp),
        contentAlignment = Alignment.Center
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.Center
        ) {
            Icon(
                imageVector = icon,
                contentDescription = null,
                tint = DoziTurquoise,
                modifier = Modifier.size(28.dp)
            )
            Spacer(Modifier.height(6.dp))
            Text(
                text = title,
                style = MaterialTheme.typography.bodySmall,
                fontWeight = FontWeight.SemiBold,
                color = TextPrimary,
                textAlign = TextAlign.Center,
                fontSize = 11.sp
            )
        }
    }
}

@Composable
private fun PremiumPlanCard(
    plan: PremiumPlan,
    isSelected: Boolean,
    onClick: () -> Unit
) {
    val isFamilyPlan = plan.id.contains("family")

    val backgroundColor = when {
        isSelected -> plan.badgeColor.copy(alpha = 0.15f)
        else -> Gray100
    }

    val borderColor = when {
        isSelected -> plan.badgeColor
        else -> Color.Transparent
    }

    Box(
        modifier = Modifier
            .fillMaxWidth()
            .clip(RoundedCornerShape(20.dp))
            .background(backgroundColor)
            .border(
                width = if (isSelected) 2.dp else 0.dp,
                color = borderColor,
                shape = RoundedCornerShape(20.dp)
            )
            .clickable(onClick = onClick)
            .padding(16.dp)
    ) {
        Row(
            modifier = Modifier.fillMaxWidth(),
            verticalAlignment = Alignment.Top
        ) {
            // Sol kƒ±sƒ±m - Bilgiler ve √ñzellikler
            Column(modifier = Modifier.weight(1f)) {
                // Badge (opsiyonel)
                if (plan.badge != null) {
                    Box(
                        modifier = Modifier
                            .clip(RoundedCornerShape(8.dp))
                            .background(plan.badgeColor)
                            .padding(horizontal = 8.dp, vertical = 4.dp)
                    ) {
                        Text(
                            text = plan.badge,
                            style = MaterialTheme.typography.labelSmall,
                            fontWeight = FontWeight.Bold,
                            color = Color.White,
                            fontSize = 10.sp
                        )
                    }
                    Spacer(Modifier.height(8.dp))
                }

                Text(
                    text = plan.title,
                    style = MaterialTheme.typography.titleLarge,
                    fontWeight = FontWeight.Bold,
                    color = TextPrimary
                )

                Spacer(Modifier.height(4.dp))

                Row(
                    verticalAlignment = Alignment.Bottom,
                    horizontalArrangement = Arrangement.spacedBy(4.dp)
                ) {
                    Text(
                        text = plan.price,
                        style = MaterialTheme.typography.headlineSmall,
                        fontWeight = FontWeight.ExtraBold,
                        color = plan.badgeColor
                    )
                    Text(
                        text = "/ ${plan.period}",
                        style = MaterialTheme.typography.bodyMedium,
                        color = TextSecondary
                    )
                }

                Spacer(Modifier.height(12.dp))

                // √ñzellikler
                plan.features.forEach { feature ->
                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(8.dp),
                        modifier = Modifier.padding(vertical = 4.dp)
                    ) {
                        Icon(
                            Icons.Default.CheckCircle,
                            contentDescription = null,
                            tint = SuccessGreen,
                            modifier = Modifier.size(18.dp)
                        )
                        Text(
                            text = feature,
                            style = MaterialTheme.typography.bodyMedium,
                            color = TextPrimary
                        )
                    }
                }
            }

            Spacer(Modifier.width(12.dp))

            // Saƒü kƒ±sƒ±m - Dozi King Karakteri ve Radio Button
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                // Radio Button - En √ºstte
                RadioButton(
                    selected = isSelected,
                    onClick = onClick,
                    colors = RadioButtonDefaults.colors(
                        selectedColor = plan.badgeColor,
                        unselectedColor = TextSecondary
                    )
                )

                // Dozi Karakter - Her plan i√ßin farklƒ±
                Image(
                    painter = painterResource(
                        id = when (plan.id) {
                            "weekly" -> R.drawable.dozi_idea
                            "monthly" -> R.drawable.dozi_kalp
                            "yearly" -> R.drawable.dozi_perfect
                            "monthly_family" -> R.drawable.dozi_family
                            "yearly_family" -> R.drawable.dozi_king
                            else -> R.drawable.dozi_bravo
                        }
                    ),
                    contentDescription = "Dozi",
                    modifier = Modifier.size(70.dp)
                )
            }
        }
    }
}

// Plan Modeli - Yeni 3 kademeli yapƒ±
enum class PlanType(
    val title: String,
    val price: String,
    val period: String
) {
    EKSTRA_MONTHLY("Ekstra Aylƒ±k", "149", "ay"),
    EKSTRA_YEARLY("Ekstra Yƒ±llƒ±k", "999", "yƒ±l"),
    AILE_MONTHLY("Aile Aylƒ±k", "249", "ay"),
    AILE_YEARLY("Aile Yƒ±llƒ±k", "1999", "yƒ±l")
}

// ============================================================================
// FILE: LocationsScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/profile/LocationsScreen.kt
// [86 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.profile

import android.Manifest
import android.annotation.SuppressLint
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.location.Geocoder
import android.widget.Toast
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.animation.*
import androidx.compose.animation.core.*
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalFocusManager
import androidx.compose.ui.platform.LocalSoftwareKeyboardController
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.core.content.ContextCompat
import com.bardino.dozi.R
import com.bardino.dozi.core.data.LocationPreferences
import com.bardino.dozi.core.data.SavedLocation
import com.bardino.dozi.core.data.repository.LocationRepository
import com.bardino.dozi.core.ui.theme.*
import com.bardino.dozi.geofence.GeofenceReceiver
import com.bardino.dozi.navigation.Screen
import com.google.android.gms.location.Geofence
import com.google.android.gms.location.LocationServices
import com.google.android.gms.maps.model.CameraPosition
import com.google.android.gms.maps.model.LatLng
import com.google.maps.android.compose.*
import kotlinx.coroutines.delay
import kotlinx.coroutines.launch
import java.util.Locale
import androidx.compose.foundation.clickable
import androidx.compose.material3.Button
import androidx.compose.material3.OutlinedButton
import androidx.compose.material3.FloatingActionButton
import androidx.compose.material3.Card

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun LocationsScreen(onNavigateBack: () -> Unit) {
    val context = LocalContext.current
    val snackbarHostState = remember { SnackbarHostState() }
    val scope = rememberCoroutineScope()
    val locationRepository = remember { LocationRepository() }

    var places by remember { mutableStateOf<List<SavedLocation>>(emptyList()) }
    var toDelete by remember { mutableStateOf<SavedLocation?>(null) }
    var showMapPicker by remember { mutableStateOf(false) }
    var isVisible by remember { mutableStateOf(false) }
    var isLoading by remember { mutableStateOf(true) }
    val markerState = remember { MarkerState() }

    // üîÑ ƒ∞lk y√ºklemede Firestore'dan konumlarƒ± al ve migration yap
    LaunchedEffect(Unit) {
        isLoading = true
        try {
            // √ñnce local'den Firestore'a migration yap
            locationRepository.migrateLocalLocationsToFirestore(context)

            // Firestore'dan konumlarƒ± al
            places = locationRepository.getLocations()
        } catch (e: Exception) {
            snackbarHostState.showSnackbar("Konumlar y√ºklenirken hata olu≈ütu")
        } finally {
            isLoading = false
            isVisible = true
        }
    }

    // Konum izni
    val locationPermissionLauncher = rememberLauncherForActivityResult(
        ActivityResultContracts.RequestPermission()
    ) { granted ->
        if (!granted) {
            Toast.makeText(context, "Konum izni verilmedi", Toast.LENGTH_SHORT).show()
        }
    }

    // ƒ∞lk giri≈üte konum izni kontrol√º
    LaunchedEffect(key1 = true) {
        delay(300)
        if (ContextCompat.checkSelfPermission(context, Manifest.permission.ACCESS_FINE_LOCATION)
            != PackageManager.PERMISSION_GRANTED
        ) {
            locationPermissionLauncher.launch(Manifest.permission.ACCESS_FINE_LOCATION)
        }
    }

    Scaffold(
        topBar = {
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .background(
                        Brush.horizontalGradient(
                            colors = listOf(DoziCoral, DoziCoralDark)
                        )
                    )
            ) {
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(horizontal = 20.dp, vertical = 16.dp)
                ) {
                    // Top bar
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        IconButton(
                            onClick = onNavigateBack,
                            modifier = Modifier
                                .size(40.dp)
                                .background(Color.White.copy(alpha = 0.2f), CircleShape)
                        ) {
                            Icon(
                                Icons.Default.ArrowBack,
                                contentDescription = "Geri",
                                tint = Color.White
                            )
                        }

                        Text(
                            text = "Konumlarƒ±m",
                            style = MaterialTheme.typography.titleLarge,
                            fontWeight = FontWeight.Bold,
                            color = Color.White
                        )

                        Box(Modifier.size(40.dp)) // Spacer for symmetry
                    }

                    Spacer(Modifier.height(12.dp))

                    // Subtitle
                    Text(
                        text = "${places.size}/5 konum kaydedildi",
                        style = MaterialTheme.typography.bodyMedium,
                        color = Color.White.copy(alpha = 0.9f)
                    )
                }
            }
        },
        floatingActionButton = {
            val canAdd = places.size < 5
            AnimatedVisibility(
                visible = isVisible,
                enter = scaleIn() + fadeIn()
            ) {
                FloatingActionButton(
                    onClick = {
                        if (!canAdd) {
                            scope.launch {
                                snackbarHostState.showSnackbar("Maksimum 5 konum ekleyebilirsiniz")
                            }
                            return@FloatingActionButton
                        }

                        if (ContextCompat.checkSelfPermission(
                                context,
                                Manifest.permission.ACCESS_FINE_LOCATION
                            ) != PackageManager.PERMISSION_GRANTED
                        ) {
                            locationPermissionLauncher.launch(Manifest.permission.ACCESS_FINE_LOCATION)
                        } else {
                            showMapPicker = true
                        }
                    },
                    containerColor = DoziCoral,
                    shape = RoundedCornerShape(18.dp),
                    modifier = Modifier.shadow(8.dp, RoundedCornerShape(18.dp))
                ) {
                    Icon(
                        Icons.Default.Add,
                        contentDescription = "Konum Ekle",
                        tint = Color.White
                    )
                }
            }
        },
        snackbarHost = { SnackbarHost(snackbarHostState) },
        containerColor = MaterialTheme.colorScheme.background
    ) { padding ->
        if (isLoading) {
            // üîÑ Y√ºkleniyor g√∂stergesi
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding),
                contentAlignment = Alignment.Center
            ) {
                CircularProgressIndicator(color = DoziCoral)
            }
        } else if (places.isEmpty()) {
            EmptyLocationsState(
                onAddClick = { showMapPicker = true },
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding)
            )
        } else {
            LazyColumn(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding)
                    .padding(horizontal = 20.dp),
                contentPadding = PaddingValues(vertical = 16.dp),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                items(places, key = { it.id }) { place ->
                    AnimatedVisibility(
                        visible = isVisible,
                        enter = slideInVertically(
                            initialOffsetY = { 50 },
                            animationSpec = tween(300)
                        ) + fadeIn()
                    ) {
                        LocationCard(
                            place = place,
                            onDelete = { toDelete = place }
                        )
                    }
                }

                item {
                    val remaining = 5 - places.size
                    Card(
                        colors = CardDefaults.cardColors(
                            containerColor = DoziCoral.copy(alpha = 0.1f)
                        ),
                        shape = RoundedCornerShape(16.dp)
                    ) {
                        Row(
                            modifier = Modifier
                                .fillMaxWidth()
                                .padding(16.dp),
                            verticalAlignment = Alignment.CenterVertically,
                            horizontalArrangement = Arrangement.spacedBy(12.dp)
                        ) {
                            Icon(
                                Icons.Default.Info,
                                contentDescription = null,
                                tint = DoziCoral
                            )
                            Text(
                                text = if (remaining > 0)
                                    "Kalan $remaining konum ekleyebilirsiniz"
                                else
                                    "Konum limiti doldu (5/5)",
                                style = MaterialTheme.typography.bodyMedium,
                                color = MaterialTheme.colorScheme.onSurface
                            )
                        }
                    }
                }

                item { Spacer(Modifier.height(80.dp)) }
            }
        }
    }

    // Silme onayƒ±
    toDelete?.let { deleting ->
        AlertDialog(
            onDismissRequest = { toDelete = null },
            icon = {
                Icon(
                    Icons.Default.Warning,
                    contentDescription = null,
                    tint = DoziCoral,
                    modifier = Modifier.size(48.dp)
                )
            },
            title = {
                Text(
                    text = "Konumu Sil?",
                    fontWeight = FontWeight.Bold
                )
            },
            text = {
                Text(
                    text = "‚Äú${deleting.name}‚Äù konumunu silmek istediƒüinize emin misiniz?",
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            },
            confirmButton = {
                Button(
                    onClick = {
                        scope.launch {
                            val result = locationRepository.removeLocation(deleting.id)
                            if (result.isSuccess) {
                                places = locationRepository.getLocations()
                                snackbarHostState.showSnackbar("${deleting.name} silindi")
                            } else {
                                snackbarHostState.showSnackbar("Silme hatasƒ±: ${result.exceptionOrNull()?.message}")
                            }
                            toDelete = null
                        }
                    },
                    colors = ButtonDefaults.buttonColors(
                        containerColor = DoziCoral
                    )
                ) {
                    Text("Sil", fontWeight = FontWeight.Bold)
                }
            },
            dismissButton = {
                OutlinedButton(onClick = { toDelete = null }) {
                    Text("ƒ∞ptal")
                }
            }
        )
    }


    // Harita picker
    if (showMapPicker) {
        MapPickerSheet(
            context = context,
            onDismiss = { showMapPicker = false },
            onConfirm = { pickedLatLng, pickedName, address ->
                if (places.size >= 5) {
                    scope.launch {
                        snackbarHostState.showSnackbar("Maksimum 5 konum ekleyebilirsiniz")
                    }
                    return@MapPickerSheet
                }
                if (pickedLatLng == null || pickedName.isBlank()) {
                    scope.launch {
                        snackbarHostState.showSnackbar("Konum ve isim gerekli")
                    }
                    return@MapPickerSheet
                }

                // üîπ Yeni konumu Firestore'a kaydet
                scope.launch {
                    val newPlace = SavedLocation(
                        id = System.currentTimeMillis().toString(),
                        name = pickedName.trim(),
                        lat = pickedLatLng.latitude,
                        lng = pickedLatLng.longitude,
                        address = address
                    )

                    val result = locationRepository.addLocation(newPlace)
                    if (result.isSuccess) {
                        places = locationRepository.getLocations()

                        // üîπ Jeofence kur
                        addGeofence(context, newPlace.name, newPlace.lat, newPlace.lng)

                        showMapPicker = false
                        snackbarHostState.showSnackbar("üìç ${pickedName} kaydedildi ve etkinle≈ütirildi")
                    } else {
                        snackbarHostState.showSnackbar("Kaydetme hatasƒ±: ${result.exceptionOrNull()?.message}")
                    }
                }
            }
        )
    }
}

@Composable
private fun EmptyLocationsState(
    onAddClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    // Float animasyonu
    val infiniteTransition = rememberInfiniteTransition(label = "float")
    val floatOffset by infiniteTransition.animateFloat(
        initialValue = 0f,
        targetValue = 15f,
        animationSpec = infiniteRepeatable(
            animation = tween(2000, easing = EaseInOutSine),
            repeatMode = RepeatMode.Reverse
        ),
        label = "float"
    )

    Column(
        modifier = modifier.padding(horizontal = 32.dp),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        Image(
            painter = painterResource(R.drawable.dozi_idea),
            contentDescription = null,
            modifier = Modifier
                .size(160.dp)
                .offset(y = floatOffset.dp)
        )

        Spacer(Modifier.height(24.dp))

        Text(
            text = "Hen√ºz konum eklemedin",
            style = MaterialTheme.typography.headlineSmall,
            fontWeight = FontWeight.Bold,

            color = MaterialTheme.colorScheme.onSurface,


            textAlign = TextAlign.Center
        )

        Spacer(Modifier.height(12.dp))

        Text(
            text = "Ev, i≈ü, okul gibi sƒ±k gittiƒüin yerleri ekle. Bu konumlara vardƒ±ƒüƒ±nda ila√ß hatƒ±rlatmasƒ± yapalƒ±m! üìç",
            style = MaterialTheme.typography.bodyLarge,

            color = MaterialTheme.colorScheme.onSurfaceVariant,

            textAlign = TextAlign.Center
        )

        Spacer(Modifier.height(32.dp))

        Button(
            onClick = onAddClick,
            modifier = Modifier
                .fillMaxWidth(0.7f)
                .height(56.dp),
            colors = ButtonDefaults.buttonColors(
                containerColor = DoziCoral
            ),
            shape = RoundedCornerShape(16.dp)
        ) {
            Icon(Icons.Default.Add, contentDescription = null)
            Spacer(Modifier.width(8.dp))
            Text(
                "ƒ∞lk Konumu Ekle",
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.Bold
            )
        }
    }
}

@Composable
private fun LocationCard(
    place: SavedLocation,
    onDelete: () -> Unit
) {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .shadow(4.dp, RoundedCornerShape(20.dp)),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        shape = RoundedCornerShape(20.dp)
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(20.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            // Icon
            Box(
                modifier = Modifier
                    .size(56.dp)
                    .clip(CircleShape)
                    .background(DoziCoral.copy(alpha = 0.15f)),
                contentAlignment = Alignment.Center
            ) {
                Icon(
                    Icons.Default.LocationOn,
                    contentDescription = null,
                    tint = DoziCoral,
                    modifier = Modifier.size(28.dp)
                )
            }

            Spacer(Modifier.width(16.dp))

            // Info
            Column(modifier = Modifier.weight(1f)) {
                Text(
                    text = place.name,
                    style = MaterialTheme.typography.titleMedium,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
                if (place.address.isNotBlank()) {
                    Spacer(Modifier.height(4.dp))
                    Text(
                        text = place.address,
                        style = MaterialTheme.typography.bodySmall,

                        color = MaterialTheme.colorScheme.onSurfaceVariant,

                        maxLines = 1
                    )
                }
                Spacer(Modifier.height(6.dp))
                Text(
                    text = "üìç ${String.format("%.4f", place.lat)}, ${String.format("%.4f", place.lng)}",
                    style = MaterialTheme.typography.labelSmall,

                    color = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.7f)


                )
            }

            // Delete button
            IconButton(
                onClick = onDelete,
                modifier = Modifier
                    .size(40.dp)
                    .background(DoziCoral.copy(alpha = 0.1f), CircleShape)
            ) {
                Icon(
                    Icons.Default.Delete,
                    contentDescription = "Sil",
                    tint = DoziCoral
                )
            }
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
private fun MapPickerSheet(
    context: Context,
    onDismiss: () -> Unit,
    onConfirm: (LatLng?, String, String) -> Unit
) {
    val sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)
    var picked by remember { mutableStateOf<LatLng?>(null) }
    var name by remember { mutableStateOf("") }
    var searchQuery by remember { mutableStateOf("") }
    var address by remember { mutableStateOf("") }
    var isLoading by remember { mutableStateOf(false) }

    val cameraState = rememberCameraPositionState()
    val focusManager = LocalFocusManager.current
    val keyboardController = LocalSoftwareKeyboardController.current
    val scope = rememberCoroutineScope()
    val markerState = remember { MarkerState() }



    // Ba≈ülangƒ±√ß konumu
    LaunchedEffect(Unit) {
        isLoading = true
        try {
            val fused = LocationServices.getFusedLocationProviderClient(context)
            fused.lastLocation.addOnSuccessListener { loc ->
                if (loc != null) {
                    cameraState.position = CameraPosition.fromLatLngZoom(
                        LatLng(loc.latitude, loc.longitude),
                        14f
                    )
                }
                isLoading = false
            }.addOnFailureListener {
                isLoading = false
            }
        } catch (e: Exception) {
            isLoading = false
        }
    }

    ModalBottomSheet(
        onDismissRequest = onDismiss,
        sheetState = sheetState,
        dragHandle = null,
        containerColor = Color.White
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .fillMaxHeight(0.95f)
        ) {
            // Header
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .background(
                        Brush.horizontalGradient(
                            colors = listOf(DoziCoral, DoziCoralDark)
                        )
                    )
                    .padding(20.dp)
            ) {
                Column {
                    Text(
                        text = "Konum Se√ß",
                        style = MaterialTheme.typography.titleLarge,
                        fontWeight = FontWeight.Bold,
                        color = Color.White
                    )
                    Text(
                        text = "Haritadan bir yer se√ß ve isimlendir",
                        style = MaterialTheme.typography.bodyMedium,
                        color = Color.White.copy(alpha = 0.9f)
                    )
                }
            }

            // Search bar
            OutlinedTextField(
                value = searchQuery,
                onValueChange = { searchQuery = it },
                placeholder = { Text("Adres veya yer ara...") },
                leadingIcon = {
                    Icon(Icons.Default.Search, contentDescription = null, tint = DoziCoral)
                },
                trailingIcon = {
                    if (searchQuery.isNotBlank()) {
                        IconButton(onClick = {
                            focusManager.clearFocus()
                            keyboardController?.hide()
                            scope.launch {
                                try {
                                    val geocoder = Geocoder(context, Locale.getDefault())
                                    val results = geocoder.getFromLocationName(searchQuery, 1)
                                    if (!results.isNullOrEmpty()) {
                                        val loc = results[0]
                                        val pos = LatLng(loc.latitude, loc.longitude)
                                        cameraState.position = CameraPosition.fromLatLngZoom(pos, 15f)
                                        picked = pos
                                        address = loc.getAddressLine(0) ?: ""
                                    } else {
                                        Toast.makeText(context, "Sonu√ß bulunamadƒ±", Toast.LENGTH_SHORT).show()
                                    }
                                } catch (e: Exception) {
                                    Toast.makeText(context, "Arama hatasƒ±", Toast.LENGTH_SHORT).show()
                                }
                            }
                        }) {
                            Icon(Icons.Default.ArrowForward, contentDescription = "Ara", tint = DoziCoral)
                        }
                    }
                },
                singleLine = true,
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(16.dp),
                shape = RoundedCornerShape(16.dp),
                colors = OutlinedTextFieldDefaults.colors(
                    focusedBorderColor = DoziCoral,
                    focusedLabelColor = DoziCoral
                )
            )

            // Map
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .weight(1f)
                    .padding(horizontal = 16.dp)
                    .clip(RoundedCornerShape(16.dp))
            ) {
                GoogleMap(
                    modifier = Modifier.matchParentSize(),
                    cameraPositionState = cameraState,
                    uiSettings = MapUiSettings(
                        myLocationButtonEnabled = true,
                        zoomControlsEnabled = false
                    ),
                    properties = MapProperties(
                        isMyLocationEnabled = ContextCompat.checkSelfPermission(
                            context, Manifest.permission.ACCESS_FINE_LOCATION
                        ) == PackageManager.PERMISSION_GRANTED
                    ),
                    onMapClick = { latLng ->
                        markerState.position = latLng
                        picked = latLng
                    }
                ) {
                    Marker(
                        state = markerState,
                        title = "Se√ßilen konum"
                    )
                }

                if (isLoading) {
                    Box(
                        modifier = Modifier
                            .fillMaxSize()
                            .background(Color.White.copy(alpha = 0.8f)),
                        contentAlignment = Alignment.Center
                    ) {
                        CircularProgressIndicator(color = DoziCoral)
                    }
                }
            }

            // Name input
            OutlinedTextField(
                value = name,
                onValueChange = { name = it },
                label = { Text("Yer Adƒ±") },
                placeholder = { Text("√ñrn: Evim, ƒ∞≈üyerim, Okulum") },
                leadingIcon = {
                    Icon(Icons.Default.Label, contentDescription = null, tint = DoziCoral)
                },
                singleLine = true,
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 16.dp),
                shape = RoundedCornerShape(16.dp),
                colors = OutlinedTextFieldDefaults.colors(
                    focusedBorderColor = DoziCoral,
                    focusedLabelColor = DoziCoral
                )
            )

            // Address display
            if (address.isNotBlank()) {
                Card(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(horizontal = 16.dp)
                        .padding(top = 8.dp),
                    colors = CardDefaults.cardColors(
                        containerColor = DoziCoral.copy(alpha = 0.1f)
                    ),
                    shape = RoundedCornerShape(12.dp)
                ) {
                    Row(
                        modifier = Modifier.padding(12.dp),
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Icon(
                            Icons.Default.Place,
                            contentDescription = null,
                            tint = DoziCoral,
                            modifier = Modifier.size(20.dp)
                        )
                        Text(
                            text = address,
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurface
                        )
                    }
                }
            }

            // Buttons
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(16.dp),
                horizontalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                OutlinedButton(
                    onClick = onDismiss,
                    modifier = Modifier.weight(1f).height(56.dp),
                    shape = RoundedCornerShape(16.dp),
                    border = BorderStroke(1.dp, DoziCoral)
                ) {
                    Text("Vazge√ß", color = DoziCoral, fontWeight = FontWeight.Bold)
                }

                Button(
                    onClick = {
                        focusManager.clearFocus()
                        keyboardController?.hide()
                        onConfirm(picked, name, address)
                    },
                    modifier = Modifier.weight(1f).height(56.dp),
                    enabled = picked != null && name.isNotBlank(),
                    shape = RoundedCornerShape(16.dp),
                    colors = ButtonDefaults.buttonColors(
                        containerColor = DoziCoral
                    )
                ) {
                    Icon(Icons.Default.Check, contentDescription = null)
                    Spacer(Modifier.width(8.dp))
                    Text("Kaydet", fontWeight = FontWeight.Bold)
                }
            }
        }
    }
}

@SuppressLint("MissingPermission")
fun addGeofence(context: Context, id: String, lat: Double, lng: Double) {
    val geofence = Geofence.Builder()
        .setRequestId(id)
        .setCircularRegion(lat, lng, 150f) // 150 metre yarƒ±√ßap
        .setExpirationDuration(Geofence.NEVER_EXPIRE)
        .setTransitionTypes(Geofence.GEOFENCE_TRANSITION_ENTER)
        .build()

    val geofencingRequest = com.google.android.gms.location.GeofencingRequest.Builder()
        .setInitialTrigger(com.google.android.gms.location.GeofencingRequest.INITIAL_TRIGGER_ENTER)
        .addGeofence(geofence)
        .build()

    val intent = Intent(context, GeofenceReceiver::class.java)
    val pendingIntent = android.app.PendingIntent.getBroadcast(
        context,
        id.hashCode(),
        intent,
        android.app.PendingIntent.FLAG_UPDATE_CURRENT or android.app.PendingIntent.FLAG_MUTABLE
    )



    val geofencingClient = com.google.android.gms.location.LocationServices.getGeofencingClient(context)
    geofencingClient.addGeofences(geofencingRequest, pendingIntent)
        .addOnSuccessListener {
            android.widget.Toast.makeText(context, "üìç $id konumu eklendi", android.widget.Toast.LENGTH_SHORT).show()
        }
        .addOnFailureListener {
            android.widget.Toast.makeText(context, "Geofence kurulamadƒ±: ${it.message}", android.widget.Toast.LENGTH_SHORT).show()
        }
}

// ============================================================================
// FILE: ProfileScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/profile/ProfileScreen.kt
// [87 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.profile

import android.os.Build
import androidx.annotation.RequiresApi
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material.icons.outlined.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.bardino.dozi.core.data.model.User
import com.bardino.dozi.core.data.repository.UserRepository
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.screens.login.LoginScreen
import com.bardino.dozi.core.ui.theme.*
import com.google.firebase.auth.FirebaseAuth
import kotlinx.coroutines.launch
import java.text.SimpleDateFormat
import java.util.*

@RequiresApi(Build.VERSION_CODES.O)
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ProfileScreen(
    onNavigateToLocations: () -> Unit = {},
    onNavigateToPremium: () -> Unit = {},
    onNavigateToFamilyManagement: () -> Unit = {},
    onNavigateToSettings: () -> Unit = {},
    onNavigateToNotifications: () -> Unit = {},
    onNavigateToAbout: () -> Unit = {},
    onNavigateToSupport: () -> Unit = {},
    onNavigateToHome: () -> Unit = {},
    onGoogleSignInClick: () -> Unit
) {
    val auth = remember { FirebaseAuth.getInstance() }
    var currentUser by remember { mutableStateOf(auth.currentUser) }

    DisposableEffect(Unit) {
        val listener = FirebaseAuth.AuthStateListener { firebaseAuth ->
            currentUser = firebaseAuth.currentUser
        }
        auth.addAuthStateListener(listener)
        onDispose { auth.removeAuthStateListener(listener) }
    }

    if (currentUser == null) {
        LoginScreen(
            onLoginSuccess = onNavigateToHome,
            onSkip = onNavigateToHome
        )
    } else {
        ProfileContent(
            user = currentUser,
            onNavigateToLocations = onNavigateToLocations,
            onNavigateToPremium = onNavigateToPremium,
            onNavigateToFamilyManagement = onNavigateToFamilyManagement,
            onNavigateToSettings = onNavigateToSettings,
            onNavigateToNotifications = onNavigateToNotifications,
            onNavigateToAbout = onNavigateToAbout,
            onNavigateToSupport = onNavigateToSupport,
            onLogout = {
                auth.signOut()
                onNavigateToHome()
            }
        )
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
private fun ProfileContent(
    user: com.google.firebase.auth.FirebaseUser?,
    onNavigateToLocations: () -> Unit,
    onNavigateToPremium: () -> Unit,
    onNavigateToFamilyManagement: () -> Unit,
    onNavigateToSettings: () -> Unit,
    onNavigateToNotifications: () -> Unit,
    onNavigateToAbout: () -> Unit,
    onNavigateToSupport: () -> Unit,
    onLogout: () -> Unit
) {
    val context = LocalContext.current
    val userRepository = remember { UserRepository() }
    val scope = rememberCoroutineScope()

    var firestoreUser by remember { mutableStateOf<User?>(null) }
    var isLoading by remember { mutableStateOf(true) }
    var showLogoutDialog by remember { mutableStateOf(false) }

    LaunchedEffect(user?.uid) {
        scope.launch {
            try {
                firestoreUser = userRepository.getUserData()
                // Debug logging
                firestoreUser?.let { u ->
                    android.util.Log.d("ProfileScreen", "üìä User loaded:")
                    android.util.Log.d("ProfileScreen", "  - isPremium: ${u.isPremium}")
                    android.util.Log.d("ProfileScreen", "  - isTrial: ${u.isTrial}")
                    android.util.Log.d("ProfileScreen", "  - planType: ${u.planType}")
                    android.util.Log.d("ProfileScreen", "  - premiumExpiryDate: ${u.premiumExpiryDate}")
                    android.util.Log.d("ProfileScreen", "  - isCurrentlyPremium(): ${u.isCurrentlyPremium()}")
                    android.util.Log.d("ProfileScreen", "  - premiumDaysRemaining(): ${u.premiumDaysRemaining()}")
                    android.util.Log.d("ProfileScreen", "  - premiumPlanType(): ${u.premiumPlanType()}")
                }
                isLoading = false
            } catch (e: Exception) {
                android.util.Log.e("ProfileScreen", "Error loading user", e)
                isLoading = false
            }
        }
    }

    if (showLogoutDialog) {
        AlertDialog(
            onDismissRequest = { showLogoutDialog = false },
            title = { Text("√áƒ±kƒ±≈ü Yap") },
            text = { Text("√áƒ±kƒ±≈ü yapmak istediƒüinize emin misiniz?") },
            confirmButton = {
                TextButton(
                    onClick = {
                        showLogoutDialog = false
                        onLogout()
                    }
                ) {
                    Text("√áƒ±kƒ±≈ü Yap", color = Color.Red)
                }
            },
            dismissButton = {
                TextButton(onClick = { showLogoutDialog = false }) {
                    Text("ƒ∞ptal")
                }
            }
        )
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Text(
                        text = "Profil",
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                },
                actions = {
                    IconButton(onClick = { showLogoutDialog = true }) {
                        Icon(
                            Icons.Default.Logout,
                            contentDescription = "√áƒ±kƒ±≈ü Yap",
                            tint = Color.Red
                        )
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = MaterialTheme.colorScheme.surface
                )
            )
        },
        containerColor = MaterialTheme.colorScheme.background
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .verticalScroll(rememberScrollState())
        ) {
            // User Profile Header with Gradient
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .background(
                        brush = Brush.verticalGradient(
                            colors = listOf(
                                DoziTurquoise,
                                DoziTurquoise.copy(alpha = 0.8f)
                            )
                        )
                    )
                    .padding(24.dp)
            ) {
                Column(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalAlignment = Alignment.CenterHorizontally
                ) {
                    // Avatar
                    Box(
                        modifier = Modifier
                            .size(80.dp)
                            .clip(CircleShape)
                            .background(Color.White.copy(alpha = 0.2f))
                            .border(3.dp, Color.White, CircleShape),
                        contentAlignment = Alignment.Center
                    ) {
                        Text(
                            text = (firestoreUser?.name?.firstOrNull()?.uppercase()
                                ?: user?.email?.firstOrNull()?.uppercase()
                                ?: "U").toString(),
                            fontSize = 32.sp,
                            fontWeight = FontWeight.Bold,
                            color = Color.White
                        )
                    }

                    Spacer(modifier = Modifier.height(12.dp))

                    // Name
                    Text(
                        text = firestoreUser?.name ?: user?.displayName ?: "Kullanƒ±cƒ±",
                        style = MaterialTheme.typography.titleLarge,
                        fontWeight = FontWeight.Bold,
                        color = Color.White
                    )

                    // Email
                    Text(
                        text = user?.email ?: "",
                        style = MaterialTheme.typography.bodyMedium,
                        color = Color.White.copy(alpha = 0.8f)
                    )

                    // Premium Badge
                    Spacer(modifier = Modifier.height(12.dp))

                    val premiumStatus = firestoreUser?.premiumStatus()
                    val isCurrentlyPremium = premiumStatus?.isActive == true
                    val isTrial = premiumStatus?.isTrial == true
                    val daysRemaining = premiumStatus?.daysRemaining() ?: 0
                    val planName = premiumStatus?.planType?.toTurkish()

                    Surface(
                        shape = RoundedCornerShape(20.dp),
                        color = if (isCurrentlyPremium) Color.White.copy(alpha = 0.2f) else Color.White.copy(alpha = 0.15f)
                    ) {
                        Row(
                            modifier = Modifier.padding(horizontal = 12.dp, vertical = 6.dp),
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Icon(
                                imageVector = when {
                                    isLoading -> Icons.Default.Sync
                                    isCurrentlyPremium -> Icons.Default.Star
                                    else -> Icons.Default.StarBorder
                                },
                                contentDescription = null,
                                tint = Color.White,
                                modifier = Modifier.size(16.dp)
                            )
                            Spacer(modifier = Modifier.width(6.dp))
                            Text(
                                text = when {
                                    isLoading -> "Y√ºkleniyor..."
                                    isCurrentlyPremium && isTrial -> {
                                        if (daysRemaining > 0) "Deneme - $daysRemaining g√ºn kaldƒ±" else "Deneme S√ºr√ºm√º"
                                    }
                                    isCurrentlyPremium -> {
                                        val planLabel = planName ?: "Dozi Ekstra"
                                        if (daysRemaining > 0) "$planLabel - $daysRemaining g√ºn" else planLabel
                                    }
                                    else -> "√úcretsiz Plan"
                                },
                                style = MaterialTheme.typography.bodySmall,
                                fontWeight = FontWeight.SemiBold,
                                color = Color.White
                            )
                        }
                    }
                }
            }

            Spacer(modifier = Modifier.height(16.dp))

            // Quick Actions Grid
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 16.dp),
                horizontalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                QuickActionCard(
                    icon = Icons.Default.HelpOutline,
                    title = "Destek",
                    backgroundColor = DoziTurquoise.copy(alpha = 0.1f),
                    iconColor = DoziTurquoise,
                    onClick = onNavigateToSupport,
                    modifier = Modifier.weight(1f)
                )
                QuickActionCard(
                    icon = Icons.Default.Star,
                    title = "Ekstra",
                    backgroundColor = Color(0xFFFFF3E0),
                    iconColor = Color(0xFFFF9800),
                    onClick = onNavigateToPremium,
                    modifier = Modifier.weight(1f)
                )
            }

            Spacer(modifier = Modifier.height(12.dp))

            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 16.dp),
                horizontalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                QuickActionCard(
                    icon = Icons.Default.LocationOn,
                    title = "Konumlar",
                    backgroundColor = Color(0xFFE3F2FD),
                    iconColor = Color(0xFF2196F3),
                    onClick = onNavigateToLocations,
                    modifier = Modifier.weight(1f)
                )
                QuickActionCard(
                    icon = Icons.Default.Settings,
                    title = "Ayarlar",
                    backgroundColor = Color(0xFFF3E5F5),
                    iconColor = Color(0xFF9C27B0),
                    onClick = onNavigateToSettings,
                    modifier = Modifier.weight(1f)
                )
            }

            Spacer(modifier = Modifier.height(20.dp))

            // Other Options Card
            Card(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 16.dp),
                colors = CardDefaults.cardColors(
                    containerColor = MaterialTheme.colorScheme.surface
                ),
                shape = RoundedCornerShape(16.dp)
            ) {
                Column {
                    if (firestoreUser?.familyPlanId != null) {
                        CompactMenuItem(
                            icon = Icons.Default.FamilyRestroom,
                            title = "Aile Y√∂netimi",
                            onClick = onNavigateToFamilyManagement
                        )
                        HorizontalDivider(
                            modifier = Modifier.padding(horizontal = 16.dp),
                            color = MaterialTheme.colorScheme.outlineVariant.copy(alpha = 0.5f)
                        )
                    }

                    CompactMenuItem(
                        icon = Icons.Default.Notifications,
                        title = "Bildirimler",
                        onClick = onNavigateToNotifications
                    )

                    HorizontalDivider(
                        modifier = Modifier.padding(horizontal = 16.dp),
                        color = MaterialTheme.colorScheme.outlineVariant.copy(alpha = 0.5f)
                    )

                    CompactMenuItem(
                        icon = Icons.Default.Info,
                        title = "Hakkƒ±nda",
                        onClick = onNavigateToAbout
                    )
                }
            }

            // Bottom padding for navigation bar
            Spacer(modifier = Modifier.height(100.dp))
        }
    }
}

@Composable
private fun QuickActionCard(
    icon: ImageVector,
    title: String,
    backgroundColor: Color,
    iconColor: Color,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier,
        colors = CardDefaults.cardColors(
            containerColor = backgroundColor
        ),
        shape = RoundedCornerShape(16.dp),
        onClick = onClick
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Box(
                modifier = Modifier
                    .size(48.dp)
                    .clip(CircleShape)
                    .background(iconColor.copy(alpha = 0.15f)),
                contentAlignment = Alignment.Center
            ) {
                Icon(
                    imageVector = icon,
                    contentDescription = null,
                    tint = iconColor,
                    modifier = Modifier.size(24.dp)
                )
            }
            Spacer(modifier = Modifier.height(8.dp))
            Text(
                text = title,
                style = MaterialTheme.typography.bodyMedium,
                fontWeight = FontWeight.SemiBold,
                color = MaterialTheme.colorScheme.onSurface
            )
        }
    }
}

@Composable
private fun CompactMenuItem(
    icon: ImageVector,
    title: String,
    onClick: () -> Unit
) {
    Surface(
        modifier = Modifier.fillMaxWidth(),
        onClick = onClick,
        color = Color.Transparent
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp, vertical = 14.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Icon(
                imageVector = icon,
                contentDescription = null,
                tint = MaterialTheme.colorScheme.onSurfaceVariant,
                modifier = Modifier.size(22.dp)
            )
            Spacer(modifier = Modifier.width(16.dp))
            Text(
                text = title,
                style = MaterialTheme.typography.bodyLarge,
                color = MaterialTheme.colorScheme.onSurface,
                modifier = Modifier.weight(1f)
            )
            Icon(
                imageVector = Icons.Default.ChevronRight,
                contentDescription = null,
                tint = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.5f),
                modifier = Modifier.size(20.dp)
            )
        }
    }
}


// ============================================================================
// FILE: AddReminderScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/reminder/AddReminderScreen.kt
// [88 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.reminder

import android.Manifest
import android.app.DatePickerDialog
import android.app.TimePickerDialog
import android.content.Context
import android.os.Build
import android.widget.Toast
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.annotation.RequiresApi
import androidx.compose.animation.*
import androidx.compose.animation.core.*
import androidx.compose.foundation.*
import androidx.compose.foundation.interaction.MutableInteractionSource
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyRow
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.scale
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalFocusManager
import androidx.compose.ui.platform.LocalLifecycleOwner
import androidx.lifecycle.Lifecycle
import androidx.lifecycle.repeatOnLifecycle
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.window.Dialog
import androidx.navigation.NavHostController
import com.bardino.dozi.DoziApplication
import com.bardino.dozi.R
import com.bardino.dozi.core.data.MedicineLookupRepository
import com.bardino.dozi.core.data.model.Medicine
import com.bardino.dozi.core.data.model.MedicineCriticality
import com.bardino.dozi.core.data.repository.MedicineRepository
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*
import com.bardino.dozi.core.utils.SoundHelper
import com.bardino.dozi.navigation.Screen
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import java.text.SimpleDateFormat
import java.util.*
import dagger.hilt.EntryPoint
import dagger.hilt.InstallIn
import dagger.hilt.android.EntryPointAccessors
import dagger.hilt.components.SingletonComponent
import com.bardino.dozi.core.premium.PremiumManager
import com.bardino.dozi.core.ui.components.PremiumLimitDialog
import com.bardino.dozi.core.ui.components.LimitIndicator
import com.bardino.dozi.core.common.Constants

// EntryPoint for accessing PremiumManager in Composable
@EntryPoint
@InstallIn(SingletonComponent::class)
interface AddReminderEntryPoint {
    fun premiumManager(): PremiumManager
}

// Medicine entry data class
data class MedicineEntry(
    val id: Int,
    var name: String = "",
    var reminderName: String = "", // Hatƒ±rlatma i√ßin √∂zel isim
    var dosageType: String = "1",
    var customDosage: String = "",
    var unit: String = "hap",
    var isCritical: Boolean = false // Kritik ila√ß - t√ºm bildirimler IMPORTANT seviyesinde
)

// Time entry data class - Her saat i√ßin not tutulabilir
data class TimeEntry(
    val time: String,           // "08:00"
    val note: String = ""       // "Tok karnƒ±na", "A√ß karnƒ±na", vs.
)

@RequiresApi(Build.VERSION_CODES.O)
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun AddReminderScreen(
    onNavigateBack: () -> Unit,
    navController: NavHostController,
    modifier: Modifier = Modifier,
    medicineId: String? = null  // Edit mode i√ßin medicine ID
) {
    val context = LocalContext.current
    val focusManager = LocalFocusManager.current
    val lifecycleOwner = LocalLifecycleOwner.current
    var selectedPlace by remember { mutableStateOf<String?>(null) }

    // üíé Premium Manager i√ßin EntryPoint eri≈üimi
    val premiumManager = remember {
        EntryPointAccessors.fromApplication(
            context.applicationContext,
            AddReminderEntryPoint::class.java
        ).premiumManager()
    }

    // üìä Limit kontrol state'leri
    var showLimitDialog by remember { mutableStateOf(false) }
    var limitDialogType by remember { mutableStateOf("medicine") } // "medicine" veya "reminder"
    var currentMedicineCount by remember { mutableStateOf(0) }
    var currentReminderCount by remember { mutableStateOf(0) }
    var medicineLimit by remember { mutableStateOf(Constants.FREE_MEDICINE_LIMIT) }
    var reminderLimit by remember { mutableStateOf(Constants.FREE_REMINDER_LIMIT) }

    // üîî Bildirim izni kontrol√º ve isteme
    var showPermissionDialog by remember { mutableStateOf(false) }
    val notificationPermissionLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.RequestPermission()
    ) { isGranted ->
        if (isGranted) {
            android.util.Log.d("AddReminder", "‚úÖ Bildirim izni verildi")
            Toast.makeText(context, "Bildirim izni verildi ‚úÖ", Toast.LENGTH_SHORT).show()
        } else {
            android.util.Log.w("AddReminder", "‚ö†Ô∏è Bildirim izni reddedildi")
            Toast.makeText(
                context,
                "‚ö†Ô∏è Bildirim izni olmadan hatƒ±rlatmalar √ßalƒ±≈ümayacak",
                Toast.LENGTH_LONG
            ).show()
        }
    }

    // Edit mode kontrol√º veya medicineId ile direkt ila√ß se√ßimi
    val isEditMode = medicineId != null
    val isPreselectedMedicine = medicineId != null

    // üìä Limit ve saya√ßlarƒ± y√ºkle
    LaunchedEffect(Unit) {
        try {
            val medicineRepository = MedicineRepository()

            // Mevcut sayƒ±larƒ± al
            val allMedicines = medicineRepository.getAllMedicines()
            currentMedicineCount = allMedicines.size
            currentReminderCount = allMedicines.sumOf { it.times.size }

            // Limitleri al
            medicineLimit = premiumManager.getMedicineLimit()
            reminderLimit = premiumManager.getReminderLimit()

            android.util.Log.d("AddReminder", "üìä Limits loaded - Medicines: $currentMedicineCount/$medicineLimit, Reminders: $currentReminderCount/$reminderLimit")
        } catch (e: Exception) {
            android.util.Log.e("AddReminder", "Error loading limits", e)
        }
    }

    var isLoading by remember { mutableStateOf(false) }

    // State'ler
    var step by remember { mutableStateOf(1) }
    var medicines by remember { mutableStateOf(listOf(MedicineEntry(id = 0))) }
    var selectedTimes by remember { mutableStateOf<List<TimeEntry>>(listOf(TimeEntry("08:00"))) }
    var frequency by remember { mutableStateOf("Her g√ºn") }
    var xValue by remember { mutableStateOf(2) }
    var selectedDates by remember { mutableStateOf<List<String>>(emptyList()) }
    var startDate by remember { mutableStateOf(System.currentTimeMillis()) } // Ba≈ülangƒ±√ß tarihi
    var endDate by remember { mutableStateOf<Long?>(null) } // Biti≈ü tarihi (opsiyonel)
    var showError by remember { mutableStateOf(false) }
    var showSuccess by remember { mutableStateOf(false) }
    val storedMedicines = remember {
        MedicineLookupRepository
            .loadLocalMedicines(context).map { it.name }
    }
    var selectedMedicineIndex by remember { mutableStateOf(-1) }

    // MedicineId ile geldiyse, o ilacƒ±n adƒ±nƒ± y√ºkle ve otomatik se√ß
    LaunchedEffect(medicineId) {
        if (isPreselectedMedicine && medicineId != null) {
            isLoading = true
            try {
                // Local repository'den ila√ß adƒ±nƒ± al
                val localMedicine = MedicineLookupRepository.getLocalMedicine(context, medicineId)
                if (localMedicine != null) {
                    medicines = listOf(MedicineEntry(
                        id = 0,
                        name = localMedicine.name,
                        dosageType = "1",
                        customDosage = "",
                        unit = "hap"
                    ))
                    android.util.Log.d("AddReminder", "‚úÖ Pre-selected medicine: ${localMedicine.name}")
                }
            } catch (e: Exception) {
                android.util.Log.e("AddReminder", "Error loading pre-selected medicine", e)
            } finally {
                isLoading = false
            }
        }
    }

    // Ses kontrol√º
    var soundEnabled by remember {
        mutableStateOf(
            context.getSharedPreferences("dozi_prefs", Context.MODE_PRIVATE)
                .getBoolean("sound_enabled", true)
        )
    }

    // Edit mode: Mevcut medicine verisini y√ºkle
    LaunchedEffect(medicineId) {
        if (isEditMode && medicineId != null) {
            try {
                val repository = MedicineRepository()
                val medicine = repository.getMedicineById(medicineId)

                if (medicine != null) {
                    // Medicine verisini state'lere doldur
                    medicines = listOf(MedicineEntry(
                        id = 0,
                        name = medicine.name,
                        dosageType = medicine.dosage.split(" ").firstOrNull() ?: "1",
                        customDosage = medicine.dosage
                    ))

                    // Saatleri y√ºkle
                    selectedTimes = if (medicine.times.isNotEmpty()) {
                        medicine.times.map { TimeEntry(it) }
                    } else {
                        listOf(TimeEntry("08:00"))
                    }

                    frequency = medicine.frequency
                    xValue = medicine.frequencyValue
                    selectedDates = medicine.days
                    // Eƒüer startDate 0 veya 1970 √∂ncesi ise bug√ºn√º kullan
                    startDate = if (medicine.startDate > 0L && medicine.startDate > 946684800000L) {
                        medicine.startDate
                    } else {
                        System.currentTimeMillis()
                    }
                }
                isLoading = false
            } catch (e: Exception) {
                isLoading = false
                Toast.makeText(context, "Hatƒ±rlatma y√ºklenirken hata: ${e.message}", Toast.LENGTH_SHORT).show()
            }
        }
    }

    // MedicineListScreen'den d√∂nen ila√ß ismini al
    LaunchedEffect(navController.currentBackStackEntry) {
        navController.currentBackStackEntry
            ?.savedStateHandle
            ?.get<String>("selectedMedicine")
            ?.let { selectedName ->
                if (selectedMedicineIndex >= 0 && selectedMedicineIndex < medicines.size) {
                    medicines = medicines.toMutableList().also {
                        it[selectedMedicineIndex] = it[selectedMedicineIndex].copy(name = selectedName)
                    }
                }
                selectedMedicineIndex = -1
                // Kullanƒ±ldƒ±ktan sonra temizle
                navController.currentBackStackEntry
                    ?.savedStateHandle
                    ?.remove<String>("selectedMedicine")
            }
    }

    var isVisible by remember { mutableStateOf(false) }

    LaunchedEffect(Unit) {
        isVisible = true
    }

    LaunchedEffect(step, soundEnabled) {
        if (soundEnabled && step <= 4) {
            playStepSound(context, step, soundEnabled)
        }
    }

    DisposableEffect(Unit) {
        onDispose {
            // Ekrandan √ßƒ±kƒ±≈üta √ßalan sesi durdur
            SoundHelper.stopCurrentSound()
        }
    }

    Scaffold(
        modifier = modifier,
        topBar = {
            DoziTopBar(
                title = if (isEditMode) "Hatƒ±rlatma D√ºzenle" else "Hatƒ±rlatma Asistanƒ±",
                canNavigateBack = true,
                onNavigateBack = {
                    if (step > 1) step-- else onNavigateBack()
                },
                actions = {
                    IconButton(
                        onClick = {
                            soundEnabled = !soundEnabled
                            context.getSharedPreferences("dozi_prefs", Context.MODE_PRIVATE)
                                .edit()
                                .putBoolean("sound_enabled", soundEnabled)
                                .apply()
                        }
                    ) {
                        Icon(
                            imageVector = if (soundEnabled) Icons.Default.VolumeUp else Icons.Default.VolumeOff,
                            contentDescription = if (soundEnabled) "Sesi Kapat" else "Sesi A√ß",
                            tint = if (soundEnabled) DoziTurquoise else MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
            )
        }
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .clickable(
                    indication = null,
                    interactionSource = remember { MutableInteractionSource() }
                ) { focusManager.clearFocus() }
        ) {
            Column(
                modifier = Modifier
                    .weight(1f)
                    .verticalScroll(rememberScrollState())
                    .padding(horizontal = 24.dp, vertical = 16.dp),
                verticalArrangement = Arrangement.spacedBy(20.dp),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                AnimatedVisibility(
                    visible = isVisible,
                    enter = fadeIn() + expandVertically()
                ) {
                    StepProgressIndicator(currentStep = step, totalSteps = 4)
                }

                AnimatedVisibility(
                    visible = isVisible,
                    enter = slideInVertically(initialOffsetY = { -50 }) + fadeIn()
                ) {
                    DoziSpeechBubble(step = step, soundEnabled = soundEnabled)
                }

                AnimatedContent(
                    targetState = step,
                    transitionSpec = {
                        slideInHorizontally(
                            initialOffsetX = { if (targetState > initialState) 300 else -300 }
                        ) + fadeIn() togetherWith
                                slideOutHorizontally(
                                    targetOffsetX = { if (targetState > initialState) -300 else 300 }
                                ) + fadeOut()
                    },
                    label = "step_transition"
                ) { currentStep ->
                    when (currentStep) {
                        1 -> MultipleMedicinesStep(
                            medicines = medicines,
                            onMedicinesChange = { medicines = it },
                            storedMedicines = storedMedicines,
                            onAddNewMedicine = { index ->
                                selectedMedicineIndex = index
                                navController.navigate(Screen.MedicineLookup.route)
                            },
                            showError = showError
                        )

                        2 -> FrequencyStep(
                            selected = frequency,
                            xValue = xValue,
                            selectedDates = selectedDates,
                            startDate = startDate,
                            endDate = endDate,
                            onSelect = { frequency = it },
                            onXChange = { xValue = it },
                            onDatesChange = { selectedDates = it },
                            onStartDateChange = { startDate = it },
                            onEndDateChange = { endDate = it },
                            context = context
                        )

                        3 -> TimeStep(
                            selectedTimes = selectedTimes,
                            onTimesChange = { selectedTimes = it },
                            context = context
                        )

                        4 -> SummaryStep(
                            medicines = medicines,
                            selectedTimes = selectedTimes,
                            frequency = frequency,
                            xValue = xValue,
                            selectedDates = selectedDates
                        )
                    }
                }
            }

            AnimatedVisibility(
                visible = isVisible,
                enter = slideInVertically(initialOffsetY = { 100 }) + fadeIn()
            ) {
                NavigationButtons(
                    step = step,
                    medicineName = medicines.firstOrNull()?.name ?: "",
                    onBack = { step-- },
                    onNext = {
                        when (step) {
                            1 -> {
                                if (medicines.any { it.name.isBlank() }) {
                                    showError = true
                                } else {
                                    showError = false
                                    step++
                                }
                            }
                            2 -> step++
                            3 -> step++
                            4 -> {
                                // üîî Bildirim izni kontrol√º (Android 13+)
                                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                                    if (!com.bardino.dozi.notifications.PermissionHandler.hasNotificationPermission(context)) {
                                        // ƒ∞zin yok, dialog g√∂ster
                                        showPermissionDialog = true
                                        return@NavigationButtons
                                    }
                                }

                                // üìä Limit kontrol√º (Edit mode hari√ß)
                                if (!isEditMode) {
                                    val newTimeSlotsCount = selectedTimes.size

                                    // ƒ∞la√ß limiti kontrol√º
                                    if (medicineLimit != Constants.UNLIMITED && currentMedicineCount >= medicineLimit) {
                                        limitDialogType = "medicine"
                                        showLimitDialog = true
                                        return@NavigationButtons
                                    }

                                    // Hatƒ±rlatma (time slot) limiti kontrol√º
                                    if (reminderLimit != Constants.UNLIMITED &&
                                        (currentReminderCount + newTimeSlotsCount) > reminderLimit) {
                                        limitDialogType = "reminder"
                                        showLimitDialog = true
                                        return@NavigationButtons
                                    }
                                }

                                // T√ºm ila√ßlarƒ± kaydet
                                saveMedicinesToFirestore(
                                    context = context,
                                    medicines = medicines,
                                    selectedTimes = selectedTimes,
                                    frequency = frequency,
                                    xValue = xValue,
                                    selectedDates = selectedDates,
                                    startDate = startDate,
                                    endDate = endDate,
                                    medicineId = medicineId,
                                    onSuccess = {
                                        if (soundEnabled) playSuccessSound(context)
                                        showSuccess = true
                                    },
                                    onError = {
                                        Toast.makeText(
                                            context,
                                            "‚ùå Hatƒ±rlatmalar kaydedilemedi",
                                            Toast.LENGTH_SHORT
                                        ).show()
                                    }
                                )
                            }
                        }
                    }
                )
            }
        }
    }

    if (showSuccess) {
        ReminderSuccessDialog(
            onAddAnother = {
                // Ba≈üka ila√ß ekle - her ≈üeyi sƒ±fƒ±rla
                showSuccess = false
                step = 1
                medicines = listOf(MedicineEntry(id = 0))
                frequency = "Her g√ºn"
                selectedDates = emptyList()
                startDate = System.currentTimeMillis()
                endDate = null
                selectedTimes = listOf(TimeEntry("08:00"))
            },
            onFinish = {
                showSuccess = false
                onNavigateBack()
            },
            isOnboarding = false
        )
    }

    // üìä Premium limit dialog'u
    if (showLimitDialog) {
        val issMedicineLimit = limitDialogType == "medicine"
        PremiumLimitDialog(
            title = if (issMedicineLimit) "ƒ∞la√ß Limitine Ula≈ütƒ±nƒ±z" else "Hatƒ±rlatma Limitine Ula≈ütƒ±nƒ±z",
            message = if (issMedicineLimit)
                "√úcretsiz planda sadece 1 ila√ß ekleyebilirsiniz. Sƒ±nƒ±rsƒ±z ila√ß i√ßin Dozi Ekstra'ya y√ºkseltin."
            else
                "√úcretsiz planda sadece 2 hatƒ±rlatma saati ekleyebilirsiniz. Sƒ±nƒ±rsƒ±z hatƒ±rlatma i√ßin Dozi Ekstra'ya y√ºkseltin.",
            currentCount = if (issMedicineLimit) currentMedicineCount else currentReminderCount,
            maxCount = if (issMedicineLimit) medicineLimit else reminderLimit,
            requiredPlan = "Dozi Ekstra",
            onDismiss = {
                showLimitDialog = false
            },
            onUpgrade = {
                showLimitDialog = false
                // Premium ekranƒ±na y√∂nlendir
                navController.navigate(Screen.Premium.route)
            }
        )
    }

    // üîî Bildirim izni dialog'u
    if (showPermissionDialog) {
        NotificationPermissionDialog(
            onRequestPermission = {
                showPermissionDialog = false
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                    notificationPermissionLauncher.launch(Manifest.permission.POST_NOTIFICATIONS)
                }
            },
            onOpenSettings = {
                showPermissionDialog = false
                com.bardino.dozi.notifications.PermissionHandler.openAppSettings(context)
            },
            onDismiss = {
                showPermissionDialog = false
                Toast.makeText(
                    context,
                    "‚ö†Ô∏è Bildirim izni olmadan hatƒ±rlatmalar √ßalƒ±≈ümayacak",
                    Toast.LENGTH_LONG
                ).show()
            }
        )
    }
}

private fun playStepSound(context: Context, step: Int, soundEnabled: Boolean) {
    if (!soundEnabled) return

    try {
        val soundType = when (step) {
            1 -> SoundHelper.SoundType.REMINDER_1
            2 -> SoundHelper.SoundType.REMINDER_2
            3 -> SoundHelper.SoundType.REMINDER_3
            4 -> SoundHelper.SoundType.REMINDER_4
            else -> return
        }

        SoundHelper.playSound(context, soundType)
    } catch (e: Exception) {
        e.printStackTrace()
    }
}

private fun playSuccessSound(context: Context) {
    try {
        SoundHelper.playSound(context, SoundHelper.SoundType.HERSEY_TAMAM)
    } catch (e: Exception) {
        // Ses dosyasƒ± yoksa sessizce devam et
    }
}

// UI COMPONENTS
@Composable
private fun StepProgressIndicator(currentStep: Int, totalSteps: Int) {
    Column(
        modifier = Modifier.fillMaxWidth(),
        verticalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        LinearProgressIndicator(
            progress = currentStep / totalSteps.toFloat(),
            modifier = Modifier
                .fillMaxWidth()
                .height(6.dp)
                .clip(MaterialTheme.shapes.small),
            color = DoziCoral,
            trackColor = Gray200
        )
        Text(
            text = "Adƒ±m $currentStep / $totalSteps",
            style = MaterialTheme.typography.labelLarge,

            color = MaterialTheme.colorScheme.onSurfaceVariant,

            modifier = Modifier.align(Alignment.End)
        )
    }
}

@Composable
private fun AnimatedDoziIcon(step: Int) {
    val infiniteTransition = rememberInfiniteTransition(label = "dozi")
    val scale by infiniteTransition.animateFloat(
        initialValue = 1f,
        targetValue = 1.15f,
        animationSpec = infiniteRepeatable(
            animation = tween(1000, easing = EaseInOutSine),
            repeatMode = RepeatMode.Reverse
        ),
        label = "scale"
    )

    val doziImage = when (step) {
        1 -> R.drawable.dozi_teach1
        2 -> R.drawable.dozi_teach2
        3 -> R.drawable.dozi_teach3
        4 -> R.drawable.dozi_teach4
        else -> R.drawable.dozi_perfect
    }

    Image(
        painter = painterResource(id = doziImage),
        contentDescription = "Dozi",
        modifier = Modifier.size(48.dp).scale(scale)
    )
}

@Composable
private fun DoziSpeechBubble(step: Int, soundEnabled: Boolean) {
    val text = when (step) {
        1 -> "üíä Hangi ila√ßlarƒ± eklemek istersin? Birden fazla ila√ß ekleyebilirsin!"
        2 -> "üîÅ Ne kadar sƒ±klƒ±kla alƒ±yorsun?"
        3 -> "‚è∞ Harika! ≈ûimdi saati belirleyelim."
        4 -> "‚úÖ Neredeyse bitti! G√∂zden ge√ßirip kaydedelim."
        else -> ""
    }

    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.Transparent),
        shape = MaterialTheme.shapes.large
    ) {
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .background(
                    brush = Brush.horizontalGradient(GradientCoral),
                    shape = MaterialTheme.shapes.large
                )
                .padding(20.dp)
        ) {
            Row(
                horizontalArrangement = Arrangement.spacedBy(16.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                AnimatedDoziIcon(step)
                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        text = text,
                        color = Color.White,
                        style = MaterialTheme.typography.bodyLarge,
                        fontWeight = FontWeight.Medium
                    )
                }
            }
        }
    }
}

// ADIM 1 - √áOKLU ƒ∞LA√á EKLEME
@Composable
private fun MultipleMedicinesStep(
    medicines: List<MedicineEntry>,
    onMedicinesChange: (List<MedicineEntry>) -> Unit,
    storedMedicines: List<String>,
    onAddNewMedicine: (Int) -> Unit,
    showError: Boolean
) {
    var showPickerForIndex by remember { mutableStateOf(-1) }

    Column(
        modifier = Modifier.fillMaxWidth(),
        verticalArrangement = Arrangement.spacedBy(16.dp)
    ) {
        medicines.forEachIndexed { index, medicine ->
            Card(
                modifier = Modifier.fillMaxWidth(),
                colors = CardDefaults.cardColors(containerColor = Color.White),
                shape = MaterialTheme.shapes.medium,
                border = if (showError && medicine.name.isBlank()) {
                    BorderStroke(2.dp, ErrorRed)
                } else {
                    BorderStroke(1.dp, Gray200)
                }
            ) {
                Column(
                    modifier = Modifier.padding(16.dp),
                    verticalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Text(
                            "ƒ∞la√ß ${index + 1}",
                            style = MaterialTheme.typography.labelLarge,
                            fontWeight = FontWeight.Bold,
                            color = DoziTurquoise
                        )

                        if (medicines.size > 1) {
                            IconButton(
                                onClick = {
                                    onMedicinesChange(medicines.filterIndexed { i, _ -> i != index })
                                }
                            ) {
                                Icon(
                                    Icons.Default.Close,
                                    contentDescription = "Kaldƒ±r",
                                    tint = ErrorRed,
                                    modifier = Modifier.size(20.dp)
                                )
                            }
                        }
                    }

                    // ƒ∞la√ß se√ßici
                    MedicinePickerRow(
                        selectedName = medicine.name,
                        onSelect = {
                            if (storedMedicines.isNotEmpty()) {
                                showPickerForIndex = index
                            } else {
                                onAddNewMedicine(index)
                            }
                        },
                        onAddNew = { onAddNewMedicine(index) }
                    )

                    // Hatƒ±rlatma adƒ± (√∂zel isim)
                    Text(
                        "Hatƒ±rlatma Adƒ± (ƒ∞steƒüe Baƒülƒ±)",
                        style = MaterialTheme.typography.labelLarge,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface
                    )

                    OutlinedTextField(
                        value = medicine.reminderName,
                        onValueChange = { newName ->
                            onMedicinesChange(medicines.toMutableList().also {
                                it[index] = it[index].copy(reminderName = newName)
                            })
                        },
                        label = { Text("Hatƒ±rlatmaya √∂zel isim", color = MaterialTheme.colorScheme.onSurfaceVariant) },
                        placeholder = { Text("√ñrn: Sabah ilacƒ±m, Tansiyon ilacƒ±") },
                        leadingIcon = { Icon(Icons.Default.Label, null, tint = DoziCoral) },
                        modifier = Modifier.fillMaxWidth(),
                        singleLine = true,
                        shape = MaterialTheme.shapes.medium,
                        colors = OutlinedTextFieldDefaults.colors(
                            focusedBorderColor = DoziCoral,
                            focusedLabelColor = DoziCoral,
                            cursorColor = DoziCoral,
                            unfocusedBorderColor = Gray200,
                            focusedContainerColor = DoziCoral.copy(alpha = 0.05f),
                            unfocusedContainerColor = Color.White
                        )
                    )

                    // üö® Kritik ƒ∞la√ß Se√ßimi
                    Spacer(modifier = Modifier.height(8.dp))

                    Card(
                        modifier = Modifier.fillMaxWidth(),
                        colors = CardDefaults.cardColors(
                            containerColor = if (medicine.isCritical)
                                Color(0xFFFFEBEE) // Light red background
                            else
                                MaterialTheme.colorScheme.surfaceVariant.copy(alpha = 0.5f)
                        ),
                        shape = MaterialTheme.shapes.medium
                    ) {
                        Column(
                            modifier = Modifier.padding(16.dp)
                        ) {
                            Row(
                                modifier = Modifier.fillMaxWidth(),
                                verticalAlignment = Alignment.CenterVertically,
                                horizontalArrangement = Arrangement.SpaceBetween
                            ) {
                                Row(
                                    verticalAlignment = Alignment.CenterVertically,
                                    modifier = Modifier.weight(1f)
                                ) {
                                    Icon(
                                        Icons.Default.Warning,
                                        contentDescription = null,
                                        tint = if (medicine.isCritical) Color(0xFFD32F2F) else MaterialTheme.colorScheme.onSurfaceVariant,
                                        modifier = Modifier.size(24.dp)
                                    )
                                    Spacer(modifier = Modifier.width(12.dp))
                                    Column {
                                        Text(
                                            "Kritik ƒ∞la√ß",
                                            style = MaterialTheme.typography.titleSmall,
                                            fontWeight = FontWeight.Bold,
                                            color = if (medicine.isCritical) Color(0xFFD32F2F) else MaterialTheme.colorScheme.onSurface
                                        )
                                        Text(
                                            "Hayati √∂nem ta≈üƒ±yan ila√ß",
                                            style = MaterialTheme.typography.bodySmall,
                                            color = MaterialTheme.colorScheme.onSurfaceVariant
                                        )
                                    }
                                }

                                Switch(
                                    checked = medicine.isCritical,
                                    onCheckedChange = { isChecked ->
                                        onMedicinesChange(medicines.toMutableList().also {
                                            it[index] = it[index].copy(isCritical = isChecked)
                                        })
                                    },
                                    colors = SwitchDefaults.colors(
                                        checkedThumbColor = Color.White,
                                        checkedTrackColor = Color(0xFFD32F2F),
                                        uncheckedThumbColor = Color.White,
                                        uncheckedTrackColor = MaterialTheme.colorScheme.outline
                                    )
                                )
                            }

                            // Bilgi mesajƒ±
                            if (medicine.isCritical) {
                                Spacer(modifier = Modifier.height(12.dp))
                                Row(
                                    modifier = Modifier
                                        .fillMaxWidth()
                                        .background(
                                            Color(0xFFD32F2F).copy(alpha = 0.1f),
                                            MaterialTheme.shapes.small
                                        )
                                        .padding(12.dp),
                                    verticalAlignment = Alignment.Top
                                ) {
                                    Icon(
                                        Icons.Default.Info,
                                        contentDescription = null,
                                        tint = Color(0xFFD32F2F),
                                        modifier = Modifier.size(16.dp)
                                    )
                                    Spacer(modifier = Modifier.width(8.dp))
                                    Text(
                                        "Bu ila√ß i√ßin t√ºm bildirimler en y√ºksek √∂ncelikte g√∂nderilecek. " +
                                        "Telefon sessiz modda olsa bile alarm sesi √ßalacak ve " +
                                        "Rahatsƒ±z Etmeyin modunu ge√ßecek. " +
                                        "Ka√ßƒ±rƒ±ldƒ±ƒüƒ±nda buddy'lerinize hemen bildirim gidecek.",
                                        style = MaterialTheme.typography.bodySmall,
                                        color = Color(0xFFD32F2F),
                                        lineHeight = MaterialTheme.typography.bodySmall.lineHeight * 1.3f
                                    )
                                }
                            }
                        }
                    }

                    Spacer(modifier = Modifier.height(8.dp))

                    // Dozaj se√ßici
                    Text(
                        "Ka√ß Adet?",
                        style = MaterialTheme.typography.labelLarge,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.onSurface
                    )

                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        DosageChip(
                            label = "1",
                            isSelected = medicine.dosageType == "1",
                            onClick = {
                                onMedicinesChange(medicines.toMutableList().also {
                                    it[index] = it[index].copy(dosageType = "1")
                                })
                            },
                            modifier = Modifier.weight(1f)
                        )
                        DosageChip(
                            label = "Yarƒ±m",
                            isSelected = medicine.dosageType == "0.5",
                            onClick = {
                                onMedicinesChange(medicines.toMutableList().also {
                                    it[index] = it[index].copy(dosageType = "0.5")
                                })
                            },
                            modifier = Modifier.weight(1f)
                        )
                        DosageChip(
                            label = "2",
                            isSelected = medicine.dosageType == "2",
                            onClick = {
                                onMedicinesChange(medicines.toMutableList().also {
                                    it[index] = it[index].copy(dosageType = "2")
                                })
                            },
                            modifier = Modifier.weight(1f)
                        )
                    }

                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        DosageChip(
                            label = "√áeyrek",
                            isSelected = medicine.dosageType == "0.25",
                            onClick = {
                                onMedicinesChange(medicines.toMutableList().also {
                                    it[index] = it[index].copy(dosageType = "0.25")
                                })
                            },
                            modifier = Modifier.weight(1f)
                        )
                        DosageChip(
                            label = "3",
                            isSelected = medicine.dosageType == "3",
                            onClick = {
                                onMedicinesChange(medicines.toMutableList().also {
                                    it[index] = it[index].copy(dosageType = "3")
                                })
                            },
                            modifier = Modifier.weight(1f)
                        )
                        DosageChip(
                            label = "Diƒüer",
                            isSelected = medicine.dosageType == "custom",
                            onClick = {
                                onMedicinesChange(medicines.toMutableList().also {
                                    it[index] = it[index].copy(dosageType = "custom")
                                })
                            },
                            modifier = Modifier.weight(1f)
                        )
                    }

                    // Custom dozaj giri≈üi
                    AnimatedVisibility(
                        visible = medicine.dosageType == "custom",
                        enter = fadeIn() + expandVertically()
                    ) {
                        OutlinedTextField(
                            value = medicine.customDosage,
                            onValueChange = { newDosage ->
                                onMedicinesChange(medicines.toMutableList().also {
                                    it[index] = it[index].copy(customDosage = newDosage)
                                })
                            },

                            label = { Text("Adet Girin", color = MaterialTheme.colorScheme.onSurfaceVariant) },

                            placeholder = { Text("√ñrn: 1.5, 4, vb.") },
                            leadingIcon = { Icon(Icons.Default.Edit, null, tint = DoziTurquoise) },
                            modifier = Modifier.fillMaxWidth(),
                            singleLine = true,
                            keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Decimal),
                            shape = MaterialTheme.shapes.medium,
                            colors = OutlinedTextFieldDefaults.colors(
                                focusedBorderColor = DoziTurquoise,
                                focusedLabelColor = DoziTurquoise,
                                cursorColor = DoziTurquoise,
                                unfocusedBorderColor = Gray200,
                                focusedContainerColor = DoziTurquoise.copy(alpha = 0.05f),
                                unfocusedContainerColor = Color.White
                            )
                        )
                    }

                    // Birim se√ßici
                    Text(
                        "Birim",
                        style = MaterialTheme.typography.labelLarge,
                        fontWeight = FontWeight.Bold,

                        color = MaterialTheme.colorScheme.onSurface,

                        modifier = Modifier.padding(top = 8.dp)
                    )

                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        UnitChip(
                            label = "Hap",
                            isSelected = medicine.unit == "hap",
                            onClick = {
                                onMedicinesChange(medicines.toMutableList().also {
                                    it[index] = it[index].copy(unit = "hap")
                                })
                            },
                            modifier = Modifier.weight(1f)
                        )
                        UnitChip(
                            label = "Doz",
                            isSelected = medicine.unit == "doz",
                            onClick = {
                                onMedicinesChange(medicines.toMutableList().also {
                                    it[index] = it[index].copy(unit = "doz")
                                })
                            },
                            modifier = Modifier.weight(1f)
                        )
                        UnitChip(
                            label = "Adet",
                            isSelected = medicine.unit == "adet",
                            onClick = {
                                onMedicinesChange(medicines.toMutableList().also {
                                    it[index] = it[index].copy(unit = "adet")
                                })
                            },
                            modifier = Modifier.weight(1f)
                        )
                    }

                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        UnitChip(
                            label = "mg",
                            isSelected = medicine.unit == "mg",
                            onClick = {
                                onMedicinesChange(medicines.toMutableList().also {
                                    it[index] = it[index].copy(unit = "mg")
                                })
                            },
                            modifier = Modifier.weight(1f)
                        )
                        UnitChip(
                            label = "ml",
                            isSelected = medicine.unit == "ml",
                            onClick = {
                                onMedicinesChange(medicines.toMutableList().also {
                                    it[index] = it[index].copy(unit = "ml")
                                })
                            },
                            modifier = Modifier.weight(1f)
                        )
                        UnitChip(
                            label = "Damla",
                            isSelected = medicine.unit == "damla",
                            onClick = {
                                onMedicinesChange(medicines.toMutableList().also {
                                    it[index] = it[index].copy(unit = "damla")
                                })
                            },
                            modifier = Modifier.weight(1f)
                        )
                    }

                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        UnitChip(
                            label = "Ka≈üƒ±k",
                            isSelected = medicine.unit == "ka≈üƒ±k",
                            onClick = {
                                onMedicinesChange(medicines.toMutableList().also {
                                    it[index] = it[index].copy(unit = "ka≈üƒ±k")
                                })
                            },
                            modifier = Modifier.weight(1f)
                        )
                        Spacer(modifier = Modifier.weight(2f))
                    }
                }
            }
        }

        // + ƒ∞la√ß Ekle butonu
        OutlinedButton(
            onClick = {
                val newId = (medicines.maxOfOrNull { it.id } ?: 0) + 1
                onMedicinesChange(medicines + MedicineEntry(id = newId))
            },
            modifier = Modifier.fillMaxWidth().height(56.dp),
            border = BorderStroke(2.dp, DoziTurquoise),
            colors = ButtonDefaults.outlinedButtonColors(contentColor = DoziTurquoise),
            shape = MaterialTheme.shapes.medium
        ) {
            Icon(Icons.Default.Add, contentDescription = null)
            Spacer(Modifier.width(8.dp))
            Text("ƒ∞la√ß Ekle", fontWeight = FontWeight.Bold)
        }

        // Hata mesajƒ±
        AnimatedVisibility(
            visible = showError && medicines.any { it.name.isBlank() },
            enter = fadeIn() + expandVertically()
        ) {
            Card(
                colors = CardDefaults.cardColors(
                    containerColor = ErrorRed.copy(alpha = 0.1f)
                ),
                shape = MaterialTheme.shapes.small
            ) {
                Row(
                    modifier = Modifier.padding(12.dp),
                    horizontalArrangement = Arrangement.spacedBy(8.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(
                        Icons.Default.Warning,
                        contentDescription = null,
                        tint = ErrorRed,
                        modifier = Modifier.size(20.dp)
                    )
                    Text(
                        "L√ºtfen t√ºm ila√ßlarƒ± se√ßin",
                        color = ErrorRed,
                        style = MaterialTheme.typography.bodySmall
                    )
                }
            }
        }
    }

    if (showPickerForIndex >= 0) {
        MedicineBottomSheet(
            items = storedMedicines,
            onPick = { selectedMedicine ->
                onMedicinesChange(medicines.toMutableList().also {
                    it[showPickerForIndex] = it[showPickerForIndex].copy(name = selectedMedicine)
                })
                showPickerForIndex = -1
            },
            onDismiss = { showPickerForIndex = -1 }
        )
    }
}

@Composable
private fun DosageChip(
    label: String,
    isSelected: Boolean,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        onClick = onClick,
        modifier = modifier.height(56.dp),
        colors = CardDefaults.cardColors(
            containerColor = if (isSelected) DoziTurquoise else Color.White
        ),
        shape = MaterialTheme.shapes.medium,
        border = BorderStroke(
            width = 2.dp,
            color = if (isSelected) DoziTurquoise else Gray200
        )
    ) {
        Box(
            modifier = Modifier.fillMaxSize(),
            contentAlignment = Alignment.Center
        ) {
            Text(
                text = label,
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.Bold,
                color = if (isSelected) Color.White else MaterialTheme.colorScheme.onSurface
            )
        }
    }
}

@Composable
private fun UnitChip(
    label: String,
    isSelected: Boolean,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    Card(
        onClick = onClick,
        modifier = modifier.height(48.dp),
        colors = CardDefaults.cardColors(
            containerColor = if (isSelected) DoziCoral else Color.White
        ),
        shape = MaterialTheme.shapes.medium,
        border = BorderStroke(
            width = 2.dp,
            color = if (isSelected) DoziCoral else Gray200
        )
    ) {
        Box(
            modifier = Modifier.fillMaxSize(),
            contentAlignment = Alignment.Center
        ) {
            Text(
                text = label,
                style = MaterialTheme.typography.bodyLarge,
                fontWeight = FontWeight.Bold,
                color = if (isSelected) Color.White else MaterialTheme.colorScheme.onSurface
            )
        }
    }
}

@Composable
private fun MedicinePickerRow(
    selectedName: String,
    onSelect: () -> Unit,
    onAddNew: () -> Unit
) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        // ‚úÖ Box wrapper ile click event'i yakala
        Box(
            modifier = Modifier
                .weight(1f)
                .clickable(onClick = onSelect)
        ) {
            OutlinedTextField(
                value = selectedName,
                onValueChange = {},
                label = { Text("ƒ∞la√ß Se√ß") },
                placeholder = { Text("Kayƒ±tlƒ± ila√ßlardan se√ß") },
                leadingIcon = {
                    Icon(Icons.Default.LocalPharmacy, contentDescription = null, tint = DoziCoral)
                },
                trailingIcon = {
                    Icon(Icons.Default.ArrowDropDown, contentDescription = null, tint = DoziCoral)
                },
                modifier = Modifier.fillMaxWidth(),
                readOnly = true,
                enabled = false, // ‚úÖ Disabled ama g√∂rsel olarak d√ºzg√ºn
                colors = OutlinedTextFieldDefaults.colors(
                    disabledTextColor = MaterialTheme.colorScheme.onSurface, // ‚úÖ Okunabilir
                    disabledBorderColor = Gray200,
                    disabledLabelColor = MaterialTheme.colorScheme.onSurfaceVariant,
                    disabledLeadingIconColor = DoziCoral,
                    disabledTrailingIconColor = DoziCoral,
                    disabledPlaceholderColor = MaterialTheme.colorScheme.onSurfaceVariant,
                    disabledContainerColor = DoziCoral.copy(alpha = 0.05f)
                ),
                shape = MaterialTheme.shapes.medium
            )
        }

        FilledTonalIconButton(
            onClick = onAddNew,
            colors = IconButtonDefaults.filledTonalIconButtonColors(
                containerColor = DoziTurquoise.copy(alpha = 0.15f),
                contentColor = DoziTurquoise
            )
        ) {
            Icon(
                Icons.Default.Add,
                contentDescription = "Yeni ila√ß ekle"
            )
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
private fun MedicineBottomSheet(
    items: List<String>,
    onPick: (String) -> Unit,
    onDismiss: () -> Unit
) {
    val sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)

    if (items.isEmpty()) {
        LaunchedEffect(Unit) {
            onDismiss()
        }
        return
    }

    ModalBottomSheet(
        onDismissRequest = onDismiss,
        sheetState = sheetState,
        containerColor = Color.White
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 20.dp, vertical = 12.dp),
            verticalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            Text(
                text = "Kayƒ±tlƒ± ƒ∞la√ßlar",
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )

            Divider(color = Gray200, thickness = 1.dp)

            items.forEach { medicine ->
                ListItem(
                    headlineContent = {
                        Text(
                            medicine,

                            color = MaterialTheme.colorScheme.onSurface,

                            style = MaterialTheme.typography.bodyLarge
                        )
                    },
                    leadingContent = {
                        Icon(
                            Icons.Default.Medication,
                            contentDescription = null,
                            tint = DoziTurquoise
                        )
                    },
                    modifier = Modifier
                        .fillMaxWidth()
                        .clip(MaterialTheme.shapes.medium)
                        .clickable {
                            onPick(medicine)
                        }
                        .padding(vertical = 4.dp)
                )
            }
            Spacer(modifier = Modifier.height(20.dp))
        }
    }
}

// ADIM 2 - SIKLIK (√ñnceki adƒ±m 3't√º, ≈üimdi adƒ±m 2)
@Composable
private fun FrequencyStep(
    selected: String,
    xValue: Int,
    selectedDates: List<String>,
    startDate: Long,
    endDate: Long?,
    onSelect: (String) -> Unit,
    onXChange: (Int) -> Unit,
    onDatesChange: (List<String>) -> Unit,
    onStartDateChange: (Long) -> Unit,
    onEndDateChange: (Long?) -> Unit,
    context: Context
) {
    val options = listOf(
        "Her g√ºn",
        "G√ºn a≈üƒ±rƒ±",
        "Haftada bir",
        "15 g√ºnde bir",
        "Ayda bir",
        "Her X g√ºnde bir",
        "ƒ∞stediƒüim tarihlerde"
    )

    Column(
        modifier = Modifier
            .fillMaxWidth()
            .heightIn(max = 400.dp),
        verticalArrangement = Arrangement.spacedBy(12.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .verticalScroll(rememberScrollState()),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            options.forEach { option ->
                FrequencyOptionCard(
                    option = option,
                    isSelected = selected == option,
                    xValue = xValue,
                    selectedDates = selectedDates,
                    startDate = startDate,
                    endDate = endDate,
                    onSelect = { onSelect(option) },
                    onXChange = onXChange,
                    onDatesChange = onDatesChange,
                    onStartDateChange = onStartDateChange,
                    onEndDateChange = onEndDateChange,
                    context = context
                )
            }
        }
    }
}

@Composable
private fun FrequencyOptionCard(
    option: String,
    isSelected: Boolean,
    xValue: Int,
    selectedDates: List<String>,
    startDate: Long,
    endDate: Long?,
    onSelect: () -> Unit,
    onXChange: (Int) -> Unit,
    onDatesChange: (List<String>) -> Unit,
    onStartDateChange: (Long) -> Unit,
    onEndDateChange: (Long?) -> Unit,
    context: Context
) {
    Card(
        onClick = onSelect,
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = if (isSelected) DoziTurquoise.copy(alpha = 0.1f) else Color.White
        ),
        shape = MaterialTheme.shapes.medium,
        border = if (isSelected) BorderStroke(2.dp, DoziTurquoise) else BorderStroke(1.dp, Gray200)
    ) {
        Column(modifier = Modifier.padding(16.dp)) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Row(
                    horizontalArrangement = Arrangement.spacedBy(12.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    RadioButton(
                        selected = isSelected,
                        onClick = onSelect,
                        colors = RadioButtonDefaults.colors(selectedColor = DoziTurquoise)
                    )
                    Text(
                        text = option,
                        style = MaterialTheme.typography.bodyLarge,
                        fontWeight = if (isSelected) FontWeight.Bold else FontWeight.Normal,
                        color = if (isSelected) DoziTurquoise else MaterialTheme.colorScheme.onSurface
                    )
                }
                if (isSelected) {
                    Icon(Icons.Default.Check, contentDescription = null, tint = DoziTurquoise, modifier = Modifier.size(20.dp))
                }
            }

            if (option == "Her X g√ºnde bir" && isSelected) {
                Spacer(Modifier.height(12.dp))
                Divider(color = Gray200)
                Spacer(Modifier.height(12.dp))
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.Center,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    IconButton(onClick = { if (xValue > 1) onXChange(xValue - 1) }) {
                        Icon(Icons.Default.Remove, contentDescription = "Azalt", tint = DoziTurquoise)
                    }
                    Surface(
                        color = DoziTurquoise.copy(alpha = 0.15f),
                        shape = MaterialTheme.shapes.small
                    ) {
                        Text(
                            text = "$xValue g√ºn",
                            style = MaterialTheme.typography.titleLarge,
                            fontWeight = FontWeight.Bold,
                            color = DoziTurquoise,
                            modifier = Modifier.padding(horizontal = 24.dp, vertical = 12.dp)
                        )
                    }
                    IconButton(onClick = { onXChange(xValue + 1) }) {
                        Icon(Icons.Default.Add, contentDescription = "Artƒ±r", tint = DoziTurquoise)
                    }
                }
            }

            // Ba≈ülangƒ±√ß tarihi se√ßici (ƒ∞stediƒüim tarihlerde hari√ß t√ºm se√ßenekler i√ßin)
            if (isSelected && option != "ƒ∞stediƒüim tarihlerde") {
                Spacer(Modifier.height(12.dp))
                Divider(color = Gray200)
                Spacer(Modifier.height(12.dp))

                Text(
                    text = "üìÖ Ba≈ülangƒ±√ß Tarihi",
                    style = MaterialTheme.typography.labelLarge,
                    fontWeight = FontWeight.Bold,
                    color = DoziTurquoise
                )
                Spacer(Modifier.height(8.dp))

                OutlinedButton(
                    onClick = {
                        showStartDatePicker(context, startDate) { newStartDate ->
                            onStartDateChange(newStartDate)
                        }
                    },
                    modifier = Modifier.fillMaxWidth(),
                    border = BorderStroke(2.dp, DoziTurquoise),
                    colors = ButtonDefaults.outlinedButtonColors(contentColor = DoziTurquoise)
                ) {
                    Icon(Icons.Default.CalendarToday, contentDescription = null, tint = DoziTurquoise)
                    Spacer(Modifier.width(8.dp))
                    val formatter = SimpleDateFormat("dd MMMM yyyy", Locale("tr", "TR"))
                    Text(
                        formatter.format(Date(startDate)),
                        fontWeight = FontWeight.Bold,
                        color = DoziTurquoise
                    )
                }

                // Biti≈ü tarihi se√ßici (opsiyonel)
                Spacer(Modifier.height(12.dp))

                Text(
                    text = "üìÖ Biti≈ü Tarihi (ƒ∞steƒüe Baƒülƒ±)",
                    style = MaterialTheme.typography.labelLarge,
                    fontWeight = FontWeight.Bold,
                    color = DoziCoral
                )
                Spacer(Modifier.height(8.dp))

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    OutlinedButton(
                        onClick = {
                            showEndDatePicker(context, startDate, endDate) { newEndDate ->
                                onEndDateChange(newEndDate)
                            }
                        },
                        modifier = Modifier.weight(1f),
                        border = BorderStroke(2.dp, DoziCoral),
                        colors = ButtonDefaults.outlinedButtonColors(contentColor = DoziCoral)
                    ) {
                        Icon(Icons.Default.EventAvailable, contentDescription = null, tint = DoziCoral)
                        Spacer(Modifier.width(8.dp))
                        val formatter = SimpleDateFormat("dd MMM yyyy", Locale("tr", "TR"))
                        Text(
                            if (endDate != null) formatter.format(Date(endDate)) else "Tarih Se√ß",
                            fontWeight = FontWeight.Bold,
                            color = DoziCoral
                        )
                    }

                    // Temizle butonu
                    if (endDate != null) {
                        IconButton(
                            onClick = { onEndDateChange(null) },
                            colors = IconButtonDefaults.iconButtonColors(
                                containerColor = ErrorRed.copy(alpha = 0.1f),
                                contentColor = ErrorRed
                            )
                        ) {
                            Icon(Icons.Default.Clear, contentDescription = "Temizle")
                        }
                    }
                }
            }

            if (option == "ƒ∞stediƒüim tarihlerde" && isSelected) {
                Spacer(Modifier.height(12.dp))
                Divider(color = Gray200)
                Spacer(Modifier.height(12.dp))

                OutlinedButton(
                    onClick = {
                        showDatePicker(context) { dateString ->
                            if (!selectedDates.contains(dateString)) {
                                onDatesChange(selectedDates + dateString)
                            }
                        }
                    },
                    modifier = Modifier.fillMaxWidth(),
                    border = BorderStroke(2.dp, DoziTurquoise),
                    colors = ButtonDefaults.outlinedButtonColors(contentColor = DoziTurquoise)
                ) {
                    Icon(Icons.Default.CalendarMonth, contentDescription = null)
                    Spacer(Modifier.width(8.dp))
                    Text("Tarih Ekle", fontWeight = FontWeight.Medium)
                }

                if (selectedDates.isNotEmpty()) {
                    Spacer(Modifier.height(12.dp))
                    LazyRow(
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        items(selectedDates) { date ->
                            DateChip(
                                date = date,
                                onRemove = {
                                    onDatesChange(selectedDates - date)
                                }
                            )
                        }
                    }
                }
            }
        }
    }
}

@Composable
private fun DateChip(date: String, onRemove: () -> Unit) {
    Surface(
        color = DoziTurquoise.copy(alpha = 0.15f),
        shape = MaterialTheme.shapes.small
    ) {
        Row(
            modifier = Modifier.padding(horizontal = 12.dp, vertical = 8.dp),
            horizontalArrangement = Arrangement.spacedBy(8.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = date,
                style = MaterialTheme.typography.labelMedium,
                color = DoziTurquoise,
                fontWeight = FontWeight.Medium
            )
            Icon(
                Icons.Default.Close,
                contentDescription = "Kaldƒ±r",
                tint = DoziTurquoise,
                modifier = Modifier
                    .size(16.dp)
                    .clickable(onClick = onRemove)
            )
        }
    }
}

private fun showDatePicker(context: Context, onDateSelected: (String) -> Unit) {
    val calendar = Calendar.getInstance()
    DatePickerDialog(
        context,
        { _, year, month, day ->
            val selectedDate = Calendar.getInstance().apply {
                set(year, month, day)
            }
            val formatter = SimpleDateFormat("dd/MM/yyyy", Locale.getDefault())
            onDateSelected(formatter.format(selectedDate.time))
        },
        calendar.get(Calendar.YEAR),
        calendar.get(Calendar.MONTH),
        calendar.get(Calendar.DAY_OF_MONTH)
    ).show()
}

private fun showStartDatePicker(context: Context, currentStartDate: Long, onDateSelected: (Long) -> Unit) {
    val calendar = Calendar.getInstance().apply {
        timeInMillis = currentStartDate
    }
    val today = Calendar.getInstance()

    val picker = DatePickerDialog(
        context,
        { _, year, month, day ->
            val selectedDate = Calendar.getInstance().apply {
                set(year, month, day, 0, 0, 0)
                set(Calendar.MILLISECOND, 0)
            }
            onDateSelected(selectedDate.timeInMillis)
        },
        calendar.get(Calendar.YEAR),
        calendar.get(Calendar.MONTH),
        calendar.get(Calendar.DAY_OF_MONTH)
    )

    // Bug√ºnden √∂nceki tarihleri se√ßilemez yap
    picker.datePicker.minDate = today.timeInMillis
    picker.show()
}

private fun showEndDatePicker(context: Context, startDate: Long, currentEndDate: Long?, onDateSelected: (Long) -> Unit) {
    val calendar = Calendar.getInstance().apply {
        timeInMillis = currentEndDate ?: startDate
    }

    val picker = DatePickerDialog(
        context,
        { _, year, month, day ->
            val selectedDate = Calendar.getInstance().apply {
                set(year, month, day, 23, 59, 59)
                set(Calendar.MILLISECOND, 999)
            }
            onDateSelected(selectedDate.timeInMillis)
        },
        calendar.get(Calendar.YEAR),
        calendar.get(Calendar.MONTH),
        calendar.get(Calendar.DAY_OF_MONTH)
    )

    // Ba≈ülangƒ±√ß tarihinden √∂nceki tarihleri se√ßilemez yap
    picker.datePicker.minDate = startDate
    picker.show()
}

// ADIM 3 - SAAT (√ñnceki adƒ±m 2'ydi, ≈üimdi adƒ±m 3) - √áOK SAAT DESTEƒûƒ∞
@Composable
private fun TimeStep(
    selectedTimes: List<TimeEntry>,
    onTimesChange: (List<TimeEntry>) -> Unit,
    context: Context
) {
    Column(
        modifier = Modifier.fillMaxWidth(),
        verticalArrangement = Arrangement.spacedBy(16.dp)
    ) {
        // Preset saatler
        Text(
            text = "‚ö° Hƒ±zlƒ± Se√ßim",
            style = MaterialTheme.typography.titleMedium,
            fontWeight = FontWeight.Bold,
            color = DoziTurquoise
        )

        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            PresetTimeChip(
                label = "Sabah",
                time = "08:00",
                icon = "üåÖ",
                modifier = Modifier.weight(1f)
            ) {
                if (!selectedTimes.any { it.time == "08:00" }) {
                    onTimesChange(selectedTimes + TimeEntry("08:00"))
                }
            }

            PresetTimeChip(
                label = "√ñƒüle",
                time = "12:00",
                icon = "‚òÄÔ∏è",
                modifier = Modifier.weight(1f)
            ) {
                if (!selectedTimes.any { it.time == "12:00" }) {
                    onTimesChange(selectedTimes + TimeEntry("12:00"))
                }
            }

            PresetTimeChip(
                label = "Ak≈üam",
                time = "20:00",
                icon = "üåô",
                modifier = Modifier.weight(1f)
            ) {
                if (!selectedTimes.any { it.time == "20:00" }) {
                    onTimesChange(selectedTimes + TimeEntry("20:00"))
                }
            }
        }

        Spacer(Modifier.height(8.dp))

        // Se√ßili saatler listesi
        Text(
            text = "‚è∞ Se√ßili Saatler (${selectedTimes.size})",
            style = MaterialTheme.typography.titleMedium,
            fontWeight = FontWeight.Bold,
            color = DoziTurquoise
        )

        selectedTimes.forEachIndexed { index, timeEntry ->
            TimeEntryCard(
                timeEntry = timeEntry,
                onRemove = {
                    if (selectedTimes.size > 1) {
                        onTimesChange(selectedTimes.filterIndexed { i, _ -> i != index })
                    }
                },
                onEdit = { newTime ->
                    val updatedList = selectedTimes.toMutableList()
                    updatedList[index] = timeEntry.copy(time = newTime)
                    onTimesChange(updatedList)
                },
                onNoteChange = { newNote ->
                    val updatedList = selectedTimes.toMutableList()
                    updatedList[index] = timeEntry.copy(note = newNote)
                    onTimesChange(updatedList)
                },
                context = context,
                canRemove = selectedTimes.size > 1
            )
        }

        // + Saat Ekle butonu
        OutlinedButton(
            onClick = {
                // Yeni saat ekle dialog
                TimePickerDialog(context, { _, h, m ->
                    val newTime = "%02d:%02d".format(h, m)
                    if (!selectedTimes.any { it.time == newTime }) {
                        onTimesChange(selectedTimes + TimeEntry(newTime))
                    }
                }, 8, 0, true).show()
            },
            modifier = Modifier.fillMaxWidth().height(56.dp),
            border = BorderStroke(2.dp, DoziTurquoise),
            colors = ButtonDefaults.outlinedButtonColors(contentColor = DoziTurquoise),
            shape = MaterialTheme.shapes.medium
        ) {
            Icon(Icons.Default.Add, contentDescription = null)
            Spacer(Modifier.width(8.dp))
            Text("Saat Ekle", fontWeight = FontWeight.Bold)
        }
    }
}

@Composable
private fun PresetTimeChip(
    label: String,
    time: String,
    icon: String,
    modifier: Modifier = Modifier,
    onClick: () -> Unit
) {
    OutlinedButton(
        onClick = onClick,
        modifier = modifier.height(72.dp),
        border = BorderStroke(2.dp, DoziTurquoise),
        colors = ButtonDefaults.outlinedButtonColors(contentColor = DoziTurquoise),
        shape = MaterialTheme.shapes.medium
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(4.dp)
        ) {
            Text(
                text = icon,
                style = MaterialTheme.typography.titleLarge
            )
            Text(
                text = label,
                style = MaterialTheme.typography.labelMedium,
                fontWeight = FontWeight.Bold
            )
            Text(
                text = time,
                style = MaterialTheme.typography.labelSmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
}

@Composable
private fun TimeEntryCard(
    timeEntry: TimeEntry,
    onRemove: () -> Unit,
    onEdit: (String) -> Unit,
    onNoteChange: (String) -> Unit,
    context: Context,
    canRemove: Boolean
) {
    var showNoteInput by remember { mutableStateOf(false) }
    var noteText by remember { mutableStateOf(timeEntry.note) }

    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        shape = MaterialTheme.shapes.medium,
        border = BorderStroke(2.dp, DoziTurquoise.copy(alpha = 0.3f))
    ) {
        Column(
            modifier = Modifier.padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                // Saat g√∂sterimi
                Surface(
                    color = DoziTurquoise.copy(alpha = 0.1f),
                    shape = MaterialTheme.shapes.small,
                    modifier = Modifier.clickable {
                        val (hour, minute) = timeEntry.time.split(":").map { it.toInt() }
                        TimePickerDialog(context, { _, h, m ->
                            onEdit("%02d:%02d".format(h, m))
                        }, hour, minute, true).show()
                    }
                ) {
                    Row(
                        modifier = Modifier.padding(horizontal = 16.dp, vertical = 12.dp),
                        horizontalArrangement = Arrangement.spacedBy(8.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Icon(
                            Icons.Default.Schedule,
                            contentDescription = null,
                            tint = DoziTurquoise,
                            modifier = Modifier.size(24.dp)
                        )
                        Text(
                            text = timeEntry.time,
                            style = MaterialTheme.typography.headlineSmall,
                            fontWeight = FontWeight.Bold,
                            color = DoziTurquoise
                        )
                    }
                }

                Row(
                    horizontalArrangement = Arrangement.spacedBy(4.dp)
                ) {
                    // Not ekle/d√ºzenle butonu
                    IconButton(
                        onClick = { showNoteInput = !showNoteInput }
                    ) {
                        Icon(
                            if (timeEntry.note.isNotEmpty()) Icons.Default.Edit else Icons.Default.Note,
                            contentDescription = "Not",
                            tint = if (timeEntry.note.isNotEmpty()) DoziCoral else MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }

                    // Kaldƒ±r butonu
                    if (canRemove) {
                        IconButton(onClick = onRemove) {
                            Icon(
                                Icons.Default.Close,
                                contentDescription = "Kaldƒ±r",
                                tint = ErrorRed
                            )
                        }
                    }
                }
            }

            // Not g√∂sterimi
            if (timeEntry.note.isNotEmpty() && !showNoteInput) {
                Surface(
                    color = DoziCoral.copy(alpha = 0.1f),
                    shape = MaterialTheme.shapes.small
                ) {
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(12.dp),
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Icon(
                            Icons.Default.Info,
                            contentDescription = null,
                            tint = DoziCoral,
                            modifier = Modifier.size(16.dp)
                        )
                        Text(
                            text = timeEntry.note,
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurface
                        )
                    }
                }
            }

            // Not input
            AnimatedVisibility(
                visible = showNoteInput,
                enter = fadeIn() + expandVertically(),
                exit = fadeOut() + shrinkVertically()
            ) {
                Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                    // Hƒ±zlƒ± se√ßenekler
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        listOf("Tok karnƒ±na", "A√ß karnƒ±na", "Yemekle birlikte", "Yemekten √∂nce", "Yemekten sonra").forEach { note ->
                            AssistChip(
                                onClick = {
                                    noteText = note
                                    onNoteChange(note)
                                    showNoteInput = false
                                },
                                label = { Text(note, style = MaterialTheme.typography.labelSmall) },
                                colors = AssistChipDefaults.assistChipColors(
                                    containerColor = DoziCoral.copy(alpha = 0.1f),
                                    labelColor = DoziCoral
                                )
                            )
                        }
                    }

                    OutlinedTextField(
                        value = noteText,
                        onValueChange = { noteText = it },
                        label = { Text("√ñzel Not") },
                        placeholder = { Text("√ñrn: Tok karnƒ±na, A√ß karnƒ±na, vb.") },
                        modifier = Modifier.fillMaxWidth(),
                        singleLine = true,
                        shape = MaterialTheme.shapes.medium,
                        colors = OutlinedTextFieldDefaults.colors(
                            focusedBorderColor = DoziCoral,
                            focusedLabelColor = DoziCoral,
                            cursorColor = DoziCoral
                        ),
                        trailingIcon = {
                            Row {
                                if (noteText.isNotEmpty()) {
                                    IconButton(onClick = {
                                        noteText = ""
                                        onNoteChange("")
                                    }) {
                                        Icon(Icons.Default.Clear, "Temizle", tint = MaterialTheme.colorScheme.onSurfaceVariant)
                                    }
                                }
                                IconButton(onClick = {
                                    onNoteChange(noteText)
                                    showNoteInput = false
                                }) {
                                    Icon(Icons.Default.Check, "Kaydet", tint = DoziCoral)
                                }
                            }
                        }
                    )
                }
            }
        }
    }
}
// ADIM 4 - √ñZET
@Composable
private fun SummaryStep(
    medicines: List<MedicineEntry>,
    selectedTimes: List<TimeEntry>,
    frequency: String,
    xValue: Int,
    selectedDates: List<String>
) {
    Column(
        modifier = Modifier.fillMaxWidth(),
        verticalArrangement = Arrangement.spacedBy(16.dp)
    ) {
        Card(
            colors = CardDefaults.cardColors(containerColor = Color.White),
            shape = MaterialTheme.shapes.large,
            elevation = CardDefaults.cardElevation(4.dp)
        ) {
            Column(
                modifier = Modifier.padding(20.dp),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                Text(
                    text = "üìã √ñzet",
                    style = MaterialTheme.typography.titleLarge,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
                Divider(color = Gray200)

                // ƒ∞la√ßlar
                Text(
                    text = "üíä ƒ∞la√ßlar (${medicines.size})",
                    style = MaterialTheme.typography.titleMedium,
                    fontWeight = FontWeight.Bold,
                    color = DoziTurquoise
                )

                medicines.forEachIndexed { index, medicine ->
                    val dosageAmount = when (medicine.dosageType) {
                        "0.5" -> "Yarƒ±m"
                        "0.25" -> "√áeyrek"
                        "1.5" -> "1.5"
                        "custom" -> medicine.customDosage
                        else -> medicine.dosageType
                    }

                    Card(
                        modifier = Modifier.fillMaxWidth(),
                        colors = CardDefaults.cardColors(
                            containerColor = DoziTurquoise.copy(alpha = 0.05f)
                        ),
                        border = BorderStroke(1.dp, DoziTurquoise.copy(alpha = 0.3f)),
                        shape = MaterialTheme.shapes.small,
                        elevation = CardDefaults.cardElevation(0.dp)
                    ) {
                        Column(
                            modifier = Modifier
                                .fillMaxWidth()
                                .padding(12.dp),
                            verticalArrangement = Arrangement.spacedBy(8.dp)
                        ) {
                            // ƒ∞la√ß ismi - uzun isimleri ellipsize ile kes
                            Text(
                                text = "${index + 1}. ${medicine.name}",
                                style = MaterialTheme.typography.bodyLarge,
                                fontWeight = FontWeight.Bold,
                                color = MaterialTheme.colorScheme.onSurface,
                                maxLines = 2,
                                overflow = TextOverflow.Ellipsis
                            )

                            // Dozaj bilgisi - yatay d√ºzen
                            Row(
                                verticalAlignment = Alignment.CenterVertically,
                                horizontalArrangement = Arrangement.spacedBy(8.dp)
                            ) {
                                Icon(
                                    Icons.Default.LocalHospital,
                                    contentDescription = null,
                                    tint = DoziTurquoise,
                                    modifier = Modifier.size(16.dp)
                                )
                                Surface(
                                    color = DoziTurquoise.copy(alpha = 0.15f),
                                    shape = MaterialTheme.shapes.extraSmall
                                ) {
                                    Text(
                                        text = "$dosageAmount ${medicine.unit}",
                                        style = MaterialTheme.typography.bodyMedium,
                                        color = DoziTurquoise,
                                        fontWeight = FontWeight.Bold,
                                        modifier = Modifier.padding(horizontal = 12.dp, vertical = 4.dp)
                                    )
                                }
                            }
                        }
                    }
                }

                Divider(color = Gray200)

                SummaryRow(
                    Icons.Default.CalendarMonth,
                    "Sƒ±klƒ±k",
                    when {
                        frequency == "Her X g√ºnde bir" -> "Her $xValue g√ºnde bir"
                        frequency == "ƒ∞stediƒüim tarihlerde" -> "${selectedDates.size} tarih se√ßildi"
                        else -> frequency
                    },
                    DoziTurquoise
                )
                // Saatler
                Text(
                    text = "‚è∞ Saatler (${selectedTimes.size})",
                    style = MaterialTheme.typography.titleMedium,
                    fontWeight = FontWeight.Bold,
                    color = WarningOrange,
                    modifier = Modifier.padding(top = 8.dp)
                )

                selectedTimes.forEach { timeEntry ->
                    Surface(
                        color = WarningOrange.copy(alpha = 0.1f),
                        shape = MaterialTheme.shapes.small
                    ) {
                        Column(
                            modifier = Modifier
                                .fillMaxWidth()
                                .padding(12.dp)
                        ) {
                            Row(
                                modifier = Modifier.fillMaxWidth(),
                                horizontalArrangement = Arrangement.SpaceBetween,
                                verticalAlignment = Alignment.CenterVertically
                            ) {
                                Row(
                                    horizontalArrangement = Arrangement.spacedBy(8.dp),
                                    verticalAlignment = Alignment.CenterVertically
                                ) {
                                    Icon(
                                        Icons.Default.Schedule,
                                        contentDescription = null,
                                        tint = WarningOrange,
                                        modifier = Modifier.size(20.dp)
                                    )
                                    Text(
                                        text = timeEntry.time,
                                        style = MaterialTheme.typography.titleMedium,
                                        fontWeight = FontWeight.Bold,
                                        color = WarningOrange
                                    )
                                }
                            }

                            if (timeEntry.note.isNotEmpty()) {
                                Spacer(Modifier.height(4.dp))
                                Text(
                                    text = timeEntry.note,
                                    style = MaterialTheme.typography.bodySmall,
                                    color = MaterialTheme.colorScheme.onSurfaceVariant
                                )
                            }
                        }
                    }
                }
            }
        }

        Card(
            colors = CardDefaults.cardColors(containerColor = DoziBlue.copy(alpha = 0.1f)),
            shape = MaterialTheme.shapes.medium
        ) {
            Row(
                modifier = Modifier.padding(16.dp),
                horizontalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                Icon(Icons.Default.Info, contentDescription = null, tint = DoziBlue)
                Text(
                    text = "Her ≈üey hazƒ±r! ${medicines.size} ila√ß aynƒ± saatte kaydedilecek.",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }
    }
}

@Composable
private fun SummaryRow(
    icon: ImageVector,
    label: String,
    value: String,
    color: Color,
    onClick: (() -> Unit)? = null
) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .then(if (onClick != null) Modifier.clickable(onClick = onClick) else Modifier),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Row(
            horizontalArrangement = Arrangement.spacedBy(12.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Icon(icon, contentDescription = null, tint = color, modifier = Modifier.size(20.dp))
            Text(
                label,
                style = MaterialTheme.typography.bodyMedium,

                color = MaterialTheme.colorScheme.onSurfaceVariant,

                fontWeight = FontWeight.Medium
            )
        }
        Text(
            value,
            style = MaterialTheme.typography.bodyLarge,
            fontWeight = FontWeight.Bold,
            color = color
        )
    }
}

// NAVƒ∞GASYON BUTONLARI
@Composable
private fun NavigationButtons(
    step: Int,
    medicineName: String,
    onBack: () -> Unit,
    onNext: () -> Unit
) {
    Surface(
        color = Color.White,
        shadowElevation = 8.dp
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 20.dp, vertical = 16.dp),
            horizontalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            if (step > 1) {
                OutlinedButton(
                    onClick = onBack,
                    modifier = Modifier.weight(1f).height(56.dp),
                    shape = MaterialTheme.shapes.medium,
                    border = BorderStroke(2.dp, DoziCoral),
                    colors = ButtonDefaults.outlinedButtonColors(contentColor = DoziCoral)
                ) {
                    Icon(Icons.Default.ArrowBack, contentDescription = null)
                    Spacer(Modifier.width(8.dp))
                    Text("Geri", fontWeight = FontWeight.Bold)
                }
            }
            Button(
                onClick = onNext,
                modifier = Modifier.weight(1f).height(56.dp),
                shape = MaterialTheme.shapes.medium,
                colors = ButtonDefaults.buttonColors(containerColor = DoziCoral)
            ) {
                Icon(
                    imageVector = if (step < 4) Icons.Default.ArrowForward else Icons.Default.Check,
                    contentDescription = null
                )
                Spacer(Modifier.width(8.dp))
                Text(
                    text = if (step < 4) "Sonraki" else "Kaydet",
                    fontWeight = FontWeight.Bold
                )
            }
        }
    }
}

// BA≈ûARI Dƒ∞YALOƒûU
@Composable
private fun ReminderSuccessDialog(
    onAddAnother: () -> Unit,
    onFinish: () -> Unit,
    isOnboarding: Boolean = false
) {
    Dialog(onDismissRequest = {}) {
        Surface(
            shape = MaterialTheme.shapes.extraLarge,
            tonalElevation = 8.dp,
            color = Color.White
        ) {
            Column(
                modifier = Modifier.padding(28.dp).fillMaxWidth(),
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(20.dp)
            ) {
                Surface(
                    modifier = Modifier.size(100.dp),
                    shape = CircleShape,
                    color = SuccessGreen.copy(alpha = 0.15f)
                ) {
                    Box(contentAlignment = Alignment.Center) {
                        Icon(
                            Icons.Default.CheckCircle,
                            contentDescription = null,
                            tint = SuccessGreen,
                            modifier = Modifier.size(60.dp)
                        )
                    }
                }
                Text(
                    text = "Tamamlandƒ±!",
                    style = MaterialTheme.typography.headlineMedium,
                    fontWeight = FontWeight.Bold,
                    color = SuccessGreen
                )
                Text(
                    text = "ƒ∞la√ßlarƒ±nƒ±z ba≈üarƒ±yla kaydedildi!",
                    style = MaterialTheme.typography.bodyLarge,

                    color = MaterialTheme.colorScheme.onSurface,

                    textAlign = TextAlign.Center
                )

                Column(
                    modifier = Modifier.fillMaxWidth(),
                    verticalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    if (isOnboarding) {
                        // Onboarding sƒ±rasƒ±nda sadece "Devam Et" butonu g√∂ster
                        Button(
                            onClick = onFinish,
                            modifier = Modifier.fillMaxWidth().height(56.dp),
                            colors = ButtonDefaults.buttonColors(containerColor = DoziTurquoise),
                            shape = MaterialTheme.shapes.medium
                        ) {
                            Text("Devam Et", fontWeight = FontWeight.Bold)
                            Spacer(Modifier.width(8.dp))
                            Icon(Icons.Default.ArrowForward, contentDescription = null)
                        }
                    } else {
                        // Normal modda iki buton g√∂ster
                        // Ba≈üka ila√ß ekle
                        Button(
                            onClick = onAddAnother,
                            modifier = Modifier.fillMaxWidth().height(56.dp),
                            colors = ButtonDefaults.buttonColors(containerColor = DoziTurquoise),
                            shape = MaterialTheme.shapes.medium
                        ) {
                            Icon(Icons.Default.Add, contentDescription = null)
                            Spacer(Modifier.width(8.dp))
                            Text("Ba≈üka ƒ∞la√ß Ekle", fontWeight = FontWeight.Bold)
                        }

                        // Bitir
                        OutlinedButton(
                            onClick = onFinish,
                            modifier = Modifier.fillMaxWidth().height(56.dp),
                            border = BorderStroke(2.dp, Gray200),
                            shape = MaterialTheme.shapes.medium,
                            colors = ButtonDefaults.outlinedButtonColors(contentColor = MaterialTheme.colorScheme.onSurfaceVariant)
                        ) {
                            Text("Kapat", fontWeight = FontWeight.Bold)
                        }
                    }
                }
            }
        }
    }
}

// Bƒ∞LDƒ∞Rƒ∞M ƒ∞ZNƒ∞ Dƒ∞YALOƒûU
@Composable
private fun NotificationPermissionDialog(
    onRequestPermission: () -> Unit,
    onOpenSettings: () -> Unit,
    onDismiss: () -> Unit
) {
    Dialog(onDismissRequest = onDismiss) {
        Surface(
            shape = MaterialTheme.shapes.extraLarge,
            tonalElevation = 8.dp,
            color = Color.White
        ) {
            Column(
                modifier = Modifier.padding(28.dp).fillMaxWidth(),
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(20.dp)
            ) {
                // ƒ∞kon
                Surface(
                    modifier = Modifier.size(100.dp),
                    shape = CircleShape,
                    color = WarningOrange.copy(alpha = 0.15f)
                ) {
                    Box(contentAlignment = Alignment.Center) {
                        Icon(
                            Icons.Default.Notifications,
                            contentDescription = null,
                            tint = WarningOrange,
                            modifier = Modifier.size(60.dp)
                        )
                    }
                }

                // Ba≈ülƒ±k
                Text(
                    text = "Bildirim ƒ∞zni Gerekli",
                    style = MaterialTheme.typography.headlineMedium,
                    fontWeight = FontWeight.Bold,
                    color = WarningOrange
                )

                // A√ßƒ±klama
                Text(
                    text = "ƒ∞la√ß hatƒ±rlatmalarƒ±nƒ±n √ßalƒ±≈üabilmesi i√ßin bildirim iznine ihtiya√ß var.",
                    style = MaterialTheme.typography.bodyLarge,
                    color = MaterialTheme.colorScheme.onSurface,
                    textAlign = TextAlign.Center
                )

                // Butonlar
                Column(
                    modifier = Modifier.fillMaxWidth(),
                    verticalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    // ƒ∞zin ver butonu
                    Button(
                        onClick = onRequestPermission,
                        modifier = Modifier.fillMaxWidth().height(56.dp),
                        colors = ButtonDefaults.buttonColors(containerColor = DoziTurquoise),
                        shape = MaterialTheme.shapes.medium
                    ) {
                        Icon(Icons.Default.NotificationsActive, contentDescription = null)
                        Spacer(Modifier.width(8.dp))
                        Text("ƒ∞zin Ver", fontWeight = FontWeight.Bold)
                    }

                    // Ayarlara git butonu (izin zaten reddedildiyse)
                    OutlinedButton(
                        onClick = onOpenSettings,
                        modifier = Modifier.fillMaxWidth().height(56.dp),
                        border = BorderStroke(2.dp, DoziTurquoise),
                        shape = MaterialTheme.shapes.medium,
                        colors = ButtonDefaults.outlinedButtonColors(contentColor = DoziTurquoise)
                    ) {
                        Icon(Icons.Default.Settings, contentDescription = null)
                        Spacer(Modifier.width(8.dp))
                        Text("Ayarlara Git", fontWeight = FontWeight.Bold)
                    }

                    // ƒ∞ptal butonu
                    TextButton(
                        onClick = onDismiss,
                        modifier = Modifier.fillMaxWidth()
                    ) {
                        Text(
                            "≈ûimdi Deƒüil",
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
            }
        }
    }
}

// KAYDETME - Multiple Medicines to Firestore
@RequiresApi(Build.VERSION_CODES.O)
private fun saveMedicinesToFirestore(
    context: Context,
    medicines: List<MedicineEntry>,
    selectedTimes: List<TimeEntry>,
    frequency: String,
    xValue: Int,
    selectedDates: List<String>,
    startDate: Long,
    endDate: Long?,
    medicineId: String? = null,
    onSuccess: () -> Unit,
    onError: () -> Unit
) {
    // Kullanƒ±cƒ± giri≈ü yapmamƒ±≈üsa LOCAL'e kaydet (Firebase yerine)
    val isUserAuthenticated = com.google.firebase.auth.FirebaseAuth.getInstance().currentUser != null
    if (!isUserAuthenticated) {
        android.util.Log.d("AddReminder", "‚úÖ Saving to local storage (authenticated: $isUserAuthenticated)")
        saveRemindersToLocal(context, medicines, selectedTimes, frequency, xValue, selectedDates, startDate)
        onSuccess()
        return
    }

    val medicineRepository = MedicineRepository()

    // Zamanlarƒ± listele
    val times = selectedTimes.map { it.time }

    // G√ºnleri hesapla - "ƒ∞stediƒüim tarihlerde" i√ßin tarihleri kullan
    val days = if (frequency == "ƒ∞stediƒüim tarihlerde") {
        selectedDates
    } else {
        emptyList() // Diƒüer sƒ±klƒ±klar i√ßin frequency field'ƒ± kullanƒ±lacak
    }

    // frequencyValue'yu d√ºzg√ºn hesapla
    val calculatedFrequencyValue = when (frequency) {
        "Her g√ºn" -> 1
        "G√ºn a≈üƒ±rƒ±" -> 2
        "Haftada bir" -> 7
        "15 g√ºnde bir" -> 15
        "Ayda bir" -> 30
        "Her X g√ºnde bir" -> xValue
        else -> 1 // "ƒ∞stediƒüim tarihlerde" i√ßin √∂nemsiz
    }

    // Her ila√ß i√ßin Medicine nesnesi olu≈ütur veya mevcut olanƒ± g√ºncelle
    CoroutineScope(Dispatchers.IO).launch {
        var allSuccess = true

        medicines.forEach { medicineEntry ->
            val dosage = if (medicineEntry.dosageType == "custom") {
                medicineEntry.customDosage
            } else {
                medicineEntry.dosageType
            }

            // üîç Edit mode: medicineId ile direkt ilacƒ± al, yoksa isimle ara
            val existingMedicine = if (medicineId != null) {
                medicineRepository.getMedicineById(medicineId)
            } else {
                val existingMedicines = medicineRepository.getAllMedicines()
                existingMedicines.find {
                    it.name.equals(medicineEntry.name, ignoreCase = true)
                }
            }

            val savedMedicine = if (existingMedicine != null) {
                // ‚úÖ Mevcut ilacƒ± g√ºncelle
                // Edit mode: saatleri REPLACE et, aksi halde MERGE et
                val updatedTimes = if (medicineId != null) {
                    // Edit mode: Eski saatleri sil, yeni saatleri kullan
                    times
                } else {
                    // Yeni hatƒ±rlatma ekleme: Saatleri birle≈ütir
                    (existingMedicine.times + times).distinct().sorted()
                }

                try {
                    // Times'ƒ± g√ºncelle
                    medicineRepository.updateMedicineField(existingMedicine.id, "times", updatedTimes)

                    // ReminderName g√ºncelleme (eƒüer yeni bir isim verildiyse)
                    if (medicineEntry.reminderName.isNotEmpty()) {
                        medicineRepository.updateMedicineField(existingMedicine.id, "reminderName", medicineEntry.reminderName)
                    }

                    // üî• FIX: Frequency ve frequencyValue'yu da g√ºncelle
                    medicineRepository.updateMedicineField(existingMedicine.id, "frequency", frequency)
                    medicineRepository.updateMedicineField(existingMedicine.id, "frequencyValue", calculatedFrequencyValue)

                    // üî• FIX: Days listesini de g√ºncelle (ƒ∞stediƒüim tarihlerde i√ßin)
                    medicineRepository.updateMedicineField(existingMedicine.id, "days", days)

                    // üî• FIX: startDate'i g√ºncelle
                    medicineRepository.updateMedicineField(existingMedicine.id, "startDate", startDate)

                    // üî• FIX: endDate'i g√ºncelle
                    if (endDate != null) {
                        medicineRepository.updateMedicineField(existingMedicine.id, "endDate", endDate as Long)
                    } else {
                        medicineRepository.updateMedicineField(existingMedicine.id, "endDate", com.google.firebase.firestore.FieldValue.delete())
                    }


                    // üî• FIX: reminderEnabled'ƒ± true yap (hatƒ±rlatma eklendi)
                    medicineRepository.updateMedicineField(existingMedicine.id, "reminderEnabled", true)

                    // üî• Kritiklik seviyesini g√ºncelle
                    val criticalityLevel = if (medicineEntry.isCritical) "CRITICAL" else "ROUTINE"
                    medicineRepository.updateMedicineField(existingMedicine.id, "criticalityLevel", criticalityLevel)

                    // Notes'u g√ºncelle - Edit mode'da REPLACE, yoksa MERGE
                    val newNotes = buildNotesFromTimes(selectedTimes, frequency, xValue)
                    val updatedNotes = if (medicineId != null) {
                        // Edit mode: Notlarƒ± deƒüi≈ütir
                        newNotes
                    } else {
                        // Yeni hatƒ±rlatma: Notlarƒ± birle≈ütir
                        if (existingMedicine.notes.isNotEmpty() && newNotes.isNotEmpty()) {
                            "${existingMedicine.notes} | $newNotes"
                        } else if (newNotes.isNotEmpty()) {
                            newNotes
                        } else {
                            existingMedicine.notes
                        }
                    }
                    medicineRepository.updateMedicineField(existingMedicine.id, "notes", updatedNotes)

                    android.util.Log.d("AddReminderScreen", "‚úÖ Mevcut ila√ß g√ºncellendi: ${existingMedicine.name} - Sƒ±klƒ±k: ${existingMedicine.frequency} -> $frequency (${calculatedFrequencyValue}), Saatler: ${existingMedicine.times} -> $updatedTimes")

                    // G√ºncellenmi≈ü Medicine'i al
                    medicineRepository.getMedicineById(existingMedicine.id)
                } catch (e: Exception) {
                    android.util.Log.e("AddReminderScreen", "‚ùå ƒ∞la√ß g√ºncellenemedi: ${existingMedicine.name}", e)
                    null
                }
            } else {
                // üÜï Yeni ila√ß olu≈ütur
                val medicine = Medicine(
                    id = "", // Repository tarafƒ±ndan olu≈üturulacak
                    userId = "", // Repository tarafƒ±ndan olu≈üturulacak
                    name = medicineEntry.name,
                    dosage = dosage,
                    unit = medicineEntry.unit,
                    form = "tablet",
                    times = times,
                    days = days,
                    frequency = frequency,
                    frequencyValue = calculatedFrequencyValue,
                    startDate = startDate,
                    endDate = endDate,
                    stockCount = 0,
                    boxSize = 0,
                    notes = buildNotesFromTimes(selectedTimes, frequency, xValue),
                    reminderEnabled = true,
                    reminderName = medicineEntry.reminderName.ifEmpty { medicineEntry.name },
                    icon = "üíä",
                    // üî• Kritiklik seviyesi
                    criticalityLevel = if (medicineEntry.isCritical) MedicineCriticality.CRITICAL else MedicineCriticality.ROUTINE
                )

                medicineRepository.addMedicine(medicine)
            }

            if (savedMedicine == null) {
                allSuccess = false
                android.util.Log.e("AddReminderScreen", "‚ùå ${medicineEntry.name} kaydedilemedi")
            } else {
                // ‚úÖ ƒ∞la√ß ba≈üarƒ±yla kaydedildi/g√ºncellendi, ≈üimdi alarmlarƒ± planla
                android.util.Log.d("AddReminderScreen", "‚úÖ ${savedMedicine.name} kaydedildi (ID: ${savedMedicine.id})")
                com.bardino.dozi.notifications.ReminderScheduler.scheduleReminders(context, savedMedicine)
                android.util.Log.d("AddReminderScreen", "‚úÖ ${savedMedicine.name} i√ßin alarmlar planlandƒ±")
            }
        }

        CoroutineScope(Dispatchers.Main).launch {
            if (allSuccess) {
                // ‚úÖ Widget'ƒ± g√ºncelle
                CoroutineScope(Dispatchers.IO).launch {
                    try {
                        com.bardino.dozi.widget.ReminderWidgetUpdater.updateWidgets(context)
                        android.util.Log.d("AddReminderScreen", "‚úÖ Widget g√ºncellendi")
                    } catch (e: Exception) {
                        android.util.Log.e("AddReminderScreen", "Widget g√ºncelleme hatasƒ±", e)
                    }
                }
                onSuccess()
            } else {
                onError()
            }
        }
    }
}

// Helper: Saatlerden ve notlardan birle≈üik not olu≈ütur
private fun buildNotesFromTimes(selectedTimes: List<TimeEntry>, frequency: String, xValue: Int): String {
    val timeNotes = selectedTimes.filter { it.note.isNotEmpty() }
        .joinToString(" | ") { "${it.time}: ${it.note}" }

    val frequencyNote = if (frequency == "Her X g√ºnde bir") "Her $xValue g√ºnde bir" else ""

    return if (timeNotes.isNotEmpty() && frequencyNote.isNotEmpty()) {
        "$frequencyNote | $timeNotes"
    } else if (timeNotes.isNotEmpty()) {
        timeNotes
    } else {
        frequencyNote
    }
}

// LOCAL KAYDETME - Onboarding sƒ±rasƒ±nda kullanƒ±lƒ±r
private fun saveRemindersToLocal(
    context: Context,
    medicines: List<MedicineEntry>,
    selectedTimes: List<TimeEntry>,
    frequency: String,
    xValue: Int,
    selectedDates: List<String>,
    startDate: Long
) {
    val prefs = context.getSharedPreferences("local_reminders", Context.MODE_PRIVATE)
    val existingReminders = prefs.getString("reminders", "[]") ?: "[]"

    // JSON array olarak parse et
    val remindersArray = try {
        org.json.JSONArray(existingReminders)
    } catch (e: Exception) {
        org.json.JSONArray()
    }

    // Yeni hatƒ±rlatmalarƒ± ekle
    medicines.forEach { medicineEntry ->
        val dosage = if (medicineEntry.dosageType == "custom") {
            medicineEntry.customDosage
        } else {
            medicineEntry.dosageType
        }

        val reminderJson = org.json.JSONObject().apply {
            put("name", medicineEntry.name)
            put("dosage", dosage)
            put("unit", medicineEntry.unit)
            put("times", org.json.JSONArray(selectedTimes.map { it.time }))
            put("timeNotes", org.json.JSONObject().apply {
                selectedTimes.forEach { timeEntry ->
                    if (timeEntry.note.isNotEmpty()) {
                        put(timeEntry.time, timeEntry.note)
                    }
                }
            })
            put("frequency", frequency)
            put("xValue", xValue)
            put("selectedDates", org.json.JSONArray(selectedDates))
            put("startDate", startDate)
            put("createdAt", System.currentTimeMillis())
        }

        remindersArray.put(reminderJson)
        android.util.Log.d("AddReminder", "üíæ Saved to local: ${medicineEntry.name} - ${selectedTimes.size} saat")
    }

    // Kaydet
    prefs.edit().putString("reminders", remindersArray.toString()).apply()
    android.util.Log.d("AddReminder", "‚úÖ Total local reminders: ${remindersArray.length()}")
}

// ============================================================================
// FILE: ReminderListScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/reminder/ReminderListScreen.kt
// [89 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.reminder

import androidx.compose.animation.*
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import com.bardino.dozi.core.data.model.Medicine
import com.bardino.dozi.core.data.repository.MedicineRepository
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.components.EmptyReminderList
import com.bardino.dozi.core.ui.theme.*
import kotlinx.coroutines.delay
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ReminderListScreen(
    onNavigateBack: () -> Unit,
    onNavigateToAddReminder: () -> Unit,
    onNavigateToEditReminder: (String) -> Unit = {}
) {
    val context = LocalContext.current
    val medicineRepository = remember { MedicineRepository() }
    var medicines by remember { mutableStateOf<List<Medicine>>(emptyList()) }
    var isVisible by remember { mutableStateOf(false) }

    // Firebase'den hatƒ±rlatmalarƒ± s√ºrekli dinle
    LaunchedEffect(Unit) {
        isVisible = true

        while (true) {
            try {
                medicines = medicineRepository.getAllMedicines()
                android.util.Log.d("ReminderListScreen", "‚úÖ Loaded ${medicines.size} reminders")
            } catch (e: Exception) {
                android.util.Log.e("ReminderListScreen", "‚ùå Error loading reminders", e)
                e.printStackTrace()
            }
            delay(3000) // Her 3 saniyede bir yenile
        }
    }

    Scaffold(
        topBar = {
            DoziTopBar(
                title = "Hatƒ±rlatmalarƒ±m",
                canNavigateBack = false,
                backgroundColor = Color.Transparent,
                actions = {
                    Surface(
                        shape = androidx.compose.foundation.shape.CircleShape,
                        color = DoziCoralDark.copy(alpha = 0.15f),
                        modifier = Modifier.padding(end = 8.dp)
                    ) {
                        IconButton(onClick = onNavigateToAddReminder) {
                            Icon(
                                Icons.Default.AddCircleOutline,
                                contentDescription = "Yeni Hatƒ±rlatma",
                                tint = DoziCoralDark
                            )
                        }
                    }
                }
            )
        },
        floatingActionButton = {
            FloatingActionButton(
                onClick = onNavigateToAddReminder,
                containerColor = DoziTurquoise,
                contentColor = Color.White,
                shape = RoundedCornerShape(16.dp),
                modifier = Modifier.shadow(12.dp, RoundedCornerShape(16.dp))
            ) {
                Icon(
                    Icons.Default.Add,
                    contentDescription = "Yeni Hatƒ±rlatma",
                    modifier = Modifier.size(28.dp)
                )
            }
        },
        containerColor = MaterialTheme.colorScheme.background
    ) { padding ->

        if (medicines.isEmpty()) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding),
                contentAlignment = Alignment.Center
            ) {
                EmptyReminderList(onAddReminder = onNavigateToAddReminder)
            }
        } else {
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding)
            ) {
                // √úst Bilgi Alanƒ±
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .background(
                            brush = Brush.horizontalGradient(
                                colors = listOf(
                                    DoziBlue,
                                    DoziTurquoise
                                )
                            ),
                            shape = RoundedCornerShape(bottomStart = 24.dp, bottomEnd = 24.dp)
                        )
                        .padding(horizontal = 20.dp, vertical = 18.dp)
                ) {
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Column(
                            verticalArrangement = Arrangement.spacedBy(4.dp)
                        ) {
                            Text(
                                text = "Hatƒ±rlatmalarƒ±nƒ±z",
                                color = Color.White,
                                style = MaterialTheme.typography.titleLarge,
                                fontWeight = FontWeight.Bold
                            )
                            Text(
                                text = "${medicines.size} aktif hatƒ±rlatma",
                                color = Color.White.copy(alpha = 0.9f),
                                style = MaterialTheme.typography.bodyMedium
                            )
                        }
                    }
                }

                Spacer(Modifier.height(16.dp))

                // Hatƒ±rlatma Listesi
                LazyColumn(
                    contentPadding = PaddingValues(horizontal = 20.dp, vertical = 12.dp),
                    verticalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    items(medicines, key = { it.id }) { medicine ->
                        AnimatedVisibility(
                            visible = isVisible,
                            enter = fadeIn() + slideInVertically(initialOffsetY = { 40 })
                        ) {
                            MedicineCard(
                                medicine = medicine,
                                onDelete = {
                                    CoroutineScope(Dispatchers.IO).launch {
                                        // üö´ √ñnce alarmlarƒ± iptal et
                                        com.bardino.dozi.notifications.ReminderScheduler.cancelReminders(
                                            context, medicine.id, medicine.times
                                        )
                                        // Sonra veritabanƒ±ndan sil
                                        medicineRepository.deleteMedicine(medicine.id)
                                        android.util.Log.d("ReminderListScreen", "üóëÔ∏è ${medicine.name} silindi ve alarmlarƒ± iptal edildi")

                                        // ‚úÖ Widget'ƒ± g√ºncelle
                                        try {
                                            com.bardino.dozi.widget.ReminderWidgetUpdater.updateWidgets(context)
                                            android.util.Log.d("ReminderListScreen", "‚úÖ Widget g√ºncellendi")
                                        } catch (e: Exception) {
                                            android.util.Log.e("ReminderListScreen", "Widget g√ºncelleme hatasƒ±", e)
                                        }
                                    }
                                },
                                onEdit = {
                                    onNavigateToEditReminder(medicine.id)
                                }
                            )
                        }
                    }

                    item { Spacer(Modifier.height(100.dp)) }
                }
            }
        }
    }
}

@Composable
private fun MedicineCard(
    medicine: Medicine,
    onDelete: () -> Unit,
    onEdit: () -> Unit = {}
) {
    var showDeleteDialog by remember { mutableStateOf(false) }

    Card(
        modifier = Modifier
            .fillMaxWidth()
            .shadow(8.dp, RoundedCornerShape(24.dp)),
        shape = RoundedCornerShape(24.dp),
        colors = CardDefaults.cardColors(
            containerColor = Color.White
        ),
        elevation = CardDefaults.cardElevation(defaultElevation = 0.dp)
    ) {
        Box {
            // Renkli gradient top border
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .height(6.dp)
                    .background(
                        brush = Brush.horizontalGradient(
                            listOf(
                                DoziPrimary,
                                DoziSecondary,
                                DoziAccent
                            )
                        ),
                        shape = RoundedCornerShape(topStart = 24.dp, topEnd = 24.dp)
                    )
            )

            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(top = 6.dp)
                    .background(
                        brush = Brush.verticalGradient(
                            colors = listOf(
                                DoziPrimaryLight.copy(alpha = 0.05f),
                                Color.White
                            )
                        )
                    )
                    .padding(20.dp),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                // Ba≈ülƒ±k satƒ±rƒ±
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.Top
                ) {
                    Column(
                        modifier = Modifier.weight(1f),
                        verticalArrangement = Arrangement.spacedBy(6.dp)
                    ) {
                        Row(
                            verticalAlignment = Alignment.CenterVertically,
                            horizontalArrangement = Arrangement.spacedBy(12.dp)
                        ) {
                            // ƒ∞kon arka planƒ± - gradient
                            androidx.compose.material3.Surface(
                                shape = RoundedCornerShape(14.dp),
                                color = Color.Transparent,
                                modifier = Modifier.size(48.dp)
                            ) {
                                Box(
                                    modifier = Modifier.background(
                                        brush = Brush.linearGradient(
                                            colors = listOf(
                                                DoziPrimary.copy(alpha = 0.2f),
                                                DoziSecondary.copy(alpha = 0.15f)
                                            )
                                        )
                                    ),
                                    contentAlignment = Alignment.Center
                                ) {
                                    Text(
                                        text = medicine.icon,
                                        style = MaterialTheme.typography.headlineMedium
                                    )
                                }
                            }

                            Column(verticalArrangement = Arrangement.spacedBy(4.dp)) {
                                // Hatƒ±rlatma ƒ∞smi (ana ba≈ülƒ±k)
                                Text(
                                    text = medicine.reminderName.ifEmpty { medicine.name },
                                    style = MaterialTheme.typography.titleLarge,
                                    fontWeight = FontWeight.Bold,
                                    color = Gray900,
                                    maxLines = 1,
                                    overflow = androidx.compose.ui.text.style.TextOverflow.Ellipsis
                                )
                                // ƒ∞la√ß ƒ∞smi (alt ba≈ülƒ±k)
                                Text(
                                    text = medicine.name,
                                    style = MaterialTheme.typography.bodyMedium,
                                    color = Gray600,
                                    fontWeight = FontWeight.Medium,
                                    maxLines = 1,
                                    overflow = androidx.compose.ui.text.style.TextOverflow.Ellipsis
                                )
                            }
                        }
                    }

                    Row(
                        horizontalArrangement = Arrangement.spacedBy(6.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        // Edit butonu
                        androidx.compose.material3.Surface(
                            shape = RoundedCornerShape(12.dp),
                            color = DoziPrimary.copy(alpha = 0.15f)
                        ) {
                            IconButton(onClick = onEdit) {
                                Icon(
                                    Icons.Default.Edit,
                                    contentDescription = "D√ºzenle",
                                    tint = DoziPrimaryDark,
                                    modifier = Modifier.size(20.dp)
                                )
                            }
                        }

                        // Delete butonu
                        androidx.compose.material3.Surface(
                            shape = RoundedCornerShape(12.dp),
                            color = ErrorRed.copy(alpha = 0.15f)
                        ) {
                            IconButton(onClick = { showDeleteDialog = true }) {
                                Icon(
                                    Icons.Default.Delete,
                                    contentDescription = "Sil",
                                    tint = ErrorRed,
                                    modifier = Modifier.size(20.dp)
                                )
                            }
                        }
                    }
                }

                // Sƒ±klƒ±k - Saat - Dosage (tek satƒ±rda)
                val frequencyText = when (medicine.frequency) {
                    "Her X g√ºnde bir" -> "Her ${medicine.frequencyValue} g√ºnde bir"
                    "ƒ∞stediƒüim tarihlerde" -> "${medicine.days.size} tarih se√ßildi"
                    else -> medicine.frequency
                }
                val timesText = if (medicine.times.isNotEmpty()) {
                    medicine.times.joinToString(", ")
                } else "Saat belirtilmemi≈ü"
                val dosageText = "${medicine.dosage} ${medicine.unit}"

                InfoTag(
                    icon = Icons.Default.Info,
                    text = "$frequencyText ‚Ä¢ $timesText ‚Ä¢ $dosageText",
                    color = DoziPrimaryDark,
                    fullWidth = true
                )

                // Ba≈ülangƒ±√ß tarihi
                val startDateText = remember(medicine.startDate) {
                    try {
                        // Eƒüer startDate 0 veya √ßok k√º√ß√ºkse (1971'den √∂ncesiyse), "Tarih belirtilmemi≈ü" g√∂ster
                        if (medicine.startDate == 0L || medicine.startDate < 31536000000L) {
                            "Tarih belirtilmemi≈ü"
                        } else {
                            val sdf = java.text.SimpleDateFormat("dd MMM yyyy", java.util.Locale("tr"))
                            sdf.format(java.util.Date(medicine.startDate))
                        }
                    } catch (e: Exception) {
                        "Tarih belirtilmemi≈ü"
                    }
                }
                InfoTag(
                    icon = Icons.Default.Schedule,
                    text = "Ba≈ülangƒ±√ß: $startDateText",
                    color = DoziSecondaryDark,
                    fullWidth = true
                )
            }
        }
    }

    // Modern Silme Onay Dialogu
    if (showDeleteDialog) {
        androidx.compose.ui.window.Dialog(
            onDismissRequest = { showDeleteDialog = false }
        ) {
            androidx.compose.material3.Surface(
                shape = RoundedCornerShape(28.dp),
                color = Color.White
            ) {
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(32.dp),
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.spacedBy(24.dp)
                ) {
                    // Icon
                    androidx.compose.material3.Surface(
                        modifier = Modifier.size(80.dp),
                        color = ErrorRed.copy(alpha = 0.15f),
                        shape = androidx.compose.foundation.shape.CircleShape
                    ) {
                        Box(contentAlignment = Alignment.Center) {
                            Icon(
                                Icons.Default.Warning,
                                contentDescription = null,
                                tint = ErrorRed,
                                modifier = Modifier.size(44.dp)
                            )
                        }
                    }

                    // Ba≈ülƒ±k ve A√ßƒ±klama
                    Column(
                        horizontalAlignment = Alignment.CenterHorizontally,
                        verticalArrangement = Arrangement.spacedBy(12.dp)
                    ) {
                        Text(
                            text = "Hatƒ±rlatmayƒ± Sil?",
                            style = MaterialTheme.typography.headlineSmall,
                            fontWeight = FontWeight.Bold,
                            color = MaterialTheme.colorScheme.onSurface
                        )

                        Text(
                            text = "${medicine.name} i√ßin ayarlanan hatƒ±rlatmayƒ± silmek istediƒüinize emin misiniz?",
                            style = MaterialTheme.typography.bodyLarge,
                            color = MaterialTheme.colorScheme.onSurfaceVariant,
                            textAlign = androidx.compose.ui.text.style.TextAlign.Center
                        )
                    }

                    // Butonlar
                    Column(
                        modifier = Modifier.fillMaxWidth(),
                        verticalArrangement = Arrangement.spacedBy(12.dp)
                    ) {
                        Button(
                            onClick = {
                                onDelete()
                                showDeleteDialog = false
                            },
                            modifier = Modifier
                                .fillMaxWidth()
                                .height(56.dp),
                            shape = RoundedCornerShape(16.dp),
                            colors = ButtonDefaults.buttonColors(
                                containerColor = ErrorRed
                            )
                        ) {
                            Icon(
                                Icons.Default.Delete,
                                contentDescription = null,
                                modifier = Modifier.size(22.dp)
                            )
                            Spacer(Modifier.width(10.dp))
                            Text(
                                "Evet, Sil",
                                style = MaterialTheme.typography.titleMedium,
                                fontWeight = FontWeight.Bold
                            )
                        }

                        OutlinedButton(
                            onClick = { showDeleteDialog = false },
                            modifier = Modifier
                                .fillMaxWidth()
                                .height(56.dp),
                            shape = RoundedCornerShape(16.dp),
                            border = BorderStroke(2.dp, Gray200)
                        ) {
                            Text(
                                "ƒ∞ptal",
                                style = MaterialTheme.typography.titleMedium,
                                fontWeight = FontWeight.Bold,
                                color = MaterialTheme.colorScheme.onSurfaceVariant
                            )
                        }
                    }
                }
            }
        }
    }
}

@Composable
private fun InfoTag(
    icon: androidx.compose.ui.graphics.vector.ImageVector,
    text: String,
    color: Color,
    fullWidth: Boolean = false
) {
    androidx.compose.material3.Surface(
        color = color.copy(alpha = 0.15f),
        shape = RoundedCornerShape(12.dp),
        modifier = if (fullWidth) Modifier.fillMaxWidth() else Modifier,
        border = BorderStroke(1.dp, color.copy(alpha = 0.3f))
    ) {
        Row(
            modifier = Modifier.padding(horizontal = 14.dp, vertical = 10.dp),
            horizontalArrangement = Arrangement.spacedBy(8.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Icon(
                icon,
                contentDescription = null,
                tint = color,
                modifier = Modifier.size(18.dp)
            )
            Text(
                text = text,
                color = color,
                style = MaterialTheme.typography.labelLarge,
                fontWeight = FontWeight.Bold
            )
        }
    }
}
// ============================================================================
// FILE: AboutScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/settings/AboutScreen.kt
// [90 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.settings

import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import com.bardino.dozi.R
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun AboutScreen(
    onNavigateBack: () -> Unit,
    onNavigateToSupport: (() -> Unit)? = null
) {
    val context = LocalContext.current
    val packageInfo = context.packageManager.getPackageInfo(context.packageName, 0)
    val versionName = packageInfo.versionName
    val versionCode = if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.P) {
        packageInfo.longVersionCode
    } else {
        @Suppress("DEPRECATION")
        packageInfo.versionCode.toLong()
    }

    var showPrivacyDialog by remember { mutableStateOf(false) }
    var showTermsDialog by remember { mutableStateOf(false) }

    Scaffold(
        topBar = {
            DoziTopBar(
                title = "Hakkƒ±nda",
                canNavigateBack = true,
                onNavigateBack = onNavigateBack,
                backgroundColor = MaterialTheme.colorScheme.surface
            )
        },
        containerColor = MaterialTheme.colorScheme.background
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .verticalScroll(rememberScrollState())
                .padding(24.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(24.dp)
        ) {
            Spacer(modifier = Modifier.height(8.dp))

            // Logo ve Ba≈ülƒ±k
            Box(
                modifier = Modifier
                    .size(100.dp)
                    .clip(CircleShape)
                    .background(DoziTurquoise.copy(alpha = 0.1f)),
                contentAlignment = Alignment.Center
            ) {
                Image(
                    painter = painterResource(R.drawable.dozi),
                    contentDescription = "Dozi",
                    modifier = Modifier.size(70.dp)
                )
            }

            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(4.dp)
            ) {
                Text(
                    text = "Dozi",
                    style = MaterialTheme.typography.headlineLarge,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
                Text(
                    text = "Saƒülƒ±klƒ± Ya≈üam Asistanƒ±n",
                    style = MaterialTheme.typography.bodyLarge,
                    color = DoziTurquoise,
                    fontWeight = FontWeight.Medium
                )
                Text(
                    text = "Versiyon $versionName",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }

            // A√ßƒ±klama
            Text(
                text = "Dozi, ila√ß takibini kolayla≈ütƒ±ran ve saƒülƒ±ƒüƒ±nƒ±zƒ± kontrol altƒ±nda tutmanƒ±za yardƒ±mcƒ± olan modern bir saƒülƒ±k asistanƒ±dƒ±r. ƒ∞la√ßlarƒ±nƒ±zƒ± zamanƒ±nda almayƒ± unutmayƒ±n, ailenizi takip edin ve saƒülƒ±klƒ± bir ya≈üam s√ºr√ºn!",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                textAlign = TextAlign.Center,
                modifier = Modifier.padding(horizontal = 8.dp)
            )

            // √ñzellikler
            Column(
                modifier = Modifier.fillMaxWidth(),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                FeatureItem(
                    icon = Icons.Default.Notifications,
                    title = "Akƒ±llƒ± Hatƒ±rlatmalar",
                    description = "ƒ∞la√ßlarƒ±nƒ±zƒ± zamanƒ±nda almanƒ±z i√ßin √∂zelle≈ütirilebilir bildirimler"
                )
                FeatureItem(
                    icon = Icons.Default.MedicalServices,
                    title = "Kolay Takip",
                    description = "ƒ∞la√ßlarƒ±nƒ±zƒ±, dozlarƒ±nƒ±zƒ± ve stok durumunuzu tek ekranda g√∂r√ºn"
                )
                FeatureItem(
                    icon = Icons.Default.CloudSync,
                    title = "Bulut Yedekleme",
                    description = "Verileriniz g√ºvenle Firebase'de saklanƒ±r ve cihazlar arasƒ± senkronize olur"
                )
                FeatureItem(
                    icon = Icons.Default.Group,
                    title = "Aile Takibi",
                    description = "Sevdiklerinizin ila√ß uyumunu uzaktan kontrol edin"
                )
            }

            Divider(color = MaterialTheme.colorScheme.outlineVariant)

            // Geli≈ütirici Bilgisi
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Text(
                    text = "Bardino Technology",
                    style = MaterialTheme.typography.titleMedium,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
                Text(
                    text = "¬© 2025 T√ºm haklarƒ± saklƒ±dƒ±r",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }

            // Politika Butonlarƒ±
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                OutlinedButton(
                    onClick = { showPrivacyDialog = true },
                    modifier = Modifier.weight(1f),
                    colors = ButtonDefaults.outlinedButtonColors(
                        contentColor = DoziTurquoise
                    )
                ) {
                    Text("Gizlilik Politikasi")
                }
                OutlinedButton(
                    onClick = { showTermsDialog = true },
                    modifier = Modifier.weight(1f),
                    colors = ButtonDefaults.outlinedButtonColors(
                        contentColor = DoziTurquoise
                    )
                ) {
                    Text("Kullanim Sartlari")
                }
            }

            // Destek Butonu
            if (onNavigateToSupport != null) {
                Button(
                    onClick = onNavigateToSupport,
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.buttonColors(
                        containerColor = DoziTurquoise
                    )
                ) {
                    Icon(
                        Icons.Default.HelpOutline,
                        contentDescription = null,
                        modifier = Modifier.size(18.dp)
                    )
                    Spacer(Modifier.width(8.dp))
                    Text("Destek ve SSS")
                }
            }

            Spacer(modifier = Modifier.height(8.dp))
        }
    }

    // Gizlilik Politikasƒ± Dialog
    if (showPrivacyDialog) {
        PrivacyPolicyDialog(onDismiss = { showPrivacyDialog = false })
    }

    // Kullanƒ±m ≈ûartlarƒ± Dialog
    if (showTermsDialog) {
        TermsOfServiceDialog(onDismiss = { showTermsDialog = false })
    }
}

@Composable
private fun FeatureItem(
    icon: androidx.compose.ui.graphics.vector.ImageVector,
    title: String,
    description: String
) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.spacedBy(16.dp),
        verticalAlignment = Alignment.Top
    ) {
        Box(
            modifier = Modifier
                .size(40.dp)
                .clip(CircleShape)
                .background(DoziTurquoise.copy(alpha = 0.15f)),
            contentAlignment = Alignment.Center
        ) {
            Icon(
                imageVector = icon,
                contentDescription = null,
                tint = DoziTurquoise,
                modifier = Modifier.size(20.dp)
            )
        }
        Column(
            modifier = Modifier.weight(1f),
            verticalArrangement = Arrangement.spacedBy(4.dp)
        ) {
            Text(
                text = title,
                style = MaterialTheme.typography.titleSmall,
                fontWeight = FontWeight.SemiBold,
                color = MaterialTheme.colorScheme.onSurface
            )
            Text(
                text = description,
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
}

@Composable
private fun PrivacyPolicyDialog(onDismiss: () -> Unit) {
    AlertDialog(
        onDismissRequest = onDismiss,
        title = {
            Text(
                "Gizlilik Politikasƒ±",
                style = MaterialTheme.typography.headlineSmall,
                fontWeight = FontWeight.Bold
            )
        },
        text = {
            Column(
                modifier = Modifier.verticalScroll(rememberScrollState()),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                PolicySection(
                    title = "1. Veri Sorumlusu",
                    content = "Dozi uygulamasƒ±, Bardino Technology tarafƒ±ndan geli≈ütirilmi≈ü ve i≈ületilmektedir. Ki≈üisel verilerinizin korunmasƒ± bizim i√ßin √∂nceliktir ve 6698 sayƒ±lƒ± Ki≈üisel Verilerin Korunmasƒ± Kanunu'na (KVKK) uygun hareket ediyoruz."
                )

                PolicySection(
                    title = "2. Toplanan Veriler",
                    content = """
                        ‚Ä¢ Kimlik Bilgileri: Ad, soyad, e-posta adresi
                        ‚Ä¢ ƒ∞leti≈üim Bilgileri: Telefon numarasƒ± (opsiyonel)
                        ‚Ä¢ Saƒülƒ±k Verileri: ƒ∞la√ß isimleri, dozaj bilgileri, kullanƒ±m saatleri, stok durumu
                        ‚Ä¢ Cihaz Bilgileri: Cihaz modeli, i≈ületim sistemi versiyonu, uygulama versiyonu
                        ‚Ä¢ Kullanƒ±m Verileri: Uygulama i√ßi aktiviteler, hata loglarƒ±
                    """.trimIndent()
                )

                PolicySection(
                    title = "3. Verilerin Kullanƒ±m Ama√ßlarƒ±",
                    content = """
                        ‚Ä¢ ƒ∞la√ß hatƒ±rlatma bildirimleri g√∂ndermek
                        ‚Ä¢ Kullanƒ±cƒ± hesabƒ±nƒ±zƒ± olu≈üturmak ve y√∂netmek
                        ‚Ä¢ ƒ∞la√ß takibi ve raporlama hizmetleri sunmak
                        ‚Ä¢ Aile √ºyeleri arasƒ±nda bilgi payla≈üƒ±mƒ±nƒ± saƒülamak (izniniz dahilinde)
                        ‚Ä¢ Uygulama performansƒ±nƒ± iyile≈ütirmek ve hatalarƒ± gidermek
                        ‚Ä¢ ƒ∞statistiksel analizler yapmak
                        ‚Ä¢ Yasal y√ºk√ºml√ºl√ºkleri yerine getirmek
                    """.trimIndent()
                )

                PolicySection(
                    title = "4. Veri G√ºvenliƒüi",
                    content = """
                        ‚Ä¢ T√ºm verileriniz Google Firebase'de saklanƒ±r
                        ‚Ä¢ SSL/TLS protokolleri ile g√ºvenli veri iletimi saƒülanƒ±r
                        ‚Ä¢ D√ºzenli g√ºvenlik testleri ve g√ºncellemeleri yapƒ±lƒ±r
                        ‚Ä¢ Yetkisiz eri≈üimlere kar≈üƒ± √ßok katmanlƒ± g√ºvenlik √∂nlemleri alƒ±nƒ±r
                    """.trimIndent()
                )

                PolicySection(
                    title = "5. Veri Payla≈üƒ±mƒ±",
                    content = "Verileriniz kesinlikle √º√ß√ºnc√º ≈üahƒ±slarla satƒ±lmaz, kiralanmaz veya payla≈üƒ±lmaz. Sadece a≈üaƒüƒ±daki durumlarda veri payla≈üƒ±mƒ± yapƒ±labilir:\n\n‚Ä¢ Yasal zorunluluklar (mahkeme kararƒ±, savcƒ±lƒ±k talebi)\n‚Ä¢ Firebase ve Google servisleri (altyapƒ± hizmeti saƒülayƒ±cƒ±sƒ± olarak)\n‚Ä¢ A√ßƒ±k izniniz dahilinde aile √ºyeleriyle"
                )

                PolicySection(
                    title = "6. Haklarƒ±nƒ±z",
                    content = """
                        KVKK kapsamƒ±nda a≈üaƒüƒ±daki haklara sahipsiniz:
                        ‚Ä¢ Verilerinizin i≈ülenip i≈ülenmediƒüini √∂ƒürenme
                        ‚Ä¢ ƒ∞≈ülenme amacƒ±nƒ± ve amacƒ±na uygun kullanƒ±lƒ±p kullanƒ±lmadƒ±ƒüƒ±nƒ± √∂ƒürenme
                        ‚Ä¢ Yurt i√ßinde veya yurt dƒ±≈üƒ±nda aktarƒ±ldƒ±ƒüƒ± 3. ki≈üileri bilme
                        ‚Ä¢ Eksik veya yanlƒ±≈ü i≈ülenmi≈üse d√ºzeltilmesini isteme
                        ‚Ä¢ Verilerin silinmesini veya yok edilmesini talep etme
                        ‚Ä¢ Otomatik sistemler ile analiz edilmesi sonucu aleyhinize bir sonu√ß doƒümasƒ± halinde itiraz etme
                    """.trimIndent()
                )

                PolicySection(
                    title = "7. √áerezler ve ƒ∞zleme",
                    content = "Uygulama performansƒ±nƒ± √∂l√ßmek i√ßin Google Analytics ve Firebase Analytics kullanƒ±lmaktadƒ±r. Bu servisler anonim kullanƒ±m verileri toplar. ƒ∞sterseniz cihaz ayarlarƒ±nƒ±zdan bu izlemeleri kapatabilirsiniz."
                )

                PolicySection(
                    title = "8. √áocuklarƒ±n Gizliliƒüi",
                    content = "Dozi, 18 ya≈üƒ±ndan k√º√ß√ºk kullanƒ±cƒ±larƒ±n verilerini bilerek toplamaz. Ebeveyn veya vasi g√∂zetiminde kullanƒ±lmasƒ± √∂nerilir."
                )

                PolicySection(
                    title = "9. Veri Saklama S√ºresi",
                    content = "Verileriniz, hizmet sunumu i√ßin gerekli olduƒüu s√ºrece veya yasal saklama y√ºk√ºml√ºl√ºkleri nedeniyle saklanƒ±r. Hesabƒ±nƒ±zƒ± sildiƒüinizde t√ºm verileriniz 30 g√ºn i√ßinde kalƒ±cƒ± olarak silinir."
                )

                PolicySection(
                    title = "10. ƒ∞leti≈üim",
                    content = """
                        Gizlilik politikasƒ± ile ilgili sorularƒ±nƒ±z i√ßin:
                        
                        E-posta: privacy@dozi.app
                        Web: www.dozi.app/gizlilik
                        Adres: Bardino Technology
                        
                        Son G√ºncelleme: Ocak 2025
                    """.trimIndent()
                )
            }
        },
        confirmButton = {
            TextButton(onClick = onDismiss) {
                Text("Kapat", color = DoziTurquoise)
            }
        }
    )
}

@Composable
private fun TermsOfServiceDialog(onDismiss: () -> Unit) {
    AlertDialog(
        onDismissRequest = onDismiss,
        title = {
            Text(
                "Kullanƒ±m ≈ûartlarƒ±",
                style = MaterialTheme.typography.headlineSmall,
                fontWeight = FontWeight.Bold
            )
        },
        text = {
            Column(
                modifier = Modifier.verticalScroll(rememberScrollState()),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                PolicySection(
                    title = "1. S√∂zle≈ümenin Konusu",
                    content = "ƒ∞≈übu kullanƒ±m ≈üartlarƒ±, Bardino Technology tarafƒ±ndan geli≈ütirilen Dozi mobil uygulamasƒ±nƒ±n kullanƒ±mƒ±na ili≈ükin h√ºk√ºm ve ko≈üullarƒ± d√ºzenler. Uygulamayƒ± kullanarak bu ≈üartlarƒ± kabul etmi≈ü sayƒ±lƒ±rsƒ±nƒ±z."
                )

                PolicySection(
                    title = "2. Tanƒ±mlar",
                    content = """
                        ‚Ä¢ Uygulama: Dozi mobil saƒülƒ±k asistan uygulamasƒ±
                        ‚Ä¢ Kullanƒ±cƒ±: Uygulamayƒ± kullanan ger√ßek ki≈üi
                        ‚Ä¢ Hizmet: Uygulama √ºzerinden sunulan t√ºm √∂zellikler ve i√ßerikler
                        ‚Ä¢ Premium: √úcretli abonelik planƒ±
                        ‚Ä¢ ƒ∞√ßerik: Uygulama i√ßinde yer alan t√ºm bilgi, veri ve g√∂rsel materyaller
                    """.trimIndent()
                )

                PolicySection(
                    title = "3. Hizmetin Kapsamƒ±",
                    content = """
                        Dozi a≈üaƒüƒ±daki hizmetleri ve daha fazlasƒ±nƒ± sunar:
                        
                        ‚Ä¢ ƒ∞la√ß takibi ve hatƒ±rlatma sistemi
                        ‚Ä¢ Doz ve kullanƒ±m zamanƒ± y√∂netimi
                        ‚Ä¢ ƒ∞la√ß stok takibi
                        ‚Ä¢ Aile √ºyeleri takip sistemi
                        ‚Ä¢ Bulut yedekleme
                    """.trimIndent()
                )

                PolicySection(
                    title = "4. Kullanƒ±cƒ± Sorumluluklarƒ±",
                    content = """
                        Kullanƒ±cƒ± olarak a≈üaƒüƒ±daki hususlarƒ± kabul edersiniz:
                        
                        ‚Ä¢ Girdiƒüiniz ila√ß bilgilerinin doƒüruluƒüundan siz sorumlusunuz
                        ‚Ä¢ Hatƒ±rlatmalarƒ± kontrol etmek sizin sorumluluƒüunuzdadƒ±r
                        ‚Ä¢ Hesap bilgilerinizi g√ºvenli tutmakla y√ºk√ºml√ºs√ºn√ºz
                        ‚Ä¢ Uygulamayƒ± yasalara uygun kullanacaƒüƒ±nƒ±zƒ± taahh√ºt edersiniz
                        ‚Ä¢ Ba≈ükalarƒ±nƒ±n hesap bilgilerini kullanmayacaƒüƒ±nƒ±zƒ± kabul edersiniz
                        ‚Ä¢ 18 ya≈üƒ±ndan k√º√ß√ºkseniz, ebeveyn veya vasi g√∂zetiminde kullanacaƒüƒ±nƒ±zƒ± taahh√ºt edersiniz
                    """.trimIndent()
                )

                PolicySection(
                    title = "5. Sorumluluk Reddi - √ñNEMLƒ∞",
                    content = """
                        Dƒ∞KKAT: Dozi bir hatƒ±rlatma ve takip uygulamasƒ±dƒ±r, tƒ±bbi bir ara√ß veya saƒülƒ±k danƒ±≈ümanlƒ±ƒüƒ± hizmeti DEƒûƒ∞LDƒ∞R.
                        
                        ‚Ä¢ Dozi tƒ±bbi tavsiye, te≈ühis veya tedavi saƒülamaz
                        ‚Ä¢ ƒ∞la√ß kullanƒ±mƒ±na ili≈ükin kararlar doktorunuzla alƒ±nmalƒ±dƒ±r
                        ‚Ä¢ Uygulama, re√ßete yazmaz veya ila√ß √∂nerisinde bulunmaz
                        ‚Ä¢ Acil durumlarda 112'yi arayƒ±n, uygulamaya g√ºvenmeyin
                        ‚Ä¢ ƒ∞la√ß etkile≈üimleri bilgilendirme ama√ßlƒ±dƒ±r, mutlaka doktorunuza danƒ±≈üƒ±n
                        ‚Ä¢ Uygulama kaynaklƒ± herhangi bir zarardan Bardino Technology sorumlu tutulamaz
                    """.trimIndent()
                )

                PolicySection(
                    title = "6. Premium Abonelik",
                    content = """
                        ‚Ä¢ Abonelik bedelleri uygulama i√ßinde belirtilmi≈ütir
                        ‚Ä¢ √ñdemeler Google Play Store √ºzerinden ger√ßekle≈üir
                        ‚Ä¢ Abonelik otomatik olarak yenilenir
                        ‚Ä¢ ƒ∞ptal i≈ülemi Google Play Store'dan yapƒ±lmalƒ±dƒ±r
                        ‚Ä¢ ƒ∞ptal sonrasƒ± mevcut d√∂nem sonuna kadar hizmet devam eder
                        ‚Ä¢ Kƒ±smi iade yapƒ±lmaz
                        ‚Ä¢ √úcretsiz deneme s√ºresi sonunda otomatik √ºcretlendirme ba≈ülar
                    """.trimIndent()
                )

                PolicySection(
                    title = "7. Fikri M√ºlkiyet Haklarƒ±",
                    content = "Dozi uygulamasƒ±, logosu, tasarƒ±mƒ± ve i√ßeriƒüi Bardino Technology'nin fikri m√ºlkiyetidir. ƒ∞zinsiz kullanƒ±m, kopyalama, deƒüi≈ütirme veya daƒüƒ±tƒ±m yasaktƒ±r."
                )

                PolicySection(
                    title = "8. Hizmet Kesintileri",
                    content = "Bardino Technology, teknik nedenler, bakƒ±m √ßalƒ±≈ümalarƒ± veya m√ºcbir sebepler nedeniyle hizmeti ge√ßici olarak durdurma hakkƒ±nƒ± saklƒ± tutar. Bu durumlarda kullanƒ±cƒ±lara bildirim yapƒ±lmaya √ßalƒ±≈üƒ±lƒ±r."
                )

                PolicySection(
                    title = "9. Hesap Silme",
                    content = """
                        ‚Ä¢ Hesabƒ±nƒ±zƒ± istediƒüiniz zaman silebilirsiniz
                        ‚Ä¢ Silme i≈ülemi ayarlar > hesap > hesabƒ± sil sekmesinden yapƒ±lƒ±r
                        ‚Ä¢ Silinen hesaplar 30 g√ºn i√ßinde kalƒ±cƒ± olarak silinir
                        ‚Ä¢ Bu s√ºre i√ßinde geri alabilirsiniz
                        ‚Ä¢ Silinen veriler geri getirilemez
                    """.trimIndent()
                )

                PolicySection(
                    title = "10. Deƒüi≈üiklikler",
                    content = "Bardino Technology, kullanƒ±m ≈üartlarƒ±nƒ± √∂nceden bildirmeksizin deƒüi≈ütirme hakkƒ±nƒ± saklƒ± tutar. √ñnemli deƒüi≈üiklikler uygulama i√ßi bildirim ile duyurulur."
                )

                PolicySection(
                    title = "11. Uygulanacak Hukuk",
                    content = "ƒ∞≈übu s√∂zle≈üme T√ºrkiye Cumhuriyeti yasalarƒ±na tabidir. Uyu≈ümazlƒ±klar ƒ∞stanbul Mahkemeleri ve ƒ∞cra Dairelerinde √ß√∂z√ºmlenir."
                )

                PolicySection(
                    title = "12. ƒ∞leti≈üim",
                    content = """
                        Kullanƒ±m ≈üartlarƒ± ile ilgili sorularƒ±nƒ±z i√ßin:
                        
                        E-posta: support@dozi.app
                        Web: www.dozi.app/sartlar
                        
                        Son G√ºncelleme: Ocak 2025
                    """.trimIndent()
                )
            }
        },
        confirmButton = {
            TextButton(onClick = onDismiss) {
                Text("Kapat", color = DoziTurquoise)
            }
        }
    )
}

@Composable
private fun PolicySection(title: String, content: String) {
    Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
        Text(
            text = title,
            style = MaterialTheme.typography.titleSmall,
            fontWeight = FontWeight.Bold,
            color = MaterialTheme.colorScheme.onSurface
        )
        Text(
            text = content,
            style = MaterialTheme.typography.bodySmall,
            color = MaterialTheme.colorScheme.onSurfaceVariant,
            lineHeight = MaterialTheme.typography.bodySmall.lineHeight
        )
    }
}
// ============================================================================
// FILE: AdvancedNotificationSettingsScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/settings/AdvancedNotificationSettingsScreen.kt
// [91 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.settings

import android.app.TimePickerDialog
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.lifecycle.viewmodel.compose.viewModel
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun AdvancedNotificationSettingsScreen(
    onNavigateBack: () -> Unit,
    viewModel: NotificationSettingsViewModel = viewModel()
) {
    val uiState by viewModel.uiState.collectAsState()
    val context = LocalContext.current
    val snackbarHostState = remember { SnackbarHostState() }

    Scaffold(
        topBar = {
            DoziTopBar(
                title = "Geli≈ümi≈ü Bildirim Ayarlarƒ±",
                canNavigateBack = true,
                onNavigateBack = onNavigateBack,
                backgroundColor = DoziTurquoise
            )
        },
        snackbarHost = { SnackbarHost(snackbarHostState) },
        containerColor = Color(0xFFF5F7FA)
    ) { padding ->
        if (uiState.isLoading) {
            Box(
                modifier = Modifier.fillMaxSize(),
                contentAlignment = Alignment.Center
            ) {
                CircularProgressIndicator(color = DoziTurquoise)
            }
        } else {
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding)
                    .verticalScroll(rememberScrollState())
                    .padding(16.dp),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                // üîï DND (Do Not Disturb) Settings
                DndSettingsCard(
                    enabled = uiState.dndEnabled,
                    startHour = uiState.dndStartHour,
                    startMinute = uiState.dndStartMinute,
                    endHour = uiState.dndEndHour,
                    endMinute = uiState.dndEndMinute,
                    onEnabledChange = { viewModel.updateDndEnabled(it) },
                    onStartTimeClick = {
                        TimePickerDialog(
                            context,
                            { _, hour, minute ->
                                viewModel.updateDndStartTime(hour, minute)
                            },
                            uiState.dndStartHour,
                            uiState.dndStartMinute,
                            true
                        ).show()
                    },
                    onEndTimeClick = {
                        TimePickerDialog(
                            context,
                            { _, hour, minute ->
                                viewModel.updateDndEndTime(hour, minute)
                            },
                            uiState.dndEndHour,
                            uiState.dndEndMinute,
                            true
                        ).show()
                    }
                )

                // ‚è∞ Adaptive Timing Settings
                AdaptiveTimingCard(
                    enabled = uiState.adaptiveTimingEnabled,
                    morningHour = uiState.preferredMorningHour,
                    eveningHour = uiState.preferredEveningHour,
                    onEnabledChange = { viewModel.updateAdaptiveTimingEnabled(it) },
                    onMorningHourChange = { viewModel.updatePreferredMorningHour(it) },
                    onEveningHourChange = { viewModel.updatePreferredEveningHour(it) }
                )

                // üß† Smart Reminder Settings
                SmartReminderCard(
                    enabled = uiState.smartReminderEnabled,
                    onEnabledChange = { viewModel.updateSmartReminderEnabled(it) }
                )

                // Bilgilendirme
                InfoCard()
            }
        }

        // Error Snackbar
        uiState.error?.let { error ->
            LaunchedEffect(error) {
                snackbarHostState.showSnackbar(
                    message = error,
                    duration = SnackbarDuration.Short
                )
                viewModel.clearError()
            }
        }
    }
}

@Composable
private fun DndSettingsCard(
    enabled: Boolean,
    startHour: Int,
    startMinute: Int,
    endHour: Int,
    endMinute: Int,
    onEnabledChange: (Boolean) -> Unit,
    onStartTimeClick: () -> Unit,
    onEndTimeClick: () -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        shape = RoundedCornerShape(20.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // Header
            Row(
                modifier = Modifier.fillMaxWidth(),
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.SpaceBetween
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    Box(
                        modifier = Modifier
                            .size(48.dp)
                            .background(
                                brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                    listOf(DoziPurple.copy(alpha = 0.2f), DoziBlue.copy(alpha = 0.1f))
                                ),
                                shape = RoundedCornerShape(12.dp)
                            ),
                        contentAlignment = Alignment.Center
                    ) {
                        Icon(
                            Icons.Default.DoNotDisturb,
                            contentDescription = null,
                            tint = DoziPurple,
                            modifier = Modifier.size(24.dp)
                        )
                    }
                    Column {
                        Text(
                            text = "üîï Rahatsƒ±z Etme Modu",
                            style = MaterialTheme.typography.titleMedium,
                            fontWeight = FontWeight.Bold
                        )
                        Text(
                            text = "Belirli saatlerde sessiz bildirimler",
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
                Switch(
                    checked = enabled,
                    onCheckedChange = onEnabledChange,
                    colors = SwitchDefaults.colors(
                        checkedThumbColor = Color.White,
                        checkedTrackColor = DoziPurple
                    )
                )
            }

            if (enabled) {
                Divider()

                // Start Time
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .clickable(onClick = onStartTimeClick)
                        .padding(vertical = 8.dp),
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.SpaceBetween
                ) {
                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(12.dp)
                    ) {
                        Icon(
                            Icons.Default.Bedtime,
                            contentDescription = null,
                            tint = DoziPurple
                        )
                        Text(
                            text = "Ba≈ülangƒ±√ß Saati",
                            style = MaterialTheme.typography.bodyLarge
                        )
                    }
                    Text(
                        text = String.format("%02d:%02d", startHour, startMinute),
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold,
                        color = DoziPurple
                    )
                }

                // End Time
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .clickable(onClick = onEndTimeClick)
                        .padding(vertical = 8.dp),
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.SpaceBetween
                ) {
                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(12.dp)
                    ) {
                        Icon(
                            Icons.Default.WbSunny,
                            contentDescription = null,
                            tint = WarningOrange
                        )
                        Text(
                            text = "Biti≈ü Saati",
                            style = MaterialTheme.typography.bodyLarge
                        )
                    }
                    Text(
                        text = String.format("%02d:%02d", endHour, endMinute),
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold,
                        color = WarningOrange
                    )
                }

                // Info
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .background(
                            DoziPurple.copy(alpha = 0.1f),
                            RoundedCornerShape(12.dp)
                        )
                        .padding(12.dp)
                ) {
                    Text(
                        text = "üí° Bu saatler arasƒ±nda bildirimler sessiz g√∂sterilecek. Kritik ila√ßlar etkilenmez.",
                        style = MaterialTheme.typography.bodySmall,
                        color = DoziPurple
                    )
                }
            }
        }
    }
}

@Composable
private fun AdaptiveTimingCard(
    enabled: Boolean,
    morningHour: Int,
    eveningHour: Int,
    onEnabledChange: (Boolean) -> Unit,
    onMorningHourChange: (Int) -> Unit,
    onEveningHourChange: (Int) -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        shape = RoundedCornerShape(20.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // Header
            Row(
                modifier = Modifier.fillMaxWidth(),
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.SpaceBetween
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    Box(
                        modifier = Modifier
                            .size(48.dp)
                            .background(
                                brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                    listOf(DoziTurquoise.copy(alpha = 0.2f), DoziBlue.copy(alpha = 0.1f))
                                ),
                                shape = RoundedCornerShape(12.dp)
                            ),
                        contentAlignment = Alignment.Center
                    ) {
                        Icon(
                            Icons.Default.Schedule,
                            contentDescription = null,
                            tint = DoziTurquoise,
                            modifier = Modifier.size(24.dp)
                        )
                    }
                    Column {
                        Text(
                            text = "‚è∞ Uyarlanabilir Zamanlama",
                            style = MaterialTheme.typography.titleMedium,
                            fontWeight = FontWeight.Bold
                        )
                        Text(
                            text = "Tercih ettiƒüiniz saatlere g√∂re ayarla",
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
                Switch(
                    checked = enabled,
                    onCheckedChange = onEnabledChange,
                    colors = SwitchDefaults.colors(
                        checkedThumbColor = Color.White,
                        checkedTrackColor = DoziTurquoise
                    )
                )
            }

            if (enabled) {
                Divider()

                // Morning Hour
                Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Icon(
                            Icons.Default.WbSunny,
                            contentDescription = null,
                            tint = WarningOrange,
                            modifier = Modifier.size(20.dp)
                        )
                        Text(
                            text = "Sabah Tercihi: ${String.format("%02d:00", morningHour)}",
                            style = MaterialTheme.typography.bodyLarge
                        )
                    }
                    Slider(
                        value = morningHour.toFloat(),
                        onValueChange = { onMorningHourChange(it.toInt()) },
                        valueRange = 6f..11f,
                        steps = 4,
                        colors = SliderDefaults.colors(
                            thumbColor = WarningOrange,
                            activeTrackColor = WarningOrange
                        )
                    )
                }

                // Evening Hour
                Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                    Row(
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Icon(
                            Icons.Default.Bedtime,
                            contentDescription = null,
                            tint = DoziPurple,
                            modifier = Modifier.size(20.dp)
                        )
                        Text(
                            text = "Ak≈üam Tercihi: ${String.format("%02d:00", eveningHour)}",
                            style = MaterialTheme.typography.bodyLarge
                        )
                    }
                    Slider(
                        value = eveningHour.toFloat(),
                        onValueChange = { onEveningHourChange(it.toInt()) },
                        valueRange = 18f..22f,
                        steps = 3,
                        colors = SliderDefaults.colors(
                            thumbColor = DoziPurple,
                            activeTrackColor = DoziPurple
                        )
                    )
                }

                // Info
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .background(
                            DoziTurquoise.copy(alpha = 0.1f),
                            RoundedCornerShape(12.dp)
                        )
                        .padding(12.dp)
                ) {
                    Text(
                        text = "üí° Sabah ve ak≈üam ila√ß hatƒ±rlatmalarƒ± tercih ettiƒüiniz saatlere kaydƒ±rƒ±lƒ±r.",
                        style = MaterialTheme.typography.bodySmall,
                        color = DoziTurquoise
                    )
                }
            }
        }
    }
}

@Composable
private fun SmartReminderCard(
    enabled: Boolean,
    onEnabledChange: (Boolean) -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        shape = RoundedCornerShape(20.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // Header
            Row(
                modifier = Modifier.fillMaxWidth(),
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.SpaceBetween
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    Box(
                        modifier = Modifier
                            .size(48.dp)
                            .background(
                                brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                    listOf(DoziBlue.copy(alpha = 0.2f), DoziTurquoise.copy(alpha = 0.1f))
                                ),
                                shape = RoundedCornerShape(12.dp)
                            ),
                        contentAlignment = Alignment.Center
                    ) {
                        Icon(
                            Icons.Default.Psychology,
                            contentDescription = null,
                            tint = DoziBlue,
                            modifier = Modifier.size(24.dp)
                        )
                    }
                    Column {
                        Text(
                            text = "üß† Akƒ±llƒ± Hatƒ±rlatma √ñnerileri",
                            style = MaterialTheme.typography.titleMedium,
                            fontWeight = FontWeight.Bold
                        )
                        Text(
                            text = "Alƒ±≈ükanlƒ±klarƒ±nƒ±za g√∂re √∂neriler",
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
                Switch(
                    checked = enabled,
                    onCheckedChange = onEnabledChange,
                    colors = SwitchDefaults.colors(
                        checkedThumbColor = Color.White,
                        checkedTrackColor = DoziBlue
                    )
                )
            }

            // Info
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .background(
                        DoziBlue.copy(alpha = 0.1f),
                        RoundedCornerShape(12.dp)
                    )
                    .padding(12.dp)
            ) {
                Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
                    Text(
                        text = "Aktif olduƒüunda:",
                        style = MaterialTheme.typography.bodySmall,
                        fontWeight = FontWeight.Bold,
                        color = DoziBlue
                    )
                    Text(
                        text = "‚Ä¢ En √ßok kullandƒ±ƒüƒ±nƒ±z erteleme s√ºreleri ‚≠ê ile i≈üaretlenir",
                        style = MaterialTheme.typography.bodySmall,
                        color = DoziBlue
                    )
                    Text(
                        text = "‚Ä¢ Ge√ßen hatƒ±rlatmalarƒ±nƒ±z analiz edilerek size √∂zel √∂neriler sunulur",
                        style = MaterialTheme.typography.bodySmall,
                        color = DoziBlue
                    )
                    Text(
                        text = "‚Ä¢ \"Hep 30 dk ge√ß alƒ±yorsunuz, zamanƒ± deƒüi≈ütirmek ister misiniz?\" gibi akƒ±llƒ± bildirimler alƒ±rsƒ±nƒ±z",
                        style = MaterialTheme.typography.bodySmall,
                        color = DoziBlue
                    )
                }
            }
        }
    }
}

@Composable
private fun InfoCard() {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        shape = RoundedCornerShape(20.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
    ) {
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .background(
                    androidx.compose.ui.graphics.Brush.verticalGradient(
                        listOf(
                            SuccessGreen.copy(alpha = 0.08f),
                            DoziTurquoise.copy(alpha = 0.08f)
                        )
                    )
                )
        ) {
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(20.dp),
                verticalArrangement = Arrangement.spacedBy(14.dp)
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.spacedBy(10.dp)
                ) {
                    Box(
                        modifier = Modifier
                            .size(40.dp)
                            .background(
                                brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                    listOf(SuccessGreen, DoziTurquoise)
                                ),
                                shape = androidx.compose.foundation.shape.CircleShape
                            ),
                        contentAlignment = Alignment.Center
                    ) {
                        Icon(
                            Icons.Default.Info,
                            contentDescription = null,
                            tint = Color.White,
                            modifier = Modifier.size(22.dp)
                        )
                    }
                    Text(
                        text = "Bilgi",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold
                    )
                }

                Text(
                    text = "Bu ayarlar t√ºm cihazlarƒ±nƒ±zda senkronize edilir ve ila√ß hatƒ±rlatmalarƒ±nƒ±zƒ± ki≈üiselle≈ütirir.",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }
    }
}

// ============================================================================
// FILE: NotificationSettingsScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/settings/NotificationSettingsScreen.kt
// [92 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.settings

import android.Manifest
import android.content.Intent
import android.net.Uri
import android.os.Build
import android.provider.Settings
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.core.content.ContextCompat
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*
import com.bardino.dozi.notifications.PermissionHandler

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun NotificationSettingsScreen(
    onNavigateBack: () -> Unit,
    onNavigateToAdvanced: () -> Unit = {}
) {
    val context = LocalContext.current

    // Bildirim izni kontrol√º
    val hasNotificationPermission = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
        ContextCompat.checkSelfPermission(
            context,
            Manifest.permission.POST_NOTIFICATIONS
        ) == android.content.pm.PackageManager.PERMISSION_GRANTED
    } else {
        true // Android 13 √∂ncesi i√ßin varsayƒ±lan olarak true
    }

    // √áin telefonu kontrol√º
    val isChinesePhone = PermissionHandler.isChineseManufacturer()
    val manufacturerName = PermissionHandler.getManufacturerDisplayName()
    var showBatteryDialog by remember { mutableStateOf(false) }

    // Pil Optimizasyonu Dialog
    if (showBatteryDialog) {
        AlertDialog(
            onDismissRequest = { showBatteryDialog = false },
            icon = {
                Icon(
                    Icons.Default.BatteryAlert,
                    contentDescription = null,
                    tint = WarningOrange,
                    modifier = Modifier.size(48.dp)
                )
            },
            title = {
                Text(
                    text = "$manufacturerName Pil Ayarlarƒ±",
                    fontWeight = FontWeight.Bold
                )
            },
            text = {
                Column(
                    verticalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    Text(
                        text = "Bildirimlerin d√ºzg√ºn √ßalƒ±≈ümasƒ± i√ßin a≈üaƒüƒ±daki ayarlarƒ± yapmanƒ±z √∂nerilir:",
                        style = MaterialTheme.typography.bodyMedium
                    )

                    Card(
                        colors = CardDefaults.cardColors(
                            containerColor = DoziTurquoise.copy(alpha = 0.1f)
                        )
                    ) {
                        Text(
                            text = PermissionHandler.getBatteryOptimizationInstructions(),
                            style = MaterialTheme.typography.bodySmall,
                            modifier = Modifier.padding(12.dp)
                        )
                    }
                }
            },
            confirmButton = {
                Button(
                    onClick = {
                        PermissionHandler.openBatteryOptimizationSettings(context)
                        showBatteryDialog = false
                    },
                    colors = ButtonDefaults.buttonColors(containerColor = DoziTurquoise)
                ) {
                    Text("Ayarlara Git")
                }
            },
            dismissButton = {
                TextButton(onClick = { showBatteryDialog = false }) {
                    Text("Daha Sonra")
                }
            }
        )
    }

    Scaffold(
        topBar = {
            DoziTopBar(
                title = "Bildirim Ayarlarƒ±",
                canNavigateBack = true,
                onNavigateBack = onNavigateBack,
                backgroundColor = DoziTurquoise
            )
        },
        containerColor = androidx.compose.ui.graphics.Color(0xFFF5F7FA)
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .verticalScroll(rememberScrollState())
                .padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // ƒ∞zin Durumu Kartƒ±
            Card(
                modifier = Modifier.fillMaxWidth(),
                colors = CardDefaults.cardColors(
                    containerColor = Color.White
                ),
                shape = androidx.compose.foundation.shape.RoundedCornerShape(20.dp),
                elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
            ) {
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .background(
                            androidx.compose.ui.graphics.Brush.horizontalGradient(
                                if (hasNotificationPermission) {
                                    listOf(SuccessGreen.copy(alpha = 0.15f), DoziTurquoise.copy(alpha = 0.15f))
                                } else {
                                    listOf(WarningOrange.copy(alpha = 0.15f), ErrorRed.copy(alpha = 0.15f))
                                }
                            )
                        )
                ) {
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(20.dp),
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.spacedBy(16.dp)
                    ) {
                        Box(
                            modifier = Modifier
                                .size(56.dp)
                                .background(
                                    brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                        if (hasNotificationPermission) {
                                            listOf(SuccessGreen, DoziTurquoise)
                                        } else {
                                            listOf(WarningOrange, ErrorRed)
                                        }
                                    ),
                                    shape = androidx.compose.foundation.shape.CircleShape
                                ),
                            contentAlignment = Alignment.Center
                        ) {
                            Icon(
                                if (hasNotificationPermission) Icons.Default.CheckCircle else Icons.Default.Warning,
                                contentDescription = null,
                                tint = Color.White,
                                modifier = Modifier.size(32.dp)
                            )
                        }
                        Column(modifier = Modifier.weight(1f)) {
                            Text(
                                text = if (hasNotificationPermission) "Bildirimler Aktif ‚úì" else "Bildirim ƒ∞zni Gerekli ‚ö†Ô∏è",
                                style = MaterialTheme.typography.titleLarge,
                                fontWeight = FontWeight.ExtraBold,
                                color = MaterialTheme.colorScheme.onSurface
                            )
                            Spacer(modifier = Modifier.height(4.dp))
                            Text(
                                text = if (hasNotificationPermission)
                                    "ƒ∞la√ß hatƒ±rlatmalarƒ± alabilirsiniz"
                                else
                                    "ƒ∞zin vermek i√ßin ayarlara gidin",
                                style = MaterialTheme.typography.bodyMedium,
                                color = MaterialTheme.colorScheme.onSurfaceVariant
                            )
                        }
                    }
                }
            }

            // Bildirim Ayarlarƒ± Butonu
            if (!hasNotificationPermission) {
                Button(
                    onClick = {
                        val intent = Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS).apply {
                            data = Uri.fromParts("package", context.packageName, null)
                        }
                        context.startActivity(intent)
                    },
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.buttonColors(containerColor = DoziTurquoise)
                ) {
                    Icon(Icons.Default.Settings, contentDescription = null)
                    Spacer(modifier = Modifier.width(8.dp))
                    Text("Uygulama Ayarlarƒ±na Git")
                }
            }

            // Geli≈ümi≈ü Bildirim Ayarlarƒ± Butonu
            if (hasNotificationPermission) {
                Button(
                    onClick = onNavigateToAdvanced,
                    modifier = Modifier.fillMaxWidth(),
                    colors = ButtonDefaults.buttonColors(containerColor = DoziPurple)
                ) {
                    Icon(Icons.Default.Psychology, contentDescription = null)
                    Spacer(modifier = Modifier.width(8.dp))
                    Text("Geli≈ümi≈ü Bildirim Ayarlarƒ±")
                }
            }

            // √áin Telefonu Uyarƒ± Kartƒ±
            if (isChinesePhone) {
                Card(
                    modifier = Modifier.fillMaxWidth(),
                    colors = CardDefaults.cardColors(
                        containerColor = Color.White
                    ),
                    shape = androidx.compose.foundation.shape.RoundedCornerShape(20.dp),
                    elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
                ) {
                    Box(
                        modifier = Modifier
                            .fillMaxWidth()
                            .background(
                                androidx.compose.ui.graphics.Brush.horizontalGradient(
                                    listOf(WarningOrange.copy(alpha = 0.15f), DoziCoral.copy(alpha = 0.15f))
                                )
                            )
                    ) {
                        Column(
                            modifier = Modifier
                                .fillMaxWidth()
                                .padding(20.dp),
                            verticalArrangement = Arrangement.spacedBy(12.dp)
                        ) {
                            Row(
                                verticalAlignment = Alignment.CenterVertically,
                                horizontalArrangement = Arrangement.spacedBy(12.dp)
                            ) {
                                Box(
                                    modifier = Modifier
                                        .size(48.dp)
                                        .background(
                                            brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                                listOf(WarningOrange, DoziCoral)
                                            ),
                                            shape = androidx.compose.foundation.shape.CircleShape
                                        ),
                                    contentAlignment = Alignment.Center
                                ) {
                                    Icon(
                                        Icons.Default.BatteryAlert,
                                        contentDescription = null,
                                        tint = Color.White,
                                        modifier = Modifier.size(28.dp)
                                    )
                                }
                                Column(modifier = Modifier.weight(1f)) {
                                    Text(
                                        text = "$manufacturerName Kullanƒ±cƒ±sƒ±",
                                        style = MaterialTheme.typography.titleMedium,
                                        fontWeight = FontWeight.ExtraBold,
                                        color = MaterialTheme.colorScheme.onSurface
                                    )
                                    Text(
                                        text = "Pil optimizasyonu ayarƒ± gerekebilir",
                                        style = MaterialTheme.typography.bodySmall,
                                        color = MaterialTheme.colorScheme.onSurfaceVariant
                                    )
                                }
                            }

                            Text(
                                text = "$manufacturerName telefonlarda pil tasarrufu √∂zellikleri bildirimlerin gecikmesine veya gelmemesine neden olabilir.",
                                style = MaterialTheme.typography.bodyMedium,
                                color = MaterialTheme.colorScheme.onSurfaceVariant
                            )

                            Button(
                                onClick = { showBatteryDialog = true },
                                modifier = Modifier.fillMaxWidth(),
                                colors = ButtonDefaults.buttonColors(containerColor = WarningOrange)
                            ) {
                                Icon(Icons.Default.Settings, contentDescription = null)
                                Spacer(modifier = Modifier.width(8.dp))
                                Text("Ayarlarƒ± D√ºzenle")
                            }
                        }
                    }
                }
            }

            // Bildirim T√ºrleri Bilgisi
            Card(
                modifier = Modifier.fillMaxWidth(),
                colors = CardDefaults.cardColors(containerColor = Color.White),
                shape = androidx.compose.foundation.shape.RoundedCornerShape(20.dp),
                elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
            ) {
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(20.dp),
                    verticalArrangement = Arrangement.spacedBy(18.dp)
                ) {
                    Text(
                        text = "üîî Bildirim T√ºrleri",
                        style = MaterialTheme.typography.titleLarge,
                        fontWeight = FontWeight.ExtraBold,
                        color = MaterialTheme.colorScheme.onSurface
                    )

                    NotificationTypeItem(
                        icon = Icons.Default.MedicalServices,
                        title = "ƒ∞la√ß Hatƒ±rlatmalarƒ±",
                        description = "ƒ∞la√ß alma saatlerinde bildirim",
                        color = DoziTurquoise
                    )

                    NotificationTypeItem(
                        icon = Icons.Default.Schedule,
                        title = "Planlƒ± Hatƒ±rlatmalar",
                        description = "√ñnceden ayarladƒ±ƒüƒ±nƒ±z zamanlar",
                        color = DoziPurple
                    )

                    NotificationTypeItem(
                        icon = Icons.Default.Info,
                        title = "Bilgilendirmeler",
                        description = "ƒ∞la√ß stoku ve saƒülƒ±k bilgileri",
                        color = DoziBlue
                    )
                }
            }

            // Bildirim Ayarlarƒ± ƒ∞pu√ßlarƒ±
            Card(
                modifier = Modifier.fillMaxWidth(),
                colors = CardDefaults.cardColors(containerColor = Color.White),
                shape = androidx.compose.foundation.shape.RoundedCornerShape(20.dp),
                elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
            ) {
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .background(
                            androidx.compose.ui.graphics.Brush.verticalGradient(
                                listOf(
                                    WarningOrange.copy(alpha = 0.08f),
                                    DoziTurquoise.copy(alpha = 0.08f)
                                )
                            )
                        )
                ) {
                    Column(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(20.dp),
                        verticalArrangement = Arrangement.spacedBy(14.dp)
                    ) {
                        Row(
                            verticalAlignment = Alignment.CenterVertically,
                            horizontalArrangement = Arrangement.spacedBy(10.dp)
                        ) {
                            Box(
                                modifier = Modifier
                                    .size(40.dp)
                                    .background(
                                        brush = androidx.compose.ui.graphics.Brush.linearGradient(
                                            listOf(WarningOrange, DoziTurquoise)
                                        ),
                                        shape = androidx.compose.foundation.shape.CircleShape
                                    ),
                                contentAlignment = Alignment.Center
                            ) {
                                Icon(
                                    Icons.Default.Lightbulb,
                                    contentDescription = null,
                                    tint = Color.White,
                                    modifier = Modifier.size(22.dp)
                                )
                            }
                            Text(
                                text = "ƒ∞pu√ßlarƒ±",
                                style = MaterialTheme.typography.titleLarge,
                                fontWeight = FontWeight.ExtraBold,
                                color = MaterialTheme.colorScheme.onSurface
                            )
                        }

                        Text(
                            text = "‚Ä¢ Bildirimleri sessize almak i√ßin telefon ayarlarƒ±nƒ±zdan 'Sessiz' modunu kullanƒ±n",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )

                        Text(
                            text = "‚Ä¢ Titre≈üimi kapatmak i√ßin Ayarlar > Bildirimler b√∂l√ºm√ºnden deƒüi≈üiklik yapabilirsiniz",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )

                        Text(
                            text = "‚Ä¢ Bildirimlerin g√∂sterilmemesi i√ßin cihaz ayarlarƒ±ndan 'Rahatsƒ±z Etme' modunu aktif edin",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
            }
        }
    }
}

@Composable
private fun NotificationTypeItem(
    icon: androidx.compose.ui.graphics.vector.ImageVector,
    title: String,
    description: String,
    color: androidx.compose.ui.graphics.Color = DoziTurquoise
) {
    Row(
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.spacedBy(14.dp)
    ) {
        Box(
            modifier = Modifier
                .size(48.dp)
                .background(
                    brush = androidx.compose.ui.graphics.Brush.linearGradient(
                        listOf(color.copy(alpha = 0.2f), color.copy(alpha = 0.1f))
                    ),
                    shape = androidx.compose.foundation.shape.RoundedCornerShape(12.dp)
                ),
            contentAlignment = Alignment.Center
        ) {
            Icon(
                icon,
                contentDescription = null,
                tint = color,
                modifier = Modifier.size(24.dp)
            )
        }
        Column(modifier = Modifier.weight(1f)) {
            Text(
                text = title,
                style = MaterialTheme.typography.bodyLarge,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )
            Spacer(modifier = Modifier.height(2.dp))
            Text(
                text = description,
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
}

// ============================================================================
// FILE: NotificationSettingsViewModel.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/settings/NotificationSettingsViewModel.kt
// [93 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.settings

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.bardino.dozi.core.data.model.User
import com.bardino.dozi.core.data.repository.UserRepository
import kotlinx.coroutines.flow.*
import kotlinx.coroutines.launch

/**
 * Notification Settings UI State
 */
data class NotificationSettingsUiState(
    val user: User? = null,
    val isLoading: Boolean = false,
    val error: String? = null,

    // DND Settings
    val dndEnabled: Boolean = false,
    val dndStartHour: Int = 22,
    val dndStartMinute: Int = 0,
    val dndEndHour: Int = 8,
    val dndEndMinute: Int = 0,

    // Adaptive Timing
    val adaptiveTimingEnabled: Boolean = false,
    val preferredMorningHour: Int = 8,
    val preferredEveningHour: Int = 20,

    // Smart Reminder
    val smartReminderEnabled: Boolean = false
)

/**
 * Notification Settings ViewModel
 */
class NotificationSettingsViewModel(
    private val userRepository: UserRepository = UserRepository()
) : ViewModel() {

    private val _uiState = MutableStateFlow(NotificationSettingsUiState())
    val uiState: StateFlow<NotificationSettingsUiState> = _uiState.asStateFlow()

    init {
        loadUserSettings()
    }

    /**
     * Kullanƒ±cƒ± ayarlarƒ±nƒ± y√ºkle
     */
    private fun loadUserSettings() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }

            try {
                val user = userRepository.getUserData()
                if (user != null) {
                    _uiState.update {
                        it.copy(
                            user = user,
                            dndEnabled = user.dndEnabled,
                            dndStartHour = user.dndStartHour,
                            dndStartMinute = user.dndStartMinute,
                            dndEndHour = user.dndEndHour,
                            dndEndMinute = user.dndEndMinute,
                            adaptiveTimingEnabled = user.adaptiveTimingEnabled,
                            preferredMorningHour = user.preferredMorningHour,
                            preferredEveningHour = user.preferredEveningHour,
                            smartReminderEnabled = user.smartReminderEnabled,
                            isLoading = false,
                            error = null
                        )
                    }
                } else {
                    _uiState.update {
                        it.copy(
                            isLoading = false,
                            error = "Kullanƒ±cƒ± bilgisi bulunamadƒ±"
                        )
                    }
                }
            } catch (e: Exception) {
                _uiState.update {
                    it.copy(
                        isLoading = false,
                        error = e.message ?: "Bilinmeyen hata"
                    )
                }
            }
        }
    }

    // ==================== DND Settings ====================

    fun updateDndEnabled(enabled: Boolean) {
        viewModelScope.launch {
            try {
                userRepository.updateUserField("dndEnabled", enabled)
                _uiState.update { it.copy(dndEnabled = enabled) }
            } catch (e: Exception) {
                _uiState.update { it.copy(error = e.message) }
            }
        }
    }

    fun updateDndStartTime(hour: Int, minute: Int) {
        viewModelScope.launch {
            try {
                val updates = mapOf(
                    "dndStartHour" to hour,
                    "dndStartMinute" to minute
                )
                userRepository.updateUserField("dndStartHour", hour)
                userRepository.updateUserField("dndStartMinute", minute)
                _uiState.update {
                    it.copy(
                        dndStartHour = hour,
                        dndStartMinute = minute
                    )
                }
            } catch (e: Exception) {
                _uiState.update { it.copy(error = e.message) }
            }
        }
    }

    fun updateDndEndTime(hour: Int, minute: Int) {
        viewModelScope.launch {
            try {
                userRepository.updateUserField("dndEndHour", hour)
                userRepository.updateUserField("dndEndMinute", minute)
                _uiState.update {
                    it.copy(
                        dndEndHour = hour,
                        dndEndMinute = minute
                    )
                }
            } catch (e: Exception) {
                _uiState.update { it.copy(error = e.message) }
            }
        }
    }

    // ==================== Adaptive Timing ====================

    fun updateAdaptiveTimingEnabled(enabled: Boolean) {
        viewModelScope.launch {
            try {
                userRepository.updateUserField("adaptiveTimingEnabled", enabled)
                _uiState.update { it.copy(adaptiveTimingEnabled = enabled) }
            } catch (e: Exception) {
                _uiState.update { it.copy(error = e.message) }
            }
        }
    }

    fun updatePreferredMorningHour(hour: Int) {
        viewModelScope.launch {
            try {
                userRepository.updateUserField("preferredMorningHour", hour)
                _uiState.update { it.copy(preferredMorningHour = hour) }
            } catch (e: Exception) {
                _uiState.update { it.copy(error = e.message) }
            }
        }
    }

    fun updatePreferredEveningHour(hour: Int) {
        viewModelScope.launch {
            try {
                userRepository.updateUserField("preferredEveningHour", hour)
                _uiState.update { it.copy(preferredEveningHour = hour) }
            } catch (e: Exception) {
                _uiState.update { it.copy(error = e.message) }
            }
        }
    }

    // ==================== Smart Reminder ====================

    fun updateSmartReminderEnabled(enabled: Boolean) {
        viewModelScope.launch {
            try {
                userRepository.updateUserField("smartReminderEnabled", enabled)
                _uiState.update { it.copy(smartReminderEnabled = enabled) }
            } catch (e: Exception) {
                _uiState.update { it.copy(error = e.message) }
            }
        }
    }

    /**
     * Hata mesajƒ±nƒ± temizle
     */
    fun clearError() {
        _uiState.update { it.copy(error = null) }
    }
}

// ============================================================================
// FILE: NotificationSoundSettingsScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/settings/NotificationSoundSettingsScreen.kt
// [94 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.settings

import android.media.RingtoneManager
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.components.PremiumBadge
import com.bardino.dozi.core.ui.components.PremiumGateDialog
import com.bardino.dozi.core.ui.theme.*

/**
 * üéµ Bildirim Sesi √ñzelle≈ütirme Ekranƒ± (Premium Feature)
 */
@Composable
fun NotificationSoundSettingsScreen(
    isPremium: Boolean,
    currentSoundUri: String?,
    currentSoundName: String,
    onSoundSelected: (uri: String, name: String) -> Unit,
    onNavigateBack: () -> Unit,
    onUpgrade: () -> Unit
) {
    var showPremiumDialog by remember { mutableStateOf(false) }
    val context = LocalContext.current

    // Sistem sesleri listesi
    val systemSounds = remember {
        listOf(
            "Notification 1" to "android.resource://com.android.providers.settings/notification1",
            "Notification 2" to "android.resource://com.android.providers.settings/notification2",
            "Notification 3" to "android.resource://com.android.providers.settings/notification3",
            "Gentle Bell" to "android.resource://com.android.providers.settings/gentle_bell",
            "Soft Chime" to "android.resource://com.android.providers.settings/soft_chime"
        )
    }

    // Premium deƒüilse gate g√∂ster
    if (!isPremium && showPremiumDialog) {
        PremiumGateDialog(
            visible = true,
            featureName = "√ñzel Bildirim Sesi",
            featureDescription = "Dozi Ekstra ile kendi bildirim sesini se√ßebilir, uygulamayƒ± ki≈üiselle≈ütirebilirsin",
            onDismiss = { showPremiumDialog = false },
            onUpgrade = onUpgrade
        )
    }

    Scaffold(
        topBar = {
            DoziTopBar(
                title = "Bildirim Sesi",
                canNavigateBack = true,
                onNavigateBack = onNavigateBack,
                actions = if (isPremium) {
                    { PremiumBadge(size = 24.dp) }
                } else {
                    null
                }
            )
        },
        containerColor = MaterialTheme.colorScheme.background
    ) { padding ->
        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding),
            contentPadding = PaddingValues(16.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            // Header
            item {
                Card(
                    colors = CardDefaults.cardColors(
                        containerColor = if (isPremium) DoziGold.copy(alpha = 0.1f) else Gray100
                    ),
                    shape = RoundedCornerShape(16.dp)
                ) {
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(16.dp),
                        horizontalArrangement = Arrangement.spacedBy(12.dp),
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        Icon(
                            Icons.Default.MusicNote,
                            contentDescription = null,
                            tint = if (isPremium) DoziGold else DoziPrimary,
                            modifier = Modifier.size(32.dp)
                        )
                        Column(modifier = Modifier.weight(1f)) {
                            Text(
                                text = "Se√ßili Ses",
                                style = MaterialTheme.typography.labelMedium,
                                color = MaterialTheme.colorScheme.onSurfaceVariant
                            )
                            Text(
                                text = currentSoundName,
                                style = MaterialTheme.typography.titleMedium,
                                fontWeight = FontWeight.Bold,
                                color = MaterialTheme.colorScheme.onSurface
                            )
                        }
                    }
                }
            }

            // Ses listesi
            item {
                Text(
                    text = "Mevcut Sesler",
                    style = MaterialTheme.typography.titleMedium,
                    fontWeight = FontWeight.Bold,

                    color = MaterialTheme.colorScheme.onSurface,

                    modifier = Modifier.padding(vertical = 8.dp)
                )
            }

            // Varsayƒ±lan ses
            item {
                SoundItem(
                    name = "Varsayƒ±lan",
                    isSelected = currentSoundName == "Varsayƒ±lan",
                    isPremium = isPremium,
                    onClick = {
                        if (isPremium) {
                            onSoundSelected("", "Varsayƒ±lan")
                        } else {
                            showPremiumDialog = true
                        }
                    }
                )
            }

            // Sistem sesleri
            items(systemSounds) { (name, uri) ->
                SoundItem(
                    name = name,
                    isSelected = currentSoundName == name,
                    isPremium = isPremium,
                    onClick = {
                        if (isPremium) {
                            onSoundSelected(uri, name)
                        } else {
                            showPremiumDialog = true
                        }
                    }
                )
            }

            // Premium upsell footer
            if (!isPremium) {
                item {
                    Card(
                        modifier = Modifier
                            .fillMaxWidth()
                            .clickable { onUpgrade() },
                        colors = CardDefaults.cardColors(
                            containerColor = DoziPrimary.copy(alpha = 0.1f)
                        ),
                        shape = RoundedCornerShape(16.dp)
                    ) {
                        Row(
                            modifier = Modifier.padding(16.dp),
                            horizontalArrangement = Arrangement.spacedBy(12.dp),
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Icon(
                                Icons.Default.Lock,
                                contentDescription = null,
                                tint = DoziPrimary
                            )
                            Text(
                                text = "√ñzel sesleri kullanmak i√ßin Dozi Ekstra'ya ge√ß",
                                style = MaterialTheme.typography.bodyMedium,

                                color = MaterialTheme.colorScheme.onSurface,

                                modifier = Modifier.weight(1f)
                            )
                            Icon(
                                Icons.Default.ArrowForward,
                                contentDescription = null,
                                tint = DoziPrimary
                            )
                        }
                    }
                }
            }
        }
    }
}

@Composable
private fun SoundItem(
    name: String,
    isSelected: Boolean,
    isPremium: Boolean,
    onClick: () -> Unit
) {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .clickable { onClick() },
        colors = CardDefaults.cardColors(
            containerColor = if (isSelected) {
                if (isPremium) DoziGold.copy(alpha = 0.15f) else DoziPrimary.copy(alpha = 0.15f)
            } else {
                Color.White
            }
        ),
        shape = RoundedCornerShape(12.dp),
        border = if (isSelected) {
            BorderStroke(2.dp, if (isPremium) DoziGold else DoziPrimary)
        } else null
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Row(
                horizontalArrangement = Arrangement.spacedBy(12.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Icon(
                    if (isSelected) Icons.Default.CheckCircle else Icons.Default.MusicNote,
                    contentDescription = null,
                    tint = if (isSelected) {
                        if (isPremium) DoziGold else DoziPrimary
                    } else {
                        Gray500
                    }
                )
                Text(
                    text = name,
                    style = MaterialTheme.typography.bodyLarge,
                    fontWeight = if (isSelected) FontWeight.Bold else FontWeight.Normal,
                    color = if (isSelected) MaterialTheme.colorScheme.onSurface else MaterialTheme.colorScheme.onSurfaceVariant
                )
            }

            if (!isPremium && name != "Varsayƒ±lan") {
                Icon(
                    Icons.Default.Lock,
                    contentDescription = "Premium",
                    tint = Gray400,
                    modifier = Modifier.size(20.dp)
                )
            }
        }
    }
}

// ============================================================================
// FILE: SettingsScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/settings/SettingsScreen.kt
// [95 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.settings

import android.os.Build
import android.widget.Toast
import androidx.annotation.RequiresApi
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import android.Manifest
import android.content.pm.PackageManager
import androidx.core.content.ContextCompat
import com.bardino.dozi.core.data.model.User
import com.bardino.dozi.core.data.repository.UserRepository
import com.bardino.dozi.core.data.ThemePreferences
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*
import com.bardino.dozi.notifications.NotificationHelper
import kotlinx.coroutines.launch

@RequiresApi(Build.VERSION_CODES.O)
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun SettingsScreen(
    onNavigateBack: () -> Unit
) {
    val context = LocalContext.current
    val userRepository = remember { UserRepository() }
    val scope = rememberCoroutineScope()

    var userData by remember { mutableStateOf<User?>(null) }
    var isLoading by remember { mutableStateOf(true) }

    // Firestore'dan kullanƒ±cƒ± verilerini √ßek
    LaunchedEffect(Unit) {
        scope.launch {
            try {
                userData = userRepository.getUserData()
                isLoading = false
            } catch (e: Exception) {
                Toast.makeText(context, "Ayarlar y√ºklenemedi", Toast.LENGTH_SHORT).show()
                isLoading = false
            }
        }
    }

    Scaffold(
        topBar = {
            DoziTopBar(
                title = "Ayarlar",
                canNavigateBack = true,
                onNavigateBack = onNavigateBack,
                backgroundColor = MaterialTheme.colorScheme.surface
            )
        },
        containerColor = MaterialTheme.colorScheme.background
    ) { padding ->
        if (isLoading) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding),
                contentAlignment = Alignment.Center
            ) {
                CircularProgressIndicator(color = DoziTurquoise)
            }
        } else {
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(padding)
                    .verticalScroll(rememberScrollState())
                    .padding(16.dp),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                // Profil Ayarlarƒ±
                SettingsSection(title = "Profil") {
                    var showNameDialog by remember { mutableStateOf(false) }
                    var currentName by remember { mutableStateOf(userData?.name ?: "") }

                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(vertical = 8.dp),
                        verticalAlignment = Alignment.CenterVertically,
                        horizontalArrangement = Arrangement.SpaceBetween
                    ) {
                        Row(
                            verticalAlignment = Alignment.CenterVertically,
                            horizontalArrangement = Arrangement.spacedBy(12.dp),
                            modifier = Modifier.weight(1f)
                        ) {
                            Icon(
                                Icons.Default.Person,
                                contentDescription = null,
                                tint = DoziTurquoise,
                                modifier = Modifier.size(24.dp)
                            )
                            Column {
                                Text(
                                    text = "ƒ∞sim",
                                    style = MaterialTheme.typography.bodyLarge,
                                    fontWeight = FontWeight.Medium,
                                    color = MaterialTheme.colorScheme.onSurface
                                )
                                Text(
                                    text = currentName.ifEmpty { "ƒ∞sim belirtilmemi≈ü" },
                                    style = MaterialTheme.typography.bodySmall,
                                    color = MaterialTheme.colorScheme.onSurfaceVariant
                                )
                            }
                        }
                        IconButton(onClick = { showNameDialog = true }) {
                            Icon(
                                Icons.Default.Edit,
                                contentDescription = "ƒ∞smi D√ºzenle",
                                tint = DoziTurquoise
                            )
                        }
                    }

                    if (showNameDialog) {
                        var newName by remember { mutableStateOf(currentName) }
                        AlertDialog(
                            onDismissRequest = { showNameDialog = false },
                            title = { Text("ƒ∞sminizi Girin") },
                            text = {
                                OutlinedTextField(
                                    value = newName,
                                    onValueChange = { newName = it },
                                    label = { Text("ƒ∞sim") },
                                    singleLine = true,
                                    colors = OutlinedTextFieldDefaults.colors(
                                        focusedBorderColor = DoziTurquoise,
                                        unfocusedBorderColor = Color.Gray.copy(alpha = 0.3f)
                                    )
                                )
                            },
                            confirmButton = {
                                Button(
                                    onClick = {
                                        if (newName.isNotBlank()) {
                                            scope.launch {
                                                try {
                                                    userRepository.updateUserField("name", newName)
                                                    currentName = newName
                                                    Toast.makeText(context, "ƒ∞sim g√ºncellendi", Toast.LENGTH_SHORT).show()
                                                    showNameDialog = false
                                                } catch (e: Exception) {
                                                    Toast.makeText(context, "Hata: ${e.message}", Toast.LENGTH_SHORT).show()
                                                }
                                            }
                                        }
                                    },
                                    colors = ButtonDefaults.buttonColors(containerColor = DoziTurquoise)
                                ) {
                                    Text("Kaydet")
                                }
                            },
                            dismissButton = {
                                TextButton(onClick = { showNameDialog = false }) {
                                    Text("ƒ∞ptal")
                                }
                            }
                        )
                    }
                }

                // Tema Ayarƒ±
                SettingsSection(title = "G√∂r√ºn√ºm") {
                    var selectedTheme by remember { mutableStateOf(userData?.theme ?: "system") }

                    SettingsDropdown(
                        label = "Tema",
                        icon = Icons.Default.Palette,
                        options = listOf("light" to "A√ßƒ±k", "dark" to "Koyu", "system" to "Sistem"),
                        selectedValue = selectedTheme,
                        onValueChange = { newTheme ->
                            selectedTheme = newTheme
                            scope.launch {
                                try {
                                    // üé® DataStore'a kaydet (ger√ßek zamanlƒ± i√ßin)
                                    ThemePreferences.saveTheme(context, newTheme)

                                    // üì¶ Firestore'a kaydet (senkronizasyon i√ßin)
                                    userRepository.updateUserField("theme", newTheme)

                                    val themeText = when (newTheme) {
                                        "dark" -> "Koyu tema"
                                        "light" -> "A√ßƒ±k tema"
                                        else -> "Sistem temasƒ±"
                                    }
                                    Toast.makeText(context, "$themeText etkinle≈ütirildi", Toast.LENGTH_SHORT).show()
                                } catch (e: Exception) {
                                    Toast.makeText(context, "Hata: ${e.message}", Toast.LENGTH_SHORT).show()
                                }
                            }
                        }
                    )
                }

                // Dil Ayarƒ±
                SettingsSection(title = "B√∂lge") {
                    var selectedLanguage by remember { mutableStateOf(userData?.language ?: "tr") }

                    SettingsDropdown(
                        label = "Dil",
                        icon = Icons.Default.Language,
                        options = listOf("tr" to "T√ºrk√ße", "en" to "English"),
                        selectedValue = selectedLanguage,
                        onValueChange = { newLang ->
                            selectedLanguage = newLang
                            scope.launch {
                                try {
                                    userRepository.updateUserField("language", newLang)
                                    Toast.makeText(context, "Dil g√ºncellendi", Toast.LENGTH_SHORT).show()
                                } catch (e: Exception) {
                                    Toast.makeText(context, "Hata: ${e.message}", Toast.LENGTH_SHORT).show()
                                }
                            }
                        }
                    )

                    Spacer(modifier = Modifier.height(8.dp))

                    var selectedTimezone by remember { mutableStateOf(userData?.timezone ?: "Europe/Istanbul") }

                    SettingsDropdown(
                        label = "Saat Dilimi",
                        icon = Icons.Default.AccessTime,
                        options = listOf(
                            "Europe/Istanbul" to "ƒ∞stanbul (GMT+3)",
                            "Europe/London" to "Londra (GMT+0)",
                            "America/New_York" to "New York (GMT-5)"
                        ),
                        selectedValue = selectedTimezone,
                        onValueChange = { newTimezone ->
                            selectedTimezone = newTimezone
                            scope.launch {
                                try {
                                    userRepository.updateUserField("timezone", newTimezone)
                                    Toast.makeText(context, "Saat dilimi g√ºncellendi", Toast.LENGTH_SHORT).show()
                                } catch (e: Exception) {
                                    Toast.makeText(context, "Hata: ${e.message}", Toast.LENGTH_SHORT).show()
                                }
                            }
                        }
                    )
                }

                // Bildirim Ayarlarƒ±
                SettingsSection(title = "Bildirimler") {
                    var vibrationEnabled by remember { mutableStateOf(userData?.vibration ?: true) }

                    SettingsSwitch(
                        label = "Titre≈üim",
                        description = "Bildirimler i√ßin titre≈üim",
                        icon = Icons.Default.Vibration,
                        checked = vibrationEnabled,
                        onCheckedChange = { isEnabled ->
                            vibrationEnabled = isEnabled
                            scope.launch {
                                try {
                                    userRepository.updateUserField("vibration", isEnabled)
                                    Toast.makeText(
                                        context,
                                        if (isEnabled) "Titre≈üim a√ßƒ±k" else "Titre≈üim kapalƒ±",
                                        Toast.LENGTH_SHORT
                                    ).show()
                                } catch (e: Exception) {
                                    Toast.makeText(context, "Hata: ${e.message}", Toast.LENGTH_SHORT).show()
                                }
                            }
                        }
                    )

                    Spacer(modifier = Modifier.height(16.dp))

                    var importantNotificationsEnabled by remember { mutableStateOf(userData?.importantNotificationsEnabled ?: true) }

                    SettingsSwitch(
                        label = "√ñnemli Bildirimler",
                        description = "1 saat sonraki kritik hatƒ±rlatmalar (Sessizde bile √ßalar)",
                        icon = Icons.Default.PriorityHigh,
                        checked = importantNotificationsEnabled,
                        onCheckedChange = { isEnabled ->
                            importantNotificationsEnabled = isEnabled
                            scope.launch {
                                try {
                                    userRepository.updateUserField("importantNotificationsEnabled", isEnabled)
                                    Toast.makeText(
                                        context,
                                        if (isEnabled) "√ñnemli bildirimler a√ßƒ±k" else "√ñnemli bildirimler kapalƒ±",
                                        Toast.LENGTH_SHORT
                                    ).show()
                                } catch (e: Exception) {
                                    Toast.makeText(context, "Hata: ${e.message}", Toast.LENGTH_SHORT).show()
                                }
                            }
                        }
                    )

                    Spacer(modifier = Modifier.height(16.dp))

                    // üîî Test Bildirimi Butonu
                    TestNotificationButton()
                }

                // Ses Ayarlarƒ±
                SettingsSection(title = "Sesli Asistan") {
                    var selectedVoiceGender by remember { mutableStateOf(userData?.voiceGender ?: "erkek") }

                    SettingsDropdown(
                        label = "Ses Se√ßimi",
                        icon = Icons.Default.RecordVoiceOver,
                        options = listOf(
                            "erkek" to "üéôÔ∏è Ozan (Erkek Ses)",
                            "kadin" to "üéôÔ∏è Efsun (Kadƒ±n Ses)"
                        ),
                        selectedValue = selectedVoiceGender,
                        onValueChange = { newVoice ->
                            selectedVoiceGender = newVoice
                            scope.launch {
                                try {
                                    userRepository.updateUserField("voiceGender", newVoice)
                                    Toast.makeText(
                                        context,
                                        "Ses deƒüi≈ütirildi: ${if (newVoice == "erkek") "Ozan" else "Efsun"}",
                                        Toast.LENGTH_SHORT
                                    ).show()
                                } catch (e: Exception) {
                                    Toast.makeText(context, "Hata: ${e.message}", Toast.LENGTH_SHORT).show()
                                }
                            }
                        }
                    )

                    Spacer(modifier = Modifier.height(12.dp))

                    // √ñrnek Ses Dinleme Butonlarƒ±
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        OutlinedButton(
                            onClick = {
                                com.bardino.dozi.core.utils.SoundHelper.playSampleSound(context, "erkek")
                            },
                            modifier = Modifier.weight(1f),
                            colors = ButtonDefaults.outlinedButtonColors(
                                containerColor = if (selectedVoiceGender == "erkek") DoziTurquoise.copy(alpha = 0.1f) else Color.Transparent
                            )
                        ) {
                            Icon(
                                Icons.Default.PlayArrow,
                                contentDescription = null,
                                modifier = Modifier.size(18.dp)
                            )
                            Spacer(Modifier.width(4.dp))
                            Text("Ozan'ƒ± Dinle")
                        }

                        OutlinedButton(
                            onClick = {
                                com.bardino.dozi.core.utils.SoundHelper.playSampleSound(context, "kadin")
                            },
                            modifier = Modifier.weight(1f),
                            colors = ButtonDefaults.outlinedButtonColors(
                                containerColor = if (selectedVoiceGender == "kadin") DoziTurquoise.copy(alpha = 0.1f) else Color.Transparent
                            )
                        ) {
                            Icon(
                                Icons.Default.PlayArrow,
                                contentDescription = null,
                                modifier = Modifier.size(18.dp)
                            )
                            Spacer(Modifier.width(4.dp))
                            Text("Efsun'u Dinle")
                        }
                    }
                }

                // üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Aile Paketi
                SettingsSection(title = "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Aile Paketi") {
                    // Aile paketi durumu g√∂ster
                    val isInFamilyPlan = userData?.isInFamilyPlan() == true
                    val isFamilyOrganizer = userData?.isFamilyOrganizer() == true

                    if (isInFamilyPlan) {
                        // Aile paketinde ise bilgi g√∂ster
                        Surface(
                            color = DoziTurquoise.copy(alpha = 0.1f),
                            shape = RoundedCornerShape(12.dp),
                            modifier = Modifier.fillMaxWidth()
                        ) {
                            Column(
                                modifier = Modifier.padding(16.dp),
                                verticalArrangement = Arrangement.spacedBy(8.dp)
                            ) {
                                Row(
                                    verticalAlignment = Alignment.CenterVertically,
                                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                                ) {
                                    Icon(
                                        Icons.Default.CheckCircle,
                                        contentDescription = null,
                                        tint = DoziTurquoise
                                    )
                                    Text(
                                        text = if (isFamilyOrganizer) "Aile Paketi Y√∂neticisi" else "Aile Paketi √úyesi",
                                        style = MaterialTheme.typography.titleSmall,
                                        fontWeight = FontWeight.Bold,
                                        color = DoziTurquoise
                                    )
                                }
                                Text(
                                    text = "Aile paketi aktif. Premium √∂zelliklerden faydalanƒ±yorsunuz.",
                                    style = MaterialTheme.typography.bodySmall,
                                    color = MaterialTheme.colorScheme.onSurfaceVariant
                                )
                            }
                        }

                        Spacer(modifier = Modifier.height(12.dp))

                        // Aile paketi bilgisi butonu
                        OutlinedButton(
                            onClick = {
                                com.bardino.dozi.core.utils.FamilyPlanTestHelper.showFamilyPlanInfo(context)
                            },
                            modifier = Modifier.fillMaxWidth(),
                            colors = ButtonDefaults.outlinedButtonColors(
                                containerColor = DoziBlue.copy(alpha = 0.1f)
                            )
                        ) {
                            Icon(Icons.Default.Info, contentDescription = null, tint = DoziBlue)
                            Spacer(Modifier.width(8.dp))
                            Text("Aile Paketi Bilgileri")
                        }
                    } else {
                        // Aile paketinde deƒüilse katƒ±lma se√ßenekleri g√∂ster
                        Text(
                            text = "Aile paketi ile 6 ki≈üiye kadar premium √∂zelliklerden faydalanabilirsiniz.",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )

                        Spacer(modifier = Modifier.height(12.dp))

                        // Davet Kodu ile Katƒ±l
                        var invitationCode by remember { mutableStateOf("") }
                        OutlinedTextField(
                            value = invitationCode,
                            onValueChange = { invitationCode = it.uppercase() },
                            label = { Text("Davet Kodu") },
                            leadingIcon = {
                                Icon(Icons.Default.VpnKey, contentDescription = null, tint = DoziTurquoise)
                            },
                            trailingIcon = {
                                if (invitationCode.length == 6) {
                                    IconButton(
                                        onClick = {
                                            com.bardino.dozi.core.utils.FamilyPlanTestHelper.joinWithCode(context, invitationCode)
                                            invitationCode = ""
                                        }
                                    ) {
                                        Icon(Icons.Default.Check, contentDescription = "Katƒ±l", tint = DoziTurquoise)
                                    }
                                }
                            },
                            modifier = Modifier.fillMaxWidth(),
                            colors = OutlinedTextFieldDefaults.colors(
                                focusedBorderColor = DoziTurquoise,
                                unfocusedBorderColor = Color.Gray.copy(alpha = 0.3f)
                            ),
                            placeholder = { Text("ABC123") }
                        )

                        Spacer(modifier = Modifier.height(4.dp))
                        Text(
                            text = "6 haneli davet kodunu girerek aile paketine katƒ±labilirsiniz",
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant,
                            modifier = Modifier.padding(horizontal = 4.dp)
                        )
                    }
                }
            }
        }
    }
}

@Composable
private fun SettingsSection(
    title: String,
    content: @Composable ColumnScope.() -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
        elevation = CardDefaults.cardElevation(defaultElevation = 1.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp)
        ) {
            Text(
                text = title,
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface,
                modifier = Modifier.padding(bottom = 12.dp)
            )
            content()
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
private fun SettingsDropdown(
    label: String,
    icon: androidx.compose.ui.graphics.vector.ImageVector,
    options: List<Pair<String, String>>,
    selectedValue: String,
    onValueChange: (String) -> Unit
) {
    var expanded by remember { mutableStateOf(false) }

    ExposedDropdownMenuBox(
        expanded = expanded,
        onExpandedChange = { expanded = !expanded }
    ) {
        OutlinedTextField(
            value = options.find { it.first == selectedValue }?.second ?: "",
            onValueChange = {},
            readOnly = true,
            label = { Text(label) },
            leadingIcon = {
                Icon(icon, contentDescription = null, tint = DoziTurquoise)
            },
            trailingIcon = {
                ExposedDropdownMenuDefaults.TrailingIcon(expanded = expanded)
            },
            colors = OutlinedTextFieldDefaults.colors(
                focusedBorderColor = DoziTurquoise,
                unfocusedBorderColor = Color.Gray.copy(alpha = 0.3f)
            ),
            modifier = Modifier
                .fillMaxWidth()
                .menuAnchor()
        )

        ExposedDropdownMenu(
            expanded = expanded,
            onDismissRequest = { expanded = false }
        ) {
            options.forEach { (value, displayText) ->
                DropdownMenuItem(
                    text = { Text(displayText) },
                    onClick = {
                        onValueChange(value)
                        expanded = false
                    }
                )
            }
        }
    }
}

@Composable
private fun SettingsSwitch(
    label: String,
    description: String,
    icon: androidx.compose.ui.graphics.vector.ImageVector,
    checked: Boolean,
    onCheckedChange: (Boolean) -> Unit
) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .padding(vertical = 8.dp),
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.SpaceBetween
    ) {
        Row(
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.spacedBy(12.dp),
            modifier = Modifier.weight(1f)
        ) {
            Icon(
                icon,
                contentDescription = null,
                tint = DoziTurquoise,
                modifier = Modifier.size(24.dp)
            )
            Column {
                Text(
                    text = label,
                    style = MaterialTheme.typography.bodyLarge,
                    fontWeight = FontWeight.Medium,
                    color = MaterialTheme.colorScheme.onSurface
                )
                Text(
                    text = description,
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }
        Switch(
            checked = checked,
            onCheckedChange = onCheckedChange,
            colors = SwitchDefaults.colors(
                checkedThumbColor = DoziTurquoise,
                checkedTrackColor = DoziTurquoise.copy(alpha = 0.5f)
            )
        )
    }
}

@Composable
private fun TestNotificationButton() {
    val context = LocalContext.current

    Button(
        onClick = {
            // Bildirim izni kontrol√º
            val hasPermission = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                ContextCompat.checkSelfPermission(
                    context,
                    Manifest.permission.POST_NOTIFICATIONS
                ) == PackageManager.PERMISSION_GRANTED
            } else {
                true // Android 13 altƒ±nda izin gerekmiyor
            }

            if (hasPermission) {
                // Test bildirimi g√∂nder
                try {
                    NotificationHelper.showMedicationNotification(
                        context = context,
                        medicineName = "Lustral",
                        dosage = "100mg",
                        time = "12:00"
                    )
                    Toast.makeText(context, "‚úÖ Test bildirimi g√∂nderildi!", Toast.LENGTH_SHORT).show()
                } catch (e: Exception) {
                    Toast.makeText(context, "‚ùå Hata: ${e.message}", Toast.LENGTH_SHORT).show()
                }
            } else {
                Toast.makeText(
                    context,
                    "‚ö†Ô∏è Bildirim izni verilmemi≈ü. L√ºtfen uygulama ayarlarƒ±ndan izin verin.",
                    Toast.LENGTH_LONG
                ).show()
            }
        },
        modifier = Modifier.fillMaxWidth(),
        colors = ButtonDefaults.buttonColors(
            containerColor = DoziPurple
        ),
        elevation = ButtonDefaults.buttonElevation(defaultElevation = 2.dp)
    ) {
        Row(
            horizontalArrangement = Arrangement.spacedBy(8.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Icon(
                Icons.Default.NotificationsActive,
                contentDescription = null,
                modifier = Modifier.size(20.dp)
            )
            Text(
                "Test Bildirimi G√∂nder",
                fontWeight = FontWeight.Bold
            )
        }
    }
}

// ============================================================================
// FILE: StatsScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/stats/StatsScreen.kt
// [96 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.stats

import android.os.Build
import androidx.annotation.RequiresApi
import androidx.compose.animation.*
import androidx.compose.animation.core.*
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import com.bardino.dozi.core.data.model.UserStats
import com.bardino.dozi.core.data.model.Achievement
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.unit.sp
import androidx.lifecycle.viewmodel.compose.viewModel
import androidx.lifecycle.compose.collectAsStateWithLifecycle
import java.time.LocalDate
import java.time.format.DateTimeFormatter
import java.util.Locale

@RequiresApi(Build.VERSION_CODES.O)
@Composable
fun StatsScreen(
    onNavigateBack: () -> Unit,
    contentPadding: PaddingValues = PaddingValues()
) {
    val viewModel: StatsViewModel = viewModel()
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()

    Scaffold(
        topBar = {
            DoziTopBar(
                title = "ƒ∞statistikler",
                canNavigateBack = false,
                onNavigateBack = onNavigateBack
            )
        },
        containerColor = DoziCharacterLight
    ) { padding ->
        Box(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .padding(contentPadding)
        ) {
            if (uiState.isLoading) {
                // Y√ºkleniyor g√∂stergesi
                Box(
                    modifier = Modifier.fillMaxSize(),
                    contentAlignment = Alignment.Center
                ) {
                    CircularProgressIndicator(color = DoziRed)
                }
            } else {
                Column(
                    modifier = Modifier
                        .fillMaxSize()
                        .verticalScroll(rememberScrollState())
                        .padding(horizontal = 16.dp)
                        .padding(top = 16.dp, bottom = 24.dp),
                    verticalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    // üî• Streak Kartƒ±
                    StreakCard(stats = uiState.stats)

                    // üìä Haftalƒ±k √ñzet
                    WeeklySummaryCard(weeklyData = uiState.weeklyLogs)

                    // üèÜ Ba≈üarƒ±mlar
                    AchievementsCard(achievements = uiState.achievements)

                    // üìà Uyumluluk Oranƒ±
                    ComplianceCard(stats = uiState.stats)
                }
            }
        }
    }
}

@Composable
private fun StreakCard(stats: UserStats?) {
    val currentStreak = stats?.currentStreak ?: 0
    val longestStreak = stats?.longestStreak ?: 0
    val totalMedications = stats?.totalMedicationsTaken ?: 0

    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = Color.White
        ),
        shape = RoundedCornerShape(20.dp),
        elevation = CardDefaults.cardElevation(4.dp)
    ) {
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .background(
                    Brush.verticalGradient(
                        listOf(
                            DoziRed.copy(alpha = 0.08f),
                            WarningOrange.copy(alpha = 0.08f)
                        )
                    )
                )
                .padding(24.dp)
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                modifier = Modifier.fillMaxWidth()
            ) {
                // Flame Icon
                Text(
                    "üî•",
                    style = MaterialTheme.typography.displayLarge.copy(fontSize = 64.sp)
                )
                Spacer(Modifier.height(8.dp))

                // Current Streak
                Text(
                    "$currentStreak",
                    style = MaterialTheme.typography.displayLarge.copy(fontSize = 56.sp),
                    fontWeight = FontWeight.ExtraBold,
                    color = if (currentStreak > 0) DoziRed else MaterialTheme.colorScheme.onSurfaceVariant
                )
                Text(
                    "G√ºnl√ºk Seri",
                    style = MaterialTheme.typography.titleMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant,
                    fontWeight = FontWeight.Medium
                )

                if (currentStreak > 0) {
                    Spacer(Modifier.height(8.dp))
                    Text(
                        "Harika gidiyorsun! üéâ",
                        style = MaterialTheme.typography.bodyMedium,
                        color = DoziTurquoise,
                        fontWeight = FontWeight.SemiBold
                    )
                }

                Spacer(Modifier.height(20.dp))
                HorizontalDivider(
                    color = Gray200,
                    thickness = 1.dp,
                    modifier = Modifier.padding(horizontal = 16.dp)
                )
                Spacer(Modifier.height(20.dp))

                // Stats Row
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceEvenly
                ) {
                    StatItem(
                        label = "En Uzun Seri",
                        value = "$longestStreak",
                        icon = Icons.Default.TrendingUp
                    )
                    StatItem(
                        label = "Toplam Doz",
                        value = "$totalMedications",
                        icon = Icons.Default.Medication
                    )
                }
            }
        }
    }
}

@RequiresApi(Build.VERSION_CODES.O)
@Composable
private fun WeeklySummaryCard(weeklyData: List<DayLog>) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        shape = RoundedCornerShape(20.dp),
        elevation = CardDefaults.cardElevation(4.dp)
    ) {
        Column(
            modifier = Modifier.padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    "üìä Son 7 G√ºn",
                    style = MaterialTheme.typography.titleLarge,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
            }
            Spacer(Modifier.height(8.dp))

            if (weeklyData.isEmpty()) {
                // Bo≈ü durum
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(vertical = 24.dp),
                    horizontalAlignment = Alignment.CenterHorizontally
                ) {
                    Text(
                        "üìÖ",
                        style = MaterialTheme.typography.displayMedium
                    )
                    Spacer(Modifier.height(8.dp))
                    Text(
                        "Hen√ºz veri yok",
                        style = MaterialTheme.typography.bodyLarge,
                        fontWeight = FontWeight.Medium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                    Text(
                        "ƒ∞la√ßlarƒ±nƒ± almaya ba≈üla!",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            } else {
                weeklyData.forEach { day ->
                    WeeklyDayRow(day)
                }
            }
        }
    }
}

@RequiresApi(Build.VERSION_CODES.O)
@Composable
private fun WeeklyDayRow(day: DayLog) {
    val progress = day.progress
    val color = when {
        progress >= 0.9f -> SuccessGreen
        progress >= 0.5f -> WarningOrange
        else -> ErrorRed
    }

    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Column(modifier = Modifier.weight(1f)) {
            Text(
                day.dayName,
                style = MaterialTheme.typography.bodyMedium,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )
            Text(
                day.date,
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }

        Row(
            horizontalArrangement = Arrangement.spacedBy(8.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            LinearProgressIndicator(
                progress = { progress },
                modifier = Modifier
                    .width(100.dp)
                    .height(8.dp)
                    .clip(RoundedCornerShape(4.dp)),
                color = color,
                trackColor = color.copy(alpha = 0.2f)
            )
            Text(
                "${day.taken}/${day.total}",
                style = MaterialTheme.typography.bodyMedium,
                fontWeight = FontWeight.Bold,
                color = color
            )
        }
    }
}

@Composable
private fun AchievementsCard(achievements: List<com.bardino.dozi.core.data.model.Achievement>) {
    val unlockedCount = achievements.count { it.isUnlocked }
    val totalCount = achievements.size

    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        shape = RoundedCornerShape(20.dp),
        elevation = CardDefaults.cardElevation(4.dp)
    ) {
        Column(
            modifier = Modifier.padding(20.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    "üèÜ Ba≈üarƒ±mlar",
                    style = MaterialTheme.typography.titleLarge,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
                Text(
                    "$unlockedCount/$totalCount",
                    style = MaterialTheme.typography.titleMedium,
                    fontWeight = FontWeight.Bold,
                    color = DoziTurquoise
                )
            }

            Spacer(Modifier.height(8.dp))

            if (achievements.isEmpty()) {
                // Hi√ß ba≈üarƒ±m yoksa (y√ºkleniyor veya hata)
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(vertical = 24.dp),
                    horizontalAlignment = Alignment.CenterHorizontally
                ) {
                    CircularProgressIndicator(color = DoziTurquoise, modifier = Modifier.size(48.dp))
                    Spacer(Modifier.height(12.dp))
                    Text(
                        "Ba≈üarƒ±mlar y√ºkleniyor...",
                        style = MaterialTheme.typography.bodyMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            } else {
                // Kategorilere g√∂re grupla
                val streakAchievements = achievements.filter {
                    it.type.name.startsWith("STREAK_")
                }
                val perfectAchievements = achievements.filter {
                    it.type.name.startsWith("PERFECT_")
                }
                val firstStepAchievements = achievements.filter {
                    it.type.name.startsWith("FIRST_")
                }
                val collectorAchievements = achievements.filter {
                    it.type.name.startsWith("MEDICINE_COLLECTOR")
                }
                val doseAchievements = achievements.filter {
                    it.type.name.startsWith("TOTAL_DOSES")
                }

                // üî• Streak Ba≈üarƒ±larƒ±
                if (streakAchievements.isNotEmpty()) {
                    AchievementCategory("üî• Streak Ba≈üarƒ±larƒ±", streakAchievements)
                    Spacer(Modifier.height(8.dp))
                }

                // üéØ M√ºkemmel Uyum
                if (perfectAchievements.isNotEmpty()) {
                    AchievementCategory("üéØ M√ºkemmel Uyum", perfectAchievements)
                    Spacer(Modifier.height(8.dp))
                }

                // üèÖ ƒ∞lk Adƒ±mlar
                if (firstStepAchievements.isNotEmpty()) {
                    AchievementCategory("üèÖ ƒ∞lk Adƒ±mlar", firstStepAchievements)
                    Spacer(Modifier.height(8.dp))
                }

                // üìö Koleksiyoncu
                if (collectorAchievements.isNotEmpty()) {
                    AchievementCategory("üìö Koleksiyoncu", collectorAchievements)
                    Spacer(Modifier.height(8.dp))
                }

                // üíØ Toplam Doz
                if (doseAchievements.isNotEmpty()) {
                    AchievementCategory("üíØ Toplam Doz", doseAchievements)
                }

                if (unlockedCount == 0) {
                    Spacer(Modifier.height(8.dp))
                    Text(
                        "üí™ D√ºzenli ila√ß kullanƒ±mƒ±nƒ± s√ºrd√ºrerek ba≈üarƒ±m kazanabilirsin!",
                        style = MaterialTheme.typography.bodySmall,
                        color = DoziTurquoise,
                        textAlign = TextAlign.Center,
                        modifier = Modifier.fillMaxWidth()
                    )
                }
            }
        }
    }
}

@Composable
private fun AchievementCategory(
    title: String,
    achievements: List<com.bardino.dozi.core.data.model.Achievement>
) {
    Column(verticalArrangement = Arrangement.spacedBy(8.dp)) {
        Text(
            title,
            style = MaterialTheme.typography.titleSmall,
            fontWeight = FontWeight.SemiBold,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
        achievements.forEach { achievement ->
            AchievementItemWithProgress(achievement)
        }
    }
}

@Composable
private fun AchievementItemWithProgress(achievement: com.bardino.dozi.core.data.model.Achievement) {
    val progressPercentage = achievement.type.getProgressPercentage(achievement.progress)
    val color = try {
        Color(android.graphics.Color.parseColor(achievement.type.color))
    } catch (e: Exception) {
        DoziTurquoise
    }

    Surface(
        modifier = Modifier.fillMaxWidth(),
        color = if (achievement.isUnlocked) color.copy(alpha = 0.1f) else Gray200.copy(alpha = 0.3f),
        shape = RoundedCornerShape(12.dp)
    ) {
        Column(
            modifier = Modifier.padding(12.dp),
            verticalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            Row(
                horizontalArrangement = Arrangement.spacedBy(12.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                // Emoji Icon
                Text(
                    achievement.type.emoji,
                    style = MaterialTheme.typography.headlineMedium,
                    modifier = Modifier
                        .size(48.dp)
                        .clip(CircleShape)
                        .background(if (achievement.isUnlocked) color.copy(alpha = 0.2f) else Gray200.copy(alpha = 0.5f))
                        .wrapContentSize(Alignment.Center),
                    fontSize = 24.sp
                )

                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        achievement.type.displayName,
                        style = MaterialTheme.typography.titleSmall,
                        fontWeight = FontWeight.Bold,
                        color = if (achievement.isUnlocked) MaterialTheme.colorScheme.onSurface else MaterialTheme.colorScheme.onSurfaceVariant
                    )
                    Text(
                        achievement.type.description,
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant,
                        fontSize = 12.sp
                    )
                }

                if (achievement.isUnlocked) {
                    Icon(
                        Icons.Default.CheckCircle,
                        contentDescription = "Unlocked",
                        tint = SuccessGreen,
                        modifier = Modifier.size(24.dp)
                    )
                } else {
                    Icon(
                        Icons.Default.Lock,
                        contentDescription = "Locked",
                        tint = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.5f),
                        modifier = Modifier.size(20.dp)
                    )
                }
            }

            // Progress Bar
            if (!achievement.isUnlocked && achievement.target > 0) {
                Column(verticalArrangement = Arrangement.spacedBy(4.dp)) {
                    Row(
                        modifier = Modifier.fillMaxWidth(),
                        horizontalArrangement = Arrangement.SpaceBetween
                    ) {
                        Text(
                            "${achievement.progress} / ${achievement.target}",
                            style = MaterialTheme.typography.labelSmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant,
                            fontSize = 11.sp
                        )
                        Text(
                            "${progressPercentage.toInt()}%",
                            style = MaterialTheme.typography.labelSmall,
                            fontWeight = FontWeight.Bold,
                            color = color,
                            fontSize = 11.sp
                        )
                    }
                    LinearProgressIndicator(
                        progress = progressPercentage / 100f,
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(6.dp)
                            .clip(RoundedCornerShape(3.dp)),
                        color = color,
                        trackColor = Gray200.copy(alpha = 0.3f)
                    )
                }
            }
        }
    }
}

@Composable
private fun AchievementItem(
    title: String,
    description: String,
    icon: String,
    isUnlocked: Boolean
) {
    Surface(
        modifier = Modifier.fillMaxWidth(),
        color = if (isUnlocked) DoziTurquoise.copy(alpha = 0.1f) else Gray200.copy(alpha = 0.3f),
        shape = RoundedCornerShape(12.dp)
    ) {
        Row(
            modifier = Modifier.padding(12.dp),
            horizontalArrangement = Arrangement.spacedBy(12.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                icon,
                style = MaterialTheme.typography.headlineMedium,
                modifier = Modifier
                    .size(48.dp)
                    .clip(CircleShape)
                    .background(if (isUnlocked) DoziTurquoise.copy(alpha = 0.2f) else Gray200.copy(alpha = 0.5f))
                    .padding(8.dp)
            )
            Column(modifier = Modifier.weight(1f)) {
                Text(
                    title,
                    style = MaterialTheme.typography.titleSmall,
                    fontWeight = FontWeight.Bold,
                    color = if (isUnlocked) MaterialTheme.colorScheme.onSurface else MaterialTheme.colorScheme.onSurfaceVariant
                )
                Text(
                    description,
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
            if (isUnlocked) {
                Icon(
                    Icons.Default.CheckCircle,
                    contentDescription = "Unlocked",
                    tint = SuccessGreen,
                    modifier = Modifier.size(24.dp)
                )
            }
        }
    }
}

@Composable
private fun ComplianceCard(stats: UserStats?) {
    val complianceRate = stats?.complianceRate ?: 0f
    val color = when {
        complianceRate >= 90f -> SuccessGreen
        complianceRate >= 70f -> WarningOrange
        else -> ErrorRed
    }

    val encouragementText = when {
        complianceRate >= 90f -> "M√ºkemmel! üåü"
        complianceRate >= 70f -> "ƒ∞yi gidiyorsun! üí™"
        complianceRate >= 50f -> "Devam et! üéØ"
        complianceRate > 0f -> "Ba≈ülangƒ±√ß g√ºzel! üöÄ"
        else -> "Haydi ba≈üla! üå±"
    }

    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(containerColor = Color.White),
        shape = RoundedCornerShape(20.dp),
        elevation = CardDefaults.cardElevation(4.dp)
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(24.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Text(
                "üìà Uyumluluk Oranƒ±",
                style = MaterialTheme.typography.titleLarge,
                fontWeight = FontWeight.Bold,
                color = MaterialTheme.colorScheme.onSurface
            )
            Spacer(Modifier.height(24.dp))

            // Circular Progress
            Box(
                contentAlignment = Alignment.Center,
                modifier = Modifier.size(140.dp)
            ) {
                CircularProgressIndicator(
                    progress = { complianceRate / 100f },
                    modifier = Modifier.fillMaxSize(),
                    color = color,
                    strokeWidth = 14.dp,
                    trackColor = color.copy(alpha = 0.15f)
                )
                Column(
                    horizontalAlignment = Alignment.CenterHorizontally
                ) {
                    Text(
                        "${complianceRate.toInt()}%",
                        style = MaterialTheme.typography.displayMedium,
                        fontWeight = FontWeight.ExtraBold,
                        color = color
                    )
                }
            }

            Spacer(Modifier.height(16.dp))
            Text(
                encouragementText,
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.SemiBold,
                color = color
            )
            Spacer(Modifier.height(8.dp))
            Text(
                "Son 30 g√ºnl√ºk ortalama",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
}

@Composable
private fun StatItem(
    label: String,
    value: String,
    icon: androidx.compose.ui.graphics.vector.ImageVector
) {
    Column(
        horizontalAlignment = Alignment.CenterHorizontally,
        modifier = Modifier.padding(horizontal = 8.dp)
    ) {
        Icon(
            icon,
            contentDescription = null,
            tint = DoziTurquoise,
            modifier = Modifier.size(28.dp)
        )
        Spacer(Modifier.height(8.dp))
        Text(
            value,
            style = MaterialTheme.typography.headlineMedium,
            fontWeight = FontWeight.ExtraBold,
            color = MaterialTheme.colorScheme.onSurface
        )
        Spacer(Modifier.height(2.dp))
        Text(
            label,
            style = MaterialTheme.typography.bodySmall,
            color = MaterialTheme.colorScheme.onSurfaceVariant,
            textAlign = TextAlign.Center,
            fontWeight = FontWeight.Medium
        )
    }
}

/**
 * G√ºnl√ºk veri modeli
 */
@RequiresApi(Build.VERSION_CODES.O)
data class DayLog(
    val date: String,
    val dayName: String,
    val taken: Int,
    val total: Int
) {
    val progress: Float
        get() = if (total > 0) taken.toFloat() / total else 0f
}

// ============================================================================
// FILE: StatsViewModel.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/stats/StatsViewModel.kt
// [97 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.stats

import android.app.Application
import android.os.Build
import androidx.annotation.RequiresApi
import androidx.lifecycle.AndroidViewModel
import androidx.lifecycle.viewModelScope
import com.bardino.dozi.core.data.model.UserStats
import com.bardino.dozi.core.data.model.Achievement
import com.bardino.dozi.core.data.repository.UserStatsRepository
import com.bardino.dozi.core.data.repository.MedicationLogRepository
import com.bardino.dozi.core.data.repository.AchievementRepository
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.flow.update
import kotlinx.coroutines.launch
import java.time.LocalDate
import java.time.format.DateTimeFormatter
import java.time.format.TextStyle
import java.util.Locale

@RequiresApi(Build.VERSION_CODES.O)
class StatsViewModel(application: Application) : AndroidViewModel(application) {

    data class StatsUiState(
        val stats: UserStats? = null,
        val weeklyLogs: List<DayLog> = emptyList(),
        val achievements: List<Achievement> = emptyList(),
        val isLoading: Boolean = true
    )

    private val _uiState = MutableStateFlow(StatsUiState())
    val uiState: StateFlow<StatsUiState> = _uiState.asStateFlow()

    private val achievementRepository = AchievementRepository()
    private val medicationLogRepository = MedicationLogRepository(application)
    private val userStatsRepository = UserStatsRepository(achievementRepository)

    init {
        loadStats()
    }

    private fun loadStats() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }

            // UserStats y√ºkle
            val stats = userStatsRepository.getUserStats()

            // Haftalƒ±k ger√ßek veriyi Firestore'dan √ßek
            val weeklyLogs = loadWeeklyLogs()

            // üèÜ Ba≈üarƒ±larƒ± y√ºkle
            val achievements = achievementRepository.getAllAchievements()

            _uiState.update {
                it.copy(
                    stats = stats,
                    weeklyLogs = weeklyLogs,
                    achievements = achievements,
                    isLoading = false
                )
            }
        }
    }

    /**
     * Firestore'dan ger√ßek haftalƒ±k ila√ß loglarƒ±nƒ± √ßek
     */
    private suspend fun loadWeeklyLogs(): List<DayLog> {
        val dateFormatter = DateTimeFormatter.ofPattern("dd MMM", Locale("tr"))

        // Firestore'dan son 7 g√ºn√ºn verilerini al
        val dailyLogs = medicationLogRepository.getWeeklyMedicationLogs()

        // DailyMedicationLogs'u DayLog'a d√∂n√º≈üt√ºr
        return dailyLogs.reversed().map { dailyLog ->
            // Tarih string'ini parse et
            val localDate = LocalDate.parse(dailyLog.date)
            val dayName = localDate.dayOfWeek.getDisplayName(TextStyle.SHORT, Locale("tr"))
            val dateStr = localDate.format(dateFormatter)

            DayLog(
                date = dateStr,
                dayName = dayName,
                taken = dailyLog.takenCount,
                total = dailyLog.totalCount
            )
        }
    }

    /**
     * ƒ∞statistikleri yenile
     */
    fun refresh() {
        loadStats()
    }
}

// ============================================================================
// FILE: SupportScreen.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/ui/screens/support/SupportScreen.kt
// [98 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.screens.support

import android.content.Intent
import android.net.Uri
import androidx.compose.animation.AnimatedVisibility
import androidx.compose.animation.expandVertically
import androidx.compose.animation.shrinkVertically
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import com.bardino.dozi.core.data.model.FAQ
import com.bardino.dozi.core.data.repository.FAQRepository
import com.bardino.dozi.core.ui.components.DoziTopBar
import com.bardino.dozi.core.ui.theme.*
import kotlinx.coroutines.launch

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun SupportScreen(
    onNavigateBack: () -> Unit
) {
    val context = LocalContext.current
    val scope = rememberCoroutineScope()
    val faqRepository = remember { FAQRepository() }

    var faqs by remember { mutableStateOf<List<FAQ>>(emptyList()) }
    var isLoading by remember { mutableStateOf(true) }
    var searchQuery by remember { mutableStateOf("") }
    var expandedFaqId by remember { mutableStateOf<String?>(null) }

    // SSS'leri yukle
    LaunchedEffect(Unit) {
        scope.launch {
            faqs = faqRepository.getAllFAQs()
            isLoading = false
        }
    }

    // Arama sonuclari
    val filteredFaqs = remember(faqs, searchQuery) {
        if (searchQuery.isBlank()) {
            faqs
        } else {
            val query = searchQuery.lowercase()
            faqs.filter { faq ->
                faq.question.lowercase().contains(query) ||
                faq.answer.lowercase().contains(query)
            }
        }
    }

    // Kategoriye gore grupla
    val groupedFaqs = remember(filteredFaqs) {
        filteredFaqs.groupBy { it.category }
    }

    Scaffold(
        topBar = {
            DoziTopBar(
                title = "Destek",
                canNavigateBack = true,
                onNavigateBack = onNavigateBack
            )
        },
        containerColor = BackgroundLight
    ) { padding ->
        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding),
            contentPadding = PaddingValues(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // Arama Alani
            item {
                OutlinedTextField(
                    value = searchQuery,
                    onValueChange = { searchQuery = it },
                    modifier = Modifier.fillMaxWidth(),
                    placeholder = { Text("Soru ara...") },
                    leadingIcon = {
                        Icon(
                            Icons.Default.Search,
                            contentDescription = null,
                            tint = DoziTurquoise
                        )
                    },
                    trailingIcon = {
                        if (searchQuery.isNotEmpty()) {
                            IconButton(onClick = { searchQuery = "" }) {
                                Icon(Icons.Default.Clear, contentDescription = "Temizle")
                            }
                        }
                    },
                    shape = RoundedCornerShape(12.dp),
                    colors = OutlinedTextFieldDefaults.colors(
                        focusedBorderColor = DoziTurquoise,
                        unfocusedBorderColor = Color.LightGray
                    ),
                    singleLine = true
                )
            }

            // Iletisim Karti
            item {
                ContactCard(
                    onEmailClick = {
                        val intent = Intent(Intent.ACTION_SENDTO).apply {
                            data = Uri.parse("mailto:info@dozi.app")
                            putExtra(Intent.EXTRA_SUBJECT, "Dozi Destek Talebi")
                        }
                        context.startActivity(intent)
                    }
                )
            }

            // Yukleniyor
            if (isLoading) {
                item {
                    Box(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(32.dp),
                        contentAlignment = Alignment.Center
                    ) {
                        CircularProgressIndicator(color = DoziTurquoise)
                    }
                }
            }

            // SSS Bos
            if (!isLoading && filteredFaqs.isEmpty()) {
                item {
                    Box(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(32.dp),
                        contentAlignment = Alignment.Center
                    ) {
                        Column(
                            horizontalAlignment = Alignment.CenterHorizontally,
                            verticalArrangement = Arrangement.spacedBy(8.dp)
                        ) {
                            Icon(
                                Icons.Default.SearchOff,
                                contentDescription = null,
                                modifier = Modifier.size(48.dp),
                                tint = Color.Gray
                            )
                            Text(
                                text = if (searchQuery.isNotEmpty())
                                    "Aramanizla eslesen soru bulunamadi"
                                else
                                    "Henuz soru eklenmemis",
                                color = Color.Gray,
                                textAlign = TextAlign.Center
                            )
                        }
                    }
                }
            }

            // SSS Listesi (Kategoriye gore)
            groupedFaqs.forEach { (category, categoryFaqs) ->
                // Kategori Basligi
                item {
                    Text(
                        text = category,
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold,
                        color = DoziTurquoiseDark,
                        modifier = Modifier.padding(top = 8.dp, bottom = 4.dp)
                    )
                }

                // Kategori Sorulari
                items(categoryFaqs, key = { it.id }) { faq ->
                    FAQItem(
                        faq = faq,
                        isExpanded = expandedFaqId == faq.id,
                        onToggle = {
                            expandedFaqId = if (expandedFaqId == faq.id) null else faq.id
                        }
                    )
                }
            }

            // Alt bosluk
            item {
                Spacer(modifier = Modifier.height(16.dp))
            }
        }
    }
}

@Composable
private fun ContactCard(
    onEmailClick: () -> Unit
) {
    Surface(
        modifier = Modifier.fillMaxWidth(),
        shape = RoundedCornerShape(16.dp),
        color = DoziTurquoise.copy(alpha = 0.1f)
    ) {
        Column(
            modifier = Modifier.padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(12.dp)
        ) {
            Row(
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Icon(
                    Icons.Default.SupportAgent,
                    contentDescription = null,
                    tint = DoziTurquoise,
                    modifier = Modifier.size(24.dp)
                )
                Text(
                    text = "Bize Ulasin",
                    style = MaterialTheme.typography.titleMedium,
                    fontWeight = FontWeight.Bold,
                    color = DoziTurquoiseDark
                )
            }

            Text(
                text = "Sorunuz listede yoksa bize e-posta gonderin. En kisa surede donecegiz.",
                style = MaterialTheme.typography.bodyMedium,
                color = Color.DarkGray
            )

            Button(
                onClick = onEmailClick,
                modifier = Modifier.fillMaxWidth(),
                shape = RoundedCornerShape(12.dp),
                colors = ButtonDefaults.buttonColors(
                    containerColor = DoziTurquoise
                )
            ) {
                Icon(
                    Icons.Default.Email,
                    contentDescription = null,
                    modifier = Modifier.size(18.dp)
                )
                Spacer(modifier = Modifier.width(8.dp))
                Text("info@dozi.app")
            }
        }
    }
}

@Composable
private fun FAQItem(
    faq: FAQ,
    isExpanded: Boolean,
    onToggle: () -> Unit
) {
    Surface(
        modifier = Modifier
            .fillMaxWidth()
            .clip(RoundedCornerShape(12.dp))
            .clickable { onToggle() },
        shape = RoundedCornerShape(12.dp),
        color = Color.White,
        tonalElevation = 1.dp
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = faq.question,
                    style = MaterialTheme.typography.bodyLarge,
                    fontWeight = FontWeight.Medium,
                    modifier = Modifier.weight(1f),
                    color = if (isExpanded) DoziTurquoise else Color.Black
                )
                Icon(
                    imageVector = if (isExpanded) Icons.Default.ExpandLess else Icons.Default.ExpandMore,
                    contentDescription = if (isExpanded) "Kapat" else "Ac",
                    tint = DoziTurquoise
                )
            }

            AnimatedVisibility(
                visible = isExpanded,
                enter = expandVertically(),
                exit = shrinkVertically()
            ) {
                Column {
                    Spacer(modifier = Modifier.height(12.dp))
                    Divider(color = Color.LightGray.copy(alpha = 0.5f))
                    Spacer(modifier = Modifier.height(12.dp))
                    Text(
                        text = faq.answer,
                        style = MaterialTheme.typography.bodyMedium,
                        color = Color.DarkGray,
                        lineHeight = MaterialTheme.typography.bodyMedium.lineHeight * 1.4
                    )
                }
            }
        }
    }
}

// ============================================================================
// FILE: EscalationManager.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/utils/EscalationManager.kt
// [99 of 122]
// ============================================================================

package com.bardino.dozi.core.utils

import android.content.Context
import android.util.Log
import com.bardino.dozi.core.data.model.*
import com.bardino.dozi.core.data.repository.BadiRepository
import com.bardino.dozi.core.data.repository.MedicationLogRepository
import com.bardino.dozi.core.data.repository.MedicineRepository
import com.bardino.dozi.core.data.repository.NotificationRepository
import com.google.firebase.auth.FirebaseAuth
import kotlinx.coroutines.flow.first
import java.util.Calendar

/**
 * üö® Escalation Manager
 * Kritik ila√ßlarƒ±n ka√ßƒ±rƒ±lmasƒ± durumunda badilere bildirim g√∂nderir
 */
class EscalationManager(
    private val context: Context
) {
    private val medicineRepository = MedicineRepository()
    private val medicationLogRepository = MedicationLogRepository(
        context,
        com.google.firebase.auth.FirebaseAuth.getInstance(),
        com.google.firebase.firestore.FirebaseFirestore.getInstance()
    )
    private val badiRepository = BadiRepository()
    private val notificationRepository = NotificationRepository()

    companion object {
        private const val TAG = "EscalationManager"
        private const val CRITICAL_MISSED_THRESHOLD = 2  // 2+ kritik ila√ß ka√ßƒ±rƒ±ldƒ±ysa escalate et
        private const val HOURS_TO_CHECK = 24  // Son 24 saati kontrol et
    }

    /**
     * Kritik ila√ßlarƒ±n ka√ßƒ±rƒ±lƒ±p ka√ßƒ±rƒ±lmadƒ±ƒüƒ±nƒ± kontrol et
     * Eƒüer CRITICAL_MISSED_THRESHOLD kadar kritik ila√ß ka√ßƒ±rƒ±ldƒ±ysa badilere bildir
     */
    suspend fun checkAndEscalate() {
        try {
            val userId = FirebaseAuth.getInstance().currentUser?.uid ?: return

            // Kullanƒ±cƒ±nƒ±n t√ºm ila√ßlarƒ±nƒ± √ßek
            val medicines = medicineRepository.getMedicinesFlow().first()

            // Kritik ila√ßlarƒ± filtrele
            val criticalMedicines = medicines.filter {
                it.criticalityLevel == MedicineCriticality.CRITICAL
            }

            if (criticalMedicines.isEmpty()) {
                Log.d(TAG, "No critical medicines found")
                return
            }

            // Son 24 saatteki missed kritik ila√ßlarƒ± kontrol et
            val missedCriticalCount = countMissedCriticalMedicines(criticalMedicines)

            Log.d(TAG, "Missed critical medicines count: $missedCriticalCount")

            if (missedCriticalCount >= CRITICAL_MISSED_THRESHOLD) {
                // üö® Escalate! Badilere bildirim g√∂nder
                notifyBuddiesAboutMissedCriticalMedicines(
                    userId,
                    missedCriticalCount,
                    criticalMedicines.map { it.name }
                )
            }
        } catch (e: Exception) {
            Log.e(TAG, "Error checking escalation", e)
        }
    }

    /**
     * Son 24 saatte ka√ßƒ±rƒ±lan kritik ila√ß sayƒ±sƒ±nƒ± hesapla
     */
    private suspend fun countMissedCriticalMedicines(criticalMedicines: List<Medicine>): Int {
        var missedCount = 0

        // Son 24 saati hesapla
        val startTime = Calendar.getInstance().apply {
            add(Calendar.HOUR_OF_DAY, -HOURS_TO_CHECK)
        }.timeInMillis

        for (medicine in criticalMedicines) {
            // ƒ∞lacƒ±n loglarƒ±nƒ± kontrol et
            val logs = medicationLogRepository.getLogsForMedicine(medicine.id, startTime)
            val missedLogs = logs.filter { it.status == MedicationStatus.MISSED }
            missedCount += missedLogs.size
        }

        return missedCount
    }

    /**
     * Badilere kritik ila√ß ka√ßƒ±rƒ±lmasƒ± hakkƒ±nda bildirim g√∂nder
     */
    private suspend fun notifyBuddiesAboutMissedCriticalMedicines(
        userId: String,
        missedCount: Int,
        medicineNames: List<String>
    ) {
        try {
            // Aktif badileri √ßek
            val badis = badiRepository.getBadisFlow().first()

            // Notification almak isteyen badileri filtrele
            // üî• FIX: Self-buddy ve duplicate kontrol√º ekle
            val notifiableBuddies = badis
                .filter {
                    it.badi.notificationPreferences.onMedicationMissed &&
                    it.badi.permissions.canReceiveNotifications &&
                    it.badi.buddyUserId != userId // Self-buddy kontrol√º
                }
                .distinctBy { it.badi.buddyUserId } // Duplicate kontrol√º

            if (notifiableBuddies.isEmpty()) {
                Log.d(TAG, "No badis to notify")
                return
            }

            // Her badi i√ßin bildirim olu≈ütur
            for (badiWithUser in notifiableBuddies) {
                val notification = DoziNotification(
                    userId = badiWithUser.badi.buddyUserId,
                    type = NotificationType.CRITICAL_MEDICATION_MISSED,
                    title = "üö® Kritik ƒ∞la√ß Uyarƒ±sƒ±",
                    body = "${badiWithUser.badi.nickname ?: badiWithUser.user.name} son 24 saatte $missedCount kritik ila√ß ka√ßƒ±rdƒ±!",
                    data = mapOf(
                        "fromUserId" to userId,
                        "missedCount" to missedCount.toString(),
                        "medicines" to medicineNames.joinToString(", ")
                    ),
                    actionUrl = "badi_medication_tracking/$userId",
                    priority = NotificationPriority.HIGH
                )

                notificationRepository.createNotification(notification)
                Log.d(TAG, "Escalation notification sent to buddy: ${badiWithUser.badi.buddyUserId}")
            }

            Log.d(TAG, "üö® Escalation notifications sent to ${notifiableBuddies.size} badis")
        } catch (e: Exception) {
            Log.e(TAG, "Error notifying badis", e)
        }
    }

    /**
     * Tek bir kritik ila√ß ka√ßƒ±rƒ±ldƒ±ƒüƒ±nda hemen badilere bildir
     */
    suspend fun notifyBuddiesForSingleCriticalMedicine(medicine: Medicine) {
        if (medicine.criticalityLevel != MedicineCriticality.CRITICAL) {
            return
        }

        try {
            val userId = FirebaseAuth.getInstance().currentUser?.uid ?: return

            // Aktif badileri √ßek
            val badis = badiRepository.getBadisFlow().first()

            // Notification almak isteyen badileri filtrele
            // üî• FIX: Self-buddy ve duplicate kontrol√º ekle
            val notifiableBuddies = badis
                .filter {
                    it.badi.notificationPreferences.onMedicationMissed &&
                    it.badi.permissions.canReceiveNotifications &&
                    it.badi.buddyUserId != userId // Self-buddy kontrol√º
                }
                .distinctBy { it.badi.buddyUserId } // Duplicate kontrol√º

            if (notifiableBuddies.isEmpty()) {
                return
            }

            // Her badi i√ßin bildirim olu≈ütur
            for (badiWithUser in notifiableBuddies) {
                val notification = DoziNotification(
                    userId = badiWithUser.badi.buddyUserId,
                    type = NotificationType.MEDICATION_MISSED,
                    title = "‚ö†Ô∏è Kritik ƒ∞la√ß Ka√ßƒ±rƒ±ldƒ±",
                    body = "${badiWithUser.badi.nickname ?: badiWithUser.user.name} ${medicine.name} ilacƒ±nƒ± ka√ßƒ±rdƒ±!",
                    data = mapOf(
                        "fromUserId" to userId,
                        "medicineId" to medicine.id,
                        "medicineName" to medicine.name,
                        "criticality" to "CRITICAL"
                    ),
                    actionUrl = "badi_medication_tracking/$userId",
                    priority = NotificationPriority.HIGH
                )

                notificationRepository.createNotification(notification)
            }

            Log.d(TAG, "‚úÖ Critical medicine missed notification sent to ${notifiableBuddies.size} badis")
        } catch (e: Exception) {
            Log.e(TAG, "Error notifying badis for single critical medicine", e)
        }
    }
}

// ============================================================================
// FILE: FamilyPlanTestHelper.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/utils/FamilyPlanTestHelper.kt
// [100 of 122]
// ============================================================================

package com.bardino.dozi.core.utils

import android.content.Context
import android.widget.Toast
import com.bardino.dozi.core.data.repository.FamilyPlanRepository
import com.google.firebase.Timestamp
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import java.util.Calendar

/**
 * üß™ Aile Paketi Test Helper
 *
 * Test i√ßin bir kullanƒ±cƒ±yƒ± aile paketi sahibi yapma
 *
 * Kullanƒ±m:
 * ```kotlin
 * FamilyPlanTestHelper.createTestFamilyPlan(context) { invitationCode ->
 *     // Davet kodu kullanƒ±ma hazƒ±r: ABC123
 * }
 * ```
 */
object FamilyPlanTestHelper {

    /**
     * Test aile planƒ± olu≈ütur (1 yƒ±l ge√ßerli)
     *
     * @param context Context
     * @param onCodeReady Davet kodu hazƒ±r olduƒüunda callback
     */
    fun createTestFamilyPlan(
        context: Context,
        onCodeReady: (String) -> Unit = {}
    ) {
        val repository = FamilyPlanRepository()

        CoroutineScope(Dispatchers.IO).launch {
            try {
                // 1 yƒ±l sonra bitecek ≈üekilde expiry date
                val calendar = Calendar.getInstance()
                calendar.add(Calendar.YEAR, 1)
                val expiryDate = Timestamp(calendar.time)

                // Aile planƒ± olu≈ütur
                val result = repository.createFamilyPlan(expiryDate)

                withContext(Dispatchers.Main) {
                    result.onSuccess { familyPlan ->
                        val message = """
                            ‚úÖ Aile Paketi Aktif!

                            üìù Plan ID: ${familyPlan.id}
                            üéüÔ∏è Davet Kodu: ${familyPlan.invitationCode}
                            üë§ Organizat√∂r: ${familyPlan.organizerName}
                            üìß Email: ${familyPlan.organizerEmail}
                            üë• Max √úye: ${familyPlan.maxMembers}
                            üìÖ Biti≈ü: ${familyPlan.expiresAt?.toDate()}

                            Davet kodu ile maksimum 3 ki≈üi katƒ±labilir!
                        """.trimIndent()

                        Toast.makeText(context, "‚úÖ Aile paketi olu≈üturuldu!", Toast.LENGTH_LONG).show()
                        android.util.Log.d("FamilyPlanTest", message)

                        onCodeReady(familyPlan.invitationCode)
                    }

                    result.onFailure { error ->
                        Toast.makeText(context, "‚ùå Hata: ${error.message}", Toast.LENGTH_LONG).show()
                        android.util.Log.e("FamilyPlanTest", "‚ùå Aile planƒ± olu≈üturulamadƒ±", error)
                    }
                }
            } catch (e: Exception) {
                withContext(Dispatchers.Main) {
                    Toast.makeText(context, "‚ùå Hata: ${e.message}", Toast.LENGTH_LONG).show()
                    android.util.Log.e("FamilyPlanTest", "‚ùå Exception", e)
                }
            }
        }
    }

    /**
     * Aile planƒ± bilgilerini g√∂ster
     */
    fun showFamilyPlanInfo(context: Context) {
        val repository = FamilyPlanRepository()

        CoroutineScope(Dispatchers.IO).launch {
            try {
                val result = repository.getUserFamilyPlan()

                withContext(Dispatchers.Main) {
                    result.onSuccess { familyPlan ->
                        if (familyPlan == null) {
                            Toast.makeText(context, "‚ÑπÔ∏è Aile planƒ±nƒ±z yok", Toast.LENGTH_SHORT).show()
                            android.util.Log.d("FamilyPlanTest", "‚ÑπÔ∏è Kullanƒ±cƒ±nƒ±n aile planƒ± yok")
                        } else {
                            val message = """
                                üìã Aile Planƒ± Bilgileri:

                                üéüÔ∏è Davet Kodu: ${familyPlan.invitationCode}
                                üë§ Organizat√∂r: ${familyPlan.organizerName}
                                üë• √úye Sayƒ±sƒ±: ${familyPlan.currentMembers.size}/${familyPlan.maxMembers}
                                üìÖ Durum: ${familyPlan.status}
                                üïí Biti≈ü: ${familyPlan.expiresAt?.toDate()}
                            """.trimIndent()

                            Toast.makeText(context, "‚úÖ Aile planƒ± aktif!", Toast.LENGTH_LONG).show()
                            android.util.Log.d("FamilyPlanTest", message)
                        }
                    }

                    result.onFailure { error ->
                        Toast.makeText(context, "‚ùå Hata: ${error.message}", Toast.LENGTH_SHORT).show()
                        android.util.Log.e("FamilyPlanTest", "‚ùå Bilgi alƒ±namadƒ±", error)
                    }
                }
            } catch (e: Exception) {
                withContext(Dispatchers.Main) {
                    Toast.makeText(context, "‚ùå Hata: ${e.message}", Toast.LENGTH_LONG).show()
                    android.util.Log.e("FamilyPlanTest", "‚ùå Exception", e)
                }
            }
        }
    }

    /**
     * Davet kodu ile katƒ±l (test i√ßin)
     */
    fun joinWithCode(context: Context, invitationCode: String) {
        val repository = FamilyPlanRepository()

        CoroutineScope(Dispatchers.IO).launch {
            try {
                val result = repository.joinFamilyPlan(invitationCode)

                withContext(Dispatchers.Main) {
                    result.onSuccess { familyPlan ->
                        Toast.makeText(context, "‚úÖ Aile planƒ±na katƒ±ldƒ±nƒ±z!", Toast.LENGTH_LONG).show()
                        android.util.Log.d("FamilyPlanTest", "‚úÖ Katƒ±lƒ±m ba≈üarƒ±lƒ±: ${familyPlan.id}")
                    }

                    result.onFailure { error ->
                        Toast.makeText(context, "‚ùå ${error.message}", Toast.LENGTH_LONG).show()
                        android.util.Log.e("FamilyPlanTest", "‚ùå Katƒ±lƒ±m hatasƒ±", error)
                    }
                }
            } catch (e: Exception) {
                withContext(Dispatchers.Main) {
                    Toast.makeText(context, "‚ùå Hata: ${e.message}", Toast.LENGTH_LONG).show()
                    android.util.Log.e("FamilyPlanTest", "‚ùå Exception", e)
                }
            }
        }
    }
}

// ============================================================================
// FILE: MedicationStatusHelper.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/utils/MedicationStatusHelper.kt
// [101 of 122]
// ============================================================================

package com.bardino.dozi.core.utils

import android.content.Context
import android.util.Log

/**
 * ƒ∞la√ß durumu kaydetme ve okuma yardƒ±mcƒ± fonksiyonlarƒ±
 * SharedPreferences kullanarak doz durumlarƒ±nƒ± saklar
 */
object MedicationStatusHelper {

    private const val PREFS_NAME = "medicine_status"
    private const val TAG = "MedicationStatusHelper"

    /**
     * ƒ∞la√ß durumunu kaydet
     */
    fun saveMedicineStatus(
        context: Context,
        medicineId: String,
        date: String,
        time: String,
        status: String
    ) {
        val prefs = context.getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE)
        val key = "dose_${medicineId}_${date}_${time}"
        prefs.edit().putString(key, status).commit() // commit() senkron, hemen kaydet
        Log.d(TAG, "Status saved: $key = $status")
    }

    /**
     * ƒ∞la√ß durumunu oku
     */
    fun getMedicineStatus(
        context: Context,
        medicineId: String,
        date: String,
        time: String
    ): String? {
        val prefs = context.getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE)
        val key = "dose_${medicineId}_${date}_${time}"
        return prefs.getString(key, null)
    }

    /**
     * Bug√ºn√ºn tarihini string olarak al
     */
    fun getCurrentDateString(): String {
        val calendar = java.util.Calendar.getInstance()
        val day = calendar.get(java.util.Calendar.DAY_OF_MONTH)
        val month = calendar.get(java.util.Calendar.MONTH) + 1
        val year = calendar.get(java.util.Calendar.YEAR)
        return "%02d/%02d/%d".format(day, month, year)
    }
}

// Top-level extension fonksiyonlarƒ± (backward compatibility i√ßin)
fun saveMedicineStatus(context: Context, medicineId: String, date: String, time: String, status: String) {
    MedicationStatusHelper.saveMedicineStatus(context, medicineId, date, time, status)
}

fun getMedicineStatus(context: Context, medicineId: String, date: String, time: String): String? {
    return MedicationStatusHelper.getMedicineStatus(context, medicineId, date, time)
}

fun getCurrentDateString(): String {
    return MedicationStatusHelper.getCurrentDateString()
}

// ============================================================================
// FILE: NetworkUtils.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/utils/NetworkUtils.kt
// [102 of 122]
// ============================================================================

package com.bardino.dozi.core.utils

import android.content.Context
import android.net.ConnectivityManager
import android.net.NetworkCapabilities
import android.os.Build

/**
 * Network connectivity utilities for offline-first approach
 */
object NetworkUtils {

    /**
     * Check if network is available
     */
    fun isNetworkAvailable(context: Context): Boolean {
        val connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE) as ConnectivityManager

        return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            val network = connectivityManager.activeNetwork ?: return false
            val capabilities = connectivityManager.getNetworkCapabilities(network) ?: return false

            capabilities.hasCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET) &&
                    capabilities.hasCapability(NetworkCapabilities.NET_CAPABILITY_VALIDATED)
        } else {
            @Suppress("DEPRECATION")
            val networkInfo = connectivityManager.activeNetworkInfo
            networkInfo?.isConnected == true
        }
    }

    /**
     * Check if we have a fast network connection (WiFi or 4G+)
     */
    fun hasFastNetwork(context: Context): Boolean {
        val connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE) as ConnectivityManager

        return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            val network = connectivityManager.activeNetwork ?: return false
            val capabilities = connectivityManager.getNetworkCapabilities(network) ?: return false

            capabilities.hasTransport(NetworkCapabilities.TRANSPORT_WIFI) ||
                    capabilities.hasTransport(NetworkCapabilities.TRANSPORT_CELLULAR)
        } else {
            @Suppress("DEPRECATION")
            val networkInfo = connectivityManager.activeNetworkInfo
            networkInfo?.isConnected == true &&
                    (networkInfo.type == ConnectivityManager.TYPE_WIFI ||
                     networkInfo.type == ConnectivityManager.TYPE_MOBILE)
        }
    }
}

// ============================================================================
// FILE: SoundHelper.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/utils/SoundHelper.kt
// [103 of 122]
// ============================================================================

package com.bardino.dozi.core.utils

import android.content.Context
import android.media.MediaPlayer
import com.bardino.dozi.R
import com.bardino.dozi.core.data.repository.UserRepository
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext

/**
 * Ses dosyalarƒ±nƒ± kullanƒ±cƒ±nƒ±n se√ßimine g√∂re √ßalan helper sƒ±nƒ±fƒ±
 *
 * Kullanƒ±m:
 * SoundHelper.playSound(context, SoundType.HARIKA)
 */
object SoundHelper {

    private val userRepository = UserRepository()
    private var currentMediaPlayer: MediaPlayer? = null

    enum class SoundType {
        ERTELE,
        HARIKA,
        HERSEY_TAMAM,
        PEKALA,
        REMINDER_1,
        REMINDER_2,
        REMINDER_3,
        REMINDER_4,
        REMINDER_5,
        SAMPLE
    }

    /**
     * Kullanƒ±cƒ±nƒ±n ses se√ßimine g√∂re uygun ses dosyasƒ±nƒ± √ßalar
     */
    fun playSound(context: Context, soundType: SoundType) {
        CoroutineScope(Dispatchers.IO).launch {
            try {
                // Kullanƒ±cƒ±nƒ±n ses tercihini al
                val userData = userRepository.getUserData()
                val voiceGender = userData?.voiceGender ?: "erkek"

                // Ses dosyasƒ± ID'sini belirle
                val soundResId = getSoundResourceId(soundType, voiceGender)

                // Sesi √ßal
                withContext(Dispatchers.Main) {
                    playRawSound(context, soundResId)
                }
            } catch (e: Exception) {
                e.printStackTrace()
                // Hata durumunda default erkek sesi √ßal
                withContext(Dispatchers.Main) {
                    playRawSound(context, getSoundResourceId(soundType, "erkek"))
                }
            }
        }
    }

    /**
     * Belirli bir cinsiyet i√ßin √∂rnek ses √ßalar (ayarlar ekranƒ± i√ßin)
     * √ñnceki √∂rnek ses √ßalƒ±yorsa √∂nce onu durdurur
     */
    fun playSampleSound(context: Context, voiceGender: String) {
        try {
            val soundResId = if (voiceGender == "erkek") {
                R.raw.dozi_erkek_sample
            } else {
                R.raw.dozi_kadin_sample
            }
            playRawSound(context, soundResId)
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

    /**
     * Ses tipi ve cinsiyete g√∂re resource ID d√∂nd√ºr√ºr
     */
    private fun getSoundResourceId(soundType: SoundType, voiceGender: String): Int {
        return when (soundType) {
            SoundType.ERTELE -> {
                if (voiceGender == "erkek") R.raw.dozi_erkek_ertele
                else R.raw.dozi_kadin_ertele
            }
            SoundType.HARIKA -> {
                if (voiceGender == "erkek") R.raw.dozi_erkek_harika
                else R.raw.dozi_kadin_harika
            }
            SoundType.HERSEY_TAMAM -> {
                if (voiceGender == "erkek") R.raw.dozi_erkek_herseytamam
                else R.raw.dozi_kadin_herseytamam
            }
            SoundType.PEKALA -> {
                if (voiceGender == "erkek") R.raw.dozi_erkek_pekala
                else R.raw.dozi_kadin_pekala
            }
            SoundType.REMINDER_1 -> {
                if (voiceGender == "erkek") R.raw.dozi_erkek_reminder1
                else R.raw.dozi_kadin_reminder1
            }
            SoundType.REMINDER_2 -> {
                if (voiceGender == "erkek") R.raw.dozi_erkek_reminder2
                else R.raw.dozi_kadin_reminder2
            }
            SoundType.REMINDER_3 -> {
                if (voiceGender == "erkek") R.raw.dozi_erkek_reminder3
                else R.raw.dozi_kadin_reminder3
            }
            SoundType.REMINDER_4 -> {
                if (voiceGender == "erkek") R.raw.dozi_erkek_reminder4
                else R.raw.dozi_kadin_reminder4
            }
            SoundType.REMINDER_5 -> {
                if (voiceGender == "erkek") R.raw.dozi_erkek_reminder5
                else R.raw.dozi_kadin_reminder5
            }
            SoundType.SAMPLE -> {
                if (voiceGender == "erkek") R.raw.dozi_erkek_sample
                else R.raw.dozi_kadin_sample
            }
        }
    }

    /**
     * Raw resource'tan ses √ßalar
     * √ñnceki ses √ßalƒ±yorsa √∂nce onu durdurur
     */
    private fun playRawSound(context: Context, soundResId: Int) {
        try {
            // √ñnceki sesi durdur ve temizle
            stopCurrentSound()

            // Yeni sesi √ßal
            val player = MediaPlayer.create(context, soundResId)
            player?.setOnCompletionListener {
                it.release()
                if (currentMediaPlayer == it) {
                    currentMediaPlayer = null
                }
            }
            currentMediaPlayer = player
            player?.start()
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

    /**
     * √áalan sesi durdurur ve temizler
     */
    fun stopCurrentSound() {
        try {
            currentMediaPlayer?.apply {
                if (isPlaying) {
                    stop()
                }
                release()
            }
            currentMediaPlayer = null
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }
}

// ============================================================================
// FILE: StreakManager.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/utils/StreakManager.kt
// [104 of 122]
// ============================================================================

package com.bardino.dozi.core.utils

import android.content.Context
import android.util.Log
import com.bardino.dozi.core.data.model.*
import com.bardino.dozi.notifications.NotificationHelper
import com.google.firebase.Timestamp
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.tasks.await
import java.text.SimpleDateFormat
import java.util.*

/**
 * üî• Streak Manager
 * Kullanƒ±cƒ±nƒ±n ardƒ±≈üƒ±k ila√ß alma d√ºzenini y√∂netir
 */
class StreakManager(
    private val context: Context
) {
    private val firestore = FirebaseFirestore.getInstance()
    private val auth = FirebaseAuth.getInstance()

    companion object {
        private const val TAG = "StreakManager"
        private const val COLLECTION_USER_STATS = "user_stats"
    }

    /**
     * Kullanƒ±cƒ±nƒ±n streak'ini g√ºncelle
     * Her g√ºn en az bir ila√ß alƒ±ndƒ±ƒüƒ±nda √ßaƒürƒ±lmalƒ±
     */
    suspend fun updateStreak() {
        try {
            val userId = auth.currentUser?.uid ?: return
            val today = getTodayDateString()

            val statsDoc = firestore.collection(COLLECTION_USER_STATS)
                .document(userId)
                .get()
                .await()

            val currentStats = if (statsDoc.exists()) {
                statsDoc.toObject(UserStats::class.java) ?: UserStats(userId = userId)
            } else {
                UserStats(userId = userId)
            }

            // Son streak tarihi bug√ºn m√º?
            val lastStreakDate = currentStats.lastStreakDate?.toDate()
            val yesterday = Calendar.getInstance().apply {
                add(Calendar.DAY_OF_YEAR, -1)
            }.time

            val newStreak = when {
                lastStreakDate == null -> {
                    // ƒ∞lk streak
                    1
                }
                isSameDay(lastStreakDate, Date()) -> {
                    // Bug√ºn zaten g√ºncellenmi≈ü
                    currentStats.currentStreak
                }
                isSameDay(lastStreakDate, yesterday) -> {
                    // D√ºn g√ºncellenmi≈ü, streak devam ediyor
                    currentStats.currentStreak + 1
                }
                else -> {
                    // Streak kƒ±rƒ±ldƒ±, yeniden ba≈üla
                    1
                }
            }

            val updatedStats = currentStats.copy(
                currentStreak = newStreak,
                longestStreak = maxOf(newStreak, currentStats.longestStreak),
                lastStreakDate = Timestamp.now()
            )

            // Firestore'a kaydet
            firestore.collection(COLLECTION_USER_STATS)
                .document(userId)
                .set(updatedStats)
                .await()

            Log.d(TAG, "‚úÖ Streak updated: $newStreak days (longest: ${updatedStats.longestStreak})")

            // Achievement kontrol√º yap
            checkAchievements(updatedStats, context)
        } catch (e: Exception) {
            Log.e(TAG, "Error updating streak", e)
        }
    }

    /**
     * Kullanƒ±cƒ±nƒ±n istatistiklerini g√ºncelle
     */
    suspend fun updateStats(
        takenCount: Int = 0,
        missedCount: Int = 0,
        skippedCount: Int = 0
    ) {
        try {
            val userId = auth.currentUser?.uid ?: return

            val statsDoc = firestore.collection(COLLECTION_USER_STATS)
                .document(userId)
                .get()
                .await()

            val currentStats = if (statsDoc.exists()) {
                statsDoc.toObject(UserStats::class.java) ?: UserStats(userId = userId)
            } else {
                UserStats(userId = userId)
            }

            val newTotalTaken = currentStats.totalMedicationsTaken + takenCount
            val newTotalMissed = currentStats.totalMedicationsMissed + missedCount
            val newTotalSkipped = currentStats.totalMedicationsSkipped + skippedCount

            val totalAttempts = newTotalTaken + newTotalMissed + newTotalSkipped
            val newComplianceRate = if (totalAttempts > 0) {
                (newTotalTaken.toFloat() / totalAttempts.toFloat()) * 100
            } else {
                0f
            }

            val updatedStats = currentStats.copy(
                totalMedicationsTaken = newTotalTaken,
                totalMedicationsMissed = newTotalMissed,
                totalMedicationsSkipped = newTotalSkipped,
                complianceRate = newComplianceRate
            )

            firestore.collection(COLLECTION_USER_STATS)
                .document(userId)
                .set(updatedStats)
                .await()

            Log.d(TAG, "‚úÖ Stats updated: Taken=$newTotalTaken, Compliance=${newComplianceRate}%")
        } catch (e: Exception) {
            Log.e(TAG, "Error updating stats", e)
        }
    }

    /**
     * Achievement kontrol√º yap ve kazanƒ±lanlarƒ± kaydet
     */
    private suspend fun checkAchievements(stats: UserStats, context: Context) {
        try {
            val newAchievements = mutableListOf<Pair<String, Pair<String, String>>>()

            // Streak bazlƒ± achievement'lar
            if (stats.currentStreak >= 7 && !stats.achievements.contains("first_week")) {
                newAchievements.add("first_week" to ("ƒ∞lk Hafta" to "7 g√ºn √ºst √ºste ila√ßlarƒ±nƒ±zƒ± aldƒ±nƒ±z!"))
                Log.d(TAG, "üèÖ Achievement unlocked: ƒ∞lk Hafta!")
            }

            if (stats.currentStreak >= 30 && !stats.achievements.contains("30_days")) {
                newAchievements.add("30_days" to ("Bir Ay" to "30 g√ºn √ºst √ºste ila√ßlarƒ±nƒ±zƒ± aldƒ±nƒ±z!"))
                Log.d(TAG, "üéñÔ∏è Achievement unlocked: Bir Ay!")
            }

            if (stats.currentStreak >= 365 && !stats.achievements.contains("year_streak")) {
                newAchievements.add("year_streak" to ("Bir Yƒ±l" to "365 g√ºn √ºst √ºste ila√ßlarƒ±nƒ±zƒ± aldƒ±nƒ±z! ƒ∞nanƒ±lmaz!"))
                Log.d(TAG, "üèÜ Achievement unlocked: Bir Yƒ±l!")
            }

            // ƒ∞la√ß sayƒ±sƒ± bazlƒ± achievement'lar
            if (stats.totalMedicationsTaken >= 100 && !stats.achievements.contains("hundred_meds")) {
                newAchievements.add("hundred_meds" to ("Y√ºzl√ºk Kul√ºp" to "Toplam 100 ila√ß aldƒ±nƒ±z!"))
                Log.d(TAG, "üíØ Achievement unlocked: Y√ºzl√ºk Kul√ºp!")
            }

            // Uyumluluk oranƒ± bazlƒ± achievement'lar
            if (stats.complianceRate >= 100f && !stats.achievements.contains("perfect_month")) {
                newAchievements.add("perfect_month" to ("M√ºkemmel Ay" to "%100 uyum oranƒ±na ula≈ütƒ±nƒ±z!"))
                Log.d(TAG, "üëë Achievement unlocked: M√ºkemmel Ay!")
            }

            // Yeni achievement'lar varsa kaydet
            if (newAchievements.isNotEmpty()) {
                val userId = auth.currentUser?.uid ?: return
                val allAchievements = stats.achievements + newAchievements.map { it.first }

                firestore.collection(COLLECTION_USER_STATS)
                    .document(userId)
                    .update("achievements", allAchievements)
                    .await()

                // Achievement bildirimlerini g√∂ster
                newAchievements.forEach { (_, titleAndDesc) ->
                    val (title, description) = titleAndDesc
                    try {
                        NotificationHelper.showAchievementNotification(
                            context,
                            title,
                            description
                        )
                    } catch (e: SecurityException) {
                        Log.e(TAG, "Permission not granted for achievement notification", e)
                    }
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "Error checking achievements", e)
        }
    }

    /**
     * Kullanƒ±cƒ± istatistiklerini √ßek
     */
    suspend fun getUserStats(): UserStats? {
        return try {
            val userId = auth.currentUser?.uid ?: return null

            val statsDoc = firestore.collection(COLLECTION_USER_STATS)
                .document(userId)
                .get()
                .await()

            if (statsDoc.exists()) {
                statsDoc.toObject(UserStats::class.java)
            } else {
                null
            }
        } catch (e: Exception) {
            Log.e(TAG, "Error getting user stats", e)
            null
        }
    }

    /**
     * ƒ∞ki tarihin aynƒ± g√ºn olup olmadƒ±ƒüƒ±nƒ± kontrol et
     */
    private fun isSameDay(date1: Date, date2: Date): Boolean {
        val cal1 = Calendar.getInstance().apply { time = date1 }
        val cal2 = Calendar.getInstance().apply { time = date2 }

        return cal1.get(Calendar.YEAR) == cal2.get(Calendar.YEAR) &&
                cal1.get(Calendar.DAY_OF_YEAR) == cal2.get(Calendar.DAY_OF_YEAR)
    }

    /**
     * Bug√ºn√ºn tarih string'ini d√∂nd√ºr (yyyy-MM-dd)
     */
    private fun getTodayDateString(): String {
        return SimpleDateFormat("yyyy-MM-dd", Locale.getDefault()).format(Date())
    }
}

// ============================================================================
// FILE: DoziVoiceAssistant.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/voice/DoziVoiceAssistant.kt
// [105 of 122]
// ============================================================================

package com.bardino.dozi.core.ui.voice

import android.Manifest
import android.app.Activity
import android.content.Intent
import android.speech.RecognizerIntent
import android.widget.Toast
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.animation.core.FastOutSlowInEasing
import androidx.compose.animation.core.RepeatMode
import androidx.compose.animation.core.animateFloat
import androidx.compose.animation.core.infiniteRepeatable
import androidx.compose.animation.core.rememberInfiniteTransition
import androidx.compose.animation.core.tween
import androidx.compose.foundation.Canvas
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Close
import androidx.compose.material.icons.filled.Mic
import androidx.compose.material.icons.filled.Refresh
import androidx.compose.material3.AlertDialog
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.FilledIconButton
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.IconButtonDefaults
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.MutableState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.Dp
import androidx.compose.ui.unit.dp
import androidx.navigation.NavController
import com.bardino.dozi.core.data.IlacJsonRepository
import com.bardino.dozi.core.ui.theme.DoziCoral
import com.bardino.dozi.core.ui.theme.DoziTurquoise
import com.bardino.dozi.core.voice.ParsedMedicineCommand
import com.bardino.dozi.core.voice.parseVoiceCommand
import com.bardino.dozi.navigation.Screen
import kotlinx.coroutines.delay
import kotlinx.coroutines.launch
import java.util.Locale

/**
 * Uygulama-i√ßi sesli asistan:
 * - ƒ∞konla a√ßƒ±lƒ±r
 * - Dinleme sƒ±rasƒ±nda animasyonlu dalga
 * - Konu≈üma bitince "Dozi d√º≈ü√ºn√ºyor..."
 * - Ardƒ±ndan popup ile onay / d√ºzenle / iptal
 */
@Composable
fun DoziVoiceAssistantOverlay(
    navController: NavController,
    onDismiss: () -> Unit,
) {
    val context = LocalContext.current
    var uiState by remember { mutableStateOf(VoiceUiState.Listening) }
    var lastHeardText by remember { mutableStateOf<String?>(null) }
    var parsed by remember { mutableStateOf<ParsedMedicineCommand?>(null) }

    // ... diƒüer kodlar aynƒ± kalacak ...


    // Mikrofon izni
    val micPermissionLauncher = rememberLauncherForActivityResult(
        ActivityResultContracts.RequestPermission()
    ) { granted ->
        if (!granted) {
            Toast.makeText(context, "Mikrofon izni gerekli.", Toast.LENGTH_LONG).show()
            onDismiss()
        }
    }

    // Speech launcher
    val speechLauncher = rememberLauncherForActivityResult(
        ActivityResultContracts.StartActivityForResult()
    ) { res ->
        if (res.resultCode == Activity.RESULT_OK) {
            val spoken = res.data?.getStringArrayListExtra(RecognizerIntent.EXTRA_RESULTS)
                ?.firstOrNull()
            lastHeardText = spoken
            uiState = VoiceUiState.Thinking
        } else {
            Toast.makeText(context, "Konu≈üma algƒ±lanamadƒ±.", Toast.LENGTH_SHORT).show()
            onDismiss()
        }
    }

    // ƒ∞lk a√ßƒ±lƒ±≈üta izin ve dinleme
    LaunchedEffect(Unit) {
        micPermissionLauncher.launch(Manifest.permission.RECORD_AUDIO)
        delay(150)
        startSpeech(speechLauncher)
    }

    // Thinking -> Parse ve popup g√∂sterimi
    LaunchedEffect(uiState) {
        if (uiState == VoiceUiState.Thinking) {
            delay(400)
            parsed = lastHeardText?.let { parseVoiceCommand(it) }
            uiState = VoiceUiState.Result
        }
    }

    // Arka plan overlay
    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.Black.copy(alpha = 0.55f)),
        contentAlignment = Alignment.Center
    ) {
        Surface(
            shape = MaterialTheme.shapes.extraLarge,
            color = Color.White,
            tonalElevation = 6.dp,
            shadowElevation = 6.dp
        ) {
            Column(
                modifier = Modifier
                    .padding(horizontal = 22.dp, vertical = 20.dp)
                    .size(width = 340.dp, height = 420.dp),
                verticalArrangement = Arrangement.SpaceBetween,
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                // √úst bar
                Row(
                    modifier = Modifier.fillMaxSize().weight(1f),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.Top
                ) {
                    Text(
                        "Dozi Sesli Asistan",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold,
                        modifier = Modifier.padding(top = 2.dp)
                    )
                    IconButton(onClick = onDismiss) {
                        Icon(Icons.Filled.Close, contentDescription = "Kapat")
                    }
                }

                // ƒ∞√ßerik
                when (uiState) {
                    VoiceUiState.Listening -> {
                        Text("üéß Dozi seni dinliyor‚Ä¶", color = Color.Gray)
                        Spacer(Modifier.height(12.dp))
                        VoiceWaveAnimation(
                            barCount = 5,
                            barWidth = 10.dp,
                            barMaxHeight = 80.dp,
                            color = DoziTurquoise
                        )
                        Spacer(Modifier.height(24.dp))
                        IconButton(
                            onClick = { /* Dinleme aktif */ },
                            modifier = Modifier
                                .size(56.dp)
                                .background(DoziCoral.copy(alpha = 0.15f), shape = CircleShape),
                            colors = IconButtonDefaults.iconButtonColors(contentColor = DoziCoral)
                        ) {
                            Icon(Icons.Filled.Mic, contentDescription = null)
                        }
                    }

                    VoiceUiState.Thinking -> {
                        Text("üí≠ Dozi d√º≈ü√ºn√ºyor‚Ä¶", color = Color.Gray)
                        Spacer(Modifier.height(16.dp))
                        ThinkingDots()
                        Spacer(Modifier.height(24.dp))
                        Text(lastHeardText ?: "", fontWeight = FontWeight.Medium)
                    }

                    // ‚úÖ D√ºzenlenen kƒ±sƒ±m burasƒ±
                    VoiceUiState.Result -> {
                        val p = parsed
                        if (p == null) {
                            Text("Komutu anlayamadƒ±m.", color = Color.Red)
                            Spacer(Modifier.height(12.dp))
                            Row(horizontalArrangement = Arrangement.spacedBy(12.dp)) {
                                Button(onClick = {
                                    startSpeech(speechLauncher)
                                    uiState = VoiceUiState.Listening
                                }) {
                                    Icon(Icons.Filled.Refresh, contentDescription = null)
                                    Spacer(Modifier.size(8.dp))
                                    Text("Tekrar Dinle")
                                }
                                TextButton(onClick = onDismiss) { Text("ƒ∞ptal") }
                            }
                        } else {
                            // üîç Komut ba≈üarƒ±yla √ß√∂z√ºmlendi
                            // √ñrnek: "Ak≈üam 5 Lustral" -> name=Lustral, hour=17
                            val matches = IlacJsonRepository.search(context, p.name)

                            if (matches.isNotEmpty()) {
                                val ilac = matches.first().item
                                // ƒ∞lacƒ± buldu ‚Üí AddReminderScreen‚Äôa y√∂nlendir
                                navController.currentBackStackEntry?.savedStateHandle?.set("voice_medicine", ilac.Product_Name)
                                navController.currentBackStackEntry?.savedStateHandle?.set("voice_hour", p.hour)
                                navController.currentBackStackEntry?.savedStateHandle?.set("voice_minute", p.minute)
                                navController.currentBackStackEntry?.savedStateHandle?.set("voice_flow", "known")

                                navController.navigate(Screen.AddReminder.route)
                            } else {
                                // ƒ∞lacƒ± bulamadƒ± ‚Üí MedicineLookupScreen‚Äôa y√∂nlendir
                                navController.currentBackStackEntry?.savedStateHandle?.set("voice_query", p.name)
                                navController.currentBackStackEntry?.savedStateHandle?.set("voice_hour", p.hour)
                                navController.currentBackStackEntry?.savedStateHandle?.set("voice_minute", p.minute)
                                navController.currentBackStackEntry?.savedStateHandle?.set("voice_flow", "unknown")

                                navController.navigate(Screen.MedicineLookup.route)
                            }

                        }
                    }
                }
                Spacer(Modifier.height(6.dp))
            }
        }
    }
}

private enum class VoiceUiState { Listening, Thinking, Result }

private fun startSpeech(launcher: androidx.activity.result.ActivityResultLauncher<Intent>) {
    val intent = Intent(RecognizerIntent.ACTION_RECOGNIZE_SPEECH).apply {
        putExtra(RecognizerIntent.EXTRA_LANGUAGE_MODEL, RecognizerIntent.LANGUAGE_MODEL_FREE_FORM)
        putExtra(RecognizerIntent.EXTRA_LANGUAGE, "tr-TR")
        putExtra(RecognizerIntent.EXTRA_PROMPT, "ƒ∞lacƒ±nƒ± s√∂yle. √ñrn: 'Sabah 9'da Parol 500 mg'")
    }
    launcher.launch(intent)
}

@Composable
private fun VoiceWaveAnimation(
    barCount: Int,
    barWidth: Dp,
    barMaxHeight: Dp,
    color: Color
) {
    val infinite = rememberInfiniteTransition(label = "wave")
    val anims = (0 until barCount).map { i ->
        val delay = i * 120
        infinite.animateFloat(
            initialValue = 0.2f,
            targetValue = 1f,
            animationSpec = infiniteRepeatable(
                tween(durationMillis = 900, delayMillis = delay, easing = FastOutSlowInEasing),
                RepeatMode.Reverse
            ),
            label = "bar-$i"
        )
    }

    Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {
        anims.forEach { anim ->
            val h = barMaxHeight * anim.value
            Canvas(Modifier.size(width = barWidth, height = barMaxHeight)) {
                val top = size.height - h.toPx()
                drawLine(
                    color = color,
                    start = Offset(x = size.width / 2f, y = size.height),
                    end = Offset(x = size.width / 2f, y = top),
                    strokeWidth = barWidth.toPx()
                )
            }
        }
    }
}

@Composable
private fun ThinkingDots() {
    val infinite = rememberInfiniteTransition(label = "dots")
    val a by infinite.animateFloat(
        initialValue = 0f, targetValue = 1f,
        animationSpec = infiniteRepeatable(tween(900), RepeatMode.Restart),
        label = "dots-anim"
    )
    val dots = when {
        a < 0.33f -> "."
        a < 0.66f -> ".."
        else -> "..."
    }
    Text("Analiz ediliyor$dots", color = Color.Gray)
}

@Composable
private fun SummaryRow(label: String, value: String) {
    Row(
        modifier = Modifier.padding(vertical = 2.dp),
        horizontalArrangement = Arrangement.spacedBy(8.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        Text("$label:", color = Color.Gray)
        Text(value, fontWeight = FontWeight.Medium)
    }
}

// ============================================================================
// FILE: VoiceCommandParser.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/core/voice/VoiceCommandParser.kt
// [106 of 122]
// ============================================================================

package com.bardino.dozi.core.voice

import java.util.Locale

data class ParsedMedicineCommand(
    val name: String,          // ƒ∞la√ß adƒ± (Parol)
    val dose: String?,         // Doz (500 mg / 1 tablet) - opsiyonel
    val hour: Int,             // 0..23
    val minute: Int = 0,       // varsayƒ±lan 00
    val frequency: String? = null // "her g√ºn", "pazartesi", vb. - opsiyonel
)

/**
 * ‚Äúsabah 9'da Parol 500 mg alacaƒüƒ±m‚Äù, ‚Äúak≈üam 8:30'da Coraspin‚Äù gibi T√ºrk√ße komutlarƒ± √ß√∂zer.
 * Minimal, pratik regex tabanlƒ± ayrƒ±≈ütƒ±rƒ±cƒ±. Gerekirse ileride NLP ile g√º√ßlendir.
 */
fun parseVoiceCommand(raw: String): ParsedMedicineCommand? {
    val text = raw.lowercase(Locale("tr", "TR")).trim()

    // Saat ve dakika (09:00, 9.00, 9, 8:30 vb.)
    val timeRegex = Regex("""(?:(sabah|ak≈üam)\s*)?(\d{1,2})(?::|\.|‚Äô|')?(\d{2})?""")
    val timeMatch = timeRegex.find(text)
    val meridiem = timeMatch?.groups?.get(1)?.value  // sabah | ak≈üam
    val hourRaw = timeMatch?.groups?.get(2)?.value?.toIntOrNull()
    val minuteRaw = timeMatch?.groups?.get(3)?.value?.toIntOrNull() ?: 0

    val hour24 = when {
        hourRaw == null -> null
        meridiem == "ak≈üam" && hourRaw in 1..11 -> hourRaw + 12
        else -> hourRaw
    }?.coerceIn(0, 23)

    // Doz (500 mg | 1 tablet | 5 ml vb.)
    val doseRegex = Regex("""(\d+\s?(?:mg|ml))|(\d+\s?tablet)|(\d+\s?damla)""")
    val dose = doseRegex.find(text)?.value?.replace("\\s+".toRegex(), " ")?.trim()

    // Sƒ±klƒ±k (her g√ºn, pazartesi, haftada 2 vb.) ‚Äì ≈üimdilik sadece √∂rnek alan
    val freqRegex = Regex("""(her g√ºn|hergun|pazartesi|salƒ±|√ßar≈üamba|per≈üembe|cuma|cumartesi|pazar|haftada\s*\d+)""")
    val freq = freqRegex.find(text)?.value

    // ƒ∞la√ß adƒ±: en zayƒ±f halka; lookup ekranƒ±nda e≈üle≈ütireceƒüin i√ßin metinden kalan par√ßadan bulacaƒüƒ±z.
    // Basit yakla≈üƒ±m: saat/doz/frekans kƒ±sƒ±mlarƒ±nƒ± ayƒ±kla, kalan kelimeler ila√ß adƒ± adayƒ±mƒ±z.
    val stripped = text
        .replace(timeRegex, " ")
        .replace(doseRegex, " ")
        .replace(freqRegex, " ")
        .replace("""alacaƒüƒ±m|alcam|alƒ±rƒ±m|hatƒ±rlat|hatirlat""".toRegex(), " ")
        .replace("""^\s+|\s+$""".toRegex(), " ")
        .replace("""\s{2,}""".toRegex(), " ")
        .trim()

    val nameCandidate = stripped.split(" ").filter { it.isNotBlank() }.joinToString(" ").trim()

    return if (!nameCandidate.isNullOrBlank() && hour24 != null) {
        ParsedMedicineCommand(
            name = nameCandidate.replaceFirstChar { it.titlecase(Locale("tr","TR")) },
            dose = dose?.replaceFirstChar { it.titlecase(Locale("tr","TR")) },
            hour = hour24,
            minute = minuteRaw,
            frequency = freq
        )
    } else null
}

// ============================================================================
// FILE: DatabaseModule.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/di/DatabaseModule.kt
// [107 of 122]
// ============================================================================

package com.bardino.dozi.di

import android.content.Context
import com.bardino.dozi.core.data.local.DoziDatabase
import com.bardino.dozi.core.data.local.dao.MedicationLogDao
import com.bardino.dozi.core.data.local.dao.SyncQueueDao
import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.android.qualifiers.ApplicationContext
import dagger.hilt.components.SingletonComponent
import javax.inject.Singleton

@Module
@InstallIn(SingletonComponent::class)
object DatabaseModule {

    @Provides
    @Singleton
    fun provideDatabase(@ApplicationContext context: Context): DoziDatabase {
        return DoziDatabase.getDatabase(context)
    }

    @Provides
    @Singleton
    fun provideMedicationLogDao(database: DoziDatabase): MedicationLogDao {
        return database.medicationLogDao()
    }

    @Provides
    @Singleton
    fun provideSyncQueueDao(database: DoziDatabase): SyncQueueDao {
        return database.syncQueueDao()
    }
}

// ============================================================================
// FILE: FirebaseModule.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/di/FirebaseModule.kt
// [108 of 122]
// ============================================================================

package com.bardino.dozi.di

import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.functions.FirebaseFunctions
import com.google.firebase.messaging.FirebaseMessaging
import com.google.firebase.storage.FirebaseStorage
import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.components.SingletonComponent
import javax.inject.Singleton

/**
 * Firebase dependency injection module
 */
@Module
@InstallIn(SingletonComponent::class)
object FirebaseModule {

    @Provides
    @Singleton
    fun provideFirebaseAuth(): FirebaseAuth = FirebaseAuth.getInstance()

    @Provides
    @Singleton
    fun provideFirebaseFirestore(): FirebaseFirestore = FirebaseFirestore.getInstance()

    @Provides
    @Singleton
    fun provideFirebaseFunctions(): FirebaseFunctions = FirebaseFunctions.getInstance()

    @Provides
    @Singleton
    fun provideFirebaseMessaging(): FirebaseMessaging = FirebaseMessaging.getInstance()

    @Provides
    @Singleton
    fun provideFirebaseStorage(): FirebaseStorage = FirebaseStorage.getInstance()
}

// ============================================================================
// FILE: RepositoryModule.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/di/RepositoryModule.kt
// [109 of 122]
// ============================================================================

package com.bardino.dozi.di

import android.content.Context
import com.bardino.dozi.core.data.repository.*
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.functions.FirebaseFunctions
import com.google.firebase.messaging.FirebaseMessaging
import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.android.qualifiers.ApplicationContext
import dagger.hilt.components.SingletonComponent
import javax.inject.Singleton

/**
 * Repository dependency injection module
 */
@Module
@InstallIn(SingletonComponent::class)
object RepositoryModule {

    @Provides
    @Singleton
    fun provideBadiRepository(
        auth: FirebaseAuth,
        firestore: FirebaseFirestore
    ): BadiRepository {
        return BadiRepository(auth, firestore)
    }

    @Provides
    @Singleton
    fun provideMedicationLogRepository(
        @ApplicationContext context: Context,
        auth: FirebaseAuth,
        firestore: FirebaseFirestore
    ): MedicationLogRepository {
        return MedicationLogRepository(context, auth, firestore)
    }

    @Provides
    @Singleton
    fun provideNotificationRepository(
        auth: FirebaseAuth,
        firestore: FirebaseFirestore,
        functions: FirebaseFunctions,
        messaging: FirebaseMessaging
    ): NotificationRepository {
        return NotificationRepository(auth, firestore, functions, messaging)
    }

    @Provides
    @Singleton
    fun provideUserRepository(
        auth: FirebaseAuth,
        firestore: FirebaseFirestore
    ): UserRepository {
        return UserRepository(auth, firestore)
    }

    @Provides
    @Singleton
    fun provideMedicineRepository(): MedicineRepository {
        return MedicineRepository()
    }

    @Provides
    @Singleton
    fun provideFamilyPlanRepository(
        auth: FirebaseAuth,
        firestore: FirebaseFirestore
    ): FamilyPlanRepository {
        return FamilyPlanRepository(auth, firestore)
    }
}

// ============================================================================
// FILE: GeofenceReceiver.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/geofence/GeofenceReceiver.kt
// [110 of 122]
// ============================================================================

package com.bardino.dozi.geofence

import android.Manifest
import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import androidx.annotation.RequiresPermission
import com.bardino.dozi.notifications.NotificationHelper
import com.google.android.gms.location.Geofence
import com.google.android.gms.location.GeofencingEvent

class GeofenceReceiver : BroadcastReceiver() {
    @RequiresPermission(Manifest.permission.POST_NOTIFICATIONS)
    override fun onReceive(context: Context, intent: Intent) {
        val event = GeofencingEvent.fromIntent(intent) ?: return
        if (event.hasError()) return

        if (event.geofenceTransition == Geofence.GEOFENCE_TRANSITION_ENTER) {
            val geofence = event.triggeringGeofences?.firstOrNull()
            val placeName = geofence?.requestId ?: "Tanƒ±msƒ±z Konum"
            NotificationHelper.showMedicationNotification(
                context,
                "üíä ${placeName} konumuna vardƒ±n! ƒ∞lacƒ±nƒ± almayƒ± unutma."
            )
        }
    }
}

// ============================================================================
// FILE: BootReceiver.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/notifications/BootReceiver.kt
// [111 of 122]
// ============================================================================

package com.bardino.dozi.notifications

import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import android.util.Log
import com.bardino.dozi.notifications.NotificationHelper

/**
 * Cihaz yeniden ba≈üladƒ±ƒüƒ±nda alarmlarƒ± yeniden planlamak i√ßin
 */
class BootReceiver : BroadcastReceiver() {

    override fun onReceive(context: Context, intent: Intent) {
        if (intent.action == Intent.ACTION_BOOT_COMPLETED ||
            intent.action == "android.intent.action.QUICKBOOT_POWERON"
        ) {
            Log.d("BootReceiver", "üîÑ Cihaz yeniden ba≈üladƒ± - Alarmlar yeniden planlanƒ±yor")

            // Notification channel'ƒ± olu≈ütur
            NotificationHelper.createDoziChannel(context)

            // ‚úÖ T√ºm ila√ßlarƒ±n alarmlarƒ±nƒ± yeniden planla
            ReminderScheduler.rescheduleAllReminders(context)

            Log.d("BootReceiver", "‚úÖ Boot receiver tamamlandƒ±, alarmlar ba≈üarƒ±yla yeniden planlandƒ±")
        }
    }
}
// ============================================================================
// FILE: DoziMessagingService.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/notifications/DoziMessagingService.kt
// [112 of 122]
// ============================================================================

package com.bardino.dozi.notifications

import android.Manifest
import android.app.PendingIntent
import android.content.Intent
import android.content.pm.PackageManager
import android.util.Log
import androidx.annotation.RequiresPermission
import androidx.core.content.ContextCompat
import com.bardino.dozi.MainActivity
import com.bardino.dozi.core.data.repository.UserRepository
import com.google.firebase.messaging.FirebaseMessagingService
import com.google.firebase.messaging.RemoteMessage
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch

/**
 * Firebase Cloud Messaging Service
 * Server'dan gelen bildirimler burada i≈ülenir
 */
class DoziMessagingService : FirebaseMessagingService() {

    private val userRepository by lazy { UserRepository() }

    /**
     * Server'dan yeni bildirim geldiƒüinde √ßaƒürƒ±lƒ±r
     */
    override fun onMessageReceived(remoteMessage: RemoteMessage) {
        Log.d(TAG, "FCM Message received from: ${remoteMessage.from}")

        // Data payload var mƒ± kontrol et
        if (remoteMessage.data.isNotEmpty()) {
            Log.d(TAG, "Message data payload: ${remoteMessage.data}")
            handleDataMessage(remoteMessage.data)
        }

        // Notification payload var mƒ± kontrol et
        remoteMessage.notification?.let {
            Log.d(TAG, "Message Notification Body: ${it.body}")
            handleNotificationMessage(it.title, it.body)
        }
    }

    /**
     * Data mesajlarƒ±nƒ± i≈üle (server'dan √∂zel format)
     */
    @RequiresPermission(Manifest.permission.POST_NOTIFICATIONS)
    private fun handleDataMessage(data: Map<String, String>) {
        val type = data["type"]

        when (type) {
            "medicine_reminder" -> {
                val medicineName = data["medicine_name"] ?: return
                val dosage = data["dosage"] ?: ""
                val time = data["time"] ?: ""

                // Bildirim izni varsa g√∂ster
                if (hasNotificationPermission()) {
                    NotificationHelper.showMedicationNotification(
                        context = this,
                        medicineName = medicineName,
                        dosage = dosage,
                        time = time
                    )
                }
            }
            "buddy_request" -> {
                // Buddy isteƒüi bildirimi - action butonlarƒ± ile
                val requestId = data["requestId"] ?: return
                val fromUserName = data["fromUserName"] ?: "Biri"

                if (hasNotificationPermission()) {
                    NotificationHelper.showBuddyRequestNotification(
                        context = this,
                        requestId = requestId,
                        fromUserName = fromUserName
                    )
                }
            }
            "buddy_medication_reminder" -> {
                // Badinin ila√ß hatƒ±rlatmasƒ±
                val buddyName = data["buddyName"] ?: "Badiniz"
                val medicineName = data["medicineName"] ?: "ila√ß"
                val time = data["time"] ?: ""
                handleNotificationMessage(
                    title = "üíä Badi ƒ∞la√ß Hatƒ±rlatmasƒ±",
                    body = "$buddyName - $medicineName alma zamanƒ± ($time)",
                    type = "buddy_medication_reminder"
                )
            }
            "medication_taken" -> {
                // Badi ilacƒ±nƒ± aldƒ± bildirimi
                val buddyName = data["buddyName"] ?: "Badiniz"
                val medicineName = data["medicineName"] ?: "ilacƒ±nƒ±"
                handleNotificationMessage(
                    title = "‚úÖ ƒ∞la√ß Alƒ±ndƒ±",
                    body = "$buddyName $medicineName aldƒ±",
                    type = "medication_taken"
                )
            }
            "medication_missed" -> {
                // Badi ilacƒ±nƒ± ka√ßƒ±rdƒ± bildirimi
                val buddyName = data["buddyName"] ?: "Badiniz"
                val medicineName = data["medicineName"] ?: "ilacƒ±nƒ±"
                handleNotificationMessage(
                    title = "‚ö†Ô∏è ƒ∞la√ß Ka√ßƒ±rƒ±ldƒ±",
                    body = "$buddyName $medicineName ka√ßƒ±rdƒ±",
                    type = "medication_missed"
                )
            }
            "general_notification" -> {
                val title = data["title"] ?: "Dozi"
                val body = data["body"] ?: ""
                handleNotificationMessage(
                    title = title,
                    body = body,
                    type = "general_notification"
                )
            }
            else -> {
                Log.w(TAG, "Unknown message type: $type")
            }
        }
    }

    /**
     * Basit notification mesajlarƒ±nƒ± i≈üle
     */
    private fun handleNotificationMessage(title: String?, body: String?, type: String = "general") {
        if (!hasNotificationPermission()) {
            Log.w(TAG, "No notification permission")
            return
        }

        Log.d(TAG, "Showing notification: $title - $body (type: $type)")

        // Notification channel'ƒ± olu≈ütur
        NotificationHelper.createDoziChannel(this)

        // Bildirim g√∂ster
        val notificationId = System.currentTimeMillis().toInt()

        // Type'a g√∂re navigation route belirle
        val navigationRoute = when (type) {
            "buddy_request" -> "buddy_list"
            "medication_taken", "medication_missed", "buddy_medication_reminder" -> "buddy_list"
            else -> null
        }

        val contentIntent = PendingIntent.getActivity(
            this,
            0,
            Intent(this, MainActivity::class.java).apply {
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP)
                // Deep link i√ßin navigation route ekle
                navigationRoute?.let { putExtra("navigation_route", it) }
            },
            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
        )

        val notification = androidx.core.app.NotificationCompat.Builder(this, NotificationHelper.CHANNEL_ID)
            .setSmallIcon(com.bardino.dozi.R.drawable.ic_notification_pill)
            .setContentTitle(title)
            .setContentText(body)
            .setAutoCancel(true)
            .setContentIntent(contentIntent)
            .setPriority(androidx.core.app.NotificationCompat.PRIORITY_HIGH)
            .build()

        try {
            val notificationManager = androidx.core.app.NotificationManagerCompat.from(this)
            notificationManager.notify(notificationId, notification)
            Log.d(TAG, "‚úÖ Notification displayed with ID: $notificationId (route: $navigationRoute)")
        } catch (e: SecurityException) {
            Log.e(TAG, "‚ùå Notification permission denied", e)
        }
    }

    /**
     * Yeni FCM token olu≈üturulduƒüunda √ßaƒürƒ±lƒ±r
     * Token deƒüi≈ütiƒüinde Firestore'a kaydetmeliyiz
     */
    override fun onNewToken(token: String) {
        Log.d(TAG, "New FCM token: $token")

        // Token'ƒ± Firestore'a kaydet
        CoroutineScope(Dispatchers.IO).launch {
            try {
                userRepository.updateUserField("fcmToken", token)
                Log.d(TAG, "FCM token saved to Firestore")
            } catch (e: Exception) {
                Log.e(TAG, "Failed to save FCM token", e)
            }
        }
    }

    /**
     * Bildirim izni kontrol√º
     */
    private fun hasNotificationPermission(): Boolean {
        return if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.TIRAMISU) {
            ContextCompat.checkSelfPermission(
                this,
                Manifest.permission.POST_NOTIFICATIONS
            ) == PackageManager.PERMISSION_GRANTED
        } else {
            true // Android 13 altƒ±nda izin gerekmiyor
        }
    }

    companion object {
        private const val TAG = "DoziMessaging"
    }
}

// ============================================================================
// FILE: MedicationSyncWorker.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/notifications/MedicationSyncWorker.kt
// [113 of 122]
// ============================================================================

package com.bardino.dozi.notifications

import android.content.Context
import android.util.Log
import androidx.work.BackoffPolicy
import androidx.work.CoroutineWorker
import androidx.work.ExistingWorkPolicy
import androidx.work.OneTimeWorkRequestBuilder
import androidx.work.WorkManager
import androidx.work.WorkerParameters
import androidx.work.workDataOf
import com.bardino.dozi.core.data.repository.BadiRepository
import com.bardino.dozi.core.data.repository.MedicationLogRepository
import com.bardino.dozi.core.utils.SmartReminderHelper
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import java.util.concurrent.TimeUnit

/**
 * üîÑ MedicationSyncWorker
 *
 * WorkManager ile aƒüƒ±r Firestore i≈ülemlerini g√ºvenli ≈üekilde yapar.
 * BroadcastReceiver'dan tetiklenir, uygulama kapalƒ± olsa bile √ßalƒ±≈üƒ±r.
 *
 * Desteklenen action'lar:
 * - ACTION_LOG_TAKEN: ƒ∞la√ß alƒ±ndƒ± kaydƒ±
 * - ACTION_LOG_SKIPPED: ƒ∞la√ß atlandƒ± kaydƒ±
 * - ACTION_LOG_SNOOZED: ƒ∞la√ß ertelendi kaydƒ±
 * - ACTION_BUDDY_ACCEPT: Badi isteƒüi kabul
 * - ACTION_BUDDY_REJECT: Badi isteƒüi red
 */
class MedicationSyncWorker(
    appContext: Context,
    workerParams: WorkerParameters
) : CoroutineWorker(appContext, workerParams) {

    companion object {
        private const val TAG = "MedicationSyncWorker"

        // Action types
        const val ACTION_LOG_TAKEN = "action_log_taken"
        const val ACTION_LOG_SKIPPED = "action_log_skipped"
        const val ACTION_LOG_SNOOZED = "action_log_snoozed"
        const val ACTION_BUDDY_ACCEPT = "action_buddy_accept"
        const val ACTION_BUDDY_REJECT = "action_buddy_reject"

        // Input data keys
        const val KEY_ACTION = "key_action"
        const val KEY_MEDICINE_ID = "key_medicine_id"
        const val KEY_MEDICINE_NAME = "key_medicine_name"
        const val KEY_DOSAGE = "key_dosage"
        const val KEY_SCHEDULED_TIME = "key_scheduled_time"
        const val KEY_TAKEN_TIME = "key_taken_time"
        const val KEY_SNOOZE_MINUTES = "key_snooze_minutes"
        const val KEY_SKIP_REASON = "key_skip_reason"
        const val KEY_REQUEST_ID = "key_request_id"

        /**
         * ƒ∞la√ß alƒ±ndƒ± kaydƒ± i√ßin Worker'ƒ± ba≈ülat
         */
        fun enqueueLogTaken(
            context: Context,
            medicineId: String,
            medicineName: String,
            dosage: String,
            scheduledTime: Long,
            takenTime: Long
        ) {
            val inputData = workDataOf(
                KEY_ACTION to ACTION_LOG_TAKEN,
                KEY_MEDICINE_ID to medicineId,
                KEY_MEDICINE_NAME to medicineName,
                KEY_DOSAGE to dosage,
                KEY_SCHEDULED_TIME to scheduledTime,
                KEY_TAKEN_TIME to takenTime
            )

            enqueueWork(context, "log_taken_$medicineId", inputData)
        }

        /**
         * ƒ∞la√ß atlandƒ± kaydƒ± i√ßin Worker'ƒ± ba≈ülat
         */
        fun enqueueLogSkipped(
            context: Context,
            medicineId: String,
            medicineName: String,
            dosage: String,
            scheduledTime: Long,
            reason: String = "Kullanƒ±cƒ± atladƒ±"
        ) {
            val inputData = workDataOf(
                KEY_ACTION to ACTION_LOG_SKIPPED,
                KEY_MEDICINE_ID to medicineId,
                KEY_MEDICINE_NAME to medicineName,
                KEY_DOSAGE to dosage,
                KEY_SCHEDULED_TIME to scheduledTime,
                KEY_SKIP_REASON to reason
            )

            enqueueWork(context, "log_skipped_$medicineId", inputData)
        }

        /**
         * ƒ∞la√ß ertelendi kaydƒ± i√ßin Worker'ƒ± ba≈ülat
         */
        fun enqueueLogSnoozed(
            context: Context,
            medicineId: String,
            medicineName: String,
            dosage: String,
            scheduledTime: Long,
            snoozeMinutes: Int = 10
        ) {
            val inputData = workDataOf(
                KEY_ACTION to ACTION_LOG_SNOOZED,
                KEY_MEDICINE_ID to medicineId,
                KEY_MEDICINE_NAME to medicineName,
                KEY_DOSAGE to dosage,
                KEY_SCHEDULED_TIME to scheduledTime,
                KEY_SNOOZE_MINUTES to snoozeMinutes
            )

            enqueueWork(context, "log_snoozed_$medicineId", inputData)
        }

        /**
         * Badi isteƒüi kabul i√ßin Worker'ƒ± ba≈ülat
         */
        fun enqueueBuddyAccept(context: Context, requestId: String) {
            val inputData = workDataOf(
                KEY_ACTION to ACTION_BUDDY_ACCEPT,
                KEY_REQUEST_ID to requestId
            )

            enqueueWork(context, "buddy_accept_$requestId", inputData)
        }

        /**
         * Badi isteƒüi red i√ßin Worker'ƒ± ba≈ülat
         */
        fun enqueueBuddyReject(context: Context, requestId: String) {
            val inputData = workDataOf(
                KEY_ACTION to ACTION_BUDDY_REJECT,
                KEY_REQUEST_ID to requestId
            )

            enqueueWork(context, "buddy_reject_$requestId", inputData)
        }

        private fun enqueueWork(context: Context, uniqueWorkName: String, inputData: Data) {
            // Network constraint YOK - Firestore offline persistence kullanƒ±r
            // ƒ∞nternet yoksa cache'e yazar, gelince otomatik sync olur
            val workRequest = OneTimeWorkRequestBuilder<MedicationSyncWorker>()
                .setInputData(inputData)
                .setBackoffCriteria(
                    BackoffPolicy.EXPONENTIAL,
                    WorkRequest.MIN_BACKOFF_MILLIS,
                    TimeUnit.MILLISECONDS
                )
                .build()

            WorkManager.getInstance(context)
                .enqueueUniqueWork(
                    uniqueWorkName,
                    ExistingWorkPolicy.REPLACE,
                    workRequest
                )

            Log.d(TAG, "‚úÖ Work enqueued: $uniqueWorkName")
        }
    }

    override suspend fun doWork(): Result = withContext(Dispatchers.IO) {
        val action = inputData.getString(KEY_ACTION) ?: return@withContext Result.failure()

        Log.d(TAG, "üîÑ Processing action: $action")

        return@withContext try {
            when (action) {
                ACTION_LOG_TAKEN -> handleLogTaken()
                ACTION_LOG_SKIPPED -> handleLogSkipped()
                ACTION_LOG_SNOOZED -> handleLogSnoozed()
                ACTION_BUDDY_ACCEPT -> handleBuddyAccept()
                ACTION_BUDDY_REJECT -> handleBuddyReject()
                else -> {
                    Log.e(TAG, "‚ùå Unknown action: $action")
                    Result.failure()
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Worker failed", e)
            if (runAttemptCount < 3) {
                Result.retry()
            } else {
                Result.failure()
            }
        }
    }

    private suspend fun handleLogTaken(): Result {
        val medicineId = inputData.getString(KEY_MEDICINE_ID) ?: return Result.failure()
        val medicineName = inputData.getString(KEY_MEDICINE_NAME) ?: return Result.failure()
        val dosage = inputData.getString(KEY_DOSAGE) ?: ""
        val scheduledTime = inputData.getLong(KEY_SCHEDULED_TIME, 0L)
        val takenTime = inputData.getLong(KEY_TAKEN_TIME, System.currentTimeMillis())

        val medicationLogRepository = MedicationLogRepository(
            applicationContext,
            FirebaseAuth.getInstance(),
            FirebaseFirestore.getInstance()
        )

        medicationLogRepository.logMedicationTaken(
            medicineId = medicineId,
            medicineName = medicineName,
            dosage = dosage,
            scheduledTime = scheduledTime
        )

        // Gecikme pattern'ini kaydet
        SmartReminderHelper.recordDelayPattern(
            context = applicationContext,
            medicineId = medicineId,
            scheduledTime = scheduledTime,
            takenTime = takenTime
        )

        Log.d(TAG, "‚úÖ Medication TAKEN logged: $medicineName")
        return Result.success()
    }

    private suspend fun handleLogSkipped(): Result {
        val medicineId = inputData.getString(KEY_MEDICINE_ID) ?: return Result.failure()
        val medicineName = inputData.getString(KEY_MEDICINE_NAME) ?: return Result.failure()
        val dosage = inputData.getString(KEY_DOSAGE) ?: ""
        val scheduledTime = inputData.getLong(KEY_SCHEDULED_TIME, 0L)
        val reason = inputData.getString(KEY_SKIP_REASON) ?: "Kullanƒ±cƒ± atladƒ±"

        val medicationLogRepository = MedicationLogRepository(
            applicationContext,
            FirebaseAuth.getInstance(),
            FirebaseFirestore.getInstance()
        )

        medicationLogRepository.logMedicationSkipped(
            medicineId = medicineId,
            medicineName = medicineName,
            dosage = dosage,
            scheduledTime = scheduledTime,
            reason = reason
        )

        Log.d(TAG, "‚úÖ Medication SKIPPED logged: $medicineName")
        return Result.success()
    }

    private suspend fun handleLogSnoozed(): Result {
        val medicineId = inputData.getString(KEY_MEDICINE_ID) ?: return Result.failure()
        val medicineName = inputData.getString(KEY_MEDICINE_NAME) ?: return Result.failure()
        val dosage = inputData.getString(KEY_DOSAGE) ?: ""
        val scheduledTime = inputData.getLong(KEY_SCHEDULED_TIME, 0L)
        val snoozeMinutes = inputData.getInt(KEY_SNOOZE_MINUTES, 10)

        val medicationLogRepository = MedicationLogRepository(
            applicationContext,
            FirebaseAuth.getInstance(),
            FirebaseFirestore.getInstance()
        )

        medicationLogRepository.logMedicationSnoozed(
            medicineId = medicineId,
            medicineName = medicineName,
            dosage = dosage,
            scheduledTime = scheduledTime,
            snoozeMinutes = snoozeMinutes
        )

        Log.d(TAG, "‚úÖ Medication SNOOZED logged: $medicineName")
        return Result.success()
    }

    private suspend fun handleBuddyAccept(): Result {
        val requestId = inputData.getString(KEY_REQUEST_ID) ?: return Result.failure()

        val buddyRepository = BadiRepository()
        val result = buddyRepository.acceptBadiRequest(requestId)

        return if (result.isSuccess) {
            Log.d(TAG, "‚úÖ Buddy request accepted: $requestId")
            Result.success()
        } else {
            Log.e(TAG, "‚ùå Buddy accept failed: ${result.exceptionOrNull()?.message}")
            Result.retry()
        }
    }

    private suspend fun handleBuddyReject(): Result {
        val requestId = inputData.getString(KEY_REQUEST_ID) ?: return Result.failure()

        val buddyRepository = BadiRepository()
        val result = buddyRepository.rejectBadiRequest(requestId)

        return if (result.isSuccess) {
            Log.d(TAG, "‚úÖ Buddy request rejected: $requestId")
            Result.success()
        } else {
            Log.e(TAG, "‚ùå Buddy reject failed: ${result.exceptionOrNull()?.message}")
            Result.retry()
        }
    }
}

// ============================================================================
// FILE: NotificationActionReceiver.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/notifications/NotificationActionReceiver.kt
// [114 of 122]
// ============================================================================

package com.bardino.dozi.notifications

import android.Manifest
import android.app.AlarmManager
import android.app.PendingIntent
import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import android.content.SharedPreferences
import android.content.pm.PackageManager
import android.media.RingtoneManager
import android.os.Build
import android.os.VibrationEffect
import android.os.Vibrator
import android.speech.tts.TextToSpeech
import android.widget.Toast
import androidx.annotation.RequiresPermission
import androidx.core.app.ActivityCompat
import androidx.core.app.NotificationManagerCompat
import androidx.core.content.ContextCompat
import androidx.core.content.edit
import com.bardino.dozi.DoziApplication
import com.bardino.dozi.core.utils.SoundHelper
import com.bardino.dozi.core.utils.EscalationManager
import com.bardino.dozi.core.data.repository.BadiRepository
import com.bardino.dozi.core.data.repository.MedicationLogRepository
import com.bardino.dozi.core.data.repository.MedicineRepository
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch

class NotificationActionReceiver : BroadcastReceiver() {

    private var tts: TextToSpeech? = null

    @RequiresPermission(Manifest.permission.POST_NOTIFICATIONS)
    override fun onReceive(context: Context, intent: Intent) {
        val med = intent.getStringExtra(NotificationHelper.EXTRA_MEDICINE) ?: "ƒ∞la√ß"
        val medicineId = intent.getStringExtra(NotificationHelper.EXTRA_MEDICINE_ID) ?: ""
        val dosage = intent.getStringExtra(NotificationHelper.EXTRA_DOSAGE) ?: ""
        val time = intent.getStringExtra(NotificationHelper.EXTRA_TIME) ?: "Bilinmiyor"
        val scheduledTime = intent.getLongExtra(NotificationHelper.EXTRA_SCHEDULED_TIME, System.currentTimeMillis())
        val prefs = context.getSharedPreferences("dozi_prefs", Context.MODE_PRIVATE)
        val nm = NotificationManagerCompat.from(context)

        when (intent.action) {
            NotificationHelper.ACTION_TAKEN -> handleTaken(context, med, medicineId, dosage, time, scheduledTime, prefs, nm)
            NotificationHelper.ACTION_SKIP -> handleSkip(context, med, medicineId, dosage, time, scheduledTime, prefs, nm)
            NotificationHelper.ACTION_SNOOZE -> handleSnooze(context, med, medicineId, dosage, time, scheduledTime, nm)
            NotificationHelper.ACTION_BUDDY_ACCEPT -> {
                val requestId = intent.getStringExtra(NotificationHelper.EXTRA_REQUEST_ID) ?: return
                val fromUserName = intent.getStringExtra(NotificationHelper.EXTRA_FROM_USER_NAME) ?: "Kullanƒ±cƒ±"
                handleBuddyAccept(context, requestId, fromUserName, nm)
            }
            NotificationHelper.ACTION_BUDDY_REJECT -> {
                val requestId = intent.getStringExtra(NotificationHelper.EXTRA_REQUEST_ID) ?: return
                val fromUserName = intent.getStringExtra(NotificationHelper.EXTRA_FROM_USER_NAME) ?: "Kullanƒ±cƒ±"
                handleBuddyReject(context, requestId, fromUserName, nm)
            }
            "ACTION_SNOOZE_TRIGGER" -> {
                // ‚è∞ Erteleme s√ºresi doldu, yeni bildirim g√∂ster + escalation/auto-missed planla
                if (hasNotificationPermission(context)) {
                    // üìÖ Medicine bilgisini al ve endDate kontrol√º yap
                    CoroutineScope(Dispatchers.IO).launch {
                        try {
                            val medicineRepository = com.bardino.dozi.core.data.repository.MedicineRepository()
                            val medicine = medicineRepository.getMedicineById(medicineId)

                            // Biti≈ü tarihi kontrol√º
                            if (medicine?.endDate != null && medicine.endDate < System.currentTimeMillis()) {
                                android.util.Log.d("NotificationActionReceiver", "‚è±Ô∏è Biti≈ü tarihi ge√ßmi≈ü: $med. Erteleme bildirimi g√∂sterilmiyor.")
                                return@launch
                            }

                            // üî• Kritik ila√ß kontrol√º
                            val isCritical = medicine?.criticalityLevel == com.bardino.dozi.core.data.model.MedicineCriticality.CRITICAL
                            NotificationHelper.showMedicationNotification(
                                context = context,
                                medicineName = med,
                                medicineId = medicineId,
                                dosage = dosage,
                                time = time,
                                scheduledTime = scheduledTime,
                                isCritical = isCritical
                            )

                            // ‚è∞ Escalation sistemi: 10dk, 30dk, 60dk (endDate ge√ßmemi≈üse)
                            if (medicineId.isNotEmpty() && (medicine?.endDate == null || medicine.endDate > System.currentTimeMillis())) {
                                scheduleEscalation1(context, medicineId, med, dosage, time, scheduledTime) // 10 dk
                                scheduleEscalation2(context, medicineId, med, dosage, time, scheduledTime) // 30 dk
                                scheduleEscalation3(context, medicineId, med, dosage, time, scheduledTime) // 60 dk
                            }

                            android.util.Log.d("NotificationActionReceiver", "‚è∞ Erteleme sonrasƒ± bildirim + escalation/auto-missed planlandƒ±: $med")
                        } catch (e: Exception) {
                            android.util.Log.e("NotificationActionReceiver", "‚ùå Erteleme tetiklemesi i≈ülenirken hata", e)
                        }
                    }
                }
            }
            ReminderScheduler.ACTION_REMINDER_TRIGGER -> {
                // üîî Zamanlanmƒ±≈ü hatƒ±rlatma tetiklendi
                val medicineId = intent.getStringExtra(ReminderScheduler.EXTRA_MEDICINE_ID) ?: return
                val medicineName = intent.getStringExtra(ReminderScheduler.EXTRA_MEDICINE_NAME) ?: "ƒ∞la√ß"
                val reminderTime = intent.getStringExtra(ReminderScheduler.EXTRA_TIME) ?: ""

                handleReminderTrigger(context, medicineId, medicineName, reminderTime, nm)
            }
            "ACTION_ESCALATION_1" -> {
                // ‚è∞ Escalation Level 1 (10 dakika sonra)
                if (hasNotificationPermission(context) && medicineId.isNotEmpty()) {
                    // üî• FIX: ƒ∞la√ß zaten alƒ±ndƒ± mƒ± kontrol et
                    CoroutineScope(Dispatchers.IO).launch {
                        try {
                            val medicationLogRepository = MedicationLogRepository(
                                context,
                                FirebaseAuth.getInstance(),
                                FirebaseFirestore.getInstance()
                            )

                            val alreadyLogged = medicationLogRepository.isMedicationLoggedForTime(
                                medicineId = medicineId,
                                scheduledTime = scheduledTime
                            )

                            if (alreadyLogged) {
                                android.util.Log.d("NotificationActionReceiver", "‚è≠Ô∏è Escalation 1 atlandƒ± - ila√ß zaten loglandƒ±: $med")
                                return@launch
                            }

                            NotificationHelper.showEscalationLevel1Notification(
                                context = context,
                                medicineName = med,
                                medicineId = medicineId,
                                dosage = dosage,
                                time = time,
                                scheduledTime = scheduledTime
                            )
                            android.util.Log.d("NotificationActionReceiver", "‚è∞ Escalation Level 1 bildirimi g√∂sterildi: $med")
                        } catch (e: Exception) {
                            android.util.Log.e("NotificationActionReceiver", "‚ùå Escalation 1 hatasƒ±", e)
                        }
                    }
                }
            }
            "ACTION_ESCALATION_2" -> {
                // üö® Escalation Level 2 (30 dakika sonra - kƒ±rmƒ±zƒ±, urgent)
                if (hasNotificationPermission(context) && medicineId.isNotEmpty()) {
                    // üî• FIX: ƒ∞la√ß zaten alƒ±ndƒ± mƒ± kontrol et
                    CoroutineScope(Dispatchers.IO).launch {
                        try {
                            val medicationLogRepository = MedicationLogRepository(
                                context,
                                FirebaseAuth.getInstance(),
                                FirebaseFirestore.getInstance()
                            )

                            val alreadyLogged = medicationLogRepository.isMedicationLoggedForTime(
                                medicineId = medicineId,
                                scheduledTime = scheduledTime
                            )

                            if (alreadyLogged) {
                                android.util.Log.d("NotificationActionReceiver", "‚è≠Ô∏è Escalation 2 atlandƒ± - ila√ß zaten loglandƒ±: $med")
                                return@launch
                            }

                            NotificationHelper.showEscalationLevel2Notification(
                                context = context,
                                medicineName = med,
                                medicineId = medicineId,
                                dosage = dosage,
                                time = time,
                                scheduledTime = scheduledTime
                            )
                            android.util.Log.d("NotificationActionReceiver", "üö® Escalation Level 2 bildirimi g√∂sterildi: $med")
                        } catch (e: Exception) {
                            android.util.Log.e("NotificationActionReceiver", "‚ùå Escalation 2 hatasƒ±", e)
                        }
                    }
                }
            }
            "ACTION_ESCALATION_3" -> {
                // üî¥ Escalation Level 3 (60 dakika sonra - IMPORTANT)
                if (hasNotificationPermission(context) && medicineId.isNotEmpty()) {
                    // üî• FIX: ƒ∞la√ß zaten alƒ±ndƒ± mƒ± kontrol et
                    CoroutineScope(Dispatchers.IO).launch {
                        try {
                            val medicationLogRepository = MedicationLogRepository(
                                context,
                                FirebaseAuth.getInstance(),
                                FirebaseFirestore.getInstance()
                            )

                            val alreadyLogged = medicationLogRepository.isMedicationLoggedForTime(
                                medicineId = medicineId,
                                scheduledTime = scheduledTime
                            )

                            if (alreadyLogged) {
                                android.util.Log.d("NotificationActionReceiver", "‚è≠Ô∏è Escalation 3 atlandƒ± - ila√ß zaten loglandƒ±: $med")
                                return@launch
                            }

                            NotificationHelper.showEscalationLevel3Notification(
                                context = context,
                                medicineName = med,
                                medicineId = medicineId,
                                dosage = dosage,
                                time = time,
                                scheduledTime = scheduledTime
                            )
                            android.util.Log.d("NotificationActionReceiver", "üî¥ Escalation Level 3 bildirimi g√∂sterildi: $med")

                            // ƒ∞lacƒ± MISSED olarak logla
                            medicationLogRepository.logMedicationMissed(
                                medicineId = medicineId,
                                medicineName = med,
                                dosage = dosage,
                                scheduledTime = scheduledTime,
                                reason = "1 saat boyunca cevap verilmedi"
                            )
                            android.util.Log.d("NotificationActionReceiver", "‚ùå ƒ∞la√ß MISSED olarak loglandƒ±: $med")

                            // Kritik ila√ß ise buddy'lere bildir
                            val medicineRepository = MedicineRepository()
                            val medicine = medicineRepository.getMedicineById(medicineId)
                            if (medicine != null) {
                                val escalationManager = EscalationManager(context)
                                escalationManager.notifyBuddiesForSingleCriticalMedicine(medicine)
                                android.util.Log.d("NotificationActionReceiver", "üö® Buddy bildirimi g√∂nderildi: $med")
                            }
                        } catch (e: Exception) {
                            android.util.Log.e("NotificationActionReceiver", "‚ùå Escalation 3 hatasƒ±: ${e.message}", e)
                        }
                    }
                }
            }
        }
    }

    private fun handleTaken(
        context: Context,
        medicineName: String,
        medicineId: String,
        dosage: String,
        time: String,
        scheduledTime: Long,
        prefs: SharedPreferences,
        nm: NotificationManagerCompat
    ) {
        val takenTime = System.currentTimeMillis()

        prefs.edit {
            putString("last_action", "ALINDI:$medicineName")
            putLong("last_taken_time", takenTime)
            putString("last_medicine", medicineName)
        }

        // üö´ Aynƒ± ilaca ait T√úM bildirimleri iptal et
        NotificationHelper.cancelAllNotificationsForMedicine(context, medicineId, time)

        // ‚úÖ MedicationLog'a kaydet (WorkManager ile garantili)
        if (medicineId.isNotEmpty()) {
            MedicationSyncWorker.enqueueLogTaken(
                context = context,
                medicineId = medicineId,
                medicineName = medicineName,
                dosage = dosage,
                scheduledTime = scheduledTime,
                takenTime = takenTime
            )
            android.util.Log.d("NotificationActionReceiver", "‚úÖ MedicationLog WorkManager'a enqueue edildi: TAKEN")

            // ƒ∞ptal: T√ºm escalation alarmlarƒ±
            cancelAllEscalations(context, medicineId, time)

            // üî• FIX: Bu saat i√ßin planlanmƒ±≈ü reminder alarmƒ±nƒ± iptal et
            ReminderScheduler.cancelReminders(context, medicineId, listOf(time))
            android.util.Log.d("NotificationActionReceiver", "üîï Reminder alarm iptal edildi: $medicineId @ $time")
        }

        showToast(context, "$medicineName alƒ±ndƒ± olarak i≈üaretlendi ‚úÖ")

        // ‚úÖ Kullanƒ±cƒ±nƒ±n ses se√ßimine g√∂re ba≈üarƒ± sesi
        SoundHelper.playSound(context, SoundHelper.SoundType.HERSEY_TAMAM)
    }


    private fun handleSkip(
        context: Context,
        medicineName: String,
        medicineId: String,
        dosage: String,
        time: String,
        scheduledTime: Long,
        prefs: SharedPreferences,
        nm: NotificationManagerCompat
    ) {
        prefs.edit {
            putString("last_action", "ATLANDI:$medicineName")
            putLong("last_skip_time", System.currentTimeMillis())
        }

        // üö´ Aynƒ± ilaca ait T√úM bildirimleri iptal et
        NotificationHelper.cancelAllNotificationsForMedicine(context, medicineId, time)

        // ‚úÖ MedicationLog'a kaydet (WorkManager ile garantili)
        if (medicineId.isNotEmpty()) {
            MedicationSyncWorker.enqueueLogSkipped(
                context = context,
                medicineId = medicineId,
                medicineName = medicineName,
                dosage = dosage,
                scheduledTime = scheduledTime,
                reason = "Kullanƒ±cƒ± atladƒ±"
            )
            android.util.Log.d("NotificationActionReceiver", "‚úÖ MedicationLog WorkManager'a enqueue edildi: SKIPPED")

            // ƒ∞ptal: T√ºm escalation alarmlarƒ±
            cancelAllEscalations(context, medicineId, time)

            // üî• FIX: Bu saat i√ßin planlanmƒ±≈ü reminder alarmƒ±nƒ± iptal et
            ReminderScheduler.cancelReminders(context, medicineId, listOf(time))
            android.util.Log.d("NotificationActionReceiver", "üîï Reminder alarm iptal edildi: $medicineId @ $time")
        }

        showToast(context, "$medicineName atlandƒ± üö´")

        // ‚úÖ Kullanƒ±cƒ±nƒ±n ses se√ßimine g√∂re atla sesi
        SoundHelper.playSound(context, SoundHelper.SoundType.PEKALA)
    }


    private fun handleSnooze(
        context: Context,
        medicineName: String,
        medicineId: String,
        dosage: String,
        time: String,
        scheduledTime: Long,
        nm: NotificationManagerCompat
    ) {
        // üö´ Aynƒ± ilaca ait T√úM bildirimleri iptal et
        NotificationHelper.cancelAllNotificationsForMedicine(context, medicineId, time)

        // ‚úÖ MedicationLog'a kaydet (WorkManager ile garantili)
        if (medicineId.isNotEmpty()) {
            MedicationSyncWorker.enqueueLogSnoozed(
                context = context,
                medicineId = medicineId,
                medicineName = medicineName,
                dosage = dosage,
                scheduledTime = scheduledTime,
                snoozeMinutes = 10
            )
            android.util.Log.d("NotificationActionReceiver", "‚úÖ MedicationLog WorkManager'a enqueue edildi: SNOOZED")

            // üî• FIX: Erteleme se√ßilince t√ºm escalation alarmlarƒ±nƒ± iptal et
            cancelAllEscalations(context, medicineId, time)
        }

        // Ses √ßal
        SoundHelper.playSound(context, SoundHelper.SoundType.ERTELE)

        // Yeni activity a√ß
        val intent = Intent(context, SnoozePromptActivity::class.java).apply {
            putExtra("medicine", medicineName)
            putExtra("medicineId", medicineId)
            putExtra("dosage", dosage)
            putExtra("time", time)
            putExtra("scheduledTime", scheduledTime)
            addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
        }
        context.startActivity(intent)
    }


    private fun handleBuddyAccept(
        context: Context,
        requestId: String,
        fromUserName: String,
        nm: NotificationManagerCompat
    ) {
        // Bildirimi kapat
        nm.cancel(requestId.hashCode())

        // Badi isteƒüini kabul et (WorkManager ile garantili)
        MedicationSyncWorker.enqueueBuddyAccept(context, requestId)
        showToast(context, "‚úÖ $fromUserName buddy isteƒüi i≈üleniyor...")
        android.util.Log.d("NotificationActionReceiver", "‚úÖ Buddy accept WorkManager'a enqueue edildi: $requestId")
    }

    private fun handleBuddyReject(
        context: Context,
        requestId: String,
        fromUserName: String,
        nm: NotificationManagerCompat
    ) {
        // Bildirimi kapat
        nm.cancel(requestId.hashCode())

        // Badi isteƒüini reddet (WorkManager ile garantili)
        MedicationSyncWorker.enqueueBuddyReject(context, requestId)
        showToast(context, "üö´ $fromUserName buddy isteƒüi reddediliyor...")
        android.util.Log.d("NotificationActionReceiver", "‚úÖ Buddy reject WorkManager'a enqueue edildi: $requestId")
    }

    @androidx.annotation.RequiresPermission(android.Manifest.permission.POST_NOTIFICATIONS)
    private fun handleReminderTrigger(
        context: Context,
        medicineId: String,
        medicineName: String,
        time: String,
        nm: NotificationManagerCompat
    ) {
        android.util.Log.d("NotificationActionReceiver", "üîî Hatƒ±rlatma tetiklendi: $medicineName ($time)")

        // Bildirim izni kontrol√º
        if (!hasNotificationPermission(context)) {
            android.util.Log.w("NotificationActionReceiver", "‚ö†Ô∏è Bildirim izni yok")
            return
        }

        // Medicine bilgilerini al
        CoroutineScope(Dispatchers.IO).launch {
            try {
                val medicineRepository = com.bardino.dozi.core.data.repository.MedicineRepository()
                val medicine = medicineRepository.getMedicine(medicineId)

                if (medicine != null) {
                    // scheduledTime hesapla (bug√ºn√ºn bu saati)
                    val (hour, minute) = time.split(":").map { it.toInt() }
                    val calendar = java.util.Calendar.getInstance().apply {
                        set(java.util.Calendar.HOUR_OF_DAY, hour)
                        set(java.util.Calendar.MINUTE, minute)
                        set(java.util.Calendar.SECOND, 0)
                        set(java.util.Calendar.MILLISECOND, 0)
                    }
                    val scheduledTime = calendar.timeInMillis

                    // üî• FIX: ƒ∞la√ß zaten alƒ±ndƒ±/atlandƒ±/ertelendi mi kontrol et
                    // Bu kontrol, kullanƒ±cƒ± uygulamadan "Aldƒ±m" i≈üaretlediyse bildirimi engeller
                    val medicationLogRepository = MedicationLogRepository(context)
                    val alreadyLogged = medicationLogRepository.isMedicationLoggedForTime(medicineId, scheduledTime)

                    if (alreadyLogged) {
                        android.util.Log.d("NotificationActionReceiver", "‚úÖ ƒ∞la√ß zaten i≈ülendi, bildirim g√∂sterilmiyor: $medicineName ($time)")
                        // Sonraki alarmƒ± yine de planla
                        if (medicine.reminderEnabled) {
                            if (medicine.endDate == null || medicine.endDate > System.currentTimeMillis()) {
                                ReminderScheduler.scheduleReminders(context, medicine, isRescheduling = true)
                                android.util.Log.d("NotificationActionReceiver", "‚úÖ Sonraki alarm planlandƒ± (ila√ß zaten alƒ±ndƒ±): $medicineName")
                            }
                        }
                        return@launch
                    }

                    // Bildirim g√∂ster (medicineId, dosage, time note ve reminderName ile)
                    if (hasNotificationPermission(context)) {
                        val timeNote = parseTimeNoteFromMedicine(medicine.notes, time)
                        // üî• Kritik ila√ß kontrol√º
                        val isCritical = medicine.criticalityLevel == com.bardino.dozi.core.data.model.MedicineCriticality.CRITICAL
                        NotificationHelper.showMedicationNotification(
                            context = context,
                            medicineName = medicine.name,
                            medicineId = medicine.id,
                            dosage = "${medicine.dosage} ${medicine.unit}",
                            time = time,
                            scheduledTime = scheduledTime,
                            timeNote = timeNote,
                            reminderName = medicine.reminderName,
                            isCritical = isCritical
                        )
                    }

                    // üîÑ Sonraki alarmƒ± planla (frequency'ye g√∂re)
                    // üìÖ Biti≈ü tarihi kontrol√º: endDate ge√ßmi≈üse sonraki alarmƒ± planlama
                    if (medicine.reminderEnabled) {
                        if (medicine.endDate != null && medicine.endDate < System.currentTimeMillis()) {
                            android.util.Log.d("NotificationActionReceiver", "‚è±Ô∏è Biti≈ü tarihi ge√ßmi≈ü: $medicineName. Sonraki alarm planlanmƒ±yor.")
                        } else {
                            ReminderScheduler.scheduleReminders(context, medicine, isRescheduling = true)
                            android.util.Log.d("NotificationActionReceiver", "‚úÖ Sonraki alarm planlandƒ±: $medicineName (frequency: ${medicine.frequency})")
                        }
                    }

                    // ‚è∞ Escalation sistemi: 10dk, 30dk, 60dk
                    // üìÖ Biti≈ü tarihi kontrol√º: endDate ge√ßmi≈üse escalation da planlanmasƒ±n
                    if (medicine.endDate == null || medicine.endDate > System.currentTimeMillis()) {
                        scheduleEscalation1(context, medicineId, medicineName, medicine.dosage + " " + medicine.unit, time, scheduledTime)
                        scheduleEscalation2(context, medicineId, medicineName, medicine.dosage + " " + medicine.unit, time, scheduledTime)
                        scheduleEscalation3(context, medicineId, medicineName, medicine.dosage + " " + medicine.unit, time, scheduledTime)
                    }
                }
            } catch (e: Exception) {
                android.util.Log.e("NotificationActionReceiver", "‚ùå Hatƒ±rlatma i≈ülenirken hata", e)
            }
        }
    }


    private fun hasNotificationPermission(context: Context): Boolean {
        return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            ContextCompat.checkSelfPermission(
                context,
                Manifest.permission.POST_NOTIFICATIONS
            ) == PackageManager.PERMISSION_GRANTED
        } else true
    }

    private fun showToast(context: Context, message: String) {
        Toast.makeText(context, message, Toast.LENGTH_SHORT).show()
    }

    private fun playSuccessSoundSafe(context: Context) {
        try {
            if (ActivityCompat.checkSelfPermission(
                    context,
                    Manifest.permission.POST_NOTIFICATIONS
                ) == PackageManager.PERMISSION_GRANTED || Build.VERSION.SDK_INT < Build.VERSION_CODES.TIRAMISU
            ) {
                val notification = RingtoneManager.getDefaultUri(RingtoneManager.TYPE_NOTIFICATION)
                RingtoneManager.getRingtone(context, notification)?.play()
            }
        } catch (e: SecurityException) {
            e.printStackTrace()
        }
    }

    private fun vibrateDevice(context: Context, duration: Long = 200) {
        val vibrator = ContextCompat.getSystemService(context, Vibrator::class.java)
        vibrator?.let {
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                it.vibrate(VibrationEffect.createOneShot(duration, VibrationEffect.DEFAULT_AMPLITUDE))
            } else {
                @Suppress("DEPRECATION")
                it.vibrate(duration)
            }
        }
    }

    /**
     * ‚è∞ Escalation Level 1: 10 dakika sonra hatƒ±rlat
     */
    private fun scheduleEscalation1(
        context: Context,
        medicineId: String,
        medicineName: String,
        dosage: String,
        time: String,
        scheduledTime: Long
    ) {
        val alarmManager = context.getSystemService(Context.ALARM_SERVICE) as AlarmManager
        val escalationTime = System.currentTimeMillis() + (10 * 60 * 1000) // 10 dakika sonra

        val intent = Intent(context, NotificationActionReceiver::class.java).apply {
            action = "ACTION_ESCALATION_1"
            putExtra(NotificationHelper.EXTRA_MEDICINE_ID, medicineId)
            putExtra(NotificationHelper.EXTRA_MEDICINE, medicineName)
            putExtra(NotificationHelper.EXTRA_DOSAGE, dosage)
            putExtra(NotificationHelper.EXTRA_TIME, time)
            putExtra(NotificationHelper.EXTRA_SCHEDULED_TIME, scheduledTime)
        }

        val requestCode = "escalation1_${medicineId}_$time".hashCode()
        val pendingIntent = PendingIntent.getBroadcast(
            context,
            requestCode,
            intent,
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
                PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
            } else {
                PendingIntent.FLAG_UPDATE_CURRENT
            }
        )

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            alarmManager.setExactAndAllowWhileIdle(AlarmManager.RTC_WAKEUP, escalationTime, pendingIntent)
        } else {
            alarmManager.setExact(AlarmManager.RTC_WAKEUP, escalationTime, pendingIntent)
        }

        android.util.Log.d("NotificationActionReceiver", "‚è∞ Escalation Level 1 planlandƒ±: $medicineName - 10 dk sonra")
    }

    /**
     * üö® Escalation Level 2: 30 dakika sonra hatƒ±rlat (kƒ±rmƒ±zƒ±, urgent)
     */
    private fun scheduleEscalation2(
        context: Context,
        medicineId: String,
        medicineName: String,
        dosage: String,
        time: String,
        scheduledTime: Long
    ) {
        val alarmManager = context.getSystemService(Context.ALARM_SERVICE) as AlarmManager
        val escalationTime = System.currentTimeMillis() + (30 * 60 * 1000) // 30 dakika sonra

        val intent = Intent(context, NotificationActionReceiver::class.java).apply {
            action = "ACTION_ESCALATION_2"
            putExtra(NotificationHelper.EXTRA_MEDICINE_ID, medicineId)
            putExtra(NotificationHelper.EXTRA_MEDICINE, medicineName)
            putExtra(NotificationHelper.EXTRA_DOSAGE, dosage)
            putExtra(NotificationHelper.EXTRA_TIME, time)
            putExtra(NotificationHelper.EXTRA_SCHEDULED_TIME, scheduledTime)
        }

        val requestCode = "escalation2_${medicineId}_$time".hashCode()
        val pendingIntent = PendingIntent.getBroadcast(
            context,
            requestCode,
            intent,
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
                PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
            } else {
                PendingIntent.FLAG_UPDATE_CURRENT
            }
        )

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            alarmManager.setExactAndAllowWhileIdle(AlarmManager.RTC_WAKEUP, escalationTime, pendingIntent)
        } else {
            alarmManager.setExact(AlarmManager.RTC_WAKEUP, escalationTime, pendingIntent)
        }

        android.util.Log.d("NotificationActionReceiver", "üö® Escalation Level 2 planlandƒ±: $medicineName - 30 dk sonra")
    }

    /**
     * üî¥ Escalation Level 3: 60 dakika sonra hatƒ±rlat (IMPORTANT)
     * Sadece kullanƒ±cƒ± ayarƒ± a√ßƒ±ksa planlanƒ±r
     */
    private fun scheduleEscalation3(
        context: Context,
        medicineId: String,
        medicineName: String,
        dosage: String,
        time: String,
        scheduledTime: Long
    ) {
        // Kullanƒ±cƒ± ayarƒ±nƒ± kontrol et
        CoroutineScope(Dispatchers.IO).launch {
            try {
                val userRepository = com.bardino.dozi.core.data.repository.UserRepository()
                val user = userRepository.getUserData()

                // √ñnemli bildirimler kapalƒ±ysa Level 3'√º planlama
                if (user?.importantNotificationsEnabled == false) {
                    android.util.Log.d("NotificationActionReceiver", "‚öôÔ∏è √ñnemli bildirimler kapalƒ±, Level 3 planlanmadƒ±: $medicineName")
                    return@launch
                }

                val alarmManager = context.getSystemService(Context.ALARM_SERVICE) as AlarmManager
                val escalationTime = System.currentTimeMillis() + (60 * 60 * 1000) // 60 dakika sonra

                val intent = Intent(context, NotificationActionReceiver::class.java).apply {
                    action = "ACTION_ESCALATION_3"
                    putExtra(NotificationHelper.EXTRA_MEDICINE_ID, medicineId)
                    putExtra(NotificationHelper.EXTRA_MEDICINE, medicineName)
                    putExtra(NotificationHelper.EXTRA_DOSAGE, dosage)
                    putExtra(NotificationHelper.EXTRA_TIME, time)
                    putExtra(NotificationHelper.EXTRA_SCHEDULED_TIME, scheduledTime)
                }

                val requestCode = "escalation3_${medicineId}_$time".hashCode()
                val pendingIntent = PendingIntent.getBroadcast(
                    context,
                    requestCode,
                    intent,
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
                        PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
                    } else {
                        PendingIntent.FLAG_UPDATE_CURRENT
                    }
                )

                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                    alarmManager.setExactAndAllowWhileIdle(AlarmManager.RTC_WAKEUP, escalationTime, pendingIntent)
                } else {
                    alarmManager.setExact(AlarmManager.RTC_WAKEUP, escalationTime, pendingIntent)
                }

                android.util.Log.d("NotificationActionReceiver", "üî¥ Escalation Level 3 planlandƒ±: $medicineName - 60 dk sonra")
            } catch (e: Exception) {
                android.util.Log.e("NotificationActionReceiver", "‚ùå Level 3 planlanƒ±rken hata", e)
            }
        }
    }

    /**
     * üö´ T√ºm escalation alarmlarƒ±nƒ± iptal et
     * IMPORTANT: Intent extras dahil tamamen e≈üle≈ümeli, yoksa iptal edilmez!
     */
    private fun cancelAllEscalations(context: Context, medicineId: String, time: String) {
        val alarmManager = context.getSystemService(Context.ALARM_SERVICE) as AlarmManager

        // RequestCode ile iptal etmek i√ßin FLAG_NO_CREATE kullan
        // Bu sayede Intent extras'a bakƒ±lmaz, sadece requestCode e≈üle≈üir

        // Escalation 1 iptal
        val esc1Intent = Intent(context, NotificationActionReceiver::class.java).apply {
            action = "ACTION_ESCALATION_1"
        }
        val esc1RequestCode = "escalation1_${medicineId}_$time".hashCode()
        val esc1PendingIntent = PendingIntent.getBroadcast(
            context,
            esc1RequestCode,
            esc1Intent,
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
                PendingIntent.FLAG_NO_CREATE or PendingIntent.FLAG_IMMUTABLE
            } else {
                PendingIntent.FLAG_NO_CREATE
            }
        )
        if (esc1PendingIntent != null) {
            alarmManager.cancel(esc1PendingIntent)
            esc1PendingIntent.cancel()
            android.util.Log.d("NotificationActionReceiver", "‚úÖ Escalation 1 iptal edildi: $medicineId")
        }

        // Escalation 2 iptal
        val esc2Intent = Intent(context, NotificationActionReceiver::class.java).apply {
            action = "ACTION_ESCALATION_2"
        }
        val esc2RequestCode = "escalation2_${medicineId}_$time".hashCode()
        val esc2PendingIntent = PendingIntent.getBroadcast(
            context,
            esc2RequestCode,
            esc2Intent,
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
                PendingIntent.FLAG_NO_CREATE or PendingIntent.FLAG_IMMUTABLE
            } else {
                PendingIntent.FLAG_NO_CREATE
            }
        )
        if (esc2PendingIntent != null) {
            alarmManager.cancel(esc2PendingIntent)
            esc2PendingIntent.cancel()
            android.util.Log.d("NotificationActionReceiver", "‚úÖ Escalation 2 iptal edildi: $medicineId")
        }

        // Escalation 3 iptal
        val esc3Intent = Intent(context, NotificationActionReceiver::class.java).apply {
            action = "ACTION_ESCALATION_3"
        }
        val esc3RequestCode = "escalation3_${medicineId}_$time".hashCode()
        val esc3PendingIntent = PendingIntent.getBroadcast(
            context,
            esc3RequestCode,
            esc3Intent,
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
                PendingIntent.FLAG_NO_CREATE or PendingIntent.FLAG_IMMUTABLE
            } else {
                PendingIntent.FLAG_NO_CREATE
            }
        )
        if (esc3PendingIntent != null) {
            alarmManager.cancel(esc3PendingIntent)
            esc3PendingIntent.cancel()
            android.util.Log.d("NotificationActionReceiver", "‚úÖ Escalation 3 iptal edildi: $medicineId")
        }

        android.util.Log.d("NotificationActionReceiver", "üö´ T√ºm escalation alarmlarƒ± iptal edildi: $medicineId - $time")
    }

    override fun toString(): String = "NotificationActionReceiver - Dozi Bildirim ƒ∞≈üleyici"
}

private fun listAvailableVoices(tts: TextToSpeech) {
    tts.voices?.forEach { voice ->
        println("Ses adƒ±: ${voice.name}, locale: ${voice.locale}, quality: ${voice.quality}, latency: ${voice.latency}")
    }
}

/**
 * Medicine.notes'tan belirli bir saat i√ßin notu parse et
 *
 * Format: "08:00: Tok karnƒ±na | 20:00: Yemekten sonra | Her 3 g√ºnde bir"
 *
 * @param notes Medicine.notes string
 * @param time Aranacak saat (√∂rn: "08:00")
 * @return Bu saat i√ßin not, yoksa bo≈ü string
 */
private fun parseTimeNoteFromMedicine(notes: String, time: String): String {
    if (notes.isEmpty()) return ""

    // "|" ile ayƒ±r (birden fazla saat notu olabilir)
    val parts = notes.split("|").map { it.trim() }

    parts.forEach { part ->
        // "08:00: Tok karnƒ±na" formatƒ±nda mƒ±?
        if (part.contains(":") && part.startsWith(time)) {
            // "08:00: Tok karnƒ±na" -> "Tok karnƒ±na"
            val noteText = part.substringAfter("$time:").trim()
            if (noteText.isNotEmpty()) {
                return noteText
            }
        }
    }

    return ""
}


// ============================================================================
// FILE: NotificationHelper.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/notifications/NotificationHelper.kt
// [115 of 122]
// ============================================================================

package com.bardino.dozi.notifications

import android.Manifest
import android.app.*
import android.content.Context
import android.content.Intent
import android.graphics.BitmapFactory
import android.graphics.Color
import android.os.Build
import android.util.Log
import androidx.annotation.RequiresPermission
import androidx.core.app.NotificationCompat
import androidx.core.app.NotificationManagerCompat
import com.bardino.dozi.MainActivity
import com.bardino.dozi.R
import com.bardino.dozi.core.data.model.MedicineCriticality
import com.bardino.dozi.core.data.model.User
import java.text.SimpleDateFormat
import java.util.*

object NotificationHelper {

    const val CHANNEL_ID = "dozi_med_channel"
    const val CHANNEL_ID_IMPORTANT = "dozi_med_important_channel"
    const val NOTIF_ID = 2025
    const val NOTIF_ID_ESCALATION_1 = 2026  // 10 dk sonraki bildirim
    const val NOTIF_ID_ESCALATION_2 = 2027  // 30 dk sonraki bildirim
    const val NOTIF_ID_ESCALATION_3 = 2028  // 60 dk sonraki bildirim (important)

    /**
     * ƒ∞la√ß ve zamana √∂zel unique notification ID olu≈ütur
     * Bu sayede aynƒ± ilacƒ±n farklƒ± zamanlardaki bildirimleri farklƒ± ID'lere sahip olur
     */
    fun getNotificationId(medicineId: String, time: String, escalationLevel: Int = 0): Int {
        val baseId = "${medicineId}_${time}_$escalationLevel".hashCode()
        // Pozitif ID'ye √ßevir (Android negatif ID'leri kabul etmiyor)
        return if (baseId < 0) -baseId else baseId
    }

    /**
     * Aynƒ± ilaca ait T√úM bildirimleri iptal et
     */
    fun cancelAllNotificationsForMedicine(context: Context, medicineId: String, time: String) {
        val nm = NotificationManagerCompat.from(context)

        // Eski sabit ID'leri iptal et (backward compatibility)
        nm.cancel(NOTIF_ID)
        nm.cancel(NOTIF_ID_ESCALATION_1)
        nm.cancel(NOTIF_ID_ESCALATION_2)
        nm.cancel(NOTIF_ID_ESCALATION_3)

        // Yeni unique ID'leri iptal et
        for (level in 0..3) {
            val notifId = getNotificationId(medicineId, time, level)
            nm.cancel(notifId)
            Log.d("NotificationHelper", "‚úÖ Bildirim iptal edildi: ID=$notifId (medicineId=$medicineId, time=$time, level=$level)")
        }
    }

    // Action keys
    const val ACTION_TAKEN = "ACTION_TAKEN"
    const val ACTION_SNOOZE = "ACTION_SNOOZE"
    const val ACTION_SKIP = "ACTION_SKIP"
    const val ACTION_BUDDY_ACCEPT = "ACTION_BUDDY_ACCEPT"
    const val ACTION_BUDDY_REJECT = "ACTION_BUDDY_REJECT"
    const val EXTRA_MEDICINE = "EXTRA_MEDICINE"
    const val EXTRA_MEDICINE_ID = "EXTRA_MEDICINE_ID"
    const val EXTRA_DOSAGE = "EXTRA_DOSAGE"
    const val EXTRA_TIME = "EXTRA_TIME"
    const val EXTRA_SCHEDULED_TIME = "EXTRA_SCHEDULED_TIME"
    const val EXTRA_REQUEST_ID = "EXTRA_REQUEST_ID"
    const val EXTRA_FROM_USER_NAME = "EXTRA_FROM_USER_NAME"

    @RequiresPermission(Manifest.permission.POST_NOTIFICATIONS)
    fun showMedicationNotification(
        context: Context,
        medicineName: String,
        medicineId: String = "",
        dosage: String = "",
        time: String = getCurrentTime(),
        scheduledTime: Long = System.currentTimeMillis(),
        timeNote: String = "",
        reminderName: String = "",
        isCritical: Boolean = false // üî• Kritik ila√ß - IMPORTANT channel kullan
    ) {
        // üî• Kritik ila√ß i√ßin IMPORTANT channel, normal ila√ß i√ßin standart channel
        if (isCritical) {
            createImportantChannel(context)
        } else {
            createDoziChannel(context)
        }
        val nm = NotificationManagerCompat.from(context)

        val contentIntent = PendingIntent.getActivity(
            context, 0,
            Intent(context, MainActivity::class.java).apply {
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP)
                putExtra("navigation_route", "medication_action/$time")
            },
            PendingIntent.FLAG_UPDATE_CURRENT or mutableFlag()
        )

        val takenPending = createActionPendingIntent(context, ACTION_TAKEN, medicineName, medicineId, dosage, time, scheduledTime, 1)
        val snoozePending = createActionPendingIntent(context, ACTION_SNOOZE, medicineName, medicineId, dosage, time, scheduledTime, 2)
        val skipPending = createActionPendingIntent(context, ACTION_SKIP, medicineName, medicineId, dosage, time, scheduledTime, 3)

        val largeIcon = BitmapFactory.decodeResource(context.resources, R.drawable.dozi)

        // üî• Kritik ila√ß i√ßin farklƒ± ba≈ülƒ±k
        val contentTitle = when {
            isCritical && reminderName.isNotEmpty() -> "üö® $reminderName"
            isCritical && medicineName.isNotEmpty() -> "üö® KRƒ∞Tƒ∞K: $medicineName"
            reminderName.isNotEmpty() -> reminderName
            medicineName.isNotEmpty() -> "üíä $medicineName"
            else -> "üíä ƒ∞la√ß Hatƒ±rlatmasƒ±"
        }

        val contentText = buildString {
            append("‚è∞ $time")
            if (dosage.isNotEmpty()) append(" ‚Ä¢ $dosage")
            if (timeNote.isNotEmpty()) append(" ‚Ä¢ $timeNote")
            if (isCritical) append(" ‚Ä¢ ‚ö†Ô∏è Kritik ƒ∞la√ß")
        }

        val bigText = buildString {
            if (isCritical) append("üö® KRƒ∞Tƒ∞K ƒ∞LA√á - Bu ila√ß hayati √∂nem ta≈üƒ±yor!\n\n")
            append("‚è∞ Saat: $time\n")
            if (medicineName.isNotEmpty()) append("üíä ƒ∞la√ß: $medicineName\n")
            if (dosage.isNotEmpty()) append("üíâ Dozaj: $dosage\n")
            if (timeNote.isNotEmpty()) append("üìù $timeNote\n")
            append("\nDetaylarƒ± g√∂rmek i√ßin dokunun.")
        }

        // üî• Kritik ila√ß i√ßin farklƒ± notification builder
        val channelId = if (isCritical) CHANNEL_ID_IMPORTANT else CHANNEL_ID
        val notificationColor = if (isCritical) Color.parseColor("#D32F2F") else Color.parseColor("#26C6DA")
        val vibrationPattern = if (isCritical) longArrayOf(0, 700, 300, 700, 300, 700) else longArrayOf(0, 300, 150, 300)

        val notificationBuilder = NotificationCompat.Builder(context, channelId)
            .setSmallIcon(R.drawable.ic_notification_pill)
            .setColor(notificationColor)
            .setLargeIcon(largeIcon)
            .setContentTitle(contentTitle)
            .setContentText(contentText)
            .setStyle(
                NotificationCompat.BigTextStyle()
                    .bigText(bigText)
                    .setBigContentTitle(contentTitle)
                    .setSummaryText(if (isCritical) "Dozi - Kritik ƒ∞la√ß" else "Dozi")
            )
            .setAutoCancel(true)
            .setPriority(if (isCritical) NotificationCompat.PRIORITY_MAX else NotificationCompat.PRIORITY_HIGH)
            .setCategory(if (isCritical) NotificationCompat.CATEGORY_ALARM else NotificationCompat.CATEGORY_REMINDER)
            .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
            .setVibrate(vibrationPattern)
            .setLights(notificationColor, 1000, 1000)
            .setContentIntent(contentIntent)
            .addAction(R.drawable.ic_notification_pill, "Aldƒ±m ‚úì", takenPending)
            .addAction(R.drawable.ic_notification_pill, "Ertele ‚è∞", snoozePending)
            .addAction(R.drawable.ic_notification_pill, "Atla ‚úï", skipPending)

        // üî• Kritik ila√ß i√ßin alarm sesi ekle
        if (isCritical) {
            notificationBuilder.setSound(android.media.RingtoneManager.getDefaultUri(android.media.RingtoneManager.TYPE_ALARM))
        } else {
            notificationBuilder.setSound(null)
        }

        val notification = notificationBuilder.build()

        // üî• FIX: Unique notification ID kullan (her ila√ß+zaman i√ßin ayrƒ± bildirim)
        val notificationId = if (medicineId.isNotEmpty()) {
            getNotificationId(medicineId, time, 0)
        } else {
            NOTIF_ID // Fallback for backward compatibility
        }
        nm.notify(notificationId, notification)
        Log.d("NotificationHelper", "‚úÖ Bildirim g√∂sterildi: ID=$notificationId (medicineId=$medicineId, time=$time, critical=$isCritical)")
    }

    // ‚úÖ RemoteViews kaldƒ±rƒ±ldƒ± - Modern BigTextStyle kullanƒ±yoruz

    private fun createActionPendingIntent(
        context: Context,
        action: String,
        medicineName: String,
        medicineId: String,
        dosage: String,
        time: String,
        scheduledTime: Long,
        requestCode: Int
    ): PendingIntent {
        return PendingIntent.getBroadcast(
            context,
            requestCode,
            Intent(context, NotificationActionReceiver::class.java).apply {
                this.action = action
                putExtra(EXTRA_MEDICINE, medicineName)
                putExtra(EXTRA_MEDICINE_ID, medicineId)
                putExtra(EXTRA_DOSAGE, dosage)
                putExtra(EXTRA_TIME, time)
                putExtra(EXTRA_SCHEDULED_TIME, scheduledTime)
            },
            PendingIntent.FLAG_UPDATE_CURRENT or mutableFlag()
        )
    }

    fun createDoziChannel(context: Context) {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            val channel = NotificationChannel(
                CHANNEL_ID,
                "üíß Dozi Hatƒ±rlatmalar",
                NotificationManager.IMPORTANCE_HIGH
            ).apply {
                description = "Dozi tarafƒ±ndan ila√ß hatƒ±rlatmalarƒ± ve bildirimler"
                enableLights(true)
                enableVibration(true)
                lightColor = Color.parseColor("#26C6DA")
                vibrationPattern = longArrayOf(0, 300, 150, 300)
                setShowBadge(true)
            }
            val nm = context.getSystemService(NotificationManager::class.java)
            nm.createNotificationChannel(channel)
        }
    }

    fun scheduleSnooze(
        context: Context,
        medicineName: String,
        medicineId: String = "",
        dosage: String = "",
        time: String = "",
        scheduledTime: Long = System.currentTimeMillis(),
        minutes: Int = 10
    ) {
        val alarmMgr = context.getSystemService(Context.ALARM_SERVICE) as AlarmManager
        val triggerAt = System.currentTimeMillis() + minutes * 60_000L

        val intent = Intent(context, NotificationActionReceiver::class.java).apply {
            action = "ACTION_SNOOZE_TRIGGER"
            putExtra(EXTRA_MEDICINE, medicineName)
            putExtra(EXTRA_MEDICINE_ID, medicineId)
            putExtra(EXTRA_DOSAGE, dosage)
            putExtra(EXTRA_TIME, time)
            putExtra(EXTRA_SCHEDULED_TIME, scheduledTime)
        }

        val pi = PendingIntent.getBroadcast(
            context,
            NOTIF_ID + 100 + minutes,  // aynƒ± snoozelarƒ± ayƒ±r (kritik)
            intent,
            PendingIntent.FLAG_UPDATE_CURRENT or mutableFlag()
        )

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            alarmMgr.setExactAndAllowWhileIdle(AlarmManager.RTC_WAKEUP, triggerAt, pi)
        } else {
            alarmMgr.setExact(AlarmManager.RTC_WAKEUP, triggerAt, pi)
        }

        Log.d("SNOOZE", "‚è≥ Snooze scheduled for $minutes min ‚Üí $medicineName ($triggerAt)")
    }


    private fun getCurrentTime(): String {
        return SimpleDateFormat("HH:mm", Locale.getDefault()).format(Date())
    }

    private fun mutableFlag(): Int =
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) PendingIntent.FLAG_MUTABLE else 0

    /**
     * Badi request bildirimi g√∂ster (Kabul/Reddet butonlarƒ± ile)
     */
    @RequiresPermission(Manifest.permission.POST_NOTIFICATIONS)
    fun showBuddyRequestNotification(
        context: Context,
        requestId: String,
        fromUserName: String
    ) {
        createDoziChannel(context)
        val nm = NotificationManagerCompat.from(context)

        // Bildirime tƒ±klanƒ±nca buddy_list ekranƒ±na y√∂nlendir
        val contentIntent = PendingIntent.getActivity(
            context, 0,
            Intent(context, MainActivity::class.java).apply {
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP)
                putExtra("navigation_route", "buddy_list")
            },
            PendingIntent.FLAG_UPDATE_CURRENT or mutableFlag()
        )

        // Kabul et butonu
        val acceptPending = PendingIntent.getBroadcast(
            context,
            requestId.hashCode() + 1,
            Intent(context, NotificationActionReceiver::class.java).apply {
                action = ACTION_BUDDY_ACCEPT
                putExtra(EXTRA_REQUEST_ID, requestId)
                putExtra(EXTRA_FROM_USER_NAME, fromUserName)
            },
            PendingIntent.FLAG_UPDATE_CURRENT or mutableFlag()
        )

        // Reddet butonu
        val rejectPending = PendingIntent.getBroadcast(
            context,
            requestId.hashCode() + 2,
            Intent(context, NotificationActionReceiver::class.java).apply {
                action = ACTION_BUDDY_REJECT
                putExtra(EXTRA_REQUEST_ID, requestId)
                putExtra(EXTRA_FROM_USER_NAME, fromUserName)
            },
            PendingIntent.FLAG_UPDATE_CURRENT or mutableFlag()
        )

        val notification = NotificationCompat.Builder(context, CHANNEL_ID)
            .setSmallIcon(R.drawable.ic_notification_pill)
            .setColor(Color.parseColor("#26C6DA"))
            .setContentTitle("ü§ù Yeni Badi ƒ∞steƒüi")
            .setContentText("$fromUserName seni buddy olarak eklemek istiyor!")
            .setStyle(
                NotificationCompat.BigTextStyle()
                    .bigText("$fromUserName seni buddy olarak eklemek istiyor!\n\nBadileriniz ila√ß hatƒ±rlatmalarƒ±nƒ±zƒ± g√∂rebilir ve sizi destekleyebilir.")
            )
            .setAutoCancel(true)
            .setPriority(NotificationCompat.PRIORITY_HIGH)
            .setCategory(NotificationCompat.CATEGORY_SOCIAL)
            .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
            .setContentIntent(contentIntent)
            .addAction(
                R.drawable.ic_notification_pill,
                "Kabul Et ‚úì",
                acceptPending
            )
            .addAction(
                R.drawable.ic_notification_pill,
                "Reddet ‚úï",
                rejectPending
            )
            .build()

        nm.notify(requestId.hashCode(), notification)
    }

    /**
     * ‚ö†Ô∏è D√º≈ü√ºk stok bildirimi g√∂ster (5 doz kaldƒ±)
     */
    @RequiresPermission(Manifest.permission.POST_NOTIFICATIONS)
    fun showLowStockNotification(
        context: Context,
        medicineName: String,
        remainingStock: Int
    ) {
        createDoziChannel(context)
        val nm = NotificationManagerCompat.from(context)

        // Ana ekrana y√∂nlendir
        val contentIntent = PendingIntent.getActivity(
            context, 0,
            Intent(context, MainActivity::class.java).apply {
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP)
                putExtra("navigation_route", "medicine_list")
            },
            PendingIntent.FLAG_UPDATE_CURRENT or mutableFlag()
        )

        val notification = NotificationCompat.Builder(context, CHANNEL_ID)
            .setSmallIcon(R.drawable.ic_notification_pill)
            .setColor(Color.parseColor("#FFA726")) // Turuncu renk (uyarƒ±)
            .setContentTitle("‚ö†Ô∏è D√º≈ü√ºk Stok Uyarƒ±sƒ±")
            .setContentText("$medicineName - $remainingStock doz kaldƒ±!")
            .setStyle(
                NotificationCompat.BigTextStyle()
                    .bigText("üì¶ $medicineName ilacƒ±nƒ±zdan sadece $remainingStock doz kaldƒ±.\n\nüíä Eczaneden temin etmeyi unutmayƒ±n!")
                    .setBigContentTitle("‚ö†Ô∏è D√º≈ü√ºk Stok Uyarƒ±sƒ±")
                    .setSummaryText("Dozi")
            )
            .setAutoCancel(true)
            .setPriority(NotificationCompat.PRIORITY_HIGH)
            .setCategory(NotificationCompat.CATEGORY_REMINDER)
            .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
            .setContentIntent(contentIntent)
            .build()

        // Her ila√ß i√ßin benzersiz bildirim ID'si (medicineName hashCode)
        nm.notify(NOTIF_ID + 1000 + medicineName.hashCode(), notification)
    }

    /**
     * üö® Stok bitti bildirimi g√∂ster (eczane √∂nerisi)
     */
    @RequiresPermission(Manifest.permission.POST_NOTIFICATIONS)
    fun showOutOfStockNotification(
        context: Context,
        medicineName: String
    ) {
        createDoziChannel(context)
        val nm = NotificationManagerCompat.from(context)

        // Haritalar uygulamasƒ±na y√∂nlendir (eczane ara)
        val mapIntent = Intent(Intent.ACTION_VIEW).apply {
            data = android.net.Uri.parse("geo:0,0?q=eczane")
            addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
        }

        val mapPendingIntent = PendingIntent.getActivity(
            context,
            medicineName.hashCode() + 1,
            mapIntent,
            PendingIntent.FLAG_UPDATE_CURRENT or mutableFlag()
        )

        // Ana ekrana y√∂nlendir
        val contentIntent = PendingIntent.getActivity(
            context, 0,
            Intent(context, MainActivity::class.java).apply {
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP)
                putExtra("navigation_route", "medicine_list")
            },
            PendingIntent.FLAG_UPDATE_CURRENT or mutableFlag()
        )

        val notification = NotificationCompat.Builder(context, CHANNEL_ID)
            .setSmallIcon(R.drawable.ic_notification_pill)
            .setColor(Color.parseColor("#EF5350")) // Kƒ±rmƒ±zƒ± renk (acil)
            .setContentTitle("üö® Stok Bitti!")
            .setContentText("$medicineName ilacƒ±nƒ±z t√ºkendi!")
            .setStyle(
                NotificationCompat.BigTextStyle()
                    .bigText("üö® $medicineName ilacƒ±nƒ±zƒ±n stoƒüu bitti!\n\nüè• En yakƒ±n eczaneyi bulmak i√ßin dokunun.")
                    .setBigContentTitle("üö® Stok Bitti!")
                    .setSummaryText("Dozi")
            )
            .setAutoCancel(true)
            .setPriority(NotificationCompat.PRIORITY_MAX)
            .setCategory(NotificationCompat.CATEGORY_REMINDER)
            .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
            .setContentIntent(contentIntent)
            .addAction(
                R.drawable.ic_notification_pill,
                "üè• Eczane Bul",
                mapPendingIntent
            )
            .build()

        // Her ila√ß i√ßin benzersiz bildirim ID'si
        nm.notify(NOTIF_ID + 2000 + medicineName.hashCode(), notification)
    }

    /**
     * üîï DND (Do Not Disturb) kontrol√º
     * @return true ise bildirim g√∂sterilebilir, false ise DND aktif
     */
    fun shouldShowNotification(
        user: User?,
        medicineCriticality: MedicineCriticality = MedicineCriticality.ROUTINE
    ): Boolean {
        // Kullanƒ±cƒ± yoksa veya DND kapalƒ±ysa bildirim g√∂ster
        if (user == null || !user.dndEnabled) {
            return true
        }

        // Kritik ila√ßlar DND'yi bypass eder
        if (medicineCriticality == MedicineCriticality.CRITICAL) {
            return true
        }

        // ≈ûu anki saat DND saatleri i√ßinde mi kontrol et
        val now = Calendar.getInstance()
        val currentHour = now.get(Calendar.HOUR_OF_DAY)
        val currentMinute = now.get(Calendar.MINUTE)
        val currentTimeInMinutes = currentHour * 60 + currentMinute

        val dndStartInMinutes = user.dndStartHour * 60 + user.dndStartMinute
        val dndEndInMinutes = user.dndEndHour * 60 + user.dndEndMinute

        val isInDndPeriod = if (dndStartInMinutes <= dndEndInMinutes) {
            // Normal durum: 22:00 - 08:00
            currentTimeInMinutes >= dndStartInMinutes && currentTimeInMinutes < dndEndInMinutes
        } else {
            // Gece yarƒ±sƒ±nƒ± ge√ßen durum: 22:00 - 02:00
            currentTimeInMinutes >= dndStartInMinutes || currentTimeInMinutes < dndEndInMinutes
        }

        // IMPORTANT ila√ßlar DND'de sessiz g√∂sterilir
        if (medicineCriticality == MedicineCriticality.IMPORTANT && isInDndPeriod) {
            // Sessiz bildirim i√ßin hala true d√∂nd√ºr ama caller'da sessiz yapƒ±lacak
            return true
        }

        // ROUTINE ila√ßlar DND'de g√∂sterilmez
        return !isInDndPeriod
    }

    /**
     * ‚ö†Ô∏è Escalation Level 1 bildirimi (10 dakika sonra)
     */
    @RequiresPermission(Manifest.permission.POST_NOTIFICATIONS)
    fun showEscalationLevel1Notification(
        context: Context,
        medicineName: String,
        medicineId: String = "",
        dosage: String = "",
        time: String = getCurrentTime(),
        scheduledTime: Long = System.currentTimeMillis()
    ) {
        createDoziChannel(context)
        val nm = NotificationManagerCompat.from(context)

        val contentIntent = PendingIntent.getActivity(
            context, 0,
            Intent(context, MainActivity::class.java).apply {
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP)
                putExtra("navigation_route", "medication_action/$time")
            },
            PendingIntent.FLAG_UPDATE_CURRENT or mutableFlag()
        )

        val takenPending = createActionPendingIntent(context, ACTION_TAKEN, medicineName, medicineId, dosage, time, scheduledTime, 11)
        val snoozePending = createActionPendingIntent(context, ACTION_SNOOZE, medicineName, medicineId, dosage, time, scheduledTime, 12)
        val skipPending = createActionPendingIntent(context, ACTION_SKIP, medicineName, medicineId, dosage, time, scheduledTime, 13)

        val notification = NotificationCompat.Builder(context, CHANNEL_ID)
            .setSmallIcon(R.drawable.ic_notification_pill)
            .setColor(Color.parseColor("#26C6DA"))
            .setContentTitle("‚è∞ Hatƒ±rlatma: $medicineName")
            .setContentText("ƒ∞lacƒ±nƒ±zƒ± almayƒ± unutmayƒ±n!")
            .setStyle(
                NotificationCompat.BigTextStyle()
                    .bigText("‚è∞ Saat: $time\nüíä ƒ∞la√ß: $medicineName")
                    .setBigContentTitle("‚è∞ Hatƒ±rlatma")
            )
            .setAutoCancel(true)
            .setPriority(NotificationCompat.PRIORITY_HIGH)
            .setCategory(NotificationCompat.CATEGORY_REMINDER)
            .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
            .setContentIntent(contentIntent)
            .addAction(R.drawable.ic_notification_pill, "Aldƒ±m ‚úì", takenPending)
            .addAction(R.drawable.ic_notification_pill, "Ertele ‚è∞", snoozePending)
            .addAction(R.drawable.ic_notification_pill, "Atla ‚úï", skipPending)
            .build()

        // üî• FIX: Unique notification ID kullan (her ila√ß+zaman i√ßin ayrƒ± bildirim)
        val notificationId = if (medicineId.isNotEmpty()) {
            getNotificationId(medicineId, time, 1)
        } else {
            NOTIF_ID_ESCALATION_1
        }
        nm.notify(notificationId, notification)
        Log.d("NotificationHelper", "‚úÖ Escalation 1 bildirimi g√∂sterildi: ID=$notificationId (medicineId=$medicineId, time=$time)")
    }

    /**
     * üö® Escalation Level 2 bildirimi (30 dakika sonra - kƒ±rmƒ±zƒ±, urgent)
     */
    @RequiresPermission(Manifest.permission.POST_NOTIFICATIONS)
    fun showEscalationLevel2Notification(
        context: Context,
        medicineName: String,
        medicineId: String = "",
        dosage: String = "",
        time: String = getCurrentTime(),
        scheduledTime: Long = System.currentTimeMillis()
    ) {
        createDoziChannel(context)
        val nm = NotificationManagerCompat.from(context)

        val contentIntent = PendingIntent.getActivity(
            context, 0,
            Intent(context, MainActivity::class.java).apply {
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP)
                putExtra("navigation_route", "medication_action/$time")
            },
            PendingIntent.FLAG_UPDATE_CURRENT or mutableFlag()
        )

        val takenPending = createActionPendingIntent(context, ACTION_TAKEN, medicineName, medicineId, dosage, time, scheduledTime, 21)
        val snoozePending = createActionPendingIntent(context, ACTION_SNOOZE, medicineName, medicineId, dosage, time, scheduledTime, 22)
        val skipPending = createActionPendingIntent(context, ACTION_SKIP, medicineName, medicineId, dosage, time, scheduledTime, 23)

        val notification = NotificationCompat.Builder(context, CHANNEL_ID)
            .setSmallIcon(R.drawable.ic_notification_pill)
            .setColor(Color.parseColor("#EF5350")) // Kƒ±rmƒ±zƒ±
            .setContentTitle("üö® ƒ∞lacƒ±nƒ± ka√ßƒ±rƒ±yorsun!")
            .setContentText("$medicineName - L√ºtfen ≈üimdi al!")
            .setStyle(
                NotificationCompat.BigTextStyle()
                    .bigText("üö® $medicineName ilacƒ±nƒ± almayƒ± unutuyorsun!\n\n‚è∞ Planlanan saat: $time\n\nL√ºtfen hemen ilacƒ±nƒ± al!")
                    .setBigContentTitle("üö® ƒ∞lacƒ±nƒ± ka√ßƒ±rƒ±yorsun!")
            )
            .setAutoCancel(true)
            .setPriority(NotificationCompat.PRIORITY_MAX)
            .setCategory(NotificationCompat.CATEGORY_ALARM)
            .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
            .setVibrate(longArrayOf(0, 500, 200, 500, 200, 500))
            .setContentIntent(contentIntent)
            .addAction(R.drawable.ic_notification_pill, "Aldƒ±m ‚úì", takenPending)
            .addAction(R.drawable.ic_notification_pill, "Ertele ‚è∞", snoozePending)
            .addAction(R.drawable.ic_notification_pill, "Atla ‚úï", skipPending)
            .build()

        // üî• FIX: Unique notification ID kullan (her ila√ß+zaman i√ßin ayrƒ± bildirim)
        val notificationId = if (medicineId.isNotEmpty()) {
            getNotificationId(medicineId, time, 2)
        } else {
            NOTIF_ID_ESCALATION_2
        }
        nm.notify(notificationId, notification)
        Log.d("NotificationHelper", "‚úÖ Escalation 2 bildirimi g√∂sterildi: ID=$notificationId (medicineId=$medicineId, time=$time)")
    }

    /**
     * üî¥ Escalation Level 3 bildirimi (60 dakika sonra - IMPORTANT, sessizde bile √ßalar)
     */
    @RequiresPermission(Manifest.permission.POST_NOTIFICATIONS)
    fun showEscalationLevel3Notification(
        context: Context,
        medicineName: String,
        medicineId: String = "",
        dosage: String = "",
        time: String = getCurrentTime(),
        scheduledTime: Long = System.currentTimeMillis()
    ) {
        createImportantChannel(context)
        val nm = NotificationManagerCompat.from(context)

        val contentIntent = PendingIntent.getActivity(
            context, 0,
            Intent(context, MainActivity::class.java).apply {
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP)
                putExtra("navigation_route", "medication_action/$time")
            },
            PendingIntent.FLAG_UPDATE_CURRENT or mutableFlag()
        )

        val takenPending = createActionPendingIntent(context, ACTION_TAKEN, medicineName, medicineId, dosage, time, scheduledTime, 31)
        val skipPending = createActionPendingIntent(context, ACTION_SKIP, medicineName, medicineId, dosage, time, scheduledTime, 33)

        val notification = NotificationCompat.Builder(context, CHANNEL_ID_IMPORTANT)
            .setSmallIcon(R.drawable.ic_notification_pill)
            .setColor(Color.parseColor("#D32F2F")) // Koyu kƒ±rmƒ±zƒ±
            .setContentTitle("üî¥ √ñNEMLƒ∞: ƒ∞la√ß Uyarƒ±sƒ±!")
            .setContentText("$medicineName - 1 saattir bekleniyor!")
            .setStyle(
                NotificationCompat.BigTextStyle()
                    .bigText("üî¥ $medicineName ilacƒ±nƒ± almayƒ± 1 saattir bekliyorsun!\n\n‚è∞ Planlanan saat: $time\n\n‚ö†Ô∏è Bu √∂nemli bir hatƒ±rlatmadƒ±r. L√ºtfen ilacƒ±nƒ± al veya atla!")
                    .setBigContentTitle("üî¥ √ñNEMLƒ∞: ƒ∞la√ß Uyarƒ±sƒ±!")
            )
            .setAutoCancel(true)
            .setPriority(NotificationCompat.PRIORITY_MAX)
            .setCategory(NotificationCompat.CATEGORY_ALARM)
            .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
            .setVibrate(longArrayOf(0, 700, 300, 700, 300, 700))
            .setSound(android.media.RingtoneManager.getDefaultUri(android.media.RingtoneManager.TYPE_ALARM))
            .setContentIntent(contentIntent)
            .addAction(R.drawable.ic_notification_pill, "Aldƒ±m ‚úì", takenPending)
            .addAction(R.drawable.ic_notification_pill, "Atla ‚úï", skipPending)
            .build()

        // üî• FIX: Unique notification ID kullan (her ila√ß+zaman i√ßin ayrƒ± bildirim)
        val notificationId = if (medicineId.isNotEmpty()) {
            getNotificationId(medicineId, time, 3)
        } else {
            NOTIF_ID_ESCALATION_3
        }
        nm.notify(notificationId, notification)
        Log.d("NotificationHelper", "‚úÖ Escalation 3 bildirimi g√∂sterildi: ID=$notificationId (medicineId=$medicineId, time=$time)")
    }

    /**
     * Important bildirimler i√ßin √∂zel channel (sessizde bile √ßalar)
     */
    fun createImportantChannel(context: Context) {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            val channel = NotificationChannel(
                CHANNEL_ID_IMPORTANT,
                "üíß Dozi √ñnemli Hatƒ±rlatmalar",
                NotificationManager.IMPORTANCE_HIGH
            ).apply {
                description = "Kritik ila√ß hatƒ±rlatmalarƒ± - Telefon sessizde bile √ßalar"
                enableLights(true)
                enableVibration(true)
                lightColor = Color.parseColor("#D32F2F")
                vibrationPattern = longArrayOf(0, 700, 300, 700, 300, 700)
                setShowBadge(true)
                setBypassDnd(true) // DND'yi bypass et
                lockscreenVisibility = NotificationCompat.VISIBILITY_PUBLIC
                setSound(
                    android.media.RingtoneManager.getDefaultUri(android.media.RingtoneManager.TYPE_ALARM),
                    android.media.AudioAttributes.Builder()
                        .setUsage(android.media.AudioAttributes.USAGE_ALARM)
                        .setContentType(android.media.AudioAttributes.CONTENT_TYPE_SONIFICATION)
                        .build()
                )
            }
            val nm = context.getSystemService(NotificationManager::class.java)
            nm.createNotificationChannel(channel)
        }
    }

    /**
     * üèÜ Achievement bildirimi g√∂ster
     */
    @RequiresPermission(Manifest.permission.POST_NOTIFICATIONS)
    fun showAchievementNotification(
        context: Context,
        achievementTitle: String,
        achievementDescription: String
    ) {
        createDoziChannel(context)
        val nm = NotificationManagerCompat.from(context)

        // Ana ekrana y√∂nlendir
        val contentIntent = PendingIntent.getActivity(
            context, 0,
            Intent(context, MainActivity::class.java).apply {
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP)
                putExtra("navigation_route", "home")
            },
            PendingIntent.FLAG_UPDATE_CURRENT or mutableFlag()
        )

        val notification = NotificationCompat.Builder(context, CHANNEL_ID)
            .setSmallIcon(R.drawable.ic_notification_pill)
            .setColor(Color.parseColor("#FFD700")) // Altƒ±n renk (achievement)
            .setContentTitle("üèÜ $achievementTitle")
            .setContentText(achievementDescription)
            .setStyle(
                NotificationCompat.BigTextStyle()
                    .bigText(achievementDescription)
                    .setBigContentTitle("üèÜ $achievementTitle")
                    .setSummaryText("Dozi")
            )
            .setAutoCancel(true)
            .setPriority(NotificationCompat.PRIORITY_DEFAULT)
            .setCategory(NotificationCompat.CATEGORY_STATUS)
            .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
            .setContentIntent(contentIntent)
            .build()

        // Her achievement i√ßin benzersiz bildirim ID'si
        nm.notify(NOTIF_ID + 3000 + achievementTitle.hashCode(), notification)
    }

    /**
     * üîî Adaptive timing - ƒ∞la√ß zamanƒ±nƒ± kullanƒ±cƒ± tercihine g√∂re ayarla
     */
    fun adjustTimeWithAdaptiveTiming(
        originalTime: String,  // "08:00"
        user: User?
    ): String {
        if (user == null || !user.adaptiveTimingEnabled) {
            return originalTime
        }

        try {
            val parts = originalTime.split(":")
            val hour = parts.getOrNull(0)?.toIntOrNull() ?: return originalTime
            val minute = parts.getOrNull(1)?.toIntOrNull() ?: 0

            // Sabah ila√ßlarƒ± (6-11 arasƒ±) kullanƒ±cƒ±nƒ±n tercih ettiƒüi sabah saatine kaydƒ±r
            val adjustedHour = when (hour) {
                in 6..11 -> {
                    // Kullanƒ±cƒ±nƒ±n sabah tercihi ile deƒüi≈ütir
                    user.preferredMorningHour
                }
                in 18..22 -> {
                    // Kullanƒ±cƒ±nƒ±n ak≈üam tercihi ile deƒüi≈ütir
                    user.preferredEveningHour
                }
                else -> hour  // Diƒüer saatler deƒüi≈ümez
            }

            return String.format("%02d:%02d", adjustedHour, minute)
        } catch (e: Exception) {
            return originalTime
        }
    }

    /**
     * üö® Bildirim prioritesi belirle (kritiklik seviyesine g√∂re)
     */
    fun getNotificationPriority(
        medicineCriticality: MedicineCriticality,
        isInDndPeriod: Boolean
    ): Int {
        return when {
            medicineCriticality == MedicineCriticality.CRITICAL -> NotificationCompat.PRIORITY_MAX
            medicineCriticality == MedicineCriticality.IMPORTANT && isInDndPeriod -> NotificationCompat.PRIORITY_LOW
            medicineCriticality == MedicineCriticality.IMPORTANT -> NotificationCompat.PRIORITY_HIGH
            else -> NotificationCompat.PRIORITY_DEFAULT
        }
    }
}
// ============================================================================
// FILE: PermissionHandler.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/notifications/PermissionHandler.kt
// [116 of 122]
// ============================================================================

package com.bardino.dozi.notifications

import android.Manifest
import android.app.Activity
import android.app.AlarmManager
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Build
import android.provider.Settings
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat

object PermissionHandler {

    const val REQUEST_CODE_NOTIFICATION = 1001
    const val REQUEST_CODE_OVERLAY = 1002
    const val REQUEST_CODE_EXACT_ALARM = 1003

    // √áin men≈üeli telefon √ºreticileri
    private val CHINESE_MANUFACTURERS = listOf(
        "xiaomi", "redmi", "poco",
        "huawei", "honor",
        "oppo", "realme", "oneplus",
        "vivo", "iqoo",
        "meizu", "zte", "nubia",
        "lenovo", "motorola"
    )

    /**
     * √áin men≈üeli telefon mu kontrol eder
     */
    fun isChineseManufacturer(): Boolean {
        val manufacturer = Build.MANUFACTURER.lowercase()
        return CHINESE_MANUFACTURERS.any { manufacturer.contains(it) }
    }

    /**
     * √úretici adƒ±nƒ± d√∂nd√ºr√ºr
     */
    fun getManufacturerDisplayName(): String {
        val manufacturer = Build.MANUFACTURER.lowercase()
        return when {
            manufacturer.contains("xiaomi") || manufacturer.contains("redmi") || manufacturer.contains("poco") -> "Xiaomi"
            manufacturer.contains("huawei") || manufacturer.contains("honor") -> "Huawei"
            manufacturer.contains("oppo") || manufacturer.contains("realme") -> "OPPO/Realme"
            manufacturer.contains("oneplus") -> "OnePlus"
            manufacturer.contains("vivo") || manufacturer.contains("iqoo") -> "Vivo"
            manufacturer.contains("meizu") -> "Meizu"
            manufacturer.contains("samsung") -> "Samsung"
            else -> Build.MANUFACTURER
        }
    }

    /**
     * Pil optimizasyonu ayarlarƒ±nƒ± a√ßar (√ºreticiye √∂zel)
     */
    fun openBatteryOptimizationSettings(context: Context) {
        val manufacturer = Build.MANUFACTURER.lowercase()

        val intent = when {
            // Xiaomi / MIUI
            manufacturer.contains("xiaomi") || manufacturer.contains("redmi") || manufacturer.contains("poco") -> {
                Intent().apply {
                    component = android.content.ComponentName(
                        "com.miui.securitycenter",
                        "com.miui.permcenter.autostart.AutoStartManagementActivity"
                    )
                }
            }
            // Huawei / EMUI
            manufacturer.contains("huawei") || manufacturer.contains("honor") -> {
                Intent().apply {
                    component = android.content.ComponentName(
                        "com.huawei.systemmanager",
                        "com.huawei.systemmanager.startupmgr.ui.StartupNormalAppListActivity"
                    )
                }
            }
            // OPPO / ColorOS
            manufacturer.contains("oppo") || manufacturer.contains("realme") -> {
                Intent().apply {
                    component = android.content.ComponentName(
                        "com.coloros.safecenter",
                        "com.coloros.safecenter.permission.startup.StartupAppListActivity"
                    )
                }
            }
            // OnePlus / OxygenOS
            manufacturer.contains("oneplus") -> {
                Intent().apply {
                    component = android.content.ComponentName(
                        "com.oneplus.security",
                        "com.oneplus.security.chainlaunch.view.ChainLaunchAppListActivity"
                    )
                }
            }
            // Vivo / FuntouchOS
            manufacturer.contains("vivo") || manufacturer.contains("iqoo") -> {
                Intent().apply {
                    component = android.content.ComponentName(
                        "com.vivo.permissionmanager",
                        "com.vivo.permissionmanager.activity.BgStartUpManagerActivity"
                    )
                }
            }
            // Samsung
            manufacturer.contains("samsung") -> {
                Intent().apply {
                    component = android.content.ComponentName(
                        "com.samsung.android.lool",
                        "com.samsung.android.sm.battery.ui.BatteryActivity"
                    )
                }
            }
            // Fallback - Genel pil optimizasyonu ayarlarƒ±
            else -> {
                Intent(Settings.ACTION_IGNORE_BATTERY_OPTIMIZATION_SETTINGS)
            }
        }

        try {
            context.startActivity(intent)
        } catch (e: Exception) {
            // √úreticiye √∂zel ayar bulunamazsa genel ayarlara git
            try {
                val fallbackIntent = Intent(Settings.ACTION_IGNORE_BATTERY_OPTIMIZATION_SETTINGS)
                context.startActivity(fallbackIntent)
            } catch (e2: Exception) {
                // Son √ßare: Uygulama ayarlarƒ±nƒ± a√ß
                openAppSettings(context)
            }
        }
    }

    /**
     * √áin telefonu i√ßin talimat metni
     */
    fun getBatteryOptimizationInstructions(): String {
        val manufacturer = Build.MANUFACTURER.lowercase()

        return when {
            manufacturer.contains("xiaomi") || manufacturer.contains("redmi") || manufacturer.contains("poco") ->
                "Ayarlar > Uygulamalar > Dozi > Pil tasarrufu > 'Kƒ±sƒ±tlama yok' se√ßin.\n\nAyrƒ±ca: G√ºvenlik > Otomatik ba≈ülatma > Dozi'yi etkinle≈ütirin."

            manufacturer.contains("huawei") || manufacturer.contains("honor") ->
                "Ayarlar > Pil > Uygulama ba≈ülatma > Dozi > 'Manuel olarak y√∂net' se√ßin ve t√ºm se√ßenekleri a√ßƒ±n."

            manufacturer.contains("oppo") || manufacturer.contains("realme") ->
                "Ayarlar > Pil > Daha fazla pil ayarƒ± > Uygulama hƒ±zlƒ± dondurma > Dozi'yi kapatƒ±n."

            manufacturer.contains("oneplus") ->
                "Ayarlar > Pil > Pil optimizasyonu > Dozi > 'Optimize etme' se√ßin."

            manufacturer.contains("vivo") || manufacturer.contains("iqoo") ->
                "Ayarlar > Pil > Arka plan g√º√ß t√ºketimi > Dozi > 'Kƒ±sƒ±tlama' se√ßin."

            manufacturer.contains("samsung") ->
                "Ayarlar > Pil > Arka plan kullanƒ±m sƒ±nƒ±rlarƒ± > Hi√ßbir zaman uyku moduna alma > Dozi'yi ekleyin."

            else ->
                "Ayarlar > Pil > Pil optimizasyonu > Dozi > 'Optimize etme' se√ßin."
        }
    }

    /**
     * T√ºm gerekli izinleri kontrol eder
     */
    fun hasAllPermissions(context: Context): Boolean {
        return hasNotificationPermission(context) &&
                hasOverlayPermission(context) &&
                hasExactAlarmPermission(context)
    }

    /**
     * Bildirim iznini kontrol eder (Android 13+)
     */
    fun hasNotificationPermission(context: Context): Boolean {
        return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            ContextCompat.checkSelfPermission(
                context,
                Manifest.permission.POST_NOTIFICATIONS
            ) == PackageManager.PERMISSION_GRANTED
        } else {
            true // Android 13 altƒ±nda otomatik verilir
        }
    }

    /**
     * Overlay izni (Dialog g√∂stermek i√ßin)
     */
    fun hasOverlayPermission(context: Context): Boolean {
        return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            Settings.canDrawOverlays(context)
        } else {
            true
        }
    }

    /**
     * Exact Alarm izni (Android 12+)
     */
    fun hasExactAlarmPermission(context: Context): Boolean {
        return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
            val alarmManager = context.getSystemService(Context.ALARM_SERVICE) as AlarmManager
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
                alarmManager.canScheduleExactAlarms()
            } else {
                true
            }
        } else {
            true
        }
    }

    /**
     * Bildirim izni ister (Android 13+)
     */
    fun requestNotificationPermission(activity: Activity) {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            ActivityCompat.requestPermissions(
                activity,
                arrayOf(Manifest.permission.POST_NOTIFICATIONS),
                REQUEST_CODE_NOTIFICATION
            )
        }
    }

    /**
     * Overlay izni ister
     */
    fun requestOverlayPermission(activity: Activity) {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            val intent = Intent(
                Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
                Uri.parse("package:${activity.packageName}")
            )
            activity.startActivityForResult(intent, REQUEST_CODE_OVERLAY)
        }
    }

    /**
     * Exact Alarm izni ister (Android 12+)
     */
    fun requestExactAlarmPermission(activity: Activity) {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
            val intent = Intent(Settings.ACTION_REQUEST_SCHEDULE_EXACT_ALARM)
            intent.data = Uri.parse("package:${activity.packageName}")
            activity.startActivityForResult(intent, REQUEST_CODE_EXACT_ALARM)
        }
    }

    /**
     * T√ºm izinleri ister
     */
    fun requestAllPermissions(activity: Activity) {
        // 1. Bildirim izni
        if (!hasNotificationPermission(activity)) {
            requestNotificationPermission(activity)
        }

        // 2. Overlay izni
        if (!hasOverlayPermission(activity)) {
            requestOverlayPermission(activity)
        }

        // 3. Exact Alarm izni
        if (!hasExactAlarmPermission(activity)) {
            requestExactAlarmPermission(activity)
        }
    }

    /**
     * ƒ∞zin sonu√ßlarƒ±nƒ± i≈üle
     */
    fun handlePermissionResult(
        requestCode: Int,
        permissions: Array<out String>,
        grantResults: IntArray,
        onGranted: () -> Unit,
        onDenied: () -> Unit
    ) {
        when (requestCode) {
            REQUEST_CODE_NOTIFICATION -> {
                if (grantResults.isNotEmpty() && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
                    onGranted()
                } else {
                    onDenied()
                }
            }
        }
    }

    /**
     * Ayarlara gitmek i√ßin Intent
     */
    fun openAppSettings(context: Context) {
        val intent = Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS).apply {
            data = Uri.fromParts("package", context.packageName, null)
        }
        context.startActivity(intent)
    }
}
// ============================================================================
// FILE: ReminderScheduler.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/notifications/ReminderScheduler.kt
// [117 of 122]
// ============================================================================

package com.bardino.dozi.notifications

import android.app.AlarmManager
import android.app.PendingIntent
import android.content.Context
import android.content.Intent
import android.os.Build
import android.util.Log
import com.bardino.dozi.core.data.model.Medicine
import com.bardino.dozi.core.data.repository.MedicineRepository
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import java.util.Calendar

/**
 * ƒ∞la√ß hatƒ±rlatma alarmlarƒ±nƒ± y√∂neten sƒ±nƒ±f
 * AlarmManager kullanarak zamanlanmƒ±≈ü bildirimleri planlar
 */
class ReminderScheduler {

    companion object {
        private const val TAG = "ReminderScheduler"
        const val ACTION_REMINDER_TRIGGER = "com.bardino.dozi.ACTION_REMINDER_TRIGGER"
        const val EXTRA_MEDICINE_ID = "medicine_id"
        const val EXTRA_MEDICINE_NAME = "medicine_name"
        const val EXTRA_TIME = "time"

        /**
         * Tek bir ila√ß i√ßin t√ºm hatƒ±rlatmalarƒ± planla
         *
         * @param isRescheduling true ise alarm tetiklendikten sonra bir sonraki alarmƒ± planlar (frequency'ye g√∂re),
         *                       false ise ilk kurulum
         */
        fun scheduleReminders(context: Context, medicine: Medicine, isRescheduling: Boolean = false) {
            if (!medicine.reminderEnabled) {
                Log.d(TAG, "Hatƒ±rlatma devre dƒ±≈üƒ±: ${medicine.name}")
                return
            }

            if (medicine.times.isEmpty()) {
                Log.d(TAG, "Hatƒ±rlatma saati yok: ${medicine.name}")
                return
            }

            // ‚úÖ Medicine ID kontrol√º
            if (medicine.id.isEmpty()) {
                Log.e(TAG, "‚ùå Medicine ID bo≈ü! ${medicine.name} i√ßin alarmlar kurulamƒ±yor.")
                return
            }

            // üìÖ Biti≈ü tarihi kontrol√º
            if (medicine.endDate != null && medicine.endDate < System.currentTimeMillis()) {
                Log.d(TAG, "‚è±Ô∏è Biti≈ü tarihi ge√ßmi≈ü: ${medicine.name}. Hatƒ±rlatma planlanmƒ±yor.")
                return
            }

            // ‚úÖ Exact alarm izni kontrol√º (Android 12+)
            if (!PermissionHandler.hasExactAlarmPermission(context)) {
                Log.w(TAG, "‚ö†Ô∏è SCHEDULE_EXACT_ALARM izni yok! ${medicine.name} i√ßin alarmlar kurulamƒ±yor.")
                Log.w(TAG, "‚ö†Ô∏è Kullanƒ±cƒ±nƒ±n Settings > Apps > Dozi > Alarms & reminders'dan izni vermesi gerekiyor.")
                return
            }

            val alarmManager = context.getSystemService(Context.ALARM_SERVICE) as AlarmManager

            // Her saat i√ßin bir alarm kur
            medicine.times.forEach { time ->
                scheduleReminderForTime(context, alarmManager, medicine, time, isRescheduling)
            }

            Log.d(TAG, "‚úÖ ${medicine.name} i√ßin ${medicine.times.size} hatƒ±rlatma planlandƒ±")
        }

        /**
         * Belirli bir saat i√ßin hatƒ±rlatma planla
         *
         * @param isRescheduling true ise alarm tetiklendikten sonra bir sonraki alarmƒ± planlar (frequency'ye g√∂re),
         *                       false ise ilk kurulum (bug√ºnden sonraki ilk uygun zamanƒ± planlar)
         */
        private fun scheduleReminderForTime(
            context: Context,
            alarmManager: AlarmManager,
            medicine: Medicine,
            time: String,
            isRescheduling: Boolean = false
        ) {
            try {
                val (hour, minute) = time.split(":").map { it.toInt() }

                // Intent olu≈ütur
                val intent = Intent(context, NotificationActionReceiver::class.java).apply {
                    action = ACTION_REMINDER_TRIGGER
                    putExtra(EXTRA_MEDICINE_ID, medicine.id)
                    putExtra(EXTRA_MEDICINE_NAME, medicine.name)
                    putExtra(EXTRA_TIME, time)
                }

                // Unique request code: medicineId + time kombinasyonu
                val requestCode = getRequestCode(medicine.id, time)

                val pendingIntent = PendingIntent.getBroadcast(
                    context,
                    requestCode,
                    intent,
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
                        PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
                    } else {
                        PendingIntent.FLAG_UPDATE_CURRENT
                    }
                )

                // Tetiklenme zamanƒ±nƒ± hesapla
                val calendar = Calendar.getInstance().apply {
                    set(Calendar.HOUR_OF_DAY, hour)
                    set(Calendar.MINUTE, minute)
                    set(Calendar.SECOND, 0)
                    set(Calendar.MILLISECOND, 0)

                    if (isRescheduling) {
                        // Alarm tetiklendi, bir sonraki zamanƒ± hesapla (frequency'ye g√∂re)
                        val daysToAdd = when (medicine.frequency) {
                            "Her g√ºn" -> 1
                            "G√ºn a≈üƒ±rƒ±" -> 2
                            "Haftada bir" -> 7
                            "15 g√ºnde bir" -> 15
                            "Ayda bir" -> 30
                            "Her X g√ºnde bir" -> medicine.frequencyValue
                            "ƒ∞stediƒüim tarihlerde" -> {
                                // ƒ∞stediƒüim tarihlerde i√ßin bir sonraki tarihi bul
                                // ≈ûimdilik 1 g√ºn ekle (bu daha sonra d√ºzg√ºn handle edilecek)
                                1
                            }
                            else -> 1
                        }
                        add(Calendar.DAY_OF_MONTH, daysToAdd)
                    } else {
                        // ƒ∞lk kurulum: Eƒüer bu saat bug√ºn ge√ßmi≈üse, frequency'ye g√∂re bir sonraki uygun zamanƒ± bul
                        if (timeInMillis <= System.currentTimeMillis()) {
                            val daysToAdd = when (medicine.frequency) {
                                "Her g√ºn" -> 1
                                "G√ºn a≈üƒ±rƒ±" -> {
                                    // Ba≈ülangƒ±√ß tarihinden itibaren g√ºn a≈üƒ±rƒ± mantƒ±ƒüƒ±nƒ± uygula
                                    // Bug√ºnden 1 veya 2 g√ºn sonra olabilir (startDate'e g√∂re)
                                    calculateDaysUntilNextAlternateDay(medicine.startDate, medicine.frequency)
                                }
                                "Haftada bir" -> calculateDaysUntilNextWeeklyAlarm(medicine.startDate)
                                "15 g√ºnde bir" -> calculateDaysUntilNextAlarm(medicine.startDate, 15)
                                "Ayda bir" -> calculateDaysUntilNextAlarm(medicine.startDate, 30)
                                "Her X g√ºnde bir" -> calculateDaysUntilNextAlarm(medicine.startDate, medicine.frequencyValue)
                                "ƒ∞stediƒüim tarihlerde" -> 1 // √ñzel tarihler i√ßin ayrƒ± handle edilecek
                                else -> 1
                            }
                            add(Calendar.DAY_OF_MONTH, daysToAdd)
                        }
                    }
                }

                // üìÖ Biti≈ü tarihi kontrol√º: Alarm zamanƒ± endDate'den sonraysa kurma
                if (medicine.endDate != null && calendar.timeInMillis > medicine.endDate) {
                    Log.d(TAG, "‚è±Ô∏è ${medicine.name} - $time i√ßin alarm zamanƒ± biti≈ü tarihinden sonra (${calendar.time}). Alarm kurulmadƒ±.")
                    return
                }

                // Alarm kur (her zaman tek seferlik)
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                    // Android 6.0+: Doze mode'u bypass etmek i√ßin setExactAndAllowWhileIdle kullan
                    alarmManager.setExactAndAllowWhileIdle(
                        AlarmManager.RTC_WAKEUP,
                        calendar.timeInMillis,
                        pendingIntent
                    )
                } else {
                    // Android 5.x: setExact kullan
                    alarmManager.setExact(
                        AlarmManager.RTC_WAKEUP,
                        calendar.timeInMillis,
                        pendingIntent
                    )
                }

                val dateFormat = java.text.SimpleDateFormat("dd/MM/yyyy HH:mm", java.util.Locale.getDefault())
                Log.d(TAG, "‚è∞ ${medicine.name} - $time i√ßin alarm kuruldu: ${dateFormat.format(calendar.time)} (requestCode: $requestCode)")

            } catch (e: Exception) {
                Log.e(TAG, "‚ùå Alarm kurulurken hata: ${medicine.name} - $time", e)
            }
        }

        /**
         * G√ºn a≈üƒ±rƒ± i√ßin bir sonraki uygun g√ºn√º hesapla
         *
         * Mantƒ±k: Ba≈ülangƒ±√ß g√ºn√º = g√ºn 0 (ila√ß al), g√ºn 1 (alma), g√ºn 2 (al), g√ºn 3 (alma), ...
         * Yani √ßift g√ºnlerde ila√ß alƒ±nƒ±r, tek g√ºnlerde alƒ±nmaz
         */
        private fun calculateDaysUntilNextAlternateDay(startDate: Long, frequency: String): Int {
            val today = Calendar.getInstance().apply {
                set(Calendar.HOUR_OF_DAY, 0)
                set(Calendar.MINUTE, 0)
                set(Calendar.SECOND, 0)
                set(Calendar.MILLISECOND, 0)
            }

            val start = Calendar.getInstance().apply {
                timeInMillis = startDate
                set(Calendar.HOUR_OF_DAY, 0)
                set(Calendar.MINUTE, 0)
                set(Calendar.SECOND, 0)
                set(Calendar.MILLISECOND, 0)
            }

            // Ba≈ülangƒ±√ßtan bug√ºne kadar ka√ß g√ºn ge√ßti
            val daysSinceStart = ((today.timeInMillis - start.timeInMillis) / (24 * 60 * 60 * 1000)).toInt()

            // G√ºn a≈üƒ±rƒ± mantƒ±ƒüƒ±: Ba≈ülangƒ±√ß = g√ºn 0, sonra g√ºn 2, g√ºn 4, g√ºn 6, ...
            // Eƒüer bug√ºn √ßift g√ºnse (ila√ß g√ºn√º) -> saat ge√ßmi≈ü olduƒüu i√ßin bir sonraki ila√ß g√ºn√º 2 g√ºn sonra
            // Eƒüer bug√ºn tek g√ºnse (ila√ß yok) -> yarƒ±n ila√ß g√ºn√º
            return if (daysSinceStart % 2 == 0) {
                2 // Bug√ºn ila√ß g√ºn√º (saat ge√ßmi≈ü), bir sonraki ila√ß g√ºn√º 2 g√ºn sonra
            } else {
                1 // Bug√ºn ila√ß yok g√ºn√º, yarƒ±n ila√ß g√ºn√º
            }
        }

        /**
         * Haftada bir i√ßin bir sonraki uygun g√ºn√º hesapla
         */
        private fun calculateDaysUntilNextWeeklyAlarm(startDate: Long): Int {
            // Ba≈ülangƒ±√ß g√ºn√ºn√º tespit et
            val startCalendar = Calendar.getInstance().apply {
                timeInMillis = startDate
            }
            val startDayOfWeek = startCalendar.get(Calendar.DAY_OF_WEEK)

            val today = Calendar.getInstance()
            val todayDayOfWeek = today.get(Calendar.DAY_OF_WEEK)

            // Bug√ºnden ba≈ülangƒ±√ß g√ºn√ºne kadar ka√ß g√ºn var
            var daysUntilNext = (startDayOfWeek - todayDayOfWeek + 7) % 7
            if (daysUntilNext == 0) daysUntilNext = 7 // Bug√ºn o g√ºn ise, gelecek hafta

            return daysUntilNext
        }

        /**
         * X g√ºnde bir i√ßin bir sonraki uygun g√ºn√º hesapla
         */
        private fun calculateDaysUntilNextAlarm(startDate: Long, intervalDays: Int): Int {
            val today = Calendar.getInstance().apply {
                set(Calendar.HOUR_OF_DAY, 0)
                set(Calendar.MINUTE, 0)
                set(Calendar.SECOND, 0)
                set(Calendar.MILLISECOND, 0)
            }

            val start = Calendar.getInstance().apply {
                timeInMillis = startDate
                set(Calendar.HOUR_OF_DAY, 0)
                set(Calendar.MINUTE, 0)
                set(Calendar.SECOND, 0)
                set(Calendar.MILLISECOND, 0)
            }

            // Ba≈ülangƒ±√ßtan bug√ºne kadar ka√ß g√ºn ge√ßti
            val daysSinceStart = ((today.timeInMillis - start.timeInMillis) / (24 * 60 * 60 * 1000)).toInt()

            // Ka√ß g√ºn sonra bir sonraki alarm g√ºn√º
            val remainder = daysSinceStart % intervalDays
            return if (remainder == 0) {
                intervalDays // Bug√ºn alarm g√ºn√º ise, gelecek interval g√ºn√º
            } else {
                intervalDays - remainder // Kalan g√ºnler
            }
        }

        /**
         * Bir ila√ß i√ßin t√ºm alarmlarƒ± iptal et
         */
        fun cancelReminders(context: Context, medicineId: String, times: List<String>) {
            val alarmManager = context.getSystemService(Context.ALARM_SERVICE) as AlarmManager

            times.forEach { time ->
                val intent = Intent(context, NotificationActionReceiver::class.java).apply {
                    action = ACTION_REMINDER_TRIGGER
                }

                val requestCode = getRequestCode(medicineId, time)

                val pendingIntent = PendingIntent.getBroadcast(
                    context,
                    requestCode,
                    intent,
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
                        PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
                    } else {
                        PendingIntent.FLAG_UPDATE_CURRENT
                    }
                )

                alarmManager.cancel(pendingIntent)
                pendingIntent.cancel()

                Log.d(TAG, "üö´ Alarm iptal edildi: $medicineId - $time (requestCode: $requestCode)")
            }
        }

        /**
         * T√ºm ila√ßlar i√ßin alarmlarƒ± yeniden planla
         * BootReceiver'dan √ßaƒürƒ±lƒ±r
         */
        fun rescheduleAllReminders(context: Context) {
            Log.d(TAG, "üìÖ T√ºm hatƒ±rlatmalar yeniden planlanƒ±yor...")

            val medicineRepository = MedicineRepository()

            CoroutineScope(Dispatchers.IO).launch {
                try {
                    val allMedicines = medicineRepository.getAllMedicines()
                    Log.d(TAG, "üì¶ ${allMedicines.size} ila√ß bulundu")

                    allMedicines.forEach { medicine ->
                        scheduleReminders(context, medicine)
                    }

                    Log.d(TAG, "‚úÖ T√ºm hatƒ±rlatmalar ba≈üarƒ±yla yeniden planlandƒ±")
                } catch (e: Exception) {
                    Log.e(TAG, "‚ùå Hatƒ±rlatmalar yeniden planlanƒ±rken hata", e)
                }
            }
        }

        /**
         * Medicine + time i√ßin unique request code olu≈ütur
         */
        private fun getRequestCode(medicineId: String, time: String): Int {
            return "$medicineId-$time".hashCode()
        }
    }
}

// ============================================================================
// FILE: SmartReminderHelper.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/notifications/SmartReminderHelper.kt
// [118 of 122]
// ============================================================================

package com.bardino.dozi.notifications

import android.content.Context
import android.util.Log
import com.bardino.dozi.core.data.repository.MedicationLogRepository
import com.bardino.dozi.core.data.repository.UserPreferencesRepository
import com.bardino.dozi.core.data.model.MedicationStatus
import com.google.gson.Gson
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import java.util.concurrent.TimeUnit

/**
 * üß† Akƒ±llƒ± hatƒ±rlatma √∂nerileri sunan helper
 *
 * Pattern tanƒ±ma:
 * - Kullanƒ±cƒ± bu ilacƒ± genellikle ne kadar ge√ß alƒ±yor?
 * - En √ßok hangi erteleme s√ºresini se√ßiyor?
 * - Zamanƒ± deƒüi≈ütirme √∂nerisi yapƒ±lmalƒ± mƒ±?
 */
object SmartReminderHelper {

    private const val TAG = "SmartReminderHelper"
    private const val ANALYSIS_DAYS = 14 // Son 14 g√ºn√º analiz et
    private const val MIN_SAMPLES = 3 // En az 3 √∂rnek olmalƒ± pattern tanƒ±ma i√ßin

    /**
     * Akƒ±llƒ± erteleme √∂nerisi
     *
     * @return Pair<snoozeMinutes, suggestion>
     * √∂rnek: (30, "Genellikle 30 dk sonra alƒ±yorsunuz")
     */
    suspend fun getSmartSnoozeSuggestion(
        context: Context,
        medicineId: String,
        scheduledTime: Long
    ): Pair<Int?, String?> = withContext(Dispatchers.IO) {
        try {
            val logRepository = MedicationLogRepository(
                context,
                com.google.firebase.auth.FirebaseAuth.getInstance(),
                com.google.firebase.firestore.FirebaseFirestore.getInstance()
            )

            // Son 14 g√ºn i√ßinde bu ila√ß i√ßin alƒ±nan/ertelenen loglarƒ± al
            val startTime = System.currentTimeMillis() - (ANALYSIS_DAYS * 24 * 60 * 60 * 1000L)
            val logs = logRepository.getLogsForMedicine(medicineId, startTime)
            val snoozedLogs = logs.filter { it.status == MedicationStatus.SNOOZED }

            // Eƒüer yeterli √∂rnek varsa, pattern analizi yap
            if (snoozedLogs.size >= MIN_SAMPLES) {
                // En √ßok kullanƒ±lan erteleme s√ºresini bul
                // Not: ≈ûu an notes'tan parse ediyoruz, ileride daha iyi bir y√∂ntem olabilir
                val snoozeMinutes = snoozedLogs.mapNotNull { log ->
                    log.notes?.let { note ->
                        val regex = """Snoozed for (\d+) minutes""".toRegex()
                        regex.find(note)?.groupValues?.get(1)?.toIntOrNull()
                    }
                }.groupingBy { it }.eachCount().maxByOrNull { it.value }?.key

                if (snoozeMinutes != null) {
                    return@withContext (snoozeMinutes to "Genellikle $snoozeMinutes dk erteliyorsunuz")
                }
            }

            // Firestore'da pattern yoksa, SharedPreferences'tan sofistike pattern verilerini oku
            val prefs = context.getSharedPreferences("dozi_prefs", Context.MODE_PRIVATE)

            // √ñncelik sƒ±rasƒ±: mode (en √ßok kullanƒ±lan) > ortalama > son erteleme
            val modeSnoozeMinutes = prefs.getInt("mode_snooze_minutes_$medicineId", -1)
            val avgSnoozeMinutes = prefs.getInt("avg_snooze_minutes_$medicineId", -1)
            val lastSnoozeMinutes = prefs.getInt("last_snooze_minutes_$medicineId", -1)

            // En √ßok kullanƒ±lan erteleme s√ºresi varsa onu √∂ner
            if (modeSnoozeMinutes > 0) {
                return@withContext (modeSnoozeMinutes to "Genellikle $modeSnoozeMinutes dk erteliyorsunuz")
            }

            // Ortalama varsa onu √∂ner
            if (avgSnoozeMinutes > 0) {
                return@withContext (avgSnoozeMinutes to "Ortalama $avgSnoozeMinutes dk erteliyorsunuz")
            }

            // Son erteleme varsa onu √∂ner
            if (lastSnoozeMinutes > 0) {
                return@withContext (lastSnoozeMinutes to "Ge√ßen seferde $lastSnoozeMinutes dk ertelemi≈ütiniz")
            }

            // Pattern yok
            return@withContext (null to null)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Error getting smart snooze suggestion", e)
            return@withContext (null to null)
        }
    }

    /**
     * Zamanƒ± deƒüi≈ütirme √∂nerisi yap
     *
     * "Hep yarƒ±m saat ge√ß alƒ±yorsunuz, artƒ±k ≈üu saatte almak ister misiniz?"
     *
     * @return Pair<newTime, suggestion>
     * √∂rnek: ("09:30", "Bu ilacƒ± genellikle 09:30'da alƒ±yorsunuz. Hatƒ±rlatma zamanƒ±nƒ± deƒüi≈ütirmek ister misiniz?")
     */
    suspend fun getTimeAdjustmentSuggestion(
        context: Context,
        medicineId: String,
        scheduledTimeStr: String // "09:00"
    ): Pair<String?, String?> = withContext(Dispatchers.IO) {
        try {
            val logRepository = MedicationLogRepository(
                context,
                com.google.firebase.auth.FirebaseAuth.getInstance(),
                com.google.firebase.firestore.FirebaseFirestore.getInstance()
            )

            // Son N hatƒ±rlatmayƒ± analiz et
            val startTime = System.currentTimeMillis() - (ANALYSIS_DAYS * 24 * 60 * 60 * 1000L)
            val logs = logRepository.getLogsForMedicine(medicineId, startTime)
            val takenLogs = logs.filter { it.status == MedicationStatus.TAKEN && it.takenAt != null && it.scheduledTime != null }

            // Eƒüer yeterli √∂rnek varsa, gecikme analizi yap
            if (takenLogs.size >= MIN_SAMPLES) {
                // scheduledTime vs takenAt farkƒ±nƒ± hesapla
                val delays = takenLogs.mapNotNull { log ->
                    val scheduled = log.scheduledTime?.toDate()?.time ?: return@mapNotNull null
                    val taken = log.takenAt?.toDate()?.time ?: return@mapNotNull null
                    val delayMinutes = TimeUnit.MILLISECONDS.toMinutes(taken - scheduled)
                    if (delayMinutes > 0) delayMinutes.toInt() else null
                }

                // Ortalama gecikme hesapla
                if (delays.isNotEmpty()) {
                    val avgDelayMinutes = delays.average().toInt()

                    if (avgDelayMinutes >= 30) {
                        // Yeni saat hesapla
                        val (hour, minute) = scheduledTimeStr.split(":").map { it.toInt() }
                        val newHour = (hour + avgDelayMinutes / 60) % 24
                        val newMinute = (minute + avgDelayMinutes % 60) % 60
                        val newTime = String.format("%02d:%02d", newHour, newMinute)

                        return@withContext (newTime to "Bu ilacƒ± genellikle $newTime'de alƒ±yorsunuz. Hatƒ±rlatma zamanƒ±nƒ± deƒüi≈ütirmek ister misiniz?")
                    }
                }
            }

            // Firestore'da pattern yoksa, SharedPreferences'tan son alma gecikmesini oku
            val prefs = context.getSharedPreferences("dozi_prefs", Context.MODE_PRIVATE)
            val avgDelayMinutes = prefs.getInt("avg_delay_minutes_$medicineId", -1)

            if (avgDelayMinutes >= 30) {
                // Yeni saat hesapla
                val (hour, minute) = scheduledTimeStr.split(":").map { it.toInt() }
                val newHour = (hour + avgDelayMinutes / 60) % 24
                val newMinute = (minute + avgDelayMinutes % 60) % 60
                val newTime = String.format("%02d:%02d", newHour, newMinute)

                return@withContext (newTime to "Bu ilacƒ± genellikle $newTime'de alƒ±yorsunuz. Hatƒ±rlatma zamanƒ±nƒ± deƒüi≈ütirmek ister misiniz?")
            }

            // Pattern yok
            return@withContext (null to null)
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Error getting time adjustment suggestion", e)
            return@withContext (null to null)
        }
    }

    /**
     * Erteleme sonrasƒ± analiz yap ve pattern'i kaydet
     *
     * Kullanƒ±cƒ± erteleme se√ßtikten sonra bu fonksiyon √ßaƒürƒ±lƒ±r
     */
    suspend fun recordSnoozePattern(
        context: Context,
        medicineId: String,
        snoozeMinutes: Int,
        scheduledTime: Long
    ) = withContext(Dispatchers.IO) {
        try {
            val prefs = context.getSharedPreferences("dozi_prefs", Context.MODE_PRIVATE)
            val gson = Gson()

            // Son 5 erteleme s√ºresini array olarak sakla (circular buffer)
            val snoozeHistoryKey = "snooze_history_$medicineId"
            val snoozeHistoryJson = prefs.getString(snoozeHistoryKey, "[]")
            val snoozeHistory = gson.fromJson(snoozeHistoryJson, Array<Int>::class.java)?.toMutableList() ?: mutableListOf()

            // Yeni erteleme s√ºresini ekle
            snoozeHistory.add(snoozeMinutes)

            // En fazla 5 √∂rnek tut (en eski kaydƒ± sil)
            if (snoozeHistory.size > 5) {
                snoozeHistory.removeAt(0)
            }

            // Ortalama erteleme s√ºresini hesapla
            val avgSnooze = if (snoozeHistory.isNotEmpty()) {
                snoozeHistory.average().toInt()
            } else {
                snoozeMinutes
            }

            // En √ßok kullanƒ±lan erteleme s√ºresini bul (mode)
            val modeSnooze = snoozeHistory
                .groupingBy { it }
                .eachCount()
                .maxByOrNull { it.value }
                ?.key ?: snoozeMinutes

            // Verileri kaydet
            prefs.edit()
                .putInt("last_snooze_minutes_$medicineId", snoozeMinutes)
                .putLong("last_snooze_timestamp_$medicineId", System.currentTimeMillis())
                .putString(snoozeHistoryKey, gson.toJson(snoozeHistory))
                .putInt("avg_snooze_minutes_$medicineId", avgSnooze)
                .putInt("mode_snooze_minutes_$medicineId", modeSnooze)
                .apply()

            // ‚úÖ Firebase'e senkronize et
            try {
                val userPrefsRepo = UserPreferencesRepository(context)
                userPrefsRepo.syncSmartPattern(
                    medicineId = medicineId,
                    modeSnoozeMinutes = modeSnooze,
                    avgSnoozeMinutes = avgSnooze,
                    lastSnoozeMinutes = snoozeMinutes
                )
                userPrefsRepo.syncSnoozeHistory(medicineId, snoozeHistory)
            } catch (e: Exception) {
                Log.e(TAG, "‚ùå Smart pattern Firebase'e senkronize edilemedi", e)
            }

            Log.d(TAG, "‚úÖ Snooze pattern kaydedildi: $medicineId -> son: $snoozeMinutes dk, ortalama: $avgSnooze dk, en √ßok: $modeSnooze dk")
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Error recording snooze pattern", e)
        }
    }

    /**
     * ƒ∞la√ß alƒ±ndƒ±ktan sonra gecikme analizi yap
     *
     * Scheduled time vs actual taken time farkƒ±nƒ± hesapla ve kaydet
     */
    suspend fun recordDelayPattern(
        context: Context,
        medicineId: String,
        scheduledTime: Long,
        takenTime: Long
    ) = withContext(Dispatchers.IO) {
        try {
            val delayMinutes = TimeUnit.MILLISECONDS.toMinutes(takenTime - scheduledTime)

            if (delayMinutes <= 0) {
                // Zamanƒ±nda veya erken alƒ±ndƒ±, pattern yok
                return@withContext
            }

            val prefs = context.getSharedPreferences("dozi_prefs", Context.MODE_PRIVATE)

            // Son 5 gecikmeyi kaydet (circular buffer)
            val delaysKey = "delay_history_$medicineId"
            val delaysJson = prefs.getString(delaysKey, "[]")
            val delays = com.google.gson.Gson().fromJson(delaysJson, Array<Int>::class.java)?.toMutableList() ?: mutableListOf()

            delays.add(delayMinutes.toInt())
            if (delays.size > 5) {
                delays.removeAt(0) // En eski kaydƒ± sil
            }

            // Ortalama gecikme hesapla
            val avgDelay = if (delays.isNotEmpty()) delays.average().toInt() else 0

            prefs.edit()
                .putString(delaysKey, com.google.gson.Gson().toJson(delays))
                .putInt("avg_delay_minutes_$medicineId", avgDelay)
                .apply()

            // ‚úÖ Firebase'e senkronize et
            try {
                val userPrefsRepo = UserPreferencesRepository(context)
                userPrefsRepo.syncSmartPattern(
                    medicineId = medicineId,
                    avgDelayMinutes = avgDelay
                )
            } catch (e: Exception) {
                Log.e(TAG, "‚ùå Delay pattern Firebase'e senkronize edilemedi", e)
            }

            Log.d(TAG, "‚úÖ Delay pattern kaydedildi: $medicineId -> ortalama $avgDelay dk gecikme")
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Error recording delay pattern", e)
        }
    }

    /**
     * Kullanƒ±cƒ±nƒ±n ge√ßmi≈ü davranƒ±≈ülarƒ±na g√∂re √∂nerilen erteleme s√ºreleri
     *
     * @return List<Pair<minutes, displayText>>
     * √∂rnek: [(10, "10 dakika"), (30, "30 dakika ‚≠ê"), (60, "1 saat")]
     * ‚≠ê i≈üareti en √ßok kullanƒ±lan s√ºreyi g√∂sterir
     */
    suspend fun getSuggestedSnoozeTimes(
        context: Context,
        medicineId: String
    ): List<Pair<Int, String>> = withContext(Dispatchers.IO) {
        try {
            val prefs = context.getSharedPreferences("dozi_prefs", Context.MODE_PRIVATE)

            // En √ßok kullanƒ±lan erteleme s√ºresini al (mode)
            val modeSnoozeMinutes = prefs.getInt("mode_snooze_minutes_$medicineId", -1)

            val defaultTimes = listOf(
                10 to "10 dakika",
                20 to "20 dakika",
                30 to "30 dakika",
                60 to "1 saat"
            )

            // Eƒüer kullanƒ±cƒ±nƒ±n en √ßok kullandƒ±ƒüƒ± erteleme s√ºresi varsa, o s√ºreyi ‚≠ê ile i≈üaretle
            if (modeSnoozeMinutes > 0) {
                return@withContext defaultTimes.map { (minutes, text) ->
                    if (minutes == modeSnoozeMinutes) {
                        minutes to "$text ‚≠ê"
                    } else {
                        minutes to text
                    }
                }
            }

            return@withContext defaultTimes
        } catch (e: Exception) {
            Log.e(TAG, "‚ùå Error getting suggested snooze times", e)
            return@withContext listOf(
                10 to "10 dakika",
                20 to "20 dakika",
                30 to "30 dakika",
                60 to "1 saat"
            )
        }
    }
}

// ============================================================================
// FILE: SnoozePromptActivity.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/notifications/SnoozePromptActivity.kt
// [119 of 122]
// ============================================================================

package com.bardino.dozi.notifications

import android.app.AlertDialog
import android.content.Context
import android.content.Intent
import android.os.Bundle
import android.widget.Toast
import androidx.activity.ComponentActivity
import androidx.lifecycle.lifecycleScope
import com.bardino.dozi.MainActivity
import com.bardino.dozi.core.data.model.User
import com.bardino.dozi.core.data.repository.UserPreferencesRepository
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import kotlinx.coroutines.launch
import kotlinx.coroutines.tasks.await

class SnoozePromptActivity : ComponentActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        val medName = intent.getStringExtra("medicine") ?: "ƒ∞la√ß"
        val medicineId = intent.getStringExtra("medicineId") ?: ""
        val scheduledTime = intent.getLongExtra("scheduledTime", System.currentTimeMillis())

        showSmartSnoozeDialog(medName, medicineId, scheduledTime)
    }

    private fun showSmartSnoozeDialog(medicineName: String, medicineId: String, scheduledTime: Long) {
        lifecycleScope.launch {
            // üîê Kullanƒ±cƒ± ayarlarƒ±nƒ± kontrol et
            val user = getUserSettings()
            val smartReminderEnabled = user?.smartReminderEnabled ?: false

            // üß† Akƒ±llƒ± √∂neriler al (eƒüer kullanƒ±cƒ± aktif ettiyse)
            val suggestedTimes = if (smartReminderEnabled) {
                SmartReminderHelper.getSuggestedSnoozeTimes(this@SnoozePromptActivity, medicineId)
            } else {
                // Default se√ßenekler (akƒ±llƒ± √∂neri yok)
                listOf(
                    10 to "10 dakika",
                    20 to "20 dakika",
                    30 to "30 dakika",
                    60 to "1 saat"
                )
            }
            val times = suggestedTimes.map { it.second }.toTypedArray()
            val minutes = suggestedTimes.map { it.first }.toIntArray()

            // üß† Zamanƒ± deƒüi≈ütirme √∂nerisi al (eƒüer kullanƒ±cƒ± aktif ettiyse)
            val (newTime, timeSuggestion) = if (smartReminderEnabled) {
                SmartReminderHelper.getTimeAdjustmentSuggestion(
                    this@SnoozePromptActivity,
                    medicineId,
                    intent.getStringExtra("time") ?: "09:00"
                )
            } else {
                null to null
            }

            var selectedIndex = 0

            val builder = AlertDialog.Builder(this@SnoozePromptActivity)
            builder.setTitle("Tamam, ne kadar erteleyelim peki?")

            // üí° Eƒüer zamanƒ± deƒüi≈ütirme √∂nerisi varsa mesaj olarak g√∂ster
            if (timeSuggestion != null) {
                builder.setMessage("üí° $timeSuggestion")
            }

            builder.setSingleChoiceItems(times, 0) { _, which ->
                selectedIndex = which
            }

            builder.setPositiveButton("Ertele") { dialog, _ ->
                val min = minutes[selectedIndex]
                val currentTime = System.currentTimeMillis()

                // ‚úÖ Erteleme ba≈ülangƒ±√ß zamanƒ±: ƒ∞la√ß saati veya ≈üu an (hangisi daha ge√ß ise)
                val snoozeFromTime = maxOf(scheduledTime, currentTime)
                val snoozeUntilTime = snoozeFromTime + min * 60_000L

                // ‚úÖ Erteleme planla (t√ºm parametrelerle)
                NotificationHelper.scheduleSnooze(
                    context = this@SnoozePromptActivity,
                    medicineName = medicineName,
                    medicineId = medicineId,
                    dosage = intent.getStringExtra("dosage") ?: "",
                    time = intent.getStringExtra("time") ?: "",
                    scheduledTime = scheduledTime,
                    minutes = min
                )

                // ‚úÖ SharedPreferences'a timestamp ile kaydet
                val snoozeUntil = currentTime + min * 60_000L
                getSharedPreferences("dozi_prefs", Context.MODE_PRIVATE).edit()
                    .putString("last_action", "ERTELENDI:$medicineName:$min dk")
                    .putLong("snooze_until", snoozeUntilTime)
                    .putInt("snooze_minutes", min)
                    .putLong("snooze_timestamp", currentTime)
                    .putLong("snooze_from", snoozeFromTime)
                    .apply()

                // ‚úÖ Firebase'e senkronize et
                lifecycleScope.launch {
                    val userPrefsRepo = UserPreferencesRepository(this@SnoozePromptActivity)
                    userPrefsRepo.syncSnoozeData(
                        snoozeMinutes = min,
                        snoozeUntil = snoozeUntil,
                        snoozeTimestamp = currentTime,
                        medicineId = medicineId
                    )
                }

                // üß† Pattern'i kaydet (gelecekteki √∂neriler i√ßin - eƒüer kullanƒ±cƒ± aktif ettiyse)
                if (smartReminderEnabled) {
                    lifecycleScope.launch {
                        SmartReminderHelper.recordSnoozePattern(
                            this@SnoozePromptActivity,
                            medicineId,
                            min,
                            scheduledTime
                        )
                    }
                }

                // Hatƒ±rlatma saatini hesapla ve g√∂ster
                val calendar = java.util.Calendar.getInstance().apply {
                    timeInMillis = snoozeUntilTime
                }
                val snoozeHour = calendar.get(java.util.Calendar.HOUR_OF_DAY)
                val snoozeMinute = calendar.get(java.util.Calendar.MINUTE)
                val formattedTime = String.format("%02d:%02d", snoozeHour, snoozeMinute)

                Toast.makeText(
                    this@SnoozePromptActivity,
                    "$medicineName saat $formattedTime'de hatƒ±rlatƒ±lacak ‚è∞",
                    Toast.LENGTH_LONG
                ).show()

                // ‚úÖ Ana sayfaya d√∂n (finish'ten √ñNCE)
                val intent = Intent(this@SnoozePromptActivity, MainActivity::class.java).apply {
                    addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK)
                }
                startActivity(intent)

                dialog.dismiss()
                finish() // ‚úÖ En sona ta≈üƒ±ndƒ±
            }

            // üí° "Zamanƒ± Deƒüi≈ütir" butonu ekle (eƒüer √∂neri varsa)
            if (newTime != null && timeSuggestion != null) {
                builder.setNeutralButton("Zamanƒ± Deƒüi≈ütir") { dialog, _ ->
                    // ƒ∞lacƒ±n hatƒ±rlatma zamanƒ±nƒ± deƒüi≈ütirmek i√ßin EditReminder ekranƒ±na y√∂nlendir
                    val editIntent = Intent(this@SnoozePromptActivity, MainActivity::class.java).apply {
                        addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK)
                        putExtra("navigate_to", "edit_reminder")
                        putExtra("medicine_id", medicineId)
                    }
                    startActivity(editIntent)
                    dialog.dismiss()
                    finish()
                }
            }

            builder.setCancelable(false)

            val dialog = builder.create()
            dialog.show()
        }
    }

    /**
     * Kullanƒ±cƒ± ayarlarƒ±nƒ± Firestore'dan al
     */
    private suspend fun getUserSettings(): User? {
        return try {
            val currentUser = FirebaseAuth.getInstance().currentUser ?: return null
            val db = FirebaseFirestore.getInstance()
            val doc = db.collection("users").document(currentUser.uid).get().await()
            doc.toObject(User::class.java)
        } catch (e: Exception) {
            android.util.Log.e("SnoozePromptActivity", "Error getting user settings", e)
            null
        }
    }
}
// ============================================================================
// FILE: ReminderWidget.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/widget/ReminderWidget.kt
// [120 of 122]
// ============================================================================

package com.bardino.dozi.widget

import android.content.Context
import android.content.Intent
import android.os.Build
import androidx.annotation.RequiresApi
import androidx.compose.runtime.Composable
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.datastore.preferences.core.Preferences
import androidx.glance.*
import androidx.glance.action.ActionParameters
import androidx.glance.action.actionParametersOf
import androidx.glance.action.actionStartActivity
import androidx.glance.action.clickable
import androidx.glance.appwidget.GlanceAppWidget
import androidx.glance.appwidget.GlanceAppWidgetManager
import androidx.glance.appwidget.SizeMode
import androidx.glance.appwidget.action.ActionCallback
import androidx.glance.appwidget.action.actionRunCallback
import androidx.glance.appwidget.cornerRadius
import androidx.glance.appwidget.provideContent
import androidx.glance.appwidget.state.updateAppWidgetState
import androidx.glance.layout.*
import androidx.glance.state.GlanceStateDefinition
import androidx.glance.text.FontWeight
import androidx.glance.text.Text
import androidx.glance.text.TextAlign
import androidx.glance.text.TextStyle
import androidx.glance.unit.ColorProvider
import com.bardino.dozi.MainActivity
import com.bardino.dozi.core.data.model.Medicine
import com.bardino.dozi.core.data.repository.MedicationLogRepository
import com.bardino.dozi.core.data.repository.MedicineRepository
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import java.util.Calendar
import androidx.glance.background
import androidx.glance.color.ColorProvider

/**
 * Dozi Hatƒ±rlatma Widget'ƒ±
 */
class ReminderWidget : GlanceAppWidget() {

    override val stateDefinition: GlanceStateDefinition<*> = ReminderWidgetStateDefinition
    override val sizeMode = SizeMode.Exact

    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            Content(context)
        }
    }

    @Composable
    private fun Content(context: Context) {
        val prefs = currentState<Preferences>()
        val currentIndex = prefs[ReminderWidgetKeys.CURRENT_INDEX] ?: 0
        val totalCount = prefs[ReminderWidgetKeys.TOTAL_COUNT] ?: 0
        val remindersJson = prefs[ReminderWidgetKeys.REMINDERS_JSON] ?: "[]"

        val reminders = try {
            val type = object : TypeToken<List<WidgetReminder>>() {}.type
            Gson().fromJson<List<WidgetReminder>>(remindersJson, type) ?: emptyList()
        } catch (e: Exception) {
            emptyList()
        }

        val currentReminder = reminders.getOrNull(currentIndex)

        Box(
            modifier = GlanceModifier
                .fillMaxSize()
                .padding(8.dp)
                .background(
                    ColorProvider(
                        day = Color(WidgetColors.BackgroundLight),
                        night = Color(WidgetColors.BackgroundDark)
                    )
                )
                .cornerRadius(16.dp)
        ) {
            if (currentReminder != null) {
                ReminderContent(
                    reminder = currentReminder,
                    currentIndex = currentIndex,
                    totalCount = totalCount,
                    hasPrevious = currentIndex > 0,
                    hasNext = currentIndex < totalCount - 1
                )
            } else {
                EmptyContent()
            }
        }
    }
}

@Composable
private fun ReminderContent(
    reminder: WidgetReminder,
    currentIndex: Int,
    totalCount: Int,
    hasPrevious: Boolean,
    hasNext: Boolean
) {
    Column(
        modifier = GlanceModifier.fillMaxSize().padding(8.dp),
        verticalAlignment = Alignment.CenterVertically,
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Row(
            modifier = GlanceModifier.fillMaxWidth(),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Text(
                text = "${currentIndex + 1}/$totalCount",
                style = TextStyle(
                    color = ColorProvider(
                        day = Color(WidgetColors.TextSecondary),
                        night = Color(WidgetColors.TextSecondary)
                    ),
                    fontSize = 12.sp
                )
            )
        }

        Spacer(GlanceModifier.height(4.dp))

        Row(
            modifier = GlanceModifier.fillMaxWidth(),
            verticalAlignment = Alignment.CenterVertically,
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            // Sol ok
            Box(
                modifier = GlanceModifier
                    .size(36.dp)
                    .cornerRadius(18.dp)
                    .background(
                        ColorProvider(
                            day = Color(if (hasPrevious) WidgetColors.Primary else WidgetColors.Disabled),
                            night = Color(if (hasPrevious) WidgetColors.Primary else WidgetColors.Disabled)
                        )
                    )
                    .clickable(
                        onClick = if (hasPrevious) actionRunCallback<PreviousReminderAction>()
                        else actionRunCallback<NoOpAction>()
                    ),
                contentAlignment = Alignment.Center
            ) {
                Text(
                    text = "<",
                    style = TextStyle(
                        color = ColorProvider(day = Color.White, night = Color.White),
                        fontSize = 18.sp,
                        fontWeight = FontWeight.Bold
                    )
                )
            }

            Spacer(GlanceModifier.width(8.dp))

            Column(
                modifier = GlanceModifier.defaultWeight(),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Text(
                    text = reminder.icon,
                    style = TextStyle(fontSize = 28.sp)
                )

                Spacer(GlanceModifier.height(4.dp))

                Text(
                    text = reminder.medicineName,
                    style = TextStyle(
                        color = ColorProvider(
                            day = Color(WidgetColors.TextPrimary),
                            night = Color(WidgetColors.TextPrimary)
                        ),
                        fontSize = 16.sp,
                        fontWeight = FontWeight.Bold,
                        textAlign = TextAlign.Center
                    ),
                    maxLines = 1
                )

                Spacer(GlanceModifier.height(2.dp))

                Text(
                    text = reminder.time,
                    style = TextStyle(
                        color = ColorProvider(
                            day = Color(WidgetColors.Primary),
                            night = Color(WidgetColors.Primary)
                        ),
                        fontSize = 20.sp,
                        fontWeight = FontWeight.Bold
                    )
                )

                Spacer(GlanceModifier.height(2.dp))

                Text(
                    text = "${reminder.dosage} ${reminder.unit}",
                    style = TextStyle(
                        color = ColorProvider(
                            day = Color(WidgetColors.TextSecondary),
                            night = Color(WidgetColors.TextSecondary)
                        ),
                        fontSize = 12.sp
                    )
                )
            }

            Spacer(GlanceModifier.width(8.dp))

            // Saƒü ok
            Box(
                modifier = GlanceModifier
                    .size(36.dp)
                    .cornerRadius(18.dp)
                    .background(
                        ColorProvider(
                            day = Color(if (hasNext) WidgetColors.Primary else WidgetColors.Disabled),
                            night = Color(if (hasNext) WidgetColors.Primary else WidgetColors.Disabled)
                        )
                    )
                    .clickable(
                        onClick = if (hasNext) actionRunCallback<NextReminderAction>()
                        else actionRunCallback<NoOpAction>()
                    ),
                contentAlignment = Alignment.Center
            ) {
                Text(
                    text = ">",
                    style = TextStyle(
                        color = ColorProvider(day = Color.White, night = Color.White),
                        fontSize = 18.sp,
                        fontWeight = FontWeight.Bold
                    )
                )
            }
        }

        Spacer(GlanceModifier.height(8.dp))

        Row(
            modifier = GlanceModifier.fillMaxWidth(),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            // Aldƒ±m butonu
            Box(
                modifier = GlanceModifier
                    .width(80.dp)
                    .height(32.dp)
                    .cornerRadius(16.dp)
                    .background(ColorProvider(day = Color(WidgetColors.Success), night = Color(WidgetColors.Success)))
                    .clickable(
                        onClick = actionRunCallback<TakeMedicineAction>(
                            parameters = actionParametersOf(
                                ActionParamKeys.MEDICINE_ID to reminder.medicineId,
                                ActionParamKeys.MEDICINE_NAME to reminder.medicineName,
                                ActionParamKeys.DOSAGE to reminder.dosage,
                                ActionParamKeys.TIME to reminder.time
                            )
                        )
                    ),
                contentAlignment = Alignment.Center
            ) {
                Text(
                    text = "Aldƒ±m",
                    style = TextStyle(
                        color = ColorProvider(day = Color.White, night = Color.White),
                        fontSize = 14.sp,
                        fontWeight = FontWeight.Medium
                    )
                )
            }

            Spacer(GlanceModifier.width(12.dp))

            // Atla butonu
            Box(
                modifier = GlanceModifier
                    .width(80.dp)
                    .height(32.dp)
                    .cornerRadius(16.dp)
                    .background(ColorProvider(day = Color(WidgetColors.Secondary), night = Color(WidgetColors.Secondary)))
                    .clickable(
                        onClick = actionRunCallback<SkipMedicineAction>(
                            parameters = actionParametersOf(
                                ActionParamKeys.MEDICINE_ID to reminder.medicineId,
                                ActionParamKeys.MEDICINE_NAME to reminder.medicineName,
                                ActionParamKeys.DOSAGE to reminder.dosage,
                                ActionParamKeys.TIME to reminder.time
                            )
                        )
                    ),
                contentAlignment = Alignment.Center
            ) {
                Text(
                    text = "Atla",
                    style = TextStyle(
                        color = ColorProvider(day = Color.White, night = Color.White),
                        fontSize = 14.sp,
                        fontWeight = FontWeight.Medium
                    )
                )
            }
        }
    }
}

@Composable
private fun EmptyContent() {
    Column(
        modifier = GlanceModifier
            .fillMaxSize()
            .padding(16.dp)
            .clickable(onClick = actionStartActivity<MainActivity>()),
        verticalAlignment = Alignment.CenterVertically,
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Text(text = "üíä", style = TextStyle(fontSize = 32.sp))

        Spacer(GlanceModifier.height(8.dp))

        Text(
            text = "Bug√ºn ila√ß yok",
            style = TextStyle(
                color = ColorProvider(day = Color(WidgetColors.TextSecondary), night = Color(WidgetColors.TextSecondary)),
                fontSize = 14.sp,
                textAlign = TextAlign.Center
            )
        )

        Spacer(GlanceModifier.height(4.dp))

        Text(
            text = "Dokunarak a√ß",
            style = TextStyle(
                color = ColorProvider(day = Color(WidgetColors.Primary), night = Color(WidgetColors.Primary)),
                fontSize = 12.sp
            )
        )
    }
}

object WidgetColors {
    val Primary = android.graphics.Color.parseColor("#A78BFA")
    val Secondary = android.graphics.Color.parseColor("#FDA4AF")
    val Success = android.graphics.Color.parseColor("#6EE7B7")
    val Disabled = android.graphics.Color.parseColor("#E0E0E0")
    val TextPrimary = android.graphics.Color.parseColor("#212121")
    val TextSecondary = android.graphics.Color.parseColor("#757575")
    val BackgroundLight = android.graphics.Color.parseColor("#F3E8FF")
    val BackgroundDark = android.graphics.Color.parseColor("#1E1E1E")
}

object ActionParamKeys {
    val MEDICINE_ID = ActionParameters.Key<String>("medicine_id")
    val MEDICINE_NAME = ActionParameters.Key<String>("medicine_name")
    val DOSAGE = ActionParameters.Key<String>("dosage")
    val TIME = ActionParameters.Key<String>("time")
}

class NoOpAction : ActionCallback {
    override suspend fun onAction(context: Context, glanceId: GlanceId, parameters: ActionParameters) {}
}

class PreviousReminderAction : ActionCallback {
    override suspend fun onAction(context: Context, glanceId: GlanceId, parameters: ActionParameters) {
        updateAppWidgetState(context, ReminderWidgetStateDefinition, glanceId) { prefs ->
            prefs.toMutablePreferences().apply {
                val currentIndex = this[ReminderWidgetKeys.CURRENT_INDEX] ?: 0
                this[ReminderWidgetKeys.CURRENT_INDEX] = (currentIndex - 1).coerceAtLeast(0)
            }
        }
        ReminderWidget().update(context, glanceId)
    }
}

class NextReminderAction : ActionCallback {
    override suspend fun onAction(context: Context, glanceId: GlanceId, parameters: ActionParameters) {
        updateAppWidgetState(context, ReminderWidgetStateDefinition, glanceId) { prefs ->
            val currentIndex = prefs[ReminderWidgetKeys.CURRENT_INDEX] ?: 0
            val totalCount = prefs[ReminderWidgetKeys.TOTAL_COUNT] ?: 0

            prefs.toMutablePreferences().apply {
                this[ReminderWidgetKeys.CURRENT_INDEX] =
                    (currentIndex + 1).coerceAtMost(totalCount - 1)
            }
        }
        ReminderWidget().update(context, glanceId)
    }
}

class TakeMedicineAction : ActionCallback {
    @RequiresApi(Build.VERSION_CODES.O)
    override suspend fun onAction(context: Context, glanceId: GlanceId, parameters: ActionParameters) {
        val medicineId = parameters[ActionParamKeys.MEDICINE_ID] ?: return
        val medicineName = parameters[ActionParamKeys.MEDICINE_NAME] ?: return
        val dosage = parameters[ActionParamKeys.DOSAGE] ?: return
        val time = parameters[ActionParamKeys.TIME] ?: return

        val scheduledTime = parseTimeToMillis(time)
        val repository = MedicationLogRepository(context)

        withContext(Dispatchers.IO) {
            repository.logMedicationTaken(
                medicineId = medicineId,
                medicineName = medicineName,
                dosage = dosage,
                scheduledTime = scheduledTime
            )
        }

        saveMedicineStatus(context, medicineId, time, "taken")
        ReminderWidgetUpdater.updateWidgets(context)
    }

    private fun parseTimeToMillis(time: String): Long {
        val parts = time.split(":")
        val hour = parts.getOrNull(0)?.toIntOrNull() ?: 0
        val minute = parts.getOrNull(1)?.toIntOrNull() ?: 0

        return Calendar.getInstance().apply {
            set(Calendar.HOUR_OF_DAY, hour)
            set(Calendar.MINUTE, minute)
            set(Calendar.SECOND, 0)
            set(Calendar.MILLISECOND, 0)
        }.timeInMillis
    }

    private fun saveMedicineStatus(context: Context, medicineId: String, time: String, status: String) {
        val prefs = context.getSharedPreferences("medicine_status", Context.MODE_PRIVATE)
        val today = java.text.SimpleDateFormat("dd/MM/yyyy", java.util.Locale.getDefault())
            .format(java.util.Date())
        val key = "dose_${medicineId}_${today}_${time}"
        prefs.edit().putString(key, status).apply()
    }
}

class SkipMedicineAction : ActionCallback {
    @RequiresApi(Build.VERSION_CODES.O)
    override suspend fun onAction(context: Context, glanceId: GlanceId, parameters: ActionParameters) {
        val medicineId = parameters[ActionParamKeys.MEDICINE_ID] ?: return
        val medicineName = parameters[ActionParamKeys.MEDICINE_NAME] ?: return
        val dosage = parameters[ActionParamKeys.DOSAGE] ?: return
        val time = parameters[ActionParamKeys.TIME] ?: return

        val scheduledTime = parseTimeToMillis(time)
        val repository = MedicationLogRepository(context)

        withContext(Dispatchers.IO) {
            repository.logMedicationSkipped(
                medicineId = medicineId,
                medicineName = medicineName,
                dosage = dosage,
                scheduledTime = scheduledTime,
                reason = "Widget'tan atlandƒ±"
            )
        }

        saveMedicineStatus(context, medicineId, time, "skipped")

        ReminderWidgetUpdater.updateWidgets(context)
    }

    private fun parseTimeToMillis(time: String): Long {
        val parts = time.split(":")
        val hour = parts.getOrNull(0)?.toIntOrNull() ?: 0
        val minute = parts.getOrNull(1)?.toIntOrNull() ?: 0

        return Calendar.getInstance().apply {
            set(Calendar.HOUR_OF_DAY, hour)
            set(Calendar.MINUTE, minute)
            set(Calendar.SECOND, 0)
            set(Calendar.MILLISECOND, 0)
        }.timeInMillis
    }

    private fun saveMedicineStatus(context: Context, medicineId: String, time: String, status: String) {
        val prefs = context.getSharedPreferences("medicine_status", Context.MODE_PRIVATE)
        val today = java.text.SimpleDateFormat("dd/MM/yyyy", java.util.Locale.getDefault())
            .format(java.util.Date())
        val key = "dose_${medicineId}_${today}_${time}"
        prefs.edit().putString(key, status).apply()
    }
}

object ReminderWidgetUpdater {

    @RequiresApi(Build.VERSION_CODES.O)
    suspend fun updateWidgets(context: Context) {
        val glanceIds = GlanceAppWidgetManager(context).getGlanceIds(ReminderWidget::class.java)

        val repository = MedicineRepository()
        val upcomingMedicines = withContext(Dispatchers.IO) {
            try {
                repository.getUpcomingMedicines(context)
            } catch (e: Exception) {
                android.util.Log.e("ReminderWidget", "Error fetching medicines", e)
                emptyList()
            }
        }

        val reminders = upcomingMedicines.map { (medicine, time) ->
            WidgetReminder(
                medicineId = medicine.id,
                medicineName = medicine.name,
                dosage = medicine.dosage,
                unit = medicine.unit,
                time = time,
                icon = medicine.icon,
                colorHex = medicine.color.hexColor
            )
        }

        val remindersJson = Gson().toJson(reminders)

        glanceIds.forEach { glanceId ->
            updateAppWidgetState(context, ReminderWidgetStateDefinition, glanceId) { prefs ->
                prefs.toMutablePreferences().apply {
                    val currentIndex = this[ReminderWidgetKeys.CURRENT_INDEX] ?: 0
                    this[ReminderWidgetKeys.TOTAL_COUNT] = reminders.size
                    this[ReminderWidgetKeys.REMINDERS_JSON] = remindersJson
                    if (currentIndex >= reminders.size) {
                        this[ReminderWidgetKeys.CURRENT_INDEX] = (reminders.size - 1).coerceAtLeast(0)
                    }
                }
            }
            ReminderWidget().update(context, glanceId)
        }
    }
}

// ============================================================================
// FILE: ReminderWidgetData.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/widget/ReminderWidgetData.kt
// [121 of 122]
// ============================================================================

package com.bardino.dozi.widget

import android.content.Context
import androidx.datastore.preferences.core.intPreferencesKey
import androidx.datastore.preferences.core.stringPreferencesKey
import androidx.glance.state.GlanceStateDefinition
import androidx.datastore.preferences.preferencesDataStore
import androidx.datastore.core.DataStore
import androidx.datastore.preferences.core.Preferences
import java.io.File

/**
 * Widget'ta g√∂sterilecek tek bir hatƒ±rlatma
 */
data class WidgetReminder(
    val medicineId: String,
    val medicineName: String,
    val dosage: String,
    val unit: String,
    val time: String,
    val icon: String,
    val colorHex: String
)

/**
 * Widget state i√ßin preference keys
 */
object ReminderWidgetKeys {
    val CURRENT_INDEX = intPreferencesKey("current_index")
    val TOTAL_COUNT = intPreferencesKey("total_count")
    val REMINDERS_JSON = stringPreferencesKey("reminders_json")
}

/**
 * Widget i√ßin Glance state definition
 */
object ReminderWidgetStateDefinition : GlanceStateDefinition<Preferences> {
    private const val DATA_STORE_FILENAME = "reminder_widget_prefs"

    private val Context.dataStore by preferencesDataStore(name = DATA_STORE_FILENAME)

    override suspend fun getDataStore(context: Context, fileKey: String): DataStore<Preferences> {
        return context.dataStore
    }

    override fun getLocation(context: Context, fileKey: String): File {
        return File(context.filesDir, "datastore/$DATA_STORE_FILENAME.preferences_pb")
    }
}

// ============================================================================
// FILE: ReminderWidgetReceiver.kt
// PATH: /home/user/Dozi/app/src/main/java/com/bardino/dozi/widget/ReminderWidgetReceiver.kt
// [122 of 122]
// ============================================================================

package com.bardino.dozi.widget

import android.appwidget.AppWidgetManager
import android.content.Context
import android.content.Intent
import android.os.Build
import androidx.glance.appwidget.GlanceAppWidget
import androidx.glance.appwidget.GlanceAppWidgetReceiver
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch

/**
 * Dozi Hatƒ±rlatma Widget Receiver
 * Widget lifecycle olaylarƒ±nƒ± y√∂netir ve g√ºncellemeleri tetikler
 */
class ReminderWidgetReceiver : GlanceAppWidgetReceiver() {

    override val glanceAppWidget: GlanceAppWidget = ReminderWidget()

    private val coroutineScope = CoroutineScope(Dispatchers.IO)

    override fun onUpdate(
        context: Context,
        appWidgetManager: AppWidgetManager,
        appWidgetIds: IntArray
    ) {
        super.onUpdate(context, appWidgetManager, appWidgetIds)

        // Widget g√ºncellendiƒüinde verileri yenile
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            coroutineScope.launch {
                ReminderWidgetUpdater.updateWidgets(context)
            }
        }
    }

    override fun onReceive(context: Context, intent: Intent) {
        super.onReceive(context, intent)

        // √ñzel intent'leri i≈üle
        when (intent.action) {
            ACTION_REFRESH_WIDGET -> {
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                    coroutineScope.launch {
                        ReminderWidgetUpdater.updateWidgets(context)
                    }
                }
            }
        }
    }

    companion object {
        const val ACTION_REFRESH_WIDGET = "com.bardino.dozi.REFRESH_WIDGET"

        /**
         * Widget'ƒ± dƒ±≈üarƒ±dan g√ºncellemek i√ßin helper fonksiyon
         */
        fun refreshWidget(context: Context) {
            val intent = Intent(context, ReminderWidgetReceiver::class.java).apply {
                action = ACTION_REFRESH_WIDGET
            }
            context.sendBroadcast(intent)
        }
    }
}

// ============================================================================
// END OF CONSOLIDATED SOURCE CODE
// Total files: 122
// ============================================================================
